# 什么是 Power BI 中的查询折叠，我为什么要关心它？

> 原文：<https://towardsdatascience.com/what-is-a-query-folding-in-power-bi-and-why-should-i-care-5b89f42f38d7?source=collection_archive---------1----------------------->

## "这会破坏查询折叠吗？"“您的查询会折叠吗？”…也许有人问过你这些问题，但你会说:“问…什么？!"在这一系列文章中，我们来学习幂查询中最重要的一个概念！

![](img/438a3abcc1842b952fc4789b20af48a4.png)

[https://www . pexels . com/photo/green-grass-field-with wind-turbines-under-blue-sky-6604984/](https://www.pexels.com/photo/green-grass-field-with-wind-turbines-under-blue-sky-6604984/)

> "这会破坏查询折叠吗？"“您的查询会折叠吗？”…也许有人问过你这些问题，但你会说:“问…什么？!"
> 
> 或者，您可能听说过 Power BI 中的查询折叠，但不知道如何在现实生活中利用它。
> 
> 如果你认识到自己处于(至少)上述两种情况中的一种，那么请继续阅读这篇简短的系列博文！

好吧，你很想知道什么是查询折叠。但是，首先…在你开始之前，我们需要一些理论基础，这些基础将把查询折叠特性放在适当的环境中。

## 数据整形

[我已经写过关于数据成形](/power-bi-101-data-shaping-in-a-nutshell-1df4681bdfd3)的文章，以及为什么它是数据准备阶段的关键概念之一。现在，我想以一种(也许)不同寻常的方式对此进行阐述:

我想你们都知道托马斯·莫尔写的一本书，叫做《乌托邦》。

在那个故事里，一切都很完美，每个人都很满意。在一个理想的世界中，让我们称之为“数据乌托邦”，我们有干净的、高质量的数据，这些数据只是“按原样”飞入我们的报告，而不需要在此过程中执行任何类型的翻新或转换。不幸的是，“数据乌托邦”只能存在于书本中——现实更加残酷——因为我们必须在培育数据的同时应对一系列挑战。

也就是说，我们必须吸收的一个关键概念是数据整形。一旦您熟悉了您的数据，并意识到您计划在您的 ***商业智能*** 解决方案中使用的数据中可能存在的陷阱，您就应该执行数据整形过程。

我有意使用术语“商业智能”而不是“Power BI”，因为这是一个通用概念，也应该在 Power BI 解决方案之外使用。

简而言之，在数据成为数据模型的一部分之前，数据整形就是数据整合的过程。关键要记住的是两个字:之前！因此，我们应该在数据进入报告本身之前进行数据整形。数据整形可以在不同的地方进行，也可以在数据准备过程中的不同时间点进行，这取决于您应用数据整形技术的位置。

***应该在哪里进行数据整形？***

源数据库——这是最明显的选择，在大多数情况下也是最理想的场景。它基于提取-转换-加载(ETL)数据的传统数据仓库原则。在这个场景中，您定义想要提取的数据(并不需要数据库中的所有数据，并且通常不建议导入所有数据)。然后，您决定是否需要对数据进行转换，以更好地满足您的报告需求，例如，您是否需要执行货币转换，或者您是否需要符合国家和城市名称。

你能认出下图中的城市吗？

![](img/df1b2e591bd1fe3015ec574f6814e2be.png)

[https://www . pexels . com/photo/skyline-photo-of-empire-state-building-in-new York-city-2190283/](https://www.pexels.com/photo/skyline-photo-of-empire-state-building-in-new-york-city-2190283/)

是的，是纽约。或者，是 NYC？或者，是纽约市？这三个名字哪个是正确的？是的，它们都是正确的-但是如果您像这样在您的数据模型中导入数据，您将得到不正确的结果-因为每个纽约、NYC 和纽约市将被视为一个单独的实体。这一点，以及更多潜在的警告，需要在数据整形阶段解决，这就是为什么花一些时间处理数据很重要。

## 电源查询

如果您不在源端执行数据转换，下一站是 Power Query——它是 Power BI 中的内置工具，[使您能够对数据执行各种转换](/power-query-tips-for-every-power-bi-developer-da9ebd3dcd93)。根据微软的官方文档，您可以应用 300 多种不同的转换，而且这个数字还在不断增加！

Power Query 的关键优势在于，您只需很少或不需要任何编码技能就可以执行复杂的数据转换！此外，您在数据转换过程中应用的所有步骤都将被保存，因此每次刷新数据集时，这些步骤都将被自动应用以形成您的数据，并为通过报表进行消费做好准备。

Power Query 的底层是一个 Mashup 引擎，它使您的数据整形能够顺利运行。Power Query 使用非常强大的 M 语言进行数据操作。现在，你可能会问自己，这些关于数据整形、强大查询、Mashup 引擎、M 语言等等的故事是怎么回事。与查询折叠有关。我不怪你，这是一个公平的问题，但我们很快会回来回答它。

## 什么是查询折叠？

对于一些数据源，例如关系数据库，以及非关系数据源，例如 OData、AD 或 Exchange，Mashup engine 能够将 M 语言“翻译”成底层数据源能够“理解”的语言，在大多数情况下是 SQL。

![](img/8cea1bf01265cf269844f0c33b04b252.png)

[https://www.pexels.com/photo/black-cables-1054397/](https://www.pexels.com/photo/black-cables-1054397/)

通过将复杂的计算和转换直接推送到数据源，Power Query 利用了健壮的关系数据库引擎的功能，这些引擎是为了以最有效的方式处理大量数据而构建的。

Power Query 的 Mashup 引擎能够创建一个 SQL 语句，将您的转换背后的所有 M 语句组合起来，这就是我们所说的查询折叠。

或者，让我们简单地说: ***如果 Mashup 引擎能够生成一个将要在数据源端执行的 SQL 查询，我们称该查询为*** 。

## 支持查询折叠的数据源

如前所述，查询折叠最明显的受益者是关系数据库源，如 SQL Server、Oracle 或 MySQL。然而，不仅仅是 SQL 数据库利用了查询折叠的概念。本质上，任何支持某种查询语言的数据源都可以利用查询折叠。其他数据源包括 OData、SSAS、Sharepoint 列表、Exchange 和 AD。

另一方面，当您使用 Excel 文件、BLOB 存储文件、平面文件等数据源时。在 Power BI 数据集中，查询不能折叠。

## 支持查询折叠的数据转换

然而，对于一般支持查询折叠的数据源，重要的是要记住**不是所有的转换**都可以被折叠并推送到数据源。所以，要明确的是，SQL 数据库支持查询折叠这一事实并不一定意味着您的查询会折叠！有一些强大的查询转换不能简单地推送到 SQL 数据库引擎。

通常，Power 查询转换中的一些细微差异可能对最终结果以及查询是否会折叠起决定性作用。在本系列的下一部分中，我将向您展示一些细微的区别。

一般来说，在 Power Query 中应用以下转换时，可以将其“转换”为一条 SQL 语句:

*   删除列
*   重命名列
*   使用静态值或超级查询参数过滤行，因为它们被视为 SQL 中的 WHERE 子句谓词
*   分组和汇总，这在 SQL 的 Group by 子句中是等价的
*   基于相同源的**可折叠**查询的合并——因为该操作可以转换为 SQL 中的 JOIN。当我说合并可折叠查询时，这意味着如果您连接两个 SQL server 表，它将工作，但如果您尝试连接 SQL 表和 Excel 文件，它将不会工作
*   追加基于相同源的**可折叠**查询——该转换与 SQL 中的 UNION ALL 操作符相关
*   用简单的逻辑添加自定义列。简单的逻辑是什么意思？使用在 SQL 语言中有等效项的 M 函数，例如数学函数或文本操作函数
*   透视和取消透视转换

![](img/b9659724b16d001fe008b76887a504be.png)

[https://www . pexels . com/photo/wood-red-industry-writing-3018978/](https://www.pexels.com/photo/wood-red-industry-writing-3018978/)

另一方面，一些会阻止查询折叠的转换有:

*   如前所述，合并基于不同来源的查询
*   基于不同的源追加(联合)查询——与前一种情况类似的逻辑
*   添加具有复杂逻辑的自定义列，或者使用一些在 SQL 中没有对应项的 M 函数
*   添加索引列
*   更改列数据类型。这是一个典型的“视情况而定”的案例。我将在本系列的下一部分向您展示它所依赖的东西，但是请记住，更改列数据类型可以是可折叠的和不可折叠的转换

## 结论

通过学习数据整形和 Power 查询，我们为理解 Power BI 中的查询折叠特性，或者更好地说是 Power Query Editor 中的查询折叠特性打下了坚实的理论基础。

在本系列的下一部分中，我们将研究为什么查询折叠如此重要，以及为什么我们应该关心查询是否折叠。我们还将学习如何检查查询是否折叠，以及为什么人们说细节决定成败…

感谢阅读！

[成为会员，阅读媒体上的每一个故事！](https://datamozart.medium.com/membership)

订阅[这里](http://eepurl.com/gOH8iP)获取更多有见地的数据文章！