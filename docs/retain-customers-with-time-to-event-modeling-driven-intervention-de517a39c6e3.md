# åˆ©ç”¨äº‹ä»¶å»ºæ¨¡é©±åŠ¨çš„å¹²é¢„æ—¶é—´ç•™ä½å®¢æˆ·

> åŸæ–‡ï¼š<https://towardsdatascience.com/retain-customers-with-time-to-event-modeling-driven-intervention-de517a39c6e3?source=collection_archive---------8----------------------->

## [å®è·µæ•™ç¨‹](https://towardsdatascience.com/tagged/hands-on-tutorials)

## ä½¿ç”¨ XGBoost åœ¨æ­£ç¡®çš„æ—¶é—´ç²¾ç¡®å®šä½å®¢æˆ·æµå¤±

ç”±[æŸ¥å°”æ–¯Â·å¼—ä¼¦æ³½](https://www.linkedin.com/in/cfrenzel/) lã€[ç™¾å·å­™](https://www.linkedin.com/in/sunbc0120/)å’Œ[å®‹å¯…](https://www.linkedin.com/in/yin-song-19b2702b/)

è·å¾—ä¸€ä¸ªå®¢æˆ·é€šå¸¸æ¯”ç•™ä½ä¸€ä¸ªå®¢æˆ·èŠ±è´¹æ›´å¤šã€‚

å…³æ³¨å®¢æˆ·ç»´ç³»ä½¿å…¬å¸èƒ½å¤Ÿåœ¨å®¢æˆ·ç”Ÿå‘½å‘¨æœŸä¸­æœ€å¤§åŒ–å®¢æˆ·æ”¶å…¥ã€‚

è¿™ç¯‡åšæ–‡å°†å‘ä½ å±•ç¤ºå¦‚ä½•è®­ç»ƒä¸€ä¸ªæ¨¡å‹ï¼Œä½¿ç”¨ [XGBoost](https://github.com/dmlc/xgboost) æ¥é¢„æµ‹å®¢æˆ·æµå¤±äº‹ä»¶çš„**é£é™©** **å’Œ** **æ—¶é—´**ã€‚

ç»“åˆ[ç”Ÿäº§çº§ç«¯åˆ°ç«¯æœºå™¨å­¦ä¹ ç®¡é“](/deploying-a-scalable-end-to-end-customer-churn-prediction-solution-with-aws-cbf3536be996)ï¼Œå¦‚ AWS ä¸Šçš„[å®¢æˆ·æµå¤±ç®¡é“](https://github.com/awslabs/aws-customer-churn-pipeline)ï¼Œæœ‰æ—¶é—´è¿›è¡Œäº‹ä»¶æµå¤±å»ºæ¨¡ï¼Œè¿™å…è®¸åŠæ—¶å¹²é¢„ä»¥åœæ­¢å®¢æˆ·æµå¤±ã€‚

![](img/a994e0d48726f54e71c8175cdba8f135.png)

ä½œè€…å›¾ç‰‡

å®¢æˆ·æµå¤±æˆ–ç®€ç§°ä¸º[æµå¤±](https://en.wikipedia.org/wiki/Customer_attrition)æ˜¯æŒ‡å®¢æˆ·åœ¨å®ç°æœ€å¤§æ”¶ç›Šä¹‹å‰â€œç¦»å¼€â€ã€‚åœæ­¢è¿™äº›æ´»åŠ¨ä»¥ä¿æŒæ”¶å…¥æ˜¯å¦‚æ­¤ç¡®å®šï¼Œä»¥è‡³äºåŸºäºæµå¤±çš„æ¨¡å‹æ˜¯é¦–æ‰¹æŠ•å…¥ç”Ÿäº§çš„æœºå™¨å­¦ä¹ è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚

ç„¶è€Œï¼Œè¿™äº›æ¨¡å‹å¾ˆå°‘è¢«ä¼˜åŒ–ï¼Œå› ä¸ºå®ƒä»¬ä¾èµ–äºäºŒè¿›åˆ¶åˆ†ç±»æ ‡å¿—(æ˜¯æˆ–å¦)ã€‚å®¢æˆ·æµå¤±åˆ†ç±»æ¨¡å‹ä¸ä¼šå‘Šè¯‰**å®¢æˆ·ä»€ä¹ˆæ—¶å€™å¯èƒ½ä¼šç¦»å¼€ï¼Œè€Œåªæ˜¯è¡¨æ˜è¿™å°†åœ¨å‡ å¤©æˆ–å‡ ä¸ªæœˆå†…å‘ç”Ÿã€‚**

è¿™ç¯‡åšæ–‡å°†ä»‹ç»å¦‚ä½•åœ¨å®¢æˆ·çš„ç”Ÿå‘½å‘¨æœŸä¸­è¡¡é‡æµå¤±é£é™©**ï¼Œä»¥æ‰¾åˆ°éœ€è¦è¿›è¡Œæµå¤±å¹²é¢„çš„ ***æ—¶é—´ç‚¹*** ã€‚**

## èŒƒå¼è½¬å˜:ä»ä»…äº‹ä»¶åˆ°åŠæ—¶å¹²é¢„

æµå¤±æ¨¡å‹å¯èƒ½æ›´å¥½çš„ä¸€ä¸ªå¾ˆå¥½çš„ç†ç”±æ˜¯ï¼Œè®¸å¤šæ¨¡å‹æ˜¯æ ¹æ®å›ºå®šçš„äºŒå…ƒç»“æœçš„ä»»æ„æ—¶é—´é˜ˆå€¼è®¾ç½®çš„ã€‚è¿™æ„å‘³ç€æ—¶é—´ä¿æŒä¸å˜ï¼ä¾‹å¦‚ï¼Œè®¾ç½®ä¸€ä¸ªä»»æ„çš„é˜ˆå€¼ï¼Œåœ¨ 40 å¤©çš„ä¸æ´»åŠ¨ä¹‹åï¼Œå®¢æˆ·å°±ä¼šç¿»ç›˜ã€‚

åŸºäºè¿™æ ·çš„å¯å‘æ ‡è®°å®¢æˆ·ä¼šå¯¼è‡´æ»‘ç‚¹ï¼Œä¸»è¦æ˜¯:

*   é¡¾å®¢åœ¨é—¨æ§›å‰ç¿»è…¾ã€‚
*   ç¦»é—¨æ§›å¾ˆè¿œå¾ˆè¿œçš„å®¢æˆ·ã€‚
*   å¿½ç•¥å®¢æˆ·ä¸€ç”Ÿçš„å·®å¼‚

å°† 40 å¤©åå¯èƒ½ç¦»å¼€çš„å®¢æˆ·ä¸ 100 å¤©åç¦»å¼€çš„å®¢æˆ·åŒç­‰å¯¹å¾…å¯èƒ½æ˜¯é”™è¯¯çš„ã€‚ä¼ ç»Ÿçš„å®¢æˆ·æµå¤±å»ºæ¨¡æ²¡æœ‰è¿›è¡Œè¿™ç§åŒºåˆ†ã€‚

ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„å›¾è¡¨ä¸­ï¼Œæ¨¡å‹å‡†ç¡®åœ°æ•è·äº†å®¢æˆ· Bï¼Œå› ä¸ºä»–ä»¬åœ¨è®¾ç½®é˜ˆå€¼çš„ç¡®åˆ‡æ—¶é—´ç‚¹(40 å¤©)ç¦»å¼€ã€‚å®¢æˆ· A å®é™…ä¸Šåœ¨é˜ˆå€¼ä¹‹åæ…åŠ¨ï¼Œå¹¶ä¸”ä»–ä»¬ä¸¢å¤±äº†ï¼Œå› ä¸ºæ¨¡å‹ä¸èƒ½è§£é‡Šä»–ä»¬ã€‚å®¢æˆ· C åšäº†ç›¸åçš„äº‹æƒ…ï¼Œåœç•™çš„æ—¶é—´è¿œè¿œè¶…è¿‡æ•°æ®æ—¶é—´çª—å£ã€‚ä»–ä»¬å¾ˆå¯èƒ½ä¼šæµå¤±ï¼Œä½†æˆ‘ä»¬æ— æ³•ç”¨åˆ†ç±»æ¨¡å‹æ¥æ¨¡æ‹Ÿä½•æ—¶æµå¤±ã€‚

![](img/8c71c67a2ed5bbf55d256590e892531b.png)

ä½œè€…å›¾ç‰‡

è¿™é‡Œå”¯ä¸€çš„æ—¶é—´ç‚¹æ˜¯â€œ40 å¤©å†…â€é˜ˆå€¼ã€‚ç”±äºå®ƒæ²¡æœ‰è€ƒè™‘æ—¶é—´ï¼Œæˆ‘ä»¬ä¸æ¸…æ¥šåœ¨ä»€ä¹ˆæ—¶å€™éœ€è¦è¥é”€å¹²é¢„ï¼Œå®ƒä¼šå¯¼è‡´å¯é¢„é˜²çš„å®¢æˆ·æµå¤±ã€‚

## å½“çŸ¥é“*æ—¶ï¼Œé‡æ–°æ„å»ºé—®é¢˜*

æˆ‘ä»¬ä¸ä½¿ç”¨äºŒå…ƒåˆ†ç±»å™¨ï¼Œè€Œæ˜¯å°†é—®é¢˜é‡æ–°æ„å»ºä¸ºä¾èµ–äºæ—¶é—´çš„é—®é¢˜ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨é€‚å½“çš„æ—¶å€™è¿›è¡Œå¹²é¢„ï¼Œåœ¨å®¢æˆ·æµå¤±å‘ç”Ÿä¹‹å‰é˜»æ­¢å®ƒã€‚ä¸å†ä¾èµ–äºé˜ˆå€¼ï¼Œæˆ‘ä»¬ç°åœ¨å°†æµå¤±è®¾ç½®ä¸ºè¿ç»­çš„æ—¶é—´æ¡ä»¶äº‹ä»¶ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ç°åœ¨çŸ¥é“æŸè€—**é£é™©**æœ€æœ‰å¯èƒ½å‘ç”Ÿçš„**æ—¶é—´**ã€‚

![](img/ac2213453808db5506c1e5392371cbd5.png)

ä½œè€…å›¾ç‰‡

æ—¶é—´ä¸å†ä¿æŒä¸å˜ï¼Œæˆ‘ä»¬ç°åœ¨éšç€æ—¶é—´çš„æ¨ç§»è·Ÿè¸ªé£é™©**ä»¥ç¡®å®šä½•æ—¶éœ€è¦è¥é”€å¹²é¢„æ¥ç•™ä½å®¢æˆ·ã€‚å¦‚æœæˆ‘ä»¬ä¸ºæ—¶é—´å’Œäº‹ä»¶å»ºæ¨¡ï¼Œå¹²é¢„å’Œé˜²æ­¢æŸè€—çš„æ­£ç¡®æ—¶æœºæ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚ä¸€ç§å«åš[ç”Ÿå­˜åˆ†æ](https://en.wikipedia.org/wiki/Survival_analysis)çš„å»ºæ¨¡æŠ€æœ¯å…è®¸æˆ‘ä»¬è¿™æ ·åšï¼Œéšç€ç°ä»£æœºå™¨å­¦ä¹ çš„å‡ºç°ï¼Œè¿™ç°åœ¨æ˜¯ä¸€é¡¹å¾®ä¸è¶³é“çš„ä»»åŠ¡ã€‚å¯¹ç”Ÿå­˜åˆ†æåŠå…¶èƒŒåçš„æ•°å­¦åŸç†çš„æ·±å…¥æ¢ç©¶è¶…å‡ºäº†æˆ‘ä»¬çš„èŒƒå›´ï¼Œæˆ‘ä»¬é¼“åŠ±ä½ æŸ¥çœ‹æ‰€æœ‰å…³äº Medium çš„å…³äºæ•°æ®ç§‘å­¦çš„[å¥½æ–‡ç« ï¼Œä»¥è·å¾—æ›´å¤šä¿¡æ¯](/search?q=survival)ã€‚**

## å¯¹æ•°æ®çš„å¿«é€Ÿæµè§ˆ

åœ¨æœ¬ä¾‹ä¸­ï¼Œæ‚¨å°†ä½¿ç”¨ä¸€ä¸ªè™šæ„çš„ç”µä¿¡å…¬å¸çš„åˆæˆå®¢æˆ·æµå¤±æ•°æ®é›†ï¼Œç»“æœä¸ºâ€œå®¢æˆ·æµå¤±ï¼Ÿâ€æ ‡è®°ä¸ºçœŸ(å·²æ…åŠ¨)æˆ–å‡(æœªæ…åŠ¨)ã€‚åŠŸèƒ½åŒ…æ‹¬å®¢æˆ·è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚è®¡åˆ’å’Œä½¿ç”¨ä¿¡æ¯ã€‚å®¢æˆ·æµå¤±æ•°æ®é›†æ˜¯å…¬å¼€çš„ï¼Œåœ¨ä¸¹å°¼å°”Â·tÂ·æ‹‰ç½—æ–¯çš„ã€ŠT2 å‘ç°æ•°æ®ä¸­çš„çŸ¥è¯†ã€‹ä¸€ä¹¦ä¸­æœ‰æ‰€æåŠã€‚ä½œè€…å°†å…¶å½’åŠŸäºåŠ å·å¤§å­¦æ¬§æ–‡åˆ†æ ¡çš„æœºå™¨å­¦ä¹ æ•°æ®é›†ä»“åº“ã€‚æ‰€æœ‰ä»£ç çš„ç¬”è®°æœ¬ä½äº[è¿™é‡Œã€‚](https://github.com/awslabs/aws-customer-churn-pipeline/blob/main/notebook/coxph/Example_Churn_Surv.ipynb)

```
df = pd.read_csv("../../data/churn.txt")

# denoting churn and duration
df["event"] = np.where(df["churn?"] == "False.", 0, 1)
df = df.rename(columns={"account_length": "duration"})

del df['churn?']

df = df.dropna()
df = df.drop_duplicates()df.head()
```

![](img/04ce8774b74bf634a71ef00610c12e1b.png)

ä½œè€…å›¾ç‰‡

è¿›ä¸€æ­¥æ£€æŸ¥æˆ‘ä»¬çš„ç›®æ ‡ä¼šå‘ç°ï¼Œæ€»å…±æœ‰ 5ï¼Œ000 æ¡è®°å½•ï¼Œå…¶ä¸­ 49.9%çš„è®°å½•æœ€ç»ˆè¢«æ·˜æ±°ã€‚æ•°æ®é›†åœ¨ç›®æ ‡ä¸Šæ˜¯å¹³è¡¡çš„ã€‚åœ¨çœŸå®ä¸–ç•Œçš„æ•°æ®ä¸­ï¼Œæƒ…å†µå¹¶éæ€»æ˜¯å¦‚æ­¤ï¼Œæµå¤±äº‹ä»¶å¯èƒ½æ˜¯æ•°ç™¾ä¸‡æ¡è®°å½•ä¸­çš„ 1%ã€‚æœ‰è¡¥æ•‘çš„ç­–ç•¥ï¼Œä½†è¿™è¶…å‡ºäº†è¿™ç¯‡åšæ–‡çš„èŒƒå›´ã€‚

æŸ¥çœ‹æŒç»­æ—¶é—´ï¼Œè¡¨ç¤ºä¸ºè´¦æˆ·é•¿åº¦(æˆ‘ä»¬çš„æ—¶é—´éƒ¨åˆ†)ï¼Œå®ƒæ˜¾ç¤ºä¸­ä½æ•°æ—¶é—´ä¸º 102 å¤©ï¼Œæ¥è¿‘ 101 å¤©çš„å¹³å‡å€¼ã€‚

```
print("Total Records:",df.shape[0],"\n")
print("Percent Churn Rate:",df.event.mean())
print("")
print("Duration Intervals")
print(df['duration'].describe())Total Records: 5000 

Percent Churn Rate: 0.4996

Duration Intervals
count   5000.0000
mean     101.6758
std       57.5968
min        1.0000
25%       52.0000
50%      102.0000
75%      151.0000
max      200.0000
```

å¯¹äºç”Ÿå­˜æ¨¡å‹ï¼Œæ•°æ®ä¸åŒäºä¼ ç»Ÿçš„åˆ†ç±»é—®é¢˜ï¼Œéœ€è¦:

*   å®¡æŸ¥å‘˜â€”â€”å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œè¿™äº›æ˜¯å°šæœªæµå¤±çš„å®¢æˆ·ã€‚åœ¨è¿™é‡Œé˜…è¯»å…³äºæƒåˆ©å®¡æŸ¥çš„å†…å®¹ã€‚
*   æŒç»­æ—¶é—´â€”â€”å®¢æˆ·æ´»åŠ¨çš„æŒç»­æ—¶é—´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¯ä»¥å¤©ä¸ºå•ä½çš„`Account Length`ã€‚
*   Event â€”äºŒè¿›åˆ¶ç›®æ ‡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä»–ä»¬ç»ˆæ­¢äº†æ ‡è®°ä¸º`Churn?`çš„ç”µè¯è®¡åˆ’ã€‚

æˆ‘ä»¬å¯ä»¥ç»˜åˆ¶æ—¶é—´çº¿ä¸Šçš„å‰ 10 ä¸ªå®¢æˆ·ï¼Œä»¥äº†è§£[å³åˆ ](https://en.wikipedia.org/wiki/Censoring_(statistics)#:~:text=Right%20censoring%20%E2%80%93%20a%20data%20point,subjects%20remaining%20are%20right-censored.)æ•°æ®æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»¥åŠé—®é¢˜æ˜¯å¦‚ä½•å½¢æˆçš„ã€‚

```
ax = plot_lifetimes(df.head(10)['duration'], df.head(10)['event'])

_=ax.set_xlabel("Duration: Account Length (days)")
_=ax.set_ylabel("Customer Number")
_=ax.set_title("Observed Customer Attrition")
```

![](img/c1a3a78b037850b6cdfeaa154b0990bc.png)

ä½œè€…å›¾ç‰‡

åœ¨ä¸Šå›¾ä¸­ï¼Œçº¢çº¿è¡¨ç¤ºå®¢æˆ·ç¦»å¼€çš„æ—¶é—´ï¼Œåœ†ç‚¹è¡¨ç¤ºå…·ä½“çš„æ—¶é—´ç‚¹ã€‚è“çº¿è¡¨ç¤ºåœ¨ x è½´ä¸Šæµ‹é‡çš„æŒç»­æ—¶é—´å†…ä»å¤„äºæ´»åŠ¨çŠ¶æ€çš„å®¢æˆ·ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°å®¢æˆ·å· 8 ç›´åˆ°ç¬¬ 195 å¤©æ‰æµå¤±ï¼Œå®¢æˆ·å· 0 å’Œ 4 åˆ†åˆ«åœ¨ç¬¬ 163 å¤©å’Œç¬¬ 146 å¤©ç¦»å¼€ã€‚æ‰€æœ‰å…¶ä»–å®¢æˆ·ä»ç„¶æ´»è·ƒã€‚

è¯·æ³¨æ„æ‰€æœ‰å®¢æˆ·æ˜¯å¦‚ä½•è¢«è®¾ç½®åœ¨ç›¸åŒçš„æ—¶é—´å°ºåº¦ä¸Šçš„ï¼Œå› ä¸ºæ•°æ®æ˜¯**åˆ†æå¯¹é½çš„**ã€‚æ¯ä¸ªé¡¾å®¢å¯èƒ½åœ¨ä¸åŒçš„æ—¶é—´æ¥ï¼Œä½†æ˜¯æˆ‘ä»¬æŠŠæ—¥å­å®šå¾—ä¸€æ ·ã€‚è¿™è®©æˆ‘ä»¬èƒ½å¤Ÿæ­£ç¡®å®¡æŸ¥å®¢æˆ·æµå¤±äº‹ä»¶çš„æ•°æ®ã€‚åœ¨å»ºæ¨¡å¼€å§‹ä¹‹å‰ï¼ŒçœŸå®ä¸–ç•Œçš„æ•°æ®éœ€è¦å®¡æŸ¥å’Œæ ¡å‡†ã€‚

## æµå¤±çš„é£é™©

ä¸€ä¸ªæ›´æœ‰ç”¨çš„æ–¹æ³•å¯èƒ½æ˜¯ä¼°è®¡[ç”Ÿå­˜å‡½æ•°](https://en.wikipedia.org/wiki/Survival_function)æˆ–å®¢æˆ·æµå¤±å‰çš„å¤©æ•°ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨[å¡æ™®å…°Â·è¿ˆè€¶ä¼°ç®—å™¨](http://en.wikipedia.org/wiki/Kaplan%E2%80%93Meier_estimator)æ¥è®¡ç®—æµå¤±å‘ç”Ÿå‰çš„æ—¶é—´ã€‚ä¼°è®¡é‡å®šä¹‰ä¸º:

![](img/dda3e4dec28d864fb6ff7ce039f7bcbb.png)

æ¥æº:ç”Ÿå‘½çº¿

å…¶ä¸­ï¼Œğ‘‘ğ‘–æ˜¯ğ‘¡æ—¶é—´ç‚¹çš„å®¢æˆ·æµå¤±äº‹ä»¶æ•°é‡ï¼Œğ‘›ğ‘–æ˜¯ğ‘¡.æ—¶é—´ç‚¹ä¹‹å‰é¢ä¸´å®¢æˆ·æµå¤±é£é™©çš„å®¢æˆ·æ•°é‡

æˆ‘ä»¬å°†ä½¿ç”¨ä¼Ÿå¤§çš„ [python åŒ… lifelines](https://github.com/CamDavidsonPilon/lifelines) æ¥ç»˜åˆ¶ç”Ÿå­˜å‡½æ•°ï¼Œå› ä¸ºè¯¥å‡½æ•°æ˜¯æœ€ç»ˆæµå¤±æ¨¡å‹çš„ä¸€ä¸ªç»„ä»¶ã€‚

```
kmf = KaplanMeierFitter()

kmf.fit(df['duration'], event_observed=df['event'])

kmf.plot_survival_function()
_=plt.title('Survival Function for Telco Churn');
_=plt.xlabel("Duration: Account Length (days)")
_=plt.ylabel("Churn Risk (Percent Churned)")
_=plt.axvline(x=kmf.median_survival_time_, color='r',linestyle='--')
```

![](img/a6823694443dae52822991b1dd85169f.png)

ä½œè€…å›¾ç‰‡

æˆ‘ä»¬æ¥çœ‹çœ‹ä¸­ä½å­˜æ´»æ—¶é—´ã€‚è¿™æ˜¯ä¸€åŠçš„é¡¾å®¢äº§ç”Ÿçš„åŸå› ã€‚æ ¹æ®è¿™å¼ å›¾ï¼Œç”¨çº¢è‰²è™šçº¿æ ‡è®°çš„åœ°æ–¹ï¼Œå¤§çº¦ 152 å¤©ï¼Œä¸€åŠçš„å®¢æˆ·æµå¤±ã€‚è¿™æ˜¯æœ‰å¸®åŠ©çš„ï¼Œå› ä¸ºå½“éœ€è¦å¹²é¢„æ—¶ï¼Œå®ƒç»™*æ•´ä½“*åŸºçº¿ã€‚ç„¶è€Œï¼Œå¯¹äºæ¯ä¸ªå®¢æˆ·æ¥è¯´ï¼Œè¿™æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚

ç¼ºå°‘çš„æ˜¯**æ¯ä¸ªå®¢æˆ·æµå¤±é£é™©æœ€é«˜çš„æ—¶é—´ç‚¹**ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨[è€ƒå…‹æ–¯æ¯”ä¾‹é£é™©](https://en.wikipedia.org/wiki/Survival_analysis#Cox_proportional_hazards_(PH)_regression_analysis)åˆ›å»ºä¸€ä¸ªæ¨¡å‹ï¼Œè¯¥æ¨¡å‹ä½¿ç”¨å¯¹æ•°é£é™©å‡½æ•° *h(x)* ã€‚é£é™©å‡½æ•°ä»¥å®¢æˆ·åœ¨æ—¶é—´ *t* æˆ–æ›´æ™šä¹‹å‰çš„å‰©ä½™ç‡ä¸ºæ¡ä»¶ï¼Œè¿™å…è®¸ä¼°è®¡éšç€æ—¶é—´**æ¨ç§»**çš„æµå¤±é£é™©ã€‚è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿå¯¹æ¯ä¸ªå®¢æˆ·è¿›è¡Œè¯„åˆ†ï¼Œå¹¶é¢„æµ‹ä½•æ—¶éœ€è¦è¥é”€å¹²é¢„ã€‚ç„¶è€Œï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œé¢„å¤„ç†ã€‚

## æ•°æ®åˆ†å‰²å’Œé¢„å¤„ç†

é¦–å…ˆï¼Œæˆ‘ä»¬å°†æ•°æ®åˆ†ä¸ºè®­ç»ƒå’Œæµ‹è¯•ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æµ‹è¯•é›†ä½œä¸ºä¾‹å­çš„éªŒè¯ã€‚åœ¨å®è·µä¸­ï¼Œæ‚¨éœ€è¦æ‰€æœ‰è¿™ä¸‰ä¸ªæ‹†åˆ†ï¼Œè¿™æ ·æ‚¨å°±ä¸ä¼šè°ƒæ•´åˆ°éªŒè¯é›†ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è·å–æ•°å­—ç‰¹å¾å’Œåˆ†ç±»ç‰¹å¾ï¼Œç„¶åå¯¹å®ƒä»¬è¿›è¡Œé¢„å¤„ç†ä»¥ç”¨äºä¸‹æ¸¸å»ºæ¨¡ã€‚åœ¨ç±»åˆ«çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†é¦–å…ˆç”¨å¸¸é‡è¿›è¡Œä¼°ç®—ï¼Œç„¶åç®€å•åœ°å¯¹å®ƒä»¬è¿›è¡Œä¸€æ¬¡æ€§ç¼–ç ã€‚åœ¨æ•°å­—çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å¡«å……ä¸­é—´å€¼ï¼Œç„¶åå°†å®ƒä»¬æ ‡å‡†åŒ–ä¸º 0 å’Œ 1 ä¹‹é—´çš„å€¼ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™äº›éƒ½åŒ…å«åœ¨ Sklearn çš„[ç®¡é“](https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html)å’Œ[åˆ—å˜æ¢å™¨](https://scikit-learn.org/stable/modules/generated/sklearn.compose.ColumnTransformer.html?highlight=columntransformer#sklearn.compose.ColumnTransformer)ä¸­ã€‚

ä½œä¸º[æ…åŠ¨ç®¡é“](https://github.com/awslabs/aws-customer-churn-pipeline)çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€æœ‰è¿™äº›æ­¥éª¤éƒ½åŒ…å«åœ¨æœ€ç»ˆçš„é¢„å¤„ç†å™¨ä¸­ï¼Œä¿å­˜èµ·æ¥ä¾›æ¨æ–­æ—¶ä½¿ç”¨ã€‚

```
df_train, df_test = train_test_split(df , test_size=0.20, random_state=SEED)numerical_idx = (
        df_train.select_dtypes(exclude=["object", "category"])
        .drop(['event','duration'],1)
        .columns.tolist()
    )

categorical_idx = df_train.select_dtypes(exclude=["float", "int"]).columns.tolist()

numeric_transformer = Pipeline(
        steps=[
            ("imputer", SimpleImputer(strategy="median")),
            ("scaler", StandardScaler()),
        ]
    )

categorical_transformer = Pipeline(
        steps=[
            ("imputer", SimpleImputer(strategy="constant", fill_value="missing")),
            ("onehot", OneHotEncoder(sparse=False, handle_unknown="ignore")),
        ]
    )

preprocessor = ColumnTransformer(
        [
            ("numerical", numeric_transformer, numerical_idx),
            ("categorical", categorical_transformer, categorical_idx),
        ],
        remainder="passthrough",
    )

train_features = preprocessor.fit_transform(df_train.drop(['event','duration'],1))
test_features = preprocessor.transform(df_test.drop(['event','duration'],1))
```

## è½¬æ¢ XGBoost çš„ç›®æ ‡

æˆ‘ä»¬å°†ä½¿ç”¨ XGBoost çš„ [DMatrix](https://xgboost.readthedocs.io/en/latest/python/python_api.html#xgboost.DMatrix) æ ¼å¼æ¥è¿è¡Œå¸¸è§„çš„é scikit APIã€‚å¯¹äºç”Ÿå­˜å‡½æ•°ï¼Œè¿™éœ€è¦ä¸€ä¸ªè½¬æ¢ï¼Œå°†æŒç»­æ—¶é—´è®¾ç½®ä¸ºç›®æ ‡ï¼Œç„¶åä½¿å…¶å¯¹äºäº‹ä»¶ä¸ºæ­£ï¼Œå¯¹äºéäº‹ä»¶ä¸ºè´Ÿã€‚è¿™ä¸æ˜¯ä¸€ä¸ªäº‹ä»¶å’ŒæŒç»­æ—¶é—´æˆ–äºŒå…ƒç»“æœçš„å…ƒç»„ï¼Œè€Œæ˜¯ä¸€ä¸ªæ­£/è´Ÿçš„å•ä¸€è¿ç»­å˜é‡ä½œä¸ºç›®æ ‡ã€‚æ›´å¤šå…³äº XGBoost ä¸­ç”Ÿå­˜æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¯·çœ‹è¿™ä¸ª[æ•™ç¨‹](https://xgboost.readthedocs.io/en/latest/tutorials/aft_survival_analysis.html)ã€‚

```
def survival_y_cox(dframe:pd.DataFrame) -> np.array:
    """Returns array of outcome encoded for XGB"""
    y_survival = []

    for idx, row in dframe[["duration", "event"]].iterrows():
        if row["event"]:
            # uncensored
            y_survival.append(int(row["duration"]))
        else:
            # right censored
            y_survival.append(-int(row["duration"]))
    return np.array(y_survival)

dm_train = xgb.DMatrix(
    train_features, label=survival_y_cox(df_train), feature_names=feature_names
)

dm_test = xgb.DMatrix(
    test_features, label=survival_y_cox(df_test), feature_names=feature_names
)
```

## å…³äºå±é™©å‡½æ•°çš„æ›´å¤šä¿¡æ¯

é£é™©åŠŸèƒ½æä¾›å®¢æˆ·æµå¤±**é£é™©**â€”â€”å‘Šè¯‰æˆ‘ä»¬å®¢æˆ·æµå¤±æœ€æœ‰å¯èƒ½å‘ç”Ÿçš„æ—¶é—´ã€‚

ç”Ÿå­˜å‡½æ•° *S(t)* è¿”å›è¶…è¿‡æŸä¸ªæ—¶é—´ç‚¹çš„å®¢æˆ·æµå¤±æ¦‚ç‡ *S(t) = P(T > t)* ï¼Œè€Œé£é™©å‡½æ•° *h(t)* ç»™å‡ºå®¢æˆ·åœç•™åˆ°æ—¶é—´ T çš„è¿‘ä¼¼æ¦‚ç‡ï¼Œä½¿å¾—:

![](img/adcfd83bd3532777569c6ba167ac5c15.png)

æ¥æº:ç”Ÿå‘½çº¿

å¦ä¸€æ–¹é¢ï¼Œåˆ©ç”¨å±é™©å‡½æ•°ï¼Œä¹Ÿå¯ä»¥å¾—åˆ°ç”Ÿå­˜å‡½æ•°ï¼Œå› ä¸º:

![](img/dd760a83033758a814353be993da8b36.png)

æ¥æº:ç”Ÿå‘½çº¿æ–‡æ¡£

## æ¢¯åº¦æ¨è¿›å’Œ Cox çš„éƒ¨åˆ†ä¼¼ç„¶

åœ¨æ¢¯åº¦å¢å¼ºçš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªåŸºæœ¬å­¦ä¹ å™¨è¢«ç»„åˆä»¥è·å¾—å¢å¼ºçš„æ•´ä½“å­¦ä¹ å™¨é›†åˆï¼Œå…¶è¢«å®šä¹‰ä¸ºä»¥ä¸‹çš„åŠ æ³•æ¨¡å‹:

![](img/6898ae77a9ec95cc38dab1ad718155c5.png)

æ¥æº:sci kit-ç”Ÿå­˜æ–‡æ¡£

å¯¹äºç”Ÿå­˜åˆ†ææƒ…å†µï¼Œç›®æ ‡æ˜¯æœ€å¤§åŒ–å¯¹æ•°éƒ¨åˆ†ä¼¼ç„¶å‡½æ•°ï¼Œä½†æ˜¯ç”¨åŠ æ³•æ¨¡å‹ä»£æ›¿ä¼ ç»Ÿçš„çº¿æ€§æ¨¡å‹ *f(x)* :

![](img/e0995d7c35c3c3ba1b93b27225c3d488.png)

èµ„æ–™æ¥æº:sci kit-ç”Ÿå­˜æ–‡ä»¶

å…³äºè¿™æ–¹é¢çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§è¿™ä¸ª[ä¼˜ç§€çš„ python åº“ Scikit-Survival æ•™ç¨‹](https://scikit-survival.readthedocs.io/en/latest/user_guide/boosting.html)ã€‚

æ­£å¸¸çš„å‚æ•°åœ¨è¿™é‡Œéƒ½é€‚ç”¨ï¼Œé™¤äº†æˆ‘ä»¬å·²ç»æŠŠ`objective`æ”¹ä¸º`surivial:cox`è¿™å°†å…è®¸è®­ç»ƒä¸€ä¸ªå¢å¼ºçš„ç”Ÿå­˜æ ‘ã€‚

```
params = {
    "eta": 0.1,
    "max_depth": 3, 
    "objective": "survival:cox",
    "tree_method": "hist",
    "subsample": 0.8,
    "seed": 123
}
bst = xgb.train(
    params,
    dm_train,
    num_boost_round=300,
    evals=[(dm_train, "train"), (dm_test, "test")],
    verbose_eval=int(1e1),
    early_stopping_rounds=10
)[0]	train-cox-nloglik:7.25501	test-cox-nloglik:5.86755
...
[151]	train-cox-nloglik:6.67063	test-cox-nloglik:5.39344
```

## å…³äºé¢„æµ‹çš„ä¸€ä¸ªæ³¨è®°

è¯¥æ¨¡å‹çš„é¢„æµ‹ä»¥é£é™©æ¯”çš„å½¢å¼è¿”å›(å³ï¼Œæ¯”ä¾‹é£é™©å‡½æ•° *h(t) = h0(t) * HR* ä¸­çš„ HR = exp(marginal_prediction)ã€‚è¿™æ„å‘³ç€è¾“å‡ºå¯ä»¥æ˜¯æŒ‡æ•°è¾¹é™…é¢„æµ‹ï¼Œä¹Ÿå¯ä»¥æ˜¯éæŒ‡æ•°è¾¹é™…é¢„æµ‹ã€‚ä¸ºäº†é¢„æµ‹å®¢æˆ·æµå¤±æœ€æœ‰å¯èƒ½å‘ç”Ÿçš„æ—¶é—´ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡æ•°åŒ–çš„ç‰ˆæœ¬ï¼Œå› ä¸ºå®ƒç›´è§‚åœ°åæ˜ äº†ä¸€ç§æ¦‚ç‡(å³ä½¿ä»æŠ€æœ¯ä¸Šè®²ï¼Œè¿™å¹¶ä¸æ˜¯çœŸæ­£çš„æ¦‚ç‡)ã€‚æ›´å¤šä¿¡æ¯è§[è¾“å‡ºå¦‚ä½•å‘ç”Ÿè§](https://datascience.stackexchange.com/questions/52097/what-is-the-outcome-of-a-cox-regression-in-xgboost)ã€‚

## æ£€æŸ¥å…¨çƒé¢„æµ‹

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æ—¶é—´ *t* (åœ¨è¿™ç§æƒ…å†µä¸‹ä¸ºè´¦æˆ·é•¿åº¦)æ¥è®¡ç®—é£é™©åˆ†æ•°æˆ–æµå¤±æ¦‚ç‡ï¼Œå¹¶æŸ¥çœ‹ä½•æ—¶æœ€æœ‰å¯èƒ½å‘ç”Ÿæµå¤±ã€‚

![](img/732bfcf2e60fbe37da8f7699918745d1.png)

åˆ†æ¡¶æµå¤±é£é™©(ä½œè€…å›¾ç‰‡)

å°†è¿™äº›å€¼åˆ†æˆæ—¶é—´æ®µæ˜¾ç¤ºï¼Œæœ€é«˜æµå¤±é£é™©å‘ç”Ÿåœ¨ç¬¬ 53 å¤©åˆ°ç¬¬ 62 å¤©ã€‚åœ¨è¿™æ®µæ—¶é—´ä¹‹åï¼Œæœ€å¯èƒ½çš„æŸè€—æ—¶é—´æ˜¯åœ¨ç¬¬ 80 åˆ° 102 å¤©ã€‚å®é™…ä¸Šï¼Œæ‚¨åº”è¯¥å¿½ç•¥ä»ç¬¬ 191 å¤©åˆ°ç¬¬ 200 å¤©çš„æœ€åä¸€æ ¹æ£’çº¿ï¼Œå› ä¸ºè¿™æ˜¯æˆªæ–­ç‚¹ã€‚

# è¯„ä¼°ç»©æ•ˆ

åœ¨ç”Ÿå­˜æ¨¡å‹çš„æƒ…å†µä¸‹[å“ˆå‹’å°”å’Œè°æŒ‡æ•°](https://statisticaloddsandends.wordpress.com/2019/10/26/what-is-harrells-c-index/)å’Œ[å¸ƒé‡ŒåŸƒåˆ†æ•°](https://en.wikipedia.org/wiki/Brier_score)é€šå¸¸ç”¨äºè¯„ä¼°ç”Ÿå­˜æ¨¡å‹ã€‚

## å“ˆå‹’å°”ç´¢å¼•(å“ˆå‹’å°”ç­‰äººï¼Œ1982 å¹´)

**ä¸€è‡´æ€§æŒ‡æ•°**æˆ– **C æŒ‡æ•°**æ˜¯ ROC æ›²çº¿(AUC) ä¸‹[åŒºåŸŸçš„æ¦‚æ‹¬ï¼Œå¯ä»¥è€ƒè™‘åˆ å¤±æ•°æ®ã€‚](https://en.wikipedia.org/wiki/Receiver_operating_characteristic)

å®ƒåº”è¯¥è¢«è®¤ä¸ºæ˜¯æ¨¡å‹çš„æ‹Ÿåˆä¼˜åº¦åº¦é‡ï¼Œè¯¥åº¦é‡ç¡®å®šäº†æ¨¡å‹åŸºäºä¸ªä½“é£é™©è¯„åˆ†æ­£ç¡®æä¾›å¯é ç”Ÿå­˜æ—¶é—´æ’åºçš„èƒ½åŠ›ã€‚

***C = 0.5*çš„å€¼è¡¨æ˜é£é™©åˆ†å€¼ä¸æ¯”æŠ›ç¡¬å¸å¥½å¤šå°‘ã€‚**

è¿™è¡¨ç¤ºä¸ºä¸€è‡´å¯¹çš„æ•°é‡/(â€œä¸€è‡´å¯¹â€çš„æ•°é‡+â€œä¸ä¸€è‡´å¯¹â€çš„æ•°é‡)æˆ–:

![](img/d882a808f638fd610a30f9f0052cebdf.png)

èµ„æ–™æ¥æº:PySurvival æ–‡ä»¶

## å¸ƒèµ–å°”ä¹è°±(å¸ƒèµ–å°” 1950)

Brier è¯„åˆ†ç”¨äºè¯„ä¼°ç»™å®šæ—¶é—´ *t* çš„é¢„æµ‹ç”Ÿå­˜å‡½æ•°çš„å‡†ç¡®æ€§ã€‚å®ƒä»£è¡¨è§‚å¯Ÿåˆ°çš„ç”Ÿå­˜çŠ¶æ€å’Œé¢„æµ‹çš„ç”Ÿå­˜æ¦‚ç‡ä¹‹é—´çš„å¹³å‡å¹³æ–¹è·ç¦»ï¼Œå¹¶ä¸”æ€»æ˜¯ 0 åˆ° 1 ä¹‹é—´çš„æ•°å­—ï¼Œ0 æ˜¯æœ€ä½³å¯èƒ½å€¼ã€‚

![](img/d665b10b55b4aa4a9ec4a80bea54f9e5.png)

èµ„æ–™æ¥æº:Pysurvival æ–‡ä»¶

ç„¶è€Œï¼Œå¦‚æœæ•°æ®é›†åŒ…å«è¢«å³åˆ æˆªçš„æ ·æœ¬ï¼Œåˆ™æœ‰å¿…è¦é€šè¿‡åŠ æƒæ¥è°ƒæ•´åˆ†æ•°ã€‚è¿™å°±æ˜¯ [Scikit-Survival çš„ Brier è¯„åˆ†æ ‡å‡†](https://scikit-survival.readthedocs.io/en/stable/api/generated/sksurv.metrics.brier_score.html)çš„ç”¨å¤„ã€‚å¦‚ä»–ä»¬çš„æ–‡ä»¶ä¸­æ‰€è¿°ï¼Œä¾èµ–äºæ—¶é—´çš„ Brier åˆ†æ•°æ˜¯åœ¨æ—¶é—´ç‚¹ *t* çš„å‡æ–¹è¯¯å·®

![](img/435eff67b91e3e9c969bdb22d027616e.png)

æ¥æº:sci kit-ç”Ÿå­˜æ–‡æ¡£

è¿™æ„å‘³ç€æµ‹é‡ç°åœ¨æ ¹æ®å³åˆ å¤±æ•°æ®è¿›è¡Œäº†è°ƒæ•´ï¼Œå› æ­¤æ›´åŠ å‡†ç¡®ã€‚

è®©æˆ‘ä»¬ç»™æ¨¡å‹æ‰“åˆ†ï¼

```
*print("CIC")
print(
    surv_metrics.concordance_index_ipcw(
       y_train,
       y_test,
      df_test['preds'],
        tau=100 # within 100 days
    )
)

print("Brier Score")
times, score = surv_metrics.brier_score(
y_train,y_test, df_test['preds'], df_test['duration'].max() - 1
)
print(score)**CIC
(0.7514910949902487, 177342, 58706, 0, 1218)

Brier Score
[0.37630957]*
```

è¿™äº›ç»“æœæ˜¯å¯ä»¥æ¥å—çš„ï¼Œå› ä¸ºè¿™äº›æ•°æ®å¹¶æ²¡æœ‰è€ƒè™‘åˆ°ç”Ÿå­˜åˆ†æã€‚ä¸€è‡´æ€§æŒ‡æ•°è¾¾åˆ° 0.75ï¼Œä¼˜äºç®€å•éšæœºæ¦‚ç‡ã€‚æ¬§çŸ³å—çš„åˆ†æ•°æ˜¯ 0.376ï¼Œä¸ç®—å¾ˆé«˜ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒæ˜¯ 0.25 æˆ–æ›´ä½ï¼Œæ­£å¦‚ [Pysurvival æ–‡æ¡£æŒ‡å‡ºçš„](https://square.github.io/pysurvival/metrics/brier_score.html)ã€‚

è¿˜æœ‰å…¶ä»–æ–¹æ³•æ¥è¿›ä¸€æ­¥è¯„ä¼°è¿™ä¸€ç‚¹ã€‚ä¾‹å¦‚ï¼Œ [Scikit-survival](https://github.com/sebp/scikit-survival) è½¯ä»¶åŒ…æä¾›äº†å¤šç§è¯„ä¼°æŒ‡æ ‡ï¼Œå¦‚ ROC ä¸‹çš„[æ—¶é—´ç›¸å…³åŒºåŸŸç­‰ã€‚](https://scikit-survival.readthedocs.io/en/stable/user_guide/evaluating-survival-models.html#Time-dependent-Area-under-the-ROC)

# *æ¨¡å‹å¯è§£é‡Šæ€§ä¸ SHAP*

å¥½æ¶ˆæ¯æ˜¯[SHAP(SHapley Additive exPlanations](https://github.com/slundberg/shap)ä¸ºåŸºäºæ ‘çš„é›†æˆæä¾›äº†ä¸€ç§é«˜é€Ÿç²¾ç¡®ç®—æ³•ï¼Œä»¥å¸®åŠ©è§£é‡Šæ¨¡å‹ä¸­çš„ç‰¹å¾é‡è¦æ€§ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå°†å…è®¸ç”¨æˆ·äº†è§£å“ªäº›å› ç´ ä¼šå¢åŠ å’Œé™ä½å®¢æˆ·æµå¤±é£é™©ã€‚

```
*explainer = shap.TreeExplainer(bst, feature_names=feature_names)
shap_values = explainer.shap_values(test_features) 

shap.summary_plot(shap_values, pd.DataFrame(test_features, columns=feature_names))*
```

![](img/7775bdd1f00282413a431d89c04070b0.png)

ä½œè€…å›¾ç‰‡

æ­¤å¤–ï¼Œæˆ‘ä»¬ç°åœ¨åœ¨å®¢æˆ·å±‚é¢è§£é‡Šäº†å¦‚ä½•è®¡ç®—æ¯ä¸ªæµå¤±é£é™©åˆ†å€¼ã€‚è¿™æœ‰åŠ©äºä¸ºå¹²é¢„ç­–ç•¥çš„é€‰æ‹©æä¾›ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¤œé—´æ”¶è´¹ã€å¤œé—´é€šè¯å’Œå¤œé—´é€šè¯æ—¶é—´éƒ½ä¼šå¯¼è‡´å®¢æˆ·æµå¤±ã€‚åŠ ä¸Šæ¯å¤©çš„é€šè¯æ—¶é—´(ä½œä¸ºä¸€ä¸ªç§¯æçš„é¢„æµ‹å› ç´ )è¡¨æ˜ï¼Œæ˜¾ç„¶åœ¨æ™šä¸Šæˆ–å¤œé—´æ‰“ç”µè¯çš„å®¢æˆ·é¢ä¸´æ›´é«˜çš„é£é™©ã€‚è¿™å¯ä»¥è¿›å…¥å¹²é¢„ç­–ç•¥ï¼Œé€šè¿‡è®¾ç½®å¹²é¢„é€šä¿¡åœ¨æ™šä¸Šå’Œå‚æ™šå‘å¤„äºå±é™©ä¸­çš„å®¢æˆ·å‘å‡ºã€‚

è¿™æä¾›äº†æ˜“äºå‘ä¸šåŠ¡ç”¨æˆ·å±•ç¤ºçš„ç»†èŠ‚ï¼Œå¹¶æä¾›äº†è¿›ä¸€æ­¥åˆ†æå“ªäº›åŠŸèƒ½ä¼šå¯¼è‡´å®¢æˆ·æµå¤±çš„æ–¹æ³•ã€‚

```
*idx_sample = 128
shap.force_plot(
    explainer.expected_value,
    shap_values[idx_sample, :],
    pd.DataFrame(test_features, columns=feature_names).iloc[idx_sample, :],
    matplotlib=True,
)

print(f"The real label is Churn={y_test[idx_sample][0]}")*
```

![](img/f0fde556ccc5692526fa741652ab694f.png)

ä¸€ä¸ªéæ…åŠ¨è€…æ˜¯å¦‚ä½•è®¡ç®—å‡ºæ¥çš„ï¼Œå›¾ç‰‡ç”±ä½œè€…æä¾›

```
*The real label is Churn=False*
```

æœ€åï¼Œç”±äºè¿™æ˜¯ä¸€ä¸ªåŸºäºæ ‘çš„æ¨¡å‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”»å‡ºæ ‘çš„æ ·å­ã€‚è™½ç„¶æˆ‘ä»¬è®¾ç½®äº† 100 æ£µæ ‘æ¥è®­ç»ƒï¼Œä½†æ˜¯å¾ˆæ—©å°±åœæ­¢äº†ï¼Œè¿™æ¬¡è¿è¡Œçš„æœ€ä½³è¿­ä»£æ˜¯ 67 æ£µæ ‘ã€‚è®©æˆ‘ä»¬åªçœ‹ç¬¬ä¸€æ£µæ ‘ï¼Œçœ‹çœ‹å®ƒçš„åˆ†è£‚æ¥åˆ¤æ–­ç†è§£æ¨ç†æ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚

```
*xgb.plot_tree(bst, rankdir="LR", num_trees=0)
fig = plt.gcf()
fig.set_size_inches(150, 100)*
```

![](img/a7e5bdc8261884b9f40db598a13b2518.png)

ç¬¬ä¸€æ£µæ ‘ï¼Œä½œè€…å›¾ç‰‡

ä¸å‡ºæ‰€æ–™ï¼Œæœ€å…·é¢„æµ‹æ€§çš„ç‰¹å¾æ˜¯å®ƒé¦–å…ˆåˆ†è£‚çš„ç‰¹å¾ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ„å‘³ç€å¤œé—´è´¹ç”¨ï¼Œå¤œé—´é€šè¯ï¼Œç™½å¤©å’Œæ™šä¸Šåˆ†é’Ÿåˆ†è£‚ã€‚æ˜¾ç„¶ï¼Œè¿™ä¸ªæ ‘ä¹Ÿæ˜¯å‘ä¸šåŠ¡ç”¨æˆ·å±•ç¤ºæ‚¨çš„æ¨¡å‹æ­£åœ¨åšä»€ä¹ˆçš„å¥½æ–¹æ³•ã€‚

# *æœ€ç»ˆæ£€æŸ¥*

åœ¨æˆ‘ä»¬çš„æœ€åæ£€æŸ¥ä¸­ï¼Œæˆ‘ä»¬å°†æŠŠé—®é¢˜ä½œä¸ºä¸€ä¸ªåˆ†ç±»å™¨æ¥å¤„ç†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥è¿™æ ·åšã€‚ç”±äºæ¨¡å‹æœ¬èº«æ˜¯ä»¥æ—¶é—´ä¸ºæ¡ä»¶çš„ï¼Œæ‰€ä»¥è¿™äº›å¹¶ä¸æ˜¯è¯„ä¼°å®ƒåœ¨æŠ€æœ¯ä¸Šåšå¾—å¦‚ä½•çš„çœŸæ­£å¥½çš„æŒ‡æ ‡ã€‚æˆ‘ä»¬åªæ˜¯ä¸ºåå¯¹è€…è¿è¡Œè¿™ä¸ªï¼Œå¹¶è¡¨æ˜å®ƒæ˜¯å¯è¡Œçš„ã€‚

```
*from sklearn import metrics

y_preds = df_test.preds.apply(lambda x : np.exp(x))
y_pred = np.where(y_preds > 0.5, 1, 0)

print(f"Accuracy score: {metrics.accuracy_score(df_test.event, y_pred)}")
print(f"Area Under the Curve {metrics.roc_auc_score(df_test.event, y_pred)}")
print("")
print(metrics.classification_report(df_test.event, y_pred))**Accuracy score: 0.932
Area Under the Curve 0.9339674490815218

              precision    recall  f1-score   support

           0       0.97      0.90      0.93       527
           1       0.89      0.97      0.93       473

    accuracy                           0.93      1000
   macro avg       0.93      0.93      0.93      1000
weighted avg       0.94      0.93      0.93      1000*
```

ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œè¯¥æ¨¡å‹è·å¾—çš„ç»“æœä¼˜äº 2017 å¹´è¯¥æ•°æ®é›†é¦–æ¬¡å‡ºç°åœ¨åšå®¢ä¸–ç•Œæ—¶[æŠ¥å‘Šçš„ 86%çš„å‡†ç¡®ç‡ã€‚æˆ‘ä»¬ä¸ä»…æœ‰å‡†ç¡®æ€§ï¼Œè¿˜èƒ½åœ¨æ—¶è¯†åˆ«å‡º**ã€‚è¿™ä½¿å¾—åŠæ—¶çš„è¥é”€å¹²é¢„èƒ½å¤Ÿç•™ä½å®¢æˆ·ã€‚**](https://aws.amazon.com/blogs/machine-learning/predicting-customer-churn-with-amazon-machine-learning/)

## *ç»“è®º*

è¿™ç¯‡åšæ–‡å±•ç¤ºäº†å¦‚ä½•ç”¨æ—¶é—´ç»„ä»¶æ¥è®­ç»ƒå®¢æˆ·æµå¤±æ¨¡å‹ã€‚ä½¿ç”¨å¸¦æœ‰ Cox æ¯”ä¾‹é£é™©çš„ç”Ÿå­˜åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç¡®å®šå®¢æˆ·æµå¤±é£é™©æœ€é«˜çš„æ—¶é—´æ¥é˜²æ­¢å®¢æˆ·æµå¤±ã€‚è¿™å…è®¸ä¸»åŠ¨ã€åŠæ—¶çš„å¹²é¢„æ¥é˜»æ­¢å®¢æˆ·ç¦»å¼€ã€‚

ç°åœ¨ä½ æœ‰äº†ä¸€ä¸ªæ¨¡å‹ï¼Œæ˜¯æ—¶å€™ç”Ÿäº§å®ƒäº†ï¼Œå°±åƒ AWS ä¸Šçš„[å®¢æˆ·æµå¤±ç®¡é“ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ªæµå¤±æ—¶é—´äº‹ä»¶å»ºæ¨¡çš„æ¨¡æ¿ã€‚ä¸€æ—¦é…ç½®äº†ç®¡é“ï¼Œæ‚¨å°±å¯ä»¥å¯¹è®°å½•è¿è¡Œæ¨ç†ï¼Œé€šè¿‡æ‰¹é‡æ¨ç†æ¥ç´¯ç§¯åˆ†æ•°ï¼Œä»è€Œåšå‡ºå¹²é¢„å†³ç­–ã€‚](https://github.com/awslabs/aws-customer-churn-pipeline)

![](img/b65d493674bedf1419c554e021cd97fa.png)

æŒ‰å¤©é—´éš”åˆ’åˆ†çš„å®¢æˆ·é£é™©(å›¾ç‰‡ç”±ä½œè€…æä¾›)

(ä¸Šé¢æ˜¾ç¤ºäº†ä¸€ä¸ªè¡¨æ ¼ï¼Œæ˜¾ç¤ºäº†å®¢æˆ·åœ¨å‡ å¤©å†…æ‰¹å¤„ç†ä½œä¸šçš„ç´¯ç§¯ç»“æœã€‚ç°åœ¨æœ‰äº†å®¢æˆ·æµå¤±é£é™©å†å²è®°å½•ï¼Œå¯ä»¥ç›‘æ§å¹¶æ ‡è®°ä½•æ—¶è¿›è¡Œå¹²é¢„ã€‚)

ä½¿ç”¨æœºå™¨å­¦ä¹ è¿›è¡Œç”Ÿå­˜åˆ†ææ˜¯ä¸€ç§è§£å†³å®¢æˆ·æµå¤±ç­‰é—®é¢˜çš„å¥½æ–¹æ³•ã€‚æˆ‘ä»¬é¼“åŠ±æ‚¨æŸ¥çœ‹ä¸‹é¢çš„å‚è€ƒé“¾æ¥ï¼Œäº†è§£æ‰€æœ‰å¯ç”¨çš„ä¸åŒæŠ€æœ¯ã€‚

## *å‚è€ƒæ–‡çŒ®*

[*ç”Ÿå‘½çº¿ï¼Œå¡æ¢…éš†æˆ´ç»´æ£®-çš®éš†*](https://github.com/CamDavidsonPilon/lifelines) *2014*

[*XGBoost:ä¸€ä¸ªå¯æ‰©å±•çš„æ ‘æå‡ç³»ç»Ÿï¼Œé™ˆ& Guestrin 2016*](https://github.com/dmlc/xgboost)

[*PySurvival:ç”Ÿå­˜åˆ†æå»ºæ¨¡å¼€æºåŒ…ï¼ŒFotso 2019*](https://github.com/square/pysurvival/)

[*scikit-survival:åŸºäº scikit-learn æ„å»ºçš„æ—¶é—´-äº‹ä»¶åˆ†æåº“ï¼ŒSebastian Polsterl 2020*](https://github.com/sebp/scikit-survival)

[*SHAP(æ²™æ™®åˆ©è¡¥å……è§£é‡Š)ï¼Œä¼¦å¾·ä¼¯æ ¼ 2017*](https://github.com/slundberg/shap)