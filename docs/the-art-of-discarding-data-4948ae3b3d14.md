# 丢弃数据的艺术

> 原文：<https://towardsdatascience.com/the-art-of-discarding-data-4948ae3b3d14?source=collection_archive---------34----------------------->

![](img/49b80a8e4e8446445d809584936338db.png)

在 [Unsplash](https://unsplash.com/s/photos/trash?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上由[Kinga koodziejska](https://unsplash.com/@locked_in_the_lens?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)拍摄的照片

## 数据工程，数据库

## 做更好的数据工程的核心思想

工程解决方案不仅仅是建造一些东西。而是想出一种方法，用最少的资源解决手头的问题。优化问题是所有计算的中心，本质上也是所有人类努力的中心。它处理的问题包括——如何让飞机飞得更快(并且使用更少的燃料),如何编写可以重复使用的代码，如何让股票市场数据在各大洲的着陆速度加快几毫秒，等等。这些问题的答案并不总是立竿见影。这些答案是在迭代中找到的。每一次迭代都是优化的一次实践(尽管有些迭代只是营销噱头)，不仅仅是资源的优化，也是设计和美学的优化。

在他的一次演讲中，一位理论物理学家说，用非常简单的方式将复杂的系统形象化会更容易理解。例如，对于一个研究方程的物理学家来说，一头奶牛可能是一个圆，其质心位于圆心。有时候从远处看问题很重要，这样才能更好地理解需要做些什么来摆脱它们。将所有这些应用到我工作中最突出的领域，我意识到(或重新意识到)API、分析、仪表板、报表等查询优化的第一步。，就是丢弃不需要的数据。这看起来很简单，不是吗？

# 要优化的资源

在查看丢弃数据的不同方法之前，让我们先来看看为什么需要这样做。众所周知，数据处理和移动通常会遇到以下瓶颈之一:

## 计算

简而言之，计算就是您的 CPU(或 vCPUs)，本质上就是处理能力。要计算大量数据，您需要在一台服务器上安装更强大的处理器(纵向扩展)，或者安装更多具有类似处理器的服务器(横向扩展)。

计算通常是一个瓶颈，因为它与内存和存储等其他昂贵的资源紧密相关。也有少数例外，比如雪花。我们稍后会谈到这一点。虽然摩尔定律正在发挥它的魔力，但处理能力仍然是昂贵的。随着时间的推移，随着数据变得越来越大、越来越多样化，成本将继续成为一个主要因素。

## 记忆

与计算一样，内存也是一种昂贵资源。芯片离 CPU 越近(基于时间越近)，成本就越高。在[一篇关于查询优化技术的文章](/easy-fixes-for-sparksql-performance-ad4166792e6e)中，我写了一篇关于往返磁盘比往返内存(RAM)多花费大约 10000 倍时间的文章。最好只在内存中保存 CPU 立即需要处理的数据。

当您听到使用术语*内存*时，请理解存储和处理都发生在 RAM 中，即整个数据库位于 RAM 中。像 Spark 这样的数据处理引擎处理内存中的大部分数据，从而获得很高的处理速度。

## 储存；储备

对于内存和存储来说，有两个因素控制着成本和性能，即容量和 I/O。商用硬件的容量通常是以 GB 内存和 TB 磁盘空间为单位。I/O 也称为 IOPS(每秒输入输出操作数)，决定这些设备的访问和处理带宽。

存储就像 CPU 和内存一样，有多种 IOPS。AWS 提供 IO2 块存储，每卷吞吐量为 4000 MB/s，每卷 256000 IOPS。的速度

## 网络

应用程序和数据库的不同组件之间的通信依赖于网络，而网络依赖于网络布线、交换机、路由器、集线器、互联网网关、网络带宽等。高速连接对于发挥数据库的最佳性能至关重要，尤其是在多节点(集群)设置中，节点之间有大量的数据传输和通信。

除了知道不同数据库组件之间的每次旅行需要多少时间(以 ns 或 ms 为单位)之外，每个人都应该知道一些通用的数据工程数字。我在下面的文章中写到了这一点。

</numbers-every-data-engineer-should-know-cc5c1a0bc3ec>  

# 丢弃数据的技术

大多数数据库使用内存来存储最近或最频繁使用的行或列。对于 MySQL 和 PostgreSQL，内存中的这个专用空间称为缓冲池。一旦数据处于暂时不使用的状态，一些其他数据就会使用 LRU(最近最少使用)缓存失效算法来替换它。这个获取缓存中数据的过程称为预热缓存。这适用于我们将在本节中讨论的所有三种架构技术。

## 索引

表上的索引本质上是原始表的副本(以及对原始表的引用)。在基于行的数据库中的某一列上创建索引，使您有机会以时间复杂度`**O(log n)**`搜索该列，其中 n 是表中记录的数量。添加索引的成本会很高，因为索引会占用相当多的空间。我写过关于索引的最佳实践，尤其是当你不得不[索引巨大的表的时候。](/indexing-very-large-tables-569811421ee0)

<https://medium.com/analytics-vidhya/indexing-best-practices-10025d779e0b>  

创建、维护和使用索引有时很有挑战性。为了最大限度地利用索引，您需要确保为正确的列集创建正确类型的索引，这对加快缓慢的查询非常有帮助。注意在用于写数据的主数据库实例上创建太多索引的后果。过多的索引会对写入负载产生负面影响。要了解更多关于索引的信息，请访问[使用索引卢克](https://use-the-index-luke.com/)！

## 分割

分区采用了不同于索引的方法。分区是在已分区的列上拆分的表的一部分，而不是在列上创建一个大的 B 树索引。

您可以将分区与索引结合使用，在这种情况下，您可以使用分区修剪来找到查询所需的分区，然后使用其余的`**WHERE**`子句条件，通过在该分区上创建的索引来搜索该分区。

在大多数数据库中，分区显示在磁盘上的不同文件中。因此，丢弃无用的分区并创建新的分区是非常容易的。对一个分区的更新不会影响其他分区上的读取查询。

## 分片

就像分区发生在数据文件(表、物化视图)级别一样，分片发生在实例级别。当您想要将数据分割到不同的机器上时，您可以使用分片。

这不仅可以帮助您丢弃数据，还可以通过实现关注点分离来帮助您实现隔离。例如，如果您有许多客户，您可以将一些优先客户的数据保存在一组分片上，而将其余的保存在另一组分片上。

# 丢弃 SQL 中的数据

您使用 SQL 编写`**SELECT**`语句从数据库中获取数据。如果你仔细观察，SQL 语言的每一个子句——`**ORDER BY/LIMIT**`、`**GROUP** **BY/HAVING**`、`**WHERE**`、`**FROM**`等等——都是为了达到你真正寻找的数据而丢弃数据的行为。为什么

*   `**FROM**` —允许您丢弃不需要的列。
*   `**WHERE**` —允许您丢弃不需要的行。
*   `**GROUP BY**`使您能够丢弃细节，查看聚集，并使用`**HAVING**`子句应用`**WHERE**`类型功能。
*   `**ORDER BY**` —使您能够根据排序方案丢弃行。使用`**LIMIT**`您可以选择丢弃任意数量的记录。

您没有丢弃的数据俗称为扫描的数据。最好的查询是扫描最少数据的查询。要扫描最少量的数据，您需要使用上面提到的数据丢弃技术。仅仅写一个`**WHERE**`条件不会自动丢弃数据。你必须应用一种或多种这些技术。

> 例如，如果您在索引中使用的列上没有索引， `***WHERE***` *子句将产生正确的结果，但不会很快，即* `***WHERE***` *子句将为了准确性而丢弃数据，而不是为了性能。*

理解这一点很重要，尤其是如果您只是在摆弄数据库、数据仓库、数据管道、数据处理引擎等。它们都基于相同的原理工作。在本文中，我刚刚介绍了一些可以更快获取数据的方法。事情远不止如此。我将在下一篇名为*理论上的最小值:SQL* 的文章中更详细地讨论在 SQL 中丢弃数据的问题。我还将讨论[如何编写更干净、更高效的 SQL](/how-to-avoid-writing-sloppy-sql-43647a160025) 。

如果你想谈论任何数据，请随时在 [LinkedIn](https://www.linkedin.com/in/kovidrathee/) 上给我留言。要获得更多我的作品，请访问[链接树](https://linktr.ee/kovid)。