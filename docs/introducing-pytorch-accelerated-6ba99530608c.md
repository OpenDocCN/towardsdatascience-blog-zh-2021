# æ¨å‡º PyTorch åŠ é€Ÿç‰ˆ

> åŸæ–‡ï¼š<https://towardsdatascience.com/introducing-pytorch-accelerated-6ba99530608c?source=collection_archive---------9----------------------->

## ä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å¼ºå¤§çš„åº“ï¼Œç”¨æœ€å°‘çš„æ ·æ¿æ–‡ä»¶è®­ç»ƒ PyTorch æ¨¡å‹

pytorch-accelerated æ˜¯ä¸€ä¸ªè½»é‡çº§åº“ï¼Œæ—¨åœ¨é€šè¿‡æä¾›ä¸€ä¸ªæœ€å°ä½†å¯æ‰©å±•çš„è®­ç»ƒå¾ªç¯(å°è£…åœ¨å•ä¸ª [**è®­ç»ƒå™¨**](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer) å¯¹è±¡ä¸­)æ¥åŠ é€Ÿè®­ç»ƒ pytorch æ¨¡å‹çš„è¿‡ç¨‹ï¼Œè¯¥è®­ç»ƒå¾ªç¯è¶³å¤Ÿçµæ´»ï¼Œå¯ä»¥å¤„ç†å¤§å¤šæ•°ç”¨ä¾‹ï¼Œå¹¶ä¸”èƒ½å¤Ÿåˆ©ç”¨ä¸åŒçš„ç¡¬ä»¶é€‰é¡¹ï¼Œè€Œæ— éœ€æ›´æ”¹ä»£ç ã€‚pytorch åŠ é€Ÿçš„æä¾›äº†ä¸€ä¸ªç²¾ç®€çš„ç‰¹æ€§é›†ï¼Œå¹¶ä¸”éå¸¸å¼ºè°ƒ**çš„ç®€å•æ€§**å’Œ**çš„é€æ˜æ€§**ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿå‡†ç¡®åœ°ç†è§£å¹•åå‘ç”Ÿçš„äº‹æƒ…ï¼Œè€Œä¸å¿…è‡ªå·±ç¼–å†™å’Œç»´æŠ¤æ ·æ¿æ–‡ä»¶ï¼

**çš„ä¸»è¦ç‰¹å¾**æ˜¯:

*   ä¸€ä¸ªç®€å•ã€åŒ…å«ä½†æ˜“äºå®šåˆ¶çš„è®­ç»ƒå¾ªç¯ï¼Œåœ¨ç®€å•çš„æƒ…å†µä¸‹å¯ä»¥å¼€ç®±å³ç”¨ï¼›å¯ä»¥ä½¿ç”¨ç»§æ‰¿å’Œ/æˆ–[å›è°ƒ](https://pytorch-accelerated.readthedocs.io/en/latest/callbacks.html)æ¥å®šåˆ¶[è¡Œä¸ºã€‚](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#customizing-trainer-behaviour)
*   å¤„ç†å™¨ä»¶å¸ƒå±€ã€æ··åˆç²¾åº¦ã€ [DeepSpeed é›†æˆ](https://www.deepspeed.ai/)ã€å¤š GPU å’Œåˆ†å¸ƒå¼åŸ¹è®­ï¼Œæ— éœ€æ›´æ”¹ä»£ç ã€‚
*   ä½¿ç”¨çº¯ PyTorch ç»„ä»¶ï¼Œæ²¡æœ‰é¢å¤–çš„ä¿®æ”¹æˆ–åŒ…è£…ï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åœ°ä¸å…¶ä»–æµè¡Œçš„åº“äº’æ“ä½œï¼Œå¦‚ [timm](https://github.com/rwightman/pytorch-image-models) ã€ [transformers](https://huggingface.co/transformers/) å’Œ [torchmetrics](https://torchmetrics.readthedocs.io/en/latest/) ã€‚
*   ä¸€ä¸ªå°çš„ã€ç®€åŒ–çš„ API ç¡®ä¿ç°æœ‰ PyTorch ç”¨æˆ·çš„å­¦ä¹ æ›²çº¿æœ€å°ã€‚

ä¸ºäº†ç¡®ä¿åº“çš„æ¯ä¸ªéƒ¨åˆ†â€”â€”åŒ…æ‹¬å†…éƒ¨å’Œå¤–éƒ¨ç»„ä»¶â€”â€”éƒ½å°½å¯èƒ½çš„æ¸…æ™°å’Œç®€å•ï¼Œä½¿å¾—å®šåˆ¶ã€è°ƒè¯•å’Œç†è§£æ¯ä¸€æ­¥å¹•åå‘ç”Ÿçš„äº‹æƒ…å˜å¾—å®¹æ˜“ï¼›åŸ¹è®­å¸ˆçš„å¤§éƒ¨åˆ†è¡Œä¸ºéƒ½åŒ…å«åœ¨ä¸€ä¸ªå•ç‹¬çš„ç±»ä¸­ï¼åœ¨ Python çš„ç²¾ç¥ä¸­ï¼Œæ²¡æœ‰ä»€ä¹ˆæ˜¯éšè—çš„ï¼Œä¸€åˆ‡éƒ½æ˜¯å¯è®¿é—®çš„ã€‚

æœ¬æ–‡çš„ç›®çš„æ˜¯ä»‹ç»è¿™ä¸ªåº“ï¼Œæˆ‘å†³å®šå°†å®ƒå‘½åä¸º *pytorch-accelerated* (åŸå› å°†åœ¨åé¢å˜å¾—æ˜¾è€Œæ˜“è§ï¼)ï¼Œæè¿°åˆ›å»ºå®ƒèƒŒåçš„ä¸€äº›åŠ¨æœºï¼Œå¹¶æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨å®ƒæ¥*åŠ é€Ÿ*æ‚¨çš„ PyTorch å¼€å‘ã€‚è¿™ç¯‡æ–‡ç« çš„ç›®çš„æ˜¯**è€Œä¸æ˜¯**æ¥ç ´åæˆ–æ¯”è¾ƒä»»ä½•ç°æœ‰çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºæˆ‘åšä¿¡å®ƒä»¬éƒ½æœ‰è‡ªå·±çš„ä½ç½®ï¼Œå¹¶ä¸”ä¸ä¼šå› ä¸ºæœ‰äººè¯´ä»–ä»¬æ›´å–œæ¬¢åº“ *x* ä¸­çš„å·¥ä½œæ–¹å¼å¹¶ä¸”æ›´å–œæ¬¢ä½¿ç”¨å®ƒè€Œç”Ÿæ°”ï¼

*å¦‚æœä½ æƒ³ç›´æ¥è¿›å…¥ä¸»é¢˜ï¼Œæˆ–è€…é€šè¿‡å®è·µè€Œä¸æ˜¯é˜…è¯»æ¥å­¦ä¹ æ›´å¤šå†…å®¹ï¼Œå¿«é€Ÿå…¥é—¨æŒ‡å—å¯åœ¨* [*è¿™é‡Œ*](https://pytorch-accelerated.readthedocs.io/en/latest/quickstart.html) *è·å¾—ï¼Œæ–‡æ¡£å¯åœ¨* [*è¿™é‡Œ*](https://pytorch-accelerated.readthedocs.io/en/latest/index.html) *è·å¾—ï¼Œæˆ–è€…æŸ¥çœ‹ GitHub* *ä¸Šçš„* [*ç¤ºä¾‹ã€‚è§‰å¾—æœ‰ç”¨åˆ«å¿˜äº†åŠ æ˜Ÿï¼*](https://github.com/Chris-hughes10/pytorch-accelerated/tree/main/examples)

![](img/1a50b22f44d66c1b37be2c7671b382f1.png)

ä½¿ç”¨ pytorch-accelerated è®­ç»ƒ MNISTã€‚

# ä¸ºä»€ä¹ˆ*å¦ä¸€ä¸ª* PyTorch é«˜çº§ APIï¼Ÿ

ä½œä¸º[å¾®è½¯ CSE](https://microsoft.github.io/code-with-engineering-playbook/CSE/) çš„æ•°æ®æ™ºèƒ½å’Œè®¾è®¡å›¢é˜Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬åœ¨è®¸å¤šä¸åŒçš„é¢†åŸŸä»äº‹å¹¿æ³›çš„æœºå™¨å­¦ä¹ é¡¹ç›®ã€‚ç”±äºè¿™äº›é—®é¢˜çš„å¤æ‚æ€§ï¼Œæˆ‘ä»¬çš„å·¥ä½œé€šå¸¸å¯ä»¥è¢«æè¿°ä¸ºåº”ç”¨ç ”ç©¶â€”â€”ä»ç°æœ‰çš„è‰ºæœ¯æ–¹æ³•ä¸­è·å¾—çµæ„Ÿï¼Œä»¥æ–°çš„æœ‰è¶£çš„æ–¹å¼é€‚åº”å’Œåº”ç”¨è¿™äº›æ–¹æ³•â€”â€”åŒæ—¶ä¹Ÿå¼ºè°ƒå¼ºå¤§çš„è½¯ä»¶å·¥ç¨‹å®è·µï¼Œå¦‚[SOLID](https://team-coder.com/solid-principles/)ï¼›ç¡®ä¿ä»£ç å°½å¯èƒ½ç®€å•å’Œå¯ç»´æŠ¤ã€‚

éšç€æ·±åº¦å­¦ä¹ çš„ä½¿ç”¨å’Œå—æ¬¢è¿ç¨‹åº¦ä¸æ–­ä¸Šå‡ï¼Œæˆ‘ä»¬çš„è®¸å¤šé¡¹ç›®éƒ½æ¶‰åŠå¼€å‘æ·±åº¦å­¦ä¹ è§£å†³æ–¹æ¡ˆï¼ŒPyTorch æ˜¯æˆ‘åœ¨è¿™äº›æƒ…å†µä¸‹çš„é¦–é€‰å·¥å…·ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¶³å¤Ÿçµæ´»çš„è§£å†³æ–¹æ¡ˆæ¥å¤„ç†å¤§é‡çš„ç”¨ä¾‹ï¼ŒåŒæ—¶æ˜“äºæ‰©å±•ï¼Œä½†è®©æˆ‘ä»¬å°½å¿«è·Ÿä¸Šé€Ÿåº¦ï¼›ç”±äºæˆ‘ä»¬çš„è®¸å¤šé¡¹ç›®éå¸¸å¤§ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦èƒ½å¤Ÿä»ç¬¬ä¸€å¤©å°±åˆ©ç”¨åˆ†å¸ƒå¼åŸ¹è®­ï¼ç”±äºæˆ‘ä»¬é€šå¸¸æ›´å–œæ¬¢åˆ©ç”¨é¢„è®­ç»ƒçš„æ¨¡å‹æˆ–ç°æœ‰çš„æ¶æ„ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½ä»å¤´æ„å»ºæ¨¡å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨çš„ä»»ä½•ä¸œè¥¿éƒ½éœ€è¦èƒ½å¤Ÿè½»æ¾åœ°ä¸åŒ…å«æœ€å…ˆè¿›æ¨¡å‹çš„å…¶ä»–åº“äº’æ“ä½œï¼Œæˆ‘ä¸ªäººæœ€å–œæ¬¢çš„æ˜¯ [timm](https://github.com/rwightman/pytorch-image-models) å’Œ [transformers](https://huggingface.co/transformers/) ã€‚

åœ¨ CSE å·¥ä½œæ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬'*ä¸æˆ‘ä»¬çš„å®¢æˆ·'*'ä¸€èµ·ç¼–ç ï¼Œåœ¨é¡¹ç›®æœŸé—´ä½œä¸ºä¸€ä¸ªå›¢é˜Ÿå·¥ä½œã€‚å½“æˆ‘ä»¬ä¸å…·æœ‰ä¸åŒ ML æˆç†Ÿåº¦çº§åˆ«çš„å›¢é˜Ÿä¸€èµ·å·¥ä½œæ—¶ï¼Œæˆ‘ä»¬çš„è®¸å¤šé˜Ÿå‹éƒ½æ˜¯ç¬¬ä¸€æ¬¡è¢«ä»‹ç»åˆ° PyTorchï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¡®ä¿å­¦ä¹ æ›²çº¿å°½å¯èƒ½æµ…ï¼›ä¸è¦è®©ä»–ä»¬è¢«å¤§é‡çš„ä¿¡æ¯æ·¹æ²¡ï¼Œå……åˆ†åˆ©ç”¨æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åˆä½œçš„æ—¶é—´ã€‚æˆ‘ä»¬è¿˜å¿…é¡»æ³¨æ„ï¼Œæˆ‘ä»¬å¸Œæœ›å®¢æˆ·åœ¨æ²¡æœ‰æˆ‘ä»¬çš„æƒ…å†µä¸‹ç»§ç»­ç»´æŠ¤ä»»ä½•äº§ç”Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»å°½å¯èƒ½ä¿æŒäº‹æƒ…ç®€å•æ˜“æ‡‚å’Œæ˜“äºç»´æŠ¤ã€‚

å°½ç®¡æˆ‘æ˜¯è¿™ä¸€é¢†åŸŸä¸­å‡ ç§ä¸åŒè§£å†³æ–¹æ¡ˆçš„é•¿æœŸç”¨æˆ·ï¼Œä½†æˆ‘åå¤å‘ç°è‡ªå·±åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œæˆ‘æ­£åœ¨ä½¿ç”¨çš„ç°æœ‰å·¥å…·ä¸å¤ªé€‚åˆæˆ‘çš„ç”¨ä¾‹ï¼Œæˆ–è€…æ˜¯ç”±äºå¼•å…¥çš„å¤æ‚æ€§æ°´å¹³ï¼Œæˆ–è€…æ˜¯ç”±äºå¿…é¡»å­¦ä¹  PyTorch ä¹‹ä¸Šçš„æ–°å·¥å…·çš„å¤æ‚æ€§ï¼Œæˆ–è€…æ˜¯å‘ç°å®šä¹‰æŠ½è±¡çš„æ–¹å¼ä¸æˆ‘è¯•å›¾åšçš„äº‹æƒ…ä¸å¤ªä¸€è‡´ã€‚

å› æ­¤ï¼Œå°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘å†³å®šåˆ›å»ºä¸€ä¸ªéå¸¸ç®€å•çš„é€šç”¨åŸ¹è®­å¾ªç¯ï¼Œä»¥æ–¹ä¾¿å®¢æˆ·ä½¿ç”¨ PyTorch å¹¶åŠ é€Ÿå¼€å‘ï¼ŒåŒæ—¶ä¿æŒæˆ‘ä»¬æ‰€éœ€çš„çµæ´»æ€§æ°´å¹³ï¼›å°½å¯èƒ½åˆ©ç”¨ç°æœ‰å·¥å…·ã€‚è¿™è¢«æœ‰æ„è®¾è®¡æˆä¸€ä¸ªéå¸¸è–„çš„æŠ½è±¡ï¼Œå…·æœ‰æµçº¿å‹çš„ç‰¹æ€§é›†ï¼Œä½¿å¾—ç†è§£ã€ä¿®æ”¹å’Œè°ƒè¯•å˜å¾—å®¹æ˜“ã€‚åœ¨æ”¶åˆ°æ¥è‡ªå®¢æˆ·å’ŒåŒäº‹çš„ç§¯æåé¦ˆåï¼Œæˆ‘è¢«è¯´æœ[åœ¨ PyPI](https://pypi.org/project/pytorch-accelerated/) ä¸Šä¸ºä»»ä½•å¯èƒ½å‘ç°è¿™ç§è§£å†³æ–¹æ¡ˆæœ‰ç”¨çš„äººæä¾›è¿™ç§è§£å†³æ–¹æ¡ˆã€‚

## *pytorch åŠ é€Ÿ*é’ˆå¯¹çš„æ˜¯è°ï¼Ÿ

*   ç†Ÿæ‚‰ PyTorch ä½†å¸Œæœ›é¿å…ç¼–å†™é€šç”¨è®­ç»ƒå¾ªç¯æ ·æ¿æ–‡ä»¶ä»¥å…³æ³¨è®­ç»ƒå¾ªç¯ä¸­æœ‰è¶£éƒ¨åˆ†çš„ç”¨æˆ·ã€‚
*   å–œæ¬¢å¹¶ä¹ æƒ¯äºé€‰æ‹©å’Œåˆ›å»ºè‡ªå·±çš„æ¨¡å‹ã€æŸå¤±å‡½æ•°ã€ä¼˜åŒ–å™¨å’Œæ•°æ®é›†çš„ç”¨æˆ·ã€‚
*   é‡è§†ç®€å•å’Œæµçº¿å‹ç‰¹æ€§é›†çš„ç”¨æˆ·ï¼Œå…¶è¡Œä¸ºæ˜“äºè°ƒè¯•ã€ç†è§£å’Œæ¨ç†ï¼

## ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ç”¨ pytorch åŠ é€Ÿï¼Ÿ

*   å¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªç«¯åˆ°ç«¯çš„è§£å†³æ–¹æ¡ˆï¼Œæ¶µç›–ä»åŠ è½½æ•°æ®åˆ°æ¨æ–­çš„ä¸€åˆ‡ï¼Œå¸®åŠ©ä½ é€‰æ‹©æ¨¡å‹ã€ä¼˜åŒ–å™¨æˆ–æŸå¤±å‡½æ•°ï¼Œä½ å¯èƒ½ä¼šæ›´é€‚åˆ [fastai](https://github.com/fastai/fastai) ã€‚pytorch-accelerated åªå…³æ³¨è®­ç»ƒè¿‡ç¨‹ï¼Œå…¶ä»–æ‰€æœ‰é—®é¢˜éƒ½ç”±ç”¨æˆ·è´Ÿè´£ã€‚
*   å¦‚æœä½ æƒ³è‡ªå·±ç¼–å†™æ•´ä¸ªè®­ç»ƒå¾ªç¯ï¼Œåªæ˜¯æ²¡æœ‰æ‰€æœ‰çš„è®¾å¤‡ç®¡ç†é—®é¢˜ï¼Œä½ å¯èƒ½æœ€é€‚åˆä½¿ç”¨æ‹¥æŠ±è„¸[åŠ é€Ÿ](https://github.com/huggingface/accelerate)ï¼è™½ç„¶å¯ä»¥å®šåˆ¶ [**è®­ç»ƒå™¨**](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer) çš„æ¯ä¸€éƒ¨åˆ†ï¼Œä½†è®­ç»ƒå¾ªç¯åŸºæœ¬ä¸Šè¢«åˆ†è§£æˆè®¸å¤šä¸åŒçš„æ–¹æ³•ï¼Œæ‚¨å¿…é¡»è¦†ç›–è¿™äº›æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œåœ¨ä½ èµ°ä¹‹å‰ï¼Œå†™é‚£äº›`for`å¾ªç¯çœŸçš„é‡è¦åˆ°è¶³ä»¥ä¿è¯ä»å¤´å†æ¥*å—*ğŸ˜‰ã€‚
*   å¦‚æœæ‚¨æ­£åœ¨å¤„ç†ä¸€ä¸ªå®šåˆ¶çš„ã€é«˜åº¦å¤æ‚çš„ç”¨ä¾‹ï¼Œå®ƒä¸é€‚åˆé€šå¸¸çš„è®­ç»ƒå¾ªç¯æ¨¡å¼ï¼Œå¹¶ä¸”æƒ³è¦åœ¨æ‚¨é€‰æ‹©çš„ç¡¬ä»¶ä¸ŠæŒ¤å‡ºæœ€åä¸€ç‚¹æ€§èƒ½ï¼Œæ‚¨å¯èƒ½æœ€å¥½åšæŒä½¿ç”¨ vanilla PyTorch ä»»ä½•é«˜çº§ API åœ¨é«˜åº¦ä¸“ä¸šåŒ–çš„æƒ…å†µä¸‹éƒ½ä¼šæˆä¸ºå¼€é”€ï¼

# ä¸ºä»€ä¹ˆ PyTorch éœ€è¦ä¸€ä¸ªé«˜çº§ APIï¼Ÿ

å¯¹äºé‚£äº›ä¸ç†Ÿæ‚‰ PyTorch çš„äººæ¥è¯´ï¼Œä½ å¯èƒ½æƒ³çŸ¥é“ï¼Œä¸ºä»€ä¹ˆ PyTorch ç”šè‡³éœ€è¦ä¸€ä¸ªé«˜çº§ APIï¼Ÿå®ƒçœŸçš„å¦‚æ­¤å¤æ‚ä»¥è‡³äºæ‰€æœ‰è¿™äº›ä¸åŒçš„è§£å†³æ–¹æ¡ˆéƒ½å¿…é¡»å»ºç«‹åœ¨å®ƒçš„åŸºç¡€ä¸Šå—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨å®ƒå‘¢ï¼Ÿï¼

ç”±äºå…¶çµæ´»æ€§ã€æ˜“äºè°ƒè¯•ä»¥åŠä¸ Python OOP å®è·µä¸€è‡´çš„ç¼–ç é£æ ¼ï¼ŒPyTorch æ­£åœ¨è¿…é€Ÿæˆä¸º Python ä¸­æœºå™¨å­¦ä¹ ç ”ç©¶çš„é¦–é€‰å·¥å…·ã€‚ç„¶è€Œï¼Œå°½ç®¡ PyTorch æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œä½†å®ƒå¯¹æ—¥å¸¸ä»ä¸šè€…æ¥è¯´ç¼ºå°‘ä¸€ä¸ªä¸œè¥¿â€”â€”ç¼ºå°‘ä¸€ä¸ªé€šç”¨çš„è®­ç»ƒå¾ªç¯ï¼Œæˆ–â€œfitâ€åŠŸèƒ½ã€‚ç”±äºè¿™ç§ç¼ºå¤±ï¼Œä¸€äº›å›¾ä¹¦é¦†è¯•å›¾ç”¨å„ç§æ–¹æ³•æ¥å¡«è¡¥è¿™ä¸€ç©ºç™½ã€‚

è™½ç„¶ç¼ºå°‘é€šç”¨å¾ªç¯ç»å¸¸è¢«è®¤ä¸ºæ˜¯ä¸€ç§ä¼˜åŠ¿ï¼Œå› ä¸ºå®ƒè¿«ä½¿ä»ä¸šè€…å¯¹åŸ¹è®­è¿‡ç¨‹çš„æ‰€æœ‰éƒ¨åˆ†è´Ÿè´£ï¼Œè¿™å¯¼è‡´åœ¨æ¯ä¸ªæ–°é¡¹ç›®çš„å¼€å§‹éƒ½éœ€è¦ç±»ä¼¼çš„æ ·æ¿ä»£ç ã€‚è¿™å¯¼è‡´äº†å®ç°é”™è¯¯ï¼Œå¹¶ä¸”ç¼ºä¹ä¸€ä¸ªå…¬å…±çš„ç»“æ„å¯¼è‡´äº†ä¸åŒé¡¹ç›®ä¸­çš„è®­ç»ƒå¾ªç¯ä¹‹é—´çš„ä¸ä¸€è‡´æ€§ï¼›å®ç°å¯èƒ½åƒå·®ä¸‡åˆ«ï¼Œè¿™ä½¿å¾—ç†è§£å’Œç»´æŠ¤ä»£ç åº“å˜å¾—å›°éš¾ï¼Œé™¤éæ‚¨ç†Ÿæ‚‰è¿™ä¸ªé¡¹ç›®â€”â€”å³ä½¿æ‚¨å¯¹ PyTorch æœ‰å¾ˆå¥½çš„ç†è§£ï¼

æ­¤å¤–ï¼Œè™½ç„¶ PyTorch ä¸ºç»„ä»¶æä¾›äº†è‰¯å¥½ã€æ¸…æ™°çš„æŠ½è±¡ï¼Œä½¿ç®€å•çš„åº”ç”¨ç¨‹åºæ˜“äºä¸Šæ‰‹ï¼Œä½†ç”±äºå¼•å…¥åˆ†å¸ƒå¼å’Œæ··åˆç²¾åº¦è®­ç»ƒã€åº¦é‡è®¡ç®—å’Œæ—¥å¿—è®°å½•ç­‰å› ç´ ï¼Œå¤æ‚æ€§ä¼šè¿…é€Ÿå¢åŠ ï¼›æ¨¡ç³Šæ•™ç¨‹ä¸­ç»å¸¸å‡ºç°çš„â€œç®€å•â€é£æ ¼çš„å¾ªç¯ã€‚ç”±äºå¿…é¡»æ˜¾å¼ç®¡ç†æ•°æ®å‘è®¾å¤‡çš„ä¼ è¾“ï¼Œè¿™æœ¬èº«å°±å¢åŠ äº†å¤§é‡çš„æ ·æ¿æ–‡ä»¶ï¼

è™½ç„¶çº¯ PyTorch æ— ç–‘æ˜¯é«˜åº¦å¤æ‚çš„ã€éœ€è¦å¤§é‡çµæ´»æ€§çš„å®šåˆ¶ä»»åŠ¡çš„æœ€ä½³æ–¹æ³•ï¼Œä½†å¯¹äºâ€œå¤§å¤šæ•°â€ç”¨ä¾‹æ¥è¯´ï¼Œè¿™ç§ç²’åº¦çº§åˆ«ä¼¼ä¹å¤ªä½äº†ã€‚

# é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆå« pytorch åŠ é€Ÿå‘¢ï¼Ÿ

é™¤äº†æœ¬åº“çš„ä¸»è¦ç›®çš„æ˜¯å¸®åŠ©æ‚¨æ›´å¿«åœ°æé«˜ PyTorch çš„å·¥ä½œæ•ˆç‡ä¹‹å¤–ï¼Œå®ƒè¿˜æ˜¯å¯¹æœ¬åº“æ‰€åŸºäºçš„ä¸€ä¸ªé‡è¦åº•å±‚ç»„ä»¶çš„æ•¬æ„ã€‚

è‡³å°‘å¯¹æˆ‘æ¥è¯´ï¼Œä½¿ç”¨é«˜çº§å·¥å…·çš„ä¸»è¦åŠ¨æœºæ˜¯ç”±äºè®¾å¤‡ç®¡ç†ï¼Œä»¥åŠåœ¨è®¾ç½®åˆ†å¸ƒå¼åŸ¹è®­æ—¶è¿™å¯èƒ½å¯¼è‡´çš„æ½œåœ¨é—®é¢˜ã€‚éœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œåœ¨çº¯ PyTorch ä¸­è¿™æ ·åšå¹¶ä¸å¤ªå¤æ‚ï¼Œä½†è¿™ç¡®å®æ¶‰åŠåˆ°å¯¹è®­ç»ƒè„šæœ¬è¿›è¡Œå¤šå¤„ä¿®æ”¹ï¼Œä¾‹å¦‚:åœ¨æ¨¡å‹å‘¨å›´æ·»åŠ ä¸åŒçš„åŒ…è£…å™¨ï¼Œåœ¨è¿›ç¨‹ä¹‹é—´åŒæ­¥å’Œæ”¶é›†ç»“æœï¼Œç¡®ä¿åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè®¾ç½®ç‰¹å®šçš„ç¯å¢ƒå˜é‡ï¼Œä»¥åŠä½¿ç”¨ä¸“é—¨çš„å¯åŠ¨å‘½ä»¤å¼€å§‹è®­ç»ƒè¿è¡Œã€‚

ç„¶è€Œï¼Œ2021 å¹´ 4 æœˆï¼Œ[æŠ±æŠ±è„¸å‘å¸ƒäº†ä¼˜ç§€çš„ *accelerate* åº“](https://huggingface.co/blog/accelerate-library)ï¼Œå°†æ‰€æœ‰è¿™äº›å…³æ³¨ç‚¹å°è£…åˆ°ä¸€ä¸ªåŠ é€Ÿå™¨å¯¹è±¡ä¸­ã€‚è¿™ä½¿å¾—åˆ©ç”¨åˆ†å¸ƒå¼åŸ¹è®­å˜å¾—éå¸¸å®¹æ˜“ï¼Œè€Œä¸å¿…å°†æ‰€æœ‰çš„ä¸“å®¶ä»£ç å¼•å…¥åˆ°æ‚¨çš„è„šæœ¬ä¸­ï¼›å¯¹å…¶å¦‚ä½•è¿ä½œä¿æŒåˆç†çš„é€æ˜åº¦ã€‚

ä½ å¯èƒ½å·²ç»çŒœåˆ°äº†ï¼Œæˆ‘æ˜¯ä¸€ä¸ªå³æ—¶ç²‰ä¸ï¼Œå‡ ä¹ç«‹åˆ»å°±é‡‡ç”¨äº†å®ƒã€‚ä½†æ˜¯ï¼Œæ ¹æ®è®¾è®¡ï¼Œaccelerate ä¸æä¾›ä»»ä½•å…¶ä»–åŠŸèƒ½ï¼Œéœ€è¦ç”¨æˆ·ç¼–å†™å’Œç»´æŠ¤è‡ªå·±çš„è®­ç»ƒå¾ªç¯ã€‚åœ¨ä¸€äº›ç”¨ä¾‹ä¹‹åï¼Œæˆ‘æ³¨æ„åˆ°æˆ‘çš„å¤§å¤šæ•°åŠ é€Ÿè„šæœ¬å¼€å§‹çœ‹èµ·æ¥éå¸¸ç›¸ä¼¼ï¼Œæˆ‘å¼€å§‹è¶Šæ¥è¶Šå¤šåœ°æ³¨æ„åˆ°æˆ‘è„‘æµ·ä¸­çš„ä¸€ä¸ªå°å°çš„å£°éŸ³ï¼Œå®ƒä¸æ–­åœ°æé†’æˆ‘ï¼Œé€šè¿‡å¤åˆ¶å’Œç²˜è´´ä¸Šä¸€ä¸ªé¡¹ç›®çš„ä»£ç æ¥å¯åŠ¨æ¯ä¸ªæ–°é¡¹ç›®å¯èƒ½ä¸æ˜¯æœ€å¥½çš„æ–¹æ³•â€¦

å¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ˜¯å·©å›ºè¿™äº›çŸ¥è¯†å’Œåˆ›å»ºæˆ‘è‡ªå·±çš„å›¾ä¹¦é¦†æ‰€éœ€è¦çš„æœ€åä¸€å‡»ï¼

*pytorch-accelerated* è‡ªè±ªè€Œé€æ˜åœ°å»ºç«‹åœ¨ [Hugging Face Accelerate](https://github.com/huggingface/accelerate) ä¹‹ä¸Šï¼Œåè€…è´Ÿè´£è®¾å¤‡ä¹‹é—´çš„æ•°æ®ç§»åŠ¨ã€DeepSpeed é›†æˆä»¥åŠè®­ç»ƒé…ç½®çš„å¯åŠ¨ã€‚

*ç°åœ¨æ‰€æœ‰çš„é—®é¢˜éƒ½è§£å†³äº†ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼*

# å…¥é—¨:åœ¨ MNIST ä¸Šè®­ç»ƒåˆ†ç±»å™¨

è®©æˆ‘ä»¬ä»ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­å¼€å§‹ï¼Œä½¿ç”¨ MNISTï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšï¼Œæˆ‘ä»¬çœŸçš„ä¼šåšæ·±åº¦å­¦ä¹ å—ï¼Ÿï¼

é¦–å…ˆè¦åšçš„æ˜¯å®‰è£…è½¯ä»¶åŒ…ã€‚ä¸ºäº†å¸®åŠ©æˆ‘ä»¬å¼€å§‹ï¼Œæˆ‘ä»¬è¿˜åŒ…æ‹¬äº†è¿è¡Œç¤ºä¾‹å¯èƒ½éœ€è¦çš„ä»»ä½•åŒ…:

`pip install pytorch-accelerated[examples]`

## åˆ›å»ºåŸ¹è®­è„šæœ¬

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºæˆ‘ä»¬çš„åŸ¹è®­è„šæœ¬ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½æ•°æ®ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼ŒMNIST å®é™…ä¸Šæ˜¯æ·±åº¦å­¦ä¹ çš„å¯¹ç­‰ç‰© *Helloï¼ŒWorld* ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä» torchvision åšè¿™ä»¶äº‹ï¼›å®ƒç”šè‡³æœ‰ä¸€ä¸ªå†…ç½®çš„æ•°æ®é›†ï¼

```
import osfrom torch.utils.data import random_split
from torchvision import transforms
from torchvision.datasets import MNISTdataset = MNIST(os.getcwd(), download=True, transform=transforms.ToTensor())train_dataset, validation_dataset, test_dataset = random_split(
    dataset, [50000, 5000, 5000]
)
```

è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ ‡å‡†çš„è½¬æ¢å°†æ•°æ®è½¬æ¢ä¸º PyTorch å¼ é‡ï¼Œç„¶åå°†æ•°æ®é›†éšæœºåˆ†ä¸ºè®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦å°±æ¨¡å‹æ¶æ„ã€æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨è¾¾æˆä¸€è‡´ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ä»»åŠ¡ï¼Œè®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç®€å•çš„å‰é¦ˆç¥ç»ç½‘ç»œï¼Œå¹¶ä½¿ç”¨ SGD å’Œ momentum ä½œä¸ºæˆ‘ä»¬çš„ä¼˜åŒ–å™¨ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªåˆ†ç±»ä»»åŠ¡ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨[äº¤å‰ç†µ](https://pytorch.org/docs/stable/generated/torch.nn.CrossEntropyLoss.html)ä½œä¸ºæˆ‘ä»¬çš„æŸå¤±å‡½æ•°ã€‚æ³¨æ„ï¼Œç”±äºäº¤å‰ç†µåŒ…æ‹¬ SoftMax è®¡ç®—ï¼Œæˆ‘ä»¬ä¸éœ€è¦å°†å®ƒä½œä¸ºæ¨¡å‹æ¶æ„çš„ä¸€éƒ¨åˆ†ã€‚

```
from torch import nn, optimclass MNISTModel(nn.Module):
    def __init__(self):
        super().__init__()
        self.main = nn.Sequential(
            nn.Linear(in_features=784, out_features=128),
            nn.ReLU(),
            nn.Linear(in_features=128, out_features=64),
            nn.ReLU(),
            nn.Linear(in_features=64, out_features=10),
        )

    def forward(self, x):
        return self.main(x.view(x.shape[0], -1))model = MNISTModel()
optimizer = optim.SGD(model.parameters(), lr=0.001, momentum=0.9)
loss_func = nn.CrossEntropyLoss()
```

è¿™é€šå¸¸æ˜¯æˆ‘ä»¬å¼€å§‹è€ƒè™‘ç¼–å†™è®­ç»ƒå¾ªç¯çš„æ—¶å€™ã€‚ç„¶è€Œï¼Œå¤šäºäº† *pytorch åŠ é€Ÿï¼Œ*æˆ‘ä»¬è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼è¦å¼€å§‹ï¼Œæˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯å¯¼å…¥[è®­ç»ƒå™¨](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer)ã€‚

```
from pytorch_accelerated import Trainertrainer = Trainer(
    model,
    loss_func=loss_func,
    optimizer=optimizer,
)
```

[è®­ç»ƒå™¨](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer)è®¾è®¡ç”¨äºå°è£…ç‰¹å®šä»»åŠ¡çš„æ•´ä¸ªè®­ç»ƒå¾ªç¯ï¼Œå°†æ¨¡å‹ã€æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨ç»“åˆåœ¨ä¸€èµ·ï¼Œå¹¶ä¸ºè®­ç»ƒè¿‡ç¨‹çš„æ¯ä¸ªæ­¥éª¤æä¾›è¦æ‰§è¡Œçš„è¡Œä¸ºè§„èŒƒã€‚

[è®­ç»ƒå™¨](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer)çš„ä¸»è¦å…¥å£æ˜¯[è®­ç»ƒ](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer.train)æ–¹æ³•ï¼Œå®ƒå°†åœ¨æˆ‘ä»¬æä¾›çš„æ•°æ®é›†ä¸Šè¿è¡Œè®­ç»ƒå’Œè¯„ä¼°å¾ªç¯ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸ºè®­ç»ƒè¿è¡Œè®¾ç½®ç‰¹å®šé…ç½®çš„åœ°æ–¹ï¼Œæ¯”å¦‚è®­ç»ƒå¤šå°‘ä¸ªæ—¶æœŸä»¥åŠä½¿ç”¨å¤šå°‘æ‰¹ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç®¡ç†ä»»ä½•é—®é¢˜çš„åœ°æ–¹ï¼Œä¾‹å¦‚å­¦ä¹ ç‡è®¡åˆ’ã€è°ƒæ•´æˆ‘ä»¬çš„æ•°æ®åŠ è½½å™¨æˆ–ç´¯ç§¯æ¢¯åº¦ï¼Œä½†ç”±äºè¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬ç°åœ¨å°†è·³è¿‡è¿™äº›ï¼

```
trainer.train(
    train_dataset=train_dataset,
    eval_dataset=validation_dataset,
    num_epochs=2,
    per_device_batch_size=32,
)
```

æ­¤å¤–ï¼Œ *pytorch åŠ é€Ÿçš„*æ”¯æŒåˆ†å¸ƒå¼è¯„ä¼°ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬çš„è®­ç»ƒè¿è¡Œç»“æŸåï¼Œè®©æˆ‘ä»¬åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°æ¨¡å‹ã€‚ç”±äºæˆ‘ä»¬åœ¨è¯„ä¼°è¿‡ç¨‹ä¸­ä¸ä¼šè®¡ç®—ä»»ä½•æ¢¯åº¦ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å°†æ‰¹é‡åŠ å€ã€‚

```
trainer.evaluate(
    dataset=test_dataset,
    per_device_batch_size=64,
)
```

ç°åœ¨æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†æ‰€éœ€çš„æ‰€æœ‰å…³é”®æ­¥éª¤ï¼Œè®©æˆ‘ä»¬å°†æ‰€æœ‰è¿™äº›æ­¥éª¤åˆå¹¶åˆ°ä¸€ä¸ªåŸ¹è®­è„šæœ¬ä¸­:

## å¯åŠ¨åŸ¹è®­

æ—¢ç„¶æˆ‘ä»¬å·²ç»ç¼–å†™äº†åŸ¹è®­è„šæœ¬ï¼Œå‰©ä¸‹è¦åšçš„å°±æ˜¯å¯åŠ¨åŸ¹è®­ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨æ‹¥æŠ±è„¸åŠ é€Ÿã€‚Accelerate æä¾›äº† [accelerate CLI](https://huggingface.co/docs/accelerate/quicktour.html#launching-your-distributed-script) ï¼Œå› æ­¤æ— è®ºæˆ‘ä»¬çš„åº•å±‚ç¡¬ä»¶è®¾ç½®å¦‚ä½•ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨ä¸€è‡´çš„å‘½ä»¤æ¥å¯åŠ¨åŸ¹è®­ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæˆ‘ä»¬çš„åŸ¹è®­åˆ›å»ºä¸€ä¸ªé…ç½®ã€‚è¿™å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼ä¹‹ä¸€æ¥å®ç°ï¼›æˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬çš„ç³»ç»Ÿå­˜å‚¨ä¸€ä¸ªæœ¬åœ°é…ç½®ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚ä¸ºäº†é€æ˜ï¼Œæˆ‘æ›´å–œæ¬¢ç”¨åè€…ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å®ç°è¿™ä¸€ç‚¹:

```
accelerate config --config_file train_mnist.yaml
```

è¯¥å‘½ä»¤å°†è¯¢é—®ä¸€ç³»åˆ—é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å°†ç”¨äºç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚

![](img/69ce180110a68903e50de8b68dcdbb88.png)

åŠ é€Ÿé…ç½®å‘½ä»¤çš„è¾“å‡º

å›ç­”ä¸Šè¿°é—®é¢˜ä¼šç”Ÿæˆä»¥ä¸‹é…ç½®æ–‡ä»¶:

![](img/e55ded1ac89c62ae432f1099d4660d30.png)

ç”±` accelerate config-config _ file train_mnist.yaml `ç”Ÿæˆçš„ train _ Mn ist . YAML é…ç½®æ–‡ä»¶

**æ³¨æ„:**è¦æ›´æ”¹æ­¤é…ç½®ï¼Œå»ºè®®å†æ¬¡è¿è¡Œå‘½ä»¤ï¼Œè€Œä¸æ˜¯ç›´æ¥ç¼–è¾‘æ­¤æ–‡ä»¶ï¼

ç°åœ¨ï¼Œè¦å¯åŠ¨åŸ¹è®­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤:

```
accelerate launch --config_file train_mnist.yaml train_mnist.py
```

è¿™å°†äº§ç”Ÿå¦‚ä¸‹æ‰€ç¤ºçš„è¾“å‡º:

![](img/0eba888806e958a36259c13222648f80.png)

è¿è¡ŒåŸ¹è®­è„šæœ¬æ—¶äº§ç”Ÿçš„è¾“å‡º

æ ¹æ®æ‰€ä½¿ç”¨çš„[å›è°ƒ](https://pytorch-accelerated.readthedocs.io/en/latest/callbacks.html)ï¼Œå¯ä»¥å®šåˆ¶è¾“å‡ºçš„ç¡®åˆ‡å†…å®¹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªæ˜¯ä½¿ç”¨[è®­ç»ƒå¸ˆ](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer)çš„é»˜è®¤å€¼ã€‚

è¿™å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨ 2 ä¸ª GPU è®­ç»ƒä¸€ä¸ªæ¨¡å‹æ‰€éœ€è¦åšçš„ä¸€åˆ‡ï¼

*å…³äºè®­ç»ƒå¾ªç¯ä¸­æ‰§è¡Œé¡ºåºçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§:* [*è®­ç»ƒå™¨å†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ*T9*ã€‚*](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#inside-trainer)

# è·Ÿè¸ªæŒ‡æ ‡

æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ[è®­ç»ƒå™¨](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer)è·Ÿè¸ªçš„å”¯ä¸€å€¼æ˜¯æ¯ä¸ªæ—¶æœŸçš„æŸå¤±ã€‚è¿™æ˜¯å› ä¸ºé€‚å½“çš„åº¦é‡æ ‡å‡†ä¸¥é‡ä¾èµ–äºä»»åŠ¡ï¼è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è·Ÿè¸ªå…¶ä»–æŒ‡æ ‡ã€‚

*ä¸ºäº†è®¡ç®—æˆ‘ä»¬çš„æŒ‡æ ‡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨*[*torch metrics*](https://torchmetrics.readthedocs.io/en/latest/)*ï¼Œå®ƒä»¬æ˜¯åˆ†å¸ƒå¼åŸ¹è®­å…¼å®¹çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦åœ¨è®¡ç®—æŒ‡æ ‡ä¹‹å‰æ”¶é›†æ¥è‡ªä¸åŒæµç¨‹çš„ç»“æœã€‚*

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–ä¸¤ç§ä¸åŒçš„æ–¹æ³•:

1.  è®­ç»ƒå‘˜çš„å­ç±»åŒ–
2.  ä½¿ç”¨å›è°ƒ

å†³å®šé‡‡ç”¨å“ªç§æ–¹æ³•å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºç”¨æˆ·çš„åå¥½ã€‚æ–‡ä»¶ä¸­ç»™å‡ºäº†ä»¥ä¸‹æŒ‡å—:

> å»ºè®®ä½¿ç”¨å›è°ƒæ¥åŒ…å«â€œåŸºç¡€ç»“æ„â€ä»£ç ï¼Œè¿™å¯¹äºè®­ç»ƒå¾ªç¯çš„æ“ä½œ(å¦‚æ—¥å¿—è®°å½•)æ¥è¯´å¹¶ä¸é‡è¦ï¼Œä½†è¿™ä¸€å†³å®šç”±ç”¨æˆ·æ ¹æ®å…·ä½“çš„ç”¨ä¾‹æ¥åˆ¤æ–­ã€‚

ç”±äºè®¡ç®—æŒ‡æ ‡å¹¶ä¸å½±å“æˆ‘ä»¬çš„è®­ç»ƒä»£ç ï¼Œå®ƒå¯èƒ½å¾ˆé€‚åˆå›è°ƒï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸å¿…å­ç±»åŒ–è®­ç»ƒå™¨ã€‚ç„¶è€Œï¼Œç”±äºå›è°ƒæ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿è¿™ä¸ªå›è°ƒä¼šåœ¨æŒ‡æ ‡è¢«æ‰“å°ä¹‹å‰è¢«è°ƒç”¨ï¼

è®©æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹è¿™ä¸¤ç§æ–¹æ³•ã€‚

## è®­ç»ƒå‘˜çš„å­ç±»åŒ–

è™½ç„¶[è®­ç»ƒå™¨](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer)åº”è¯¥åœ¨ç®€å•çš„ç”¨ä¾‹ä¸­å¼€ç®±å³ç”¨ï¼Œä½†æ˜¯å­ç±»åŒ–è®­ç»ƒå™¨å¹¶è¦†ç›–å…¶æ–¹æ³•æ˜¯æœ‰æ„çš„ï¼Œä¹Ÿæ˜¯è¢«é¼“åŠ±çš„â€”â€”æŠŠåŸºç¡€å®ç°æƒ³è±¡æˆä¸€ç»„'*åˆç†çš„ç¼ºçœå€¼*'ï¼

*[*è®­ç»ƒå™¨*](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer) *æœ‰å¾ˆå¤šä¸åŒçš„æ–¹æ³•å¯ä»¥è¢«è¦†ç›–ï¼Œåœ¨æ–‡æ¡£* [*è¿™é‡Œ*](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#customizing-trainer-behaviour) *ä¸­æœ‰æè¿°ã€‚è¦è®°ä½çš„ä¸»è¦äº‹æƒ…æ˜¯ï¼Œä»¥åŠ¨è¯ä¸ºå‰ç¼€çš„æ–¹æ³•ï¼Œä¾‹å¦‚* `create` *æˆ–* `calculate` *æœŸæœ›è¿”å›ä¸€ä¸ªå€¼ï¼Œæ‰€æœ‰å…¶ä»–æ–¹æ³•éƒ½ç”¨äºè®¾ç½®å†…éƒ¨çŠ¶æ€(ä¾‹å¦‚* `optimizer.step()` *)**

*è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª[è®­ç»ƒå™¨](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer) çš„å­ç±»ï¼Œå®ƒè·Ÿè¸ªä¸€ç»„åˆ†ç±»æŒ‡æ ‡ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ¯ä¸ªè¯„ä¼°æ‰¹æ¬¡ç»“æŸæ—¶ï¼Œæˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„æŒ‡æ ‡â€”â€”ä¸ºäº†é¿å…é‡å†™å®é™…çš„è¯„ä¼°é€»è¾‘ï¼Œæˆ‘ä»¬åˆšåˆšä¸ºæ­¤è°ƒç”¨äº†é»˜è®¤å®ç°â€”â€”ç„¶ååœ¨æ¯ä¸ªè¯„ä¼°å‘¨æœŸç»“æŸæ—¶è®¡ç®—å®ƒä»¬ã€‚*

*[è®­ç»ƒå™¨](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer) ç»´æŠ¤ä¸€ä¸ª[è¿è¡Œå†å²](https://pytorch-accelerated.readthedocs.io/en/latest/tracking.html#runhistory)ï¼Œé»˜è®¤æƒ…å†µä¸‹ç”¨äºè·Ÿè¸ªæŸå¤±ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥è·Ÿè¸ªæˆ‘ä»¬è®¡ç®—çš„æŒ‡æ ‡ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ç®¡ç†è·Ÿè¸ªï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªé¢å¤–çš„å¥½å¤„ï¼Œå³åŒ…å«åœ¨[è¿è¡Œå†å²](https://pytorch-accelerated.readthedocs.io/en/latest/tracking.html#runhistory)ä¸­çš„ä»»ä½•æŒ‡æ ‡å°†åœ¨æ¯ä¸ªæ—¶æœŸç»“æŸæ—¶è¢«è®°å½•ï¼*

*åœ¨æˆ‘ä»¬çš„è„šæœ¬ä¸­ä½¿ç”¨æˆ‘ä»¬çš„æ–°æ•™ç»ƒï¼Œæˆ‘ä»¬çš„è„šæœ¬ç°åœ¨çœ‹èµ·æ¥åƒè¿™æ ·:*

*ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¯åŠ¨:*

```
*accelerate launch --config_file train_mnist.yaml train_with_metrics_in_loop.py*
```

*æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåº¦é‡æ˜¯åœ¨æ¯ä¸ªæ—¶æœŸçš„æœ«å°¾æ‰“å°å‡ºæ¥çš„ï¼*

*![](img/be2c781bd0e3fc1ae56beb7f48f79e68.png)*

*åœ¨å¾ªç¯ä¸­è¿è¡Œå¸¦æœ‰æŒ‡æ ‡çš„åŸ¹è®­è„šæœ¬æ—¶äº§ç”Ÿçš„è¾“å‡º*

## *ä½¿ç”¨å›è°ƒ*

*å¯¹äºè¿™æ ·ä¸€ä¸ªå°çš„è°ƒæ•´ï¼Œæ¯”å¦‚æ·»åŠ åº¦é‡ï¼Œä½ å¯èƒ½ä¼šè§‰å¾—å­ç±»åŒ–[è®­ç»ƒå™¨](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer)æœ‰ç‚¹è¿‡åˆ†ï¼Œå¹¶ä¸”æ›´å–œæ¬¢ä½¿ç”¨åŸºæœ¬å®ç°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å›è°ƒæ¥æ‰©å±•é»˜è®¤è®­ç»ƒå™¨çš„è¡Œä¸ºã€‚*

*è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å›è°ƒï¼Œæˆ‘ä»¬å¯ä»¥å­ç±»åŒ– [TrainerCallback](https://pytorch-accelerated.readthedocs.io/en/latest/callbacks.html#pytorch_accelerated.callbacks.TrainerCallback) å¹¶è¦†ç›–ç›¸å…³çš„æ–¹æ³•ï¼›è¿™äº›åœ¨çš„æ–‡æ¡£[ä¸­æœ‰æè¿°ã€‚ä¸ºäº†é¿å…ä¸](https://pytorch-accelerated.readthedocs.io/en/latest/callbacks.html#creating-new-callbacks)[è®­ç»ƒå™¨](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer)çš„æ–¹æ³•æ··æ·†ï¼Œæ‰€æœ‰å›è°ƒæ–¹æ³•éƒ½å¸¦æœ‰å‰ç¼€`_on`ã€‚*

*è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„å›è°ƒæ¥è·Ÿè¸ªæˆ‘ä»¬çš„åˆ†ç±»æŒ‡æ ‡:*

*åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»£ç å‡ ä¹ä¸æˆ‘ä»¬åœ¨å‰ä¸€ä¸ªä¾‹å­ä¸­æ·»åŠ åˆ°è®­ç»ƒå™¨çš„ä»£ç ç›¸åŒã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åŸ¹è®­æˆ–è¯„ä¼°å¼€å§‹æ—¶æ‰‹åŠ¨å°†æŒ‡æ ‡ç§»åŠ¨åˆ°æ­£ç¡®çš„è®¾å¤‡ä¸Šã€‚å¹¸è¿çš„æ˜¯ï¼Œ[è®­ç»ƒå™¨](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer)é€šè¿‡æ ¹æ®ä¸Šä¸‹æ–‡è¿”å›æ­£ç¡®çš„è®¾å¤‡ï¼Œè®©æˆ‘ä»¬å˜å¾—ç®€å•ï¼*

*è¦ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨åˆ›å»ºæ—¶å°†å®ƒåŒ…å«åœ¨æˆ‘ä»¬ä¼ é€’ç»™æˆ‘ä»¬çš„[è®­ç»ƒå¸ˆ](https://pytorch-accelerated.readthedocs.io/en/latest/trainer.html#pytorch_accelerated.trainer.Trainer)çš„å›è°ƒåˆ—è¡¨ä¸­ã€‚å› ä¸ºæˆ‘ä»¬æƒ³ä¿ç•™é»˜è®¤è¡Œä¸ºï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ‰€æœ‰é»˜è®¤å›è°ƒä¹‹å‰åŒ…å«äº†è¿™ä¸ªè¡Œä¸ºã€‚*

```
*trainer = Trainer(
    model,
    loss_func=loss_func,
    optimizer=optimizer,
    callbacks=(
        ClassificationMetricsCallback(
            num_classes=num_classes,
        ),
        *DEFAULT_CALLBACKS,
    ),
)*
```

*ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒæ•´åˆåˆ°æˆ‘ä»¬çš„åŸ¹è®­è„šæœ¬ä¸­:*

*åƒä»¥å‰ä¸€æ ·å¯åŠ¨å®ƒ:*

```
*accelerate launch --config_file train_mnist.yaml train_with_metrics_in_callback.py*
```

*æˆ‘ä»¬å°†è§‚å¯Ÿåˆ°ä¸ä¸Šä¸€ä¸ªç¤ºä¾‹ç›¸åŒçš„è¾“å‡ºã€‚*

# *ç»“è®º*

*å¸Œæœ›è¿™å·²ç»æä¾›äº†å…³äº *pytorch åŠ é€Ÿçš„*çš„ä»‹ç»å’Œè¶³å¤Ÿçš„ä¿¡æ¯æ¥æ¼”ç¤ºå¦‚ä½•å¼€å§‹ä½ è‡ªå·±çš„ç”¨ä¾‹ã€‚è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œæ–‡æ¡£å¯åœ¨æ­¤å¤„[è·å¾—](https://pytorch-accelerated.readthedocs.io/en/latest/index.html)ï¼Œæ›´å¤æ‚çš„åŸ¹è®­ç¤ºä¾‹å¯åœ¨ GitHub ä¸Š[è·å¾—ã€‚è§‰å¾—æœ‰ç”¨åˆ«å¿˜äº†åŠ æ˜Ÿï¼](https://github.com/Chris-hughes10/pytorch-accelerated/tree/main/examples)*

*æœŸå¾…æ›´å¤šçš„å¸–å­æ¥æ¶µç›–å¦‚ä½•å¤„ç†ä¸€äº›æ›´é«˜çº§çš„ç”¨ä¾‹ï¼Œä»¥åŠå¦‚ä½•åœ¨åŸ¹è®­æœŸé—´åº”ç”¨ä¸€äº›æˆ‘æœ€å–œæ¬¢çš„ PyTorch æŠ€å·§å’Œè¯€çªã€‚*

## *æ‰¿è®¤*

*pytorch-accelerated çš„è®¾è®¡å’Œç‰¹æ€§èƒŒåçš„è®¸å¤šæ–¹é¢éƒ½å—åˆ°äº†è®¸å¤šä¼˜ç§€åº“å’Œæ¡†æ¶çš„æå¤§å¯å‘ï¼Œå¦‚ [fastai](https://github.com/fastai/fastai) ã€ [timm](https://github.com/rwightman/pytorch-image-models) ã€ [PyTorch-lightning](https://github.com/PyTorchLightning/pytorch-lightning) å’ŒæŠ±æŠ±è„¸ [accelerate](https://github.com/huggingface/accelerate) ã€‚è¿™äº›å·¥å…·ä¸­çš„æ¯ä¸€ä¸ªéƒ½å¯¹è¿™ä¸ªåº“å’Œæœºå™¨å­¦ä¹ ç¤¾åŒºäº§ç”Ÿäº†å·¨å¤§çš„å½±å“ï¼Œä»–ä»¬çš„å½±å“æ˜¯ä¸è¨€è€Œå–»çš„ï¼*

*pytorch-accelerated ä»…ä»è¿™äº›å·¥å…·ä¸­è·å¾—çµæ„Ÿï¼Œå¹¶ä¸”åŒ…å«çš„æ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯ä»é›¶å¼€å§‹å®ç°çš„ï¼Œå¯¹æœ¬åº“æœ‰ç›Šã€‚å”¯ä¸€çš„ä¾‹å¤–æ˜¯ [examples](https://github.com/Chris-hughes10/pytorch-accelerated/tree/main/examples/) æ–‡ä»¶å¤¹ä¸­çš„ä¸€äº›è„šæœ¬ï¼Œä¸ºäº†å±•ç¤º *pytorch-accelerated* çš„ç‰¹æ€§ï¼Œè¿™äº›è„šæœ¬ä¸­çš„ç°æœ‰èµ„æºè¢«æå–å’Œä¿®æ”¹ï¼›è¿™äº›æ¡ˆä¾‹éƒ½æœ‰æ˜ç¡®çš„æ ‡è®°ï¼Œå¹¶æ³¨æ˜åŸä½œè€…ã€‚*

*æˆ‘è¿˜è¦æ„Ÿè°¢æˆ‘æ‰€æœ‰å‡ºè‰²çš„ CSE åŒäº‹ï¼Œä»–ä»¬ä¸º pytorch åŠ é€Ÿç‰ˆæä¾›äº†åé¦ˆï¼Œå¹¶å°±ä¸€ä¸ªå¥½çš„è§£å†³æ–¹æ¡ˆæä¾›äº†ä¸€äº›æƒ³æ³•ï¼*

**å…‹é‡Œæ–¯Â·ä¼‘æ–¯ä¸Šçš„æ˜¯* [*é¢†è‹±*](http://www.linkedin.com/in/chris-hughes1/) *ã€‚**