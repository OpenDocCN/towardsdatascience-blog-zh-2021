# 如何使用 SQL 从雪花中提取数据可观测性度量

> 原文：<https://towardsdatascience.com/how-to-extract-data-observability-metrics-from-snowflake-using-sql-9bf001038788?source=collection_archive---------16----------------------->

## 使用这些简单的查询来监控雪花数据管道的健康状况

![](img/a329e0312d08a0349f336343c009be59.png)

图片由 [Unsplash](http://www.unsplash.com) 上的[悉尼·瑞伊](https://unsplash.com/photos/akKqjTsmEwM)提供。

你的团队刚刚将[的**迁移到了雪花**的](https://www.montecarlodata.com/how-to-migrate-to-snowflake-like-a-boss/)。你的首席技术官对这个“现代数据堆栈”了如指掌，或者用她的话说:“企业数据发现[”但是任何数据工程师都会告诉你，即使是最好的工具也无法将你从破裂的管道中拯救出来。](https://en.wikipedia.org/wiki/Star_Trek:_Discovery)

事实上，您可能已经在比您希望记住的更多的情况下接受了模式更改变坏、重复的表和太多的空值。

好消息是什么？当谈到管理雪花环境中的数据质量时，数据团队可以采取几个步骤来了解数据从接收到使用的健康状况。

这里有一个从雪花中提取数据可观察性度量的五步方法，反过来，离**信任您的数据**又近了一步:

# 映射您的雪花库存

出于本教程的目的，让我们假设您在 Snowflake 上有一个名为 ANALYTICS 的数据库(尽管与大多数数据堆栈一样，这种情况很少发生)。要在您的环境中运行以下查询，只需将 ANALYTICS 替换为您希望跟踪的数据库的名称。要列出您帐户中的数据库，您可以运行“显示数据库”。

您的第一步将是映射仓库中的所有表，这样您就知道首先需要跟踪什么。当您这样做时，映射模式可以成为理解每个表中的内容以及这些内容如何随时间变化的强大工具。

以下是如何用雪花做这件事:

该查询将获取所有表的列表以及关于它们的设置的有用元数据。如果您一直致力于用[注释](https://docs.snowflake.com/en/sql-reference/sql/comment.html)来记录数据，那么*注释*属性会特别有用。

要获取表的模式(了解它的演变过程确实有助于防止和解决数据损坏问题)，您可以使用以下查询:

请注意，上面的代码片段将有助于处理表格，但是我们有意省略了视图和外部表格。要提取这些内容的元数据，我们建议使用以下查询:

虽然这可能会增加实现的复杂性，但这些查询将获取在查询*information _ schema . tables*时无法获得的有价值的信息。例如，您将拥有视图的 text 属性——它将为您的视图提供关于底层 SQL 查询的洞察力。

# 监控雪花中的数据新鲜度和数据量

跟踪表的数量和新鲜度[对于了解管道和数据的整体健康状况极其重要](https://www.montecarlodata.com/introducing-the-5-pillars-of-data-observability/)。幸运的是，当对仓库中的表进行写操作时，雪花会跟踪这些信息。您可以使用以下查询获取表的字节数和行数，以及它们最近一次更新的时间:

通过存储这些指标并观察它们如何随时间变化，您可以绘制出表更新的频率、每次更新预期的数据量，最重要的是，确定缺失或异常的更新。

测量视图的新鲜度和容量并不简单，因为它是底层查询中包含的表的函数。至于外部表，我们建议使用来自“*显示外部表…* ”的新鲜度信息。

# 构建您的雪花查询历史

在排查问题时，拥有在雪花环境中运行的所有查询的可靠历史记录是一个非常有价值的工具——它可以让您确切地看到最近一次写入表的方式和时间。更广泛地说，对查询日志的分析可以帮助映射血统(表之间的依赖关系)，了解哪些用户使用哪些资产，甚至优化雪花实例的性能和成本。

这是我们用来提取查询日志的查询—请注意，我们将过滤掉系统和错误的查询以减少干扰:

您可能还会发现查看复制和加载操作的历史对于理解数据是如何加载和移动的很有价值:

## 在雪花中检查您最重要的数据的健康状况

最后，对于一些关键表，您可能希望运行数据质量检查，以确保所有字段都正确填充并具有健康的值。通过跟踪一段时间内的运行状况指标并将其与过去的批次进行比较，您可以在数据中出现一系列数据质量问题时立即发现这些问题

你可以这样做:

在本例中，我们正在收集 *client_hub* 表中两个字段的健康指标。对于字段 *account_id* ，一个字符串，我们跟踪像完整性(非空值的百分比)、独特性(唯一值的百分比)和 UUID 率(匹配 UUID 格式的记录的百分比)这样的指标。随着时间的推移跟踪这些将有助于识别常见问题，如没有 id 的帐户、重复记录和 id 格式错误。

对于数值字段 *num_of_users* ，我们跟踪其他类型的指标，如零比率(值为 0 的记录的百分比)、平均值和分位数。随着时间的推移，这些指标可以帮助我们识别常见问题，如导致我们的计数为 0 的缺失数据，或导致我们的用户计数偏离的错误。

为了可伸缩性，请注意我们只跟踪最近的数据(在本例中为 1 天),并假设以前的数据已经被查询和存储。这种做法——以及必要时的采样——将让您高效且经济地跟踪一些大规模数据集。

# 将它投入生产

当在生产中使用这种方法时，需要记住一些注意事项:

## 可量测性

跟踪大量的表和大数据集可能会变得很棘手。您需要考虑对您的调用进行批处理，针对规模优化您的查询，进行重复数据删除，规范化各种模式，并将所有这些信息存储在一个可扩展的存储中，以便您能够理解这些信息。这需要构建一个专用的数据管道，由您长期操作、更新和维护。

**专业提示:**别忘了记录你的雪花信用卡消费(你不会想接到首席财务官的电话……)。

## 覆盖堆栈的其他部分

构建真正可靠的数据管道和实现数据可观察性需要的不仅仅是收集雪花型指标。事实上，随着现代数据堆栈的发展，监视实时流数据、数据湖、仪表板、ML 模型和其他资产的可靠性将变得至关重要。

使这种方法可扩展到雪花之外是一个根本性的挑战，特别是当您的数据堆栈增长到包含额外的技术和数据源时。因为数据可能在管道中的任何地方中断，所以您将需要一种方法不仅从您的仓库中，而且从其他资产中提取指标和元数据。

投资于解决方案，使这些集成彼此之间以及与您的最终用户(无论是您的数据工程师、分析工程师、ML 团队还是数据科学家)和谐相处，应该是重中之重。真正的数据可观察性超越了数据仓库，在破碎的数据滚雪球般变成更大的问题之前，提供对您的湖泊、ETL、商业智能仪表板等中的数据健康状况的洞察。

## 构建工作流

团队的其他成员需要随时可以获得您获取的信息，特别是当事情发生变化或者您正在对您的数据管道 进行 [**根本原因分析时。在检测到问题时自动发送通知，并通过一个集中的(易于导航的)用户界面来更好地处理这些工作流，这是快速解决问题和长达数天的数据灾难之间的区别。**](/root-cause-analysis-for-data-engineers-782c02351697)

这不是星舰企业号(或发现号)，但我们希望本教程能为您提供数据信任的基础。

现在，前进并执行 SQL！

***有兴趣了解更多？伸出手去*** [***巴尔摩西***](https://www.linkedin.com/in/barrmoses/)*[***伊塔布莱***](https://www.linkedin.com/in/itay-bleier-28b5854/) ***以及剩下的*** [***蒙特卡洛团队。***](http://www.montecarlodata.com)*

**本文由 Itay Bleier 合著。**