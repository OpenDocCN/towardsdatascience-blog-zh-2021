# 编写生产就绪 API -第 1 部分:实现 ORM

> 原文：<https://towardsdatascience.com/build-a-real-life-professional-api-with-an-orm-part-1-8fce4d480d59?source=collection_archive---------22----------------------->

## 为我们的网站创建一个高效、安全和快速的 API，而不需要编写一行 SQL

![](img/7e0f5a1b7bc438a65895a137bd415ba9.png)

我们的 API 会比这些可爱的生物更快(图片由[切瓦农摄影](https://www.pexels.com/@chevanon)在[像素](https://www.pexels.com/photo/two-yellow-labrador-retriever-puppies-1108099/)上拍摄)

想象一下去一家餐馆。你坐下来，看菜单，选择一些菜。然后你走向厨房，告诉厨师你想吃什么，等他吃完后再把你的饭菜端上桌。这家奇怪的餐馆里发生了什么事？

没有 API 的应用程序就像没有服务员的餐馆。在餐馆里，你不需要和厨房沟通，也不需要等着点菜来享用美食。同样的，一个网站不需要知道如何与你的数据库通信。像一个服务员一样，我们的 API 从我们的网站收到一个命令:“我想要一些带有元数据的用户统计数据”。API 随后检查订单(是否允许您拥有该数据？)，说服我们的数据库(厨师)为他烹制一些美味的信息，等待数据库完成，最后将数据返回到网站。

## 这篇文章是关于什么的？

我们将使用 ORM 为我们正在构建的名为 [**BeerSnob**](https://mikehuls.medium.com/version-control-your-database-part-2-migrations-and-seeds-for-table-relations-d4fb185d95d8) 的现实世界应用程序创建一个全功能、快速和安全的 API 一个专门为喝优质啤酒的人建立的网站。它允许用户分享关于他们在特定场所喝的啤酒的评论；在提供价格和口味信息的同时，对场地和啤酒进行评级。在本文结束时，您将拥有一个带有 ORM 的工作 API，并有一个迁移模型来完成它！首先我们进入*为什么*我们会创建一个 API 或者 ORM，然后我们开始编码。

# 0.目标和准备

我们的目标是为 BeerSnob 创建一个 API，它将从网站接收用户创建的数据包。基于所需的动作，它然后从数据库中检索数据或将数据包插入到数据库中。数据包可能包含多个表的信息，API 的工作是确保正确的信息出现在正确的表中。

# 为什么要构建 API？

如果你点击脸书网站或应用程序中的“我的朋友”，你会向 API 发送信息请求。这个软件翻译你的请求，检查你是否被允许提出请求，收集所有的数据并用你的数据包回应。这很好，有几个原因:

*   保持我们的代码整洁
*   保护对我们数据库的访问(网站与我们的数据库分离，例如:我们的网站不需要有数据库凭证)
*   检查用户对数据的访问(我只能更改*我的*个人资料，不能更改其他人的)

## 为什么要使用 ORM？

ORM 代表对象关系映射，它是一种允许你使用对象从数据库中查询和操作数据的技术。您不必再编写查询，您可以使用对象来检索数据。伪代码示例:`song_list = SongTable.query(artist="Snoop dogg")`。优点:

*   没必要写 SQL
*   很多事情都是自动完成的
*   阻止 [SQL 注入](https://en.wikipedia.org/wiki/SQL_injection)

我们来编码吧！

# 1.设置

在 API 能够处理数据库数据之前，我们需要一个实际使用的数据库。在 [**这篇文章**](https://mikehuls.medium.com/version-control-your-database-part-2-migrations-and-seeds-for-table-relations-d4fb185d95d8) 中，我们使用迁移来创建所有的表、关联、关联和索引。无论您是否使用迁移，本文还包含一个非常漂亮的 BeerSnob 数据库结构图。

我们将在 [**本文**](https://mikehuls.medium.com/version-control-your-database-part-2-migrations-and-seeds-for-table-relations-d4fb185d95d8) 中构建的迁移模型上构建 API。如果你想编码，那么 git 从这里的[](https://github.com/mike-huls/beersnobv2)****克隆代码。**首先让我们构建一个 ORM，然后实现我们的 API。**

# **2.为我们的 ORM 创建模型**

**ORM 是我们可以在 API 中使用的对象和数据库中的数据之间的转换。为了将数据库数据转换成对象，它使用“模型”。在我们的 BeerSnob 示例中，我们希望按照`foundbeers = BeerTable.Get(ID=2)`的思路做一些事情。在这个例子中，BeerTable 是一个模型，它能够连接到数据库中的 Beers 表，并对其执行操作，如检索数据和插入新记录。**

**![](img/f949ed280408c6ddf27982835a643cd1.png)**

**像这个好孩子一样，我们的 ORM 将在我们的努力中帮助我们**

**让我们创建我们的第一个模型；国家。这个模型处理我们国家表中的数据。在“models”目录下创建一个名为 countries.js 的新文件，内容如下:**

**这个简单的文件允许我们创建一个模型。创建一个模型并理解它是如何工作的并不难。重要的事情定义如下。**

*   **在 tableModel(第 5 行)中，我们添加了 modelName。我决定保持表名的复数形式(countries 表包含许多国家的记录)和模型名的单数形式(一个模型只描述一个国家)。**
*   **模型与另一个模型相关联(第 11 行)。我们告诉我们的 ORM，如果我们删除一个国家，一个城市应该被删除。我们还在国家表(CountryId)上定义了外键。**
*   **在 Init 中，我们定义了一些关于列的信息。ORM 需要知道数据库中列的数据类型和名称。**
*   **时间戳:false(第 24 行)。如果设置为 true，ORM 会添加额外的列来跟踪创建和修改的时间戳(我们手动处理这些，但是 ORM 也可以为您完成)。**

**当定义模型之间的关联时，有几个选项。到目前为止，我已经在这个项目中使用了一些，但是我们将在下一部分中更深入地研究它们。我还为其他表格创建了模型。查看存储库以获取更多信息。**

# **3.原料药制备**

**在我们开始创建 API 之前，我们需要安装一些依赖项并准备一些东西。**

## **3.1 安装包。**

**转到您的根文件夹并:**

```
npm install --save express body-parser
npm install --save-dev nodemon
```

**这将安装我们的 API 需要的包。Express 是一个 web 服务器，body-parser 允许我们解析通过该 web 服务器发送的请求体。然后我们安装一个开发依赖；这些仅用于构建我们的应用程序，并且通常仅用于开发。每次我们更改代码时，Nodemon 都会重新加载我们的 web 服务器。我的 f5 键对此非常感谢。**

## **3.2 配置您的应用程序以使用 Nodemon**

**打开根文件夹中的 package.json 文件。调整“脚本”部分以反映以下内容:**

```
"scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
```

**这将允许我们在生产环境中调用`npm run start`或`npm run dev`用 nodemon 运行我们的应用程序，允许重启。**

## **3.3 创建文件夹**

**在根目录下创建两个文件夹:“routes”和“service”。**

# **4.构建 API**

**是时候让这些模型发挥作用了！有了 API，我们将能够接收请求并使用模型从数据库中检索数据。我们首先设计我们的服务器，它将捕获所有的请求，并将它们传递给一个路由。然后，路由将检查请求并与数据库通信。**

**![](img/0733f3e5f8a1acbe315462f9576c2c36.png)**

**该去拿东西了！(图片由 [Pexels](https://www.pexels.com/photo/two-adult-black-and-tan-german-shepherds-running-on-ground-1633522/) 上的[约瑟夫·费尔](https://www.pexels.com/@jozef-feher-356581)拍摄)**

## **4.1 为我们的应用程序创建服务器**

**使用下面的脚本，我们将有一个服务器启动并运行。**

**事情是这样的:**

*   **我们导入了一些包和日志服务。这个服务帮助我们调试，我们在第 13 行这样做。**
*   **在第 9 行，我们创建了一个可以传递请求的应用程序。**
*   **第 24 行；我们告诉 app 我们要用 bodyParser 通过这种方式，我们可以接收例如 json 数据。**
*   **第 29 行:我们设置 API 的规则。**
*   **第 41 行到第 46 行:我们捕获一些 URL 路径，并将它们传递给我们的 routes。**
*   **第 59 行:为我们的应用程序创建一个服务器，并告诉它监听本地主机上的端口 5000**

## **4.2 创建路线和处理请求**

**现在我们的服务器已经启动并运行了，是时候将请求传递给我们在第 41 行到第 46 行定义的路由了。下面我将展示一个处理路由的例子。我已经以完全相同的方式实现了其他路线；你可以在[找到我们的知识库](https://github.com/mike-huls/BeerSnobV3)。**

**在上面的代码中，您可以看到 ORM 在处理路由时是如何工作的。让我们走完第一条路线(11 号线至 39 号线)。**

*   **第 11 行:我们定义路线。`/search`在我们的例子中是指`localhost:5000/api/beers/search`**
*   **第 14 行:我们从 url 获取数据。req.query 检索 url 参数(T2 中的粗体部分)。我们将参数 q 的值存储在一个变量中，这个变量也称为 q(用于查询)。在 url `localhost:5000/api/beers/search?q=ale`中，键 q 的值是‘ale’。**
*   **第 20 行:如果 q 太短，什么也不做**
*   **第 23 行到第 30 行:返回所有包含 q 的啤酒(不区分大小写)**
*   **第 33 行 res.retun 是我们的 API 返回的内容。它将返回一个只有一个键的对象:“beers”和我们在数据库中找到的所有啤酒的数组。我们返回状态代码 200(成功)。**
*   **第 36 行:如果 try-block 中有任何错误，我们通过返回一个错误让客户端知道(我们使用 [errorService](https://github.com/Muls/BeerSnobV3/blob/main/services/errorService.js) 来完成这个任务)。**

**如您所见，我们不必自己编写一行 SQL 我们可以调用模型来翻译我们的请求并与我们的数据库通信。这不仅很方便，还能防止 SQL 注入。**

# **5.测试我们的路线**

**让我们测试我们的啤酒路线！在啤酒行业，有三条不同的道路:**

1.  **这条路线使用我们的 ORM 来查询 Beers 表。你可以通过一个搜索词(q)像`localhost:5000/api/beers/search?q=heine`。然后它会寻找类似 q 的啤酒。**
2.  **一个 GET for /
    这个路由使用可选的查询参数 Id，如果提供了 Id，就尝试查找记录。否则它返回所有啤酒。尝试`localhost:5000/api/beers`或`localhost:5000/api/beers?id=1`**
3.  **一个用于/
    的 POST 此路由接受一个它将在第 72 行(req.body)上捕获的主体。试着将下面的 json 发布到`localhost:5000/api/beers`，你会看到数据库中出现一条新记录。**

```
{
    "Name": "Bud Light",
    "Type": "Beer flavored water"
}
```

**![](img/4202b037b38e4286090159bffe7df022.png)**

**这是一篇相当长的文章:这只可爱的小狗是我们应得的(图片由 [Hannah Grace](https://unsplash.com/@oddityandgrace) 在 [Unsplash](https://unsplash.com/photos/fk4tiMlDFF0) 上提供)**

# **结论**

**这个 API 为我们的应用程序提供了一些不错的基本功能！使用我们的 ORM，我们现在能够使用我们的 API 来搜索、获取和创建国家、城市、地点、啤酒、用户和报告。在下一部分中，我们将进一步充实我们的 API:**

*   **我们将添加更深入的关联(*返回用户 X 提交的所有啤酒*或*返回访问过场所 X 并报告了啤酒 Y 的所有用户*)。**
*   **实现更多的功能，例如:用户想要更新他们的密码**
*   **我们会增加安全措施。我只能编辑自己的密码，不能编辑别人的。**

**这是一篇很长的文章；我希望你到这里为止，我的解释够清楚了。如果不是，请让我知道我可以在哪里提高自己。[关注我](https://mikehuls.medium.com/)敬请关注！**

**—迈克**