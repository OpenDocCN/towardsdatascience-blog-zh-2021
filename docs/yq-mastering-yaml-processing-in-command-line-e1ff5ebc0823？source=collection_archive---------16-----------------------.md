# yq:在命令行中掌握 YAML 处理

> 原文：<https://towardsdatascience.com/yq-mastering-yaml-processing-in-command-line-e1ff5ebc0823?source=collection_archive---------16----------------------->

## 学习使用`yq`命令行实用程序和这个简单的备忘单更有效地解析和操作 YAML 文件

![](img/fd0fd20886eb48e4d13f8d2d839f128d.png)

照片由[马特·阿特兹](https://unsplash.com/@mattartz?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄

如今，YAML 几乎用于配置所有东西(无论是好是坏)，所以无论你是使用 Kubernetes 或 Ansible 的 DevOps 工程师，还是使用 GitHub 操作配置 Python 或 CI/CD 日志的开发人员，你都必须至少不时地处理 YAML 文件。因此，能够有效地查询和操作 YAML 是我们所有工程师的基本技能。最好的学习方法是掌握 YAML 处理工具，如`yq`，它可以让你在许多日常任务中更加高效，从简单的查找到复杂的操作。所以，让我们浏览并学习`yq`所提供的一切——包括遍历、选择、排序、归约等等！

# 安装

在我们开始使用`yq`之前，我们首先需要安装它。当你谷歌`yq`的时候，你会发现两个项目/资源库。首先，在[https://github.com/kislyuk/yq](https://github.com/kislyuk/yq)是围绕`jq`的包装器 JSON 处理器。如果你已经熟悉了`jq`,你可能想抓住这个并使用你已经知道的语法。然而在本文中，我们将使用另一个更受欢迎的项目，来自 https://github.com/mikefarah/yq。这个版本并不 100%匹配`jq`语法，但它的优势是它是独立的(不依赖于`jq`)，有关差异的更多上下文，请参见下面的 [GitHub 问题](https://github.com/mikefarah/yq/issues/193)。

要安装它，请转到[文档](https://mikefarah.gitbook.io/yq/#install)并选择适合您系统的安装方法，只需确保您安装的是版本 4，因为这是我们将在这里使用的。最重要的是，你可能想要设置 shell 完成，关于它的信息可以在[https://mikefarah.gitbook.io/yq/commands/shell-completion](https://mikefarah.gitbook.io/yq/commands/shell-completion)获得。

现在我们已经安装了它，我们还需要一些 YAML 文件或文档来测试我们将要运行的命令。为此，我们将使用以下文件，这些文件包含了您可以在 YAML 中找到的所有常见内容—属性(普通的和嵌套的)、数组和各种值类型(字符串、整数和布尔值):

这个说完了，我们来学习基础知识吧！

# 基础知识

我们将运行的所有命令都将以相同的基数`yq eval`开始，后面是带引号的表达式和您的 YAML 文件。一个例外是 YAML 文件的漂亮打印，在这种情况下，你可以省略表达式——例如`yq eval some.yaml`——如果你熟悉`jq`，那么这相当于`cat some.json | jq .`。

可选地，我们也可以添加一些额外的标志，一些更有用的标志是`-C`强制彩色输出，`-I n`设置输出缩进到`n`空格，或者`-P`漂亮打印。

至于基本表达式，我们可以做很多事情，但最常见的是遍历 YAMLs，或者换句话说，在 YAML 文档中查找某个键。这是使用`.`(点)操作符完成的，在最基本的形式中，看起来是这样的:

除了基本的地图导航之外，您可能经常想要在一个数组中查找特定的索引(使用`[N]`):

最后，您可能还会发现 *splat* 操作符非常有用，它可以展平贴图/数组(请注意与我们看到的第一个示例的不同之处):

除了基本的遍历，你可能还想熟悉选择的*，它允许你通过布尔表达式过滤。为此我们使用`select(. == "some-pattern-here")`。这里，简单的例子可以是基于前导数字的过滤:*

这个例子还展示了管道(`|`)——我们使用它首先导航到我们想要过滤的文档部分，然后将它传递给`select(...)`。

在上面的例子中，我们使用了`==`来查找与模式相等的字段，但是您也可以使用`!=`来匹配不相等的字段。此外，您可以完全省略`select`函数，您将只获得匹配的布尔结果，而不是值:

无论您是第一次使用`yq`还是已经使用了一段时间，您肯定会遇到这样的问题，您不知道为什么您的查询没有返回您想要的结果。在这些情况下，您可以使用`-v`标志来产生详细的输出，这可能会为您提供为什么查询会这样的信息。

# 高级查询

前一节展示了基本的功能，这些功能对于快速查找和过滤来说已经足够了，但是有时您可能希望使用更高级的函数和操作符，例如在自动化某些涉及 YAML 输入和/或输出的任务时。所以，让我们探索一下`yq`能提供的更多东西。

有时候，对文档中的键进行排序可能很有用，例如，如果您在 git 中对 YAMLs 进行版本控制，或者只是为了提高可读性。如果你需要区分两个 YAML 文件，这也很方便。为此我们可以使用`'sortKeys(...)'`功能:

如果输入的 YAML 文档是动态的，并且您不确定将会出现什么键，那么首先用`has("key")`检查它们是否存在可能是有意义的:

与使用`has("key")`的情况类似，在对文档进行某些操作之前，您可能需要首先获得动态的键列表，为此您可以使用`keys`函数:

检查值的长度对于输入过滤/验证或者确保值不会溢出一些预定义的界限可能是必要的。这是使用`length`功能完成的:

对于具有参数化输入的自动化任务，您肯定需要将环境变量传递到`yq`查询中。显然，您可以使用普通的 shell 环境变量，但是您最终会遇到非常棘手和难以理解的引号转义。因此，最好使用`yq`的`env()`功能:

为了简化一些字段或数组的处理，你也可以使用一些字符串函数，如`join`或`split`来连接或拆分文本:

本节最后一个也可能是最复杂的例子是使用`ireduce`的数据转换。要有一个使用这个函数的好理由，你需要一个相当复杂的 YAML 文档，这不是我想在这里转储的东西。因此，相反，为了至少给你一个函数如何工作的概念，让我们用它来实现前面例子中的`join`的*“穷人的”*版本:

这个不像前几个那样一目了然，所以让我们把它分解一下。查询的前半部分(`.user.orders[] as $item ireduce`)从 YAML 获取一些可迭代字段(序列)并将其赋给变量——在本例中是`$item`。在第二部分中，我们定义初始值`"";`(空字符串)和一个表达式，该表达式将为每个`$item`清空——这里是之前存在的值，用空格(`(. + " ")`)连接，后跟我们当前迭代的项(`+ $item`)。

# 操纵和修改

大多数情况下，您只需要对现有文档进行搜索、查找和过滤，但有时您可能还需要操作 YAMLss 并从中创建新的 YAML。`yq`提供了几个操作符来完成这类任务，所以让我们简单回顾一下，看几个例子。

最简单的就是 union 操作符，其实就是一个`,`(逗号)。它允许我们组合多个查询的结果。如果您需要同时提取 YAML 的多个部分，但无法通过单个查询完成，这将非常有用:

另一个相当常见的用例是向数组中添加记录或者连接两个数组。这是通过`+`(加号)运算符完成的:

另一个方便的是更新操作符(`=`)，它(*惊奇，惊奇*)更新一些字段。在我们的示例 YAML 中更新日志级别的非常简单的示例:

这里需要指出的是，默认情况下，结果被发送到标准输出，而不是原始文件。要进行就地更新，您需要使用`-i`选项。

还有一些操作符可用，但不是特别有用(大多数时候)，所以我不会给你看一堆可能对你没有帮助的例子，相反，我会给你一些到文档的链接，以防你想知道得更深入一点:

*   [数字减法](https://mikefarah.gitbook.io/yq/operators/subtract)
*   [乘法(合并)](https://mikefarah.gitbook.io/yq/operators/multiply-merge)
*   [删除](https://mikefarah.gitbook.io/yq/operators/delete)

# 方便的例子

现在我们知道了这个理论，让我们来看看一些例子和方便的命令，你可以马上把它们整合到你的工作流程中。

出于明显的原因，我们从 Kubernetes 开始，因为它可能是使用 YAML 进行配置的最流行的项目。`yq`可以帮助我们做的最简单但非常有用的事情是漂亮地打印 Kubernetes 资源或查询清单的特定部分:

我们可以做的另一件事是列出资源名称和特定属性。这对于查找或提取服务的所有监听端口非常方便，例如查找名称空间中每个 pod 的 pod 图像:

注意，上面我们不得不使用`.items[]`，因为当你`get`一个资源的所有实例时，返回的*种类*是`items`的*列表*。

在诸如 pod、部署或服务之类的资源的情况下，通常在每个名称空间中有许多实例，仅仅将它们全部转储到控制台并手动筛选它们可能是不可取的。因此，您可以根据某些属性对它们进行过滤，例如，仅列出在特定端口上公开的服务的名称和监听端口:

所有的 Kubernetes*“YAML 工程师”*都知道，有时很难记住某个特定资源中的所有字段，那么为什么不直接查询所有的关键字，例如部署的`spec.template.spec`？

从 Kubernetes 继续，来点`docker-compose`怎么样？也许你需要临时删除一些部分，比如`volumes`或者`healthcheck`——好了，这就是了(这是破坏性的，所以要小心):

以类似的方式，你也可以从一个可行的剧本中删除任务。说到这里，把所有任务中的`remote_user`都改成`root`怎么样？

# 结束语

我希望这个*“速成班”*能帮助你开始使用`yq`，但是和任何工具一样，你只能通过实践和实际执行真实世界的任务来学习使用它，所以下次你需要在 YAML 文件中查找某些东西时，不要只是把它转储到终端中，而是写一个`yq`查询来为你完成工作。此外，如果你正在努力为你的特定任务提出查询，而谷歌搜索没有找到任何有用的东西，尝试搜索使用`jq`的解决方案——查询语法几乎相同，考虑到它是更受欢迎/常用的工具，你可能会更幸运地搜索到`jq`解决方案。

*本文最初发布于*[*martinheinz . dev*](https://martinheinz.dev/blog/51?utm_source=medium&utm_medium=referral&utm_campaign=blog_post_51)

[](/networking-tools-every-developer-needs-to-know-e17c9159b180) [## 每个开发人员都需要知道的网络工具

### 让我们学习被忽视的网络技能，如检查 DNS 记录，扫描端口，排除连接故障…

towardsdatascience.com](/networking-tools-every-developer-needs-to-know-e17c9159b180) [](https://itnext.io/advanced-git-features-you-didnt-know-you-needed-ed8455c45495) [## 您不知道自己需要的高级 Git 特性

### 你错过了一些很棒的 git 特性，比如 word diff，auto-correct，插件或者提交签名，是时候了…

itnext.io](https://itnext.io/advanced-git-features-you-didnt-know-you-needed-ed8455c45495) [](/its-time-to-say-goodbye-to-docker-5cfec8eff833) [## 你不用再用 Docker 了

### Docker 不是唯一的集装箱工具，可能会有更好的替代工具…

towardsdatascience.com](/its-time-to-say-goodbye-to-docker-5cfec8eff833)