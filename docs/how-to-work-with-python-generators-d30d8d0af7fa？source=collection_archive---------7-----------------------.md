# 如何使用 Python 生成器

> 原文：<https://towardsdatascience.com/how-to-work-with-python-generators-d30d8d0af7fa?source=collection_archive---------7----------------------->

## 通过了解如何编写生成器来提高可读性、内存消耗和性能

![](img/2b3bec6f7ad329fe669a4169ca1830c8.png)

照片由[卡斯登·沃斯(➡️@卡斯登.沃斯)](https://unsplash.com/@karsten_wuerth?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

# 介绍

您在处理太大而无法容纳在内存中的数据集时是否遇到过问题？当您想要迭代一些需要维护状态的计算值时，您是否编写过复杂且难看的 for 循环？或者你曾经不得不从一个潜在的无限流中消费数据，比如 [Kafka](https://kafka.apache.org/) 消息队列，并为其编写代码，使其看起来像火箭科学？

如果你对这三个问题中的任何一个的回答是*是的*那么一个在未来最有可能拯救你的建议就是

> 使用生成器和生成器表达式！

你现在问你自己；那是什么？什么是*生成器*和*生成器表达式*？如果是的话，我建议你保持冷静，继续读下去。

在这篇文章中，我将向您简要介绍 Python 中的*生成器。与往常一样，我提供了示例代码，您可以进行试验，这将有助于促进理解。*

你准备好了吗？让我们开始吧！

# 生成器和生成器表达式

编写干净、可理解且节省内存的 Python 代码(尤其是在处理海量或流式数据集时)有时被视为一门艺术。然而，这往往比您想象的更容易实现。生成器和生成器表达式是 Python 中的两个概念，在这里可以帮到你。

## 基本概念

让我们从基础开始，记下使用生成器的一些好处。

生成器允许你声明一个行为类似迭代器的函数。这意味着你可以在 for 循环或 list/dict 理解中使用生成器，就像你在使用 list 或 tuple 一样。因为这是你在每一门 Python 101 课程中学到的东西，所以使用生成器对你来说应该是非常自然的。

你得到的另一个好处是[关注点分离](https://en.wikipedia.org/wiki/Separation_of_concerns)和[单一责任](https://en.wikipedia.org/wiki/Single-responsibility_principle)。我这么说是什么意思？我的意思是，在生成器中，您可以专注于如何获取数据。 *在应用生成器的 for 循环*中，您可以专注于真正重要的事情，即*处理数据*。您经常会在冗长而笨拙的 for 循环中看到这两件事紧密地联系在一起，尽管这是两个完全不同的任务，也需要不同的知识和能力。

我想强调的最后一个优势，因为它在我们的机器学习和数据科学领域非常重要，就是使用生成器，您可以在处理大型数据集时缓解内存问题。这是如何实现的？这是通过*发电机本质上被点燃并忘记*来实现的。您可以按需加载数据集的子集，处理该子集，丢弃它，然后继续迭代。这意味着您不必将整个数据集保存在内存中，而只需保存它的一个子集。当然，这只有在您可以进行批处理的情况下才是可行的。

在谈论了发电机的基础和优点之后，现在让我们来看看有趣的部分；编写我们自己的生成器！

## 如何编写生成器

你们可能都知道如何用 Python 编写函数，以及`**return**`语句的作用。现在，用`**yield**`替换`**return**`关键字，您已经创建了您的第一个生成器函数。祝贺㊗️！相当容易不是吗？

现在是时候看看一些代码了，我们从最基础的开始

这里你看到一个生成器函数，`numbers_123`、**、**、**、**产生数字 1、2 和 3。当然，这个函数不是很有用，应该只是作为第一个例子来理解生成器背后的概念。

因为那个函数包含了`**yield**` 关键字，所以它变成了一个生成器函数。收益表有什么作用？*yield 语句向调用者输出其右边的值*。此外，*它暂停函数*保存其所有状态，并在随后的调用中从暂停处继续。因为它只是暂停你可以在一个函数中多次调用 yield 的函数。这与`**return**` 语句形成了鲜明的对比，后者只能调用一次，因为它终止了一个函数。

如前一节所述，可以像使用列表或元组一样在 for 循环中使用生成器。为了说明这一点，我已经将它添加到代码的第 7 行。

这基本上就是你要写一个生成器函数所要知道的。*只要记住收益表的作用，你就做好了准备*。如果你想学习如何制作一个类生成器，那篇文章可能也适合你。听起来很棒，不是吗？

![](img/3c9b5bdd057b84fae56a7b7c4c803af7.png)

照片由 [Jen Theodore](https://unsplash.com/@jentheodore?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

除了我们到目前为止所看到的，还有一些关于生成器的更好的语法糖，我想在下一节讨论。

## 如何编写生成器表达式

在这一节，我想谈谈生成器表达式。听起来很复杂，但这也很简单。

我猜你们中的许多人已经知道如何写一份理解清单。现在，用圆括号代替方括号，你就有了一个生成器表达式。真的很简单不是吗？让我们用一段代码来说明这一点

这里，`soun`是一个生成器，它产生一个整数和一个浮点数的元组。第 5 行等号右边的表达式是创建生成器的生成器表达式。孕尿激素😃因此，当使用圆括号和 for 循环时，你不是像人们所想的那样创建一个元组，而是一个生成器。记住这一点，你会给很多人留下深刻印象。相信我😃

关于使用发电机，需要注意的是*只生产你消耗的*。那是什么意思？在示例中，当我们看到第一个大于 50 的`number`时，我们中断迭代。这意味着，我们既不处理任何大于该值的数字，也不必加载或存储它们。对于这个玩具示例，这并不重要，但在处理真实数据集时，它可能会改变游戏规则。

最后，在进入最后一个示例之前，我想向您展示另一种语法，以简洁地编写从可迭代的生成的*代码。听起来又比实际情况更戏剧化。让我们试着从代码来理解它*

我们创建了另一个名为`some_generator`的函数。我们再次看到关键字`**yield**` ，它将函数变成了生成器。不过这次我们把它和关键字`**from**`结合起来。这样，我们*从*的 iterable 中得到的每一个元素*。这实际上是编写一个 for 循环的简短形式，该循环遍历 iterable 并产生每个元素。又好又甜的 pythonic 糖😃*

# 示例时间

为了了解生成器的全部功能，我创建了一个虚构的示例，我们首先想从服务器下载图像，然后检测每张图像中的所有猫和狗😺 🐶。

为此，我们有两个 API，一个返回所有可用图像的 URL，另一个用于下载图像。获取图像 URL 的 API 是分页的，这意味着我们必须多次调用它来获取所有图像 URL。该服务器可能包含数百万张图片，这些图片可能太大而不适合您的电脑内存。令人惊讶的是，这听起来非常适合使用发电机。让我们看看怎么做。

## 消化代码

在这个例子中，你可以看到两个发生器`get_urls`和`get_images`以及一些检测猫和狗的功能，我将在下面详细解释。

先说`get_urls`。这样，我们以分页的方式从服务器获取所有可用的图像 URL。由于这是一个生成器，我们可以使用变量`current_page`跟踪已经检索到的页码，并逐个迭代。一旦页面上返回的 URL 数量少于我们每页请求的 URL 数量，我们就停止检索 URL。对于一些狗食，我在这里使用了前面提到的`**yield from**` 构造来逐个生成图像 URL。

接下来，我们使用`get_images`从提供的 URL 迭代器下载每张图片，并把图片作为 NumPy 数组提供给调用者。因此，我添加了一个未指定的函数`to_numpy_array`，它将来自流的原始字节转换成一个 NumPy 数组。只要假设这个函数存在就可以了，不必关心细节。此外，我已经添加了可选参数`max_images`，允许您限制下载图像的数量。

最后，我们看看如何利用生成器来下载和处理图像。假设服务器将返回数百万张图像，那么使用这种方法就不会有任何内存问题。这里需要注意的一点是，您可以将生成器作为参数传递给函数。这允许您链接和组合生成器来创建可读性良好的处理管道。

我想在这里再次强调的最后一点是，生成器帮助你*编写干净且结构良好的代码*。我希望从给定的例子中可以明显看出这一点，在这个例子中，您可以看到数据加载和处理部分之间关注点的清晰分离。

![](img/dd48f8aeacf7538cce0a5240f71b45d5.png)

照片由[布雷特·乔丹](https://unsplash.com/@brett_jordan?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

# 包裹

在这篇文章中，我们看了如何编写和使用生成器和生成器表达式来创建干净和高性能的数据处理管道。我希望在您的代码库中应用它们是多么容易和有益。我向你保证，如果你这样做了，你将会给你的同事留下深刻的印象😎。

感谢您关注这篇文章。一如既往，如果有任何问题、意见或建议，请随时联系我或关注我，无论是在 Medium 还是通过 [LinkedIn](https://www.linkedin.com/in/simon-hawe-75832057) 。圣诞快乐🎅