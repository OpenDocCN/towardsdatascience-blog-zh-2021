# 学习不确定情况下的决策——第 2 部分:解决随机问题

> 原文：<https://towardsdatascience.com/learn-decision-making-under-uncertainty-part-2-solve-the-stochastic-problem-773767e96d33?source=collection_archive---------45----------------------->

## 学习使用 Python 最大化所有可能场景的预期价值

![](img/d8bbda034a119b0245a28b384411bdd5.png)

由 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的 [Edge2Edge 媒体](https://unsplash.com/@edge2edgemedia?utm_source=medium&utm_medium=referral)拍摄

在[第一部](/learn-decision-making-under-uncertainty-part-1-solve-the-problem-with-mean-values-368c35add0b7)中，我们帮助一位农民探索了三种不同的种植方式。尽管我们基于平均收益率的决策相当有效，但我们发现为乐观收益率制定计划实际上更有效。但是我们必须确保我们没有忽略另一个可能更好的选择。一种方法是采用强力方法生成所有可能的种植方案，并计算每个方案的预期利润值(EV ),就像我们计算我们提出的 3 个方案的 EV 一样。如果我们允许分配英亩的真实值，可能的选项是无限的，因此这种方法是不可能的。如果将选择限制在 0 到 500 之间的整数选项，我们也许能够列举出这些选择，但是如果农民想要增加种植作物的限制，这是一个很难修改的方法。

我们实际上可以聪明地列举出所有可能的选项，而不需要使用蛮力方法。我们将强迫线性规划求解器为我们做那件事。

这本[笔记本](https://github.com/buzzrk/mlor/blob/main/Optimization/Stochastic/Farmer/Farmer_DEP.ipynb)有很好的解释，你可以一步一步来。我建议在使用笔记本之前阅读下面的方法。

# 随机线性规划

让我们改写一下利润的等式。

> 利润= —种植作物的成本+季末作物销售收入—购买小麦和玉米的成本赤字

请注意，种植作物的成本仅取决于分配给每种作物的英亩数，而不取决于实现的产量。然而，销售的收入和购买作物的成本取决于产量。

到目前为止，我们已经尝试在假设收益率的情况下决定买入和卖出的数量，然后计算三种情况下的预期价值。然而，我们必须解决三个独立的线性规划。如果我们把三个线性程序合并成一个呢？这就是随机规划的本质——我们通过评估所有可能场景的预期利润值来动态寻找最佳的第一阶段决策*。*

这个提法叫做**确定性等价问题** ( *DEP* )。

# 决策变量

请注意，我们被允许对每个场景的购买和销售做出*三个不同的第二阶段决策(收益率在我们必须做出这些决策时实现)。然而，对于种植的英亩数，我们只能做出*一个可能的第一阶段决策*(如果我们被允许做出三英亩决策，这意味着我们有完美的信息)。换句话说，我们在各种情况下对冲第一阶段决策的影响。但是，我们不是手动计算我们决策的 EV，而是让线性程序为我们的英亩选择在所有可能的情况下最大化预期利润的值。*

我们可以把决策变量分为两个阶段。

**一组第一阶段变量**，链接到每组第二阶段变量。这些与我们第一个用产量平均值求解的线性程序相同。

```
var_acres_planted = LpVariable.dicts("plant_acres", items, lowBound=0, cat='Continuous')
```

**每种可能情况的几组第二阶段变量**。请注意，当我们完成求解时，我们对第二阶段变量没有一个答案；我们有几个答案——每个场景一个。我们的代码可以通过添加场景作为每组变量的键来重用。

# **目标函数**

第一阶段和第二阶段都对利润有贡献。然而，第二阶段的贡献取决于每个场景，因此我们必须考虑所有场景的期望值。

> 利润= —种植作物的成本+
> 
> 1/3(季末作物销售收入——购买小麦和玉米的成本赤字),因为产量不佳+
> 
> 平均产量+的 1/3(季末作物销售收入-购买小麦和玉米的成本赤字)
> 
> 1/3(季末作物销售收入——购买小麦和玉米的成本赤字)用于高产

# 限制

我们可以把约束看作两组。

## 第一阶段约束

这些约束只影响第一阶段的决策。我们今天只有总英亩数约束，但该模型可以处理任何其他约束。这些与我们第一个用产量平均值求解的线性程序相同。

**农场可用英亩数**

所有作物的种植面积≤ 500 英亩

```
M += lpSum([var_acres_planted[i] **for** i **in** items]) <= total_acres
```

## 第二阶段约束

这些约束将每组第二阶段变量链接到第一阶段变量。请注意，我们知道这些约束条件中每一个的情况，因此所有的参数都随着情况的变化而变化，例如，当我们为与不良产出情况相关的变量编写约束条件时，我们知道产出是不良的)

**小麦和玉米:**

种植生产的作物+购买的作物=用于消费的作物+出售给市场的作物

**对于豆子:**

*   种植生产的作物-以正常价格出售给市场的作物-以较低价格出售给市场的作物=豆类消费(我们的农民为 0)
*   以正常价格出售给市场的作物≤ 6000 吨

# 用 Python 求解随机模型

![](img/e53420f6ae1bc20115c62d50dbe29696.png)

由 [Pakata Goh](https://unsplash.com/@pakata?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

该方程组可以在任何线性规划求解器中求解。出于学习的目的，我选择了开源 Python 包 PuLP，它允许任何人以最小的安装运行代码。

笔记本可以在这里找到[。请使用 conda 或 pip 安装纸浆。](https://github.com/buzzrk/mlor/blob/main/Optimization/Stochastic/Farmer/Farmer_DEP.ipynb)

```
pip install pulp
```

我们可以运行求解器并获得最优解，然后使用 python 计算下表来计算成本、收入和利润。*解决方案如下。*鉴于豆类的二级销售价格非常低，分配给豆类的英亩数是直观的，但玉米和小麦的选择却不是。一般来说，凭直觉找到这个解是非常困难的。

*   种植大豆，确保我们永远不会低价出售大豆——250 英亩高产大豆可产 6000 吨。
*   种植玉米以满足平均产量下的农场需求。
*   在剩下的几英亩土地上种植小麦。

对于任何单个场景产量，该解决方案显然不能胜过该场景的最优解决方案(根据最优解决方案的定义)。但是它在三个可能场景中的期望值比三个解决方案(我们在第 1 部分中计算的 86600 美元、107240 美元、107683 美元)和任何可能的第一阶段解决方案都要好。我们解决的随机线性规划使这成为可能。

# 随机解决方案(VSS)的价值和交付的总价值

我们的竞争对手只懂线性规划，根据平均收益率做出合理的推荐。通过了解这种随机方法，我们给农民增加了额外的利润。这就是随机方法(VSS)的价值。在本例中，它是 108390 美元–107240 美元= 1150 美元。

> VSS =随机解(DEP)的 EV—均值解的 EV

我们给农民增加的总利润值是多少？这取决于农民会如何利用自己的直觉种植作物。我们可以计算该解决方案的预期价值，并计算我们增加的额外利润。在我们的笔记本中，通过将变量设置为农民的手动解决方案，可以很容易地做到这一点。请注意，该价值的很大一部分是由线性程序提供的，利润为 107240 美元。

**练习**:如果农民通常种植两种利润最高的作物——豆类和小麦，种植 300 英亩豆类和 200 英亩小麦，预期利润值是多少？我们总共增加了多少价值(Ans:10190 美元？线性程序传递了什么价值(答案:9040 美元)？VSS 占总价值的百分比是多少(答案:12.7%)？

# 完全信息的期望值

一个机器学习专家团队提出，他们将能够以 100%的准确率提供每年的产量预测。当农民已经可以得到我们的随机解时，他能为这个信息支付的最高价格是多少？这被称为完美信息的期望值(EVPI)。

> EVPI =每个场景使用最优解的 EV-随机解的 EV

EVPI = 1/3(59950 美元+118600 美元+167667 美元)-108390 美元= 7016 美元

# 如果收益因子(收益的乘数)有一个概率分布

*   如果概率分布是离散的，我们可以通过为每个离散值生成收益字典来重复这个笔记本。
*   如果概率分布是连续的，我们可以通过生成分布的切片使其离散。这种方法有多靠谱？我不会在这里涵盖细节，但理论表明，如果我们产生足够的样本，这是非常准确的。请注意，为了获得更多的准确性，我们将有数百或数千个场景。对于这个问题，这个问题应该很容易解决，但是如果给定场景的线性规划(第 1 部分的平均值问题)本身很复杂，我们将面临计算上的挑战。我们可以使用强大的商业软件包，但我们甚至可以测试它们的极限。有一种技术叫 Benders 分解(L 形法)，可以通过分解成两个阶段来解决问题。

# 结论

*   我们学会了如何修改我们的线性程序，通过为依赖于场景的每个变量创建多个副本来考虑所有可能的场景。
*   这个解为我们提供了第一阶段的最优解。第二阶段变量有几个答案。农民可以在产量实现后每年计算它们，并采取相应的行动(购买赤字并出售剩余的作物)。
*   解决这个问题的随机版本，通过对冲所有可能的情况，使我们获得更好的利润预期值。

# 后续步骤

*   在这个问题中，我们解决了期望值最大化的问题。这是最受欢迎的选择。我们也可以求解其他目标；其中一些很难建模。我建议解决它们。
*   解决多阶段问题。在下面提到的课堂笔记中，有一个财务规划问题就是一个很好的例子。

# 参考

我将把我的参考资料限制在解释基础知识和涉及这个问题的资源上。

[1] J. Linderoth，[课堂笔记](http://homepages.cae.wisc.edu/~linderot/classes/ie495/lecture2.pdf)涵盖了这个问题。附加[注释](http://homepages.cae.wisc.edu/~linderot/classes/ie495/)

[2] J. Birge，F. Louveaux，教科书:[随机规划介绍](https://link.springer.com/book/10.1007/978-1-4614-0237-4) —这个问题在第 1 章中有所涉及。

[3]Python 中的[纸浆](https://pypi.org/project/PuLP/)解算器的官方网站