# å¡æ™®å…°-è¿ˆè€¶æ›²çº¿è§£é‡Šé“

> åŸæ–‡ï¼š<https://towardsdatascience.com/kaplan-meier-curve-explained-9c78a681faca?source=collection_archive---------9----------------------->

## æ•°æ®ç§‘å­¦åŸºç¡€

## å­¦ä¹ å¦‚ä½•åœ¨ Python ä¸­ä»å¤´å¼€å§‹æ„å»º KM æ›²çº¿ä»¥åŠå…¶ä»–ä¸¤ç§æ–¹æ³•

Kaplan-Meier æ›²çº¿æ˜¯ä¸€ç§æµè¡Œçš„ç”Ÿå­˜åˆ†æå·¥å…·ï¼Œå®ƒæœ‰åŠ©äºåœ¨æ•°æ®ä¸å®Œæ•´çš„æƒ…å†µä¸‹ç†è§£ç”Ÿå­˜æ¦‚ç‡ã€‚åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä»å¤´å¼€å§‹æ„å»º Kaplan-Meier æ›²çº¿ä»¥è·å¾—æ›´å¥½çš„ç†è§£ï¼Œç„¶åçœ‹çœ‹ä½¿ç”¨ Python ä¸­çš„ç”Ÿå­˜åˆ†æåº“æ„å»ºå®ƒçš„ä¸¤ç§æ–¹æ³•ã€‚

![](img/e2564ff79122095c1b5323dcceb522a1.png)

Ravi Roshan åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„çš„ç…§ç‰‡

# 0.æ•°æ®

è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æœ‰ä» 2020 å¹´ 9 æœˆåˆ° 2021 å¹´ 6 æœˆæ”¶é›†çš„æ•°æ®ï¼Œç”¨äºä¸€é¡¹ä¸´åºŠç ”ç©¶ï¼Œä»¥äº†è§£ç™Œç—‡æ‚£è€…çš„ç”Ÿå­˜æœŸã€‚ä»¥ä¸‹æ˜¯å‚ä¸è¿™é¡¹å‡è®¾ç ”ç©¶çš„äººçš„æ—¶é—´è¡¨:

![](img/82abc4573b878a3fe46c3491402f390b.png)

å·¦è¾¹çš„å­—æ¯æ˜¯å‚ä¸è€…çš„å”¯ä¸€æ ‡è¯†ç¬¦|ä½œè€…å›¾ç‰‡

æˆ‘ä»¬å°†å‡æƒ³ç ”ç©¶çš„æ•°æ®é›†ä¿æŒåœ¨è¾ƒå°çš„èŒƒå›´å†…ï¼Œä»¥ä¾¿æ›´å®¹æ˜“å¯†åˆ‡ç›‘æ§è¯¥è¿‡ç¨‹ã€‚é»‘è‰²å®å¿ƒåœ†åœˆè¡¨ç¤ºè®°å½•çš„æœ€åä¸€ä¸ªæ•°æ®æ¡ç›®ã€‚åœ†åœˆå†…çš„å‰è¡¨ç¤ºè®°å½•æœ‰äº‹ä»¶(å³æ­»äº¡)ï¼Œè€Œé—®å·è¡¨ç¤ºè®°å½•æ²¡æœ‰äº‹ä»¶ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œæœ‰ä¸‰ç§å¯èƒ½çš„æƒ…å†µã€‚

1.  **å‘ç”Ÿäº‹ä»¶:**åœ¨ç ”ç©¶æœŸé—´å‘ç”Ÿäº‹ä»¶(å¦‚è®°å½• *a* å’Œ *c*
2.  **æ— äº‹ä»¶:**åœ¨ç ”ç©¶ç»“æŸæ—¶æ— äº‹ä»¶(å¦‚è®°å½• b å’Œ d)ã€‚
3.  **æ— äº‹ä»¶:**åœ¨ç»ˆç‚¹å‰é€€å‡ºç ”ç©¶ï¼Œä¸”åœ¨å‚ä¸ç ”ç©¶æ—¶æœªå‘ç”Ÿäº‹ä»¶(å¦‚è®°å½• *f* å’Œ *h* )ã€‚

ç¬¬äºŒç±»å’Œç¬¬ä¸‰ç±»è®°å½•è¢«ç§°ä¸ºåˆ æˆªè®°å½•ï¼Œæ›´ç¡®åˆ‡åœ°è¯´æ˜¯å³åˆ æˆªè®°å½•ï¼Œå› ä¸ºæˆ‘ä»¬å¯¹äº‹ä»¶çš„ä¿¡æ¯ä¸å®Œæ•´ã€‚

åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°æ¨ªè½´ä¸Šæœ‰ä¸€ä¸ª*æ—¥å†æ—¶é—´*ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å°†*æ—¥å†æ—¶é—´*è½¬æ¢ä¸º*å­˜æ´»æ—¶é—´*ï¼Œ*ç›¸å¯¹äºç ”ç©¶ç™»è®°æ—¥æœŸæµ‹é‡çš„* *æŒç»­æ—¶é—´*ã€‚*å­˜æ´»æ—¶é—´*åœ¨æˆ‘ä»¬ç¨åå°†è¦ç†Ÿæ‚‰çš„ Python åº“ä¸­é€šå¸¸è¢«ç§°ä¸º*æŒç»­æ—¶é—´*ï¼›å› æ­¤ï¼Œä»è¿™é‡Œå¼€å§‹ï¼Œæˆ‘ä»¬å°†äº’æ¢ä½¿ç”¨è¿™äº›æœ¯è¯­ã€‚

![](img/1dead3a6b795035798b2915bca1e2c1b.png)

ä½œè€…å›¾ç‰‡

ä½¿ç”¨ä¸‹é¢çš„è„šæœ¬ï¼Œè®©æˆ‘ä»¬å¯¼å…¥æˆ‘ä»¬éœ€è¦çš„åº“ï¼Œå¹¶ä¸º 9 æ¡è®°å½•åˆ›å»ºä¸€ä¸ªåŒ…å«*æŒç»­æ—¶é—´*å’Œ*äº‹ä»¶*çš„å°æ•°æ®å¸§:

```
# Data manipulation
import numpy as np
import pandas as pd
from string import ascii_lowercase# Visualisation
import matplotlib.pyplot as plt
import seaborn as sns
sns.set(style='dark', context='talk')# Kaplan-Meier curve
from lifelines import KaplanMeierFitter 
from sksurv.nonparametric import kaplan_meier_estimator# Create a toy dataframe
df = pd.DataFrame(data={'duration': [3,9,5,8,7,2,1,3,4],
                        'event': [1,0,1,0,1,0,1,0,0]}, 
                  index=list(ascii_lowercase[:9]))
df
```

![](img/5f01a5c27bb284205f707a4e186a1d8e.png)

äº‹ä»¶æ :0 è¡¨ç¤ºå®¡æŸ¥ï¼Œ1 è¡¨ç¤ºæœ‰äº‹ä»¶

# 1.æˆ‘ä»¬è‡ªå·±ä»é›¶å¼€å§‹å»ºé€ 

ç°åœ¨è®©æˆ‘ä»¬ç†Ÿæ‚‰ä¸€ä¸‹æ¦‚å¿µçŸ¥è¯†ã€‚å¡æ™®å…°-è¿ˆè€¶æ›²çº¿æ˜¯å¡æ™®å…°-è¿ˆè€¶ä¼°è®¡é‡çš„ç›´è§‚è¡¨ç¤ºï¼Œå®ƒåšå‡ºä»¥ä¸‹å‡è®¾:

1.  **å®¡æŸ¥:**ç»è¿‡å®¡æŸ¥çš„è§‚å¯Ÿå’Œæœªç»å®¡æŸ¥çš„è§‚å¯Ÿæœ‰ç€ç›¸åŒçš„ç”Ÿå­˜å‰æ™¯ã€‚
2.  **ç ”ç©¶è¿›å…¥æ—¶é—´:**åœ¨ç ”ç©¶æ—©æœŸå’ŒåæœŸæ‹›å‹Ÿçš„è§‚æµ‹å€¼çš„å­˜æ´»æ¦‚ç‡ç›¸åŒã€‚
3.  **äº‹ä»¶æ—¶é—´:**äº‹ä»¶åœ¨è§„å®šçš„æ—¶é—´å‘ç”Ÿ

å¡æ™®å…°-è¿ˆè€¶ä¼°è®¡é‡ç”±ä»¥ä¸‹å…¬å¼å®šä¹‰:

![](img/ba171b74ca4e1fcdc12e840708b8c8eb.png)![](img/d6d9cdef6312ac7c4a011abb88b1727c.png)

æœ‰äº†è¿™ä¸ªå…¬å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ±‚å‡ºç»™å®šæ—¶åˆ»çš„ç”Ÿå­˜æ¦‚ç‡ã€‚æ— è®º *i* ä» 1 è¿˜æ˜¯ 0 å¼€å§‹éƒ½æ²¡æœ‰åŒºåˆ«ï¼Œå› ä¸º 0 æ—¶åˆ»çš„ç”Ÿå­˜æ¦‚ç‡æ˜¯ 1ã€‚å¦‚æœæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿè¿™ä¸ªå…¬å¼ï¼Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°æ‹¬å·å†…çš„å†…å®¹æ˜¯æ•è·*å­˜æ´»æ¯”ä¾‹(å³ 1-æ­»äº¡æ¯”ä¾‹)*ã€‚

è®©æˆ‘ä»¬ç”¨è¿™ä¸ªå…¬å¼æ‰¾å‡ºå‰ä¸‰ä¸ªæŒç»­æ—¶é—´çš„ç”Ÿå­˜æ¦‚ç‡:

![](img/9c60c1fd1c1d66a9d9e43cd2c3bc7c7a.png)

åœ¨ç ”ç©¶è¿›è¡Œä¸€ä¸ªæœˆåï¼Œæˆ‘ä»¬æœ‰ 9 åå‚ä¸è€…å¤„äºå±é™©ä¸­ï¼Œä¸€åå‚ä¸è€…å·²ç»æ­»äº¡ã€‚å› æ­¤ï¼Œd1 = 1ï¼Œn1 = 9ã€‚

![](img/3423f69ab78ec59efca071e54f0beda0.png)

åœ¨ç ”ç©¶çš„ä¸¤ä¸ªæœˆåï¼Œæˆ‘ä»¬æœ‰ 8 åå‚ä¸è€…å¤„äºå±é™©ä¸­ï¼Œæ²¡æœ‰äººæ­»äº¡ã€‚å› æ­¤ï¼Œd2 = 0ï¼Œn = 8ã€‚å¦‚ä½ æ‰€è§ï¼Œå½“æŒç»­æ—¶é—´æ²¡æœ‰äº‹ä»¶æ—¶ï¼Œç”Ÿå­˜æ¦‚ç‡ä¸å‰ä¸€ä¸ªæŒç»­æ—¶é—´ç›¸åŒã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªæŒç»­æ—¶é—´æ²¡æœ‰äº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è·³è¿‡è®¡ç®—ï¼Œä½¿ç”¨å‰ä¸€ä¸ªç”Ÿå­˜æ—¶é—´çš„ç”Ÿå­˜æ¦‚ç‡ã€‚

![](img/32b2eaa1a2ee1f369b5f0a6bd88d7c17.png)

åœ¨ç ”ç©¶çš„ç¬¬ä¸‰ä¸ªæœˆï¼Œæˆ‘ä»¬æœ‰ 7 ä¸ªè®°å½•å¤„äºå±é™©ä¸­ï¼Œ1 ä¸ªæ­»äº¡ï¼Œå­˜æ´»æ¦‚ç‡ä¸‹é™åˆ° 0.76ã€‚è¿™ä¸ªç­‰å¼ç°åœ¨å˜å¾—è¶Šæ¥è¶Šé•¿ï¼Œè¶Šæ¥è¶Šç¹çã€‚æˆ‘ä»¬å¯ä»¥å°†å…¬å¼æ”¹å†™ä¸ºä»¥ä¸‹æ›´ç®€å•çš„å½¢å¼:

![](img/31dc404c193b0fcd2ad59696e84a3084.png)

ä½¿ç”¨è¿™ä¸ªå…¬å¼ï¼Œè®¡ç®—æ›´åŠ ç®€æ´:

![](img/6ba49354d9f2e2eeb5e82b9706827dd8.png)

è¿™ä¸‰ä¸ªä¾‹å­è¯´æ˜äº†æ¦‚ç‡æ˜¯å¦‚ä½•ä¼°è®¡çš„ã€‚ä¸å…¶é‡å¤è®¡ç®—å…¶ä½™éƒ¨åˆ†ï¼Œä¸å¦‚è®©æˆ‘ä»¬å°†é€»è¾‘è½¬æ¢æˆ Python è„šæœ¬ï¼Œå¹¶è®¡ç®—æ‰€æœ‰æŒç»­æ—¶é—´çš„ç”Ÿå­˜æ¦‚ç‡:

```
# Prepare unique durations in ascending order
durations = df.sort_values('duration')['duration'].unique()# Initialise the table
columns = ['duration', 'n_at_risk', 'n_events', 
           'survival_probability']
km = pd.DataFrame(columns=columns, dtype=np.number)
km = km.append(pd.DataFrame([[0, df.shape[0], 0, 1]], 
                            columns=columns))# Calculate survival probability for each duration
for i, t in enumerate(durations):
    n = np.sum(df['duration']>=t)
    d = np.sum((df['duration']==t) & (df['event']==1))
    s = (1 - d / n) * km.loc[i, 'survival_probability']
    km = km.append(pd.DataFrame([[t, n, d, s]], 
                                index=[i+1],
                                columns=columns))
km
```

![](img/8cd43004c2422c273a81f0156070c594.png)

å¡æ™®å…°-è¿ˆè€¶æ›²çº¿éœ€è¦*ç”Ÿå­˜æ¦‚ç‡*å’Œ*æŒç»­æ—¶é—´*æ ã€‚ç°åœ¨è®©æˆ‘ä»¬ç»˜åˆ¶æ›²çº¿ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†è¾“å…¥ã€‚

```
plt.figure(figsize=(8,4))
sns.lineplot(data=km, x='duration', y='survival_probability', 
             drawstyle='steps-post')
plt.ylim(0,1.1) 
plt.title("Kaplan-Meier curve");
```

![](img/e9b3ca872700a0ce7d772ac55c85d096.png)

ç§ï¼Œæˆ‘ä»¬åˆšåˆšè‡ªå·±ç»˜åˆ¶äº†æ›²çº¿ã€‚ä»é›¶å¼€å§‹æ„å»ºæ›²çº¿æœ‰æœ›å¸®åŠ©ä½ ç†è§£æ½œåœ¨çš„é€»è¾‘ã€‚å·²ç»å­¦ä¼šäº†å¦‚ä½•è‡ªå·±æ„å»ºæ›²çº¿ï¼Œè®©æˆ‘ä»¬æ¥å­¦ä¹ ç»˜åˆ¶å¡æ™®å…°-è¿ˆè€¶æ›²çº¿çš„æ›´å®ç”¨çš„æ–¹æ³•ã€‚æˆ‘ä»¬å°†ç†Ÿæ‚‰ä¸¤ä¸ªæä¾›ç°æˆè§£å†³æ–¹æ¡ˆçš„åº“ã€‚

# 2.ä½¿ç”¨ç”Ÿå‘½çº¿

Lifeline æ˜¯ Python ä¸­ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„ç”Ÿå­˜åˆ†æåº“ã€‚å¡æ™®å…°-è¿ˆè€¶æ›²çº¿å¯ä½¿ç”¨`KaplanMeierFitter`å¯¹è±¡ç»˜åˆ¶æˆå‡ æ¡çº¿:

```
kmf = KaplanMeierFitter() 
kmf.fit(df['duration'], df['event'])plt.figure(figsize=(8,4))
kmf.plot()
plt.title("Kaplan-Meier curve");
```

![](img/b4a18cc2e0a9c2e818d33942c726cbda.png)

ä»æ‹Ÿåˆçš„å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è®¿é—®`survival_function_`å±æ€§æ¥æŸ¥çœ‹ç”Ÿå­˜æ¦‚ç‡:

```
kmf.survival_function_
```

![](img/71b7427c9036ece8b6e4a0964b4d458b.png)

æˆ‘ä»¬è¿˜å¯ä»¥æå–äº‹ä»¶è¡¨ï¼Œå®ƒç±»ä¼¼äºæˆ‘ä»¬åœ¨*ç¬¬ 1 èŠ‚*ä¸­æ„å»ºçš„ä¸€ä¸ªè¡¨ã€‚

```
kmf.event_table
```

![](img/0b5470e2bd42e14cc9cb8adc23d4b612.png)

åˆ—'*'è§‚å¯Ÿ'*ä¸ç¬¬ 1 èŠ‚è¡¨æ ¼ä¸­çš„åˆ—*' n _ äº‹ä»¶'*ç›¸åŒã€‚æ­¤å¤–ï¼Œä¸¤ä¸ªè¡¨ä¸­çš„â€œé£é™©â€å’Œâ€œn é£é™©â€åˆ—æ˜¯ç›¸åŒçš„ã€‚

æœ‰äº†*ç”Ÿå‘½çº¿*ï¼Œç»˜åˆ¶æ›²çº¿å’Œæ£€æŸ¥ä¼°è®¡å™¨çš„ç»†èŠ‚å˜å¾—å¾ˆå®¹æ˜“ã€‚

# 3.ä½¿ç”¨ scikit-survival

å¦ä¸€ä¸ªæœ‰ç”¨çš„ç”Ÿå­˜åˆ†æåº“æ˜¯ *scikit-survival* ã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒä¸ *scikit-learn* åè°ƒå·¥ä½œã€‚åˆ©ç”¨`kaplan_meier_estimator()`å¯ä»¥å¾—åˆ°*æŒç»­æ—¶é—´*å’Œ*ç”Ÿå­˜æ¦‚ç‡*ã€‚ä¸€æ—¦æˆ‘ä»¬æœ‰äº†æ›²çº¿æ‰€éœ€çš„è¾“å…¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»ä½•å¯è§†åŒ–åº“æ¥ç»˜åˆ¶å®ƒã€‚ç”±äºæˆ‘ä»¬åœ¨ç¬¬ 1 èŠ‚ä¸­ä½¿ç”¨äº† *seaborn* ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹ä½¿ç”¨ *matplotlib* ç»˜å›¾çš„å¦ä¸€ç§æ–¹æ³•:

```
duration, survival_probability = kaplan_meier_estimator(df['event']==1, df['duration'])
plt.figure(figsize=(8,4))
plt.step(x=duration, y=survival_probability, where="post")
plt.ylim(0,1.1)
plt.xlabel("Survival time (months)")
plt.ylabel("Survival probability")
plt.title("Kaplan-Meier curve");
```

![](img/c34e86376537d0adbb4003235b6dad7b.png)

è‡³æ­¤ï¼Œæ‚¨å·²ç»å­¦ä¹ äº†ä¸ºå¡æ™®å…°-è¿ˆè€¶æ›²çº¿å‡†å¤‡è¾“å…¥çš„åŸºæœ¬é€»è¾‘ï¼Œå¹¶ç†Ÿæ‚‰äº†ç»˜åˆ¶æ›²çº¿çš„å‡ ç§ä¸åŒæ–¹æ³•ï¼

![](img/c1299000bb78af920393a41a8dc8a32d.png)

[Bruce Hong](https://unsplash.com/@hongqi?utm_source=medium&utm_medium=referral) åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šçš„ç…§ç‰‡

æ‚¨æƒ³è¦è®¿é—®æ›´å¤šè¿™æ ·çš„å†…å®¹å—ï¼Ÿåª’ä½“ä¼šå‘˜å¯ä»¥æ— é™åˆ¶åœ°è®¿é—®åª’ä½“ä¸Šçš„ä»»ä½•æ–‡ç« ã€‚å¦‚æœä½ ä½¿ç”¨ [*æˆ‘çš„æ¨èé“¾æ¥*](https://zluvsand.medium.com/membership)*æˆä¸ºä¼šå‘˜ï¼Œä½ çš„ä¸€éƒ¨åˆ†ä¼šè´¹ä¼šç›´æ¥å»æ”¯æŒæˆ‘ã€‚*

æ„Ÿè°¢æ‚¨é˜…è¯»è¿™ç¯‡æ–‡ç« ã€‚å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œè¿™é‡Œæœ‰æˆ‘çš„ä¸€äº›å…¶ä»–å¸–å­çš„é“¾æ¥:
â—¼ï¸ [ROC æ›²çº¿è§£é‡Š](/roc-curve-explained-50acab4f7bd8)
â—¼ï¸ [æœ‰ç”¨çš„ IPython é­”æ³•å‘½ä»¤](/useful-ipython-magic-commands-245e6c024711)
â—¼ï¸ [ä»é›¶å¼€å§‹å­¦ä¹  Python çš„ 5 ä¸ªæŠ€å·§](/5-tips-to-learn-python-from-zero-e4f6a9106558)
â—¼ï¸ [ç”¨è¿™äº›æŠ€å·§ç»„ç»‡ä½ çš„ Jupyter ç¬”è®°æœ¬](/organise-your-jupyter-notebook-with-these-tips-d164d5dcd51f)
â—¼ï¸ï¸ [åœ¨ç†ŠçŒ«ä¸­ç¼–å†™ 5 ä¸ªå¸¸è§çš„ SQL æŸ¥è¯¢](/writing-5-common-sql-queries-in-pandas-90b52f17ad76)

å†è§ğŸƒğŸ’¨