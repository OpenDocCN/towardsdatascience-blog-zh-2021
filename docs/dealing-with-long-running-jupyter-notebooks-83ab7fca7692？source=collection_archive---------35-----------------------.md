# 处理长时间运行的 Jupyter 笔记本

> 原文：<https://towardsdatascience.com/dealing-with-long-running-jupyter-notebooks-83ab7fca7692?source=collection_archive---------35----------------------->

## 当您的浏览器与 Jupyter 笔记本断开连接时，这是非常令人沮丧的！

![](img/9a438444334c1fa5060f550d5309afd6.png)

内森·杜姆劳在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

在[Saturn Cloud，我们管理着一个数据科学平台](https://www.saturncloud.io)，该平台提供 Jupyter 笔记本、Dask 集群以及部署模型、仪表盘和作业的方式。因此，我们经常帮助客户对他们的笔记本电脑进行故障诊断，网络断开是一个常见问题。

我们已经有很多客户在为长时间运行的 Jupyter 笔记本而苦恼——那些需要几个小时或更长时间才能运行的笔记本。他们经常来找我们，因为这些长时间运行的笔记本电脑在某个时候会失去服务器和浏览器之间的连接，这在云服务中很常见。通常云服务会正常地重新连接，不会有任何问题，但是在 Jupyter 的情况下，如果连接丢失，那么 Jupyter 将停止保存任何输出。Jupyter 笔记本将所有状态存储在浏览器中，这意味着如果运行代码的服务器和查看代码的浏览器之间出现连接问题，笔记本的状态就会丢失。

如果我们客户的长时间运行的代码中有一个错误，并且连接曾经中断，那么用户就不能看到代码的输出和它所创建的错误消息。试图在没有输出的情况下调试这些模型是徒劳的。在本地使用 Jupyter 时这不是问题，因为计算机与自身的连接是无限稳定的，但在云中工作时这是一个问题。

# 背景

Jupyter 笔记本将所有状态存储在浏览器中，因此需要持续的网络连接。这是一个众所周知的设计问题，有许多含义。虽然网络问题不会导致笔记本中的代码停止执行，但它会影响输出保存到笔记本的方式。

Jupyter 笔记本的流程是:

*   服务器将输出推送到您的浏览器。
*   您的浏览器将其添加到笔记本对象中(并将其呈现到屏幕上)。
*   您的浏览器会将笔记本保存回服务器。

在网络切断的情况下，该流中断，并且没有输出被保存。长期的解决方案是对 Jupyter 本身进行修改，以处理间歇性连接，这是一个非常活跃的讨论领域。目前还没有将它添加到开源 Jupyter 的时间表。

然而，有一个短期战略。

# 解决办法

我们只需少量代码就可以调整 Jupyter，使其将输出直接保存到服务器上的一个文件中。通过这样做，即使网络连接中断，服务器仍会存储输出。这并不完美——在理想的情况下，这种输出仍然会出现在笔记本本身中，但是将它们存储在某个地方而不是丢失是一种改进。将这段代码放在您长期运行的笔记本的顶部:

在你的笔记本顶部执行。 *TADA！*现在，当您运行笔记本电脑时，所有输出都将镜像到`data.log`平面文件中。

![](img/ccd9e6fcec29587200150dacf9d13b95.png)

**工作原理:**在 Jupyter 笔记本中，普通的`stdout`和`stderr`文件对象被替换为`ipykernel.iostream.OutStream`对象(这就是它们在浏览器中的显示方式)。这个对象有一个 echo 对象，默认为可以传播输出的`None`。因此，第一组代码行粘贴了一个 Python 文件对象来代替 echo，所有普通的`stdout`和`stderr`现在也被复制到磁盘上。异常由 python 日志记录系统处理。在默认配置中，它不输出到`stdout`或`stderr`，因此第二组代码行对其进行了修补，并设置了 log leve。

# 结论

有了这个解决方案，长时间运行 Jupyter 笔记本电脑的最大痛苦就不复存在了。也就是说，在 aat Saturn，我们通常建议使用更好的硬件(GPU)或并行化(Dask ),以避免您的笔记本电脑需要等待 10 个小时才能运行。然而，如果您的问题是不可并行化的，这是一个合理的变通方法。然而，如果**您不知道如何实现并行化，但希望您做到了**，您应该告诉我们！我们真的很擅长！

声明:我是[土星云](https://www.saturncloud.io/s/home/)的 CTO。我们让您的团队轻松连接云资源。想用 Jupyter 和 Dask？部署模型、仪表板或作业？在笔记本电脑或 4 TB Jupyter 实例上工作？完全透明地了解谁在使用哪些云资源？我们做所有这些，甚至更多。

*原载于 2021 年 7 月 15 日*[*https://Saturn cloud . io*](https://saturncloud.io/blog/long-running-notebooks/)*。*