# è®©æ‚¨çš„ SQL ä»Žä¼˜ç§€èµ°å‘å“è¶Š:ç¬¬ 3 éƒ¨åˆ†

> åŽŸæ–‡ï¼š<https://towardsdatascience.com/take-your-sql-from-good-to-great-part-3-687d797d1ede?source=collection_archive---------0----------------------->

## åŠ å…¥è¿åŠ¨çš„æ—¶é—´åˆ°äº†

è¿™æ˜¯å…³äºŽæˆ‘æœ€çœ‹é‡çš„ SQLâ€œæŠ€å·§â€çš„ 4 éƒ¨åˆ†ç³»åˆ—çš„ç¬¬ 3 éƒ¨åˆ†ã€‚æŸ¥çœ‹è¯¥ç³»åˆ—ä¸­çš„å…¶ä»–å†…å®¹:

ç¬¬ä¸€éƒ¨åˆ†:[å¸¸ç”¨è¡¨è¡¨è¾¾å¼](/take-your-sql-from-good-to-great-part-1-3ae61539e92a)

ç¬¬äºŒéƒ¨åˆ†:[å…³äºŽé‚£äº›æ—¥å­çš„ä¸€åˆ‡](/take-your-sql-from-good-to-great-part-2-cb03b1b7981b)

ç¬¬ 3 éƒ¨åˆ†:å…¶ä»–è¿žæŽ¥(ä½ åœ¨è¿™é‡ŒðŸ“)

ç¬¬å››éƒ¨åˆ†:[çª—å£åŠŸèƒ½](/take-your-sql-from-good-to-great-part-4-99a55fd0e7ff)

*æœ‰æ²¡æœ‰ä¸€ä¸ªè¢«ä½Žä¼°çš„ SQL æŠ€å·§è®©ä½ ä¸Žä¼—ä¸åŒï¼Ÿ* [*è®©æˆ‘çŸ¥é“*](mailto:hello@count.co) *ï¼*

# å‘å¾®çš„åŠ å…¥

è”æŽ¥ä¸æ˜¯ä»»ä½•äººéƒ½å–œæ¬¢çš„ SQL éƒ¨åˆ†ã€‚å®ƒä»¬ä¸åƒçª—å£å‡½æ•°é‚£æ ·åŽä¸½ï¼Œä¹Ÿä¸åƒ cte é‚£æ ·å…·æœ‰å˜é©æ€§ã€‚ç„¶è€Œï¼Œå®ƒä»¬æ— ç–‘æ˜¯æˆ‘ä»¬è®¿é—®å’Œè½¬æ¢å…³ç³»æ•°æ®çš„æœ€å¼ºå¤§çš„å·¥å…·ã€‚

æ‰€ä»¥åœ¨è¿›å…¥æˆ‘æœ€å–œæ¬¢çš„ä½¿ç”¨è¿žæŽ¥çš„æ–¹å¼ä¹‹å‰ï¼Œæˆ‘æƒ³æˆ‘åº”è¯¥æé†’è‡ªå·±ä¸ºä»€ä¹ˆæˆ‘ä»¬åº”è¯¥æ›´åŠ å…³æ³¨è¿™ä¸ªé•¿æœŸè¢«å¿½è§†çš„è¿žæŽ¥ã€‚

## 1.ä¼˜åŒ–èƒ½åŠ›

SQL æŸ¥è¯¢ä¸ä¼šæŒ‰ç…§å®ƒä»¬è¢«å†™å…¥(æˆ–è¯»å–)çš„é¡ºåºè¿è¡Œã€‚äº‹å®žä¸Šï¼ŒSELECT è¯­å¥æ˜¯æŸ¥è¯¢è¿è¡Œæ—¶æœ€åŽå®Œæˆçš„æ­¥éª¤ä¹‹ä¸€ã€‚

è¿è¡Œçš„æŸ¥è¯¢çš„ç¬¬ä¸€éƒ¨åˆ†æ˜¯ FROM/JOIN å­å¥ï¼Œè¿™æ„å‘³ç€å¦‚æžœæˆ‘ä»¬æƒ³æé«˜æŸ¥è¯¢æ€§èƒ½(è°ä¸æƒ³)ï¼Œæˆ‘ä»¬åº”è¯¥é¦–å…ˆçœ‹çœ‹æˆ‘ä»¬çš„è€æœ‹å‹ JOINã€‚

![](img/f86ce40a2f7a5c6e6c83e4ad8ec7a7e9.png)

æœ±èŽ‰å¨…Â·åŸƒæ–‡æ–¯æ‹æ‘„çš„ç…§ç‰‡ã€‚

## 2.åˆ›é€ æ€§è§£å†³é—®é¢˜

æˆ‘æ¬£èµè¿žæŽ¥çš„å¦ä¸€ä¸ªä¸å¤ªæŠ€æœ¯æ€§çš„åŽŸå› æ˜¯ï¼Œå®ƒä»¬å…è®¸æˆ‘ä»¬æ›´æœ‰åˆ›é€ æ€§åœ°æ€è€ƒæˆ‘ä»¬çš„æ•°æ®åˆ†æžã€‚å®ƒä»¬å°±åƒæˆ‘ä»¬çš„ä¹é«˜ç§¯æœ¨ä¸Šçš„é¥°é’‰ï¼Œå…è®¸æˆ‘ä»¬å»ºé€ æ¯”æˆ‘ä»¬çš„å•ä¸ªè¡¨æ ¼æ•°æ®åº“æœ¬èº«æ›´å¤§çš„ä¸œè¥¿ã€‚

è¿™ç§èƒ½åŠ›å’Œçµæ´»æ€§æ˜¯æˆ‘ä»¬ä»Šå¤©ä»ç„¶ä½¿ç”¨å…³ç³»æ•°æ®åº“çš„ä¸»è¦åŽŸå› ä¹‹ä¸€ï¼Œå°½ç®¡å®ƒä»¬å·²ç»æœ‰å°†è¿‘ 50 å¹´çš„åŽ†å²äº†ã€‚

# é»˜è®¤è¿žæŽ¥

å°½ç®¡æœ‰å¤ªå¤šçš„è¿žæŽ¥ç±»åž‹å¯ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œä½†å¤§å¤šæ•°äººéƒ½é»˜è®¤ä½¿ç”¨å·¦è¿žæŽ¥ã€‚è¿™æœ‰ä¸€äº›éžå¸¸åˆç†çš„ç†ç”±ã€‚æˆ‘ä»¬(åœ¨è¥¿æ–¹ä¸–ç•Œä¸­)ä»Žå·¦å‘å³é˜…è¯»ï¼Œä»Žæˆ‘ä»¬æåˆ°çš„ç¬¬äºŒä¸ªè¡¨ä¸­æ·»åŠ åˆ—å¯¹æˆ‘ä»¬æ¥è¯´æ›´å®¹æ˜“æ¦‚å¿µåŒ–ï¼Œå¹¶ä¸”å®ƒçš„è®¡ç®—å¼€é”€æ›´å°ã€‚

ä½†æ˜¯åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œå°†ä¸€ä¸²å·¦è¿žæŽ¥é“¾æŽ¥åœ¨ä¸€èµ·å¯èƒ½éœ€è¦æ›´å¤šçš„å·¥ä½œï¼Œå¹¶ä¸”è®¡ç®—æˆæœ¬è¶…å‡ºäº†æ‚¨çš„æ‰¿å—èƒ½åŠ›ã€‚å¯¹äºŽè¿™äº›åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹çœ‹ä¸€äº›æ›´å®¹æ˜“è¢«å¿½ç•¥çš„è¿žæŽ¥ç±»åž‹:

![](img/2e22ae35e2248e53b463db2f2582aa06.png)

å¸¸è§è¿žæŽ¥ç±»åž‹ã€‚å›¾ç‰‡ä½œè€…ã€‚

# æ‚¨æ²¡æœ‰å……åˆ†ä½¿ç”¨çš„ JOIN åŠŸèƒ½

## 1.å†…éƒ¨è”æŽ¥ï¼Œè€Œä¸æ˜¯è¿‡æ»¤æŽ‰ç©ºå€¼

æˆ‘ç»å¸¸çœ‹åˆ°äººä»¬åšè¿™æ ·çš„äº‹æƒ…:

```
SELECT ...
FROM X
LEFT JOIN Y
ON X.KEY = Y.KEY
WHERE Y.KEY IS NOT NULL
```

è¿™å®žé™…ä¸Šåªæ‰¾åˆ°äº†è¡¨ X å’Œ Y çš„å…±åŒç‚¹(ä¹Ÿç§°ä¸ºå†…éƒ¨è¿žæŽ¥)ã€‚)

```
SELECT ...
FROM X
INNER JOIN Y
ON X.KEY = Y.KEY
```

**ä¸ºä»€ä¹ˆå–œæ¬¢:** åˆšåˆšå¥½ã€‚ä½†æ›´å…·ä½“åœ°è¯´ï¼Œå®ƒæ›´æœ‰æ•ˆï¼Œå› ä¸ºä½ ä¸éœ€è¦é‚£ä¹ˆå¤šçš„ WHERE è¯­å¥ï¼Œå®ƒæ›´å¿«æ›´å®¹æ˜“é”®å…¥ï¼Œä¹Ÿæ›´å®¹æ˜“è®©åˆ«äººç†è§£ã€‚è¿™æœ¬èº«å¹¶ä¸æ˜¯ä¸€ç§é»‘å®¢è¡Œä¸ºï¼Œè€Œæ˜¯æé†’äº†ä¸€ä¸ªäº‹å®žï¼Œå³å†…éƒ¨è¿žæŽ¥æ˜¯å­˜åœ¨çš„ï¼Œå®ƒé€šå¸¸å¯ä»¥ä¸ºæ‚¨å¤„ç†å¤§é‡çš„è¿‡æ»¤å·¥ä½œã€‚

**ä¸¾ä¾‹:**

å¦‚æžœæˆ‘æƒ³æ‰¾åˆ° Spotify æ¯æ—¥æ’­æ”¾é‡æœ€é«˜çš„ 10 é¦–æ­Œæ›²ï¼Œæˆ‘å¯ä»¥:

1.  æŸ¥æ‰¾æµé‡æœ€å¤§çš„ 10 é¦–æ­Œæ›²
2.  ä½¿ç”¨å†…éƒ¨è¿žæŽ¥å°†å…¶è¿žæŽ¥å›žæˆ‘ä»¬çš„æ¯æ—¥æµæ•°æ®:

![](img/fe46379b8773ba9fe3e08f11203f00a9.png)

å†…éƒ¨è”æŽ¥ç¤ºä¾‹ã€‚([é“¾æŽ¥](https://count.co/n/U4y4XkaeQLx#pSLvVsHNqFy))

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸Šé¢çš„æŸ¥è¯¢ç‰ˆæœ¬(å¸¦æœ‰ top_tracks å†…éƒ¨è¿žæŽ¥ daily_streams)åœ¨ BigQuery ä¸­å¤„ç† 27 MB çš„æ•°æ®éœ€è¦ **0.9** ç§’ã€‚

å·¦è¿žæŽ¥é€‰é¡¹(daily _ streams LEFT JOIN top _ tracksâ€¦WHEREâ€¦)å¤„ç† 27 MB éœ€è¦ **1.9** ç§’ã€‚

è™½ç„¶è¿™ä¸¤ç§æ–¹æ³•éƒ½å¾ˆå¿«ï¼Œä½†æ˜¯æ‚¨å¯ä»¥çœ‹åˆ°å®ƒå¦‚ä½•æ‰©å±•åˆ°æ›´å¤§çš„æ•°æ®ã€‚

## 2.èŒƒå›´è”æŽ¥

å½“æˆ‘ä»¬æƒ³åˆ°è¿žæŽ¥æ—¶ï¼Œæˆ‘ä»¬å€¾å‘äºŽåªæƒ³åˆ°ç­‰å¼ï¼Œä¾‹å¦‚ key == keyã€‚ä½†æ˜¯æˆ‘ä»¬ç»å¸¸éœ€è¦ä¸€ä¸ªæ›´ç²¾ç¡®çš„é€»è¾‘æ¥å°†ä¸¤ä¸ªè¡¨åˆå¹¶åœ¨ä¸€èµ·ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªèŒƒå›´è¿žæŽ¥ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªä¸ç­‰å¼çš„è¿žæŽ¥ã€‚ä¾‹å¦‚:

```
SELECT ...
FROM X
LEFT JOIN Y 
ON X.KEY >=Y.RANGE_START AND X.KEY <= Y.RANGE_END
```

**ä¸ºä»€ä¹ˆå–œæ¬¢:** å½“ä½ éœ€è¦æ ¹æ®ä¸€äº›æ—¶é—´é€»è¾‘æ¥è”æŽ¥ä¸¤ä¸ªè¡¨çš„æ—¶å€™ï¼Œè¿™äº›çœŸçš„å¾ˆæ£’ã€‚æƒ³æƒ³çœ‹ï¼Œå½“ä½ çš„ç”¨æˆ·è´­ä¹°äº†ä»–ä»¬çš„ç¬¬ä¸€ä¸ªäº§å“åŽï¼Œè¯•å›¾æ‰¾åˆ°ä»–ä»¬åš X çš„å®žä¾‹ï¼Œæˆ–è€…æ‰¾åˆ°åœ¨ä»–ä»¬çš„å…è´¹è¯•ç”¨çª—å£å†…å‘ç”Ÿçš„æ‰€æœ‰è¡Œä¸ºã€‚å¦‚æžœæ²¡æœ‰èŒƒå›´è¿žæŽ¥ï¼Œæ‰€æœ‰è¿™äº›éƒ½å°†æ˜¯ç—›è‹¦çš„ï¼Œç”šè‡³æ˜¯å®Œå…¨ä¸å¯èƒ½çš„ã€‚

**ä¾‹å¦‚:**

è®©æˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çš„ Spotify æ•°æ®ï¼Œå‡è®¾æˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°çƒ­é—¨æ­Œæ›²çš„æ¯æ—¥æµåª’ä½“æ•°æ®ï¼Œä½†åªé’ˆå¯¹æ­Œæ›²å‘å¸ƒåŽ 30 å¤©çš„æ•°æ®ã€‚

![](img/23f2de3684903a3575c001ad552c4118.png)

èŒƒå›´è”æŽ¥ç¤ºä¾‹([é“¾æŽ¥](https://count.co/n/U4y4XkaeQLx#P8xT4hByqsG))

![](img/5061728593fece6cdf621e5d518f9222.png)

æ”¾å¤§ SQL

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ç®€å•åœ°æ‰©å±•äº†æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œåœ¨æˆ‘ä»¬çš„å†…éƒ¨è¿žæŽ¥ä¸­å¢žåŠ äº†ä¸€äº›æ¡ä»¶ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬åªé€‰æ‹©éŸ³è½¨å‘å¸ƒåŽ 30 å¤©å†…çš„æ•°æ®ã€‚

**â„¹ï¸è­¦å‘Š:**ä¸æ˜¯æ¯ä¸ª SQL æ–¹è¨€éƒ½æ”¯æŒä¸ç­‰å¼è¿žæŽ¥ã€‚è¿™å¯¹æˆ‘æ¥è¯´æ˜¯ç›¸å½“æƒŠäººçš„ï¼Œä½†åœ¨ä½ å¼€å§‹å°è¯•å®ƒå¹¶å¾—åˆ°ä¸€ä¸ªæ¨¡ç³Šçš„é”™è¯¯ä¹‹å‰ï¼Œæ£€æŸ¥ä¸€ä¸‹ä»ç„¶æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ç„¶åŽåˆ‡æ¢åˆ°æ–°çš„ SQL æ–¹è¨€ã€‚

## 3.æ¨ªå‘è¿žæŽ¥

æˆ‘å‚åŠ æ¨ªå‘åŠ å…¥æ´¾å¯¹çš„æ—¶é—´ç›¸å¯¹è¾ƒæ™šï¼Œä½†æˆ‘ä¸å¾—ä¸è¯´æˆ‘å–œæ¬¢åˆ°ç›®å‰ä¸ºæ­¢æˆ‘æ‰€çœ‹åˆ°çš„ã€‚æˆ‘èŠ±äº†ä¸€æ®µæ—¶é—´æ‰å¼„æ¸…æ¥šå®ƒä»¬åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä½†æœ¬è´¨ä¸Šç†è§£æ¨ªå‘è¿žæŽ¥æœ‰ä¸¤ä¸ªå…³é”®:

1.  å®ƒä»¬å…è®¸æˆ‘ä»¬è®¿é—® FROM è¯­å¥åŽé¢çš„åˆ—ã€‚
2.  å®ƒä»¬çš„æ“ä½œç±»ä¼¼äºŽ FOR EACH è¿ç®—ç¬¦ï¼Œå› ä¸ºå®ƒä»¬æ˜¯é’ˆå¯¹æŸ¥è¯¢çš„æ¯ä¸€è¡Œè¿›è¡Œè®¡ç®—çš„ã€‚

**ä¸ºä»€ä¹ˆå–œæ¬¢:** å¯¹ SQL ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œåšçš„èƒ½åŠ›éƒ½éžå¸¸å¾—å¿ƒåº”æ‰‹ï¼Œå°¤å…¶æ˜¯å½“ä½ éœ€è¦ä¸ºä½ çš„åŸºè¡¨ä¸­çš„æ¯ä¸€è¡Œç”Ÿæˆæ–°è¡Œçš„æ—¶å€™ã€‚

æ­¤å¤–ï¼Œæ¨ªå‘è¿žæŽ¥å…è®¸æ‚¨åœ¨åŒä¸€ä¸ªæŸ¥è¯¢ä¸­æž„å»ºè‡ªå·±ï¼Œä»Žè€Œç®€åŒ–æŸ¥è¯¢é€»è¾‘ã€‚è¿™ç§é€»è¾‘åˆå¹¶æœ‰ä¸¤ä¸ªä¾‹å­[è¿™é‡Œ](https://vladmihalcea.com/sql-lateral-join/)å’Œ[è¿™é‡Œ](https://popsql.com/learn-sql/postgresql/how-to-use-lateral-joins-in-postgresql#data-set)ã€‚

**ä¸¾ä¾‹:**

ä¸ºäº†ä¸Ž Spotify ä¿æŒä¸€è‡´ï¼Œå‡è®¾æˆ‘ä»¬å¸Œæœ›æ‰¾åˆ° Spotify å‰ 10 åè‰ºæœ¯å®¶çš„å‰ 5 é¦–æ­Œæ›²ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥:

1.  æŸ¥æ‰¾å‰ 10 åè‰ºæœ¯å®¶
2.  å¯¹äºŽæ¯ä½è‰ºæœ¯å®¶ï¼Œä½¿ç”¨æ¨ªå‘è¿žæŽ¥æ‰¾åˆ°ä»–ä»¬çš„å‰ 5 é¦–æ›²ç›®:

![](img/26a8d285aa4fc212eaf341ebf0e3dfa8.png)

çœ‹å®Œæ•´åˆ†æž[è¿™é‡Œ](https://count.co/n/W2O2UEyL4Em)ã€‚

![](img/2f87134a8d9fbbd21f15e22fade68e0b.png)

æ”¾å¤§ SQL

ä½ ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªçª—å£å‡½æ•°æ¥åšè¿™ä»¶äº‹ï¼Œè¿™æ°å¥½æ˜¯æœ¬ç³»åˆ—çš„ä¸‹ä¸€ä¸ªä¸»é¢˜ï¼

**â„¹ï¸è­¦å‘Š:**ä¸æ˜¯æ¯ä¸ª SQL æ–¹è¨€éƒ½æœ‰æ¨ªå‘è¿žæŽ¥çš„æ¦‚å¿µã€‚ä¾‹å¦‚ï¼ŒBigQuery é€šè¿‡ UNNEST ä½¿ç”¨éšå¼æ¨ªå‘è¿žæŽ¥ã€‚äº²è‡ªè¯•ç”¨ä¹‹å‰ï¼Œè¯·æ£€æŸ¥æ‚¨çš„å·¥å…·æ–‡æ¡£ï¼

# è¿›ä¸€æ­¥é˜…è¯»

åœ¨ç ”ç©¶ä»Šå¤©çš„å¸–å­æ—¶ï¼Œæˆ‘å‘çŽ°ä»¥ä¸‹é“¾æŽ¥æœ€æœ‰å¸®åŠ©:

*   [PostgreSQL ä¸­å¸¦æœ‰æ¨ªå‘è¿žæŽ¥çš„è¿­ä»£å™¨](https://blog.crunchydata.com/blog/iterators-in-postgresql-with-lateral-joins)
*   [ä»€ä¹ˆ SQLï¼Ÿï¼ï¼Ÿæ¨ªå‘è¿žæŽ¥](https://ddrscott.github.io/blog/2017/what-the-sql-lateral/#enough-nesting-lateral-join-save-me)
*   [ä»€ä¹ˆæ˜¯èŒƒå›´è¿žæŽ¥ï¼Œä¸ºä»€ä¹ˆé€Ÿåº¦è¿™ä¹ˆå¿«ï¼Ÿ](https://www.vertica.com/blog/what-is-a-range-join-and-why-is-it-so-fastba-p223413/)

# ç»“æŸè¯­

æ‰€æœ‰ä½¿ç”¨çš„ä¾‹å­éƒ½æ˜¯åœ¨[count.co](https://count.co)ä¸­æž„å»ºçš„ï¼Œè¿™æ˜¯ä¸ºåˆ†æžå¸ˆæž„å»ºçš„ SQL ç¬”è®°æœ¬ã€‚æ‚¨å¯ä»¥ä¸Žä»¥ä¸‹ç¤ºä¾‹äº’åŠ¨:

  

è¿˜æœ‰è¿™é‡Œ:

  

ç›´åˆ°ä¸‹æ¬¡æˆ‘ä»¬è®¨è®ºçª—å£å‡½æ•°çš„æ—¶å€™ï¼

*æœ‰æˆ‘é”™è¿‡çš„ä¸€äº›åŠ å…¥ SQL çš„æŠ€å·§å—ï¼Ÿè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘*ðŸ‘‡