# ä¸ç†ŠçŒ«çš„ç‹©çŒå¨èƒğŸ¼ğŸ‘Šâ€”â€”MFT åˆ†æå…¬å¸

> åŸæ–‡ï¼š<https://towardsdatascience.com/hunting-threats-with-pandas-mft-analysis-9f96a99ef27a?source=collection_archive---------26----------------------->

## åˆ©ç”¨æ•°æ®åˆ†ææŠ€æœ¯å’Œå·¥å…·æ”¹è¿›äº‹æ•…å“åº”ã€‚

åœ¨æˆ‘çœ‹æ¥ï¼Œçœ‹åˆ°ç½‘ç»œå®‰å…¨çš„å‘å±•æ–¹å‘ç¡®å®ä»¤äººå…´å¥‹ã€‚äº‹ä»¶å“åº”ç”šè‡³å¨èƒè¿½è¸ªè¶Šæ¥è¶Šå¤šåœ°ä¸æµ·é‡ä¿¡æ¯çš„å¤„ç†è”ç³»åœ¨ä¸€èµ·ã€‚æˆ‘è®¤ä¸ºè¿™ä¸€æ–¹é¢æ˜¯ç”±äºå½“å‰è®¾å¤‡å­˜å‚¨å’Œ/æˆ–ç”Ÿæˆçš„é¥æµ‹æ•°æ®é‡ï¼Œå¦ä¸€æ–¹é¢æ˜¯ç”±äºè¶Šæ¥è¶Šå¤šçš„äº‹æ•…ï¼Œå…¶ä¸­è®¸å¤šæ˜¯éå¸¸å¤§çš„äº‹æ•…ï¼Œæ¶‰åŠè®¸å¤šè®¡ç®—æœºï¼Œç”šè‡³ä¸€ä¸ªç»„ç»‡çš„è®¸å¤šç«™ç‚¹ã€‚
è¿™æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬å¿…é¡»åœ¨å¨èƒè¿½è¸ªä¸­æ‰¾åˆ°ç»„ç»‡å†…çš„æ”»å‡»è€…æ—¶ï¼Œæˆ–è€…å½“æˆ‘ä»¬å¿…é¡»åœ¨ DFIR æ¼”ä¹ ä¸­æ‰¾åˆ°æ”»å‡»è€…çš„è¸ªè¿¹æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»å¤„ç†è¶Šæ¥è¶Šå¤šçš„ä¿¡æ¯ï¼Œæ¥è‡ªå¤šä¸ªæ¥æºã€å…·æœ‰ä¸åŒæ ¼å¼çš„æ•°ç™¾ä¸‡ä¸ªäº‹ä»¶â€¦â€¦è¿™ç®€ç›´æ˜¯ä¸€åœºå™©æ¢¦ã€‚

æˆ‘ä¸€ç›´è®¤ä¸ºï¼Œç¼–ç¨‹æ˜¯ä»»ä½•ç½‘ç»œå®‰å…¨åˆ†æå¸ˆçš„åŸºæœ¬æŠ€èƒ½ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰æœ€èµ·ç çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬æ³¨å®šè¦ä¸€ç›´ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œè€Œè¿™äº›å·¥å…·å¹¶ä¸æ€»æ˜¯ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œèƒ½å¤Ÿåˆ›å»ºè‡ªåŠ¨åŒ–æ•°æ®å¤„ç†çš„å°è„šæœ¬æˆ–ç¨‹åºå°†ä¼šæœ‰å¾ˆå¤§çš„ä¸åŒã€‚

# èŸ’è›‡å’Œç†ŠçŒ«æ¥æ•‘æ´äº†ï¼

![](img/03c5a133f34c1874ebbb0cafad8373f1.png)

ç…§ç‰‡ç”±[åŸƒé‡Œå…‹Â·éº¦å…‹æ—](https://www.pexels.com/@introspectivedsgn?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels)ä»[æ´¾å…‹æ–¯](https://www.pexels.com/photo/man-in-black-and-white-panda-costume-standing-on-payphone-booth-during-night-time-4065800/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels)æ‹æ‘„

è™½ç„¶ Python æœ‰èƒ½åŠ›è®©ä½¿ç”¨å®ƒçš„ç¨‹åºå‘˜æ„Ÿåˆ°æƒŠè®¶ï¼Œä½† Pandas å´è®©æˆ‘å¤§åƒä¸€æƒŠï¼Pandas æ˜¯ä¸€ä¸ªæ•°æ®åˆ†æå’Œæ“ä½œå·¥å…·ï¼Œæ­£å¦‚å®ƒçš„åˆ›é€ è€…æ‰€å®šä¹‰çš„é‚£æ ·ï¼Œå®ƒå¿«é€Ÿã€å¼ºå¤§ã€çµæ´»â€¦â€¦å®ƒä»¬æœ‰æ‰€ä¸è¶³ï¼Œä»¤äººéœ‡æƒŠã€‚ğŸ˜è™½ç„¶å®ƒä»¬æ˜¯ç‹¬ç«‹çš„é¡¹ç›®ï¼Œä½†å¼ºçƒˆå»ºè®®ä½¿ç”¨ JupyterLab ä¸ç†ŠçŒ«â€œç©è€â€,å®ƒè¢«æ¨èç”¨äºä»»ä½•äº‹æƒ…ï¼Œå¦‚æœä½ ä»æœªä½¿ç”¨è¿‡å®ƒï¼Œå½“ä½ ä½¿ç”¨å®ƒæ—¶ï¼Œä½ ä¼šåæ‚”ä»¥å‰æ²¡æœ‰è¿™æ ·åšã€‚æˆ‘æ¨èä½ å®‰è£… AnacondağŸè¦ä½¿ç”¨ JupyterLabï¼Œè¿™ä¸ä¼šè®©æˆ‘ä»¬çš„è®¡ç®—æœºå……æ»¡æˆ‘ä»¬ä¸éœ€è¦çš„ Python åº“ï¼Œä½ å¿…é¡»æœ‰æ¡ç†ï¼ğŸ˜„é¦–å…ˆï¼Œä¸€æ—¦å®‰è£…äº† Anacondaï¼Œæˆ‘ä»¬å°†é€šè¿‡åœ¨ Anaconda æ§åˆ¶å°ä¸­è¿è¡Œè¿™ä¸ªå‘½ä»¤æ¥å¯åŠ¨ JupyterLabã€‚

```
C:>jupyter notebook
```

ä¸€æ—¦è¿›å…¥ Jupyter ç•Œé¢ï¼Œä½ å°±å¯ä»¥ç”¨ Pyhton 3 åˆ›å»ºä¸€ä¸ªæ–°çš„ç¬”è®°æœ¬å¹¶å¼€å§‹æ¸¸æˆã€‚

# MFT åˆ†æğŸ“‚

è™½ç„¶æˆ‘çš„æ„å›¾æ˜¯å‘è¡¨å‡ ç¯‡å¸–å­æ¥è®¨è®ºåœ¨åˆ†æå¸ˆçš„æ—¥å¸¸å·¥ä½œä¸­ä½¿ç”¨ Pandas çš„æ–¹æ³•ï¼Œä½†åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•ä½¿ç”¨ Pandas å’Œ Python æ¥å¤„ç† MFT(ä¸»æ–‡ä»¶è¡¨)ã€‚
é¦–å…ˆï¼Œåœ¨è®¸å¤šå®‰å…¨äº‹ä»¶ä¸­ï¼ŒMFT æ˜¯éå¸¸å®è´µçš„èµ„äº§ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼ŒNTFS æ–‡ä»¶ç³»ç»Ÿåœ¨å…¶ä¸­è·Ÿè¸ªå­˜å‚¨å·ä¸Šåˆ›å»ºçš„æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•ã€‚éœ€è¦æŸ¥çœ‹è¯¥æ—¥å¿—çš„æƒ…å†µä¸èƒœæšä¸¾ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„å—å®³è€…é­å—äº†å‹’ç´¢è½¯ä»¶çš„ä¾µå®³ã€‚
MFT ä¸æ˜¯ä¸€ç§èˆ’é€‚çš„å·¥ä½œæ ¼å¼ï¼Œä¸ºäº†è®©æˆ‘ä»¬æ›´å®¹æ˜“ï¼Œæˆ‘å°†ä½¿ç”¨ [Eric Zimmerman çš„ MFTECmd](https://ericzimmerman.github.io/#!index.md) å·¥å…·ã€‚ğŸ”
å¦‚æœ MFT ä¸æ˜¯å¾ˆå¤§ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ MS Excel è¿›è¡Œåˆ†æï¼Œä½†å¾ˆå¤šæ—¶å€™æ–‡ä»¶å¤ªå¤§ï¼Œæˆ‘ä»¬éœ€è¦æ›´é€šç”¨çš„å·¥å…·ã€‚

æœ€åˆï¼Œå¿…é¡»å£°æ˜ä¸€äº›å˜é‡å¹¶è¿è¡Œ MFETCmd å·¥å…·ã€‚

```
**import** **os**
**from** **subprocess** **import** check_output
mft_path = "**\"**C:**\\**kape**\\**collected**\\**2021-06-01T151604**\\**C**\\**$MFT**\"**"
mftexplorer_path = "**\"**C:**\\**MFTExplorer**\\**MFTECmd.exe**\"**"
output_folder = "C:**\\**Documents**\\**test"
output_filename = "MyOutputFile.csv"command = "**{0}** -f **{1}** --csv **\"{2}\"** --csvf **\"{3}\"**".format(mftexplorer_path, mft_path, output_folder, output_filename)
print(command)
output = os.popen(command).read()
```

è¿™ä¸ªæ‰§è¡Œçš„ç»“æœå°†æ˜¯ set æ–‡ä»¶å¤¹ä¸­çš„ä¸€ä¸ª CSV æ–‡ä»¶ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦ç”¨æ¥å–‚å…»ç†ŠçŒ«çš„æ–‡ä»¶ã€‚ğŸ¼

```
**import** **pandas** **as** **pd** 
pd.set_option('display.max_columns', 500)

data = pd.read_csv(output_folder + "**\\**" + output_filename)
```

æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªåŒ…å«æ¥è‡ª MFT çš„æ‰€æœ‰ä¿¡æ¯çš„æ•°æ®æ¡†æ¶ã€‚ä¸ºäº†ç»§ç»­èˆ’é€‚åœ°å¤„ç†æ•°æ®ï¼Œå»ºè®®è°ƒæ•´åŒ…å«æ—¥æœŸçš„å­—æ®µçš„ç±»å‹ã€‚

```
data.set_index("EntryNumber", inplace=**True**)
data['Created0x10'] =  pd.to_datetime(data['Created0x10'], format='%Y-%m-**%d** %H:%M:%S.**%f**')
data['Created0x30'] =  pd.to_datetime(data['Created0x30'], format='%Y-%m-**%d** %H:%M:%S.**%f**')
data['LastModified0x10'] =  pd.to_datetime(data['LastModified0x10'], format='%Y-%m-**%d** %H:%M:%S.**%f**')
data['LastModified0x30'] =  pd.to_datetime(data['LastModified0x30'], format='%Y-%m-**%d** %H:%M:%S.**%f**')
data['LastRecordChange0x10'] =  pd.to_datetime(data['LastRecordChange0x10'], format='%Y-%m-**%d** %H:%M:%S.**%f**')
data['LastRecordChange0x30'] =  pd.to_datetime(data['LastRecordChange0x30'], format='%Y-%m-**%d** %H:%M:%S.**%f**')
```

æ•°æ®ç°åœ¨å·²å‡†å¤‡å¥½ä¾›æŸ¥è¯¢ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸ª MFT å±äºé­å—å‹’ç´¢è½¯ä»¶æ”»å‡»çš„è®¡ç®—æœºï¼Œæ›´å…·ä½“åœ°è¯´æ˜¯ Avaddonã€‚
å‡è®¾æˆ‘ä»¬ä¸çŸ¥é“å‹’ç´¢è½¯ä»¶æ˜¯ä½•æ—¶æ‰§è¡Œçš„ï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³çŸ¥é“å®ƒä»¥ä¾¿æ‰§è¡Œè°ƒæŸ¥ã€‚
é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹åœ¨ MFT ä¸­å“ªä¸€å¤©å¯¹æ–‡ä»¶è¿›è¡Œäº†æ›´å¤šçš„æ›´æ”¹ã€‚

```
dates = data["LastRecordChange0x10"]
dates.index = dates.dt.to_period('d')
s = dates.groupby(level=0).size()
s.sort_values(ascending=**False**).head(10)
```

![](img/817e15bb8f78f940f6f2b1ea880e21bc.png)

MFT å‘ç”Ÿæ›´å¤šå˜åŒ–çš„æ—¥å­

åœ¨ä¸Šå›¾ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¦‚ä½•é€šè¿‡å‡ ä¸ªå‘½ä»¤æå–æ–‡ä»¶çš„ä¿®æ”¹æ—¥æœŸï¼Œåœ¨å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„åï¼Œæˆ‘ä»¬é¦–å…ˆè·å¾—æ“ä½œç³»ç»Ÿçš„å®‰è£…æ—¥æœŸï¼Œç„¶åè·å¾—æ”»å‡»çš„æ—¥æœŸã€‚
å¦‚æœæˆ‘ä»¬å¸Œæœ›ä»¥æ›´ç›´è§‚çš„æ–¹å¼æŸ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”Ÿæˆä¸€ä¸ªå›¾è¡¨ï¼Œæ˜¾ç¤ºè¿‡å»ä¸¤ä¸ªæœˆæ‰€åšçš„æ›´æ”¹ã€‚

![](img/c6782ab30d3564e53a1ee82471b87269.png)

MFT æ¯æ—¥ç›´æ–¹å›¾å˜åŒ–

æˆ‘ä»¬å¯ä»¥åšçš„å¦ä¸€ä¸ªæµ‹è¯•æ˜¯å¯»æ‰¾è¿‡å» 4 ä¸ªæœˆ MFT ä¸­é‡å¤æ¬¡æ•°æœ€å¤šçš„æ–‡ä»¶ï¼Œç›®çš„æ˜¯å‘ç°å¼‚å¸¸ã€‚

```
fig = px.bar(names_plot, x="FileName", "title=Files with more entries")
Fig.show()
```

![](img/acfe1b5116a8113ac44a9b6b0b3004d9.png)

å…·æœ‰æ›´å¤šæ¡ç›®çš„æ–‡ä»¶

å‹’ç´¢ä¿¡ï¼è¯¥å‹’ç´¢è½¯ä»¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºå‹’ç´¢ç¬”è®°ï¼Œå¹¶ä½¿ç”¨å®ƒåŠ å¯†çš„æ¯ä¸ªæ–‡ä»¶ä¿®æ”¹å®ƒä»¬ã€‚ä¸ºäº†æ›´è¯¦ç»†åœ°æŸ¥çœ‹ä¿¡æ¯ï¼Œæˆ‘ä»¬å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚

```
readme = data[data["FileName"].str.contains("_readme_.txt")]
redme.sort_values(by="LastModified0x10", ascending=True).head()
```

![](img/66e9a55a64a4f61233ec54e1e4659f38.png)

å‹’ç´¢ä¿¡

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéšç€èµé‡‘ç¬”è®°çš„å‡ºç°ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ï¼Œä½†ç°åœ¨æˆ‘ä»¬å°†è¯•å›¾æ‰¾å‡ºè°å¯èƒ½æ˜¯è‚‡äº‹è€…ï¼Œåªæœ‰ MFTã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†å°è¯•æŸ¥è¯¢å‹’ç´¢ç—…æ¯’æ¡ˆä¾‹ä¸­æ”»å‡»è€…ä½¿ç”¨çš„æœ€å¸¸è§æ‰©å±•åçš„æ–‡ä»¶ï¼Œä½†ä»…é™äºåˆ›å»ºç¬¬ä¸€å°å‹’ç´¢ä¿¡ä¹‹å‰çš„ 12 å°æ—¶å†…ã€‚ğŸ”

```
first_note = readme1.sort_values(by="LastModified0x10", ascending=**True**).iloc[0]["LastModified0x10"]
range_exe = first_note + pd.offsets.Hour(-12)
data_filtered = data[(data['Created0x10'] > "2021-05-22") & (data['Created0x10'] < "2021-05-25")]
files = data_filtered[data_filtered["FileName"].str.contains("\.exe|\.ps1|\.msi|\.vba", regex=**True**)]
```

![](img/64f4fdc177494b836ca204f44816a719.png)

èµé‡‘å¯æ‰§è¡Œæ–‡ä»¶

ç°åœ¨æˆ‘ä»¬æœ‰äº†æ–‡ä»¶ï¼Œæˆ‘ä»¬å¿…é¡»æ‰¾å‡ºå®ƒæ˜¯å¦‚ä½•è¿›å…¥ç”µè„‘çš„ï¼Œä½†è¿™æ˜¯ MFT æ— æ³•å‘Šè¯‰æˆ‘ä»¬çš„äº‹æƒ…ğŸ˜„ã€‚è™½ç„¶æˆ‘ä»¬æ²¡æœ‰æ·±å…¥ç ”ç©¶ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¯¹å¤šä¸ª MFT æ–‡ä»¶è¿›è¡Œåˆ†æï¼ŒæŒ‰åç§°æ¨¡å¼æœç´¢ï¼Œæ¯”è¾ƒåˆ›å»ºå’Œä¿®æ”¹æ—¥æœŸï¼Œæœç´¢å…·æœ‰å¯ç–‘å±æ€§çš„æ–‡ä»¶â€¦â€¦è¿™æ˜¯ä¸€ä¸ªå……æ»¡å¯èƒ½æ€§çš„ä¸–ç•Œã€‚

åœ¨ä»¥åçš„æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä¼šè°ˆåˆ°ä¸€äº›æ›´é«˜çº§çš„æ¡ˆä¾‹ï¼Œåœ¨è¿™äº›æ¡ˆä¾‹ä¸­ï¼ŒPandas å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œè°ƒæŸ¥ï¼Œä¾‹å¦‚åˆ†æåƒå…†å­—èŠ‚çš„é˜²ç«å¢™æ—¥å¿—æˆ–åˆ†æ Windows äº‹ä»¶ã€‚æˆ‘å¸Œæœ›ä½ å–œæ¬¢å®ƒï¼Œå¹¶é¼“åŠ±ä½ æŠŠç†ŠçŒ«å’Œæœ±åº‡ç‰¹åˆ—å…¥ä½ çš„ç‹©çŒå·¥å…·åº“ã€‚

ä½ å¯ä»¥åœ¨[è¿™ä¸ªé“¾æ¥](https://github.com/lucky-luk3/Infosec_Notebooks/blob/main/MFT_analysis_public_v0.2.ipynb)æ‰¾åˆ°è¿™ä¸ªç¬”è®°æœ¬ï¼Œå¥½å¥½äº«å—å§ï¼

ä¸‹é›†å†è§ï¼Œç¥ç‹©çŒæ„‰å¿«ï¼