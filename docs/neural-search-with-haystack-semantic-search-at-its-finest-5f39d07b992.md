# Haystack ç¥ç»æœç´¢â€”â€”è¯­ä¹‰æœç´¢çš„æè‡´

> åŸæ–‡ï¼š<https://towardsdatascience.com/neural-search-with-haystack-semantic-search-at-its-finest-5f39d07b992?source=collection_archive---------14----------------------->

## ä¸€ä¸ªå¿«é€Ÿç®€å•çš„æŒ‡å—ï¼Œç”¨å˜å½¢é‡‘åˆšå’Œæœ€å°‘çš„è®¾ç½®å»ºç«‹ä½ è‡ªå·±çš„æœç´¢å¼•æ“

![](img/667c1a63659a3d465a4e175b45c5653d.png)

å¢å¡Â·èƒ¡ç‰¹åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šçš„ç…§ç‰‡

è¯­ä¹‰æœç´¢åœ¨æˆ‘ä»¬çš„æ—¥å¸¸ç”Ÿæ´»ä¸­ç›¸å½“å¸¸è§ï¼Œå°¤å…¶æ˜¯æˆ‘ä»¬ä½¿ç”¨è°·æ­Œä½œä¸ºå¤§å¤šæ•°é—®é¢˜(å¦‚æœä¸æ˜¯æ‰€æœ‰é—®é¢˜)ç­”æ¡ˆçš„åª’ä»‹çš„æ¬¡æ•°ã€‚ç›´åˆ°å‡ å¹´å‰ï¼Œåœ¨æ²¡æœ‰å¤§é‡è®¡ç®—èµ„æºçš„æƒ…å†µä¸‹æ„å»ºä¸€ä¸ªç›¸å½“ä¸é”™çš„æœç´¢å¼•æ“è¿˜æ˜¯ä¸€ä»¶ç—›è‹¦çš„äº‹æƒ…ã€‚ç®€è€Œè¨€ä¹‹ï¼Œè¿™å¤ªéš¾äº†ï¼Œéœ€è¦å¤§é‡çš„é«˜çº§ NLP æ¦‚å¿µçš„ä¸“ä¸šçŸ¥è¯†ã€‚

> BERT transformer æ¨¡å‹åŠå…¶åç»§è€…çš„å‡ºç°æ”¹å˜äº†è¿™ä¸€ç‚¹ã€‚è™½ç„¶æˆ‘ä»¬ä»ç„¶éœ€è¦ä¸€ä¸ªå¥½çš„ GPU æ¥å¾®è°ƒè¿™äº›æ¨¡å‹ï¼Œä½†ä¸€äº›ä»¤äººæ•¬ç•çš„åº“ï¼Œå¦‚ [Haystack](https://haystack.deepset.ai/) ç°åœ¨å·²ç»å¯ä»¥éå¸¸å®¹æ˜“åœ°å›´ç»•æˆ‘ä»¬é€‰æ‹©çš„æ•°æ®é›†æ„å»ºç”Ÿäº§å°±ç»ªçš„åº”ç”¨ç¨‹åºã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å±•ç¤ºå¦‚ä½•ä»å…¬å¼€å¯ç”¨çš„æ•°æ®é›†(ä¾‹å¦‚ Kaggle)ä¸­å¿«é€Ÿæ„å»ºè‡ªå·±çš„å®šåˆ¶æœç´¢å¼•æ“ã€‚

æˆ‘ä»¬å¼€å§‹å§ï¼ğŸ‘‡

## ä½†é¦–å…ˆï¼Œå¹²è‰å †åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

> ç®€è€Œè¨€ä¹‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªéå¸¸æ£’çš„åº“ï¼Œå¯ä»¥ç”¨æ¥æ„å»ºç”Ÿäº§å°±ç»ªçš„ã€å¯ä¼¸ç¼©çš„æœç´¢ç³»ç»Ÿå’Œé—®é¢˜å›ç­”ç³»ç»Ÿã€‚

å®ƒåˆ©ç”¨äº†æœ€æ–°çš„ transformer æ¨¡å‹ï¼Œå› æ­¤å¯¹ç ”ç©¶äººå‘˜å’Œå¼€å‘äººå‘˜æ¥è¯´éƒ½æ˜¯æœ€å¥½çš„ NLP å·¥å…·åŒ…ä¹‹ä¸€ã€‚

å®ƒæä¾›äº†ç”¨äºæ„å»ºæ­¤ç±»ç³»ç»Ÿçš„ä¸åŒç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶éå¸¸æ˜“äºå­¦ä¹ å’Œå®éªŒã€‚æˆ‘å°†åœ¨æœ¬æ–‡ä¸­è®¨è®ºå…¶ä¸­ä¸€äº›ï¼Œå¸Œæœ›èƒ½ç»™ä½ ä¸€ä¸ªå¥½çš„èµ·ç‚¹ï¼

## è·å–æ•°æ®é›†

æˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ª Kaggle çš„æ•°æ®é›†çš„å­é›†[ã€‚å®ƒåŒ…å«å¤§çº¦ 170 ä¸‡ç¯‡æ¥è‡ª STEM çš„ arxiv ç ”ç©¶è®ºæ–‡ï¼Œæ¯ç¯‡è®ºæ–‡éƒ½æœ‰ä¸åŒçš„ç‰¹å¾ï¼Œå¦‚æ‘˜è¦ã€ä½œè€…ã€å‘è¡¨æ—¥æœŸã€æ ‡é¢˜ç­‰ã€‚å®ƒæ˜¯ json æ ¼å¼çš„ï¼Œæˆ‘ç¼–è¯‘äº†ä¸€ä¸ªæ›´å°çš„ç‰ˆæœ¬ã€‚](https://www.kaggle.com/Cornell-University/arxiv)

> åœ¨æˆ‘çš„ GitHub repo ä¸Šçš„è¿™é‡Œæœ‰æ›´å°çš„ç‰ˆæœ¬ã€‚ç»§ç»­å°† **arxiv_short.csv** ä¸‹è½½åˆ°æ‚¨çš„æœºå™¨ä¸Šã€‚

ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ç¡®ä¿åªä¿ç•™ 50ï¼Œ000 ä¸ªæ–‡æ¡£å’Œä¸‰åˆ—:

*   **ä½œè€…** â€”è®ºæ–‡çš„ä½œè€…
*   **æ‘˜è¦** â€”è®ºæ–‡æ‘˜è¦
*   **æ ‡é¢˜** â€”è®ºæ–‡æ ‡é¢˜

å’Œç†ŠçŒ«ä¸€èµ·è¯»:

```
import pandas as pddf = pd.read_csv('arxiv_short.csv')
df.head()
```

æˆ‘ä»¬æ¥çœ‹çœ‹æ•°æ®:

![](img/e23aeb5be65093d93f572066f139c8da.png)

arxiv æ•°æ®é›†æ ‡é¢˜è¡Œ

æˆ‘ä»¬ç°åœ¨å‡†å¤‡è®¾ç½®æˆ‘ä»¬çš„ haystack å¼•æ“ã€‚

## å®‰è£…å¹²è‰å †

è¿™ä¸€æ­¥åªéœ€è¦ä¸¤è¡Œä»£ç ã€‚é¦–å…ˆç¡®ä¿ä½ å¤„äºè™šæ‹Ÿç¯å¢ƒä¸­ã€‚

```
pip install git+https://github.com/deepset-ai/haystack.gitpip install sentence-transformers
```

> æˆ‘ä»¬å°†ä½¿ç”¨ haystack æ„å»ºå®é™…çš„æœç´¢å¼•æ“ï¼Œå¹¶ä½¿ç”¨å¥å­è½¬æ¢å™¨ä»æˆ‘ä»¬çš„ ***æ‘˜è¦*** æ–‡æœ¬åˆ—åˆ›å»ºå¥å­åµŒå…¥ï¼Œæˆ‘ä»¬çš„æœç´¢å¼•æ“å°†åŸºäºè¯¥æ–‡æœ¬åˆ—ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç»§ç»­ä¸ºæˆ‘ä»¬çš„ haystack æœç´¢å¼•æ“æ„å»ºä¸åŒçš„ç»„ä»¶ï¼

## åˆå§‹åŒ–æ–‡æ¡£å­˜å‚¨å’Œæ£€ç´¢å™¨

> ä¸€ä¸ª**æ–‡æ¡£å­˜å‚¨åº“**å­˜å‚¨æˆ‘ä»¬çš„å¯æœç´¢æ–‡æœ¬åŠå…¶å…ƒæ•°æ®ã€‚

ä¾‹å¦‚ï¼Œè¿™é‡Œæˆ‘ä»¬çš„æ–‡æœ¬å°†æ˜¯æ¥è‡ªæ•°æ®é›†çš„**æŠ½è±¡**åˆ—ï¼Œå…¶ä½™ä¸¤åˆ—â€” **æ ‡é¢˜**å’Œ**ä½œè€…** â€”å°†ç”±æˆ‘ä»¬çš„å…ƒæ•°æ®ç»„æˆã€‚

åˆå§‹åŒ–å’Œæ„å»ºç›¸å½“ç®€å•:

```
document_store_faiss = FAISSDocumentStore(faiss_index_factory_str="Flat", return_embedding=True)
```

[FAISS](https://github.com/facebookresearch/faiss) æ˜¯ä¸€ä¸ªç”¨äºé«˜æ•ˆç›¸ä¼¼æ€§æœç´¢å’Œå¯†é›†å‘é‡èšç±»çš„åº“ï¼Œå› ä¸ºå®ƒä¸éœ€è¦é¢å¤–çš„è®¾ç½®ï¼Œæ‰€ä»¥æˆ‘æ›´å–œæ¬¢åœ¨è¿™é‡Œä½¿ç”¨å®ƒè€Œä¸æ˜¯ Elasticsearchã€‚

ç°åœ¨çŒçŠ¬æ¥äº†ã€‚

> ä¸€ä¸ª**æ£€ç´¢å™¨**æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå®ƒå¯ä»¥å¿«é€Ÿéå†æ•´ä¸ªæ–‡æ¡£åº“ï¼Œå¹¶æ ¹æ®å¯¹ç»™å®šæŸ¥è¯¢ç›¸ä¼¼æ€§æœç´¢ï¼Œä»ä¸­æ‰¾å‡ºä¸€ç»„å€™é€‰æ–‡æ¡£ã€‚

> å…¶æ ¸å¿ƒæ˜¯ï¼Œæˆ‘ä»¬æ­£åœ¨æ„å»ºä¸€ä¸ªè¯­ä¹‰æœç´¢ç³»ç»Ÿï¼Œå› æ­¤ä»æŸ¥è¯¢ä¸­è·å–ç›¸å…³æ–‡æ¡£æ˜¯æˆ‘ä»¬é¡¹ç›®çš„æ ¸å¿ƒã€‚

åˆå§‹åŒ–ä¸€ä¸ªæ£€ç´¢å™¨ä¹Ÿå¾ˆç®€å•:

```
retriever_faiss = EmbeddingRetriever(document_store_faiss, embedding_model='distilroberta-base-msmarco-v2',model_format='sentence_transformers')
```

åœ¨è¿™é‡Œï¼Œ**distilloberta**ä»…ä»…æ˜¯ä¸€ä¸ª transformer æ¨¡å‹ BERT æ¨¡å‹çš„å˜ä½“â€”â€”æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨å®ƒæ¥ä¸ºæˆ‘ä»¬çš„æ–‡æœ¬è¿›è¡ŒåµŒå…¥ã€‚å®ƒä½œä¸º**å¥å­å˜å½¢é‡‘åˆš**å¥—è£…çš„ä¸€éƒ¨åˆ†æä¾›ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬æƒ³å°†æ–‡æ¡£å†™å…¥æˆ‘ä»¬çš„æ–‡æ¡£å­˜å‚¨ã€‚

## æ„å»ºæ–‡æ¡£å­˜å‚¨

æˆ‘ä»¬åªéœ€å°†æ•°æ®å¸§çš„åˆ—ä¼ é€’ç»™æ–‡æ¡£å­˜å‚¨ã€‚

```
document_store_faiss.delete_all_documents() # a precaution document_store_faiss.write_documents(df[['authors', 'title', 'abstract']].rename(columns={ 'title':'name','author' : 'author','abstract':'text'}).to_dict(orient='records'))
```

è¿™é‡Œéœ€è¦è¿›è¡Œä¸€ç‚¹é‡å‘½åï¼Œå› ä¸º haystack å¸Œæœ›æˆ‘ä»¬çš„æ–‡æ¡£ä»¥è¿™ç§æ ¼å¼ç¼–å†™:

```
{ 'text': DOCUMENT_TEXT, 'meta': {'name': DOCUMENT_NAME, ...}     }, ... and so on.
```

æœ€åï¼Œåœ¨æ„å»ºå®Œæˆåï¼Œæˆ‘ä»¬å°†æ–‡æ¡£å­˜å‚¨æä¾›ç»™æˆ‘ä»¬çš„æ£€ç´¢å™¨ã€‚

```
document_store_faiss.update_embeddings(retriever=retriever_faiss)
```

> æ•°æ®é›†è¶Šå¤§ï¼Œè¿™ä¸¤ä¸ªæ­¥éª¤éœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ã€‚

æˆ‘ä»¬å¿«å®Œæˆäº†ï¼å‰©ä¸‹å”¯ä¸€è¦åšçš„å°±æ˜¯åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥æ£€ç´¢ä¸æŸ¥è¯¢åŒ¹é…çš„æ–‡æ¡£ï¼

## æ€»ç»“â€”â€”è·å–ç»“æœå¹¶å°è¯•

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„å‡½æ•°æ¥ä»æˆ‘ä»¬çš„æ•°æ®ä¸­è·å– 10 ä¸ªç›¸å…³çš„æ–‡æ¡£(ç ”ç©¶è®ºæ–‡æ‘˜è¦)ã€‚

```
def get_results(query, retriever, n_res = 10): return [(item.text, item.to_dict()['meta']) for item in    retriever.retrieve(q, top_k = n_res)]
```

æœ€åæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼

```
query = 'Poisson Dirichlet distribution with two-parameters' print('Results: ')res = get_results(query, retriever_faiss)for r in res:
    print(r)
```

æ‚¨å¯ä»¥çœ‹åˆ°è¿™æ ·çš„ç»“æœ:

![](img/02ab532a29d67d7bdae1a7481188c7d3.png)

æœç´¢ç»“æœ

è¿™å°±æ˜¯ä½ è¦çš„â€”â€”ä¸€ä¸ªå»ºç«‹åœ¨ä½ é€‰æ‹©çš„æ•°æ®é›†ä¸Šçš„å®šåˆ¶è¯­ä¹‰æœç´¢å¼•æ“ï¼

å»ç©å§ï¼è°ƒæ•´ä¸€äº›å‚æ•°â€”ä¾‹å¦‚ï¼Œå°è¯•æ›´æ”¹æ£€ç´¢å™¨å¯¹è±¡ä¸­çš„è½¬æ¢å™¨æ¨¡å‹ã€‚

å®Œæ•´çš„ä»£ç ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œçš„ç¬”è®°æœ¬ä¸Šæ‰¾åˆ°:

[](https://github.com/yashprakash13/haystack-search-engine) [## yashprakash 13/haystack-æœç´¢å¼•æ“

### åŸºäº Kaggle çš„ Arxiv æ•°æ®é›†æ„å»ºçš„è¯­ä¹‰æœç´¢å¼•æ“ã€‚-yashprakash 13/haystack-æœç´¢å¼•æ“

github.com](https://github.com/yashprakash13/haystack-search-engine) 

æ„Ÿè°¢é˜…è¯»ï¼:)

> ç‹¬è‡ªå­¦ä¹ æ•°æ®ç§‘å­¦å¯èƒ½ä¼šå¾ˆéš¾ï¼Œ[è·Ÿæˆ‘æ¥](https://medium.com/@ipom)ï¼Œè®©æˆ‘ä»¬ä¸€èµ·è®©å®ƒå˜å¾—æœ‰è¶£ã€‚ä¿è¯ã€‚ğŸ˜

æ­¤å¤–ï¼Œè¿™é‡Œæ˜¯æˆ‘æ‰€æœ‰æ•°æ®ç§‘å­¦æ•…äº‹çš„ä»£ç åº“ã€‚å¿«ä¹å­¦ä¹ ï¼â­ï¸

è¿™æ˜¯æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼Œä½ å¯èƒ½æƒ³è¯»ä¸€è¯»:

[](/deploying-an-ml-model-with-fastapi-a-succinct-guide-69eceda27b21) [## ä½¿ç”¨ FastAPI éƒ¨ç½² ML æ¨¡å‹â€”â€”ç®€æ˜æŒ‡å—

### å¦‚ä½•ä½¿ç”¨ NLP æ¨¡å‹ä½œä¸º APIâ€”â€”æ™ºèƒ½çš„ã€ç”Ÿäº§å°±ç»ªçš„æ–¹å¼ã€‚

towardsdatascience.com](/deploying-an-ml-model-with-fastapi-a-succinct-guide-69eceda27b21)