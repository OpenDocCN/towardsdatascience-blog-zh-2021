# å¤‡ä»½æ‚¨æœ‰ä»·å€¼çš„ BigQuery è§†å›¾å’Œè®¡åˆ’æŸ¥è¯¢

> åŸæ–‡ï¼š<https://towardsdatascience.com/back-up-your-valuable-bigquery-views-and-scheduled-queries-424791b6f2c7?source=collection_archive---------19----------------------->

## ä½ çš„å®è´ SQL ä¹Ÿéœ€è¦ä¸€äº›çˆ±

![](img/5b6937b45082debd36130f8a632a251c.png)

åŸå›¾[å¡è‰Â·è°¢ä¼Š](https://unsplash.com/@karishea)

**è¿›è¡Œæ•°æ®å¤‡ä»½å¾ˆé‡è¦ã€‚ä½†æ˜¯éšè—åœ¨è§†å›¾å’Œé¢„å®šæŸ¥è¯¢ä¸­çš„å®è´µçš„ SQL ä»£ç å‘¢ï¼Ÿæœ¬æ•™ç¨‹å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Python å°†æ‰€æœ‰ SQL ä»£ç å¤‡ä»½åˆ° Git å­˜å‚¨åº“ä¸­ã€‚**

åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè§†å›¾å’Œé¢„å®šæŸ¥è¯¢åŒ…å«äº†æ‰€æœ‰è‰°è‹¦å·¥ä½œ(å’ŒèŠ±è´¹çš„å¤§é‡æ—¶é—´)çš„ç»“æœã€‚å®ƒä»¬åŸºæœ¬ä¸ŠåŒ…å«äº†å¾ˆå¤šæ„å»ºæ¨¡å—ã€‚æƒ³æƒ³æ•°æ®è½¬æ¢ã€ç‰¹å¾å·¥ç¨‹ã€é€‰æ‹©ç”šè‡³æ¨¡å‹æœ¬èº«ã€‚

> ***æ³¨:*** *ä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« å—ï¼Ÿé˜…è¯»* [*åŸæ–‡*](https://stacktonic.com/article/backup-your-valuable-big-query-views-and-scheduled-queries-using-python) *(ä»¥åŠå…¶ä»–è®¸å¤šåŠ¨æ‰‹è¥é”€æŠ€æœ¯ç›¸å…³æ–‡ç« )ä¸Š*[*stacktonic.com*](https://stacktonic.com)*ğŸš€*

*æ­¤å¤–ï¼Œå½“å¾ˆå¤šç”¨æˆ·ç§¯æå‚ä¸è°·æ­Œäº‘å¹³å°(GCP)ç¯å¢ƒçš„å¼€å‘æ—¶ï¼Œå¾ˆéš¾è·Ÿè¸ªè§†å›¾å’Œé¢„å®šæŸ¥è¯¢çš„å˜åŒ–ã€‚*

*æœ¬æ•™ç¨‹ä¸­æä¾›çš„è§£å†³æ–¹æ¡ˆå°†:*

*   ***å¤‡ä»½**æ‚¨çš„ BigQuery **è§†å›¾**å’Œ**è°ƒåº¦æŸ¥è¯¢**åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šçš„`.sql`æ–‡ä»¶ã€‚*
*   *èƒ½å¤Ÿæäº¤å¯¹ä¸€ä¸ª **Git** åº“çš„æ›´æ”¹ã€‚å®šæœŸè¿è¡Œè„šæœ¬æ—¶ï¼Œå¯ä»¥è·Ÿè¸ª**å˜æ›´å†å²**ã€‚*
*   *æ”¯æŒ**å¤šä¸ª** GCP é¡¹ç›®ã€‚*

# *å‡†å¤‡*

*æˆ‘ä»¬å°†ä½¿ç”¨æœåŠ¡å¸æˆ·å¯¹æ‚¨çš„ Google äº‘é¡¹ç›®è¿›è¡Œèº«ä»½éªŒè¯ã€‚*

> **é€šè¿‡å°†æ­¤å…·æœ‰æ­£ç¡®è§’è‰²çš„æœåŠ¡å¸æˆ·æ·»åŠ åˆ°æ‚¨æƒ³è¦å¤‡ä»½çš„æ‰€æœ‰ GCP é¡¹ç›®ï¼Œæ‚¨å¯ä»¥å¯¹æ‰€æœ‰é¡¹ç›®ä½¿ç”¨ç›¸åŒçš„æœåŠ¡å¸æˆ·ã€‚**

*å¦‚æœä½ ä¸ç†Ÿæ‚‰è®¾ç½®æœåŠ¡è´¦æˆ·ï¼Œè¯·å…ˆé˜…è¯»è°·æ­Œæ–‡æ¡£ã€‚*

*   *åˆ›å»ºä¸€ä¸ªæœåŠ¡å¸æˆ·ï¼Œå¹¶ä¸ºè¯¥å¸æˆ·å¯ç”¨`BigQuery User`è§’è‰²ã€‚*
*   *ä¸ºæœåŠ¡å¸æˆ·ç”Ÿæˆå¹¶ä¸‹è½½ JSON å¯†é’¥æ–‡ä»¶ã€‚*
*   *åœ¨æ‚¨çš„ GCP é¡¹ç›®ä¸­å¯ç”¨`Data Transfer API`*

# *è„šæœ¬å¦‚ä½•å·¥ä½œ*

*   *Python è„šæœ¬å°†è·å–è„šæœ¬ä¸­é…ç½®çš„ GCP é¡¹ç›®ä¸­æ‰€æœ‰è§†å›¾å’Œè®¡åˆ’æŸ¥è¯¢çš„ SQL ä»£ç ã€‚*
*   *æ–‡ä»¶è¢«ä¸‹è½½åˆ°æ‚¨çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€‚*
*   *å½“æ‚¨å¯ç”¨`REPO_COMMIT`è®¾ç½®æ—¶ï¼Œè„šæœ¬å°†é¦–å…ˆå…‹éš†ä¸€ä¸ª(è¿œç¨‹)å­˜å‚¨åº“ï¼Œè·å–è§†å›¾å’Œé¢„å®šæŸ¥è¯¢ SQLï¼Œå¹¶å°†æ›´æ”¹æäº¤ç»™å­˜å‚¨åº“ã€‚åœ¨å…‹éš†è¿œç¨‹å­˜å‚¨åº“ä¹‹å‰ï¼Œå®ƒå°†é¦–å…ˆåˆ é™¤æ—§ç‰ˆæœ¬çš„å­˜å‚¨åº“*

> **å½“ä½¿ç”¨ Git å­˜å‚¨åº“å¤‡ä»½ SQL å’Œè·Ÿè¸ªå˜æ›´å†å²æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ SSH å¯†é’¥è¿›è¡Œè®¤è¯ã€‚å‚è§* [*GitHub*](https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account) *æˆ–*[*bit bucket*](https://support.atlassian.com/bitbucket-cloud/docs/set-up-an-ssh-key/)çš„è¯´æ˜*

***æ–‡ä»¶ç»“æ„***

*è¯¥è„šæœ¬å°†æ ¹æ®ä»¥ä¸‹æ–‡ä»¶å¤¹/æ–‡ä»¶ç»“æ„åˆ›å»ºå’Œå¡«å……:*

*![](img/1c954270f790959df694358e52e41061.png)**![](img/1530db392ad15cb260808e587ba98ee2.png)*

# *å®‰è£…å’Œè¿è¡Œä»£ç *

***å®‰è£…åŒ…***

*è¯¥è„šæœ¬éœ€è¦ä¸€äº›ä¾èµ–é¡¹ã€‚ä½¿ç”¨`pip`æ¥å®‰è£…è¿™äº›åŒ…:*

```
*pip install google-auth
pip install google-cloud-bigquery
pip install GitPython*
```

*æœ€åä¸€æ­¥æ˜¯è°ƒæ•´è„šæœ¬ä¸­çš„è®¾ç½®:*

*![](img/1e876cf1f40bfab278262dd5c1986e41.png)*

*ç°åœ¨ï¼Œæ‚¨å·²ç»å‡†å¤‡å¥½è¿è¡Œä»£ç äº†:*

```
*python backup_views_scheduled_queries.py*
```

# *Python è„šæœ¬*

*æ‰‹åŠ¨å°†ä»£ç ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ–è€…ç›´æ¥ä»æˆ‘ä»¬çš„ GitHub åº“ä¸‹è½½ä»£ç [ã€‚](https://gist.github.com/krisjan-oldekamp/78869851421af2f75325c32302fa2137)*

***backup _ views _ scheduled _ query . py***

# *ä¸€äº›æœ€åçš„æç¤º*

*   *æ‚¨å¯èƒ½å¸Œæœ›æ¯å¤©å®‰æ’è¿™ä¸ªè„šæœ¬ã€‚ä½ å¯ä»¥ä½¿ç”¨ä½ æœ€å–œæ¬¢çš„è°ƒåº¦å·¥å…·ï¼Œæ¯”å¦‚ Apache Airflow æˆ–è€… good ol' cronjobsã€‚*
*   *åœ¨ windows ä¸Šï¼Œé…ç½® SSH å¯†é’¥å¯èƒ½ä¼šç»™æ‚¨å¸¦æ¥ä¸€äº›éº»çƒ¦ã€‚å‚è§ [GitHub](https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent) å’Œ [Bitbucket](https://support.atlassian.com/bitbucket-cloud/docs/troubleshoot-ssh-issues/) æ–‡æ¡£è¿›è¡Œæ•…éšœæ’é™¤ã€‚*