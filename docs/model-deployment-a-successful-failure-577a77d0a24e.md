# 部署失败:成功的故事

> 原文：<https://towardsdatascience.com/model-deployment-a-successful-failure-577a77d0a24e?source=collection_archive---------36----------------------->

## 我如何使用 Dash、Plotly 和 Heroku 部署我的第一个萨里玛新冠肺炎预测模型。

![](img/f72a608d5ccb365cdb041c155a560a5c.png)

[胡伊森](https://unsplash.com/@ethanhjy?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

我**没有**使用 statsmodels 库部署了一个预测未来新冠肺炎感染率和死亡率的 SARIMA 时间序列模型。使用 Plotly 创建当前和预测的病例和死亡率的交互式图表，允许用户决定包括哪些统计数据，预测哪些国家或州，以及预测多远，我没有制作一个公众可访问的交互式预测网站。我努力工作，并在没有将这个模型部署到 Heroku 服务器上的过程中学到了很多。

下面是我的故事。

在本演练中，您将学习向 Heroku 部署一个不进行机器学习预测的网站。您将学习如何开始:

1.  一个用于 Python 的交互式图形库
2.  [Dash 开源](https://dash.plotly.com/)，一个 web 部署库，它可以很好地将您的自定义 Plotly 图形放到 web 上，供您的用户进行交互。
3.  Heroku 免费版，一个有好处…也有限制的虚拟主机服务。
4.  不太了解时间序列建模。我把这个留到以后再讲。

# 背景

我是一名初露头角的数据科学家，已经学到了很多关于数据和建模的知识，但是我想用一种方式向世界展示我能做什么，也许还能制造一些对其他人有用的工具。 [Jupyter 笔记本](https://jupyter.org/)非常适合与其他数据科学家交流，并展示您的发现的有效性和可重复性。但是，它们并不是与所有人分享你的作品的合适工具。我们必须部署！

从 Flatiron 数据科学集训营毕业后，我被邀请加入一个团队，参加 X-Prize [新冠肺炎疫情反应竞赛](https://www.xprize.org/challenge/pandemicresponse)。稍后我会写下这段旅程的故事，但简短的是，我知道一些关于时间序列预测的基础知识，并决定加入团队以了解更多。我最成功的模型是一个 [SARIMA 模型](https://machinelearningmastery.com/sarima-for-time-series-forecasting-in-python/)，它可以以 99%的准确率，只访问到 11 月的数据，预测美国 12 月份感染率的变化(我的验证数据)。

我还试用了[脸书先知](https://facebook.github.io/prophet/)时间序列预测库。虽然它没有给我最好的结果，但我确实了解了他们的库和 Plotly 之间的集成。使用 Plotly，我能够制作我的第一个交互式图表来探索预测和趋势。

我花时间学习了更多关于 Plotly 的知识，并继续使用这个有趣而简单的库来学习如何让交互式的情节变得精彩。我熟悉 matplotlib，Plotly 有很多相同的功能，还有交互和动画选项。新的数据科学超能力！

当我使用 Plotly 的文档不断学习新技能时，该网站不断向我推送他们的 Dash Enterprise deployment 库。他们希望我为我的企业购买软件包和综合开发环境。嗯，我还没有一个企业，只有一种进取精神。我知道我想学习如何部署我的模型，使用 Dash 的免费版本部署一个新冠肺炎预测器似乎是一个不错的起点。我最终没有部署我的模型，但不是因为 Dash。机器学习 web 部署我绝对推荐 Dash！

我以前的编码经验主要集中在 Jupyter 笔记本和支持它们的定制库上。Dash 是为部署到 web 服务器而设计的，并且使用了一些对我来说是新的工具，比如函数包装器和回调。

我知道许多新数据科学家很想了解如何部署他们的工作，所以让我告诉你什么没有……什么**对我有用！**

# **阴谋地**

Plotly 是一个数据可视化库，让您可以轻松地制作交互式图表，以鼓励您的观众探索数据。让一个基本的情节继续下去并不需要太多。请看下面，了解如何下载 COVID 数据，并在交互式绘图中按国家和地区绘制数据:

由作者创建

由作者创建

如果您想查看其他区域的图，请随意更改`country`和`region`变量。但是，请注意，只有美国、加拿大、巴西和英国有按地区划分的数据。

此外，如果您运行上面的代码，花一点时间与图形进行交互。您可以在感兴趣的区域上画一个框来放大，然后双击来缩小。你会注意到死亡和病例的比例非常不同，要查看累计死亡的详细信息，你必须放大很多倍！

# 萨里玛

时间序列预测有细微差别，做出好的预测超出了本文的范围。简而言之，您必须考虑数据中的许多方面和模式，以允许模型使用过去的值来预测未来的值。模型对数据的分布方式很挑剔，为了得到好的预测，通常需要一些转换。如果你想复制我的模型，代码如下。我不会真的解释它，也不会解释我是如何得到这个特殊的超参数的。请关注我关于时间序列预测的下一篇博客，以了解更多的事实。

以下是我的预测模型的代码:

由作者创建

由作者创建

# 破折号

这是在线部署您的模型和分析的关键要素。Dash 在后端使用 [Flask](https://flask.palletsprojects.com/en/1.1.x/) 服务器，使部署变得简单直观。我用你在上面的列表中看到的功能创建了自定义模块，以集成到 Dash 应用程序布局中。Dash 的工作原理是创建一个`Dash()`应用程序对象，该对象包含生成 HTML 布局的方法、自定义函数与布局交互的回调装饰器，以及启动 Flask server 的`.run_server()`方法。在终端中运行代码会创建一个本地服务器，您可以使用浏览器连接到该服务器来预览您的新站点。一旦你理解了装饰者是如何与布局互动的，这真的很容易。

`app = dash.Dash(__name__)`

## 样式表

当`Dash()` app 对象被实例化时，可以给它一个样式表模板来开始。

`app = dash.Dash(__name__, external_stylesheets=URL)`

## 布局

`app.layout`是 app 控制网站布局及其组件的属性。布局控制你的访问者看到什么，它充满了被称为组件的东西。组件可以是文本图像、图形、交互式对象、输入等等。如果你熟悉 HTML，这将对你有所帮助，因为语法是熟悉的。每个组件都有一个`id`，回调使用它来帮助你的函数与它交互。

`app.layout = html.Div([html.H2('Sample'), html.Div(id='first-division'), dcc.Dropdown(id='dropdown-1')]`等。

一件可能不明显的事情是，`html.Div`对象具有`children`属性，这些属性是新组件，出现在所显示的 web 页面中的布局分区下。这就是对返回一个`dcc.Graph()`组件的`display_value()`的回调如何在`html.Div(id='graph')`组件下创建一个新图形。

## 装饰者和复试者

函数装饰器对我来说是新的，一开始我不明白它们是如何工作的，但我想分享一下我所学到的东西:

函数装饰者改变直接在他们下面的函数(没有空格！).

当用户与部署的站点交互时，Dash 使用`@app.callback()`装饰器在布局和函数之间移动值。它们是您的代码与站点访问者看到的和做的事情进行交互的一种方式。

`@app.callback([<dependencies>..])`

`def function()`

## 属国

当您阅读下面的代码时，请注意回调函数中的`dash.dependencies.Input()`和`dash.dependencies.Output()`对象如何通过第一个参数中的`id`和第二个参数中的组件的一部分来引用布局中的组件。正如您可能已经猜到的，`Input()`对象从组件中获取值，`Output`对象改变组件的一部分。

`@app.callback(Output('first-division','children'),[Input('dropdown-1','value')])`

`def function(dropdown_input):`

来自`Input()`对象的值按照它们在回调中出现的顺序被提供给包装器下面的函数，并成为该函数的参数。这是关键。在函数定义中调用什么变量并不重要，它们从`Input()`对象中接收值，顺序与回调方法中出现的顺序相同。

## 指导和清晰度

这是一个关于元素间稍微复杂的交互的简短指南。如需了解更多信息，或者如果我让您感到困惑，请访问 [Dash 开源文档](https://dash.plotly.com/)以了解详情。您也可以看看下面的代码，看看它们是如何组合在一起的。

# 警告！

虽然到目前为止，我在本文中给出的代码可以在 Colab 上运行，非常好的沙箱化，但下面的代码实际上不会让您在 Colab 上获得一个工作服务器，您必须在本地运行它。在你的电脑上运行别人的程序时，一定要非常小心。下面这个是安全的，其他的可能就不安全了。如果您有任何疑问，请仔细检查代码，研究导入的库，和/或咨询您的编码专家朋友。

您可以将代码作为笔记本来运行，或者将其复制到文本文件中并重命名为`app.py`以通过您的终端来运行。请确保您也获得了下面的定制 src 模块的源代码。

由作者创建

这里也是 SRC。你需要两者来让你的服务器工作。将下面的代码复制到一个文本文件中，并将该文件命名为`src.py`。然后把它放到上面 Dash app 文件所在的文件夹里。

好吧！我知道你要说什么。你已经注意到了。这里没有预测器。如果运行此代码，您将设置一个服务器和一个站点，您可以通过浏览器本地连接到该服务器和站点。但是，该网站只允许您探索当前的 COVID 数据图表，而不是像 SARIMA 代码那样的预测案例。我们已经到了我的“失败”了。

# 赫罗库

Heroku 提供一个免费的网站托管服务，让你连接一个正确设置的 git 库来创建你的网站。在您的 repo 中添加一些额外的文件(如下所示)，上面要点中的代码，当部署在 Heroku 上时，将会很好地向世界展示您的新冠肺炎追踪器。不过，你需要在 Heroku 上开一个账户。

要部署上面的文件，你需要将它复制到一个文本文件中，并将文件重命名为`app.py`。然后，您将需要本演练末尾链接的 git repo 中的一些可用文件，requirements.txt、runtime.txt 和 Procfile。requirements.txt 告诉 Heroku 它需要安装什么包，runtime.txt 告诉它你的代码用什么编程语言，Procfile 告诉它如何开始部署你的代码。我不会说得更详细，您可以查看本文末尾的回购协议，了解这些文件需要包含什么。

# 失败！

我想告诉你为什么我不能把我的预测模型部署到 Heroku。Heroku 提供这种免费服务，这很棒，但免费服务器不是最快的，而且 SARIMA 模型需要一些马力来训练。在我写这篇文章的时候，我负担不起完整版的费用。

你可能会认为这将导致永远无法返回图表，但 Heroku 对后端应用程序响应用户请求的时间有 30 秒的硬性限制。免费提供的服务器无法在这段时间内训练模型并做出预测。因此，我们仅限于可爱的交互式 Plotly 图形和用户探索不同国家和地区的当前和历史数据的能力。不过，这还是很酷。

# 未来的成功

我的下一个学习目标是掌握亚马逊网络服务。AWS 目前为大量互联网提供动力，并拥有针对数据分析和机器学习进行优化的强大服务器。我怀疑通过他们的服务，我未来的 ML 部署可能会成功。然而……他们的免费服务是有限的，意外费用也不难产生。我将努力获得 AWS ML 认证，我会回来与大家分享我在未来学到的东西。

其他人找到的其他可能的解决方案是让服务器递增地返回信息。我可以为我的应用程序寻找一种方法来返回*一些东西，*比如“仍在训练”的消息或其他东西，以延长超时前的时间。这是由[阿提什·纽帕内](https://librenepal.com/author/aatish/)提出的，尽管他们指出这只能将超时延长到 55 秒。

另一个解决方案是添加更多的 dyno(Heroku 中的后台处理器)。免费帐号给你 2 个 dynos 在你部署的站点之间分配，所以这是一个很大的要求，基本上使这成为我唯一可以部署的站点。

最后，有人建议我可以根据每天的新数据对模型进行预训练。

[这是我在新冠肺炎部署的数据站点](https://violet-covid-data.herokuapp.com/)的链接。它一开始加载很慢，因为每次加载应用程序都会下载所有最新的新冠肺炎数据。不过，一旦加载，它的反应会很快。Plotly 针对 Dash 和 Pandas 进行了优化，Pandas 针对数据进行了优化。有了这些很棒的库，网站可以很好很快地显示数据。

[这里是完整回购的链接。](https://github.com/Violet-Spiral/covid-data)请克隆好好玩！

让我知道什么适合你！

同时，享受代码。请以此为起点，推出自己的想法。要有创意，打破它，改变它，增加它，并在评论中发表你的见解，奋斗和成功。

真诚地，带着爱，

乔希·约翰逊

# 感谢:

## 特邀明星嘉宾:

蕾拉·龙威:我在这个项目中的合作伙伴，尤其是在网络部署方面。

## 大量数据:

牛津大学和布拉瓦尼克政府学校[冠状病毒政府响应跟踪。](https://www.bsg.ox.ac.uk/research/research-projects/coronavirus-government-response-tracker#data)

## 温和的 SARIMA 模型指导:

杰森·布朗利的[用 Python 温和地介绍了用于时间序列预测的萨里玛](https://machinelearningmastery.com/sarima-for-time-series-forecasting-in-python/)