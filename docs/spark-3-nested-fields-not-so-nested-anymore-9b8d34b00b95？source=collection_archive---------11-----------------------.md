# ç«èŠ± 3ã€‚åµŒå¥—å­—æ®µä¸å†åµŒå¥—

> åŸæ–‡ï¼š<https://towardsdatascience.com/spark-3-nested-fields-not-so-nested-anymore-9b8d34b00b95?source=collection_archive---------11----------------------->

## å…³äºåµŒå¥—å­—æ®µçš„é‡è¦æ›´æ”¹

![](img/51e0c9f6bbf38af3d79a71f156fa9f95.png)

ç…§ç‰‡ç”± [Mrg Simon](https://unsplash.com/@mrsmrg?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) åœ¨ [Unsplash](https://unsplash.com/s/photos/nest?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šæ‹æ‘„

**Spark 3.1.1** å‘å¸ƒå¸¦æ¥äº†å¾ˆå¤šæ–°ä¸œè¥¿ï¼

ä¾‹å¦‚ï¼ŒæŸ¥çœ‹ä¸ºè¿™ä¸ª[ç‰ˆæœ¬](https://issues.apache.org/jira/browse/SPARK-33005)å®Œæˆçš„æ‰€æœ‰ä¸ Kubernetes ç›¸å…³çš„ä»»åŠ¡ã€‚

æ­£å¦‚ä½ å¯èƒ½ä»è¿™ç¯‡æ–‡ç« çš„æ ‡é¢˜ä¸­æƒ³è±¡çš„é‚£æ ·ï¼Œæˆ‘ä»¬ä¸ä¼šè°ˆè®º Kubernetesï¼Œè€Œæ˜¯åµŒå¥—å­—æ®µ*ã€‚*

å¦‚æœæ‚¨ä½¿ç”¨ Spark çš„æ—¶é—´è¶³å¤Ÿé•¿ï¼Œé‚£ä¹ˆæ‚¨è‚¯å®šä¼šåšä¸€äº›ä½¿ç”¨æ·±åº¦åµŒå¥—å­—æ®µçš„å™©æ¢¦ã€‚

è®©æˆ‘ä»¬ä»å¤´å¼€å§‹ã€‚

> ä»€ä¹ˆæ˜¯åµŒå¥—å­—æ®µï¼Ÿ

åµŒå¥—å­—æ®µæ˜¯åŒ…å«å…¶ä»–å­—æ®µæˆ–å¯¹è±¡çš„å­—æ®µã€‚

ä¾‹å¦‚:

![](img/e5299f9f11399aff6b49d10f05443783.png)

> å¦‚ä½•åœ¨ Spark ä¸­ç®¡ç†åµŒå¥—å­—æ®µï¼Ÿ

åœ¨ Spark ä¸­ï¼Œå¤„ç†å®ƒä»¬æ€»æ˜¯æœ‰ç‚¹é—®é¢˜ã€‚

å‡è®¾ id=1 çš„äººå·²ç»æŠŠä»–çš„åœ°å€ä»â€œè©¹å§†æ–¯è¡—â€æ”¹æˆäº†â€œåœ£å½¼å¾—è¡—â€ï¼Œç°åœ¨ä½ éœ€è¦æ›´æ–°å®ƒã€‚

å› ä¸ºåœ¨ Spark ä¸­ä¸èƒ½ç›´æ¥ä¿®æ”¹åµŒå¥—å­—æ®µï¼Œæ‰€ä»¥éœ€è¦é‡æ–°æ„å»ºæ•´ä¸ªç»“æ„ï¼Œè¿™æ ·æ‰ä¸ä¼šä¸¢å¤±å…¶ä»–å­—æ®µã€‚

å¤§æ¦‚æ˜¯è¿™æ ·çš„:

```
df
  .withColumn("personal_info",
  *struct*(
    *lit*("**St Peter**"),
    *col*("personal_info.phone_number"),
    *col*("personal_info.age")))
```

> å—¯ï¼Œå¥½å§ï¼Œä½†æ˜¯æˆ‘ç°åœ¨å¦‚ä½•åœ¨ Spark ä¸­ç®¡ç†åµŒå¥—å­—æ®µå‘¢ï¼Ÿ

å—¯ï¼Œåœ¨è¿™ä¸ªæ–°çš„ 3.1.1 ç‰ˆæœ¬ä¸­ï¼Œå¼•å…¥äº†ä¸€ä¸ªåä¸º***with field****çš„æ–°æ–¹æ³•ã€‚*

*è®©æˆ‘ä»¬æ‰“ä¸ªæ‹›å‘¼ğŸ˜*

*ä» Spark 3.1.1 å¼€å§‹ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿåƒè¿™æ ·æ”¹å˜åµŒå¥—å­—æ®µ:*

```
*df
  .withColumn("personal_info",
    'personal_info.withField("address", *lit*("**St Peter**")))*
```

*å¥½å¤šäº†ï¼Œå¯¹å§ï¼Ÿæˆ‘ä»¬ä¸éœ€è¦é‡å»ºæ•´ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬åªéœ€è¦å¼•ç”¨æˆ‘ä»¬æƒ³è¦æ”¹å˜çš„å­—æ®µå°±å¯ä»¥äº†ï¼*

*è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­ã€‚*

*æˆ‘ä»¬çš„æ–°è¾“å…¥ JSON å¦‚ä¸‹(ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘é¿å…äº†ä¸€äº›æ‹¬å·)*

*![](img/cf4e7a3618853fa1373678975ba2d2a5.png)*

*æˆ‘å°†æ‰“å° Spark æ¨¡å¼ï¼Œè®©è¾“å…¥æ•°æ®æ›´åŠ æ¸…æ™°ã€‚*

```
*root
 |-- items: struct (nullable = true)
 |    |-- item: struct (nullable = true)
 |    |    |-- batters: struct (nullable = true)
 |    |    |    |-- batter: struct (nullable = true)
 |    |    |    |    |-- id: string (nullable = true)
 |    |    |    |    |-- topping: struct (nullable = true)
 |    |    |    |    |    |-- id: string (nullable = true)
 |    |    |    |    |    |-- type: string (nullable = true)
 |    |    |    |    |-- type: string (nullable = true)
 |    |    |-- id: string (nullable = true)
 |    |    |-- name: string (nullable = true)
 |    |    |-- ppu: double (nullable = true)
 |    |    |-- type: string (nullable = true)*
```

*ç°åœ¨æˆ‘ä»¬éœ€è¦ä»**ç½®é¡¶**å­—æ®µä¸­æ›´æ”¹ **id** ï¼Œè¯¥å­—æ®µåµŒå¥—å¾ˆæ·±ï¼Œæˆ‘ä»¬éœ€è¦å¯¼èˆª:*

> **ç‰©å“- >ç‰©å“- >é¢ç³Š- >é¢ç³Š- >æµ‡å¤´- > id**

*æ¥è¾¾åˆ°è¿™ä¸ªå€¼ã€‚*

*åœ¨ Spark 3.1.1 ä¹‹å‰ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªçœŸæ­£çš„éš¾é¢˜ï¼Œä½†ç°åœ¨å°±åƒè¿™æ ·ç®€å•:*

```
*df
  .withColumn("items",
    *col*("items")
      .withField("item.batters.batter.topping.id", *lit*(**12**)))*
```

*å¦‚æœæˆ‘ä»¬æ‰“å°ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ–°çš„ id ä¸å†æ˜¯ **5001** è€Œæ˜¯ **12** :*

```
*+----------------------------------------------------------+
|items                                                     |
+----------------------------------------------------------+
|{{{{1001, {**12**, None}, Regular}}, 0001, Cake, 0.55, donut}}|
+----------------------------------------------------------+*
```

*å°±æ˜¯è¿™æ ·ï¼é…·å§ï¼Ÿ*

> *â€¦é‚£ä¹ˆåˆ é™¤åµŒå¥—å­—æ®µå‘¢ï¼Ÿ*

*å¥½æ¶ˆæ¯ï¼æˆ‘ä»¬ä¹Ÿå¯ä»¥æ”¾å¼ƒä»–ä»¬ã€‚è®©æˆ‘ä»¬åˆ é™¤åˆšåˆšæ›´æ”¹è¿‡çš„å­—æ®µï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ ***dropFields:****

```
*df
  .withColumn("items",
    *col*("items")
      .dropFields("item.batters.batter.topping.id"))*
```

*è®©æˆ‘ä»¬å†æ¬¡æ‰“å°è¾“å‡º:*

```
*+------------------------------------------------------+
|items                                                 |
+------------------------------------------------------+
|{{{{1001, {None}, Regular}}, 0001, Cake, 0.55, donut}}|
+------------------------------------------------------+*
```

*è¿˜æœ‰æˆåŠŸï¼ **id** ä¸è§äº†ã€‚*

*åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä½ å¯èƒ½ä¼šé—®â€¦*

> *æˆ‘å¯ä»¥åŒæ—¶ä¿®æ”¹ä¸€åˆ—å’Œåˆ é™¤ä¸€åˆ—å—ï¼Ÿ*

*ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼*

```
*df
 .withColumn("items",
   *col*("items")
     .withField("item.batters.batter.topping.id", *lit*(12))
     .dropFields("item.batters.batter.topping.type"))*
```

*å¦‚æœæˆ‘ä»¬æ‰“å°ç»“æœå’Œæ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° ***id*** æ˜¯ 12ï¼Œè€Œ ***topping.type*** ä¸è§äº†:*

```
*+----------------------------------------------------+
|items                                               |
+----------------------------------------------------+
|{{{{1001, {12}, Regular}}, 0001, Cake, 0.55, donut}}|
+----------------------------------------------------+root
 |-- items: struct (nullable = true)
 |    |-- item: struct (nullable = true)
 |    |    |-- batters: struct (nullable = true)
 |    |    |    |-- batter: struct (nullable = true)
 |    |    |    |    |-- id: string (nullable = true)
 |    |    |    |    |-- topping: struct (nullable = true)
 |    |    |    |    |    |-- id: integer (nullable = false)
 |    |    |    |    |-- type: string (nullable = true)
 |    |    |-- id: string (nullable = true)
 |    |    |-- name: string (nullable = true)
 |    |    |-- ppu: double (nullable = true)
 |    |    |-- type: string (nullable = true)*
```

## *ç»“è®º*

*Spark å‘å±•å¾ˆå¿«ï¼Œä»¥å‰ä¸å¯èƒ½çš„äº‹æƒ…ç°åœ¨å¯èƒ½ä¼šå‘ç”Ÿï¼Œè·Ÿä¸Šæ—¶ä»£æ€»æ˜¯å¥½çš„ï¼Œä¸ä»…æ˜¯ Sparkï¼Œè€Œæ˜¯æ¯é¡¹æŠ€æœ¯ã€‚*

*æ¯«æ— ç–‘é—®ï¼Œå¯¹äºæ‰€æœ‰ä½¿ç”¨æ·±åº¦åµŒå¥—å­—æ®µçš„äººæ¥è¯´ï¼Œè¿™å°†æ”¹å˜æ¸¸æˆè§„åˆ™ã€‚*