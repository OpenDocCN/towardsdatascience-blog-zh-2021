# PyMC3 ä¸­çš„è´å¶æ–¯åˆ†å±‚å»ºæ¨¡

> åŸæ–‡ï¼š<https://towardsdatascience.com/bayesian-hierarchical-modeling-in-pymc3-d113c97f5149?source=collection_archive---------2----------------------->

## [è´å¶æ–¯ç»Ÿè®¡](https://medium.com/tag/bayesian-statistics)

## æ²»æ„ˆä½ æ¨¡ç‰¹çš„å¥å¿˜ç—‡

![](img/67997b9b7b08b6db188fd6034a904936.png)

åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šç”± [Rob Pumphrey](https://unsplash.com/@robpumphrey?utm_source=medium&utm_medium=referral) æ‹æ‘„çš„ç…§ç‰‡

# ä¸¤ç§æ–¹æ³•çš„æ•…äº‹

æœ‰æ—¶ï¼Œå½“ä½ è¯•å›¾åœ¨ä¸€ä¸ªå®Œå…¨å¼‚æ„çš„æ•°æ®é›†ä¸Šè¿›è¡Œæœºå™¨å­¦ä¹ æ—¶ï¼Œä½ ä¼šé¢ä¸´é€‰æ‹©çš„ç—›è‹¦ã€‚ä½œä¸ºæˆ‘æ‰€è¯´çš„å¼‚æ„æ•°æ®é›†çš„ä¸€ä¸ªä¾‹å­ï¼Œè€ƒè™‘ä¸€ä¸ªç®€å•çš„èº«é«˜æ•°æ®é›†ã€‚

![](img/3e0a1eccb13bb3509838de4fab930bee.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

è¿™ä¸ªæ•°æ®çœŸæ­£é‡è¦çš„ç‰¹å¾æ˜¯èº«é«˜ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸¤ä¸ªä¸åŒçš„ç¾¤ä½“:ç”·æ€§å’Œå¥³æ€§ã€‚ä»…ç”±ç”·æ€§ç»„æˆçš„å­æ•°æ®é›†æœ¬èº«æ˜¯åŒè´¨çš„ï¼Œä»…ç”±å¥³æ€§ç»„æˆçš„å­æ•°æ®é›†ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä½†æ˜¯å°†ä¸¤è€…æ”¾åœ¨ä¸€èµ·ä¼šäº§ç”Ÿå¼‚è´¨æ•°æ®é›†ã€‚

ç»™å®šä¸€äº›å¼‚æ„æ•°æ®ï¼Œæ‚¨å¯ä»¥:

*   åœ¨å®Œæ•´çš„æ•°æ®é›†ä¸Šæ„å»ºä¸€ä¸ªå¤§æ¨¡å‹ï¼Œæˆ–è€…
*   åœ¨æ•°æ®é›†æ›´å°ã€æ›´åŒè´¨çš„éƒ¨åˆ†ä¸Šæ„å»ºå¤šä¸ªæ¨¡å‹ã€‚

![](img/3f71996d44abd7e767ae0885329ae7a5.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

## åˆ©å¼Š

æ„å»ºä¸€ä¸ªå¤§æ¨¡å‹ï¼Œä¹Ÿè¢«ç§°ä¸º**(å®Œå…¨)æ± åŒ–**ï¼Œé€šå¸¸æ˜¯æœ€ç®€å•çš„æ–¹æ³•:ä½ æŠŠæ‰€æœ‰çš„æ ·æœ¬æ”¾åœ¨ä¸€èµ·ï¼Œå¿˜è®°ä¸åŒçš„ç»„ã€‚ç„¶è€Œï¼Œå¦‚æœå¤§æ¨¡å‹è¿‡äºç®€å•ï¼Œå®ƒå¯èƒ½ä¼šå¿½ç•¥æ•°æ®ä¸­çš„ä¸åŒç»†å¾®å·®åˆ«ï¼Œä»è€Œå¯¼è‡´**ä¸ç¬¦åˆ**ã€‚å½“ä½¿ç”¨é«˜åº¦å¯è§£é‡Šçš„æ¨¡å‹(å¦‚çº¿æ€§æ¨¡å‹)æ—¶ï¼Œè¿™ä¸ªé—®é¢˜ä¼šå¾ˆå¿«å‘ç”Ÿã€‚å¦‚æœæ‚¨å¯ä»¥å¹¶ä¸”æƒ³è¦ä½¿ç”¨é»‘ç›’æ–¹æ³•ï¼Œå¦‚æ¢¯åº¦å¢å¼ºï¼Œè¯¥æ¨¡å‹å¯ä»¥è‡ªå·±å‘ç°å¹¶å­¦ä¹ ä¸åŒçš„å­æ•°æ®é›†ï¼Œä½†ä»£ä»·æ˜¯é™ä½äº†å¯è§£é‡Šæ€§ã€‚

å»ºç«‹å‡ ä¸ªæ›´å°çš„æ¨¡å‹ä¼¼ä¹æ˜¯ä¸€ä¸ªæ›´å¥½çš„ä¸»æ„:ä½ å°†æ•°æ®é›†åˆ†å‰²æˆä¸åŒçš„æ›´åŒè´¨çš„éƒ¨åˆ†ï¼Œå¹¶ä¸ºæ¯ä¸ªéƒ¨åˆ†å»ºç«‹ä¸€ä¸ªæ›´å°çš„æ¨¡å‹ã€‚ç”±æ­¤äº§ç”Ÿçš„æ¨¡å‹è¢«ç§°ä¸º**éæ± åŒ–**æ¨¡å‹ã€‚è¿™æ ·ï¼Œæ¯ä¸ªæ¨¡å‹éƒ½å¯ä»¥å¾ˆå¥½åœ°å¤„ç†ä¸€å°éƒ¨åˆ†æ•°æ®ï¼Œå¹¶ä¸”å®ƒä»¬åº”è¯¥ä¸€èµ·å½¢æˆä¸€ä¸ªä¸é”™çš„æ¨¡å‹ã€‚è¿™ç§æ–¹æ³•çš„æ˜æ˜¾ç¼ºç‚¹æ˜¯ä½ å¿…é¡»é€‚åº”è®¸å¤šæ¨¡å‹ï¼Œä½†æ˜¯å½“å°æ•°æ®é›†å˜å¾—*å¤ªå°*æ—¶ï¼Œä¸€ä¸ªæ›´ä¸¥é‡çš„é—®é¢˜å‡ºç°äº†:**è¿‡åº¦é€‚åº”**ã€‚

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œå‡è®¾æˆ‘ä»¬çš„èº«é«˜æ•°æ®é›†ç”± 100 ä¸ªæ ·æœ¬ç»„æˆ:97 åå¥³æ€§å’Œ 3 åç”·æ€§ã€‚æˆ‘ä»¬ç°åœ¨æƒ³é€šè¿‡å–èº«é«˜çš„æ ·æœ¬å¹³å‡å€¼æ¥ä¼°è®¡æ¯ç»„çš„å¹³å‡èº«é«˜ã€‚è™½ç„¶å¥³æ€§çš„çŒœæµ‹åº”è¯¥æ˜¯ç›¸å½“ä¸é”™çš„ï¼Œä½†ç”·æ€§çš„ç»“æœå°†éå¸¸ä¸å¯é ï¼Œå› ä¸ºè§‚å¯Ÿçš„æ•°é‡å¾ˆå°‘ã€‚ä¸»è¦é—®é¢˜å¦‚ä¸‹:

> å­æ¨¡å‹æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚è¢«è®­ç»ƒçš„æ¯ä¸ªå­æ¨¡å‹ä¸å‘å…¶ä»–å­æ¨¡å‹ä¼ é€’ä»»ä½•ä¿¡æ¯ã€‚åœ¨æŸç§æ„ä¹‰ä¸Šï¼Œæ€»æ¨¡å‹å¿˜è®°äº†å®ƒåœ¨æ¯ä¸ªå­æ•°æ®é›†ä¸Šåšä»€ä¹ˆã€‚

æœªå†·å´çš„æ¨¡å‹ã€‚

# æ¨¡ç‰¹çš„å¥å¿˜ç—‡

è™½ç„¶è®­ç»ƒå­¤ç«‹çš„æ¨¡å‹*åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½*æœ‰æ„ä¹‰ï¼Œä½†åœ¨æˆ‘çœ‹æ¥ï¼Œå­æ¨¡å‹å…±äº«çŸ¥è¯†å¾€å¾€æ›´å¥½ã€‚

ä¸¾ä¸ªç°å®ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼Œåœ¨ [*å°é…’é¦†åˆ°å¾·å›½é‡‘è‰² M*](https://de.wikipedia.org/wiki/McDonald%E2%80%99s) ä¹°ä¸ªèŠå£«æ±‰å ¡çš„ç­‰å¾…æ—¶é—´å¹³å‡éœ€è¦ä¸¤åˆ†é’Ÿ(è¿™ä¸ªæ•°å­—æ˜¯æˆ‘ç¼–çš„)ã€‚å¦‚æœæˆ‘ç°åœ¨å»æ³•å›½ï¼Œå¹³å‡ç­‰å¾…æ—¶é—´å¾ˆå¯èƒ½ä¸è¿™ä¸¤åˆ†é’Ÿç›¸å·®ä¸è¿œã€‚æ—¥æœ¬å¯èƒ½ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å½“ç„¶ï¼Œä¸€äº›å›½å®¶æ›´å¿«ï¼Œä¸€äº›å›½å®¶å¹³å‡æ›´æ…¢ï¼Œä½†æ˜¯ä¸ç®¡æ˜¯å“ªä¸ªå›½å®¶ï¼Œç­‰å¾…ä¸€ä¸ªæ±‰å ¡ä¸€ä¸ªå°æ—¶åº”è¯¥æ˜¯ä¸€ä¸ªç›¸å½“ç½•è§çš„ä¾‹å¤–ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘é¥¿äº†ï¼Œæƒ³åœ¨æ³•å›½åƒä¸€ä¸ªèŠå£«æ±‰å ¡ï¼Œæˆ‘ä¼šæƒ³åˆ°è¦ç­‰å¤šä¹…ï¼Œä¹Ÿè®¸æˆ‘æ˜¯å¯¹çš„ã€‚æˆ‘å¯ä»¥å°†ä»ä¸€ä¸ªå°ç»„(å¾·å›½)å­¦åˆ°çš„çŸ¥è¯†è½¬ç§»åˆ°å¦ä¸€ä¸ªå°ç»„(æ³•å›½)è¿›è¡Œé¢„æµ‹ã€‚*è¿™åŒæ ·é€‚ç”¨äº heights æ•°æ®é›†ã€‚*

## ä¸€ä¸ªæœ‰ç”¨çš„é»˜è®¤

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åˆ›é€ ä¸€äº›æƒ…æ™¯ï¼Œè®©äººä»¬è¯¯ä»¥ä¸ºè®°ä½äº†ä½ å­¦è¿‡çš„ä¸œè¥¿ã€‚åœ¨åŒ»ç”ŸåŠå…¬å®¤çš„ç­‰å¾…æ—¶é—´å¯èƒ½ä¸ä¼šç»™ä½ ä»»ä½•å…³äºäº¤é€šç¯ç»¿è‰²é˜¶æ®µæŒç»­æ—¶é—´çš„æŒ‡ç¤ºï¼Œæ‰€ä»¥ä½ ä¸åº”è¯¥è¯•å›¾åœ¨è¿™ä¸¤ä¸ªä¸ç›¸å…³çš„å˜é‡ä¹‹é—´åˆ†äº«çŸ¥è¯†ã€‚

ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬è¯šå®ï¼Œé€šå¸¸æˆ‘ä»¬ä¸ä¼šçœ‹åˆ°æ¥è‡ªå®Œå…¨ä¸ç›¸å…³å’Œéšæœºæ¥æºçš„æ•°æ®ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ç›¸å½“ä¸€è‡´çš„ï¼Œåªæ˜¯åœ¨å›½å®¶ã€æ€§åˆ«ã€å•†åº—ç­‰ç¾¤ä½“ä¸­æœ‰ä¸€äº›å˜åŒ–ï¼Œå› æ­¤

> æˆ‘è§‰å¾—åˆ†äº«çŸ¥è¯†å¾€å¾€æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é»˜è®¤ã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•è®©æˆ‘ä»¬çš„æ¨¡å‹æœ‰æ›´å¥½çš„è®°å¿†å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œæ¢ä¸€ç§æ–¹å¼ï¼Œå¦‚ä½•æ•™ä¼šå­æ¨¡å‹ä¹‹é—´çš„æ²Ÿé€šå’ŒååŒå·¥ä½œï¼Ÿè¿™æœ‰å‡ ç§æ–¹æ³•ï¼Œä¾‹å¦‚ï¼Œåœ¨ç¥ç»ç½‘ç»œçš„æƒ…å†µä¸‹ï¼Œ*å‚æ•°*æˆ–*æƒé‡åˆ†é…*ï¼Œè¿™é‡Œæˆ‘ä¸æ‰“ç®—è¯¦ç»†è¯´æ˜ã€‚

ç„¶è€Œï¼Œæ­£å¦‚ä½ ä»è¿™ç¯‡æ–‡ç« çš„æ ‡é¢˜ä¸­æ‰€çŸ¥é“çš„ï¼Œæˆ‘ä»¬å°†è½¬å‘è´å¶æ–¯ï¼Œå¹¶å­¦ä¹ å¦‚ä½•åš**è´å¶æ–¯åˆ†å±‚å»ºæ¨¡**ä½œä¸ºæˆ‘ä»¬é—®é¢˜çš„å¯èƒ½è§£å†³æ–¹æ¡ˆã€‚æˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨ [PyMC3](https://docs.pymc.io/) ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªä¸é”™çš„åŒ…ã€‚

å¦‚æœæ‚¨ä»æœªå¬è¯´è¿‡è´å¶æ–¯ç»Ÿè®¡æˆ– PyMC3ï¼Œå¹¶æƒ³å­¦ä¹ å®ƒï¼Œè¯·æŸ¥çœ‹æˆ‘å…³äºè¿™ä¸ªæœ‰è¶£ä¸»é¢˜çš„å…¶ä»–ä»‹ç»æ€§æ–‡ç« ã€‚

[](/a-gentle-introduction-to-bayesian-inference-6a7552e313cb) [## è´å¶æ–¯æ¨ç†çš„ç®€æ˜ä»‹ç»

### äº†è§£é¢‘ç‡ä¸»ä¹‰è€…å’Œè´å¶æ–¯æ¨ç†æ–¹æ³•ä¹‹é—´çš„åŒºåˆ«

towardsdatascience.com](/a-gentle-introduction-to-bayesian-inference-6a7552e313cb) [](/conducting-bayesian-inference-in-python-using-pymc3-d407f8d934a5) [## ä½¿ç”¨ PyMC3 åœ¨ Python ä¸­è¿›è¡Œè´å¶æ–¯æ¨ç†

### é‡æ¸©ç¡¬å¸çš„ä¾‹å­ï¼Œå¹¶ä½¿ç”¨ PyMC3 è®¡ç®—è§£å†³å®ƒã€‚

towardsdatascience.com](/conducting-bayesian-inference-in-python-using-pymc3-d407f8d934a5) 

**èµ°å§ï¼**

# PyMC3 ä¸­çš„åˆ†å±‚å»ºæ¨¡

é¦–å…ˆï¼Œæˆ‘ä»¬å°†é‡æ–°å®¡è§†ä¸¤è€…ï¼Œåœ¨**è´å¶æ–¯**è®¾ç½®ä¸­çš„æ± åŒ–å’Œéæ± åŒ–æ–¹æ³•ï¼Œå› ä¸ºå®ƒæ˜¯

1.  ä¸€ä¸ªå¾ˆå¥½çš„ç»ƒä¹ ï¼Œè€Œä¸”
2.  éæ± åŒ–å’Œå±‚æ¬¡åŒ–(ä¹Ÿç§°ä¸º**éƒ¨åˆ†æ± åŒ–**æˆ–**å¤šçº§**)çš„ä»£ç åº“éå¸¸ç›¸ä¼¼ã€‚

åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ•°æ®é›†è¿›è¡Œå®éªŒã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç®€å•çš„ä¸€ç»´å›å½’é—®é¢˜ï¼Œå³åªæœ‰ä¸€ä¸ªç‰¹å¾å’Œä¸€ä¸ªç›®æ ‡ã€‚æœ‰å…«ä¸ªä¸åŒçš„ç»„ï¼Œæ¯ä¸ªç»„éƒ½æœ‰è‡ªå·±çš„æ–œç‡ï¼Œå›ºå®šæˆªè·ä¸ºé›¶ã€‚

```
import numpy as np

np.random.seed(0) # to keep it reproducible

mean_slope = 2 # the 8 different slopes have a mean of 2

slopes = np.random.normal(mean_slope, size=8)
groups = np.array(50*[0, 1, 2, 3, 4, 5, 6] + 5*[7])

x = np.random.randn(355)
y = slopes[groups] * x + 0.1*np.random.randn(355)
```

`groups`å˜é‡åŒ…å«æ¯ä¸ªè§‚å¯Ÿå€¼æ‰€å±çš„ç»„ã€‚0 åˆ° 6 ç»„å„æœ‰ 50 ä¸ªè§‚å¯Ÿå€¼ã€‚ç„¶åï¼Œæœ€åæ˜¯å°‘æ•°ç¾¤ä½“ 7ï¼Œåªæœ‰äº”ä¸ªè§‚å¯Ÿå€¼ã€‚

ä½œä¸ºä¸€ä¸ªå°æŒ‡å—ï¼Œè¦è·å¾—å±äºç»„ 2 çš„å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨`x[groups==2], y[groups==2]`ã€‚è¿™ä¸ªå­æ•°æ®é›†çš„æ–œç‡æ˜¯`slopes[2]`ã€‚

ä¸ºäº†å¢åŠ è¶£å‘³ï¼Œè®©æˆ‘ä»¬åœ¨è¿™ä¸ªå°‘æ•°ç¾¤ä½“ä¸­åŠ å…¥å±€å¤–äººã€‚

```
y[-1] = 30 # the last 5 observations are from minority group 7
y[-2] = 30
```

å¯¼å…¥æˆ‘ä»¬æœ€å–œæ¬¢çš„è´å¶æ–¯åº“å

```
import pymc3 as pm
import arviz as az
```

æˆ‘ä»¬å¯ä»¥å¼€å§‹å»ºæ¨¡äº†ï¼

## æ··åˆæ¨¡å‹

æˆ‘ä»¬å°†ä»å¿½ç•¥ç»„å¼€å§‹ï¼Œå°†è¿™ä¸ªæ•°æ®é›†è§†ä¸ºä¸€ä¸ªå¤§å—ã€‚PyMC3 ä¸­ä¸å¸¦æˆªè·çš„ç®€å•è´å¶æ–¯çº¿æ€§å›å½’å¦‚ä¸‹æ‰€ç¤º:

```
with pm.Model() as pooled_model:
    slope = pm.Normal('slope', 0, 20)
    noise = pm.Exponential('noise', 0.1)

    obs = pm.Normal('obs', slope*x, noise, observed=y)

    pooled_trace = pm.sample(return_inferencedata=True)

az.plot_posterior(pooled_trace, var_names=['slope'])
```

è¾“å‡ºå°†æ˜¯

![](img/1d5fc8395ea5ec67d1575a8a8213e0ae.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

è¿™åŸºæœ¬ä¸Šæ²¡ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬åªå¾—åˆ°ä¸€ä¸ªå•ä¸€çš„æ–œç‡ï¼Œä½†è¿™å¹¶ä¸å¥‡æ€ªã€‚ä¸‹ä¸€ä¸ªæœ€å¥½çš„æ–¹æ³•æ˜¯ä¸ºæ¯ç»„å¼•å…¥ä¸€ä¸ªæ–œç‡ã€‚

## æ— æ± æ¨¡å‹

```
with pm.Model() as unpooled_model:
    slope = pm.Normal('slope', 0, 20, shape=8)
    noise = pm.Exponential('noise', 10)

    obs = pm.Normal('obs', slope[groups]*x, noise, observed=y)

    unpooled_trace = pm.sample(return_inferencedata=True)

az.plot_posterior(unpooled_trace, var_names=['slope'])
```

æˆ‘ä»¬ç°åœ¨æœ‰å…«ä¸ªä¸åŒçš„æ–œå¡ï¼Œéƒ½æ˜¯ç‹¬ç«‹è®­ç»ƒçš„:

![](img/f3b2e63aad4e8d33efe718c27ba34ed5.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä»…æ ‡ç»˜ 94%çš„é«˜å¯†åº¦åŒºé—´(HDI ),å³åŒ…å« 94%åä½è´¨é‡çš„çŸ­å¯ä¿¡åŒºé—´

```
az.plot_forest(unpooled_trace, var_names=['slope'], combined=True)
```

æˆ‘ä»¬å¾—åˆ°äº†

![](img/6b0ca707aab192f59eb8e08f2594ed54.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

ä½ å¯ä»¥çœ‹åˆ°ç¬¬ 0 ç»„åˆ°ç¬¬ 6 ç»„çš„æ–œç‡å¾ˆå°ï¼Œè€Œç¬¬ 7 ç»„çš„æ–œç‡å¾ˆå¤§ã€‚ä½†è¿™æ˜¯å®Œå…¨é”™è¯¯çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ‰€æœ‰çš„æ–œç‡éƒ½åº”è¯¥åœ¨å€¼**2**å·¦å³ã€‚å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿç®€å•:æˆ‘ä»¬é€šè¿‡åœ¨æœ€å°çš„ç¾¤ä½“ä¸­å¼•å…¥å¼‚å¸¸å€¼æ¥æ¬ºéª—æ¨¡å‹ã€‚

è¿™æ­£æ˜¯æˆ‘ä¹‹å‰è°ˆåˆ°çš„é—®é¢˜:ç»„ 7 çš„å­æ¨¡å‹æ²¡æœ‰æœºä¼šï¼Œå› ä¸ºå®ƒä¸çŸ¥é“ç»„ 0 åˆ°ç»„ 6 ä¸­å‘ç”Ÿäº†ä»€ä¹ˆã€‚å®ƒä¸çŸ¥é“æ–œç‡é€šå¸¸åœ¨ 2 å·¦å³ã€‚

æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## éƒ¨åˆ†æ± åŒ– aka å±‚æ¬¡æ¨¡å‹

```
with pm.Model() as hierarchical_model:
    mu_slope = pm.Normal('mu_slope', 0, 1) # hyperprior 1
    sigma_slope = pm.Exponential('sigma_slope', 13) # hyperprior 2

    slope = pm.Normal('slope', mu_slope, sigma_slope, shape=8)
    noise = pm.Exponential('noise', 10)

    obs = pm.Normal('obs', slope[groups]*x, noise, observed=y)

    hierarchical_trace = pm.sample(
        return_inferencedata=True,
        target_accept=0.995
    )

az.plot_posterior(hierarchical_trace)
```

é‚£ä¹ˆï¼Œç°åœ¨è¿™æ˜¯ä»€ä¹ˆï¼Ÿåœ¨æ— æ± æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡

```
slope = pm.Normal('slope', 0, 20, shape=8)
```

æˆ‘ä»¬å‘Šè¯‰æ¨¡å‹ï¼Œæ–œç‡åº”è¯¥åœ¨é›¶å·¦å³ï¼Œä½†æ˜¯å…·æœ‰ç›¸å½“å¤§çš„ 20 çš„æ ‡å‡†åå·®ã€‚

åœ¨åˆ†å±‚æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†æ‰€è°“çš„**è¶…å…ˆéªŒ**æ¥ä¸ºæ–œç‡å…ˆéªŒæ‰¾åˆ°æ›´å¥½çš„å‡å€¼å’Œæ ‡å‡†å·®ã€‚é‡è¦çš„æ˜¯:

```
mu_slope = pm.Normal('mu_slope', 0, 1)
sigma_slope = pm.Exponential('sigma_slope', 13)

slope = pm.Normal('slope', mu_slope, sigma_slope, shape=8)
```

æˆ‘ä»¬ç”¨`mu_slope`ä»£æ›¿é›¶ï¼Œç”¨`sigma_slope`ä»£æ›¿äºŒåï¼Œå°±è¿™ä¹ˆç®€å•ã€‚è¿™ä¸¤ä¸ªéƒ½æ˜¯éšæœºå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è´å¶æ–¯æ¨ç†æ¥å­¦ä¹ ã€‚`mu_slope`å’Œ`sigma_slope`è¢«ç§°ä¸ºè¶…ä¼˜å…ˆçº§ï¼Œä¾‹å¦‚ï¼Œå†³ç­–æ ‘çš„æœ€å¤§æ·±åº¦è¢«ç§°ä¸ºè¶…å‚æ•°ã€‚å®ƒä»¬éƒ½æ¯”`slope`é«˜ä¸€ä¸ª*å±‚çº§*ï¼Œå› ä¸ºåœ¨`slope`å¯ä»¥è®¡ç®—ä¹‹å‰ï¼Œå®ƒä»¬å¿…é¡»é¦–å…ˆè¢«è¯„ä¼°ã€‚

> æ³¨æ„:æˆ‘åœ¨`sample`æ–¹æ³•ä¸­æ·»åŠ äº†`target_accept=0.995`æ¥æ”¹è¿›é‡‡æ ·ï¼Œå› ä¸ºä»è¿™ä¸ªåµŒå¥—çš„åéªŒæ¨¡å‹ä¸­é‡‡æ ·ä¸å†åƒå¯¹é pool æ¨¡å‹é‚£æ ·å®¹æ˜“ã€‚æˆ‘å¯ä»¥åœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­è¿›ä¸€æ­¥è§£é‡Šè¿™ä¸€ç‚¹ã€‚

åéªŒçœ‹èµ·æ¥åƒè¿™æ ·:

![](img/c4547554da0e51e4d37d44e6180f5e26.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

![](img/6a05bdb7d7ae85e70c4f10296e1a189d.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

è¿™ä»ç„¶ä¸æ˜¯å®Œç¾çš„ï¼Œä½†æ¯”æ— æ± æ¨¡å‹æ›´æ¥è¿‘äº‹å®ã€‚è¿™æ˜¯å› ä¸ºè¯¥æ¨¡å‹è¿˜è¯•å›¾ä½¿ç”¨`mu_slope`è¶…çº§å‡½æ•°æ¥è®¡ç®—æ–œç‡å¹³å‡å€¼ã€‚çœŸå®çš„å…ˆéªŒåº”è¯¥æ˜¯ 2ï¼Œç„¶è€Œï¼Œç”±äºå¼‚å¸¸å€¼ï¼Œæ¨¡å‹è®¤ä¸ºå®ƒå¤§çº¦æ˜¯ 3ã€‚

![](img/e9a1a87e0fc3c0af5b6aa9e5efa8cd00.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬åœ¨é pool æ¨¡å‹ä¸­çœ‹åˆ°çš„å¤§æ–œç‡**15**å°†*æ‹‰å‘è¿™ä¸ªå¤§çº¦ 3 çš„`mu_slope`ã€‚å…¶ä»–å‚æ•°ä¹Ÿæ˜¯å¦‚æ­¤:*

> åœ¨åˆ†å±‚å»ºæ¨¡ä¸­ï¼Œæ‰€æœ‰å‚æ•°éƒ½è¢«æ‹‰å‘å…¨å±€å¹³å‡å€¼ã€‚è¿™ç§æ•ˆåº”è¢«ç§°ä¸ºæ”¶ç¼©ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œå±‚æ¬¡æ¨¡å‹æ˜¯æ˜æ˜¾çš„èµ¢å®¶ã€‚ä½œä¸ºæœ€åä¸€æ­¥ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨**æ ‡ç‰Œç¬¦å·**ç›´è§‚åœ°æ¯”è¾ƒä¸‰ç§å‹å·ã€‚è¿™æ˜¯ä¸€ä¸ªä¸è¨€è‡ªæ˜çš„æ¨¡å‹å¯è§†åŒ–è¡¨ç¤ºï¼Œå¯èƒ½å¯¹ä½ ä»¬å½“ä¸­çš„è§†è§‰å­¦ä¹ è€…æœ‰æ‰€å¸®åŠ©ã€‚

# ä½¿ç”¨å¹³æ¿ç¬¦å·æ¯”è¾ƒæ¨¡å‹

PyMC3 æœ‰ä¸€ä¸ªå¥‡å¦™çš„åŠŸèƒ½`pm.model_to_graphviz(model)`ä»¥ä¸€ç§å¾ˆå¥½çš„æ–¹å¼æ˜¾ç¤ºä½ çš„æ¨¡å‹ã€‚

![](img/40adce39c7da6fe0901d09ecb0374dfb.png)

å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚

æˆ‘å–œæ¬¢è¿™ç§è¡¨ç¤ºï¼Œå› ä¸ºä½ å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æ¨¡å‹çš„æŸç§æ¼”å˜ã€‚åœ¨æ··åˆæ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬ä»å•ä¸€æ–œç‡å¼€å§‹ã€‚ç„¶åæˆ‘ä»¬å¢åŠ æ–œç‡çš„æ•°é‡ï¼Œç”¨æ•°å­—ä¸º 8 çš„æ–¹æ¡†è¡¨ç¤ºã€‚

> è¿™ä¸ªç¬¦å·æ˜¯ä¸ºæ–œå¡ç”» 8 ä¸ªåœ†çš„æ·å¾„ã€‚æˆ‘çŒœè¿™ä¸ªå°ç›’å­åº”è¯¥æ˜¯ä¸€å¼ æ¡Œå­ï¼Œä¸Šé¢å æ”¾ç€ 8 ä¸ªç›˜å­ï¼Œæˆ‘ä»¬ä»ä¸Šé¢çœ‹ï¼Œå› æ­¤å¾—åã€‚

è¿™ä¸ªè¿‡ç¨‹çš„æœ€åä¸€æ­¥æ˜¯åœ¨é¡¶å±‚å¼•å…¥ä¸€ä¸ªæ–°çš„å˜é‡å±‚ï¼Œå³è¶…ä¼˜å…ˆçº§ã€‚

# ç»“è®º

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†å¤„ç†å¼‚æ„æ•°æ®é›†æ—¶ä¸åŒçš„å»ºæ¨¡æ–¹æ³•ã€‚èµ·åˆï¼Œæˆ‘å£°ç§°æœ‰ä¸¤ç§æ–¹å¼:æ± åŒ–å’Œéæ± åŒ–æ¨¡å‹ã€‚å¾ˆæ˜æ˜¾ï¼Œæˆ‘åœ¨æ’’è°ï¼Œæ­£å¦‚æˆ‘ä»¬å·²ç»çœ‹åˆ°çš„åˆ†å±‚å»ºæ¨¡ä¸€æ ·ã€‚

ä¸€ä¸ªæœ‰è¶£çš„è§‚å¯Ÿæ˜¯ï¼Œæ‚¨å¯ä»¥å°†åˆ†å±‚å»ºæ¨¡çœ‹ä½œæ˜¯å¯¹éæ± åŒ–å»ºæ¨¡çš„**æ¨å¹¿ã€‚å¦‚æœæ‚¨å°†è¶…ä¼˜å…ˆçº§è®¾ç½®ä¸ºæŸä¸ª*å¸¸é‡*éšæœºå˜é‡ï¼Œæ‚¨å°†å†æ¬¡ä»¥æ— æ± æ–¹æ³•ç»“æŸã€‚å¦åˆ™ï¼Œå±‚æ¬¡æ¨¡å‹é€šè¿‡è·Ÿè¸ªå…¨å±€å‚æ•°æ¥åšä¸€äº›ä¸åŒçš„äº‹æƒ…ï¼Œä¾‹å¦‚`mu_slope`ï¼Œå®ƒå……å½“æˆ‘ä»¬æƒ³è¦ä¼°è®¡çš„å®é™…å‚æ•°çš„ç§å­ã€‚ä½œä¸ºä¸€ä¸ªå¾ˆå¥½çš„å‰¯ä½œç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå¾—åˆ°è¿™äº›å…¨å±€å‚æ•°çš„ä¼°è®¡ã€‚å¦‚æœåœ¨ä¸åŒçš„ç»„ä¸­æ²¡æœ‰å€¼å¾—åˆ†äº«çš„ä¸œè¥¿ï¼Œå±‚æ¬¡æ¨¡å‹ä¹Ÿä¼šå­¦ä¹ è¿™ä¸ªï¼Œè¿™å¾ˆå¥½ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ**æˆ‘è®¤ä¸ºä½ åº”è¯¥å°½å¯èƒ½ä½¿ç”¨å±‚æ¬¡åŒ–çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯éæ± åŒ–çš„æ–¹æ³•**:é€šå¸¸è¿™æ²¡æœ‰åå¤„ã€‚**

å½“ä½¿ç”¨åˆ†å±‚å»ºæ¨¡è€Œä¸æ˜¯æ— æ± å»ºæ¨¡æ—¶ï¼Œå”¯ä¸€å¯èƒ½å‡ºé”™çš„æ˜¯æœ‰æ›´å¤šçš„**å‚æ•°**è¦ä¼°è®¡ï¼Œå¹¶ä¸”ç”±äºåµŒå¥—çš„å‚æ•°ï¼Œä¼°è®¡ä¹Ÿå˜å¾—æ›´åŠ å›°éš¾ã€‚ä½ å¿…é¡»ä½¿ç”¨ä¸€äº›æŠ€å·§ï¼Œæ¯”å¦‚æ”¹å˜ MCMC é‡‡æ ·å‚æ•°æˆ–è€…å¼•å…¥æ‰€è°“çš„*éä¸­å¿ƒ*å˜é‡ã€‚

ä¸€ä¸ªä»¥**ä¸ºä¸­å¿ƒçš„** ( *æˆ‘ç§°ä¹‹ä¸ºåµŒå¥—çš„*)å˜é‡ç±»ä¼¼äºå¦å¤–ä¸¤ä¸ªéšæœºå˜é‡`a`å’Œ`b`çš„`pm.Normal('X', a, b)`ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ä¸Šé¢ç”¨è¿‡çš„ã€‚ç„¶è€Œï¼Œåœ¨æ­£æ€åˆ†å¸ƒçš„ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œä½ ä¹Ÿå¯ä»¥å†™`a + b*pm.Normal('X', 0, 1)`ï¼Œè¿™ä»ç»Ÿè®¡å­¦çš„è§’åº¦æ¥çœ‹æ˜¯ç­‰ä»·çš„ï¼Œä½†å¯¹äºè®¡ç®—åéªŒåˆ†å¸ƒçš„ MCMC ç®—æ³•æ¥è¯´æ˜¯ä¸€ä¸ªå·¨å¤§çš„å·®å¼‚ã€‚

å°½ç®¡å¦‚æ­¤ï¼Œå¦‚æœä½ èƒ½å…‹æœè®¡ç®—é—®é¢˜ï¼Œæˆ‘è®¤ä¸ºåˆ†å±‚å»ºæ¨¡é€šå¸¸æ˜¯ä¸€æ¡å€¼å¾—å°è¯•çš„é“è·¯ã€‚

ä½œä¸ºä¸€ä¸ªé¢å¤–çš„èµ„æºï¼Œçœ‹çœ‹æ‰˜é©¬æ–¯Â·å¨å¥‡å’Œè¾¾å†…Â·åŸƒå°”ä¼¯æ–¯å†™çš„è¿™ç¯‡ä¸é”™çš„åšæ–‡ã€‚

æˆ‘å¸Œæœ›ä½ ä»Šå¤©å­¦åˆ°äº†æ–°çš„ã€æœ‰è¶£çš„ã€æœ‰ç”¨çš„ä¸œè¥¿ã€‚æ„Ÿè°¢é˜…è¯»ï¼

**ä½œä¸ºæœ€åä¸€ç‚¹ï¼Œå¦‚æœä½ **

1.  **æƒ³æ”¯æŒæˆ‘å¤šå†™ç‚¹æœºå™¨å­¦ä¹ å’Œ**
2.  **æ— è®ºå¦‚ä½•ï¼Œè®¡åˆ’è·å¾—ä¸€ä¸ªä¸­ç­‰è®¢é˜…é‡ï¼Œ**

**ä¸ºä»€ä¹ˆä¸åš** [**é€šè¿‡è¿™ä¸ªç¯èŠ‚**](https://dr-robert-kuebler.medium.com/membership) **ï¼Ÿè¿™å°†å¯¹æˆ‘å¸®åŠ©å¾ˆå¤§ï¼ğŸ˜Š**

é€æ˜åœ°è¯´ï¼Œç»™ä½ çš„ä»·æ ¼ä¸å˜ï¼Œä½†å¤§çº¦ä¸€åŠçš„è®¢é˜…è´¹ç›´æ¥å½’æˆ‘ã€‚

**éå¸¸æ„Ÿè°¢ï¼Œå¦‚æœä½ è€ƒè™‘æ”¯æŒæˆ‘ï¼**

> å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [LinkedIn](https://www.linkedin.com/in/dr-robert-k%C3%BCbler-983859150/) ä¸Šç»™æˆ‘å†™ä¿¡ï¼