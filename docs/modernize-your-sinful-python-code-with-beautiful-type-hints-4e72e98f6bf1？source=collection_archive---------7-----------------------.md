# 用漂亮的类型提示使你罪恶的 Python 代码现代化

> 原文：<https://towardsdatascience.com/modernize-your-sinful-python-code-with-beautiful-type-hints-4e72e98f6bf1?source=collection_archive---------7----------------------->

## 成为拥有专业代码质量技能的顶级掠夺者

![](img/67068390919a119df1f0926edababc27.png)

戴维·克洛德在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

# 您的旅程概述

1.  [设置舞台](#d5ae)
2.  [了解动态类型和静态类型](#e8cf)
3.  [变量的 Python 类型提示](#507c)
4.  [用 Mypy 检查类型提示](#b03b)
5.  [函数的 Python 类型提示](#6478)
6.  [如何添加列表作为类型提示](#111d)
7.  [给你的代码加电的五个令人敬畏的类型提示](#1653)
8.  [为什么所有酷小孩都用 Python 3.9+](#c7b3)
9.  [总结和进一步的资源](#89a2)

# 搭建舞台

在由 Stack Overflow 发起的 *2020 年开发者调查中，* Python 在“[开发者想学的编程语言](https://insights.stackoverflow.com/survey/2020#technology-most-loved-dreaded-and-wanted-languages-wanted)”类别中拔得头筹。尽管如此，Python 也有让支持者和批评者恼火的缺点。经常提到的一个缺点如下:

> *Python 有* ***动态类型*** *。这增加了调试时间，并使变量和函数的行为不可预测。*

尽管动态类型对于快速原型开发来说很方便，但是在大型项目中，它们可能会成为一种烦恼。这就是类型提示发挥作用的地方:自从 Python 3.5 发布以来，可以通过编写**类型提示来模拟 Python 中的**静态类型**！❤️**

编写类型提示的另一个好处是它们可以提高代码质量。当我说代码质量时，大多数人会想到**描述性变量名**和**写得很好的文档字符串**。编写类型提示是提高 Python 代码质量的一个新方法。

> 在本文中，我将向您展示如何使用类型提示来增强您的 Python 代码！

**目标:**我会教你 Python 中类型提示的基础知识。完成基础知识之后，我将向您展示五个更棒的类型提示来增强您的 Python 代码。最后，我将解释随着 Python 3.9 的引入，类型提示是如何变得不那么麻烦的。

**先决条件:**你应该熟悉 Python 的基础知识。确保您运行的 Python 版本高于 Python 3.5。对于*动态类型*、*静态类型*或*类型提示*没有必要的先决条件。

# 理解动态类型和静态类型

首先我要解释一下术语**动态类型**和**静态类型。**在 Python 中，您可以在整个程序中任意多次更改变量的数据类型:

在 Python 中，变量的类型可以动态改变。

请注意上面的代码片段:

*   我在定义变量`my_variable`时没有指定它的数据类型。
*   我可以在整个 Python 程序中改变变量`my_variable`的数据类型。

> 简而言之，Python 有**动态类型**。

在一些编程语言(例如 Java)中，你需要在创建时指定变量的数据类型。此外，变量的数据类型在程序的后期不能改变。我们说这样的编程语言有**静态类型**。

用静态类型的语言编程可能看起来是一种负担。然而，用静态类型调试编程语言通常不那么麻烦。使用静态类型，您可以更早地发现错误并以最小的努力修复它们。

简单来说:

*   这是你调试动态类型时的表情😢
*   这是你调试静态类型时的表情😎

我将向您展示如何使用类型提示在 Python 中模拟静态类型！

> **趣闻:**动态分型有时也叫**鸭子分型**。术语来源于众所周知的说法:“如果它走路像**鸭**，叫声像**鸭**，那么它一定是**鸭。**

# 变量的 Python 类型提示

我将从以下类型提示的应用开始:

> 类型提示允许您指定变量的数据类型。

因为代码片段比文字更有说服力，所以看一下下面的例子:

类型提示的一个简单例子。

借助类型提示的力量，我已经指定`my_variable`应该是一个整数。那还不算太糟！😃

对于类型提示，您也可以使用标准数据类型，如`float`、`bool`和`string` 。以下代码片段记录了汽车的一些有用特性:

各种数据类型的类型提示。

如果您尝试在脚本中运行上面的代码片段，那么 Python 毫无怨言。一切看起来都很好！然而，这并不意味着 Python 会检查分配的类型是否正确。事实上，尝试运行以下代码:

错误的类型提示。

什么！？Python 不会用错误的类型提示给出任何错误😧

这是因为 Python 虽然理解类型提示的语法，但根本不关心它。

![](img/fef81695900c03ba4025c954efa7d2d5.png)

照片由[托尼克](https://unsplash.com/@thetonik_co?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

您将需要使用一个**外部类型检查器**来检查类型提示是否匹配所提供的变量**。**外部类型检查器**通常是一个外部 Python 模块。我将向您展示如何使用 **mypy** 模块进行外部类型检查。放心吧， **mypy** 好用！**

# 用 Mypy 检查类型提示

mypy 的一行描述如下:

> 如果在代码中加入类型提示，mypy 可以对代码进行类型检查，并找出常见的错误。

要安装 **mypy** ，使用 PIP(Python 的包安装程序)命令:

```
pip install mypy
```

如果这不起作用，则查看[文档](https://mypy.readthedocs.io/en/stable/getting_started.html)以获得安装帮助。使用以下代码行创建一个名为`simple_type_hint.py` 的文件:

简单类型提示。

打开你的终端，导航到你创建文件`simple_type_hint.py`的文件夹。然后运行命令:

```
python -m mypy simple_type_hint.py
```

这将显示以下消息:

```
**Success: no issues found in 1 source file**
```

看起来 mypy 对目前为止写的所有东西都很满意。我现在想故意破坏类型提示，看看会发生什么😈

将下面一行代码添加到`simple_type_hint.py`:

尝试中断到类型提示。

在上面的代码片段中，我用类型提示指定了`my_variable`应该是一个整数。尽管如此，我后来通过给`my_variable`赋值一个字符串来打破类型提示。

如果您将文件`simple_type_hint.py` 作为 Python 程序运行，那么不会像往常一样显示错误。但是，请尝试使用 mypy 命令:

```
python -m mypy simple_type_hint.py
```

这应该会显示类似下面的消息:

```
simple_type_hint.py:5: error: Incompatible types in assignment (expression has type “str”, variable has type “int”)Found 1 error in 1 file (checked 1 source file)
```

与 Python 不同，mypy 会检测出什么问题。上面的错误消息指定了行号(在我的例子中是 5)和发生的具体问题。

## 有用！！！

![](img/8a05055768f3d6d581e04b68e9b92da3.png)

[布鲁斯·马尔斯](https://unsplash.com/@brucemars?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

有一个工作实例感觉很棒，不管多简单🔥

> **有趣的事实:**在 mypy 的 GitHub 页面上，有一个来自 2019 年的问题(问题#6740)建议 mypy 不要再把自己称为**阿尔法软件**。术语 alpha 软件是指处于预发布/早期版本阶段的软件。Python 的创始人吉多·范·罗苏姆介入了讨论，澄清了一些事情:

> “我们在这里非常自嘲。我会毫不犹豫地称之为 mypy 产品质量，即超越测试版。”—范·罗森指南

# 函数的 Python 类型提示

大多数 Python 程序都有大量的函数。我现在将向您展示如何使用函数的类型提示。

在一个名为`simple_function.py` 的空文件中，我编写了下面这个简单的函数:

一个简单的函数检查整除 2。

函数`both_divisible_by_two`接受两个整数作为输入。然后检查它们是否能被 2 整除。很简单，对吧？现在我给函数`both_divisible_by_two`添加类型提示:

带有类型提示的简单函数。

请注意，只有`both_divisible_by_two`的第一行发生了变化:

*   我写了`a: int`和`b: int`来表示`both_divisible_by_two`的输入`a`和`b`应该是整数。
*   为了表明`both_divisible_by_two`的输出是一个布尔值，我使用了语法`-> bool`。

如果您现在运行通常的命令

```
python -m mypy simple_funciton.py
```

那么你应该得到令人满意的输出

```
**Success: no issues found in 1 source file.**
```

看起来棒极了！如果您有意做出错误的类型提示，检查 mypy 是否会有反应总是一个很好的明智之举。为了验证这一点，我将`both_divisible_by_two` 修改如下:

输出带有错误类型提示的简单函数。

如果您再次运行该命令

```
python -m mypy simple_funciton.py
```

那么您应该大致得到错误消息

```
simple_function.py:4: error: Incompatible return value type (got "bool", expected "str")Found 1 error in 1 file (checked 1 source file)
```

有用！😃

> **提示:**如果您在`both_divisible_by_two`中将输出的类型提示更改为`int` ，那么 mypy 将不会给出错误。你明白为什么吗？这还得归功于 Python 中一个微妙的实现细节:布尔类`bool` 是整数类`int` 下的一个子类
> 
> `0 <-> False`****`1 <-> True`。****
> 
> ****因此，在 Python 中，布尔值“是”整数。当您使用类型提示时，请记住这个细节！****

# ****如何将列表添加为类型提示****

****我们已经看到了如何给函数添加基本类型提示。如何输入变量应该是列表的提示？不幸的是，显而易见的方法(编写`list`)在 Python 版本 3.8 和更低版本中无效😒****

****您实际上需要进入内置模块`typing` 来获取列表的类型提示。让我打开一个名为`list_type_hints.py` 的新文件，并以下面一行开始:****

****从类型模块导入列表类型提示。****

****注意`List`是大写的。创建一个名为`append_element` 的函数，将一个值追加到给定的列表中:****

****一个简单的函数，向列表追加一个值。****

****到目前为止，一切顺利。如果为`data`参数传递一个字典，函数`append_element`将会崩溃。为确保这一点，您可以添加如下类型提示:****

****带有列表类型提示的简单函数。****

****如果用命令对文件`list_type_hints.py` 运行 mypy****

```
**python -m mypy list_type_hints.py**
```

****然后 mypy 报告以下内容:****

```
**list_type_hints.py:5: error: “append” of “list” does not return a valueFound 1 error in 1 file (checked 1 source file)**
```

****这是什么？好像 mypy 在我们的代码中发现了一个错误😱****

****有什么问题？在继续之前仔细检查 mypy 的回答。****

******解决方案:**列表方法`append` 就地修改列表但返回`None`。因此有了这个声明****

```
**return data.append(value)**
```

****将始终返回与****

```
**return None**
```

****要修复代码，您应该进行以下简单的编辑:****

****修复了简单函数。****

****马上发现问题，太牛逼了！这里，类型提示发现了一个通常的 Python 解释器不会提醒您的错误😎****

****类型提示还有一个额外的好处，那就是它们可以更好地记录代码。现在在`append_element`中可以清楚地看到`data`应该是一个列表。我也可以使用比`data`更具描述性的变量名。描述性变量名和类型提示都可以提高代码的质量。****

****到目前为止，传入`append_element`的列表中的元素可以是任何类型。例如，它可以是整数列表、字符串列表或由整数和字符串组成的列表。如果我只想接受一个整数列表，那么我可以如下修改代码:****

****指定列表中元素类型的类型提示。****

****注意，我把类型提示`List`换成了更具体的类型提示`List[int]`。现在列表输入和列表输出只能包含整数！****

> ******提示:**在`typing`模块中，还有字典`Dict`和元组`Tuple`等其他容器数据类型。我邀请你在需要的时候看看这些。****

# ****增强你的代码的五个令人敬畏的类型提示****

****![](img/ecbc2e8a283592782e4cf87d6540ad4c.png)****

****托马斯·凯利在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 拍摄的照片****

****现在，您已经熟悉了 Python 中类型提示的基础知识。因此，是时候学习一些更高级的特性了。我将向您展示五个令人敬畏的类型提示，它们将增强您的 Python 代码🐍****

## ****可迭代的****

****要求变量或函数参数应该是一个`List`有时过于严格。事实上，只要迭代是可能的，类型通常是可以接受的。对于这种情况，您可以使用`Iterable`类型提示。考虑下面的`print_everything`功能 **:******

****打印 iterable 中所有内容的函数。****

****现在可以对任何支持迭代的对象(例如列表、元组、字符串)调用函数`print_everything`。****

> ******提示:**在 Python 中，没有显式 return 语句的函数默认返回`None`。这就是我为函数`print_everything`的输出添加了`-> None` 类型提示的原因。****

## ****请求即付的****

****Python 是一种支持 [**高阶函数**](https://en.wikipedia.org/wiki/Higher-order_function) 的编程语言。这样做的结果是，您可以将函数作为参数传递给其他函数。考虑下面的`wrapper_print`函数:****

****一个愚蠢的包装函数。****

****属性`__name__`给出了函数的名称。注意`wrapper_print` 的输入和输出都是函数**。通过使用`Callable`类型提示，我可以将其指定为类型提示:******

****在包装函数中使用可调用类型提示。****

****当试图理解什么是可调用函数时，你经常会遇到这样的说法:“可调用函数是任何可以被调用的东西。”😑****

****如果你不确定，那么 Python 有内置的函数`callable`来拯救你。函数`callable`检查某个东西是否可调用。在日常编码中，当将`Callable`指定为类型提示时，你应该记住大部分函数。****

> ******提示:**放心，函数(独立函数和类方法)都是可调用的。相反，请确保数据类型`*int*`、`*float*`、`*bool*`、`*str*`、`*None*`、`*list*`、`*dict*`、`*tuple*`或`*set*`都是不可调用的。一个有趣的可调用实例是一个拥有 dunder 方法`*__call__*`的类的实例。****

## ****联盟****

****有时，要求变量或函数参数只能是单一类型过于严格。一个常见的例子是既可以是整数又可以是浮点数的变量。考虑类型提示****

****变量的浮点类型提示。****

****可以想见，`hourly_wage` 也可能是整数。您可以使用`Union`类型提示来指定许多类型提示:****

****使用联合类型提示。****

****在`Union`中，为变量指定每个适当的类型，用逗号分隔。请注意，这里有一个折衷的情况:通过使用`Union`添加许多类型提示，您可以获得更大的灵活性。然而，随着您的类型提示变得更加灵活，它们也变得不那么有用了。****

> ******提示:**在 Python 3.10 中，有一种全新的语法可用:您可以使用运算符`|`来分隔不同类型的提示，而不是使用`Union`。因此我们可以用 Python 3.10+中的`int | float`替换`Union[int, float]` 。****
> 
> ****到目前为止，大多数公司还没有使用 Python 3.10。因此，我建议通过使用`Union`来熟悉经典的语法。****

## ****可选择的****

****通常，函数中的某些参数默认设置为`None`。以下面的`lowercase_playlist`函数为例:****

****一种降低播放列表中歌曲音量的功能。****

****在`lowercase_playlist`中`songs` 参数默认设置为`None`。如果`songs`没有提供值，那么`songs` 将被设置为一个包含单曲*的列表“一切都很棒！”。* 最后，我们用列表理解的方式返回歌曲的小写版本。****

****您可以编写`Union[List, None]`为`lowercase_playlist`提供输入类型提示。但是，这种情况非常普遍，因此有一种特殊的简写语法`Optional[List]`:****

****小写函数的可选类型提示。****

******提示:**函数中的默认参数不应该使用**可变对象**(如列表)。这样做经常会导致恼人的臭虫。关于这个问题，我推荐艾尔·斯威加特的新书《超越蟒蛇的基本技能》第八章[](https://inventwithpython.com/beyond/)****。********

## ******任何的******

******最后，您可以通过`Any`提供一个包罗万象的类型提示。Python 文档简单地指出:******

> ******`Any` -特殊类型表示无约束类型。每种类型都与`Any`兼容。`Any`兼容各型。******

******在可以省略类型提示的情况下，为什么还需要`Any`？😕******

******在我看来，`Any`的主要用途是向其他开发人员表明，缺少限制性类型提示是一种有意识的选择。如果您只是没有指定类型提示，那么其他开发人员可能会开始怀疑:******

> ******马克忘记在这里添加类型提示了吗？他马虎了吗？嗯…******

******关注你的开发伙伴，在适当的时候使用`Any`类型的提示。******

# ******为什么所有酷小孩都用 Python 3.9+******

******![](img/ed2abd86e0f42135dbe200f61f1cff8a.png)******

******丹尼尔·林肯在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 拍摄的照片******

******在 Python 3.9 之前，如果想提供类型提示，需要从`typing`模块导入`List`和`Dict`。******

## ******不再有了！******

******在 Python 3.9 中，终于有了对列表和字典类型提示的原生支持。这意味着您不需要使用`typing`模块来导入`List`和`Dict`进行类型提示。在 Python 3.9+中，可以使用小写的`list`和`dict`作为类型提示:******

******使用列表和字典进行类型提示的新 Python 3.9+语法。******

> ********提示:** *在 Python 3.9 之前，从* `*typing*` *模块导入* `*List*` *和* `*Dict*` *时必须大写。*这是为了避免覆盖内置的`list()`和`dict()`构造函数。在 Python 3.9+中，您可以安全地使用小写版本的`list`和`dict`作为类型提示，而不用覆盖任何内容。******

****啊！唯一比更少的导入更好的是语法一致性😍****

# ****总结和更多资源****

****在本文中，我介绍了 Python 中的类型提示。类型提示是在 Python 代码中加入一些静态类型的现代方法。****

## ****更多资源****

****对于求知欲极强的皮托尼斯塔来说，没有比 pep 484 T1 更好的起点了。此外，mypy 的酷人们还做了一份很棒的[小抄](https://mypy.readthedocs.io/en/stable/cheat_sheet_py3.html)。****

> ******提示:**你可以在你的项目中一点一点地加入类型提示。将部分代码静态类型化，而将其余部分动态类型化是没有问题的。****

## ****更多类似内容？****

****如果你喜欢我的文章，那么看看我的其他博客文章，比如[作为数据科学家学习一些前端 Web 开发](/learn-some-front-end-web-development-as-a-data-scientist-da662dde6d22)和 [5 个可以在紧要关头拯救你的牛逼 NumPy 函数](/5-awesome-numpy-functions-that-can-save-you-in-a-pinch-ba349af5ac47)。如果你对数据科学、编程或任何介于两者之间的东西感兴趣，欢迎在 LinkedIn 上加我，并向✋问好****