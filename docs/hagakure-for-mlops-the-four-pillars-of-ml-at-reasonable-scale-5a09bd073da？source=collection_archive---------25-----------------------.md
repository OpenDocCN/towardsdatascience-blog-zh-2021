# MLOps 的 Hagakure:合理规模的 ML 的四大支柱

> 原文：<https://towardsdatascience.com/hagakure-for-mlops-the-four-pillars-of-ml-at-reasonable-scale-5a09bd073da?source=collection_archive---------25----------------------->

## [在启动阶段有效地进行 ML](https://towardsdatascience.com/tagged/mlops-without-much-ops)

## 没有太多操作的 MLOps 第 3 集

与[安德里亚·波洛尼奥利](https://medium.com/u/97c0c65d3de7?source=post_page-----5a09bd073da--------------------------------)和[雅格布·塔利亚布埃](https://medium.com/u/bffd30619c10?source=post_page-----5a09bd073da--------------------------------)

![](img/aab2677e47265b70b922e22ba5eec616.png)

[朱伟](https://unsplash.com/@zhuwei5021?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍照

> "不要用弓箭杀死蚊子."
> 
> 孔子

在本系列的[上一集](/ml-and-mlops-at-a-reasonable-scale-31d2c0782d9c)中，我们探讨了我们所谓的“合理规模”(RS)，给出了一个有点松散的定义，旨在把握我们认为许多公司目前在 ML 方面所处的状况。

鉴于 RS 公司必须面对的许多重大挑战，本文将阐述一个基于四个主要哲学支柱的框架，同时将这些原则应用到现实世界的问题中。

在提出我们在不断变化的现代传销环境中对传销从业者的实践和精神指导之前——我们对合理规模的传销的[**haga kure**](https://en.wikipedia.org/wiki/Hagakure)**—***——让我们简单回顾一下 RS 公司面临和解决的主要挑战*。**

*当在真实的公司中做出实际的选择时，我们在上一篇文章中描述的约束有无数的分支。这部分是由于制约因素的异质性。RS 公司必须始终考虑工程资源、数据量、数据质量、团队规模、用例以及此类用例的货币影响等一系列问题。一个特定组织内部的确切图景可能取决于许多因素，我们应该期望它对该组织来说是有些独特的，这使得很难提出一个单一的成功秘诀。*

*令人眼花缭乱的 MLOps 供应商并没有让事情变得更简单(见[这里](https://huyenchip.com/2020/12/30/mlops-v2.html)和[这里](https://mattturck.com/data2021/))。虽然一些公司倾向于可以在整个 ML 堆栈中采用的端到端解决方案，如 [Databricks](https://databricks.com/) ，但该行业最近见证了一场快速而无情的功能整合运动。换句话说，越来越多的公司(目前主要是初创公司)正在为 ML 周期的所有步骤开发更成熟的解决方案，从数据仓库到模型部署。现在，这种前景的发展总体上有助于提供一套连贯的解决方案，这些解决方案可以相互集成，但事实是，这个领域的大多数参与者都是独立行动的，这给 ML 从业者留下了一个艰巨的任务，即找到正确的方法来选择他们的工具，并以连贯的方式将它们组合在一起。*

*因此，再一次，就像每一次对智慧的追求一样，我们的任务是制定一个原则性的框架，而不是指向一个具体的解决方案。由于我们全心全意地赞同精神指导只有在实践中有用才是好的这一观点，我们希望确保这样一个框架能够解决遥感公司的现实问题。*

# ***规模合理的 ML 四大支柱***

*![](img/8ac7bc7a97eb2d30b4c8342cad1d9a9b.png)*

*杰里米·珀金斯在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片*

> *一 *Data is superior to modeling.**
> 
> *二 *Log then transform.**
> 
> *三 *PaaS & FaaS is preferable to IaaS.**
> 
> *四 *Vertical cuts deeper than distributed.**

# *一 DATA IS SUPERIOR TO MODELING*

> *RS 公司更大的边际收益总是在于拥有干净和可访问的数据:好的数据比建模和模型架构的相对改进更重要。*

*总的来说，行业似乎进入了一个新的阶段，模型功能变得越来越商品化，可能是因为我们在建模方面变得越来越好，开箱即用的模型变得足够引人注目。这一点很重要，因为在内部构建非常有竞争力的模型已经成为 RS 公司的一项更大的投资，而 ROI 可能没有太大意义。*

*在这种情况下，从战略角度来看，专有数据流至关重要，尤其是对于遥感公司。举个例子，由 [Chris Re](https://github.com/hazyresearch/data-centric-ai) 和最近由[吴恩达](https://www.youtube.com/watch?v=06-AZXmwHjo)倡导的以数据为中心的人工智能框架，它专注于[数据集优化](/how-i-won-andrew-ngs-very-first-data-centric-ai-competition-e02001268bda)以提供一个坚实的基础，其中数据收集受到限制，训练样本天生稀缺，迭代不可能超快(你可能记得我们的[第二集](/ml-and-mlops-at-a-reasonable-scale-31d2c0782d9c)，这是 RS 的关键原则)。*

> *这一原则的第一个结果是，数据摄取是您的 MLOps 周期的一等公民，获得清晰的数据应该是最终目标。*

*简单地说，数据摄取必须包括通过标准获取数据。你可以选择一个已经存在的特定领域的协议(例如 [Google Analytics](https://developers.google.com/analytics) 用于浏览事件),或者如果你的数据对你的业务来说有些独特，你可以提出自己的标准。*

*然而底线是相同的:两个描述完全相同事物的事件绝不会有不同的结构。例如，假设我们正在构建一个推荐系统，我们正在从不同的电子商务网站收集添加到购物车的操作:在任何情况下，来自*网站 A* 的添加到购物车事件都不应该与来自*网站 B* 的[添加到购物车事件](https://developers.google.com/analytics/devguides/collection/ua/gtm/enhanced-ecommerce#cart)不同。对于这条规则的每一个例外，迟早都要付出代价。*

*与标准化这一点密切相关，我们可以补充一点关于**严格验证和拒绝**。一般来说，即使事件不符合约定的标准格式，也不应该被拒绝。系统应该标记所有格式错误的事件，将它们发送到不同的路径，并通知警报系统。虽然形式不良的事件不会出现在我们的表中是非常重要的，但知道什么时候出错也是非常重要的。*

# *二 Log then transform*

> *数据接收和处理之间的明确分离产生了可靠且可重复的数据管道。数据仓库应该包含系统在任何给定时间的每个状态的不可变的原始记录。*

*因此，数据管道应该总是从原始事件构建，并在流和处理之间实现明显的分离。前者的作用是保证任何给定系统状态的真实快照，后者是为最终目的准备数据的引擎。*

> *关键的区别在于，流的输出是不可变的，而处理的输出总是可以撤消和修改的。如果您从小就认为数据库是关于写入和转换数据的，那么这里的想法有些违反直觉，但是它的核心非常简单:模型总是可以固定的，而数据却不能。*

*这个原则的北极星是你的系统是否允许**可重复性**。主要的问题是:你能在数据转换、查询或模型中改变一些东西，然后重放自时间开始以来你摄取的所有数据，而没有任何大问题(时间除外)吗？如果答案是肯定的，那么您成功地将这一原则应用到了您的数据基础架构中。如果答案是否定的，你真的应该试着把它变成肯定的，在不可能的情况下，尽可能地接近它。*

*在我们系列的下一集，我们将更详细地讨论数据摄取以及流和处理之间的分离，我们还将分享基于[雪花](https://www.snowflake.com/) + [dbt](https://www.getdbt.com/) 的开源实现。*

# *三 PaaS & FaaS is preferable to IaaS*

> *专注是 RS 的精髓。不要构建和管理 ML 管道的每个组件，而是采用完全托管的服务来运行计算。*

*RS 公司的主要特点是，它们在 ML 计划的资源方面受到这样或那样的限制。当然，当资源有限时，将资源投入到最重要的业务问题中是一种很好的做法。例如，假设您正在构建一个推荐系统，您可能希望尽可能地专注于提供好的推荐。就这么简单。*

*当然，倾向于完全托管服务的方法在硬成本方面往往更昂贵，但与此同时，数据科学家可以不必担心停机、复制、自动扩展等问题。所有这些都是必要的，但这并不意味着它们是您的 ML 应用程序的中心，根据我们的经验，让您的组织专注于核心业务问题的好处往往超过低成本的好处(当然，在合理的范围内)。因为由专门的人员维护和扩展基础设施仍然很昂贵，所以最终很容易就会比支付和管理少数新提供商的费用高得多。*

> *此外，建设和维护基础设施最糟糕的一点是，随着时间的推移，实际成本是不可预测的。不仅很容易低估长期所需的全部努力，而且每次你为了构建一个基础设施而创建一个团队时，你都引入了人的因素的典型的不可预测性。*

*最终需要多少人？他们会在一年后被公司吸收吗？组织内的护城河是因为角色的过度分离还是因为一些团队的唯一目的是保持基础设施的正常运行？*

*消费账单很少有积极的方面，但有一点是肯定的，那就是它们很容易预测。如果你想更大规模地预测成本，你可以将你的账单乘以任何你认为能抓住你成长道路下一阶段的数字。*

# *四 Vertical cuts deeper than distributed.*

> *RS 公司不需要在每一步都进行分布式计算。高效的垂直设计可以实现很多目标。*

*这可能是我们做出的最有争议的声明，但是坚持我们的观点，这是有原因的。分布式系统，如 [Hadoop](https://hadoop.apache.org/) 和 [Spark](https://spark.apache.org/documentation.html) ，在大数据革命中发挥了关键作用。仅仅在五年前，Spark 几乎是大规模进行 ML 的唯一选择。世界各地的初创公司都使用 Spark(我们也不例外)进行流传输，SparkSQL 进行数据探索，MLlib 进行功能选择和构建 ML 管道。*

*然而，它们使用起来很麻烦，很难调试，而且它们还强制许多科学家不熟悉的编程模式，这对新员工的增加时间有非常负面的影响。*

> *我们想表达的观点很简单:如果你是一家 RS 公司，你要处理的数据量不需要无处不在的分布式计算:有了好的垂直设计，就有可能在显著改善开发人员体验的同时完成大部分工作。*

*总的想法是，您的 ML 管道应该被视为贯穿许多模块化步骤实现的 DAG。现在，虽然其中一些可能需要更多的计算能力，但是重要的是从 ML 开发的过程和经验中抽象出计算部分。*

*分布式计算应该用于它真正的用途:解决大量复杂的数据问题。对于其他所有事情，更实际的做法是在单独的盒子中运行管道中的步骤，在云基础设施*中扩展计算，并且只在*中扩展需要的步骤，例如 [Metaflow](https://metaflow.org/) 允许这样做。*

*在我们的经验中，这种观点的转变对任何 ML 团队的开发人员体验都有巨大的影响，因为它会给数据科学家一种在本地开发的感觉，而不必一直经历处理分布式计算的重重困难和障碍。*

# ***爱你的开发者:关于垂直独立性的推论。***

*最后两点旨在尽可能地从 ML 开发者那里抽象出基础设施。这种哲学有很好的理由存在。*

*我们希望鼓励 ML 团队的纵向独立性。ML 中的许多工作在很大程度上取决于所解决问题的类型，因此数据科学家需要能够根据数据集、数据类型、算法和安全约束对工具、架构和建模做出合理的独立选择。此外，ML 系统不是针对静态环境部署的，因此数据科学家需要了解数据中的变化、模型中的变化、敌对攻击等等。我们倾向于纵向独立，而不是嵌入到高度条块化的组织中，因为在这种情况下过度专业化会导致高协调成本、低迭代率和适应环境变化的困难。最后，我们痛苦地意识到，在 RS 公司必须进行预算的所有资源中，最稀缺的是优秀的工程师。*

> *我们认为，在吸引和留住 RS 公司的关键人才方面，垂直独立性非常重要。[我们经常听到](https://know.anaconda.com/rs/387-XNW-688/images/Anaconda-SODS-Report-2020-Final.pdf)数据科学家仍然将相当大一部分时间投入到低影响任务中，例如数据准备、简单分析、基础设施维护以及更普遍的跳过繁琐流程的束缚。*

*根据我们的经验，优秀的工程师和数据科学家会对使用最好的工具做前沿工作感到兴奋。糟糕的开发体验以及无法看到他们的工作在生产中的影响是数据科学家感到沮丧的主要原因之一。我们都知道，沮丧的工程师更有可能在 LinkedIn 上回复招聘人员的信息。*

*纵向独立在创新速度、最小化、精简和自由方面获得回报:RS 组织最有价值的硬币。让您的数据科学家拥有从获取数据到生产测试的整个周期的可能性，让他们尽可能容易地在整个端到端管道的不同阶段来回移动，并赋予他们权力。这样做，他们会开发出具有真正商业价值的可靠应用程序，让你大吃一惊。*

# *无耻的下一个帖子的悬念*

*这些是我们在 RS 规模生产中 ML 的原则。采用它们使我们能够成功地大规模工作，同时最大限度地减少所有可能的基础架构问题，否则我们将不得不处理这些问题。请记住，我们所做的一切都是受 RS 公司所受约束的激励。最终目标永远是做 DataOps 和 MLOps，而不做太多的 Ops。*

> *在下一篇文章中，我们将更深入地探讨前两个原则，并设计出一个具体的数据接收和数据处理管道示例，它完全可以用[无服务器](https://aws.amazon.com/lambda/serverless-architectures-learn-more/#:~:text=A%20serverless%20architecture%20is%20a,management%20is%20done%20by%20AWS)、雪花和 [dbt](https://www.getdbt.com/) 来重现。*

# *承认*

*如果没有我们*开源贡献者*的承诺，这个系列是不可能的:*

*   *Patrick John Chia :局部流量和基线模型；*
*   *Luca Bigon :通用工程和基础优化；*
*   *Andrew Sutcliffe :远程流；*
*   *Leopoldo Garcia Vargas :质量保证和测试。*