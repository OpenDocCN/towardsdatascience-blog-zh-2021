# ä¸ Docker å’Œ Jenkins çš„ MLOps:è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ ç®¡é“

> åŸæ–‡ï¼š<https://towardsdatascience.com/mlops-with-docker-and-jenkins-automating-machine-learning-pipelines-a3a4026c4487?source=collection_archive---------7----------------------->

## å¦‚ä½•ç”¨ Docker å°†ä½ çš„ ML æ¨¡å‹å®¹å™¨åŒ–ï¼Œç”¨ Jenkins å°†ç®¡é“è‡ªåŠ¨åŒ–

![](img/41ce528d640fc4064b4fb9418d99a06d.png)

åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šç”± [Bernd Dittrich](https://unsplash.com/@hdbernd?utm_source=medium&utm_medium=referral) æ‹æ‘„çš„ç…§ç‰‡

# ä»‹ç»

è¿™ç¯‡æ–‡ç« çš„ç›®çš„æ˜¯æä¾›ä¸€ä¸ªä¾‹å­ï¼Œè¯´æ˜æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ Docker å’Œ Jenkins è¿™æ ·çš„ DevOps å·¥å…·æ¥è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ ç®¡é“ã€‚åœ¨è¿™ç¯‡æ–‡ç« çš„æœ€åï¼Œä½ å°†çŸ¥é“å¦‚ä½•ç”¨ Docker å°è£…ä¸€ä¸ªæœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œå¹¶ä½¿ç”¨ Jenkins åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œè¯¥ç®¡é“è‡ªåŠ¨å¤„ç†åŸå§‹æ•°æ®ï¼Œè®­ç»ƒæ¨¡å‹ï¼Œå¹¶åœ¨æ¯æ¬¡æˆ‘ä»¬å¯¹æˆ‘ä»¬çš„å­˜å‚¨åº“è¿›è¡Œæ›´æ”¹æ—¶è¿”å›æµ‹è¯•å‡†ç¡®æ€§ã€‚

è¿™ä¸ªå¸–å­éœ€è¦çš„æ‰€æœ‰ä»£ç éƒ½å¯ä»¥åœ¨ [Github](https://github.com/Adricarpin/MLOps-with-Docker-and-Jenkins) ä¸­æ‰¾åˆ°ã€‚

å¯¹äºè¿™é¡¹ä»»åŠ¡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨[æˆäººäººå£æ™®æŸ¥æ”¶å…¥æ•°æ®é›†](https://www.kaggle.com/uciml/adult-census-income)ã€‚ç›®æ ‡å˜é‡æ˜¯æ”¶å…¥:ä¸€ä¸ªäºŒå…ƒå˜é‡ï¼Œè¡¨ç¤ºä¸ªäººå¹´æ”¶å…¥æ˜¯å¦è¶…è¿‡ 5 ä¸‡è‹±é•‘ã€‚

ğŸ“’æ³¨æ„:ç”±äºæœ¬æ–‡çš„ç›®çš„æ˜¯è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ ç®¡é“ï¼Œæˆ‘ä»¬ä¸ä¼šæ·±å…¥ç ”ç©¶ EDAï¼Œå› ä¸ºè¿™è¶…å‡ºäº†èŒƒå›´ã€‚å¦‚æœä½ å¯¹æ­¤æ„Ÿåˆ°å¥½å¥‡ï¼Œä½ å¯ä»¥æŸ¥çœ‹è¿™ä¸ª [Kaggle ç¬”è®°æœ¬](https://www.kaggle.com/adro99/from-na-ve-to-xgboost-and-ann-adult-census-income)ï¼Œä½†è¿™å¹¶ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä»¥ä¾¿äº†è§£è¿™é‡Œåšäº†ä»€ä¹ˆã€‚

å¥½ï¼Œé‚£æˆ‘ä»¬å¼€å§‹å§ï¼

# åˆ¶å®šæˆ˜ç•¥

åœ¨å¼€å§‹ç¼–ç ä¹‹å‰ï¼Œæˆ‘è®¤ä¸ºé‡è¦çš„æ˜¯ç†è§£è®¡åˆ’æ˜¯ä»€ä¹ˆã€‚å¦‚æœä½ çœ‹ä¸€ä¸‹ [Github åº“](https://medium.com/@adro99/mlops-with-docker-and-jenkins-automating-machine-learning-pipelines-a3a4026c4487)ä½ ä¼šçœ‹åˆ°ä¸‰ä¸ª python è„šæœ¬:é€šè¿‡æŸ¥çœ‹å®ƒä»¬çš„åå­—å°±å¾ˆå®¹æ˜“çŸ¥é“å®ƒä»¬æ˜¯åšä»€ä¹ˆçš„:)ã€‚æˆ‘ä»¬è¿˜æœ‰åŸå§‹æ•°æ®é›†:æˆäºº. csv å’Œä¸€ä¸ª docker æ–‡ä»¶(æˆ‘ä»¬å°†åœ¨åé¢è®¨è®º)ã€‚ä½†ç°åœ¨æˆ‘æƒ³è®©ä½ äº†è§£è¿™ä¸ªé¡¹ç›®çš„å·¥ä½œæµç¨‹ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯äº†è§£æˆ‘ä»¬çš„ Python è„šæœ¬çš„è¾“å…¥å’Œè¾“å‡ºæ˜¯ä»€ä¹ˆ:

![](img/2b579552ece15d6e0105b49c2c2eeadb.png)

ä½œè€…å›¾ç‰‡

æ­£å¦‚æˆ‘ä»¬åœ¨å›¾ä¸­çœ‹åˆ°çš„ï¼Œpreprocessing.py å°†åŸå§‹æ•°æ®ä½œä¸ºè¾“å…¥ï¼Œè¾“å‡ºå¤„ç†åçš„æ•°æ®ï¼Œåˆ†æˆè®­ç»ƒå’Œæµ‹è¯•ä¸¤éƒ¨åˆ†ã€‚train.py å°†è®­ç»ƒå¤„ç†åçš„æ•°æ®ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¾“å‡ºæ¨¡å‹å’Œä¸€ä¸ª json æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­å­˜å‚¨éªŒè¯å‡†ç¡®æ€§ã€‚test.py å°†æµ‹è¯•å¤„ç†åçš„æ•°æ®å’Œæ¨¡å‹ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¾“å‡ºä¸€ä¸ªå…·æœ‰æµ‹è¯•ç²¾åº¦çš„ json æ–‡ä»¶ã€‚

è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€å †å¿…é¡»æŒ‰ä¸€å®šé¡ºåºè¿è¡Œçš„è„šæœ¬ï¼Œå®ƒä»¬åˆ›å»ºäº†ä¸€å †æˆ‘ä»¬éœ€è¦å­˜å‚¨å’Œè®¿é—®çš„æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¸Œæœ›è‡ªåŠ¨åŒ–æ‰€æœ‰è¿™ä¸€è¿‡ç¨‹ã€‚

ç°åœ¨ï¼Œå¤„ç†è¿™ä¸ªé—®é¢˜çš„æœ€å¥½æ–¹æ³•æ˜¯ä½¿ç”¨ Docker:ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ç¯å¢ƒï¼Œæ‹¥æœ‰è¿è¡Œä½ çš„ä»£ç æ‰€éœ€çš„æ‰€æœ‰ä¾èµ–å…³ç³»(è§£å†³â€œå®ƒåœ¨æˆ‘çš„æœºå™¨ä¸Šå·¥ä½œâ€çš„é—®é¢˜ï¼)é‚£å°±æ›´å®¹æ˜“äº†ã€‚ä¸€æ—¦æˆ‘ä»¬æœ‰äº†è¿™äº›ï¼Œæˆ‘ä»¬å°±èƒ½è‡ªåŠ¨å¤„ç† Jenkins çš„æ‰€æœ‰æµç¨‹ã€‚

Docker åŸºäº 3 ä¸ªæ¦‚å¿µ:å®¹å™¨ã€å›¾åƒå’Œ Docker æ–‡ä»¶ã€‚ä¸ºäº†ä¸ Docker åˆä½œï¼Œäº†è§£ä»–ä»¬çš„å·¥ä½œæ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰å®ƒä»¬ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç›´è§‚çš„å®šä¹‰:

*   å®¹å™¨:ä¸€ä¸ªæ ‡å‡†çš„è½¯ä»¶å•å…ƒï¼Œå®ƒæ‰“åŒ…äº†è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„ä¸€åˆ‡(ä¾èµ–é¡¹ã€ç¯å¢ƒå˜é‡â€¦â€¦)
*   Dockerfile:è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­å®šä¹‰ä½ æƒ³åœ¨å®¹å™¨ä¸­åŒ…å«çš„æ‰€æœ‰å†…å®¹ã€‚
*   å›¾ç‰‡:è¿™æ˜¯è¿è¡Œå®¹å™¨æ‰€éœ€çš„è“å›¾ã€‚æ‚¨å¯ä»¥é€šè¿‡æ‰§è¡Œ Dockerfile æ–‡ä»¶æ¥æ„å»ºæ˜ åƒã€‚

æ‰€ä»¥ï¼Œä¸ºäº†ä½¿ç”¨ Dockerï¼Œä½ å°†éµå¾ªä»¥ä¸‹æ­¥éª¤:

1.  å®šä¹‰ Dockerfile æ–‡ä»¶
2.  å»ºç«‹å½¢è±¡
3.  è¿è¡Œé›†è£…ç®±
4.  åœ¨å®¹å™¨å†…è¿è¡Œå‘½ä»¤

æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ã€‚

# å®šä¹‰ Dockerfile æ–‡ä»¶

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¿…é¡»å®šä¹‰è¿è¡Œç®¡é“æ‰€éœ€çš„ä¸€åˆ‡ã€‚ä½ å¯ä»¥çœ‹ä¸€ä¸‹[åº“](https://github.com/Adricarpin/MLOps-with-Docker-and-Jenkins)ä¸­çš„ Dockerfileï¼Œä½†æ˜¯å¦‚æœä½ ä¸ç†Ÿæ‚‰è¯­æ³•ï¼Œä¸€å¼€å§‹å¯èƒ½ä¼šæœ‰äº›ä¸çŸ¥æ‰€æªã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œè¦åšçš„æ˜¯è°ˆè®ºæˆ‘ä»¬æƒ³è¦åœ¨å®ƒé‡Œé¢æŒ‡å®šä»€ä¹ˆï¼Œå¹¶ä¸”ä¸€æ­¥ä¸€æ­¥åœ°çœ‹è¯­æ³•ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šæˆ‘ä»¬å¸Œæœ›åœ¨å“ªé‡Œè¿è¡Œç®¡é“ã€‚å¯¹äºå¤§å¤šæ•°å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºï¼Œäººä»¬ä¼šé€‰æ‹©è½»é‡çº§çš„ Linux å‘è¡Œç‰ˆï¼Œæ¯”å¦‚ alpineã€‚ç„¶è€Œï¼Œå¯¹äºæˆ‘ä»¬çš„ç®¡é“ï¼Œæˆ‘ä»¬å°†åªä½¿ç”¨ä¸€ä¸ªåä¸º`jupyter/scipy-notebook`çš„ jupyter å›¾åƒã€‚åœ¨ Dockerfile æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šä»¥ä¸‹å‘½ä»¤:

```
FROM jupyter/scipy-notebook
```

ç„¶åï¼Œæˆ‘ä»¬å¿…é¡»å®‰è£…ä¸€äº›è½¯ä»¶åŒ…ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨å‘½ä»¤`RUN`:

```
USER root RUN apt-get update && apt-get install -y jq RUN pip install joblib
```

ğŸ“’æ³¨æ„:ç°åœ¨è¿™å¯èƒ½æ²¡æœ‰å¤šå¤§æ„ä¹‰ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦`jq`æ¥è®¿é—® json æ–‡ä»¶ä¸­çš„å€¼ï¼Œè¿˜éœ€è¦`joblib`æ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¨¡å‹ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è¦è®¾ç½®çš„æ˜¯å®¹å™¨ä¸­æ–‡ä»¶çš„åˆ†å¸ƒã€‚æˆ‘ä»¬æƒ³å»ºé€ ä¸€ä¸ªå†…éƒ¨å…·æœ‰è¿™ç§ç»“æ„çš„å®¹å™¨:

![](img/81f3e23bdae58c7e6fca0934aab76c39.png)

ä½œè€…å›¾ç‰‡

ğŸ“’æ³¨æ„:â€œå·¥ä½œâ€æ–‡ä»¶å¤¹ç”± Docker è‡ªåŠ¨ç”Ÿæˆã€‚æˆ‘ä»¬ä¸ä¼šåœ¨é‡Œé¢æ”¾ä»»ä½•ä¸œè¥¿ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºæ–‡ä»¶å¤¹:

```
RUN mkdir model raw_data processed_data results
```

ç„¶åæˆ‘ä»¬å°†ç›®å½•è®¾ç½®ä¸ºç¯å¢ƒå˜é‡(è¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šåœ¨æ•´ä¸ªä»£ç ä¸­ç¡¬ç¼–ç è·¯å¾„)

```
ENV MODEL_DIR=/home/jovyan/modelENV RAW_DATA_DIR=/home/jovyan/raw_dataENV PROCESSED_DATA_DIR=/home/jovyan/processed_dataENV RESULTS_DIR=/home/jovyan/resultsENV RAW_DATA_FILE=adult.csv
```

æœ€åï¼Œæˆ‘ä»¬è®¾ç½®ä»å­˜å‚¨åº“ä¸­å¤åˆ¶è„šæœ¬å’ŒåŸå§‹æ•°æ®çš„é¡ºåºã€‚ä¸€æ—¦æˆ‘ä»¬åˆ›å»ºäº†å®¹å™¨ï¼Œå®ƒä»¬å°±ä¼šè¢«ç²˜è´´åˆ°æˆ‘ä»¬çš„å®¹å™¨ä¸­ã€‚

```
COPY adult.csv ./raw_data/adult.csv COPY preprocessing.py ./preprocessing.py COPY train.py ./train.py COPY test.py ./test.py
```

# å»ºç«‹å½¢è±¡

ä¸€æ—¦æˆ‘ä»¬æŒ‡å®šäº† docker æ–‡ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„å»ºæ˜ åƒäº†ã€‚æ‰§è¡Œæ­¤æ“ä½œçš„å‘½ä»¤æ˜¯:

```
sudo -S docker build -t adult-model .
```

æˆ‘ä»¬ç”¨`-t adult-model` (-t ä»£è¡¨æ ‡ç­¾)æŒ‡å®šå›¾åƒçš„åç§°ï¼Œç”¨`.`æŒ‡å®š Dockerfile çš„è·¯å¾„ã€‚Docker ä¼šè‡ªåŠ¨é€‰æ‹©åä¸ºâ€œDockerfileâ€çš„æ–‡ä»¶ã€‚

# è¿è¡Œå®¹å™¨

ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå›¾åƒ(ä¸€ä¸ªå®¹å™¨çš„è“å›¾)ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªå®¹å™¨äº†ï¼

ğŸ“’æ³¨æ„:æˆ‘ä»¬å°†åªæ„å»ºä¸€ä¸ªå®¹å™¨ï¼Œä½†æ˜¯å¦‚æœä½ ä¸çŸ¥é“ï¼Œä¸€æ—¦æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå›¾åƒï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„å»ºä»»æ„å¤šçš„å®¹å™¨äº†ï¼è¿™å¸¦æ¥äº†å¹¿æ³›çš„å¯èƒ½æ€§ã€‚

è¿è¡Œå®¹å™¨çš„å‘½ä»¤å¦‚ä¸‹:

```
sudo -S docker run -d --name model adult-model
```

å…¶ä¸­-d æ ‡å¿—è¡¨ç¤ºåˆ†ç¦»(åœ¨åå°è¿è¡Œå®¹å™¨)ã€‚æˆ‘ä»¬å°†å…¶å‘½åä¸ºâ€œæ¨¡å‹â€ï¼Œå¹¶æŒ‡å®šæˆ‘ä»¬ä½¿ç”¨çš„å›¾åƒ(æˆäººæ¨¡å‹)ã€‚

# åœ¨å®¹å™¨å†…è¿è¡Œå‘½ä»¤

ç°åœ¨æˆ‘ä»¬å·²ç»è¿è¡Œäº†æˆ‘ä»¬çš„å®¹å™¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨`docker exec`åœ¨é‡Œé¢è¿è¡Œå‘½ä»¤ã€‚åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŒ‰é¡ºåºæ‰§è¡Œè„šæœ¬ï¼Œç„¶åæ˜¾ç¤ºç»“æœã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å®ç°:

*   è¿è¡Œé¢„å¤„ç†. py

```
sudo -S docker container exec model python3 preprocessing.py
```

*   è¿è¡Œ train.py

```
sudo -S docker container exec model python3 train.py
```

*   è¿è¡Œ test.py

```
sudo -S docker container exec model python3 test.py
```

*   æ˜¾ç¤ºéªŒè¯å‡†ç¡®æ€§å’Œæµ‹è¯•å‡†ç¡®æ€§

```
sudo -S docker container exec model cat \
/home/jovyan/results/train_metadata.json \
/home/jovyan/results/test_metadata.json
```

ğŸ“’æ³¨æ„:å¦‚æœä½ è¶³å¤Ÿå¥½å¥‡(æˆ‘çŒœä½ æ˜¯)ï¼Œä½ ä¼šæƒ³çŸ¥é“æ¯ä¸ªè„šæœ¬å®é™…ä¸Šæ˜¯åšä»€ä¹ˆçš„ã€‚åˆ«æ‹…å¿ƒï¼Œå¦‚æœä½ ç†Ÿæ‚‰åŸºæœ¬çš„æœºå™¨å­¦ä¹ å·¥å…·(è¿™é‡Œæˆ‘åŸºæœ¬ç”¨çš„æ˜¯ç†ŠçŒ«å’Œ SKlearn åº“)ï¼Œä½ å¯ä»¥æ‰“å¼€è„šæœ¬çœ‹ä¸€ä¸‹ä»£ç ã€‚æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„å¤§éƒ¨åˆ†å°è¯éƒ½è¢«è¯„è®ºäº†ã€‚å¦‚æœä½ æƒ³æ·±å…¥äº†è§£æˆ–è€…ä½ æ­£åœ¨å¯»æ‰¾æ¯”è¿™é‡Œæ˜¾ç¤ºçš„æ›´å¤æ‚çš„æ¨¡å‹ï¼Œä½ å¯ä»¥çœ‹çœ‹[è¿™ä¸ªç¬”è®°æœ¬](https://www.kaggle.com/adro99/from-na-ve-to-xgboost-and-ann-adult-census-income)ã€‚

# æµ‹è¯•æ­¥éª¤

åœ¨æ„å»ºç®¡é“æ—¶ï¼Œé€šå¸¸ä¼šæœ‰ä¸€ä¸ªä¸“é—¨çš„æ­¥éª¤æ¥æµ‹è¯•åº”ç”¨ç¨‹åºæ˜¯å¦æ„å»ºè‰¯å¥½ï¼Œæ˜¯å¦è¶³ä»¥éƒ¨ç½²åˆ°ç”Ÿäº§ä¸­ã€‚åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªæ¡ä»¶è¯­å¥æ¥æµ‹è¯•éªŒè¯å‡†ç¡®æ€§æ˜¯å¦é«˜äºé˜ˆå€¼ã€‚å¦‚æœæ˜¯ï¼Œåˆ™éƒ¨ç½²è¯¥æ¨¡å‹ã€‚å¦‚æœæ²¡æœ‰ï¼Œè¯¥è¿‡ç¨‹åœæ­¢ã€‚æ‰§è¡Œæ­¤æ“ä½œçš„ä»£ç å¦‚ä¸‹:

```
val_acc=$(sudo -S docker container exec model  jq .validation_acc \ /home/jovyan/results/train_metadata.json)threshold=0.8

if echo "$threshold > $val_acc" | bc -l | grep -q 1
then
	echo 'validation accuracy is lower than the threshold, process stopped'
else
   echo 'validation accuracy is higher than the threshold'
   sudo -S docker container exec model python3 test.py
   sudo -S docker container exec model cat \ /home/jovyan/results/train_metadata.json \ /home/jovyan/results/test_metadata.json 
fi
```

å¦‚æ‚¨æ‰€è§ï¼Œé¦–å…ˆæˆ‘ä»¬è®¾ç½®ä¸¤ä¸ªæƒ³è¦æ¯”è¾ƒçš„å˜é‡(éªŒè¯å‡†ç¡®æ€§å’Œé˜ˆå€¼)ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæ¡ä»¶è¯­å¥ä¼ é€’å®ƒä»¬ã€‚å¦‚æœéªŒè¯å‡†ç¡®æ€§é«˜äºé˜ˆå€¼ï¼Œæˆ‘ä»¬å°†ä¸ºæµ‹è¯•æ•°æ®æ‰§è¡Œæ¨¡å‹ï¼Œç„¶åæˆ‘ä»¬å°†æ˜¾ç¤ºæµ‹è¯•å’ŒéªŒè¯ç»“æœã€‚å¦åˆ™ï¼Œè¯¥è¿‡ç¨‹å°†åœæ­¢ã€‚

æˆ‘ä»¬åšåˆ°äº†ï¼æˆ‘ä»¬çš„æ¨¡å‹æ˜¯å®Œå…¨å®¹å™¨åŒ–çš„ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œç®¡é“ä¸­çš„æ‰€æœ‰æ­¥éª¤ï¼

## Docker åˆå­¦è€…çš„é—®é¢˜:æˆ‘ä»¬æ‰€åšçš„æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿ

å¦‚æœä½ ä¸ç†Ÿæ‚‰ Dockerï¼Œç°åœ¨ä½ å¯èƒ½ä¼šé—®:å¥½å§ï¼Œè¿™äº›éƒ½æ˜¯å¥½ä¸œè¥¿ï¼Œä½†æœ€ç»ˆæˆ‘åªæœ‰æˆ‘çš„æ¨¡å‹å’Œæˆ‘çš„é¢„æµ‹ã€‚æˆ‘ä¹Ÿå¯ä»¥é€šè¿‡è¿è¡Œæˆ‘çš„ Python ä»£ç æ¥è·å¾—å®ƒä»¬ï¼Œè€Œä¸éœ€è¦å­¦ä¹  Dockerã€‚é‚£ä¹ˆï¼Œè¿™ä¸€åˆ‡æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ

æˆ‘å¾ˆé«˜å…´ä½ é—®äº†ğŸ˜ã€‚

é¦–å…ˆï¼Œå°†æ‚¨çš„æœºå™¨å­¦ä¹ æ¨¡å‹æ”¾åœ¨ Docker å®¹å™¨ä¸­å¯¹äºå°†è¯¥æ¨¡å‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­éå¸¸æœ‰ç”¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä½ æœ‰å¤šå°‘æ¬¡åœ¨æ•™ç¨‹æˆ–åº“ä¸­çœ‹åˆ°ä½ è¯•å›¾å¤åˆ¶çš„ä»£ç ï¼Œå½“åœ¨ä½ çš„æœºå™¨ä¸Šè¿è¡Œç›¸åŒçš„ä»£ç æ—¶ï¼Œä½ çš„å±å¹•å……æ»¡äº†çº¢è‰²ï¼Ÿå¦‚æœæˆ‘ä»¬ä¸æ„¿æ„ç»å†è¿™äº›ï¼Œæƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬çš„å®¢æˆ·ä¼šæœ‰ä»€ä¹ˆæ„Ÿå—ã€‚æœ‰äº† Docker å®¹å™¨ï¼Œè¿™ä¸ªé—®é¢˜å°±è§£å†³äº†ã€‚

Docker çœŸæ­£æœ‰ç”¨çš„å¦ä¸€ä¸ªåŸå› å¯èƒ½ä¸æ‚¨é˜…è¯»æœ¬æ–‡çš„åŸå› ç›¸åŒ:å¸®åŠ©è‡ªåŠ¨åŒ–æ•´ä¸ªç®¡é“ã€‚

æ‰€ä»¥ï¼Œäº‹ä¸å®œè¿Ÿï¼Œæˆ‘ä»¬å¼€é—¨è§å±±å§ï¼

# åˆ©ç”¨ Jenkins å®ç° ML ç®¡é“çš„è‡ªåŠ¨åŒ–

å¯¹äºè¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Jenkinsï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸è‘—åçš„å¼€æºè‡ªåŠ¨åŒ–æœåŠ¡å™¨ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—æ’ä»¶æ¥æ”¯æŒæ„å»ºã€éƒ¨ç½²å’Œè‡ªåŠ¨åŒ–ä»»ä½•é¡¹ç›®ã€‚

è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åä¸º jobs çš„å·¥å…·æ¥æ„å»ºç®¡é“çš„æ­¥éª¤ã€‚æ¯é¡¹å·¥ä½œéƒ½å°†æ˜¯æˆ‘ä»¬å·¥ä½œæµç¨‹ä¸­çš„ä¸€æ­¥ã€‚

ğŸ“’æ³¨æ„:ä¸ºäº†è®©äº‹æƒ…é¡ºåˆ©è¿è¡Œï¼Œæ‚¨å¯èƒ½éœ€è¦é…ç½®ä¸€äº›ä¸œè¥¿:

*   å¦‚æœæ‚¨åœ¨æœ¬åœ°ä¸»æœºä¸Šä½¿ç”¨ Jenkinsï¼Œé‚£ä¹ˆæ‚¨åœ¨å°è¯•å°† Jenkins ä¸ Github è¿æ¥æ—¶å¯èƒ½ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œè¯·è€ƒè™‘åˆ›å»ºä¸€ä¸ªåˆ°æœ¬åœ°ä¸»æœºçš„å®‰å…¨ URLã€‚æˆ‘å‘ç°æœ€å¥½çš„å·¥å…·æ˜¯ [ngrok](https://ngrok.com/) ã€‚
*   ç”±äº jenkins ä½¿ç”¨è‡ªå·±çš„ç”¨æˆ·(ç§°ä¸º Jenkins ),æ‚¨å¯èƒ½éœ€è¦æˆäºˆå®ƒæƒé™ï¼Œä»¥ä¾¿åœ¨æ²¡æœ‰å¯†ç çš„æƒ…å†µä¸‹æ‰§è¡Œå‘½ä»¤ã€‚ä½ å¯ä»¥é€šè¿‡ç”¨`sudo visudo /etc/sudoers`æ‰“å¼€ sudoers æ–‡ä»¶å¹¶ç²˜è´´`jenkins ALL=(ALL) NOPASSWD: ALL`æ¥å®ç°ã€‚

è¯è™½å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜æ˜¯çœ‹çœ‹æœ‰ä»€ä¹ˆè®¡åˆ’å§ã€‚æˆ‘ä»¬å°†åˆ›é€  4 ä¸ªå°±ä¸šæœºä¼š:

1.  â€œgithub-to-containerâ€å·¥ä½œ:åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å°† Jenkins ä¸ githubâ€œè¿æ¥â€,æ¯æ¬¡åœ¨ Github ä¸­æäº¤æ—¶éƒ½ä¼šè§¦å‘è¿™é¡¹å·¥ä½œã€‚æˆ‘ä»¬è¿˜å°†æ„å»º Docker æ˜ åƒå¹¶è¿è¡Œä¸€ä¸ªå®¹å™¨ã€‚
2.  â€œé¢„å¤„ç†â€ä½œä¸š:åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†æ‰§è¡Œ preprocessing.py è„šæœ¬ã€‚è¯¥ä½œä¸šå°†ç”±â€œgithub åˆ°å®¹å™¨â€ä½œä¸šè§¦å‘ã€‚
3.  â€œtrainâ€ä½œä¸š:åœ¨è¿™ä¸ªä½œä¸šä¸­ï¼Œæˆ‘ä»¬å°†æ‰§è¡Œ train.py è„šæœ¬ã€‚è¯¥ä½œä¸šå°†ç”±â€œé¢„å¤„ç†â€ä½œä¸šè§¦å‘ã€‚
4.  â€œæµ‹è¯•â€å·¥ä½œ:åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡æˆ‘ä»¬çš„æ¡ä»¶è¯­å¥ä¼ é€’éªŒè¯åˆ†æ•°ã€‚å¦‚æœå®ƒé«˜äºé˜ˆå€¼ï¼Œæˆ‘ä»¬å°†æ‰§è¡Œ test.py è„šæœ¬å¹¶æ˜¾ç¤ºå…ƒæ•°æ®(éªŒè¯å’Œæµ‹è¯•å‡†ç¡®æ€§)ã€‚å¦‚æœéªŒè¯åˆ†æ•°ä½äºé˜ˆå€¼ï¼Œåˆ™è¯¥è¿‡ç¨‹å°†åœæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šæä¾›å…ƒæ•°æ®ã€‚

ä¸€æ—¦æˆ‘ä»¬çŸ¥é“è¯¥åšä»€ä¹ˆï¼Œè®©æˆ‘ä»¬å»åšå§ï¼

# åˆ›é€ è©¹é‡‘æ–¯å°±ä¸šæœºä¼š

## github åˆ°å®¹å™¨çš„å·¥ä½œ

å¯¹äº github åˆ°å®¹å™¨çš„å·¥ä½œï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ github å’Œ Jenkins ä¹‹é—´åˆ›å»ºä¸€ä¸ªâ€œè¿æ¥â€ã€‚è¿™æ˜¯ä½¿ç”¨ webhooks å®Œæˆçš„ã€‚è¦åˆ›å»º Webhookï¼Œè¯·è½¬åˆ° Github ä¸­çš„å­˜å‚¨åº“ï¼Œé€‰æ‹© settings å¹¶é€‰æ‹© webhooksã€‚é€‰æ‹©æ·»åŠ  webhookã€‚åœ¨æœ‰æ•ˆè´Ÿè½½ URL ä¸­ï¼Œä¼ é€’è¿è¡Œ Jenkins çš„ URL å¹¶æ·»åŠ â€œ//github-webhook/â€ã€‚å¯¹äºå†…å®¹ç±»å‹ï¼Œé€‰æ‹©â€œåº”ç”¨ç¨‹åº/jsonâ€ã€‚å¯¹äºâ€œæ‚¨å¸Œæœ›å“ªä¸ªäº‹ä»¶è§¦å‘è¿™ä¸ª webhookï¼Ÿâ€ï¼Œé€‰æ‹©â€œä»…æ¨é€äº‹ä»¶â€ã€‚åœ¨åº•éƒ¨é€‰æ‹©æ´»åŠ¨ã€‚é€‰æ‹©æ·»åŠ  webhookã€‚

![](img/d9044ad0811bee5fab440425a1ad9613.png)

ä½œè€…å›¾ç‰‡

ç„¶åï¼Œæ‚¨éœ€è¦åœ¨ Jenkins ä¸­åˆ›å»ºä¸€ä¸ªå‡­è¯æ¥è®¿é—® Githubã€‚åœ¨è©¹é‡‘æ–¯ï¼Œè½¬åˆ°ç®¡ç†è©¹é‡‘æ–¯

![](img/d38c23c1a4d8e36e86f14024069904e3.png)

ä½œè€…å›¾ç‰‡

ç„¶åé€‰æ‹©ç®¡ç†å‡­æ®ï¼Œ

![](img/d4024207782eff04e74b9e4b1c746239.png)

ä½œè€…å›¾ç‰‡

åœ¨â€œJenkins èŒƒå›´å†…çš„å•†åº—â€ä¸­ï¼Œé€‰æ‹© Jenkins

![](img/a7a3e94a10446056eb6030e937c407a7.png)

ä½œè€…å›¾ç‰‡

ç„¶åé€‰æ‹©â€œå…¨å±€å‡­è¯(æ— é™åˆ¶)â€

![](img/4d9bc08028e0498dfa4c54e23156632d.png)

ä½œè€…å›¾ç‰‡

å¹¶æ·»åŠ å‡­æ®

![](img/d5edde51eb936925186e4d3665d32f78.png)

ä½œè€…å›¾ç‰‡

åœ¨è¿™é‡Œï¼Œå¯¹äºèŒƒå›´é€‰æ‹©â€œGlobal (Jenkinsï¼Œnodesï¼Œitemsï¼Œall child itemsï¼Œetc)â€ï¼Œå¯¹äºç”¨æˆ·åå’Œå¯†ç å¡«å†™æ‚¨çš„ Github ç”¨æˆ·åå’Œå¯†ç ã€‚æ‚¨å¯ä»¥å°† ID ç•™ç©ºï¼Œå› ä¸ºå®ƒå°†è‡ªåŠ¨ç”Ÿæˆã€‚æ‚¨ä¹Ÿå¯ä»¥æ·»åŠ æè¿°ã€‚æœ€åï¼Œå•å‡»ç¡®å®šã€‚

ç°åœ¨è®©æˆ‘ä»¬å»ºç«‹ç¬¬ä¸€ä¸ªå·¥ä½œï¼

åœ¨ Jenkins ä¸­ï¼Œè½¬åˆ°æ–°é¡¹ç›®ï¼Œ

![](img/396892f2cb7c1195316aaff0dc33a297.png)

ä½œè€…å›¾ç‰‡

ç„¶åç»™å®ƒèµ·ä¸ªåå­—ï¼Œé€‰æ‹©è‡ªç”±å¼é¡¹ç›®ã€‚

![](img/bcf59b95f4742bfee9e51a1ce2e3542b.png)

ä½œè€…å›¾ç‰‡

ä¸‹ä¸€æ­¥æ˜¯è®¾ç½®é…ç½®ã€‚å¯¹äºè¿™ä¸€æ­¥ï¼Œåœ¨æºä»£ç ç®¡ç†ä¸­é€‰æ‹© Gitï¼Œç„¶åç²˜è´´æ‚¨çš„å­˜å‚¨åº“çš„ URL å’Œæ‚¨çš„ Github å‡­è¯ã€‚

![](img/11550092997419bebf8ab679a97e1eb0.png)

ä½œè€…å›¾ç‰‡

ç„¶åï¼Œåœ¨æ„å»ºè§¦å‘å™¨ä¸­é€‰æ‹©â€œGitHub hook trigger for git SCM pollingâ€ã€‚æœ€ååœ¨ build éƒ¨åˆ†é€‰æ‹© Add build stepï¼Œç„¶åæ‰§è¡Œ shellï¼Œç„¶åç¼–å†™æ„å»ºæ˜ åƒå’Œè¿è¡Œå®¹å™¨çš„ä»£ç (æˆ‘ä»¬å·²ç»è®¨è®ºè¿‡äº†):

![](img/415bfad4d914885752300197f6d9ed95.png)

ä½œè€…å›¾ç‰‡

é€‰æ‹©ä¿å­˜ã€‚

## é¢„å¤„ç†ä½œä¸š

å¯¹äºâ€œé¢„å¤„ç†â€ä½œä¸šï¼Œåœ¨æºä»£ç ç®¡ç†ä¸­å°†å…¶ä¿ç•™ä¸ºæ— ã€‚åœ¨â€œç”Ÿæˆè§¦å‘å™¨â€ä¸­ï¼Œé€‰æ‹©â€œåœ¨å…¶ä»–é¡¹ç›®ç”Ÿæˆåç”Ÿæˆâ€ã€‚ç„¶ååœ¨è¦ç›‘è§†çš„é¡¹ç›®ä¸­è¾“å…¥ç¬¬ä¸€ä¸ªä½œä¸šçš„åç§°ï¼Œå¹¶é€‰æ‹©â€œä»…å½“æ„å»ºç¨³å®šæ—¶è§¦å‘â€ã€‚

![](img/f27fb39148c30db57a13616272609b74.png)

ä½œè€…å›¾ç‰‡

åœ¨ Build ä¸­ï¼Œé€‰æ‹© Add build stepï¼Œç„¶åæ‰§è¡Œ shellï¼Œå¹¶ç¼–å†™è¿è¡Œ preprocessing.py çš„ä»£ç :

![](img/1918af9a25a610364733e63c2cf45321.png)

ä½œè€…å›¾ç‰‡

## ç«è½¦å·¥ä½œ

â€œè®­ç»ƒâ€ä½œä¸šä¸â€œé¢„å¤„ç†â€ä½œä¸šçš„æ–¹æ¡ˆç›¸åŒï¼Œä½†æœ‰ä¸€äº›ä¸åŒã€‚æ­£å¦‚æ‚¨å¯èƒ½çŒœåˆ°çš„ï¼Œæ‚¨éœ€è¦åœ¨ Build triggers éƒ¨åˆ†å†™ä¸‹ç¬¬äºŒä¸ªä½œä¸šçš„åç§°:

![](img/df8c5804257c8f685e7a1a04d0ff219b.png)

ä½œè€…å›¾ç‰‡

åœ¨æ„å»ºéƒ¨åˆ†ç¼–å†™è¿è¡Œ train.py çš„ä»£ç ã€‚

![](img/c1435dd75f66bfb9ee83e0e936232f05.png)

ä½œè€…å›¾ç‰‡

## æµ‹è¯•å·¥ä½œ

å¯¹äºâ€œæµ‹è¯•â€ä½œä¸šï¼Œä¸ºæ„å»ºè§¦å‘å™¨éƒ¨åˆ†é€‰æ‹©â€œè®­ç»ƒâ€ä½œä¸šï¼Œ

![](img/410dbb644c3b3f398e5216114db1636a.png)

ä½œè€…å›¾ç‰‡

å¹¶åœ¨æ„å»ºéƒ¨åˆ†ç¼–å†™ä»¥ä¸‹ä»£ç :

```
val_acc=$(sudo -S docker container exec model  jq .validation_acc \ /home/jovyan/results/train_metadata.json)threshold=0.8

if echo "$threshold > $val_acc" | bc -l | grep -q 1
then
	echo 'validation accuracy is lower than the threshold, process stopped'
else
   echo 'validation accuracy is higher than the threshold'
   sudo -S docker container exec model python3 test.py
   sudo -S docker container exec model cat \ /home/jovyan/results/train_metadata.json \ /home/jovyan/results/test_metadata.json 
fi    

sudo -S docker rm -f model
```

æˆ‘å·²ç»å†™äº†ï¼Œä»¥é˜²ä½ æƒ³å¤åˆ¶ç²˜è´´ï¼Œä½†åœ¨è©¹é‡‘æ–¯å®ƒåº”è¯¥æ˜¯è¿™æ ·çš„:

![](img/adcf91809ebff14a744fcec88e6447d7.png)

ä½œè€…å›¾ç‰‡

ç‚¹å‡»ä¿å­˜ï¼Œæˆ‘ä»¬å°±æœ‰äº†ï¼æˆ‘ä»¬çš„æµæ°´çº¿ç°åœ¨å®Œå…¨è‡ªåŠ¨åŒ–äº†ï¼

æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨å®ƒäº†:å°è¯•åœ¨ Github ä¸­æäº¤ï¼Œçœ‹çœ‹æ¯ä¸€æ­¥æ˜¯å¦‚ä½•è‡ªåŠ¨è¿›è¡Œçš„ã€‚æœ€åï¼Œå¦‚æœæ¨¡å‹éªŒè¯ç²¾åº¦é«˜äºé˜ˆå€¼ï¼Œæ¨¡å‹å°†è®¡ç®—æµ‹è¯•ç²¾åº¦å¹¶è¿”å›ç»“æœã€‚

ğŸ“’æ³¨æ„:ä¸ºäº†æŸ¥çœ‹æ¯ä¸ªæ­¥éª¤çš„è¾“å‡ºï¼Œé€‰æ‹©è¯¥æ­¥éª¤ï¼Œå•å‡»å·¦ä¸‹æ–¹æ„å»ºéƒ¨åˆ†çš„ç¬¬ä¸€ä¸ªæ•°å­—ï¼Œç„¶åé€‰æ‹©æ§åˆ¶å°è¾“å‡ºã€‚å¯¹äºæœ€åä¸€æ­¥ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°éªŒè¯å’Œæµ‹è¯•çš„å‡†ç¡®æ€§ã€‚

å¸Œæœ›ä½ å­¦åˆ°äº†å¾ˆå¤šï¼æ„Ÿè°¢é˜…è¯»ï¼

## å‚è€ƒ

[æœºå™¨å­¦ä¹ çš„ Docker ç¬¬ä¸‰éƒ¨åˆ†](https://mlinproduction.com/docker-for-ml-part-3/)

[ä» DevOps åˆ° MLOPS:ä½¿ç”¨ Jenkins å’Œ Docker æ•´åˆæœºå™¨å­¦ä¹ æ¨¡å‹](/from-devops-to-mlops-integrate-machine-learning-models-using-jenkins-and-docker-79034dbedf1)

[ä»å¤©çœŸåˆ° XGBoost å’Œ ANN:æˆäººäººå£æ™®æŸ¥æ”¶å…¥](https://www.kaggle.com/adro99/from-na-ve-to-xgboost-and-ann-adult-census-income)