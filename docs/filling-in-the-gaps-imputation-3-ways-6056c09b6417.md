# 填补空白:三种插补方式

> 原文：<https://towardsdatascience.com/filling-in-the-gaps-imputation-3-ways-6056c09b6417?source=collection_archive---------8----------------------->

## [*小窍门*](https://towardsdatascience.com/tagged/tips-and-tricks)

## 观察缺失数据的插补，从简单的替换方法到更复杂的链式方程多重插补。

![](img/ae6197609a5f22d14b1dcdacc4a6561e.png)

照片由[凯勒·琼斯](https://unsplash.com/@gcalebjones?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 拍摄

# 背景

如果你做过任何预测分析——或尝试过任何 IFoA 精算检查——你会遇到“垃圾进，垃圾出”这句话。自 20 世纪 50 年代末以来，它就一直存在，并抓住了这样一个概念，即如果逻辑的基本前提有缺陷，那么逻辑就是不合理的。

这句话同样适用于预测建模:**无论算法有多花哨，数据质量总是一个限制因素。**

我的新闻提要贴满了对最新算法和超参数优化技术的解释，但我很少看到任何关于数据清理的内容。这真的不奇怪，因为大多数分析师可能会发现数据管理是治疗他们失眠的有效方法。然而，这是建模过程中至关重要的一部分，需要极大的关注和思考。

我最近一直在处理一些外部数据源，这些数据源在与公司内部数据结合后需要进行大量处理，这主要是因为合并和聚合后的数据中存在大量缺失值。以下注释旨在通过一个例子来分享我从处理恶意数据的实践经验中学到的一些东西，包括:

*   归罪背后的动机
*   简单看一下标准的估算方法
*   更长远地看待更复杂的方法

# 归罪

先说处理缺失值，这本身就是统计学的一个广阔领域。

## 为什么我们需要烦恼？

很简单，缺少值就是信息缺口。

充其量，这些信息差距

*   可能无法让我们获得关键见解或…
*   可能导致从数据中得出的任何见解的严谨性值得怀疑或…
*   可能会描绘出一幅有限的世界图景(想想试图通过钥匙孔来描述一个房间)。

…在最坏的情况下，它们是导致糟糕的机器学习模型的障碍——垃圾进，垃圾出。

## 缺失的值可能会让我们深入了解我们的问题

讽刺。

理解值丢失的原因有时可以让我们更好地理解我们的数据和数据收集协议。我喜欢问自己以下问题，因为我发现这些问题经常让我更好地理解我在做什么，以及如何对待缺失的价值观。

**“数据是随机缺失的吗？”**也就是说，缺失的价值观中是否存在某种模式或系统性偏差？

**“为什么数据会丢失？”**缺失的数据是由数据收集方式造成的吗？比如数据检索管道是否正确？是否存在匹配问题？

丢失的数据是收集数据的时间段的函数吗？例如，多年数据集只能提供特定时间范围的数据。

**“缺失的值能告诉我们什么吗？”**也就是说，当我们想到特性本身时，缺失的值是否意味着什么？

如果我们正在查看房屋销售价格数据,“公摊面积”特性中缺失的数据是否能告诉我们一些关于房子的信息？可以说，是的——这可能意味着房子没有游泳池。

如果我们从一个有足够市场覆盖面和良好匹配协议的大型提供商那里寻找信用评分数据，缺失的信用评分是否能告诉我们一些关于客户的信息？*最有可能的是，该客户尚未建立信用记录，可能是因为他们年轻或刚刚移民。只用现金支付商品和服务可能是一个危险信号！*

一旦我们弄清楚了这些问题，我们就可以继续决定一个“最优”策略来处理缺失的价值。现在，我不打算这样做，因为(A)这超出了本笔记的范围,( B)我实际上对我们正在处理的数据集了解不多。

让我们继续讨论一些方法来弥补我们缺失的价值观。

## 三种估算方法:

一个简单的**方法是删除任何包含缺失值的行。这并不理想，因为从我们的数据集中删除观察结果实际上是从我们的数据集中删除信息。**

一个更复杂的方法是用从没有**丢失的值计算出的统计值代替丢失的值。**

*   这可以通过在数据组中加入额外的列来增强，这些列表明一行是否被估算。例如，如果我们在`Column A`中输入缺失值，我们可以创建一个名为`Column A Imputed`的新列，当`Column A`中的一行被输入时，它取值 1，否则取值 0。
*   通过考虑背景信息，可以产生更复杂的插补。例如，假设我们正在处理一个住房数据集，我们试图估算与房子花园大小相关的缺失数据。由于同一街区大约在同一时间建造的房屋很可能具有相似的特征，因此用同一街区大约在同一时间建造的房屋的平均花园面积来代替缺失值并非不合理。

一种**高级方法**是使用非缺失数据迭代地模拟缺失值。

*   例如，假设我们的数据集中有 10 列。还假设丢失了 10%的`Column 1`，丢失了 5%的`Column 2`，丢失了 2.5%的`Column 3`，并且在数据集中没有其他丢失的值。
*   我们可以使用第 4-10 列来建立一个预测`Column 3`的模型。这个模型将使用没有丢失`Column 3`数据的行来构建。
*   `Column 3`中缺失的值将被模型预测替换。
*   然后，我们重复建模过程，使用第 3–10 列来预测`Column 2`。同样，只使用非缺失数据，并且`Column 2`中缺失的值将被我们模型中的预测所替换。
*   最后，我们可以为`Column 1`重复建模-插补过程。
*   插补顺序通常从*最少*缺失值的列开始，并按照缺失值递增的顺序移动。
*   这通常会提高插补模型的预测能力，因为它们是用更多的数据构建的，而且插补值中包含的不确定性更少。
*   这种方法被称为使用链式方程的多重插补(MICE ),在文献中有详细介绍——我鼓励您阅读！

## 好吧，但是我们怎么知道最好的估算方法是什么呢？

如果我们在一个项目的开始，我们可能很难确切地知道哪种估算方法是最好的。此外，我们可能不知道是否有单一的最佳方法，或者是否需要某种混合方法。

无论如何，我们需要定义我们所说的“最好”是什么！

在这篇笔记中，我试图根据我们掌握的其他信息来预测水是否可以饮用。我已经决定(感谢其他 Kagglers 所做的伟大工作)我将使用一个极其随机的森林来做预测，并且我将使用各种度量来测量树模型的准确性。

**补充说明:**您可能认为知道为哪种模型形式进行优化有点骗人。你可能是正确的，因为对于大多数机器学习应用来说，通过交叉验证进行模型选择是标准的。然而，提前知道将使用什么模型在现实世界中并不罕见——实践者经常受到技术和他们的涉众环境的限制(关于这些的讨论可以写在单独的文章中)。

回到笔记！

我将把**最佳插补方法定义为在所选模型指标中最大化树形模型交叉验证模型准确性的方法**。

我还定义了我将应用的 5 种估算方法:

1.  删除所有缺少值的行。
2.  使用基于非缺失值的统计数据输入缺失值。
3.  如(2)中那样进行估算，但是添加了附加列来指示是否估算了特定值。
4.  使用贝叶斯岭模型的 MICE 方法。
5.  一只老鼠用一个非常随机的森林模型接近。

## 工作流程

1.  获取数据。
2.  做插补。
3.  创建交叉验证功能。
4.  使用模型准确性度量和特征重要性评估估算数据集的性能。
5.  选择我们的最佳估算方法。

我们走吧！

# 数据

来源于 [Kaggle](https://www.kaggle.com/adityakadiwal/water-potability) ，我们将使用**饮用水**数据集作为例子。让我们快速看一下数据中的内容:

1.  **pH 值:**表示酸性或碱性水状态。
2.  **硬度:**主要由钙和镁盐引起，因为水溶解了它通过的物质中的地质沉积物。
3.  **固体:**水可以溶解多种矿物质和盐类，如钾、钙、钠；溶解的矿物质会产生令人不快的味道和稀释的外观(使用水的重要参数)。
4.  **氯胺:**氯和氯胺是公共供水系统使用的消毒剂。
5.  **硫酸盐:**在矿物、土壤和岩石中发现的自然存在的物质。
6.  **导电性:**纯水不是电流的良导体；离子浓度的增加增强了水的导电性
7.  **有机碳:**来自腐烂的天然有机物和合成来源，这是对纯水中有机化合物中碳总量的度量。
8.  **三卤甲烷:**三卤甲烷是在用氯处理过的水中发现的化学物质。饮用水中 THMs 的浓度根据水中有机物质的水平、处理水所需的氯量和被处理水的温度而变化。
9.  **浊度:**是水的发光特性的量度，该测试用于指示与胶体物质相关的废物排放质量。
10.  **可饮用性:**表示水对于人类饮用是否安全，其中`1`表示可饮用，`0`表示不可饮用。

数据的第一行如下所示:

![](img/518089fa634d316a879a7c301195371e.png)

作者图片

我们可以看到有一些丢失的值，但是到底有多少呢？

![](img/93adf7a68f0c9808214d7fa604f33d62.png)

作者图片

目标(`potability`)没有遗漏——这是好事！

不幸的是，`ph`、`sulfate`和`trihalomethanes`就不一样了，它们分别丢失了 15%、24%和 5%的数据。

我们不会在数据转换和特性工程上花太多心思，但不管怎样，至少对我们正在做的事情有个感觉是个好习惯。

![](img/5ae1c213add6e926dfc0618d1c2e1959.png)

作者图片

因此，水的特征似乎大致呈正态分布，当观察可饮用/不可饮用的划分时，有一些明显的差异。*在其他情况下，我们可能会对调查*`*ph*`*`*chloramines*`*和* `*sulfate*`感兴趣。*

*快速检查水可饮用性的正面和负面情况之间的平衡显示出轻微的不平衡(39%的情况属于“正面”类别)。*

*我将暂时离开不平衡问题，因为它不会对我们的归因调查产生太大的影响。*

# *建模和验证拆分*

*我们将获取初始数据集，并将其分为训练数据集和验证数据集。*

*我们知道有些数据丢失了，所以我们需要小心到底哪些行进入了验证集——我们不希望在我们的验证集中有丢失的值。*

*这个过程相对简单:*

1.  *打乱数据以删除原始数据中固有的任何顺序。*
2.  *检查哪些行包含缺失值。*
3.  *决定我们需要多少干净的数据来验证。我将选择 600 行进入我们的验证集——这大约是数据集的 20%,完全符合标准。*
4.  *从原始数据中分离干净的验证数据，并将其命名为`X_valid`和`Y_valid`。*
5.  *剩余的数据形成了我们的训练集`X`和`Y`。*

*就代码而言，这看起来类似于:*

*现在检查验证集中是否没有丢失的值…*

*![](img/d8196a7754a82f3b2f6be3b3f1e08720.png)*

*作者图片*

*太棒了。*

*我们正在使用所有可用的数据(即`X`∩`X_valid`=`df`)，我们的验证集不包含缺失值。我们可以继续处理训练集中缺失的值。*

# *创建估算数据集*

## *删除所有缺少值的行*

*删除缺少值的行非常容易。然而，按照这种方法，我们丢失了大约 49%的数据，这显然是站不住脚的。*

*虽然一些数据丢失是可以接受的，但是这个数量是不可接受的，因此我们将不再考虑这种方法。*

## *用统计值(中值)替换缺失值*

*这是一种稍微复杂一点的方法，它允许我们保存更多的信息，而不仅仅是删除行。*

*由于所有的数据都是连续的，我们可以使用描述连续变量的统计数据；在这种情况下，我使用中值，它比平均值对异常值更稳健。*

*如果我们的一些数据是分类的，我们将需要修改我们的统计-我的第一选择将是使用模式(即最受欢迎的值)。*

*然而，这种估算很简单:*

## *用统计数据替换缺失值，并添加指标来识别估算值*

*基于前面的方法，我们首先确定要估算的观测值，然后进行估算。通过对代码做一点小小的修改，我们可以将指示器列添加到数据中，这样我们的模型就可以识别被估算的行。*

## *用 MICE 方法替换缺失值*

*我们今天要探讨的最复杂的方法是，我们现在将对非缺失值进行建模，并用模型预测替换缺失值。同样，我们的数据类型决定了我们的方法:我们试图建模的数据是连续的，因此我们将进行回归。*

*我们将使用方便的`sklearn`实现来:*

*   *用贝叶斯岭模型估算缺失值(`BayesianRidge`)。*
*   *用一个极其随机的森林来估算缺失值(`ExtraTreesRegressor`)。*如果我们的一些数据是分类的，我们需要使用分类类而不是回归类*。*

# *构建交叉验证功能*

*我们现在准备构建功能，创建折叠外模型预测以及每个折叠的特征重要性。*

*这将使我们了解哪种估算方法产生的模型最准确，并让我们深入了解该模型是如何构建的。*

*这是一段很长的代码，但是很容易理解:*

# *评估交叉验证的性能和功能重要性*

*让我们绘制每个数据集的每个特征的特征重要性等级。这里，我们将使用所有数据集共有的特性。*

*![](img/911c0c701f8552b3ba3a7a3dd56eb830.png)*

*作者图片*

*有意思！*

*建立在`Tree Impute`、`Fill`和`Bayesian Impute`数据集上的模型似乎在很大程度上同意对提高模型拟合度很重要的特征。*

*基于`Fill + Indicate`数据构建的模型似乎在哪些功能最重要的问题上存在分歧，但值得记住的是，这个数据集比其他数据集拥有更多的功能。让我们来看看`Fill + Indicate`中所有特性的重要性。*

*![](img/60ed954122ea9bca7e7a4ceb7d9dfc91.png)*

*作者图片*

*“原始”栏特征重要性的不同排序，其中`sulfate`、`ph`、`trihalomethanes`的插补指标也发挥了作用。这真的很有趣，因为这些列有缺失值，所以模型使用估算列*和指标列*来学习。*

*模型中没有使用其他指标列，这些指标列的特征重要性值为 0，因此排在最后。*

*让我们检查一下跨褶皱的模型准确性指标。在这种情况下，我们将使用准确度，它被定义为%正确预测。*

*![](img/f5fefd1ecd3bfe3b5ac2a5eebb356f6d.png)*

*作者图片*

*现在来看看折页数据的所有精确度指标。*

*![](img/2cb0347a2999d16f686a0a58869a7d97.png)*

*作者图片*

*![](img/4cc4d6014ebfaaa073fb56670a65a3b7.png)*

*作者图片*

*这就是我们拥有的模型预测能力的非折叠度量，其中:*

*   *`accuracy`是模型精度，定义为正确预测的百分比；越高越好。*
*   *`f1 score`是精度和召回率的调和平均值；越高越好。*
*   *`balanced accuracy`是对每一类的平均回忆；越高越好*
*   *`brier score`是预测概率与实际结果的均方差；越低越好。*

*对我来说，这看起来像树插补方法是上面定义的最佳方法！*

# *一些想法*

*总结，夹杂一些散漫。*

*我们已经讨论了**为什么我们需要估算数据**，触及了我最喜欢的一个成语(“垃圾进，垃圾出”)。*

*没有花太多时间**了解数据**。我不鼓励这样做，在现实世界中我自己也不会这样做。领域知识和数据理解通常是成功分析实践的关键驱动因素。*

*我们**使用多种技术估算缺失的数据。**通过`pandas`可以轻松应用简单的技术，而通过`sklearn`可以进行更复杂的插补。就像生活中的其他事物一样，并非所有闪光的东西都是金子，不新奇的东西也不应该立即丢弃。这是显而易见的，因为我们看到用中值替换缺失值(“填充”技术)产生了极具竞争力的结果！*

*虽然我没有详细介绍交叉验证步骤，但是**交叉验证是一个很好的工具，可以充分利用你的(有时是有限的)数据。**我强烈推荐在现实场景中明智地实现它。*

*重要的是要记住**模型的准确性——无论它是如何定义的——并不是从业者应该关心的唯一事情**。数据的变更很可能会对模型结构产生重大影响，我们通过各种插补技术的特征重要性差异看到了这一点。*

*我们使用了**多种模型准确性指标来评估插补方法的性能**。这样做提供了不同的视角，我们可以通过这些视角来观察模型的性能。同样，如果可行的话，我会建议在现实世界中这样做。关注最适合当前场景的指标是最务实的，因为例如 I 型和 II 型错误可能会有财务影响。*

*最后，但同样重要的是，我希望你喜欢这篇文章，就像我喜欢把它放在一起一样！*