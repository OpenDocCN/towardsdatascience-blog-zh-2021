# 胜于替代 1.1 和预期目标 1.1:模型更新和验证

> 原文：<https://towardsdatascience.com/wins-above-replacement-1-1-and-expected-goals-1-1-model-updates-and-validation-c05855b59f12?source=collection_archive---------28----------------------->

## 一些小改动。更多的数据，以及它真正的价值。

就在半年多前，我发布了两个评估 NHL 滑手和守门员的描述性模型:[预期目标](https://topdownhockey.medium.com/a-new-expected-goal-model-that-is-better-than-corsi-at-predicting-future-goals-ecfa44dc84e9)和[胜于替补](/wins-above-replacement-high-level-overview-63838e914395)。对于任何不熟悉或想要刷新记忆的人来说，这里有一个每个型号的快速运行:

*   **预期目标**利用极端梯度推进(extreme gradient boosting)，一种先进的机器学习技术，根据射门距离、角度和射门前发生的事件等因素，计算未被阻挡的射门尝试成为目标的概率。预期目标可以解释为加权投篮。
*   **胜于替换(战争)**使用[岭回归(RAPM)](/a-comprehensive-guide-to-using-regression-rapm-to-evaluate-nhl-skaters-with-source-code-ad76d1e1b8da) 来隔离运动员在力量相等的情况下对预期目标的影响，以及他们对力量打法的预期目标和点球决胜的预期目标的影响。它以前还使用岭回归来分离每个球员对他们球队获得和获得点球的比率的影响，以及射手和守门员对他们获得或面临的未阻挡射门尝试的影响(射门/扑救)。对于滑冰运动员来说，这些回归的结果分为六个部分:力量进攻，力量防守，力量进攻，人手不足防守，处罚和投篮。(注意，这里的力量与 NHL 的定义略有不同，并且**不包括**空网的比赛；它只包括 3 对 3、4 对 4 或 5 对 5 比赛，其中两队都有一名守门员。这将适用于我在这篇文章中提到的任何力量游戏。)从玩家实际提供的进球数中减去替换级别玩家预期在每个部分中提供的进球数，然后使用与一个进球数的值相当的除法器将该进球数转换成获胜数，以便获得高于替换的获胜数。

从 2013–2014 年到 2019–2020 年的所有赛季都建立了预期目标，而从 2014–2015 年到 2019–2020 年的所有赛季都建立了胜于更替目标。这两种型号都用于 2020-2021 赛季。

我对两个模型都做了一些更新。最激动人心的更新是，我激动地宣布**我现在有了这两款车型从 2007-2008 年到 2020-2021 年的数据，并将很快提供所有数据**。不幸的是，2007 年至 2008 年和 2009 年至 2010 年间的一些比赛没有完整的比赛数据和位置坐标；我已经选择从这些模型中完全排除这些游戏。您可能会注意到在输出中，某些在某个赛季打了 82 场比赛的球队或球员被列为打得更少；这意味着他们玩的是一个无法模拟的游戏。

其他的更新都是无关紧要的，我可能会实现它们而不提及任何东西，但我认为透明度很重要，最重要的是，我只是喜欢写这些东西。

我的两个模型以前都是用 R 构建的，它们都是完全用 Python 重新构建的。除了我有意做的调整之外，建模过程被尽可能紧密地遵循，但是模型输出之间会有一些微小的差异也是很自然的。某个投篮在一个模型中可能值 0.2 个预期目标，在另一个模型中可能值 0.3 个，没有真正的原因。

考虑到这一点，以下是我选择对每个型号进行的具体调整:

# 预期目标

*   每一季的模型训练所依据的数据差异很大。从 2007-2008 年到 2009-2010 年，我从样本中删除了 100 个“目标”游戏，根据剩余的数据训练模型，然后在我删除的目标游戏上运行它。在这三个赛季中，我对每 100 个游戏样本重复了这个过程。我这样做是因为与 2010-2011 年至今的数据不同，所有拍摄位置坐标都完全来自 ESPN 的 XML 报告，这些报告与 NHL 的 API 报告在拍摄跟踪方式上略有不同。
*   从 2010–2011 年到 2016–2017 年，我只是从样本中删除了一个目标季节，在剩余的季节训练模型，并在目标季节运行模型。我在这 7 季中重复了这个过程。
*   从 2017–2018 到 2021 年，我使用了与 2007–2008 到 2009–2010 年相同的过程:从样本中删除 100 个目标游戏，在剩余的游戏上训练模型，然后在目标游戏上运行模型。我将这些赛季从 2010-2011 年分为 2016-2017 年，因为 NHL 从 2017-2018 年开始对守门员设备法规进行了调整。守门员设备尺寸的减小带来了射门成为进球的可能性的可预测的增加，并且一个模型应该考虑到这一点。
*   在每个模型被训练的季节之外，这个模型的建模过程保持尽可能类似于先前的建模过程；所有相同的变量都被考虑在内，模型训练的参数使用相同的交叉验证方法获得。

# 胜于替代

*   这个模型的前一个版本使用了一个先验(贝叶斯)RAPM，用于力量均衡进攻、力量均衡防守、强力进攻和人手不足防守。我从 2013 年至 2014 年的无事先知情(香草)RAPM 开始，然后计算 2014 年至 2015 年的事先知情 RAPM，然后使用 2014 年至 2015 年 RAPM 的输出作为 2015 年至 2016 年的先验。我在 2020-2021 年间重复了这一过程，有效地创造了所谓的菊花链。**新型号与旧型号不同，它使用菊花链，但这种菊花链始于 2007 年至 2008 年**，并简单地使用 2007 年至 2008 年香草 RAPM 的输出来创建力量进攻、力量防守、力量进攻和人手不足的防守组件。
*   **对判罚的影响不再通过岭回归来计算，而是通过抽取和执行的个人判罚来计算。**虽然我相信玩家无法控制的因素确实会影响他们抽牌和罚点球的速度，但我不认为回归分析足以适应这种外部环境。类似于使用支持和反对的目标作为目标变量运行岭回归，我相信这在理论上听起来很棒，但在实践中，一个赛季中球员在冰上的目标变量的出现次数可能太低，无法在这样的回归输出中放置太多股票。这个模型的 1.0 版本中反直觉输出的数量和惩罚战的低重复性促使我做出这个决定。
*   **对射门和救球的影响不再通过岭回归来计算，而是通过相对于预期目标的进球和允许进球来计算。**这个改变主要是将拍摄分解成 3 个部分，然后可以添加到模型的其他部分；该模型的 1.0 版本仅具有一个“投篮”组件和一个“救球”组件，这使得很难真正衡量球员在均匀力量和力量发挥方面的影响。这也使得衡量守门员为每支球队做了什么变得不可能。考虑到一个赛季进球的样本量很小，我目前还没有信心使用岭回归来分离这方面的影响；尤其是在将这些样本进一步细分为三个更小的子样本之后，这三个子样本分别是平均强度、强力打法和短手打法。我计划在某个时候使用某种逻辑脊回归来重新审视这一点，因为我确实认为评估守门员和守门员表现的指标*应该*考虑到他们面对的各自守门员和射手的影响。不过，就目前而言，我对计算模型的拍摄和保存组件的方式感到满意。
*   因为在一些早期赛季，所有选手的工资数据都不容易获得，所以替代水平不再由 850，000 美元或更低的工资帽和 UFA 签约状态来定义。**更确切地说，替换等级是由冰时定义的，每个游戏强度的定义略有不同:**
*   实力相当时的替补水平定义为在冰上百分比实力相当时，队内排名低于第 13 位的所有前锋和排名低于第 7 位的所有防守队员。
*   替补级别是指在冰上的力量比赛时间百分比中，所有排名低于第 9 位的前锋和所有排名低于第 4 位的防守队员。
*   点球决胜中的替补级别定义为队中所有排名低于第 8 位的前锋和所有排名低于第 6 位的防守队员在场上的人手不足时间百分比。
*   所有情况下的替补水平(出于处罚目的)被定义为在所有情况下球队中排名低于第 13 位的所有前锋和排名低于第 7 位的所有防守队员的上场时间百分比。
*   守门员替换级别定义为在比赛中排名低于第二的所有守门员。
*   请注意，虽然在所有情况下都使用了罚分，但没有其他组件使用空网比赛。因为这个原因，在战争旁边出现的总冰上时间值，以及随后的战争/冰上时间比率，都没有将冰上时间与空网合并。
*   在所有情况下仍然使用点球，因为不可能从 NHL 的比赛数据中确定地得出点球是由守门员在网内进行的，还是守门员在抽签后被推迟点球。在守门员被拉下的情况下进行的处罚很少，所以这个问题的影响可以忽略不计，但这是值得注意的。
*   我之前使用 Christopher Long 的[方法计算了一个进球相对于一场胜利的价值，发现从 2017-2018 年到 2019-2020 年，一场胜利大约相当于 5.33 个进球。对于模型的 1.1 版本，我遵循克里斯托弗的方法，使用 2007-2008 年到 2020-2021 年的每个 NHL 赛季计算一个稳定的毕达哥拉斯指数:2.022。然后，我使用每个赛季每场比赛的联赛平均进球数——排除所有净胜球或点球大战中的进球数，就像我在模型的其余部分所做的那样——来确定每个赛季相当于一场胜利的进球数。以下是我获得的价值:](http://angrystatistician.blogspot.com/2016/06/a-simple-estimate-for-pythagorean.html)

```
╔══════════╦═══════════════╗
║ **Season**   ║ **Goals Per Win** ║
╠══════════╬═══════════════╣
║ 20072008 ║         5.051 ║
║ 20082009 ║         5.345 ║
║ 20092010 ║         5.201 ║
║ 20102011 ║         5.115 ║
║ 20112012 ║         4.989 ║
║ 20122013 ║         4.975 ║
║ 20132014 ║         5.002 ║
║ 20142015 ║         4.908 ║
║ 20152016 ║         4.853 ║
║ 20162017 ║         5.053 ║
║ 20172018 ║         5.375 ║
║ 20182019 ║         5.438 ║
║ 20192020 ║         5.422 ║
║ 20202021 ║         5.285 ║
╚══════════╩═══════════════╝
```

# 确认

我总结了对预期目标所做的更改，并在替换模型上取得了成功。但是有了 2007-2008 年的数据，我决定是时候使用整个样本来验证这些模型，看看这些老派的详细数据是否真的像它所描述的那样糟糕。

我用来验证我的**预期目标**模型的指标包括曲线下面积(AUC)，你可以在这里了解更多关于[的信息，以及每个实际目标的预期目标。以下是每个季节的测试指标值:](http://gim.unmc.edu/dxtests/roc3.htm)

```
╔══════════╦════════════════╦═══════╦═════════════════╗
║  **Season** ║ **Game Strength**  ║  **AUC**  ║ **xGoals per Goal** ║
╠══════════╬════════════════╬═══════╬═════════════════╣
║ 20072008 ║ All Situations ║ 0.769 ║           0.985 ║
║ 20072008 ║ Even Strength  ║ 0.778 ║           0.990 ║
║ 20072008 ║ Power Play     ║ 0.710 ║           0.977 ║
║ 20072008 ║ Shorthanded    ║ 0.767 ║           0.931 ║
║ 20082009 ║ All Situations ║ 0.775 ║           0.993 ║
║ 20082009 ║ Even Strength  ║ 0.783 ║           0.991 ║
║ 20082009 ║ Power Play     ║ 0.713 ║           1.000 ║
║ 20082009 ║ Shorthanded    ║ 0.815 ║           0.983 ║
║ 20092010 ║ All Situations ║ 0.760 ║           1.033 ║
║ 20092010 ║ Even Strength  ║ 0.767 ║           1.017 ║
║ 20092010 ║ Power Play     ║ 0.700 ║           1.071 ║
║ 20092010 ║ Shorthanded    ║ 0.787 ║           1.092 ║
║ 20102011 ║ All Situations ║ 0.773 ║           1.000 ║
║ 20102011 ║ Even Strength  ║ 0.782 ║           0.987 ║
║ 20102011 ║ Power Play     ║ 0.715 ║           1.031 ║
║ 20102011 ║ Shorthanded    ║ 0.773 ║           1.075 ║
║ 20112012 ║ All Situations ║ 0.775 ║           0.999 ║
║ 20112012 ║ Even Strength  ║ 0.781 ║           0.988 ║
║ 20112012 ║ Power Play     ║ 0.722 ║           1.028 ║
║ 20112012 ║ Shorthanded    ║ 0.807 ║           1.047 ║
║ 20122013 ║ All Situations ║ 0.771 ║           0.973 ║
║ 20122013 ║ Even Strength  ║ 0.779 ║           0.981 ║
║ 20122013 ║ Power Play     ║ 0.697 ║           0.929 ║
║ 20122013 ║ Shorthanded    ║ 0.780 ║           1.168 ║
║ 20132014 ║ All Situations ║ 0.773 ║           0.991 ║
║ 20132014 ║ Even Strength  ║ 0.781 ║           0.981 ║
║ 20132014 ║ Power Play     ║ 0.715 ║           1.042 ║
║ 20132014 ║ Shorthanded    ║ 0.783 ║           0.849 ║
║ 20142015 ║ All Situations ║ 0.771 ║           1.002 ║
║ 20142015 ║ Even Strength  ║ 0.778 ║           0.996 ║
║ 20142015 ║ Power Play     ║ 0.706 ║           1.013 ║
║ 20142015 ║ Shorthanded    ║ 0.812 ║           1.083 ║
║ 20152016 ║ All Situations ║ 0.771 ║           1.024 ║
║ 20152016 ║ Even Strength  ║ 0.780 ║           1.036 ║
║ 20152016 ║ Power Play     ║ 0.696 ║           0.996 ║
║ 20152016 ║ Shorthanded    ║ 0.782 ║           0.953 ║
║ 20162017 ║ All Situations ║ 0.771 ║           1.011 ║
║ 20162017 ║ Even Strength  ║ 0.777 ║           1.017 ║
║ 20162017 ║ Power Play     ║ 0.709 ║           1.002 ║
║ 20162017 ║ Shorthanded    ║ 0.789 ║           0.925 ║
║ 20172018 ║ All Situations ║ 0.766 ║           1.032 ║
║ 20172018 ║ Even Strength  ║ 0.772 ║           1.030 ║
║ 20172018 ║ Power Play     ║ 0.697 ║           1.050 ║
║ 20172018 ║ Shorthanded    ║ 0.828 ║           0.958 ║
║ 20182019 ║ All Situations ║ 0.762 ║           1.001 ║
║ 20182019 ║ Even Strength  ║ 0.771 ║           1.004 ║
║ 20182019 ║ Power Play     ║ 0.676 ║           0.991 ║
║ 20182019 ║ Shorthanded    ║ 0.798 ║           0.974 ║
║ 20192020 ║ All Situations ║ 0.772 ║           0.989 ║
║ 20192020 ║ Even Strength  ║ 0.779 ║           0.984 ║
║ 20192020 ║ Power Play     ║ 0.696 ║           1.004 ║
║ 20192020 ║ Shorthanded    ║ 0.821 ║           1.003 ║
║ 20202021 ║ All Situations ║ 0.774 ║           0.975 ║
║ 20202021 ║ Even Strength  ║ 0.782 ║           0.966 ║
║ 20202021 ║ Power Play     ║ 0.706 ║           0.994 ║
║ 20202021 ║ Shorthanded    ║ 0.813 ║           1.107 ║
╚══════════╩════════════════╩═══════╩═════════════════╝
```

预期目标模型在 2007-2008 至 2009-2010 赛季的表现略差于后来几年，但仍好于我的预期。注意，根据我引用的 AUC 文件，0.6 和 0.7 之间的值为差，0.7 和 0.8 之间的值为一般，0.8 和 0.9 之间的值为好；这意味着在所有的情况下，在相同的强度下，这个模型是公平的，在每一个赛季中更接近好的而不是坏的。无论前三季的位置坐标存在什么问题，都不足以阻止模型发布令人尊敬的性能。然而，在权力游戏中，该模型在 5 个赛季中被归类为差，在其他 9 个赛季中更接近差而不是好。

这些数字证实了**我对公众预期目标模型的总体立场:总的来说，它们是公平的，我要说它们更接近于好而不是坏。但是特别是在权力游戏上，他们忽略了很多重要的内容。**

在测试和验证了我的预期目标模型在每个赛季都是公平的之后，是时候测试我的**战争**模型了。虽然 WAR 本质上是描述性的，但是很难实现模型的描述性测试，我相信对过去结果的准确描述通常可以很好地预测未来的结果，所以我选择测试模型的描述性*和*预测能力。

WAR 模型的一个常见的**描述性**测试是测试团队级别的 WAR 总和与另一个指标(如积分或目标差异)之间的相关性，后者明确定义了团队质量。这个测试本质上是对 WAR 的恭维，因为它不一定测试 WAR 如何评估一个团队中的选手，而是 WAR 如何评估该团队选手作为一个整体的总和。

例如，假设我们有一个完美的战争模型，它会告诉我们，在 2018-2019 年，塞德里克·帕盖特为坦帕湾闪电队提供了-1 场战争，尼基塔·库切罗夫为他们提供了 5 场战争。这意味着他们的贡献总和是 4 战。现在，假设我建立了一个可怕的模型，说帕盖特值 5 次战争，库切罗夫值-1。他们战争的总和仍然是 4，这将完全符合他们贡献的真实组合价值。但是我对每个玩家都很不满意，我的模型在隔离他们的影响方面做得很糟糕。这是一个虚构的例子；没有人的模型说 Paquette 或 Kucherov 有任何接近的东西，但在我们开始分析我的描述性测试的结果之前，值得记住。

正如我提到的，我的战争模型的一些输出是通过岭回归得到的。这些回归将一个赛季中的每个球员视为一个整体，不管他们是否在赛季中更换球队。这意味着我不能将为多支球队效力的球员的贡献划分回他们效力的球队，因此测试该模型的最佳方式是完全移除这些球员。这实际上有点不讨好模型。以下是我第一次描述性测试的结果:

![](img/67a2bd87d242289acfff2d61a2e0616e.png)

0.82 的 R 值告诉我们，该模型可以解释每 82 场比赛中 82%的积分差异。其余的可以用为多支球队效力的球员所贡献的胜利、纯粹的运气和建模错误的某种组合来解释。

虽然这个值听起来很公平，但当我第一次看到它时，我发现它非常令人担忧。当我去年冬天发布我的模型的输出时，我使用了相同的精确测试方法，并获得了 0.89 的显著更高的 R 值。

![](img/d1bc1b4bcb62a66e5f7f1d65f39712aa.png)

这里发生了什么？模型变得明显更差了吗？

谢天谢地，没有。这只是适用于一系列季节，它并不十分有效。当在这张图片中测试 WAR 1.0 的同一三季中测试时，WAR 1.1 实际上表现稍好:

![](img/cfddda71f1679a300049242ff840af13.png)

我可以一整天都给出 R 值，但是如果没有某种比较或基线，这些值就没什么价值了。为了了解我们从使用战争中真正获得了多少价值，下一步是将其与曲棍球当前最流行的统计数据进行比较:点数。

分析社区的普遍共识是，战争和类似的模型远远优于点。如果这是真的，他们应该更好地描述团队层面的表现。

为了在平等的基础上比较两者，我首先删除了所有守门员，因为没有人关心守门员得分的多少，所以我们不会在任何一个测试中使用它们。从 2007-2008 年到 2020-2021 年，只使用滑冰运动员重复相同的测试，导致 R:

![](img/8dbe9038d14ee389e3de9fbe3dd60c23.png)

相比之下，点数的表现并不像分析社区可能认为的那样糟糕:

![](img/cea415080ff1325abd8c943748b4e74f.png)

我不得不承认，我对选手们的总分在这里保持得如此之好印象深刻。他们显然是劣等的，但不是我所期望的那样。这一证据表明，在没有更好的度量标准的情况下，用描述性的方式来使用分数绝对没有错。也就是说，我也认为有理由认为，虽然运动员总积分本身在描述团队层面的成功方面做得很好，但在团队中分配个人荣誉方面，他们可能比战争差得多，我们知道战争在这方面远非完美。

也许一个更好的方法来确定这些指标如何在队友之间恰当地分配信用，是转移到测试模型的**预测**能力。虽然一个模型说塞德里克·帕盖特是坦帕湾在 2018-2019 年成功的真正驱动力，可能已经通过了那个赛季的描述性测试，但一旦帕盖特换了球队，它就会大大失败，并有望以坦帕为代价为他的新俱乐部带来重大成功。

我为预测测试选择的方法仍然相当简单:使用目标指标作为第一年的比率统计，并将其插入到第二年玩家的游戏量中。在这种情况下，我首先在第一年使用 WAR 来预测第二年的排名:

![](img/095d1a97bea6e1ba9e444bc66b7f547b.png)

我获得了 0.35 的 R 值，这是相当可靠的:这意味着第二年运动员预期贡献的胜利数足以解释团队层面上 35%的积分差异。另外的 65%可以用一些因素来解释，比如运动员的表现比他们预期的更好或更差，模型从未见过的运动员，第一年比赛少于 10 场因而被忽视的运动员，守门员和纯粹的运气。

然后我用点数重复了同样的测试:

![](img/bae0ac9f3ac93bfcea49b41e94718182.png)

再一次，就像描述性测试一样，溜冰者的分数显然远远高于其他人，但他们比像我这样的分析极客可能建议的做得更好。再说一次，在没有更好的衡量标准的情况下，我认为使用选手的总分就可以了。

我也很好奇，想看看战争的方式是如何累积到像积分这样的团队级别的指标的。使用排名分数进行描述性测试是没有意义的，因为这样做意味着将第一年的排名分数与第一年的排名分数进行比较。这些是完全相同的指标，将为您提供 1.0 的 R。但是使用第一年的积分来预测第二年的积分是完全有效的，所以我也选择这样做:

![](img/53500fe0182f0cf6644ec6f3e8f5dbc0.png)

类似于运动员积分，单独的团体积分可以很好的预测未来的积分，但是它们不能叠加到战争中。如果你想确定下一年谁是最好的球队，并且你很清楚每个人会为每支球队打多少比赛，那么你会比只有去年的积分榜上的分数的情况好得多。

# 限制

这些模型有很多局限性:预期目标模型甚至不能被归类为好的，并且[推动一些战争组成部分的岭回归有很大程度的误差](https://topdownhockey.medium.com/determining-the-uncertainty-associated-with-rapm-1428316e9288)。我也相信在玩家层面，这种特殊的战争模式过于强调射击，而对游戏驾驶重视不够。这有两个原因:

1.  播放驱动成分通过岭回归获得，岭回归使系数偏向 0。这对于避免极端古怪的值是必要的，但这也意味着该模型可能会低估玩家在游戏驾驶上的真实每分钟贡献，并假设他们比实际情况更接近于平均玩家。
2.  替换级别射击远低于平均水平比替换级别玩驾驶。我肯定这是为什么，但我认为，虽然这种差异在数学上被夸大了，因为对于上场时间较少的球员，模型将系数偏向 0 的程度更高，但这种差异也确实存在，因为教练更容易识别并迅速减少投篮不佳的运动员的冰上时间。

如果我根据我个人认为重要的东西，以完全任意的方式来“衡量”每一个组成部分，这个模型将更少地强调射击，而更多地强调游戏驾驶。如果我用战争来判断一个团队的收购，我会记住这样一个事实，即游戏驱动部分比射击更具可重复性。

这完全是在说，战争不仅是对过去附加值的不完美估计，而且在预测未来业绩时，应该考虑比战争更多的东西。简而言之，战争作为任何讨论的起点比作为终点更好。

考虑到这些限制，我还将声明 WAR 是对仍然被更频繁引用的更基本的度量标准的明显升级。你不一定要喜欢或使用战争，但如果你每次看到战争都捂住眼睛，或每次听到战争都塞住耳朵，并坚持使用滑手点数来代替，你会错得更多。