# 重构糟糕代码的简单方法

> 原文：<https://towardsdatascience.com/the-simple-ways-to-refactor-terrible-code-983f563964fc?source=collection_archive---------13----------------------->

## 是时候克服对混乱的遗留代码的恐惧了，用一些简单的重构技巧让它更干净、更简单、更易读…

很多人试图避免重构，无论是因为他们害怕破坏代码，还是因为他们看不到直接的好处，或者他们只是假装没有时间去做。然而在现实中，重构无论从短期还是长期来看都是非常有益的，有很多理由在这上面花些时间。最常提到的可能是发现错误，使软件更容易理解或改进设计。

然而，在我看来，促使你去弄乱你的(或者可能是遗留的)糟糕代码的真正原因应该是,*重构帮助我们从我们自己的代码中摆脱恐惧*,并且帮助我们避免当我们不得不向别人展示我们的代码时的*羞耻感*。

因此，在这篇文章中，我们将介绍一些简单的方法来重构和大大改进您的代码，而不会同时破坏所有东西，这样您就不必害怕自己的代码或羞于向同事展示。

![](img/6bb62657c2fc42fdc4bf47a4909d5437.png)

爱丽丝·迪特里希在 [Unsplash](https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上的照片

# 最简单的改进

为了让你轻松地重构令人恐惧的代码库，我们将从简单但非常重要的改进开始，这些改进是文学无法打破的——首先是代码的重新格式化。

有几种方法可以修复代码格式。你可以修复代码块周围的错误缩进或缺失`{}`之类的问题，也可以采取更系统的方法。更系统的方法是创建一个风格指南，然后应用它(最好是执行它)。

我说我们应该*创建*一个样式指南，但是对于大多数编程语言来说，已经有了一套标准的约定，比如 PEP8 for Python 或者[Google Java Style Guide](https://google.github.io/styleguide/javaguide.html)for Java，你可以采用并使用工具或 ide 插件来帮助你找到并修复所有的格式问题。

不管你选择哪种方法，重要的是(小心地)选择一种风格并坚持下去，同时确保团队中的每个人都遵循相同的指南以保持事情的一致性。

重构的另一个安全区域是注释。只要它们是相关的、最新的和有用的，拥有它们就很好。但是大多数时候，你会发现很多应该被删除的评论。这些可能是描述不言自明的东西的多余注释或文档、注释掉的代码或应该更新的过时注释(如果不再相关，则删除)。在这三个代码中，我非常想强调注释掉的代码，因为很多人会说:*“但是我以后可能会需要它！”不，你不会的，别再骗自己了，现在就删除它，如果你将来真的需要它，你就能在`git`历史中找到它。*

> *说到注释，只要记住注释并不能弥补糟糕的代码。*

这一部分的最后一件事是死代码。它会造成混乱，你把它留在代码库中的时间越长，就越难删除，因为没有人知道它是做什么的，或者是否需要它。现在，任何像样的 IDE 都会告诉你不可到达的死代码，所以你不需要害怕删除它，所以只是摆脱它，没有理由把它放在那里。

# 低垂的果实

通常很容易找到要重构的东西，比如上面显示的简单改进。然而，如果你需要一些蹩脚代码的例子，那么这里有一个列表:

*   在我看来，花大量时间寻找好的变量、类或函数名是非常值得的。重构也很容易，可以极大地提高代码的可读性，而不会对脆弱的代码造成任何损害。那么，如何选择好名字呢？一般来说，对类使用名词——最好是非通用的(不，`Data`不是类的好名字)；函数和变量的动词(或整个短语)？
    嗯，命名变量并没有一个真正的规则，但是一般来说，任何描述性的和明确的规则都可以。说得更具体一些，更专业一些——你应该总是避免使用像`x`或`a`这样的单个字符的名字。对于布尔变量名，使用*“问题”*，例如`isReady`或`hasName`。通常人们不喜欢使用长的变量名，但是最好使用长名字，而不是使用无意义的名字(但是简洁的名字显然更好)。最后一个一般性建议是坚持使用单个字母的大小写——无论是`camelCase`、`snake_case`还是其他，选择一个并坚持使用(最好使用特定编程语言的约定和术语)。
*   类似于变量，常量也可以帮助你的代码变得更具可读性。因此，尝试用合理的命名常量替换任何神奇的数字/值，并使用`CAPITALIZED_WITH_UNDERSCORES`字母大小写。
*   另一个适合重构的东西是否定的条件句，它们令人困惑，难以阅读并且容易出错。不过它们很容易移除，因为这通常足以逆转`if` / `else`街区的尸体。正如我已经多次提到的，您的 IDE 可能能够为您发现被否定的条件，并提出修复建议。
*   我们已经讨论了适当的代码块格式，但是我想在这里提到一件我非常讨厌看到的事情，那就是当人们省略条件和循环的括号/主体时，例如(*注意:本文中的代码片段使用各种语言，因为所有的提示都是与语言无关的*):

如果您像这样省略大括号，您可能会节省一行代码，但实际上您只是在为一些讨厌的长时间调试做准备。除此之外，如果您需要在这样的一行程序中设置断点，您会发现您不能真正正确地设置断点，因为您只能在整行上设置断点，而不仅仅是在条件或循环中的部分。

*   最后但同样重要的是垂直分隔——或者换句话说——变量的定义和它们的用法之间的巨大距离。变量，还有函数和方法都应该尽可能地靠近它们被使用的地方来定义，以便于阅读代码。局部变量定义中的大垂直距离及其用法可能是函数太大的标志，应该分解成较小的函数。

> *最基本的规则:只做微小的改动，重新测试。*

# 深入挖掘

既然您已经浏览了一些代码，并对修改它有了更多的信心，那么您可能想要更深入地挖掘，寻找代码中更具体的缺陷。您肯定会发现的一个缺陷是重复代码。关于代码复制的简单经验法则是，如果你将同一段代码重复 3 次，就该将它提取到单独的函数或变量中。

另一个常见缺陷可能是布尔参数的过度使用。将布尔参数传递给一个函数可能表明这个函数正在做不止一件事情，因此应该分成(至少)两个更小的部分。

说到函数参数——您有时可能会遇到修改输入参数的坏习惯。参数是函数输入，仅此而已——将它们用作输入，不要改变它们的值。如果您在代码中看到这个缺陷，最好将值复制到新变量中，并避免修改参数。

与参数相关的最后一个问题是，您可能需要注意参数过多的函数。最多 3 个参数通常是好的，但是看到任何更多的参数都应该引起怀疑。您应该检查这样的函数，并决定是否可以使用这么多参数，或者是否最好分解和/或简化函数。

转到变量，您可能会遇到两个基本问题，首先是冗余的临时变量。这看起来会像这样:

使用这种变量没有任何用处。它使代码变得更长，并且没有以任何方式解释或提高可读性，所以我们应该删除它并像这样内联它:

另一个常见问题与上述相反，即代码缺少变量，例如:

与前一期不同，这段代码将受益于一些额外的变量，这些变量将有助于解释代码的作用。这也会简化调试，因为为每个变量设置断点和*观察*会更容易。重构版本可以看起来像这样:

本节中最后一个重构的候选对象非常容易识别——它是复杂/复合条件的。我们都见过那些由几个`&&`和`||`组合在一起的巨大的多行条件句。它们很难看，难以解析，难以调试，也难以修改。消除它的最简单的方法——或者更确切地说是抽象它——是将其提取到单独的检查函数中。例子看起来是这样的:

# 遗留代码

为了能够有效地重构我们的代码，我们需要有一个合适的测试覆盖率，否则我们就冒着破坏现有功能的风险。在前面的章节中，我假设我们有测试，因此可以修改代码并运行测试套件来验证一切正常。

但是我们如何重构没有适当测试覆盖的代码——或者换句话说，我们如何重构*遗留代码*？在我们不能依赖测试的情况下，我建议只改变那些必须改变的东西，那些有需要修复的 bug 的代码或者我们正在添加新特性的代码库的一部分。在这些领域中，首先为现有的遗留代码编写测试，然后才进行任何代码修改。我个人会首先重构旧代码，让自己熟悉它，让它更“欢迎”必要的改变。

从这一点上来说，你可以像处理任何其他需要重构的代码一样继续进行——一步一步来，从小的简单的改变开始，并且频繁地重新测试。

# 利用工具

重构和通常情况下对代码的精心处理是非常耗时的，这在时间紧迫的项目中或者在截止日期临近的时候可能会成为问题。这是人们把所有好的实践都扔出窗外，并试图尽快*“出货就好”的时代。*

*为了减轻这种压力，即使在看起来没有时间的时候也能更容易地继续重构和改进代码，请尝试使用能够为您做一些工作的工具。这些工具可以是像`pylint`这样的 linters，像 [Checkstyle](https://checkstyle.sourceforge.io/) 这样的代码检查器，或者像 [Sonarqube](https://www.sonarqube.org/) 这样的代码覆盖工具。*

*谈到代码覆盖和测试——也要确保你的测试套件是快速的，否则你将最终放弃缓慢的测试或者根本不运行套件。*

*在理想的情况下，所有这些都应该使用某种 CI/CD 管道来实现自动化，这将使用强制质量检查来运行代码检查，在构建和部署之前报告任何代码风格不一致、任何可能的错误或问题。*

# *结论*

*本文并不是*“所有重构的事情”*的详尽列表。要获得更多的列表和例子，你一定要看看鲍勃大叔的《干净的代码》(尤其是第九章《气味和启发》(T10))或者马丁·福勒的《重构》(T11、T12、T13、T14)。*

*不管你决定遵循哪个指南或书籍，最终都归结为几个简单的规则。总是试着让代码比以前干净一点——这样你可以缓慢但肯定地重构并提高整体质量，而不用花费太多的精力和时间。同时，不要推迟重构，因为*以后再做通常意味着永远不做*，这会导致遗留代码一团糟。*

**本文原帖*[*martinheinz . dev*](https://martinheinz.dev/blog/40?utm_source=tds&utm_medium=referral&utm_campaign=blog_post_40)*

*[](/writing-more-idiomatic-and-pythonic-code-c22e900eaf83) [## 编写更加地道和 Pythonic 化的代码

### 使你的 Python 代码可读、有效、简洁和可靠的习惯用法和惯例。

towardsdatascience.com](/writing-more-idiomatic-and-pythonic-code-c22e900eaf83) [](/networking-tools-every-developer-needs-to-know-e17c9159b180) [## 每个开发人员都需要知道的网络工具

### 让我们学习被忽视的网络技能，如检查 DNS 记录，扫描端口，排除连接故障…

towardsdatascience.com](/networking-tools-every-developer-needs-to-know-e17c9159b180) [](/hidden-features-of-chrome-devtools-33d9de390dc0) [## Chrome DevTools 的隐藏功能

### 使用这些 Chrome DevTools 提示和技巧，成为一个更高效的 web 开发人员。

towardsdatascience.com](/hidden-features-of-chrome-devtools-33d9de390dc0)*