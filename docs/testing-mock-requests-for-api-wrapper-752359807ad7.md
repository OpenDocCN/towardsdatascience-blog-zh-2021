# 测试:对 API 包装器的模拟请求

> 原文：<https://towardsdatascience.com/testing-mock-requests-for-api-wrapper-752359807ad7?source=collection_archive---------7----------------------->

## 你想成为一名机器学习工程师吗？使用模拟 http 请求的测试来改进您的编程项目。

# TL；速度三角形定位法(dead reckoning)

*   构建您自己的 ML 项目
*   一个好的选择是使用 twitter API，因为它允许您访问当前的数据，并且可以扩展到大规模
*   当构建一个需要长期维护的机器学习项目时，编写测试。
*   API 包装的测试是特殊的。您不能依赖简单的请求来进行测试，因为您接收的数据会不时发生变化。这就是为什么你需要模拟请求。
*   python 模拟请求的库叫做 responses。我给你看几个例子来开始。

![](img/4b49a47b87445ca234f7432ed0bc8783.png)

[JESHOOTS.COM](https://unsplash.com/@jeshoots?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍照

# 介绍

我希望你知道，如果你没有该行业的工作经验，建筑项目是向未来雇主展示你是合适人选的首选方式。

这就是为什么我开始自己为 twitter API 构建一个包装器。开始这个项目后不久，我提醒自己，我想做一个像样的项目。模仿机器学习工程师在行业中的工作方式。我开始使用 git 和版本控制。感觉还不够。我想尽可能远离修补代码，我想比以前更认真、更有条理地工作。

从这个角度来看，我确信我想用一个或多个测试套件来测试我的代码。我知道如何编写简单的测试。简单的方法包括实例化一个类，然后检查字段的属性是否正确，或者向一个函数提供一个输入，然后用期望的输出检查函数的输出。但是为 API 包装器或与外部数据库交互的程序编写测试，编写测试稍微复杂一些。

但是你知道这个。采取行动并了解模拟请求，通过您的机器学习项目加速您的学习。

# 测试要求

**专注**

我们希望我们的测试集中在特定的代码上，也就是说一个单独的方法或类。如果我们的测试失败了，我们知道我们必须检查哪个代码区域出现了缺陷。因此，测试应该关注尽可能少的行。这使得发现缺陷更加容易。

**可预测的**

这是非常重要的一点，可能对你来说是显而易见的，但是永远不要忽视你的测试的可预测性。否则你的测试体验将是不愉快的、低效的和令人困惑的。如果你在数据 x 上测试你的函数 foo，你希望每次都得到相同的答案，而且它不应该依赖于月亮的位置或其他任何东西。

**快**

时间就是金钱。我们都听说过这句话。如果您的测试持续的时间更长，您的改进周期将会花费更多的时间，并且您的代码将会延迟发布。

# 使用外部数据源进行测试

**使用外部数据源的挑战(限制)**

*   由于来自外部数据源的数据可能会改变，所以您的测试可能是不可预测的。因此，您受数据源的支配。
*   连接和接收数据造成的延迟会降低测试速度
*   限制和上限:如果你从一个 API 接收实时数据，你的请求是有速率限制的，也许你有一个上限，规定你一个月内可以发出多少个请求。因此，如果您的测试需要数据来测试代码的功能，您会用完每月的请求。

> *如果我们嘲笑我们的要求，我们的要求可以被满足，我们的限制可以被克服*

# 模仿请求(解决方案)

如果我们嘲笑我们的请求，我们从我们的请求中得到的数据不会随着时间而改变。我们不必连接数据库并从数据库接收数据，然后等待数据到达。而且我们不会用尽我们可能有上限的有价值的请求。

这些测试是

*   快速(无连接和数据传输)
*   可预测(我们可以控制测试的数据)
*   专注(我们不需要测试外部依赖)

# 什么是模拟请求？

通过模拟请求，我们模拟了代码和外部数据源之间的交互，这样我们就可以完全控制这种交互。我们用一个所谓的模拟请求来模拟请求。从前面的章节中我们了解到，如果我们编写一个有外部依赖的测试，我们会使用这个过程。通过使用模拟方法，我们可以隔离并关注被测试的代码，而不是行为或与外部依赖的交互。但是请记住，这只有在我们的代码基于接口的情况下才是可能的，这样，只要它实现了我们的接口，传递到我们的系统中的具体内容并不重要。

> *对一个界面进行编程是嘲讽起作用的原因。我们可以传入模拟或伪造的对象，这些对象模拟来自外部数据源的实际运行时对象。*

要知道嘲讽框架是对单元测试框架的补充。他们不能替代那些。模仿框架隔离了依赖性，因此有助于编写更简洁的单元测试。

# 如何模仿请求？

我将展示我在自己的项目中做的几个例子，并解释工作机制，以便您可以更容易地开始。

首先，这个简短的教程将用 python 和 **unittests** 来完成。为了继续工作，我建议您在 unittest 旁边导入名为 [**responses**](https://github.com/getsentry/responses) 的库。Responses 也有名为 GET 和 POST 的类。他们将被用来嘲笑`requests.get()`或`requests.post()`。

让我们看看我们的第一个例子。我向您展示了一个测试，它应该检查我的函数`getUser()`是否正确地检索和存储数据并返回一个用户对象。我将展示两种可能性来测试功能`getUser()`。

## 用回应来嘲笑。RequestsMock()

我要你把注意力集中在几行上:

3:我们创建一个响应实例

4:这个实例然后被用来激活功能，否则`requests.get()`不会触发库`responses`来模拟响应

6–8:这非常重要，因为您不通过数据库或 API 接收数据，您需要自己存储数据。这使得测试可预测且快速。

10: `responses.add()`是对你从`requests.get()`得到的每个响应进行排队，所以如果你的函数调用`requests.get()`两次，你也需要写`responses.add()`两次。您每次需要的参数是`GET`或`POST`，`URL`必须匹配传入`requests.get()`的 url 和`requests.get()`返回的数据，而不是在非测试环境下返回的真实数据。

13:在这一行中,`requests.get()`被调用，但并不连接到 url，而是接收到一个您用`responses.add()`排队的模拟响应

15–17:您通常在其他测试中写的行也是这样吗

20，21 *(自愿*):这两行只有在测试排队且无论如何都不清理的情况下才是必需的。在单元测试中，通常有两个函数`setUp()`和`tearDown()`。如果你想基于`setUp()`中的一个请求实例化一个应该在每个测试用例中使用的对象，你需要调用 cleanup，因为排队的响应可能会干扰你想运行的后续测试。否则，将这两行保留在函数`tearDown()`中。下一种方法不需要使用第 3、4、20、21 行，但是如果您需要前面提到的链式事件，就容易出错。

## 用@responses.activate 模仿

这个版本使用了一个装饰器，和`responses.start()`有相同的效果。它用于激活功能，否则`requests.get()`不会触发库`responses`模拟响应。其他方面都差不多，但是请记住我之前提到的警告！

# 可能的错误和解决方案

我必须承认，我对这个话题也相当陌生，有时思考你收到的错误可能有点令人生畏。我决定列出几个和我的理由，让他们离开我的方式。

## 资源定位符

您需要为函数`responses.add()`提供的一个东西是 URL。有时，您会得到一个类似如下的错误:

`requests.exceptions.ConnectionError: Connection refused by Responses - the call doesn't match any registered mock.`

请确保它与提供给`requests.get()`的 url 相匹配，否则一个巧妙的技巧是提供一个匹配不同 URL 的正则表达式。例如，当使用 twitter API 时，url 总是看起来像这样:`https://api.twitter.com/2`您可以提供一个正则表达式:

## 数据类型

我曾经收到过这样的错误消息:

`TypeError: a bytes-like object is required, not ‘dict'`

我意识到我错误地以这种方式加载了数据:

然而，如果你知道`json.load(f)`创建了一个 [python 对象，一个字典。但是我想提醒你，响应和请求只需要一个类似字节的对象。](/working-with-json-data-in-python-45e25ff958ce)

谢谢你一直读到最后。作为答谢，我总结了本文中最重要的几个方面。

# 摘要

我向你介绍了一个简短的介绍，希望能让你相信，为了让你的 ML 项目有更高的测试覆盖率，模拟是必要的。为了满足与外部数据库交互的功能的测试需求，如焦点、速度和可预测性，使用模拟。我还向您展示了如何使用名为 responses 的库来模拟 python 中的请求。

# 我在 towardsdatascience 上发表的其他文章

## 最受欢迎

</learn-git-branches-with-your-ml-project-7f58bdf1ae80>  

## 阅读最多

</learn-git-basics-for-your-ml-project-46ecf03865b>  

## 与本文相关

</working-with-json-data-in-python-45e25ff958ce>  

**撰写本文所需的资源**

<https://github.com/getsentry/responses> 