# 成功持续培训战略的框架

> 原文：<https://towardsdatascience.com/framework-for-a-successful-continuous-training-strategy-8c83d17bb9dc?source=collection_archive---------28----------------------->

## 什么时候应该重新培训模型？应该使用哪些数据？应该重新培训什么？数据驱动的方法

![](img/fba66c698198862c1a53ce574605983c.png)

*Monika Pejkovska 在 Unsplash 上拍摄的照片*

> 这篇文章是我和我的同事[李然·纳胡姆](https://medium.com/u/67435b765449?source=post_page-----8c83d17bb9dc--------------------------------)合著的

ML 模型建立在这样的假设上，即生产中使用的数据将与过去观察到的数据相似，即我们用来训练模型的数据。虽然对于某些特定的用例来说这可能是正确的，但是大多数模型都工作在动态数据环境中，在这种环境中，数据不断变化，并且很可能发生“概念漂移”,从而对模型的准确性和可靠性产生负面影响。

为了解决这个问题，需要定期对 ML 模型进行再培训。或者如谷歌的“ [MLOps:机器学习中的连续交付和自动化管道](https://cloud.google.com/solutions/machine-learning/mlops-continuous-delivery-and-automation-pipelines-in-machine-learning)”:::*为了应对这些挑战并保持你的模型在生产中的准确性，你需要做以下事情:积极监控你的模型在生产中的质量[……]并经常重新培训你的生产模型。*“这个概念叫做‘持续培训’**(CT)，是 MLOps 实践的一部分。持续训练旨在自动和持续地重新训练模型，以适应数据中可能发生的变化。**

**进行持续再培训有不同的方法，每种方法都有自己的优点、缺点和成本。**然而，与赤脚走路的鞋匠类似，我们——数据科学家——似乎过度进行再培训，有时是手动的，并经常将其作为“默认”解决方案** **，而没有足够的生产驱动的洞察力。****

**每个 ML 用例都有自己的动态数据环境，可能会导致概念漂移:从实时交易，到对手改变数据分布的欺诈检测，或具有大量新电影和新趋势的推荐引擎。然而，不管用例如何，在设计持续培训策略时，需要解决三个主要问题:**

****1 —什么时候应该重新培训模型？**由于目标是保持运行高度相关的模型，并且在任何时间点都以最佳状态运行，那么应该多长时间对模型进行一次再培训**

****2 —应该使用哪些数据？**选择适当数据集的常见假设是，数据的相关性与其最近的时间相关，这引发了一系列问题:我们应该只使用新数据还是添加旧数据集？什么是新旧数据的良好平衡？多新的数据被认为是新数据，或者新旧数据的分界是什么时候？**

****3 —应该重新培训什么？**我们能否替换数据，用相同的超级参数重新训练相同的模型？或者我们应该采取一种更具侵入性的方法，运行一个完整的管道来模拟我们的研究过程？‍**

> **上述三个问题中的每一个都可以单独回答，并有助于确定每种情况下的最佳策略。然而，在回答这些问题的同时，还有一系列需要考虑的因素，我们在此进行了研究。对于每个问题，我们描述了不同的方法，对应于 ML 过程的自动化和成熟度的不同水平。**

# **什么时候重新培训？**

**三种最常见的策略是:定期再培训、基于绩效或基于数据变化。**

## **定期再培训**

**定期再训练计划是最简单直接的方法。通常基于时间:模型每 3 个月重新训练一次，但也可以基于数量，即每 10 万个新标签。**

**定期再培训的优势同样简单明了:这是一种非常直观和易于管理的方法，因为很容易知道下一次再培训迭代将在何时发生，并且很容易实现**。****

****![](img/0937a75efa58467562b103c63004c216.png)****

*****作者图片*****

****然而，这种方法经常暴露出不合适或者效率低下。你多久对模特进行一次再培训？每天？每周吗？每三个月？一年一次？虽然人们希望频繁地重新训练以保持我们的模型更新，但是在没有实际原因(即没有概念漂移)的情况下过于频繁地重新训练模型是昂贵的。此外，即使再培训是自动化的，它也需要重要的资源，包括计算资源和数据科学团队的资源，他们需要在部署后监督再培训流程和生产中的新模型行为。然而，大间隔的再训练可能会错过连续再训练的要点，并且无法适应数据的变化，更不用说对有噪声的数据进行再训练的风险了。‍****

> ****在一天结束时，如果频率与你的领域的动态相一致，定期的再培训计划是有意义的。否则，选择一个随机的时间/里程碑可能会使您面临风险，并且留给您的模型会比先前版本的相关性更低。****

## ****基于性能的触发器****

****这几乎是一个常识性的说法，基于一句古老的工程格言:“如果它没坏，就不要修理它。”确定何时重新训练的第二个最常见的方法是利用基于性能的触发器，并在检测到性能下降时重新训练模型。****

****![](img/8d00bd7c2603d92c248b680d0a1a50e1.png)****

*****作者图片*****

****这种方法比第一种方法更具经验性，它假设您对模型在生产中的性能有一个连续的视图。****

****当仅仅依靠表现时，主要的限制是你获得你的基本事实所花费的时间——如果你获得它的话。在用户转化预测案例中，可能需要 30 或 60 天才能获得基本事实，在交易欺诈检测或 LTV 等案例中甚至需要 6 个月或更长时间。如果你需要等很长时间才能得到完整的反馈，那就意味着在业务已经受到影响之后，你再培训这个模型就太晚了。****

****另一个需要回答的重要问题是:什么被认为是“性能下降”？您可能依赖于阈值的灵敏度和校准的准确性，这可能会导致您过于频繁或不够频繁地重新训练。‍****

> ****总的来说，使用基于性能的触发器有利于快速反馈和大量数据的用例，如实时竞价，在这种情况下，您可以在尽可能接近预测时间的时间间隔内，以高置信度(大量)测量模型的性能。‍****

## ****由数据变化驱动****

****这种方法是最动态的，自然会从领域的动态性中触发再训练。通过测量输入数据的变化，即模型使用的要素分布的变化，您可以检测数据漂移，这表明您的模型可能已经过时，需要保留新数据。****

****对于没有快速反馈或无法实时评估模型在生产中的性能的情况，这是基于性能的方法的替代方法。此外，即使在快速反馈的情况下，结合使用这种方法也是一种很好的做法，因为这可能表明性能不佳，甚至没有降级。**了解数据变化以开始再培训过程是非常有价值的，尤其是在动态环境中。******

****![](img/76e6cb44466b295a630de6e209c1433d.png)****

*****截图自 superwise.ai*****

****上面的‍The 图由监控服务生成，显示了一个营销用例的数据漂移指标(上图)和性能 KPI(下图)。数据漂移图是一个时间轴，其中 Y 轴显示每天(即这一天的数据)相对于训练集的漂移水平。在这个营销用例中，新的营销活动被频繁引入，业务扩展到新的国家。**显然，生产中的数据流正在漂移，变得越来越不像模型训练所依据的数据。**通过更全面地了解生产中的模型，可以在业务部门观察到性能下降之前触发再培训迭代。‍****

> ****那么什么时候再培训呢？这取决于关键因素，例如:反馈的可用性、数据量以及模型性能的可见性。总的来说，在选择合适的时间进行再培训的问题上，没有一个放之四海而皆准的标准。相反，根据您的资源，目标应该是尽可能以生产为导向。****

# ****应该使用哪些数据？****

****虽然我们已经看到时间就是一切(例如:我什么时候重新培训我的模型？)，现在我们来看看所有 MLOps 的神经:数据。再培训时，我如何选择要使用的正确数据？****

## ****固定窗口大小****

****最简单的方法是使用固定的窗口大小作为训练集。例如，使用最近 X 个月的数据。显然，该方法的优点在于其简单性，因为它非常直接。****

****缺点来自选择正确窗口的挑战:如果窗口太宽，它可能会错过新的趋势，如果窗口太窄，它会过度拟合和嘈杂。窗口大小的选择还应该考虑再训练的频率:如果只使用上个月的数据作为训练集，那么每 3 个月再训练一次是没有意义的。****

****此外，选择的数据可能与生产中正在传输的数据有很大不同，因为它可能紧接在变更点之后发生(在快速/突然变更的情况下)，或者可能包含不规则事件(例如，节假日或选举日等特殊日子)、数据问题等。‍****

> ****总的来说，与任何其他“静态”方法一样，修复窗口方法是一种简单的启发式方法，在某些情况下可能效果很好，但在变化率多种多样且经常发生不规则事件(如假期或技术问题)的情况下，将无法捕捉到您环境的超动态性。‍****

## ****动态窗口大小****

****动态窗口大小方法试图通过以更数据驱动的方式确定应该包括多少历史数据，以及通过将窗口大小视为可以作为再训练的一部分进行优化的另一个超参数，来解决预定义窗口大小的一些限制。****

****这种方法最适合有快速反馈的情况(即:实时投标或食品交付 eta)。最相关的数据可以作为测试集，可以在上面优化窗口大小，就像模型的另一个超参数一样。在下面的例子中，最高的性能是通过最后 3 周获得的，这是这个迭代应该选择的。对于将来的窗口，根据与测试集的比较，可以选择不同的窗口。****

****![](img/d627f02b754277109e3a71d286f6f052.png)****

*****作者图片*****

****动态窗口大小方法的优势在于，它更多地由数据驱动，基于模型性能(这是真正的底线),因此它对于高度时态的环境更健壮。****

****缺点是它需要一个更复杂的训练管道(见下一个问题“训练什么”)来测试不同的窗口大小并选择最佳的一个，并且它需要更多的计算。此外，像固定的窗口大小一样，它假设最近的数据是最相关的，但这并不总是正确的。****

## ****动态数据选择****

****选择数据来训练模型的第三种方法寻求实现任何再训练策略的基本目标，并且是任何 ML 模型的基本假设:使用与生产数据相似的训练数据。或者换句话说，模型应该根据与现实生活中使用的数据尽可能相似的数据进行重新训练，以发布预测。这种方法很复杂，需要生产数据的高度可见性。****

******要做到这一点，您需要对生产中的数据演变进行彻底的分析，以了解它是否以及如何随时间而变化。**一种方法是计算每两天之间输入数据的偏差，即某一天的数据与另一天的数据有多大差异，并生成一张显示数据随时间变化模式的热图，如下图所示。下面的热图是一段时间内漂移评估的可视化，其中轴(列和行)是日期，每个点(矩阵中的单元格)是两天之间的漂移水平，漂移越高，单元格越红。****

****![](img/f82f5ec268291654b178173f274274f7.png)****

*****作者图片*****

****上图中，您可以看到这种分析的结果，它有助于找出与当前正在传输的数据尽可能相似的数据。从这个观点中可以很容易地得出不同类型的见解:****

****1-12 月与其他数据(之前和之后)非常不同。这种洞察力使我们能够避免将整个期间视为一个整体，并排除那些您想要重新培训的日子，因为本月的数据并不代表您在生产中观察到的正常数据。****

****2-数据的季节性可以可视化——这可以引发对工作日和周末使用不同模型的必要性的讨论。‍****

> ****这里还有一件非常重要的事情:你实际上可以有一张图片来证明最近的数据不一定是最相关的。****

****‍in·肖特:选择正确的数据来重新训练模型需要对生产中的数据行为有一个透彻的了解。虽然使用固定或动态的窗口大小可能有助于您“勾选方框”，但它通常仍然是一种猜测，可能成本更高，效率更低。****

# ****应该重新培训什么？****

****既然我们已经分析了什么时候再培训，应该使用什么数据，让我们来解决第三个问题:应该再培训什么？人们可以选择仅基于新数据重新训练(改装)模型实例，以包括一些或所有数据准备步骤，或者采取更具侵入性的方法并运行模拟研究过程的完整管道。****

****再培训的基本假设是，在研究阶段培训的模型将由于概念漂移而变得过时，因此需要再培训。然而，在大多数情况下，模型实例只是在研究阶段构建的更广泛的管道的最后一个阶段，并且包括数据准备步骤。问题是:漂移及其影响有多严重？或者在再培训的背景下，模型管道的哪些部分应该受到挑战？****

****在研究阶段，您在模型管道步骤中试验和评估许多元素，以优化您的模型。这些要素可以分为两个高级部分，数据准备和模型训练。负责准备数据的数据准备部分(咄！)供模型使用，包括特征工程、缩放、插补、降维等方法。模型训练部分负责选择最优模型及其超参数。在流程的最后，您将获得一系列连续的步骤，这些步骤获取数据，准备供模型使用，并使用模型预测目标结果。****

****仅用新的相关数据重新训练模型，即流水线中的最后一步，是最简单和最天真的方法，并且可能足以避免性能下降。然而，在某些情况下，这种仅提供模型的方法可能是不够的，应该对再培训的范围采取更全面的方法。扩大再培训的范围可以从两个方面进行:****

****1 — **再培训什么？**应该使用新数据重新培训管道的哪些部分？****

****2 — **再培训的级别:**您是否只是用新数据来重新调整模型(或其他步骤)？你做超参数优化吗？还是挑战模型本身的选择并测试其他模型类型？****

****另一种看待这个问题的方式是，在再培训过程中，你基本上试图自动化并避免模型优化研究的手动工作，如果没有自动化的再培训过程，这些工作将由数据科学家完成。因此，你需要决定你想在多大程度上尝试和模仿人工研究过程，如下图所示。****

****![](img/68ddeb8c93624b9987278487c8e656bd.png)****

*****MLOps:机器学习中的连续交付和自动化管道*中描述的模型研究阶段****

****‍Note 认为，自动化流程的第一步更加复杂，随着围绕这些实验建立的自动化程度越来越高，流程变得更加健壮和灵活，以适应变化，但这也增加了复杂性，因为需要考虑更多的最终案例和检查****

# ****示例和结论****

****让我们以一个简单的模型管道为例，它是我们的 awesome 数据科学团队为一些分类任务进行的手动研究的结果:****

****![](img/5a198b5056498b1a098fc830092df1c7.png)****

*****作者图片*****

****您可以采取简单的方法，只需重新训练模型本身，让它学习新的树，或者您可以包括一些(或所有)数据准备步骤(例如，重新学习估算器中的平均值或缩放器中的最小/最大值)。但是除了选择要重新训练的步骤之外，你还需要决定要训练到什么水平。例如，即使您选择只对模型进行重新培训，也可以在多个级别进行。您可以只重新训练模型本身，并让它学习一个新的树，即 model.fit (new_X，new_y)，或者您可以搜索并优化模型 hyper 参数(最大深度、最小叶大小、最大叶节点等)。)或者甚至质疑模型本身的选择并测试其他模型类型(例如逻辑回归和。随机森林)。数据准备步骤也可以(也应该)重新训练，以测试不同的定标器或不同的插补方法，甚至测试不同的特征选择。****

****当选择采用更全面的方法并执行超参数优化/模型搜索时，您还可以使用 Auto-ML 框架，这些框架旨在自动执行构建和优化模型管道的过程，包括数据准备、模型搜索和超参数优化。而且不一定要涉及复杂的元学习。这很简单:用户选择一系列模型和参数。有很多工具可用: [AutoKeras](https://autokeras.com/) ， [Auto SciKitLearn](https://github.com/automl/auto-sklearn) 。然而，尽管 AutoML 很有吸引力，但它并不能免除用户在模型的整个生命周期中拥有一个健壮的过程来跟踪、测量和监控模型，尤其是在生产中部署它们之前和之后。****

****最终，“拨动开关”和自动化您的过程必须伴随着健壮的过程，以确保您保持对您的数据和模型的控制。****

> ******为了实现高效的持续培训，你应该能够以生产驱动的洞察力为主导。对于任何一个用例来说，创建一个健壮的 ML 基础设施在很大程度上依赖于实现对模型健康和生产中数据健康的可见性和控制的能力。这是成为数据驱动的数据科学家所必需的；)******