# ä½¿ç”¨ FastAPI éƒ¨ç½² ML æ¨¡å‹â€”â€”ç®€æ˜æŒ‡å—

> åŸæ–‡ï¼š<https://towardsdatascience.com/deploying-an-ml-model-with-fastapi-a-succinct-guide-69eceda27b21?source=collection_archive---------10----------------------->

## å¦‚ä½•ä½¿ç”¨ NLP æ¨¡å‹ä½œä¸º APIâ€”â€”æ™ºèƒ½çš„ã€ç”Ÿäº§å°±ç»ªçš„æ–¹å¼ã€‚

![](img/181ae1226f75564de2ce86af0bb0050c.png)

ç…§ç‰‡ç”±[å†‰è´å°”ç§‘ç»´å¥‡](https://unsplash.com/@berko?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

FastAPI æ˜¯ä¸€ç§æ›´æ–°ã€æ›´å¥½çš„æ–¹æ³•ï¼Œå¯ä»¥å°†æ‚¨çš„æœºå™¨å­¦ä¹ æ¨¡å‹éƒ¨ç½²ä¸º REST APIï¼Œç”¨äº web åº”ç”¨ç¨‹åºã€‚åœ¨ä»–ä»¬çš„[å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)ä¸­ï¼Œä»–ä»¬å£°ç§°è¿™æ˜¯å¯åŠ¨å¹¶è¿è¡Œç”Ÿäº§çš„æœ€å¿«æ–¹æ³•ï¼Œè‡ªç„¶ï¼Œè¿™æ¿€èµ·äº†æˆ‘çš„å…´è¶£ã€‚

> å‡†å¤‡å¥½æ¢ç´¢è¿™ä¸ªæ–°çš„åº“ï¼Œæˆ‘ç»§ç»­å‰è¿›ï¼Œç”¨ **spacy** åšäº†ä¸€ä¸ªç®€å•çš„ NLP æ¨¡å‹ï¼Œå¹¶è¯•å›¾å›´ç»•å®ƒæ„å»ºä¸€ä¸ª APIã€‚è€å®è¯´ï¼Œå®ƒç›¸å½“ç®€å•ï¼Œéå¸¸æ–¹ä¾¿ï¼Œæœ‰æ— æ•°æœ‰ç”¨çš„å‡½æ•°ï¼Œæˆ‘åœ¨ä¸åˆ°ä¸€ä¸ªå°æ—¶çš„æ—¶é—´é‡Œå°±å‡†å¤‡å¥½äº† APIâ€”â€”è¿˜æœ‰æµ‹è¯•ï¼Œä¹Ÿæ²¡æœ‰ Postman æˆ– CURLã€‚

ç‚’ä½œå¤Ÿäº†å§ï¼Ÿä¸‹é¢æˆ‘æè¿°ä¸€ä¸‹*ä½ *å¯ä»¥ç”¨ä½ è‡ªå·±çš„ ML æ¨¡å‹åšåŒæ ·çš„äº‹æƒ…çš„æ­¥éª¤ã€‚

ğŸ‘‡æˆ‘ä»¬èµ°å§ï¼

## è®¾ç½®æ‚¨çš„ç¯å¢ƒ

è®¾ç½®è™šæ‹Ÿç¯å¢ƒçš„ä¸¤ä¸ªç®€å•æ­¥éª¤:

1.  æ¿€æ´»æ–°çš„ **pipenv** env:

```
pipenv shell
```

2.åœ¨å…¶ä¸­å®‰è£…åº“:

```
pipenv install spacy spacytextblob pydantic fastapi uvicorn
```

## æ„å»ºæ¨¡å‹

åœ¨å°è¯•ä»»ä½•æ–°çš„åº“æ—¶ï¼Œæˆ‘æ€»æ˜¯æ›´ä¸“æ³¨äºæ¢ç´¢åº“æä¾›çš„ç¡®åˆ‡åŠŸèƒ½ï¼Œè€Œä¸æ˜¯èƒŒæ™¯ç»†èŠ‚ã€‚

å‡ºäºè¿™ä¸ªåŸå› ï¼Œæˆ‘åªç”¨æœ€å°‘çš„è®¾ç½®ç”¨ spacy æ„å»ºäº†ä¸€ä¸ªç®€å•çš„æƒ…ç»ªåˆ†ææ¨¡å‹ï¼Œä»¥ä¾¿å¿«é€Ÿè·å¾—ä¸€ä¸ªæ¨¡å‹æ¥è¿›è¡Œé¢„æµ‹ã€‚

è¿™æ˜¯æ¨¡å‹çš„å®Œæ•´ä»£ç ï¼Œåœ¨ä¸€ä¸ªåä¸º **model.py.** çš„æ¨¡å—ä¸­å®šä¹‰

```
import spacy
from spacytextblob import SpacyTextBlob
from pydantic import BaseModelclass SentimentQueryModel(BaseModel):
    text : strclass SentimentModel:
    def get_sentiment(self, text):
        nlp = spacy.load('en_core_web_sm')
        spacy_text_blob = SpacyTextBlob()
        nlp.add_pipe(spacy_text_blob)doc = nlp(text)polarity = doc._.sentiment.polarity      
        subjectivity = doc._.sentiment.subjectivityreturn polarity, subjectivity
```

æ˜¯çš„ï¼ŒçœŸçš„æ˜¯è¿™ä¸ªã€‚å¦‚æœä½ åƒæˆ‘ä¸€æ ·ä» FastAPI å¼€å§‹ï¼Œæˆ‘å»ºè®®ä½ å…ˆç”¨è¿™ä¸ªç®€å•çš„æ¨¡å‹æ¢ç´¢è¿™ä¸ª API åŠå…¶ç‰¹æ€§ï¼Œç„¶åå†å»å¼€å‘æ›´å¤æ‚ã€æ›´å¤§çš„æ¨¡å‹ã€‚

æˆ‘ç®€å•è§£é‡Šä¸€ä¸‹ä»£ç :

*   æˆ‘ä»¬é¦–å…ˆå¯¼å…¥é¡¹ç›®æ‰€éœ€çš„åº“
*   **SentimentQueryModel** åªæ˜¯ä¸€ä¸ªæ¨¡å‹ï¼ŒåŒ…å«æˆ‘ä»¬å¯¹è¿™ä¸ªæ¨¡å‹çš„å”¯ä¸€æŸ¥è¯¢â€”â€”æˆ‘ä»¬å°†é¢„æµ‹å…¶æƒ…æ„Ÿçš„æ–‡æœ¬ã€‚ [Pydantic](https://pydantic-docs.helpmanual.io) åº“æœ‰åŠ©äºç¡®ä¿æˆ‘ä»¬å¯ä»¥å¿«é€Ÿæ‹¥æœ‰ä¸€ä¸ªåŒ…å«æ¨¡å‹æ‰€éœ€æ•°æ®çš„å­—æ®µï¼Œè¿™å°†æ˜¯ ***æ–‡æœ¬*** å˜é‡ã€‚FastAPI æ–‡æ¡£è¿˜æè¿°äº†è®¸å¤šä½¿ç”¨è¿™ä¸ªåº“å£°æ˜æ•°æ®å­—æ®µçš„æ–¹æ³•ã€‚
*   **sensition model**æ˜¯åŠ è½½ spacy tokeniser å’Œ spacytextblob åº“å¹¶å¯¹æ–‡æœ¬æ‰§è¡Œæƒ…æ„Ÿé¢„æµ‹çš„ç±»

**æƒ…æ„Ÿåˆ†æå¾—åˆ†çš„ä¸¤ä¸ªä¸»è¦ç»„æˆéƒ¨åˆ†æ˜¯:**

**ææ€§** â€”å®ƒæ˜¯ä¸€ä¸ªä½äº[-1ï¼Œ1]èŒƒå›´å†…çš„æµ®ç‚¹æ•°ï¼Œå…¶ä¸­ 1 è¡¨ç¤ºå®Œå…¨è‚¯å®šçš„é™ˆè¿°ï¼Œè€Œ-1 è¡¨ç¤ºå®Œå…¨å¦å®šçš„é™ˆè¿°ã€‚

**ä¸»è§‚æ€§**â€”*ä¸»è§‚*å¥ä¸€èˆ¬æŒ‡ä¸ªäººè§‚ç‚¹ã€æƒ…æ„Ÿæˆ–åˆ¤æ–­ï¼Œè€Œ*å®¢è§‚*åˆ™æŒ‡äº‹å®ä¿¡æ¯ã€‚**ä¸»è§‚æ€§**åˆ†é‡æ˜¯ä¸€ä¸ªä½äº[0ï¼Œ1]èŒƒå›´å†…çš„æµ®ç‚¹æ•°ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»ä»æ¨¡å‹ä¸­è¿”å›äº†ä¸¤ä¸ªåˆ†æ•°ï¼Œè®©æˆ‘ä»¬è½¬åˆ°å®é™…æ„å»º API çš„éƒ¨åˆ†ã€‚

## åˆ¶ä½œ API

é¦–å…ˆï¼Œæˆ‘ä»¬å¯¼å…¥æˆ‘ä»¬çš„åº“å’Œæ¨¡å—:

```
import uvicornfrom fastapi 
import FastAPIfrom model 
import SentimentModel, SentimentQueryModel
```

ç„¶åï¼Œæˆ‘ä»¬å®ä¾‹åŒ– FastAPI å¯¹è±¡å’Œé¢„æµ‹ç±»:

```
app = FastAPI()
model = SentimentModel()
```

æœ€åï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°å‡½æ•°ï¼Œé€šè¿‡ä¸€ä¸ª **POST** è¯·æ±‚æ¥è·å–é¢„æµ‹:

```
@app.post('/predict')
def predict(data: SentimentQueryModel):    
    data = data.dict()    
    polarity, subjectivity = model.get_sentiment(data['text'])
    return { 'polarity': polarity,        
             'subjectivity': subjectivity    
           }
```

ç¡®ä¿æˆ‘ä»¬å¯ä»¥ä» POST å‡½æ•°ä¸­è®¿é—®ä½œä¸º JSON å¯¹è±¡çš„æ–‡æœ¬å­—ç¬¦ä¸²å¯¹è±¡ã€‚

å¾—åˆ°åˆ†æ•°åï¼Œæˆ‘ä»¬ç®€å•åœ°å°†å®ƒä»¬ä½œä¸ºå¦ä¸€ä¸ª dictionary å¯¹è±¡è¿”å›ã€‚

ç°åœ¨æˆ‘ä»¬å®Œæˆäº†ï¼Œæˆ‘ä»¬ç»§ç»­è¿è¡Œåº”ç”¨ç¨‹åºï¼Œä»£ç å¦‚ä¸‹:

```
if __name__ == '__main__':    
    uvicorn.run(app, host='127.0.0.1', port=8000)
```

æˆ‘ä»¬å®Œäº‹äº†ã€‚è¿™æ˜¯å®Œæ•´çš„ä»£ç ï¼Œä½ çš„ API å·²ç»å¯ä»¥æµ‹è¯•äº†ã€‚

## æ€»ç»“â†’æµ‹è¯•æ‚¨çš„ API

è¿™æ˜¯å­¦ä¹ ä½¿ç”¨ FastAPI æœ€ä»¤äººå…´å¥‹çš„éƒ¨åˆ†ä¹‹ä¸€ã€‚æ˜¾ç„¶ï¼Œé€šè¿‡å®ƒä¸ SwaggerUI çš„é›†æˆï¼Œä½ å¯ä»¥ç›´æ¥æµ‹è¯• APIï¼Œè€Œä¸éœ€è¦ä»»ä½•å¤–éƒ¨å·¥å…·ï¼Œå¦‚ **Postman** æˆ–ç»ˆç«¯å‘½ä»¤ **CURL** ã€‚

å¯¼èˆªåˆ°åœ°å€`http://127.0.0.1:8000/docs` ä»¥æŸ¥çœ‹æ‚¨çš„ API çš„è¿è¡Œæƒ…å†µã€‚æŒ‰ä¸‹**è¯•ä¸€è¯•**æŒ‰é’®ã€‚

å®ƒåº”è¯¥æ˜¯è¿™æ ·çš„:

![](img/7ca5c0754d8cb54a0400cf08b0f0603c.png)

ç»§ç»­åœ¨å­—æ®µä¸­è¾“å…¥æ‚¨çš„æ–‡æœ¬ã€‚

æœ€åï¼ŒæŒ‰ä¸‹**æ‰§è¡Œ**ã€‚

![](img/26933e590fc88610b4eb388b94907dea.png)

ç°åœ¨ä½ çŸ¥é“äº†ï¼è¿™äº›é¢„æµ‹ï¼Œä»¥åŠæµè§ˆå™¨æœ¬èº«è¿”å›çš„å“åº”ä»£ç ã€‚æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ï¼Ÿ

è¯·æ”¾å¿ƒï¼Œæˆ‘å°†æ¥ä¹Ÿä¼šå¹¿æ³›åœ°æ¢ç´¢è¿™ä¸ªåº“ï¼

æ•´ä¸ªä»£ç ä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªè¦ç‚¹[è·å¾—ã€‚](https://gist.github.com/yashprakash13/998e7322769ce3257b9f8dae786c0e36)

ç„¶è€Œï¼Œå¦‚æœæ‚¨å·²ç»éµå¾ªäº†è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆæ‚¨åº”è¯¥å·²ç»æœ‰äº†å¯ä»¥å¼€å§‹æ„å»ºè‡ªå·±çš„ API çš„ä»£ç ï¼

æ„Ÿè°¢é˜…è¯»ï¼:)

> å•ç‹¬å­¦ä¹ æ•°æ®ç§‘å­¦å¯èƒ½ä¼šå¾ˆéš¾ã€‚è·Ÿæˆ‘æ¥ï¼Œè®©æˆ‘ä»¬ä¸€èµ·å˜å¾—æœ‰è¶£ã€‚ğŸ˜
> 
> åœ¨ [Twitter](https://twitter.com/csandyash) ä¸Šä¸æˆ‘è”ç³»ã€‚

è¿™é‡Œæ˜¯æˆ‘æ‰€æœ‰æ•°æ®ç§‘å­¦æ•…äº‹çš„ä»£ç åº“ã€‚å¿«ä¹å­¦ä¹ ï¼â­ï¸

å¦å¤–ï¼Œçœ‹çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼Œä½ å¯èƒ½ä¼šæ„Ÿå…´è¶£:

[](/making-your-first-kaggle-submission-36fa07739272) [## é¦–æ¬¡æäº¤ Kaggle

### ä¸€ä¸ªæ˜“äºç†è§£çš„æŒ‡å—ï¼Œå¼€å§‹ä¸ç«äº‰ï¼Œå¹¶æˆåŠŸå»ºæ¨¡ï¼Œä½¿ä½ çš„ç¬¬ä¸€â€¦

towardsdatascience.com](/making-your-first-kaggle-submission-36fa07739272)