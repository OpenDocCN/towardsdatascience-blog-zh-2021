# dbt å®è·µæ•™ç¨‹

> åŸæ–‡ï¼š<https://towardsdatascience.com/a-hands-on-tutorial-for-dbt-f749f7749c8d?source=collection_archive---------21----------------------->

## å…¥é—¨æŒ‡å—

## é€šè¿‡åªç¼–å†™ SQL SELECT è¯­å¥ï¼Œå°† dbt ç”¨äºå¤æ‚æ•°æ®**è½¬æ¢ã€‚è¿è¡Œæµ‹è¯•ï¼Œç”Ÿæˆæ–‡æ¡£ï¼Œä½¿ç”¨å®ï¼Œä»¥åŠæ›´å¤šçš„åŠŸèƒ½ã€‚**

![](img/faf35bf5c73fd38d5b777f6de0ef9307.png)

*æœ¬å¸–ä¸­ä½¿ç”¨çš„æ‰€æœ‰å›¾ç‰‡/è§†é¢‘å‡ç”±ä½œè€…åˆ›ä½œï¼Œé™¤éå¦æœ‰è¯´æ˜ã€‚(å›¾æ ‡æ¥è‡ª*[](https://flaticon.com)**)**

*dbt(æ•°æ®æ„å»ºå·¥å…·)æ˜¯ä¸€ä¸ªä½¿ç”¨ select SQL è¯­å¥çš„æ•°æ®è½¬æ¢å·¥å…·ã€‚å®ƒå…è®¸æ‚¨åˆ›å»ºå¤æ‚çš„æ¨¡å‹ï¼Œä½¿ç”¨å˜é‡å’Œå®(ä¹Ÿç§°ä¸ºå‡½æ•°)ï¼Œè¿è¡Œæµ‹è¯•ï¼Œç”Ÿæˆæ–‡æ¡£ï¼Œä»¥åŠæ›´å¤šçš„ç‰¹æ€§ã€‚*

*dbt ä¸æå–æˆ–åŠ è½½æ•°æ®ï¼Œä½†æ˜¯å®ƒåœ¨è½¬æ¢æ•°æ®åº“ä¸­å·²ç»å¯ç”¨çš„æ•°æ®æ–¹é¢å¾ˆå¼ºå¤§â€”â€”dbt åœ¨ ELT(æå–ã€åŠ è½½ã€è½¬æ¢)è¿‡ç¨‹ä¸­æ‰§è¡Œ Tã€‚*

*åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œä½ å°†å­¦ä¼šå¦‚ä½•â€¦*

*   *é…ç½® dbt é¡¹ç›®*
*   *åˆ›å»º dbt æ¨¡å‹(SELECT è¯­å¥)*
*   *ä½¿ç”¨å…¨å±€å˜é‡å’Œå®æ„å»ºå¤æ‚çš„ dbt æ¨¡å‹*
*   *å‚è€ƒå…¶ä»– dbt æ¨¡å‹æ„å»ºå¤æ‚æ¨¡å‹*
*   *è¿è¡Œæµ‹è¯•*
*   *ç”Ÿæˆæ–‡æ¡£*

# *å…ˆå†³æ¡ä»¶*

## *æ³¨å†Œ*

*ä½ å¯ä»¥åœ¨ getdbt.com æŠ¥åã€‚å…è´¹è®¡åˆ’å¯¹äºå°å‹é¡¹ç›®å’Œæµ‹è¯•æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è®¡åˆ’ã€‚*

## *å…·æœ‰å¡«å……æ•°æ®çš„æ•°æ®åº“*

*ä½ å¯ä»¥æŸ¥çœ‹æˆ‘å…³äºå¦‚ä½•åœ¨ Heroku ä¸Šéƒ¨ç½²ä¸€ä¸ª*å…è´¹* PostgreSQL æ•°æ®åº“çš„å¸–å­ã€‚è¿™ç¯‡æ–‡ç« æä¾›äº†å¦‚ä½•åšçš„ä¸€æ­¥ä¸€æ­¥çš„æŒ‡å¯¼ã€‚*

*æ‚¨è¿˜å¯ä»¥æŸ¥çœ‹æœ¬æ–‡é™„å¸¦çš„ GitHub repo ä¸­çš„[æ•°æ®æ‘„å–è„šæœ¬](https://github.com/e-alizadeh/sample_dbt_project/blob/master/data/data_ingestion.py)ã€‚*

*[](https://github.com/e-alizadeh/sample_dbt_project) [## e-alizadeh/sample_dbt_project

### æ­¤æ—¶æ‚¨ä¸èƒ½æ‰§è¡Œè¯¥æ“ä½œã€‚æ‚¨å·²ä½¿ç”¨å¦ä¸€ä¸ªæ ‡ç­¾é¡µæˆ–çª—å£ç™»å½•ã€‚æ‚¨å·²åœ¨å¦ä¸€ä¸ªé€‰é¡¹å¡ä¸­æ³¨é”€ï¼Œæˆ–è€…â€¦

github.com](https://github.com/e-alizadeh/sample_dbt_project) 

æŒ‰ç…§ä¸Šé¢æ‰€è¿°ï¼Œæˆ‘ä»¬å·²ç»åœ¨ PostgreSQL æ•°æ®åº“ä¸­ç”Ÿæˆäº†ä¸¤ä¸ªè¡¨ï¼Œæˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­ä½¿ç”¨å®ƒä»¬ã€‚æ•°æ®åº“ä¸­æœ‰ä¸¤ä¸ªè¡¨ï¼Œåˆ†åˆ«æ˜¯`covid_latest`å’Œ`population_prosperity`ã€‚æ‚¨å¯ä»¥åœ¨ GitHub repo ä¸Šæ‰¾åˆ°è¿™ç¯‡æ–‡ç« çš„æ‘„å–è„šæœ¬ã€‚

## dbt CLI å®‰è£…

æ‚¨å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„ [dbt æ–‡æ¡£é¡µé¢](https://docs.getdbt.com/dbt-cli/installation/)ä¸Šçš„è¯´æ˜æ¥å®‰è£… dbt å‘½ä»¤è¡Œç•Œé¢(CLI)ã€‚

[](https://docs.getdbt.com/dbt-cli/installation) [## å®‰è£…| dbt æ–‡æ¡£

### æˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨ä»¥ä¸‹ä¸‰ç§å±¡è¯•ä¸çˆ½çš„æ–¹æ³•ä¹‹ä¸€æ¥å®‰è£… dbt:å®‰è£…è‡ªåˆ¶è½¯ä»¶ã€‚ç„¶åï¼Œè¿è¡Œ:æµ‹è¯•æ‚¨çš„â€¦

docs.getdbt.com](https://docs.getdbt.com/dbt-cli/installation) 

# dbt é¡¹ç›®çš„åŸºç¡€

ä¸ºäº†ä½¿ç”¨ dbt å·¥å…·ï¼Œæœ‰ä¸‰ä»¶ä¸»è¦çš„äº‹æƒ…éœ€è¦äº†è§£ã€‚

*   dbt é¡¹ç›®
*   æ•°æ®åº“è¿æ¥
*   dbt å‘½ä»¤

## dbt æ€ä¹ˆç”¨ï¼Ÿ

dbt é¡¹ç›®æ˜¯åŒ…å«`.sql`å’Œ`.yml`æ–‡ä»¶çš„ç›®å½•ã€‚æœ€å°‘éœ€è¦çš„æ–‡ä»¶æ˜¯:

*   åä¸º`dbt_project.yml`çš„é¡¹ç›®æ–‡ä»¶:è¯¥æ–‡ä»¶åŒ…å« dbt é¡¹ç›®çš„é…ç½®ã€‚
*   æ¨¡å‹(`.sql`æ–‡ä»¶):dbt ä¸­çš„æ¨¡å‹ä»…ä»…æ˜¯ä¸€ä¸ª`.sql`æ–‡ä»¶ï¼ŒåŒ…å«ä¸€ä¸ª**å•ä¸ª** `**select**` **è¯­å¥**ã€‚

> æ¯ä¸ª dbt é¡¹ç›®éƒ½éœ€è¦ä¸€ä¸ª dbt_project.yml æ–‡ä»¶â€”â€”è¿™æ˜¯ dbt çŸ¥é“ä¸€ä¸ªç›®å½•æ˜¯ dbt é¡¹ç›®çš„æ–¹å¼ã€‚å®ƒè¿˜åŒ…å«å‘Šè¯‰ dbt å¦‚ä½•æ“ä½œæ‚¨çš„é¡¹ç›®çš„é‡è¦ä¿¡æ¯ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æ›´å¤šå…³äº dbt é¡¹ç›®[çš„ä¿¡æ¯ã€‚](https://docs.getdbt.com/docs/introduction#dbt-projects)

> ğŸ’¡dbt æ¨¡å‹åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªå¸¦æœ‰ SELECT è¯­å¥çš„`.sql`æ–‡ä»¶ã€‚

## dbt å‘½ä»¤

dbt å‘½ä»¤ä»¥`dbt`å¼€å§‹ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€æ‰§è¡Œ:

*   dbt Cloud(dbt Cloud ä»ªè¡¨æ¿åº•éƒ¨çš„å‘½ä»¤éƒ¨åˆ†)ï¼Œ
*   dbt CLI

æœ‰äº›å‘½ä»¤åªèƒ½åœ¨ dbt CLI ä¸­ä½¿ç”¨ï¼Œå¦‚`dbt init`ã€‚æˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­ä½¿ç”¨çš„ä¸€äº› dbt å‘½ä»¤æ˜¯

*   `dbt init`(ä»…åœ¨ dbt CLI ä¸­)
*   `dbt run`
*   `dbt test`
*   `dbt docs generate`

# dbt é¡¹ç›®è®¾ç½®

## æ­¥éª¤ 1:ä½¿ç”¨ dbt CLI åˆå§‹åŒ– dbt é¡¹ç›®(ç¤ºä¾‹æ–‡ä»¶)

æ‚¨å¯ä»¥ä½¿ç”¨`[dbt init](https://docs.getdbt.com/reference/commands/init)`ç”Ÿæˆæ ·æœ¬æ–‡ä»¶/æ–‡ä»¶å¤¹ã€‚ç‰¹åˆ«æ˜¯ï¼Œ`dbt init project_name`å°†åˆ›å»ºä»¥ä¸‹å†…å®¹:

*   ä¸€ä¸ª`~/.dbt/profiles.yml`æ–‡ä»¶(å¦‚æœä¸å­˜åœ¨)
*   åä¸º`[project_name]`çš„æ–°æ–‡ä»¶å¤¹
*   dbt å…¥é—¨æ‰€éœ€çš„ç›®å½•å’Œç¤ºä¾‹æ–‡ä»¶

> **æ³¨æ„**:ç”±äº`dbt init`ä¼šç”Ÿæˆä¸€ä¸ªåä¸º`project_name`çš„ç›®å½•ï¼Œä¸ºäº†é¿å…ä»»ä½•å†²çªï¼Œæ‚¨åº”è¯¥*æ²¡æœ‰ä»»ä½•åŒåçš„æ–‡ä»¶å¤¹ã€‚*

![](img/8ed5199937576ff7ca1caf6577515f6f.png)

dbt åˆå§‹åŒ–<project_name></project_name>

ç»“æœæ˜¯ä¸€ä¸ªåŒ…å«ä»¥ä¸‹ç¤ºä¾‹æ–‡ä»¶çš„ç›®å½•ã€‚

```
sample_dbt_project
â”œâ”€â”€ README.md
â”œâ”€â”€ analysis
â”œâ”€â”€ data
â”œâ”€â”€ dbt_project.yml
â”œâ”€â”€ macros
â”œâ”€â”€ models
â”‚   â””â”€â”€ example
â”‚       â”œâ”€â”€ my_first_dbt_model.sql
â”‚       â”œâ”€â”€ my_second_dbt_model.sql
â”‚       â””â”€â”€ schema.yml
â”œâ”€â”€ snapshots
â””â”€â”€ tests
```

å¯¹äºè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†åªè€ƒè™‘æœ€å°‘çš„æ–‡ä»¶ï¼Œå¹¶åˆ é™¤å¤šä½™çš„ä¸œè¥¿ã€‚

```
sample_dbt_project
â”œâ”€â”€ README.md
â”œâ”€â”€ dbt_project.yml
â””â”€â”€ models
    â”œâ”€â”€ my_first_dbt_model.sql
    â”œâ”€â”€ my_second_dbt_model.sql
    â””â”€â”€ schema.yml
```

## æ­¥éª¤ 2:å»ºç«‹ä¸€ä¸ª Git å­˜å‚¨åº“

æ‚¨å¯ä»¥ä½¿ç”¨è®¾ç½®æœŸé—´æŒ‡å®šçš„ç°æœ‰å›è´­åè®®ã€‚æ‚¨å¯ä»¥æŒ‰ç…§è¿™é‡Œçš„ dbt æ–‡æ¡£[æ¥é…ç½®å­˜å‚¨åº“ã€‚](https://docs.getdbt.com/docs/dbt-cloud/cloud-configuring-dbt-cloud/cloud-configuring-repositories)

**æˆ–è€…ï¼Œå¦‚æœä½ æƒ³åˆ›å»ºä¸€ä¸ªæ–°çš„å›è´­â€¦**

æ‚¨å¯ä»¥ä»åˆ›å»ºçš„ç›®å½•ä¸­åˆ›å»ºæ–°çš„å­˜å‚¨åº“ã€‚ä½ å¯ä»¥åƒä¸‹é¢è¿™æ ·åš

```
git init
git add .
git commit -m "first commit"
git remote add origing <repo_url>
git push -u origin master
```

## æ­¥éª¤ 3:åœ¨ dbt Cloud Dashboard ä¸Šå»ºç«‹ä¸€ä¸ªæ–°é¡¹ç›®

åœ¨ä¸Šä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«ç¤ºä¾‹æ¨¡å‹å’Œé…ç½®çš„ç¤ºä¾‹ dbt é¡¹ç›®ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼Œå¹¶åœ¨ dbt Cloud ä»ªè¡¨æ¿ä¸Šè¿æ¥æˆ‘ä»¬çš„æ•°æ®åº“å’Œå­˜å‚¨åº“ã€‚

åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œæ‚¨åº”è¯¥å·²ç»

*   ä¸€äº›æ•°æ®å·²ç»å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œ
*   åŒ…å«ä¸Šä¸€æ­¥ç”Ÿæˆçš„æ–‡ä»¶çš„å­˜å‚¨åº“

æ‚¨å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤åœ¨ dbt Cloud ä¸­è®¾ç½®ä¸€ä¸ªæ–°é¡¹ç›®(è¯·è®°ä½ï¼Œè¿™ä¸€æ­¥ä¸ä¸Šä¸€æ­¥ä¸åŒï¼Œå› ä¸ºæˆ‘ä»¬åªç”Ÿæˆäº†ä¸€äº›ç¤ºä¾‹æ–‡ä»¶)ã€‚

åœ¨ dbt Cloud ä¸Šå»ºç«‹ä¸€ä¸ªæ–°çš„ dbt é¡¹ç›®

æˆ‘ä»¬é¡¹ç›®çš„`dbt_project.yml`æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤º(ä½ å¯ä»¥åœ¨è¿™ç¯‡æ–‡ç« é™„å¸¦çš„ [GitHub repo](https://github.com/e-alizadeh/sample_dbt_project.git) ä¸­æ‰¾åˆ°å®Œæ•´ç‰ˆæœ¬)ã€‚

dbt_project.yml

# dbt å‹å·å’ŒåŠŸèƒ½

## dbt æ¨¡å‹

è®©æˆ‘ä»¬åˆ›å»ºç®€å•çš„ dbt æ¨¡å‹æ¥æ£€ç´¢è¡¨ä¸­çš„å‡ åˆ—ã€‚

**covid 19 _ latest _ stats**dbt æ¨¡å‹(models/covid 19 _ latest _ stats . SQL)

**äººå£** dbt æ¨¡å‹(models/population.sql)

> âš ï¸ **æ³¨æ„**:dbt æ¨¡å‹åæ˜¯`models`ç›®å½•ä¸­ sql æ–‡ä»¶çš„æ–‡ä»¶åã€‚æ¨¡å‹åç§°å¯èƒ½ä¸åŒäºæ•°æ®åº“ä¸­çš„è¡¨åç§°ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œdbt æ¨¡å‹`population`æ˜¯æ•°æ®åº“ä¸­`population_prosperity`è¡¨ä¸Šçš„`SELECT`è¯­å¥çš„ç»“æœã€‚

## è¿è¡Œæ¨¡å‹

æ‚¨å¯ä»¥é€šè¿‡æ‰§è¡Œ`dbt run`æ¥è¿è¡Œæ‚¨çš„ dbt é¡¹ç›®ä¸­çš„æ‰€æœ‰æ¨¡å‹ã€‚ä¸‹é¢æ˜¾ç¤ºäº†ä¸€ä¸ªç¤ºä¾‹ dbt è¿è¡Œè¾“å‡ºã€‚æ‚¨å¯ä»¥çœ‹åˆ°è¿è¡Œæ‰€æœ‰ dbt æ¨¡å‹çš„æ‘˜è¦æˆ–è¯¦ç»†æ—¥å¿—ã€‚è¿™å¯¹äºè°ƒè¯•æ‚¨åœ¨æŸ¥è¯¢ä¸­å¯èƒ½é‡åˆ°çš„ä»»ä½•é—®é¢˜éå¸¸æœ‰å¸®åŠ©ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¤±è´¥çš„æ¨¡å‹æŠ›å‡ºäº†ä¸€ä¸ª Postgres é”™è¯¯ã€‚

![](img/7760f0e1fe04b3fb7c4007f5cbeb9c7f.png)

å¤±è´¥**çš„è¯¦ç»†æ—¥å¿— jinja _ and _ variable _ usage**dbt æ¨¡å‹

## é‡‘ä½³å’Œå®

dbt ä½¿ç”¨ [Jinja](https://jinja.palletsprojects.com/) æ¨¡æ¿è¯­è¨€ï¼Œä½¿å¾— dbt é¡¹ç›®æˆä¸º SQL çš„ç†æƒ³ç¼–ç¨‹ç¯å¢ƒã€‚ä½¿ç”¨ Jinjaï¼Œæ‚¨å¯ä»¥è¿›è¡Œ SQL ä¸­é€šå¸¸ä¸å¯èƒ½çš„è½¬æ¢ï¼Œæ¯”å¦‚ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å®â€”â€”SQL çš„æŠ½è±¡ç‰‡æ®µï¼Œç±»ä¼¼äºå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸­çš„å‡½æ•°ã€‚æ¯å½“ä½ çœ‹åˆ°ä¸€ä¸ª`{{ ... }}`ï¼Œä½ å·²ç»åœ¨ç”¨ Jinja äº†ã€‚å…³äº Jinja å’Œå®šä¹‰çš„é™„åŠ  Jinja é£æ ¼å‡½æ•°çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹ [dbt æ–‡æ¡£](https://docs.getdbt.com/docs/building-a-dbt-project/jinja-macros/)ã€‚

åœ¨è¿™ç¯‡æ–‡ç« çš„åé¢ï¼Œæˆ‘ä»¬å°†è®¨è®ºç”± dbt å®šä¹‰çš„è‡ªå®šä¹‰å®ã€‚

## ä½¿ç”¨å˜é‡

**å®šä¹‰ä¸€ä¸ªå˜é‡**

æ‚¨å¯ä»¥åœ¨æ‚¨çš„`dbt_project.yml`ä¸­çš„`vars`éƒ¨åˆ†ä¸‹å®šä¹‰æ‚¨çš„å˜é‡ã€‚ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåä¸º`selected_country`çš„å˜é‡ï¼Œå…¶é»˜è®¤å€¼ä¸º`USA`ï¼Œå¦ä¸€ä¸ªåä¸º`selected_year`çš„å˜é‡ï¼Œå…¶é»˜è®¤å€¼ä¸º`2019`ã€‚

å¸¦æœ‰å·²å®šä¹‰å˜é‡çš„ dbt_project.yml æ–‡ä»¶

**ä½¿ç”¨å˜é‡**

æ‚¨å¯ä»¥é€šè¿‡`[var()](https://docs.getdbt.com/reference/dbt-jinja-functions/var)` Jinja å‡½æ•°(`{{ var("var_key_name") }}`)åœ¨æ‚¨çš„ dbt æ¨¡å‹ä¸­ä½¿ç”¨å˜é‡ã€‚

## å®æŒ‡ä»¤

åœ¨`dbt_utils`ä¸­æœ‰è®¸å¤šæœ‰ç”¨çš„è½¬æ¢å’Œå®å¯ä»¥ç”¨åœ¨ä½ çš„é¡¹ç›®ä¸­ã€‚å…³äºæ‰€æœ‰å¯ç”¨å®çš„åˆ—è¡¨ï¼Œä½ å¯ä»¥æŸ¥çœ‹ä»–ä»¬çš„ GitHub repo ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°† dbt_utils æ·»åŠ åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œå¹¶æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œå®‰è£…:

1.  å°† dbt_utils å®æ·»åŠ åˆ°æ‚¨çš„`packages.yml`æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤º:

å°† **dbt_utils** åŒ…æ·»åŠ åˆ° packages.yml

2.è¿è¡Œ`dbt deps`å®‰è£…è½¯ä»¶åŒ…ã€‚

![](img/53caa794f6ebaff21c2696a4d4b8fed4.png)

ä½¿ç”¨ **dbt deps** å®‰è£…è½¯ä»¶åŒ…

## å¤æ‚ dbt æ¨¡å‹

æ¨¡å‹(é€‰æ‹©)é€šå¸¸å †å åœ¨å¦ä¸€ä¸ªä¹‹ä¸Šã€‚ä¸ºäº†æ„å»ºæ›´å¤æ‚çš„æ¨¡å‹ï¼Œä½ å¿…é¡»ä½¿ç”¨`[ref()](https://docs.getdbt.com/reference/dbt-jinja-functions/ref)`å®ã€‚`ref()`æ˜¯ dbt ä¸­æœ€é‡è¦çš„åŠŸèƒ½ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨å¼•ç”¨å…¶ä»–æ¨¡å‹ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½æœ‰ä¸€ä¸ªåšå¤šç§äº‹æƒ…çš„æ¨¡å‹(åˆå SELECT query ),è€Œæ‚¨ä¸æƒ³åœ¨å…¶ä»–æ¨¡å‹ä¸­ä½¿ç”¨å®ƒã€‚å¦‚æœä¸ä½¿ç”¨å‰é¢ä»‹ç»çš„å®ï¼Œå°†å¾ˆéš¾æ„å»ºä¸€ä¸ªå¤æ‚çš„æ¨¡å‹ã€‚

## ä½¿ç”¨`ref()`å’Œå…¨å±€å˜é‡çš„ dbt æ¨¡å‹

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœ¬æ–‡å‰é¢å®šä¹‰çš„ä¸¤ä¸ª dbt æ¨¡å‹æ„å»ºæ›´å¤æ‚çš„æ¨¡å‹ã€‚ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ dbt æ¨¡å‹ï¼Œå®ƒæ ¹æ®å›½å®¶ä»£ç è¿æ¥ä¸Šè¿°ä¸¤ä¸ªè¡¨ï¼Œç„¶åæ ¹æ®é€‰å®šçš„å›½å®¶å’Œå¹´ä»½è¿›è¡Œè¿‡æ»¤ã€‚

**jinja _ and _ variable _ usage**dbt æ¨¡å‹(models/jinja _ and _ variable _ usage . SQL)

å…³äºä¸Šè¿°æŸ¥è¯¢çš„å‡ ç‚¹:

*   `{{ref('dbt_model_name')}}`ç”¨äºæŒ‡é¡¹ç›®ä¸­å¯ç”¨çš„ dbt å‹å·ã€‚
*   ä½ å¯ä»¥ä»åƒ`{{ref('dbt_model_name')}}.column_name`è¿™æ ·çš„æ¨¡å‹ä¸­å¾—åˆ°ä¸€ä¸ªä¸“æ ã€‚
*   æ‚¨å¯ä»¥é€šè¿‡`{{var("variable_name)}}`ä½¿ç”¨`dbt_project.yml`æ–‡ä»¶ä¸­å®šä¹‰çš„å˜é‡ã€‚

ä¸Šé¢çš„ä»£ç ç‰‡æ®µå°†æ¥è‡ª`population`å’Œ`covid19_latest_stats`å‹å·çš„æ•°æ®è¿æ¥åˆ°å›½å®¶ä»£ç ä¸Šï¼Œå¹¶æ ¹æ® selected_country=USA å’Œ selected_year=2019 è¿›è¡Œç­›é€‰ã€‚æ¨¡å‹çš„è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºã€‚

![](img/2a734b1f34f73ae4fb6c7f13b0b864fc.png)

**jinja _ and _ variable _ usage**dbt æ¨¡å‹çš„è¾“å‡º

æ‚¨ä¹Ÿå¯ä»¥ç‚¹å‡»**ç¼–è¯‘ sql** æŒ‰é’®æŸ¥çœ‹ç¼–è¯‘åçš„ SQL ä»£ç ç‰‡æ®µã€‚è¿™éå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯å¦‚æœæ‚¨æƒ³åœ¨ dbt å·¥å…·ä¹‹å¤–è¿è¡ŒæŸ¥è¯¢çš„è¯ã€‚

![](img/362da5d35dbca43e4b54fda56d64058a.png)

ä¸º**jinja _ and _ variable _ usage**dbt æ¨¡å‹ç¼–è¯‘çš„ SQL ä»£ç 

## ä½¿ç”¨ dbt_utils åŒ…å’Œå®çš„ dbt æ¨¡å‹

`dbt_utils`åŒ…ä¸­åŒ…å«å¯ä»¥åœ¨ dbt é¡¹ç›®ä¸­ä½¿ç”¨çš„å®(åˆåå‡½æ•°)ã€‚æ‰€æœ‰å®çš„åˆ—è¡¨å¯ä»¥åœ¨ [dbt_utils çš„ GitHub é¡µé¢](https://github.com/dbt-labs/dbt-utils/)ä¸Šæ‰¾åˆ°ã€‚

è®©æˆ‘ä»¬åœ¨ dbt æ¨¡å‹ä¸­ä½¿ç”¨ dbt_utils `[pivot()](https://github.com/dbt-labs/dbt-utils/#pivot-source)`å’Œ`[get_column_values()](https://github.com/dbt-labs/dbt-utils/#get_column_values-source)`å®ï¼Œå¦‚ä¸‹æ‰€ç¤º:

**ä½¿ç”¨ _dbt_utils_macros** dbt æ¨¡å‹(models/using _ dbt _ utils _ macros . SQL)

ä¸Šé¢çš„ dbt æ¨¡å‹å°†åœ¨ dbt ä¸­ç¼–è¯‘æˆä¸‹é¢çš„ SQL æŸ¥è¯¢ã€‚

ä½¿ç”¨ _dbt_utils_macros ä»**ç¼–è¯‘ SQL æŸ¥è¯¢** dbt æ¨¡å‹

# åœ¨ dbt ä¸­è¿è¡Œæµ‹è¯•

ä½¿ç”¨ dbt çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯èƒ½å¤Ÿæµ‹è¯•æ•°æ®ã€‚å¼€ç®±å³ç”¨ï¼Œdbt æœ‰ä»¥ä¸‹é€šç”¨æµ‹è¯•:`unique`ã€`not_null`ã€`accepted_values`å’Œ`relationships`ã€‚å¯¹æ¨¡å‹è¿›è¡Œè¿™äº›æµ‹è¯•çš„ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤º:

schema.yml (dbt æµ‹è¯•)

ä½ å¯ä»¥é€šè¿‡`dbt test`è¿è¡Œæµ‹è¯•ã€‚æ‚¨å¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°è¾“å‡º

![](img/d2381f0cc56c2e9f79a26390d43c4b83.png)

åœ¨ dbt äº‘ä»ªè¡¨æ¿ä¸Šè¿è¡Œ dbt æµ‹è¯•çš„ç»“æœ

å…³äº dbt æµ‹è¯•çš„æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥è®¿é—® [dbt æ–‡æ¡£](https://docs.getdbt.com/docs/building-a-dbt-project/tests)ã€‚

# åœ¨ dbt ä¸­ç”Ÿæˆæ–‡æ¡£

æ‚¨å¯ä»¥é€šè¿‡ç®€å•åœ°åœ¨å‘½ä»¤éƒ¨åˆ†è¿è¡Œ`dbt docs generate`æ¥ä¸ºæ‚¨çš„ dbt é¡¹ç›®ç”Ÿæˆæ–‡æ¡£ï¼Œå¦‚ä¸‹æ‰€ç¤º:

![](img/5f7a4dc716547a1cd75c87942cf95f2e.png)

ä¸º dbt é¡¹ç›®ç”Ÿæˆæ–‡æ¡£

æ‚¨å¯ä»¥é€šè¿‡å•å‡»æŸ¥çœ‹æ–‡æ¡£æ¥æµè§ˆç”Ÿæˆçš„æ–‡æ¡£ã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°ç”Ÿæˆçš„æ–‡æ¡£çš„æ¦‚è¿°ã€‚

å‘½ä»¤**ç”Ÿæˆçš„æ–‡æ¡£ dbt docs ç”Ÿæˆ**ã€‚

é™¤äº†`dbt docs generate`ä¹‹å¤–ï¼Œdbt docs è¿˜å¯ä»¥ä¸º web æœåŠ¡å™¨æä¾›ç”Ÿæˆçš„æ–‡æ¡£ã€‚ä¸ºæ­¤ï¼Œæ‚¨åªéœ€è¿è¡Œ`dbt docs serve`ã€‚æ›´å¤šå…³äºä¸ºä½ çš„ dbt é¡¹ç›®ç”Ÿæˆæ–‡æ¡£çš„ä¿¡æ¯å¯ä»¥åœ¨[è¿™é‡Œ](https://docs.getdbt.com/docs/building-a-dbt-project/documentation)æ‰¾åˆ°ã€‚

# å…¶ä»–åŠŸèƒ½

## ä½¿ç”¨é’©å­å’Œæ“ä½œçš„æ•°æ®åº“ç®¡ç†

æœ‰äº›æ•°æ®åº“ç®¡ç†ä»»åŠ¡éœ€è¦è¿è¡Œé¢å¤–çš„ SQL æŸ¥è¯¢ï¼Œä¾‹å¦‚:

*   åˆ›å»ºç”¨æˆ·å®šä¹‰çš„å‡½æ•°
*   æˆäºˆå¯¹è¡¨çš„ç‰¹æƒ
*   è¿˜æœ‰æ›´å¤š

dbt æœ‰ä¸¤ä¸ªæ¥å£(é’©å­å’Œæ“ä½œ)æ¥æ‰§è¡Œè¿™äº›ä»»åŠ¡ï¼Œé‡è¦çš„æ˜¯å¯¹å®ƒä»¬è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹é’©å­å’Œæ“ä½œã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ [dbt æ–‡æ¡£](https://docs.getdbt.com/docs/building-a-dbt-project/hooks-operations)ã€‚

## é’©ä½

é’©å­åªæ˜¯åœ¨ä¸åŒæ—¶é—´æ‰§è¡Œçš„ SQL ç‰‡æ®µã€‚é’©å­åœ¨`dbt_project.yml`æ–‡ä»¶ä¸­å®šä¹‰ã€‚ä¸åŒçš„æŒ‚é’©æœ‰:

*   `pre-hook`:æ¨¡å‹å»ºç«‹å‰æ‰§è¡Œ
*   `post-hook`:æ¨¡å‹å»ºç«‹åæ‰§è¡Œ
*   `on-run-start`:åœ¨`dbt run`å¼€å§‹æ—¶æ‰§è¡Œ
*   `on-run-end`:åœ¨`dbt run`ç»“æŸæ—¶æ‰§è¡Œ

## æ“ä½œ

æ“ä½œæ˜¯åœ¨ä¸è¿è¡Œæ¨¡å‹çš„æƒ…å†µä¸‹è°ƒç”¨å®çš„ä¸€ç§ä¾¿æ·æ–¹å¼ã€‚ä½¿ç”¨`[dbt run-operation](https://docs.getdbt.com/reference/commands/run-operation)`å‘½ä»¤è§¦å‘æ“ä½œã€‚

æ³¨æ„ï¼Œä¸é’©å­ä¸åŒï¼Œæ‚¨éœ€è¦åœ¨ä¸€ä¸ª [dbt æ“ä½œ](https://docs.getdbt.com/docs/building-a-dbt-project/hooks-operations#operations)ä¸­æ˜¾å¼æ‰§è¡Œ SQLã€‚

# ç»“è®º

dbt æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å·¥å…·ï¼Œç»å¯¹å€¼å¾—ä¸€è¯•ï¼Œå› ä¸ºå®ƒå¯ä»¥ç®€åŒ–æ‚¨çš„æ•°æ® ELT(æˆ– ETL)ç®¡é“ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•è®¾ç½®å’Œä½¿ç”¨ dbt è¿›è¡Œæ•°æ®è½¬æ¢ã€‚æˆ‘å‘æ‚¨ä»‹ç»äº†è¯¥å·¥å…·çš„ä¸åŒç‰¹æ€§ã€‚ç‰¹åˆ«æ˜¯ï¼Œæˆ‘æä¾›äº†ä¸€ä¸ªåˆ†æ­¥æŒ‡å—

*   é…ç½® dbt é¡¹ç›®
*   åˆ›å»º dbt æ¨¡å‹(SELECT è¯­å¥)
*   ä½¿ç”¨å…¨å±€å˜é‡å’Œå®æ„å»ºå¤æ‚çš„ dbt æ¨¡å‹
*   å‚è€ƒå…¶ä»– dbt æ¨¡å‹æ„å»ºå¤æ‚æ¨¡å‹
*   è¿è¡Œæµ‹è¯•
*   ç”Ÿæˆæ–‡æ¡£

æ‚¨å¯ä»¥åœ¨ä¸‹é¢æ‰¾åˆ°åŒ…å«æ‰€æœ‰è„šæœ¬(åŒ…æ‹¬æ•°æ®æ‘„å–è„šæœ¬)çš„ GitHub repoã€‚

[](https://github.com/e-alizadeh/sample_dbt_project) [## e-alizadeh/sample_dbt_project

### æ­¤æ—¶æ‚¨ä¸èƒ½æ‰§è¡Œè¯¥æ“ä½œã€‚æ‚¨å·²ä½¿ç”¨å¦ä¸€ä¸ªæ ‡ç­¾é¡µæˆ–çª—å£ç™»å½•ã€‚æ‚¨å·²åœ¨å¦ä¸€ä¸ªé€‰é¡¹å¡ä¸­æ³¨é”€ï¼Œæˆ–è€…â€¦

github.com](https://github.com/e-alizadeh/sample_dbt_project) 

æ„Ÿè°¢é˜…è¯»ğŸ™

> [*åŠ å…¥æˆ‘çš„é‚®ä»¶åˆ—è¡¨æ¥æ”¶ç±»ä¼¼çš„å¸–å­*](https://www.ealizadeh.com/subscribe/) *ã€‚ä¹Ÿå¯ä»¥å…³æ³¨æˆ‘ä¸Š* [*ä¸­*](https://medium.com/@ealizadeh)*[*LinkedIn*](https://www.linkedin.com/in/alizadehesmaeil/)*ï¼Œ*[Twitter](https://twitter.com/intent/follow?screen_name=es_alizadeh&tw_p=followbutton)*ã€‚**

# *æœ‰ç”¨çš„é“¾æ¥*

*[](/deploy-free-postgresql-database-in-heroku-and-ingest-data-8002c574a57d) [## å…è´¹ PostgreSQL æ•°æ®åº“çš„é€æ­¥éƒ¨ç½²å’Œæ•°æ®æ¥æ”¶

### åœ¨ Heroku ä¸­å…è´¹éƒ¨ç½² PostgreSQL æ•°æ®åº“ï¼Œå¹¶ä½¿ç”¨ Pandas å’Œ SQLAlchemy æ¥æ”¶æ•°æ®

towardsdatascience.com](/deploy-free-postgresql-database-in-heroku-and-ingest-data-8002c574a57d) 

# å‚è€ƒ

[](https://docs.getdbt.com/docs/introduction) [## dbt æ˜¯ä»€ä¹ˆï¼Ÿ| dbt æ–‡æ¡£

### dbt(æ•°æ®æ„å»ºå·¥å…·)ä½¿åˆ†æå·¥ç¨‹å¸ˆèƒ½å¤Ÿé€šè¿‡ç®€å•åœ°ç¼–å†™ selectâ€¦

docs.getdbt.com](https://docs.getdbt.com/docs/introduction) 

*åŸè½½äº*[*https://ealizadeh.com*](https://ealizadeh.com/blog/dbt-tutorial)*ã€‚***