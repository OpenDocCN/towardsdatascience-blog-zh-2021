# 数据科学中的因果推断:A/B 检验&有协变量调整的随机试验

> 原文：<https://towardsdatascience.com/causal-inference-in-data-science-a-b-testing-randomized-trials-with-covariate-adjustment-f5a24bd023b3?source=collection_archive---------34----------------------->

## **效率&A/B 测试中条件协变量调整的统计功效增益&随机试验**

![](img/6fdce09e3219cd9b08bbe217004e24c0.png)

照片由[卡斯帕·卡米尔·鲁宾](https://unsplash.com/@casparrubin?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

# 1:背景和动机

因果推理是一个涉及几个领域的领域，并引起了包括统计学家、数据科学家、机器学习科学家和其他计算研究人员在内的广泛从业者的兴趣。

到目前为止，我已经写了几篇关于因果推理空间的方法/主题的文章。其中包括:

*   [因果推理中的有效抽样框架](/efficient-sampling-frameworks-in-causal-inference-data-science-52ad44e15f48)
*   [因果推断中的双重稳健估计技术](/doubly-robust-estimators-for-causal-inference-in-statistical-estimation-3c00847e9db)
*   [半参数结构嵌套模型的 G-估计](/causal-inference-in-data-science-g-estimation-of-structural-nested-models-d11b1e3c9360?source=post_stats_page-------------------------------------)
*   [存在 M 偏差结构时因果效应的恢复](/causal-inference-in-data-science-structure-of-m-bias-with-confounding-adjustment-70e4a263ad08)
*   [在 AB 试验/随机试验中对边缘结构建模的需求，用于信息性审查调整](/causal-inference-in-data-science-a-b-testing-and-the-need-for-marginal-structural-modeling-b9ab299681bb)
*   [多重比较的有效推理覆盖率](/causal-inference-in-data-science-valid-inferential-coverage-with-multiple-comparisons-750e9e3f0259)

这篇文章涉及 A/B 检验(又名随机试验)和通过协变量调整的统计有效的条件抽样估计规范。即使在没有混杂因素的情况下，也为调整感兴趣结果的强预测因素的益处提供了数学上严格的论证和计算模拟。

该作品的内容如下:

![](img/3d3c3217393cbed78734ad653183dd14.png)

作者图片

# 2:具有连续结果的简单理想化 A/B 测试

我们将首先探讨在假设感兴趣的结果是连续的情况下，在 A/B 测试框架中协变量调整的好处:

## 2.1:玩具示例的规格

让我们假设一个简单的“理想化”A/B 测试，带有随机二元干预*和连续正态分布结果 ***Y*** 。“理想化”是指:*

*   *完美数据测量*
*   *完美的受试者依从性，无交叉干预*
*   *没有失访或丢失数据，因此没有信息审查*

**(关于受试者不依从和信息性审查的调整方法，请见* [*见我的*](/causal-inference-in-data-science-a-b-testing-and-the-need-for-marginal-structural-modeling-b9ab299681bb) *关于信息性审查和边缘结构建模)**

*与上述理想化 A/B 测试相对应的边际因果 DAG(在零值下)如图 1 所示。*

*![](img/6d66c2e9b5480b77e7ced9147d84f100.png)*

*作者图片*

*在上面的空因果 DAG 中，我们有二元介入*和连续结局 ***Y*** 。干预*是随机化的，因此没有箭头进入*。但是请注意，我们在集合***【L】***中有一组附加变量，带有指向结果 ***Y*** 的箭头。集合 ***L*** 中的变量是结果*Y 的直接原因(即预测因素)，它们独立于随机干预*而不是通过随机干预来调节。******

***对于有随机试验和 A/B 试验因果 DAG 经验的读者来说，在图 1 的*DAG 中设置 ***L*** 可能会显得奇怪。有人可能会问*“如果干预是随机的，那么干预和结果应该是图上唯一的变量？这是随机研究，不是观察研究？set****L****中的附加变量从哪里来？”*****

*这激发了关于“完全”因果 Dag 的重要讨论点。当我们指定一个因果 DAG 并判定图是“完整的”并且“所有的变量都在图上”时，我们具体指的是什么？嗯，具体来说，我们的意思是:*

*   *关于我们详细说明的科学上著名的感兴趣的问题，为我们的问题构建和恢复无偏抽样估计量所需的一组充分的变量在图上*

*重要的是要记住，在因果 DAG 上总是有比图示更多的变量。在实践中，我们经常只是形象地展示足以回答我们问题的变量。例如，在图 1 的*因果 DAG 中，理论上有更多的变量在两个方向上无限延伸:**

*   *集合 ***L*** 中变量的直接原因的变量，以及这些变量的直接原因，以此类推*
*   *是 ***Y*** 的直接后代的变量，以及这些变量的直接后代，等等*

*为了恢复干预*对结果*的因果效应的无偏估计，我们只需要变量*和 ***Y*** 。但是，这并不意味着 set ***L*** 中的变量不是真实存在的。****

**对于我们感兴趣的问题以及本文的主题，我们将清楚为什么选择在我们的因果 DAG 中以图形方式显示集合 ***L*** 中的变量。还是那句话，我们不需要包含 ***L*** 来恢复一个*A*Y 因果效应的无偏估计。但是从推理覆盖和统计功效的角度来看，包括*对我们是有益的，我们很快就会看到。*****

## ***2.2:**因果效应估计的“标准”边际抽样估计量*****

*****让我们具体说明在最简单的随机试验或玩具问题的 A/B 试验中使用的“标准”边际抽样估计量。*****

*****同样，从*图 1* 中的因果 DAG 开始:*****

****![](img/6d66c2e9b5480b77e7ced9147d84f100.png)****

****作者图片****

****![](img/99043400e4562c97555b7abba7beb219.png)****

****作者图片****

****![](img/0f2d237bf8fdd07b1b36f47947b8e83b.png)****

****作者图片****

## ****2.3:因果效应估计的条件抽样估计量****

****![](img/c9c408aa1034e5461c3e870e739af5f4.png)****

****作者图片****

****在*图 2* 中，我们有与*图 1* 中相同的因果 DAG，除了我们现在对集合 ***L*** 进行调节。注意，我们仍然对恢复干预*对结果*的平均因果效应的无偏估计感兴趣。******

*****![](img/bbfbbfba629941849872e0936490d151.png)*****

*****作者图片*****

*****![](img/c365e68cbb5ee861fbf3004d1c8cb87a.png)*****

*****作者图片*****

## *****2.4:抽样方差和统计功效的差异*****

*****![](img/854c07971bbcc1f1b5e55ba3dfdcf5a6.png)*****

*****作者图片*****

*****![](img/bd3a4f93d7cc810026aef20432bf5daa.png)*****

*****作者图片*****

*****![](img/e35f53ccce7b54370e776c33cb659218.png)*****

*****作者图片*****

*****![](img/6ad975673d81969f70d95e6ae6fda3f2.png)*****

*****作者图片*****

*****![](img/f035bc11e86711ae6140c88b558adb64.png)*****

*****作者图片*****

*****![](img/486b4cdd68aed312502db61e46f2b887.png)*****

*****作者图片*****

# *****3: **具有二元结果的简单理想化 A/B 测试*******

*****现在，让我们在假设感兴趣的结果是二元的情况下，探讨 A/B 测试框架中共变量调整的好处。由于优势比的不可压缩性，我们正在分别处理二元结果案例。*关于不可压缩性的详细讨论，* [*参见 Miguel Hernan 和 James Robins 的《因果推论:如果*](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/) *会怎样》一文中的第 4.3 点。******

## ****3.1:玩具示例的规格****

****让我们假设一个简单的“理想化”A/B 测试，带有随机二元干预*和伯努利分布结果*****

*****与上述理想化 A/B 测试相对应的边际因果 DAG(在零值下)如图 3 所示。*****

*****![](img/07d7d496f8982b11d19451d2834940a6.png)*****

*****作者图片*****

*****在上面的空因果 DAG 中，我们有二元干预*，二元结果 ***Y*** ，以及协变预测结果*中的集合*。请注意，上面的 DAG 与 2.1 节中的*图 1* 几乎相同，除了感兴趣的结果 ***Y*** 是二进制而不是连续的。********

## ****3.2:**因果效应估计的“标准”边际抽样估计量******

******让我们具体说明在最简单的随机试验或玩具问题的 A/B 试验中使用的“标准”边际抽样估计量。******

******再次从*图 3* 中的因果 DAG 开始:******

******![](img/07d7d496f8982b11d19451d2834940a6.png)******

******作者图片******

******![](img/af151a73a788ba6928c3f82e5dd08929.png)******

******作者图片******

******![](img/0bc8a8be2bec089768475a66a144876a.png)******

******作者图片******

## ******3.3: **因果效应估计的条件抽样估计量********

******![](img/134594353531bc3e235ed021b7e1eec7.png)******

******作者图片******

******![](img/b61cb8133ed64ee46419a7d8f0a1ab63.png)******

******作者图片******

******![](img/bae46193f44e01d2c1e13bad7b501052.png)******

******作者图片******

## ******3.4:抽样方差和统计功效的差异******

******![](img/83b9733eb1483cf9fda1c31fb2d5e02e.png)******

******作者图片******

******![](img/19d8d051120862a68ec376b53bee7ed1.png)******

******作者图片******

# ******4.计算模拟******

******下面是第 2 节(连续结果病例)和第 3 节(二元结果病例)中介绍的理想化随机试验的 Python 计算模拟。研究了有和没有协变量调整的平均因果效应差异的无偏估计的恢复，显示了有协变量调整的统计效率增益:******

******让我们导入我们需要的库:******

******接下来，我们模拟随机试验的函数，包括有无协变量调整的连续/二元结果，以及功效计算:******

******在连续结果情况下运行模拟:******

******在二元结果情况下运行模拟:******

******从上面的结果中，我们可以看到，在连续和二元结果情况下，协变量调整分析与未调整分析相比，在功效方面有效率增益。******

******以上计算模拟的完整代码/笔记本，请看下面的 [**github 链接**](https://github.com/atrothman/Randomized_Trial_Covariate_Adjustment) 。******

# ******5.总结和结论******

******这总结了我们对协变量调整的 A/B 检验的推导和计算模拟，以及从统计效率的角度来看这样做的好处。我鼓励任何发现上述材料有见地的人创建自己的模拟示例，利用我的代码作为起点，并自己进行实验！******

******如果你想了解更多关于因果推理的方法和注意事项，我会推荐哈佛大学 Miguel Hernan 和 Jamie Robins(我以前的两位教授)的教科书“*因果推理:如果*会怎样”，加州大学洛杉矶分校 Judea Pearl 的教科书“*因果关系*，斯坦福大学 Daphne 黑仔和耶路撒冷希伯来大学 Nir Friedman 的教科书*概率图形模型:原理和技术*，以及加州大学伯克利分校 Mark van der Laan 和 Sheri 的两本关于*目标最大似然估计*的教科书这些都是很棒的文章。我计划在未来写更多关于因果推理的深度文章。******

******[因果推断:如果](https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/)会怎样******

******[因果关系](http://bayes.cs.ucla.edu/BOOK-2K/)******

******[概率图形模型:原理和技术](https://mitpress.mit.edu/books/probabilistic-graphical-models)******

******[目标最大似然估计](https://vanderlaan-lab.org/papers/)******

******希望以上有见地。正如我在以前的一些文章中提到的，我认为没有足够的人花时间去做这些类型的练习。对我来说，这种基于理论的洞察力让我在实践中更容易使用方法。我个人的目标是鼓励该领域的其他人采取类似的方法。我打算在未来写一些基础作品，所以请随时在 [**LinkedIn**](http://www.linkedin.com/in/andrew-rothman-49739630) 上与我联系，并在 Medium 上 [**关注我的更新！**](https://anr248.medium.com/)******