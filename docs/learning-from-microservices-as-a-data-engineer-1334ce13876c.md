# 作为一名数据工程师，向微服务学习

> 原文：<https://towardsdatascience.com/learning-from-microservices-as-a-data-engineer-1334ce13876c?source=collection_archive---------10----------------------->

## 专业化的软件是不是更好的软件？

## 为什么软件工程师转向微服务，我们如何从他们的经验中学习📖

![](img/fe7fe61d0f1a179c3a2eddb7746d02f9.png)

我能找到的最好的独角兽😄，照片由 [**马克·格兰西**](https://www.pexels.com/@mark-glancy-721708?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels) 发自 [**像素**](https://www.pexels.com/photo/boston-terrier-wearing-unicorn-pet-costume-1564506/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels)

# 闪购独角兽

[**早期的 Gilt.com**](https://en.wikipedia.org/wiki/Gilt_Groupe)**，一家专门从事时尚单品闪购的网购网站(及手机 app)👠:该技术是一个由 PostgreSQL 数据库支持的用 Ruby On Rails 编写的大型应用程序。**

**有一段时间，它使 Gilt 能够快速移动，因为所有的东西都在一个地方，并且很容易对架构进行推理。**

**然而，当吉尔特变得超级受欢迎时，问题开始了…**

**flash 销售的性质造成了**流量高峰**，这最初在很大程度上由于云的按需资源和弹性(在这种情况下，AWS)而得以缓解，但是扩展 monolith 来处理高峰需要成本高昂的资源💸。**

**除了**成本和稳定性问题**之外，工程团队还在成长，让多个团队在单一应用程序的不同部分工作需要大量的**协调**来确保变更可以安全部署。**

# **微服务**

**因此决定，单片应用处理的不同进程将逐渐转移到专门的小型服务，最终成为微服务(参见[扼杀者模式](https://martinfowler.com/bliki/StranglerFigApplication.html))。这些服务将高度解耦，并通过版本化的显式接口进行通信:RESTful APIs。**

**这种新架构支持:**

*   **每项服务都要单独扩展📈。**
*   **每项服务都要单独部署📦。**
*   **团队明确拥有 X 数量的服务。**
*   **团队自治🏃 🏃‍♀.**
*   **代码库更小，更容易被拥有它们的团队理解。**
*   **通过 API 和 API 版本化，不同团队之间可以更好地协作。**
*   **微服务将分别进行框架和语言更新。**

**使用微服务的组织优势，我简单地称之为“快速和自治”，在这篇博客文章中，在领域驱动开发的背景下进行了广泛的探讨:**

**<https://medium.com/datadriveninvestor/if-youre-building-microservices-you-need-to-understand-what-a-bounded-context-is-30cbe51d5085>  

*为了更深入地了解 Gilt 的微服务方法和经验教训，我建议您观看 QCon 上的* [*约尼·戈德堡*](https://www.linkedin.com/in/goldbergyoni/)*[*演示*](https://www.infoq.com/presentations/microservice-arch-gilt) *。**

> *2017 年，我加入了 Gilt.com 的数据团队*

*那时，有超过 100 个微服务。事实上，一些微服务被进一步分解成更小的应用程序，称为“lambdas”。我想强调的是，管理超过 100 个微服务是一项艰巨的任务，它只对一定规模的组织有益。在您开始下一个绿地项目之前，微服务阅读:*

*<https://www.martinfowler.com/bliki/MonolithFirst.html>  

我在这里的目的不是宣称微服务是银弹！🙅‍♂

他们有自己的**问题**，例如:

*   由于多个微服务相互作用和相互依赖，提供开发/测试/集成环境变得更加困难。
*   “调用堆栈”可能很复杂，因为一个操作可能会导致对不同微服务的多次调用。
*   将代码库分成不同的微服务会产生开销，例如，需要设置不同的包，设置 CI/CD 资源…
*   网络/CPU 不是免费的！“太小”的微服务由于需要发出所有请求而表现不佳。

相反，我的目的是强调整体架构中固有的问题，以便我们在开发数据解决方案时能够注意到这些问题。⚠️* 

# *它与数据工程有什么关系？*

*在数据工程中，今天，我们倾向于创建更少的服务，并在框架中实现逻辑(如 Airflow、Spark、Flink……)。但是有些原则仍然是正确的:*

*   *一个软件的范围应该被清晰地定义，并且容易推理:松散定义的范围会导致你的应用程序变成一个整体。*
*   *清晰的团队边界和所有权允许团队更快地前进。*
*   *较小的应用程序允许更细粒度的扩展。*
*   *更小的应用程序使得“尽早发布，经常发布”更加安全，不仅是团队开发的代码，还有库更新和编程语言更新。*
*   *较小的应用程序更容易将逻辑“组合”在一起，或者换句话说:增加可重用性。🙌*

# *将这些原理应用于气流*

*Apache Airflow 是一个流行的调度程序和数据管道创作框架。它也是一个“模块化的整体”:一个做很多事情的应用程序，，但是组件有明确定义的角色。*

*气流由以下物质组成:*

*   *Web 服务器。*
*   *工人。*
*   *得益于 Airflow 2.0 的多重调度程序😀。*
*   *定义任务如何在基础设施上运行的执行者。*
*   *定义任务如何连接到外部服务的挂钩。*
*   *定义任务执行期间发生何种工作的操作员/传感器。*

*两年前，当我开始使用气流时，运营商对我发出了警告🚩。当我们在操作符中编写转换、提取和加载逻辑时，我们将许多有价值的、可重用的软件锁定在了 Airflow 中。为了使用这些组件，其他团队被迫依赖或直接使用气流。*

*我们最终还会引入依赖性，这可能会很快堆积起来并产生冲突。*

*借鉴微服务，我认为将我们自己限制在触发和监控在气流的之外**部署和管理的应用的操作员是一个更好的模式。***

*[杰西卡·拉夫林](https://medium.com/u/cde51aa5548a?source=post_page-----1334ce13876c--------------------------------)写了一篇关于 Bluecore Engineering 转向 KubernetesPodOperator 并将他们的逻辑打包到容器中的非常详细的帖子，这是实现这一目标的一种方式。*

*<https://medium.com/bluecore-engineering/were-all-using-airflow-wrong-and-how-to-fix-it-a56f14cb0753>  

# 在 Spark 上重复过去的错误

在 Gilt，当我们采用 Spark Scala 时，我们创建了**一个**单一 Scala 项目。我们构建的不同管道依赖于共享类，共享类将为 Spark 会话定义助手和实用程序，读取/写入默认值和用户定义的函数。

因为所有的数据管道由于它们共享的项目而紧密耦合，所以我们必须在更新 Spark 时迁移“ **All or Nothing** ”。这在 Spark 中尤其令人痛苦，在某些负载和资源配置下会出现错误，因此我们希望在发布之前在生产条件下测试整个**项目。**

我们只有两个团队在 Spark 项目上工作，我想除此之外，更新一个完整的 Spark 项目需要大量的协调工作，特别是当错误可能出现在推进更新的团队不拥有和不理解的管道中时。😢

回过头来看，**每个团队**或者**每个管道**都应该是自己的 Spark 项目，我们可以单独更新和打包。共享助手库的有用性并没有超过管道中共享依赖所带来的问题。

注意，拥有独立的项目会带来开销，就像微服务一样。

当将应用程序分割成更小的部分时，考虑您的团队结构、团队规模，以及如何减少管理小项目的开销。例如，如果您有许多数据管道和小团队，为新项目创建模板将会很有价值。共享的 CI/CD 逻辑 or/和 [Monorepo](https://en.wikipedia.org/wiki/Monorepo) 设置也会有所帮助。

# 打破数据仓库

数据工程中软件的专门化和解耦可以从从前云数据仓库到新的数据湖库系统的演变中看出。

下面是构成**数据仓库**的工具列表，它们实际上是“解构的”数据仓库:

*   特殊文件格式(如 Avro、Parquet)。
*   分布式文件系统(例如 S3、GCS)。
*   元数据存储(例如，Hive Metastore)。
*   计算引擎(例如 Spark、Presto)。
*   事务层(例如，德尔塔湖、阿帕奇胡迪)。

我想象新一代的**专有**云数据仓库产品的结构也是由专门的组件组成的，甚至可能使用我刚刚列出的开源工具的某个版本，但是对这些架构的可见性有限(所以我只能猜测😃).

# 最后

作为数据工程师，我们可以从微服务架构旨在解决的问题中学习，并意识到紧密耦合软件的危险。

我个人觉得有趣的是，现代数据堆栈中的趋势也正朝着**模块化**和**专用**组件发展，这种趋势我们在后端工程中已经看到，但在具有“微前端”的前端中也是如此。🤔

> 所以，保持简单，也许小？

## 附加 Gilt 微服务资源

我想再分享一些 Gilt 校友发给我的 Gilt.com 资源(谢谢！！)

*   [2016 年 3 月悉尼 Gilt.com 微服务展](https://speakerdeck.com/sullis/microservices-at-gilt-dot-com-sydney-march-2016)
*   [AWS re:Invent 2016:从单片到微服务:演进的架构模式](https://www.youtube.com/watch?v=oRIYtOsAlzk)
*   [微服务—温哥华 BC—2018–09–20](https://speakerdeck.com/sullis/microservices-vancouver-bc-2018-09-20)***