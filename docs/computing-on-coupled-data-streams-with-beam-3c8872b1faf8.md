# 用 Beam 计算耦合数据流

> 原文：<https://towardsdatascience.com/computing-on-coupled-data-streams-with-beam-3c8872b1faf8?source=collection_archive---------28----------------------->

## [思想与理论](https://towardsdatascience.com/tagged/thoughts-and-theory)，[行业笔记](https://towardsdatascience.com/tagged/notes-from-industry)

## *耦合数据流需要一起分析，特别注意事件时间的同时性和控制参与者流的其他流程特定变量……*

数据流现在无处不在。IOT 设备、自动柜员机交易、应用程序、传感器等……源源不断地输出数据。当这些数据流*到达*时，分析它们会带来挑战——尤其是当数据流是耦合的时候。例如，当单个底层进程生成多个数据流时，它们*将*耦合。耦合的数据流只能一起分析，要特别注意这些数据流上的事件在时间上的同时性(以及其他与过程相关的问题，如发出数据流的空间位置)。如果其中一个数据流由于某种原因被延迟，整个处理框架就会停止工作，等待它赶上来，而来自其他数据流的数据就会堆积起来。

等到*所有数据都在*中才能理解它—不适用。在任何时间*所有数据都不会在*中。流处理技术在*时间*内通过窗口将流动的数据分批成块，并将每个块作为一个批次进行分析。由于有不同类型的*时间* —事件/日志/流程等，用于批处理流的具体时间量取决于生成数据的流程和分析的目标。要使用的时间窗的具体类型(固定宽度、重叠等)及其宽度也是如此。缓慢发展的现象可以存在于更大的时间窗口中，而高度动态的系统将需要足够薄的时间窗口来忠实地跟踪过程随时间的变化。每个数据窗口可能在该窗口的代表时间*产生一些关于过程的度量——比如说它的中点。*

这是一个不完美的世界

现实世界中的数据流从来都不是完美的，因此流处理框架必须计划如何处理它们。

*   **迟到、无序到达和未出现**。一些旧的测量可能在途中被延迟，并且比新的测量晚到达。有些人可能会完全迷路。时间窗应该打开多长时间是一个没有严格正确答案的问题。它依赖于产生数据并将数据传输到处理框架的机制。
*   **早期和改善结果**。在处理该批数据之前，应该不需要等待时间窗口关闭，特别是当我们需要为迟到者打开时间窗口时。计算早期指标，即使它们是近似值，对于检测和警告潜在问题可能是有用的。
*   **需要同时**。大多数进程以不同的速率产生不同的数据流。例如，化学反应器可能在不同的位置具有温度和压力传感器，每个传感器生成一个数据流。对反应堆健康状况的任何分析都需要在*相同的*时间从所有位置测量温度和压力。也就是说，不能使用一次温度测量和几分钟后(或在不同位置)的压力测量来正确评估反应堆的健康状况。

这篇文章的目的是在模拟数据流上说明上述内容。至于流处理框架，我们将使用 [Apache Beam](https://beam.apache.org/) ，因为它似乎设计得很好，可以处理真实世界的数据流。此外，Beam 提供了一个可移植的 API 层来构建并行数据处理管道，这些管道可以在各种执行引擎上执行，包括 Google Cloud[data flow](https://cloud.google.com/dataflow)for scale。我们将坚持使用在本地运行的 DirectRunner。我们将使用 [Apache Kafka](https://kafka.apache.org/) 来产生数据流，并在 Beam 管道中使用它们。实现代码可以从 [github](https://github.com/ashokc/computing-on-coupled-data-streams-with-Beam) 获得。

# 1.数据流

考虑识别一个明确定义的三角形的三个点。让一个理想的质量-弹簧系统附着在每一点上，当实验开始时，在它的最外部位置释放。当这些点以不同的频率围绕其静止状态执行简谐运动时，它们的坐标位置( *x，y* )产生稳定的数据流。当三角形变形时，对由这三个点标识的三角形的周长和面积等度量的精确估计是令人感兴趣的。这里的理想三角形只是一个替代物，比如说一个支撑关键结点的三角形金属法兰，数据流从每个角落的位置监控器发出。下面的图 1 说明了这一点，并获得了作为时间的显式函数的坐标位置。

![](img/728e162b3d6d0e7a3b484a6e92e525e0.png)

图一。顶点围绕它们的静止状态沿着指定的轴执行简单的谐波运动。每个顶点处的监视器为其坐标位置(x，y)生成数据流。这些流由 Beam 一起处理，以计算由这三个点确定的三角形 *的周长和面积(图片由作者提供)。*

给定这些等式，我们可以很容易地计算三角形度量，如周长和面积。下面的图 2 显示了顶点 A 在 90 秒内完成了一整圈，而顶点 B 摆动得更快，只需要 15 秒。随着顶点以不同的方式移动，三角形的面积和周长以某种混乱的方式变化。但它们确实显示出 90 秒的严格周期——因为 Ta 是 Tb 和 Tc 的简单倍数。

![](img/00d2e0dacc985d19e3b2fd8294ad342c.png)

图二。 *Ta=90，Tb=15，Tc=45。(A)顶点的坐标围绕其静止状态执行正弦运动(B)顶点沿着箭头线移动形成变形的三角形面积和周长以混沌的方式变化但具有预期的整体周期性(图片由作者提供)。*

![](img/53d2b0addd6c548a1243dd8d02d3f42f.png)

变形三角形的动画。任意时刻箭头的长度反映了该时刻顶点的移动速度*(图片由作者提供)。*

# 2.数据流

顶点的( *x，y* )坐标被发布到 Kafka 主题——数据流的源。实际测量时间是主题中事件的创建时间。但是事件是随机延迟的，所以以完全不同的顺序进入主题，如下面的图 3 所示。当然，每个测量的到达时间都严格地晚于创建时间。

![](img/6f9cdc8d05cec0afb0e2ad6ab62ff174.png)

图 3。*射束处理的时间窗基于事件创建时间。事件到达流的顺序与它们的创建顺序非常不同。因此，多个时间窗口看到在给定处理时间到达它们的事件(图片由作者提供)。*

图 3 显示了当事件到达主题/流时，时间窗口被事件填满。给定模拟的随机延迟，第一时间窗继续看到落入其中的事件，直到结束。最后一个时间窗口从一开始就看到一些事件。下面的图 4 显示了其中一个模拟中的活动生产订单与到货订单。

![](img/fb510628ca3c3da6f4c553fbf0d35056.png)

图 4。*测量事件被模拟为具有随机延迟，因此它们以非常不同的顺序到达流中。例如，顶点 A 的第一个测量事件在超过 10000 个其他测量已经进来之后出现在流中。相同事件时间的 B 和 C 顶点的测量直到 25000 个其他事件进来之后才进来。因此，严格来说，在那之前，第一个三角形的良好定义是不可用的。这是耦合数据流的典型问题。*

在理想情况下，从第一个事件落入该窗口的时刻起，每个时间窗口只需要在其宽度的持续时间内保持打开。但是考虑到这里的无序和迟到，时间窗口需要保持打开更长时间，以避免数据丢失。

# 3.流处理

流处理的目标是计算作为时间函数的三角形的面积和周长。这要求首先在每个时间窗口中识别一个三角形。一个定义明确的三角形要求所有三个顶点的位置同时为*和*。由于三台监视器没有进行同步测量，我们需要估计每个顶点在同一时刻的位置，比如它们所在时间窗口的中点。**

**![](img/c5a850b9332040fdb937b9d1f5cc045f.png)**

**图 5。*首先通过顶点(每个时间窗口)对事件进行分组，以便估计其在窗口中点时间的位置。通过顶点和窗口，处理是并行的。然后，根据公共时刻对它们进行重新分组，以组装定义三角形和发射度量所需的三个顶点(图片由作者提供)。***

**图 5 展示了我们通过数据得到我们想要的东西的机制。Beam 提供了方便的 IO 模块来与各种数据源和接收器对话。在这里，我们从 Kafka 主题中读取事件，并最终将指标写入 Elasticsearch 进行分析。上面的每一步(除了“应用窗口”之外，它只是在窗口中按事件时间对数据进行分组)都将一个元素集合作为输入，并将它们转换成另一个元素集合，然后提供给下一步。**

****3.1 键是** **同时并行**的键**

**选择(如果数据中不存在，则构建)正确的键来对数据进行分组对于确保时间上的局部性和同时性非常重要。以顶点为关键字进行分组首先为下一个处理步骤固定顶点，该步骤计算并发出所有顶点在某个公共时刻(如窗口中点)的估计位置。按该时刻分组会在同一时刻产生三个顶点，用于下一步定义三角形并计算该时刻的度量。**

**此外，并行性从顶点的数量切换到时间窗的数量。对于每个变换步骤，光束平行度内置于元素级别。我们的元素是键值对。例如，如果我们正在监控 10 个三角形法兰的数据，第一个分组可以产生 30 个并发执行。并且，如果我们选择在每个时间窗口内的 5 个瞬间估计顶点位置，第二组产生的潜在并行度是操作窗口数量的 5 倍。**

****3.2 估算插值****

**虽然这与波束无关，但我们这里的具体问题要求我们在估计窗口中点时间的顶点位置时要小心。我们可以尝试一个简单的平均值，但这只适用于顶点的位置在时间窗口的持续时间内没有太大变化的情况。更好的方法是如图 6 所示进行插值，从估算时刻的任意一侧选取几个最接近的测量值。**

**![](img/ef44847de337affb064ba83bab9da876.png)**

**图 6。*线性插值可以给出比简单平均更好的估计值*。*分段三次曲线可以进一步提高估计值。***

**此外，快速变化的量显然需要足够薄的时间窗来捕捉其动态，并在时间窗内用分段线性或(可能是三次样条)来近似它。**

****3.3 触发器****

**时间窗继续收集折点，直到不再有折点，此时时间窗将关闭。但是没有必要等到那个时候，因为我们可以*触发*窗格来不时地发出它的内容*。当一个窗口触发时，它发布它的内容，以便后续步骤获得一个新的元素集合来处理，并且一些三角形度量被发布出来用于分析。定期触发允许尽早(如果是近似的)立即获得度量。***

***窗口可以选择累积它的内容(就像我们在这里做的一样)，即使是在周期性地发出它们之后。这意味着随着图 6 中的估计值越来越接近精确值，度量的持续改进是可能的。***

*****3.4 管道代码*****

***这里运行这些模拟的完整代码可以从 [github](https://github.com/ashokc/computing-on-coupled-data-streams-with-Beam) 获得。为 Beam 设置的管道值得一看，以确认它与图 5 和图 6 中描述的内容相一致。***

# ***4.结果***

***对于顶点的两组不同的周期，每次都采用两种不同的估计方法(平均或插值)来获得结果。在第二组中，顶点的移动速度是第一组的三倍，这是为了突出插值策略的影响。因此总共运行四次，每次运行 360 秒，Beam 使用 1 秒的固定时间窗***

1.  ***Ta=90，Tb=15，Tc=45。通过线性插值估计中点顶点***
2.  ***Ta=90，Tb=15，Tc=45。通过以下方式估计中点顶点:简单平均***
3.  ***Ta=30，Tb=5，Tc=15。通过线性插值估计中点顶点***
4.  ***Ta=30，Tb=5，Tc=15。通过以下方式估计中点顶点:简单平均***

***图 7 显示了基本情况(运行 1)的周长与时间的函数关系。这基本上验证了这里用于处理三个耦合流以计算全局度量的整个方法。***

***![](img/aeebe361e512004f4e7a5a4352c25cbb.png)***

***图 7。周长与已知解析解的一致性非常好*(图片由作者提供)。****

***由于比例的原因，在上图中很难看到，但是所有时间窗口中的第一个和最终计算的周长值与精确值非常接近。让我们更仔细地看看这个问题。图 8 显示了所有四种情况下计算面积与精确面积之比随时间的变化情况。理想情况下，我们希望它是 1.0。***

***![](img/54e306b887fdb19ce3f63dca6d65c60d.png)***

***图 8。在时间窗口中累积事件改进了窗口寿命期间的预测。插值时，度量的最终计算值与精确值(8.1 和 8.3)非常一致，即使在快速变化的度量(8.3)的情况下，第一个计算值也只有大约 5%的误差。使用分段三次样条插值可能会有进一步的帮助。相比之下，当求平均值时，我们看到最终计算值的误差高达 25%，首次计算值的误差高达 40%(8.4)*(图片由作者提供)。****

***图 9 展示了从给定时间窗口开始的计算指标的演变。有点类似于图 8，但是包括了在时间窗的生命周期内发射的屈光不正的所有(即不仅仅是第一个和最后一个)值。当我们积累顶点时，我们再次希望看到改进。我们在插值的情况下会这样做，而在求平均值时不会这样做。***

***![](img/f26145a7ed8f6f864217c5f5b5c910da.png)***

***图 9。不同时间窗口发出的指标显示为处理时间的函数。随着处理时间的增加，我们希望该比率接近 1.0。当插值(9.1 & 9.3)时，我们确实看到稳定而快速地收敛到 1.0。*(图片作者)。****

# ***5.结论***

***耦合的数据流需要一起分析，要特别注意事件时间的同时性和控制数据流的其他过程特定变量。借助于一个已知精确解的测试问题，我们已经表明，用波束进行流水线处理可以精确地获得它们。***

***Apache Beam 提供了应对与处理耦合数据流相关的许多挑战的方法——无论是根据需要切换键以适应处理、允许延迟到达，还是启用早期度量等……加上元素级别的内置并行性和管道在不同运行器上执行的可导出性，使得 Beam 对于大规模流处理非常有吸引力。***

****原载于 2021 年 9 月 7 日 http://xplordat.com**[*。*](http://xplordat.com/2021/09/07/computing-on-coupled-data-streams-with-beam/)****