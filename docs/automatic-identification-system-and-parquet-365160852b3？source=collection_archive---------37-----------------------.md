# 自动识别系统和拼花地板

> 原文：<https://towardsdatascience.com/automatic-identification-system-and-parquet-365160852b3?source=collection_archive---------37----------------------->

## [理解大数据](https://towardsdatascience.com/tagged/making-sense-of-big-data)

## 如果在 Parquet 文件中存储最低程度解析的船舶位置数据，查询大量数据会更快更容易。

![](img/2ea08304bbf2bdd6b1d06037b258887c.png)

通过维基百科的公共领域图像

仅仅一百多年前，[两艘船在加拿大新斯科舍省的哈利法克斯港](https://en.wikipedia.org/wiki/Halifax_Explosion)相撞。勃朗峰装载了用于欧洲战争的炸药，当它与国际海事组织相撞时，货物着火了。这是核武器出现之前最大的一次人为爆炸，在战时的哈利法克斯，它夷平了城市的一部分，杀死了 1700 多人。

碰撞很少如此戏剧性，但即使是最近在 2017 年的[，也有生命在这些事故中丧生。](https://en.wikipedia.org/wiki/USS_John_S._McCain_and_Alnic_MC_collision)

*自动识别系统*旨在防止这种情况发生。装有 AIS 应答器的船只在水中行驶时会广播它们的位置、航向和身份。

这些低功率广播旨在为雷达提供帮助，可被邻近船只、岸上接收器甚至低空卫星接收到。从全球陆地和空间传感器网络收集 AIS 数据可以提供全球船舶交通状况。

这些数据已被用于评估无冰夏季对加拿大北部群岛船舶交通的影响，估计船舶对鲸鱼栖息地的噪声影响，以及规划港口社区的铁路和公路服务发展。

考虑到这一点，我的目标是构建 AIS 存储，以便可以轻松地创建关于时间、位置、身份和目的地的摘录，但要做到这一点，我需要从 AIS 的加密编码方案中提取一些重要信息。

**数据**

未分析的 AIS 数据样本。

从 AIS 接收器流出的数据只能模糊地辨认出来。AIS 发射机使用 27 个信息的词汇表。广播的不仅仅是船只的动向，AIS 信息还可以传递天气、船员、搜救活动和航行危险的信息。

我使用 Eric Raymond 的 [AIVDM/AIVDO 协议解码](https://gpsd.gitlab.io/gpsd/AIVDM.html#_introduction)指南来导航 AIS 句子结构。因为我正在处理已经存储在压缩文件中的数据，所以我的第一步是将每个文件加载到 pandas 中，并将感叹号上的每一行分成两列——前缀*和后缀*。**

*前缀包含关于一系列*标记块中的消息的元数据。*正则表达式可以提取这些有趣的比特。卫星来源的人工智能可以在轨道上缓冲，一些供应商提供传感器接收广播的时间(*报告 _ 时间*)和地面站接收数据的时间(*接收 _ 时间*)。不是每个句子都有下载时间，所以当数据存在时，会对其进行解析。*

*正则表达式也可以用来从后缀中分离出值——消息是否被分割成多个句子？如果有，这是第一句还是第二句？把两个句子联系在一起的片段 id 是什么？有效载荷需要填充吗？*

*AIS 信息最重要的部分是由随机出现的字符串组成的，它构成了信息后半部分的大部分。*

*AIS 有效载荷以 6 位 ASCII 编码。为了使它可读，我们必须将这部分消息转换成二进制，取出必要的数据位，并将数据转换成适当的类型——字符串、浮点、有符号或无符号整数。*

*构建有效负载的最后一步是将第二个片段附加到多部分句子的第一个片段上。我招募了一个熊猫“外”合并为这项工作。*

*现在我们有了一串 1 和 0，我们可以分割它们来找到船的身份和位置。*

***分割比特***

*第一步是通过将消息的前六位拉成一个无符号整数，用句子的消息类型标记每一行。*

*有了消息类型，我们可以开始提取船只的位置。消息 1、2、3、4 和 18 具有纬度和经度。*

*每艘装有 AIS 发射机的船只都由有效载荷的第 8 至 37 位携带的*海上移动服务标识* (MMSI)进行识别。*

*消息类型 5 保存船只的目的地，如果声明的话。*

*使用上面的例子和 Raymond 的 AIS 指南中的详细规范，很容易从有效载荷中解析出其他属性。在这一点上，我有足够的元素来满足我在时间、位置、身份和目的地上创建摘录的目标。*

***如何存储数据？***

*我主要看到以 CSV 格式存储的 AIS 数据——我明白了，CSV 无处不在，大多数工具都能理解它，但是数据读取很慢。因为这个归档文件只能被读取，所以理想的做法是以列存储格式存储数据，比如 [Apache Parquet](https://parquet.apache.org/) 。*

*intertubes 上有很多关于拼花地板的信息，所以我在这里就不赘述了。我更想看看这种格式作为阅读格式与 CSV 相比如何。*

*将数据帧写入 Parquet 非常简单。为了帮助基于时间的搜索，我按年、月、日和小时对表进行了分区。*

*为了测试 Parquet 对搜索性能的影响，我以 snappy 压缩 Parquet 和未压缩 CSV 格式创建了一个大型 AIS 数据存储库，并使用 [Apache Drill](https://drill.apache.org/) 运行了一些查询。对于每个计时，我记录第二次运行的时间值，以便 optimiser 有机会缓存元数据。*

*使用 CVS 存储的数据执行大约 3.34 亿个报告的行计数需要 90 秒。对于拼花地板，计数需要 0.121 秒。查找前 100 个引用目的地的分组和排序查询对于 CVS 花费了 87 秒，对于 Parquet 花费了 4.5 秒。*

*对 CSV 存储数据执行的所有唯一 MMSIs 的频率计数需要 89 秒，而使用 Parquet 则需要 19.1 秒。最后，搜索单个 MMSI 对于 CSV 存储需要 82 秒，对于数据需要 6.2 秒*

*代码可以在[这里](https://github.com/ScottSyms/AISArchive)找到。*