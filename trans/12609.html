<html>
<head>
<title>De-Mystifying an Airflow DAG Script</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">揭开气流 DAG 脚本的神秘面纱</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/de-mystifying-an-airflow-dag-script-ff4f267edf34?source=collection_archive---------21-----------------------#2021-12-27">https://towardsdatascience.com/de-mystifying-an-airflow-dag-script-ff4f267edf34?source=collection_archive---------21-----------------------#2021-12-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4ddb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何阅读气流 DAG 脚本</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c5aa1f04b66b6b38285c96767d60056d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7wndR9WOSkqKmsatlWYLiA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/photos/v0PWN7Z38ag" rel="noopener ugc nofollow" target="_blank">去飞溅</a></p></figure><p id="14a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我第一次看到 Dag 脚本时，除了它主要是用 python 和一点 jinja 语言编写的，我发现脚本的流程很难理解。</p><blockquote class="lv lw lx"><p id="1794" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated"><strong class="lb iu"> DAG </strong>表示有向无环图</p></blockquote><p id="9d74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，这可能是由于 dag 脚本的复杂性或可读性问题，但我也认为即使有一个简单的 dag 脚本和可读的代码，它仍然会有点混乱。在我的工作中，我正在训练寻找模式和我发现的模式，这有助于我更容易地浏览 dag 脚本。</p><blockquote class="lv lw lx"><p id="4269" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated"><strong class="lb iu"> Airflow </strong>是一个以编程方式创作、调度和监控工作流的平台。虽然 Airflow 可以实现任何语言的程序，但实际的工作流是用 Python 编写的。点击了解更多关于气流<a class="ae ky" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank">的信息。</a></p></blockquote><h2 id="21be" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">典型的 dag 脚本由五个数据块组成，它们是</h2><ul class=""><li id="6d71" class="mv mw it lb b lc mx lf my li mz lm na lq nb lu nc nd ne nf bi translated">库导入块</li><li id="8987" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">DAG 参数块</li><li id="1314" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">DAG 定义块</li><li id="58d3" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">任务定义块</li><li id="3994" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">任务流水线块</li></ul><ol class=""><li id="b338" class="mv mw it lb b lc ld lf lg li nl lm nm lq nn lu no nd ne nf bi translated"><strong class="lb iu">库导入块</strong>是 dag 所需的所有库被导入的地方。</li></ol><p id="63d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">典型的<strong class="lb iu">导入块</strong>如下所示</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="51d8" class="mc md it nq b gy nu nv l nw nx"># import the libraries<br/></span><span id="9383" class="mc md it nq b gy ny nv l nw nx">#to set dates</span><span id="73e7" class="mc md it nq b gy ny nv l nw nx">from datetime import timedelta, datetime</span><span id="4619" class="mc md it nq b gy ny nv l nw nx"># The DAG object; we'll need this to instantiate a DAG</span><span id="5ee1" class="mc md it nq b gy ny nv l nw nx">from airflow import DAG</span><span id="29b3" class="mc md it nq b gy ny nv l nw nx"># Operators; we need this to write tasks!</span><span id="d76f" class="mc md it nq b gy ny nv l nw nx">from airflow.operators.bash_operator import BashOperator</span></pre><p id="2c72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 2。DAG 参数</strong>类似于 DAG 的设置，与<code class="fe nz oa ob nq b">start_date</code>、<code class="fe nz oa ob nq b">email</code>设置等的键值对一起存储在字典中。</p><p id="980d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个典型的<strong class="lb iu">参数块</strong>看起来像这样</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="1334" class="mc md it nq b gy nu nv l nw nx">#defining DAG arguments</span><span id="1ed1" class="mc md it nq b gy ny nv l nw nx"># You can override them on a per-task basis during operator initialization</span><span id="bc19" class="mc md it nq b gy ny nv l nw nx">default_args = {</span><span id="a9c2" class="mc md it nq b gy ny nv l nw nx">'owner': 'Wild One',</span><span id="dfbb" class="mc md it nq b gy ny nv l nw nx">'start_date': datetime(2021,12,25),</span><span id="9c96" class="mc md it nq b gy ny nv l nw nx">'email': ['xyz@somemail.com'],</span><span id="1120" class="mc md it nq b gy ny nv l nw nx">'retries': 1,</span><span id="a20d" class="mc md it nq b gy ny nv l nw nx">'retry_delay': timedelta(minutes=5),</span><span id="85ee" class="mc md it nq b gy ny nv l nw nx">}</span></pre><p id="d0aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ly">请暂时忽略传递的每个参数/自变量的含义，因为它不在本帖的</em>  <em class="ly">范围之内。</em></p><p id="3afc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 3。</strong><strong class="lb iu">DAG 定义块</strong>涉及实例化在<strong class="lb iu">导入块</strong>中导入的 DAG 类，并传递诸如实际 DAG 名称或<code class="fe nz oa ob nq b">dag_id</code>、在<strong class="lb iu"> DAG 参数</strong>块中设置的<code class="fe nz oa ob nq b">default_args</code>等参数。</p><p id="92f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">典型的<strong class="lb iu"> DAG 定义</strong>如下所示</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="1180" class="mc md it nq b gy nu nv l nw nx"># defining the DAG</span><span id="2a25" class="mc md it nq b gy ny nv l nw nx">dag = DAG(</span><span id="730e" class="mc md it nq b gy ny nv l nw nx">'my-first-dag',</span><span id="8b6e" class="mc md it nq b gy ny nv l nw nx">default_args=default_args,</span><span id="4737" class="mc md it nq b gy ny nv l nw nx">description='My first DAG',</span><span id="b327" class="mc md it nq b gy ny nv l nw nx">schedule_interval=timedelta(days=1),</span><span id="cc84" class="mc md it nq b gy ny nv l nw nx">)</span></pre><p id="24a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 4 </strong>。当然每个<em class="ly"> DAG </em>至少有一个<em class="ly">任务</em>。这就是<strong class="lb iu">任务定义</strong>块的用武之地。</p><blockquote class="lv lw lx"><p id="d267" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">DAGS 由运算符表示的任务组成。</p></blockquote><p id="d194" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">任务定义</strong>包括实例化所需的操作符，以运行选择和传递参数的任务，如任务名称或<code class="fe nz oa ob nq b">task_id</code>以及其他特定于所实例化的操作符类型的参数。</p><p id="dc11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ly">这些操作符应该已经在</em> <strong class="lb iu"> <em class="ly">导入块</em> </strong> <em class="ly">中导入了。</em></p><p id="d9bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">典型的<strong class="lb iu">任务定义</strong>如下所示</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="5899" class="mc md it nq b gy nu nv l nw nx"># define the tasks</span><span id="765a" class="mc md it nq b gy ny nv l nw nx"># define the first task</span><span id="bd0c" class="mc md it nq b gy ny nv l nw nx">start_task = BashOperator(</span><span id="437f" class="mc md it nq b gy ny nv l nw nx">task_id='start',</span><span id="9065" class="mc md it nq b gy ny nv l nw nx">bash_command='echo "Hello world"',</span><span id="3a0e" class="mc md it nq b gy ny nv l nw nx">dag=dag,</span><span id="9435" class="mc md it nq b gy ny nv l nw nx">)</span><span id="5b91" class="mc md it nq b gy ny nv l nw nx"># define the second task</span><span id="eaec" class="mc md it nq b gy ny nv l nw nx">end_task = BashOperator(</span><span id="2da7" class="mc md it nq b gy ny nv l nw nx">task_id='end',</span><span id="95b8" class="mc md it nq b gy ny nv l nw nx">bash_command='echo "Goodbye"',</span><span id="705e" class="mc md it nq b gy ny nv l nw nx">dag=dag,</span><span id="8d86" class="mc md it nq b gy ny nv l nw nx">)</span></pre><p id="669a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 5。</strong>最后，<strong class="lb iu">任务流水线</strong>模块，帮助我们组织任务的顺序，即定义任务依赖性。它由一个<strong class="lb iu">位移位运算符/符号</strong>表示，看起来像这样:<strong class="lb iu"> &lt; &lt; </strong>或<strong class="lb iu"> &gt; &gt;。对我来说，它们看起来或多或少有点像数学中的两个大于 25 的符号或小于 27 的符号，或者 bash 中的重定向运算符。在气流中，这些符号代表上游或下游运动。</strong></p><ul class=""><li id="1c32" class="mv mw it lb b lc ld lf lg li nl lm nm lq nn lu nc nd ne nf bi translated">上游(<code class="fe nz oa ob nq b">&gt;&gt;</code>)是指之前的<strong class="lb iu"/></li><li id="0d01" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">下游(<code class="fe nz oa ob nq b">&lt;&lt;</code>)是指之后的<strong class="lb iu"/></li></ul><p id="b9c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">典型的<strong class="lb iu">任务流水线</strong>如下所示</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="e190" class="mc md it nq b gy nu nv l nw nx"># task pipeline</span><span id="68a1" class="mc md it nq b gy ny nv l nw nx">start_task &gt;&gt; end_task</span></pre><p id="8841" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以如果你看到一个<strong class="lb iu">任务管道</strong>有<code class="fe nz oa ob nq b">task1 &gt;&gt; task2</code>，这意味着<em class="ly">任务 1 </em>应该在<em class="ly">任务 2 </em>之前运行。但是，如果是这样:<code class="fe nz oa ob nq b">task1 &lt;&lt; task2</code>，表示<em class="ly">任务 1 </em>应该在<em class="ly">任务 2 之后运行。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/d363f1ac79d64c360906b0cb50be0920.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mcmC9IVX0XRonIN67vyBxA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由作者使用<a class="ae ky" href="https://excalidraw.com/" rel="noopener ugc nofollow" target="_blank"> Excalidraw </a>创建</p></figure><p id="470d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上图是一个简单的 dag 图形视图，方框表示任务，箭头表示依赖关系。</p><p id="57d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个简单的 DAG 脚本可能类似于下面的代码</p><p id="bc73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ly">注意注释以识别区块</em></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由作者使用<a class="ae ky" href="https://deepnote.com/referral?token=095f134f" rel="noopener ugc nofollow" target="_blank">深度笔记</a>创建</p></figure><h2 id="b7ab" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">结论</h2><p id="d83a" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li of lk ll lm og lo lp lq oh ls lt lu im bi translated">现在您知道了如何解释典型 dag 脚本的流程，请注意，根据工作流的复杂性，它可能会变得复杂。请随意查看<a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow/stable/tutorial.html" rel="noopener ugc nofollow" target="_blank">这里的</a>以获取关于可用任务操作符、其众多参数可能性、每个参数的含义等信息。</p></div></div>    
</body>
</html>