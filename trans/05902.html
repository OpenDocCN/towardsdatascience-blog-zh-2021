<html>
<head>
<title>Automatic Hyperparameter Search and Optimization using Optuna</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Optuna的自动超参数搜索和优化</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automatic-hyperparameter-search-and-optimization-using-optuna-392d77917ede?source=collection_archive---------20-----------------------#2021-05-26">https://towardsdatascience.com/automatic-hyperparameter-search-and-optimization-using-optuna-392d77917ede?source=collection_archive---------20-----------------------#2021-05-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a277" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何简单高效地优化您的AI/ML模型的超参数</h2></div><p id="c34b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">超参数调优是AI/ML模型开发中比较耗时的手工任务之一。有时候，您希望在处理其他事情的时候能够自动化它们，比如弄清楚如何部署您的模型，或者只是享受一个下午茶休息时间。现在你可以这么做了。奥普图纳来救援了！</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/32490ab4061fae01e4f7168861314c34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k5Bpvo3CXfm7ROFJBxCAWA.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者图片</p></figure></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="a0fa" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">为什么是Optuna？</h1><p id="fde8" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">有许多类似的超参数调节库，包括Hyperopt。但是为什么特别是Optuna？对我来说，有几个原因:</p><ol class=""><li id="8b93" class="my mz it kk b kl km ko kp kr na kv nb kz nc ld nd ne nf ng bi translated">它是轻量级的、通用的和平台无关的。有很少的依赖性，Optuna可以集成到流行的ML框架中，包括PyTorch、Tensorflow、scikit-learn、<em class="nh">等</em>。</li><li id="5608" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated">Optuna是高效的，并且用优化的算法实现。它从一开始就通过删除没有前途的超参数搜索空间来执行修剪，从而使优化程序运行得更快。</li><li id="d6d1" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated">它为您跟踪优化过程的发展提供了简单而强大的可视化工具。</li><li id="53e1" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated">而且对我个人来说，Optuna有一个直观易懂的API，让我可以专注于模型开发任务本身。</li></ol><p id="769b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">既然你已经对Optuna有些信服了，那就让我们进入正题吧。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="b058" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">设置</h1><p id="f75a" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">首先，我们需要安装一些依赖项。您可以选择使用<em class="nh"> pip </em>或<em class="nh"> conda </em>进行安装。</p><ol class=""><li id="956a" class="my mz it kk b kl km ko kp kr na kv nb kz nc ld nd ne nf ng bi translated">使用画中画</li></ol><pre class="lf lg lh li gt nn no np nq aw nr bi"><span id="7491" class="ns mc it no b gy nt nu l nv nw">pip install optuna<br/>pip install plotly</span></pre><p id="766f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">2.使用conda</p><pre class="lf lg lh li gt nn no np nq aw nr bi"><span id="4dae" class="ns mc it no b gy nt nu l nv nw">conda install -c conda-forge optuna<br/>conda install plotly</span></pre><p id="4339" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不要忘记安装PyTorch！你可以在这里找到它的安装步骤<a class="ae nx" href="https://pytorch.org/get-started/locally/" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="f836" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">超参数优化</h1><p id="2ea4" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">一切都准备好了！让我们从导入一些我们需要的依赖项开始，包括PyTorch和Optuna。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="340d" class="ns mc it bd md oa ob dn mh oc od dp ml kr oe of mn kv og oh mp kz oi oj mr ok bi translated"><strong class="ak">获取数据集</strong></h2><p id="596f" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">为了便于说明，我们将使用TorchVision库提供的时尚MNIST数据集。我们将如下定义<code class="fe ol om on no b">train_loader</code>和<code class="fe ol om on no b">test_loader</code>。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="3888" class="ns mc it bd md oa ob dn mh oc od dp ml kr oe of mn kv og oh mp kz oi oj mr ok bi translated"><strong class="ak">初始化常量</strong></h2><p id="a74b" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">既然我们已经有了加载时尚MNIST数据集的工作函数，下一步就是定义一些以后会有用的常量。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="71b7" class="ns mc it bd md oa ob dn mh oc od dp ml kr oe of mn kv og oh mp kz oi oj mr ok bi translated"><strong class="ak">定义模型</strong></h2><p id="6bf8" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">此后，我们需要建立一个简单的网络来训练和验证我们的时尚MNIST数据。该网络将是一个简单的线性多层感知器，我们将在其中执行我们的第一个超参数优化试验:</p><ol class=""><li id="627e" class="my mz it kk b kl km ko kp kr na kv nb kz nc ld nd ne nf ng bi translated"><code class="fe ol om on no b">number of layers (n_layers)</code></li><li id="9521" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated"><code class="fe ol om on no b">hidden units (hidden_units)</code></li><li id="5eee" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated"><code class="fe ol om on no b">dropout probability (dropout_p)</code></li></ol><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="5bff" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，在上面的代码片段中，有一个参数<code class="fe ol om on no b">trial</code>被传递到函数<code class="fe ol om on no b">define_model()</code>中。这是一个独特的<em class="nh">关键字</em>,每当您想要试验超参数的值时，Optuna都会使用它。</p><p id="ad89" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe ol om on no b">trial.suggest_int()</code>或<code class="fe ol om on no b">trial.suggest_float()</code>是您可以调用来执行试验的一些方法。第一个参数是试验的名称，随后的参数将指示试验可以采用的可能值的列表。</p><h2 id="29c3" class="ns mc it bd md oa ob dn mh oc od dp ml kr oe of mn kv og oh mp kz oi oj mr ok bi translated"><strong class="ak">支持功能</strong></h2><p id="157d" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">现在让我们定义我们的<code class="fe ol om on no b">train</code>函数，我们将枚举<code class="fe ol om on no b">train_loader</code>并使用<code class="fe ol om on no b">negative log-likelihood (nll)</code>损失函数来计算训练损失。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="108b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不要忘记我们将要计算测试<code class="fe ol om on no b">accuracy</code>的<code class="fe ol om on no b">test</code>函数！</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="d807" class="ns mc it bd md oa ob dn mh oc od dp ml kr oe of mn kv og oh mp kz oi oj mr ok bi translated"><strong class="ak">定义目标函数</strong></h2><p id="b13b" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">这里，我们将向函数中传递另一个<code class="fe ol om on no b">trial</code>参数，以表明我们对执行超参数优化的兴趣。</p><p id="1dde" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将进行两次超参数试验:</p><ol class=""><li id="ba33" class="my mz it kk b kl km ko kp kr na kv nb kz nc ld nd ne nf ng bi translated"><code class="fe ol om on no b">optimizer_name</code></li><li id="74f1" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated"><code class="fe ol om on no b">lr</code>(学习率)</li></ol><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="9eb0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Optuna的优点是能够尽早修剪超参数搜索空间(即移除没有显示出有希望的结果的候选者)。</p><p id="0a51" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果结果不好且不需要进一步考虑，可在报告该纪元的试验后调用<code class="fe ol om on no b">raise optuna.exceptions.TrialPruned()</code>来完成。</p><p id="ef50" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">7.把所有东西放在一起</p><p id="e8eb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们需要通过定义一个驱动程序来编译我们所有的函数。我们通过以下方式做到这一点:</p><ol class=""><li id="ef6d" class="my mz it kk b kl km ko kp kr na kv nb kz nc ld nd ne nf ng bi translated">创建一个<code class="fe ol om on no b">study</code>,我们的超参数优化将放置在它的下面</li><li id="b731" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated">指定<code class="fe ol om on no b">optimize</code>到<code class="fe ol om on no b">maximize</code>我们的准确性(或者<code class="fe ol om on no b">minimize</code>,如果您报告损失是要注意的关键指标)</li><li id="2036" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated">初始化两种类型的试验研究:<code class="fe ol om on no b">pruned_trials</code>(由于结果不够好而跳过的试验)或<code class="fe ol om on no b">complete_trials</code>(潜在的好结果)</li><li id="ae09" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated">打印出数值，以跟踪哪个超参数组合产生最佳结果</li></ol><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="92c0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">试验结束后，我们看到终端打印出以下结果。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/e13dabe1c5bc383b9e9eabf4469f4559.png" data-original-src="https://miro.medium.com/v2/resize:fit:698/format:webp/1*Uc1eWirhJrYgEAyKoE4pIQ.png"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">结果(图片由作者提供)</p></figure><p id="9fc4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们观察到，在100次试验后，其中38次确实有潜力(即完成)而其中62个实际上是无用的(即修剪)。最佳试验包括以下一组超参数:</p><ol class=""><li id="03b0" class="my mz it kk b kl km ko kp kr na kv nb kz nc ld nd ne nf ng bi translated"><strong class="kk iu">层数</strong> : 3</li><li id="18e0" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated"><strong class="kk iu">优化器</strong>:亚当</li><li id="f6da" class="my mz it kk b kl ni ko nj kr nk kv nl kz nm ld nd ne nf ng bi translated"><strong class="kk iu"> LR </strong> : 0.05492006</li></ol><p id="aace" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">干得好！</p><h1 id="dec4" class="mb mc it bd md me op mg mh mi oq mk ml jz or ka mn kc os kd mp kf ot kg mr ms bi translated">可视化结果</h1><p id="719a" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">现在一切都完成了，我们可以进行一个快速的可视化来看看我们的试验进展如何。</p><p id="59b2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，我们可以检查哪个超参数对模型的性能影响最大:</p><pre class="lf lg lh li gt nn no np nq aw nr bi"><span id="9263" class="ns mc it no b gy nt nu l nv nw">from optuna.visualization import plot_param_importances</span><span id="ce00" class="ns mc it no b gy ou nu l nv nw">plot_param_importances(study)</span></pre><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/32490ab4061fae01e4f7168861314c34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k5Bpvo3CXfm7ROFJBxCAWA.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">超参数重要性(图片由作者提供)</p></figure><p id="e329" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第二层中隐藏单元的数量似乎是影响模型性能的主要因素！</p><h1 id="1fb7" class="mb mc it bd md me op mg mh mi oq mk ml jz or ka mn kc os kd mp kf ot kg mr ms bi translated">离别的思绪</h1><p id="061c" class="pw-post-body-paragraph ki kj it kk b kl mt ju kn ko mu jx kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">现在，您可以相对轻松地自动化您的超参数优化过程。有了这些多余的时间，你肯定可以构建一个更好的ML模型，或者享受更多的下午茶休息时间…</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><p id="471b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> <em class="nh">我定期通过我的电子邮件简讯，用简单的英语和漂亮的可视化总结人工智能研究论文，请在</em></strong><a class="ae nx" href="https://tinyurl.com/2npw2fnz" rel="noopener ugc nofollow" target="_blank"><em class="nh">【https://tinyurl.com/2npw2fnz】</em></a><em class="nh">订阅。</em></p></div></div>    
</body>
</html>