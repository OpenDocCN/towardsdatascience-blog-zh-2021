<html>
<head>
<title>Building a real-time web app in NodeJS Express with Socket.io library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Socket.io库在NodeJS Express中构建实时web app</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-real-time-web-app-in-nodejs-express-with-socket-io-library-d9b50aded6e6?source=collection_archive---------6-----------------------#2021-08-30">https://towardsdatascience.com/building-a-real-time-web-app-in-nodejs-express-with-socket-io-library-d9b50aded6e6?source=collection_archive---------6-----------------------#2021-08-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="49c3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">服务器+客户端代码实现来检索公交车到达时间</h2></div><h2 id="7fc4" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">用例:我的公交路线可视化网站</h2><p id="6ef8" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">为了更深入地了解公共交通通勤者的出行模式，几个月前我接受了一项任务，对一系列公共汽车出行进行出行链分析。虽然我最初在<a class="ae lx" href="https://sg-transportation.glitch.me/" rel="noopener ugc nofollow" target="_blank">建立了一个公交路线可视化网站</a>，其唯一目的是基于所选的特定始发地-目的地配对导出定制公交路线数据:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ly"><img src="../Images/b007942acac9b26b302cb7de7b9d0011.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dDjLS1LBpUOlTFh357ozLg.png"/></div></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">作者截图|显示支持选择始发地和目的地公交车站的网站功能</p></figure><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mo"><img src="../Images/690820f27d0bf3978545900e7acdd1c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MrnOOOJPG62tror-WAPseg.png"/></div></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">作者截图|选择的始发地公交线路数据可以在web app上导出</p></figure><p id="cbf4" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated">后来我决定进一步探索和利用<a class="ae lx" href="https://datamall.lta.gov.sg/content/datamall/en/dynamic-data.html#Public%20Transport" rel="noopener ugc nofollow" target="_blank">数据提供商</a>的公共API，其中包括返回<strong class="lg iu">任何特定公交车站的实时公交到达时间。简而言之，我很好奇API在它的实时响应中还包括哪些数据字段🤔</strong></p><p id="bb62" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated">虽然有其他库能够在web应用程序中集成实时数据流，但我实现<a class="ae lx" href="https://socket.io/" rel="noopener ugc nofollow" target="_blank"> Socket.io </a>的主要原因是因为它不仅提供了在服务器+客户端之间建立Web socket双向连接的功能，而且两个服务器&amp;客户端代码实现都是用JavaScript <strong class="lg iu">编写的，因此在编写应用程序的后端和前端代码时，无需在两种语言之间来回切换。</strong></p><h1 id="2610" class="mu kj it bd kk mv mw mx kn my mz na kq jz nb ka ku kc nc kd ky kf nd kg lc ne bi translated"><strong class="ak">socket . io的服务器端实现</strong></h1><p id="3d30" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">首先，在Express NodeJS web应用程序中，代码的服务器端通常指的是<strong class="lg iu">app.js/server.js文件</strong>，即初始化Express.js实例的web应用程序的入口点。通过<code class="fe nf ng nh ni b">npm install socket.io</code>安装NodeJS Socket.io库后，服务器端代码实现如下:</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h2 id="5aa9" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">因此，在上面的代码片段中应该注意几个关键点:</h2><p id="9e7d" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated"><strong class="lg iu"> 1。</strong>库socket.io通过以下方式导入:</p><pre class="lz ma mb mc gt nl ni nm bn nn no bi"><span id="889d" class="np kj it ni b be nq nr l ns nt">const socketio=require("socket.io")</span></pre><p id="c73e" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated"><strong class="lg iu"> 2。</strong>默认情况下，任何web socket实例都有名称空间<code class="fe nf ng nh ni b">disconnect</code>——如果实例已经与前端断开连接<em class="nu">(通常是由于与其web服务器断开连接)</em></p><p id="a4f3" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated"><strong class="lg iu"> 3。</strong>定制名称空间<code class="fe nf ng nh ni b">bus_arrivals</code>和<code class="fe nf ng nh ni b">get_bus_arrivals_info</code>将随后对应于来自客户端的完全相同的名称空间<strong class="lg iu"> (KIV) </strong>，使得在存在多个套接字通道的情况下，web套接字实例将能够基于名称空间来识别将哪些消息发送到哪些通道。</p><p id="9afa" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated"><strong class="lg iu"> 4*。</strong>在从Express NodeJS库中创建了<strong class="lg iu"> app </strong>实例之后，包装了<strong class="lg iu"> app </strong>实例的<strong class="lg iu">服务器</strong>实例通过以下方式进行初始化:</p><pre class="lz ma mb mc gt nl ni nm bn nn no bi"><span id="9bea" class="np kj it ni b be nq nr l ns nt">const server = http.createServer(app)</span></pre><p id="1303" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated">⚠这一点非常重要，因为<strong class="lg iu">应用</strong>和<strong class="lg iu">服务器</strong>实例具有完全独立的功能。当web应用程序的内容由<strong class="lg iu">应用程序</strong>实例提供服务时，实际的web套接字连接实际上是在<strong class="lg iu">服务器</strong>实例上运行的，其表示为:</p><pre class="lz ma mb mc gt nl ni nm bn nn no bi"><span id="5b4b" class="np kj it ni b be nq nr l ns nt">const io = socketio(server)</span></pre><h1 id="4378" class="mu kj it bd kk mv mw mx kn my mz na kq jz nb ka ku kc nc kd ky kf nd kg lc ne bi translated">Socket.io的客户端实现</h1><p id="2a70" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm kr ln lo lp kv lq lr ls kz lt lu lv lw im bi translated">从上述实现的第3点继续，回想一下命名空间<code class="fe nf ng nh ni b">bus_arrivals</code>和<code class="fe nf ng nh ni b">get_bus_arrivals_info</code>是为2个web套接字通道指定的:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nv"><img src="../Images/11a7a216e5e826418c904af063cd543d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n8bA71NZ4PB1cHlnJ1mqbw.png"/></div></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">作者插图|服务器通过套接字通道<strong class="bd nw">【bus _ arrivals】</strong>从客户端接收请求，以了解服务器应该检索哪个汽车站信息。然后，服务器继续进行API调用，以检索该特定汽车站的汽车到达信息。最后，API响应通过web socket通道<strong class="bd nw">【get _ bus _ arrival _ info】</strong>返回到前端进行渲染</p></figure><p id="8d7d" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated">要初始化web套接字的客户端实例，必须包含用于<a class="ae lx" href="https://socket.io/docs/v3/client-installation/index.html" rel="noopener ugc nofollow" target="_blank"> socket.io </a>的JavaScript浏览器库:</p><pre class="lz ma mb mc gt nl ni nm bn nn no bi"><span id="5d0f" class="np kj it ni b be nq nr l ns nt">&lt;script type="text/javascript" src="js/socket.io.js"&gt;&lt;/script&gt;</span></pre><p id="1074" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated">在实现Socket.io的以下代码片段嵌入浏览器的JavaScript内容之前:</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h2 id="3d5b" class="ki kj it bd kk kl km dn kn ko kp dp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">⚠请注意，服务器端安装的NPM Socket.io包和浏览器端导入的JavaScript库版本必须兼容。在我的<a class="ae lx" href="https://sg-transportation.glitch.me/" rel="noopener ugc nofollow" target="_blank"> web应用</a>中，我使用过的Socket.io库的版本有:</h2><ul class=""><li id="b085" class="nx ny it lg b lh li lk ll kr nz kv oa kz ob lw oc od oe of bi translated">服务器端NPM包:<strong class="lg iu"> socket.io v4.1.3 </strong></li><li id="a0dd" class="nx ny it lg b lh og lk oh kr oi kv oj kz ok lw oc od oe of bi translated">客户端JavaScript库:<strong class="lg iu"> Socket。IO版本4.1.3 </strong></li></ul><p id="b014" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated">有关确定您已安装的NPM包是否与您在浏览器上导入的JavaScript库兼容的更多信息，请参考<a class="ae lx" href="https://socket.io/" rel="noopener ugc nofollow" target="_blank"> Socket.io的官方网站</a>。</p></div><div class="ab cl ol om hx on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="im in io ip iq"><p id="818c" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated">最后，在决定了应该显示公交车到站信息的哪些数据字段之后，我决定实现以下布局:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi os"><img src="../Images/f5065e772ef9e1200def1417a890c65a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QKFF2dM6D7apIZfRLn30Jg.png"/></div></div><p class="mk ml gj gh gi mm mn bd b be z dk translated">作者截图|左图是从android设备上看到的，右图是从平板电脑屏幕上看到的。</p></figure><p id="6714" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated">这就对了。巴士ETAs现在将每10秒重新渲染一次<em class="nu">(可以定制)</em>以反映最新的更新！🤩</p></div><div class="ab cl ol om hx on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="im in io ip iq"><p id="c0b3" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated"><strong class="lg iu">参考消息:完整的源代码请点击</strong><a class="ae lx" href="https://github.com/incubated-geek-cc/sg-transportation" rel="noopener ugc nofollow" target="_blank"><strong class="lg iu">my GitHub repo</strong></a><strong class="lg iu">。web应用程序当前部署在:</strong><a class="ae lx" href="https://sg-transportation.glitch.me/" rel="noopener ugc nofollow" target="_blank">https://sg-transportation.glitch.me/</a></p><p id="a614" class="pw-post-body-paragraph le lf it lg b lh mp ju lj lk mq jx lm kr mr lo lp kv ms lr ls kz mt lu lv lw im bi translated">希望上面在NodeJS中实现<a class="ae lx" href="https://socket.io/" rel="noopener ugc nofollow" target="_blank"> Socket.io </a>的例子对您有用，非常感谢您的阅读！❤:如果你想阅读我即将发表的应对工作挑战的文章(包括人和技术问题)，请跟随我！会非常感激😀</p><div class="ot ou gp gr ov ow"><a href="https://geek-cc.medium.com/membership" rel="noopener follow" target="_blank"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd iu gy z fp pb fr fs pc fu fw is bi translated">通过我的推荐链接加入灵媒——李思欣·崔</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">获得李思欣·崔和其他作家在媒体上的所有帖子！😃您的会员费直接…</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">geek-cc.medium.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk mi ow"/></div></div></a></div></div></div>    
</body>
</html>