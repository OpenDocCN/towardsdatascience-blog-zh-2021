<html>
<head>
<title>Maximum inner product search using nearest neighbor search algorithms</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用最近邻搜索算法的最大内积搜索</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/maximum-inner-product-search-using-nearest-neighbor-search-algorithms-c125d24777ef?source=collection_archive---------9-----------------------#2021-10-13">https://towardsdatascience.com/maximum-inner-product-search-using-nearest-neighbor-search-algorithms-c125d24777ef?source=collection_archive---------9-----------------------#2021-10-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/4604a8310b3f48ab732f91456d23f848.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*KPpzdqDwn8Hv_yZY4k6DvA.jpeg"/></div><p class="iv iw gj gh gi ix iy bd b be z dk translated">这两个人看起来很像，对吧？约尔根·哈兰在<a class="ae iz" href="https://unsplash.com/s/photos/twins?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><div class=""/><div class=""><h2 id="3dae" class="pw-subtitle-paragraph jz jb jc bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">允许使用库进行最近邻搜索的简单简化，以便有效检测具有大内积的向量</h2></div><h2 id="1156" class="kr ks jc bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">动机</h2><p id="b8ba" class="pw-post-body-paragraph ln lo jc lp b lq lr kd ls lt lu kg lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">最近邻搜索是数据科学中最基本的问题之一。应用范围从用户分割到近似重复检测。毫不奇怪，大多数用于数据科学应用程序的编程语言都提供了具有高度可伸缩的最近邻搜索算法的库。</p><p id="b5a9" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">另一个广泛使用的问题是检测具有大内积的向量。例如，在多标签分类问题中，我们需要检测与需要分类的输入实例的向量具有最大内积的类别向量。在推荐系统中，我们寻找具有大内积的向量。</p><p id="ce34" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">这两个问题是相关的。正如我们下面所讨论的，如果所有的向量都有相同的范数，这两个问题就变得相同了。但是在大多数应用中，向量有不同的范数，这两个问题变得不同。在高层次上，在最近邻搜索中，我们寻找具有几乎相同值的向量。而在最大内积搜索中，优先选择它们之间具有小角度的向量。</p><p id="4cd7" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">在这篇文章中，我提出了一个简单的技巧，将最大内积搜索问题简化为最近邻搜索。该方法的主要好处是，我们可以将为最近邻搜索设计的高度优化的库应用于最大内积搜索问题。</p><h2 id="4019" class="kr ks jc bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">正式设置</h2><p id="3800" class="pw-post-body-paragraph ln lo jc lp b lq lr kd ls lt lu kg lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">通常，最近邻搜索被表述为欧几里得空间中的向量问题。向量x的范数定义为</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/a967718f2147b6dd13a29afab7a3aa5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/format:webp/1*qCFvgQR848sl7XhTHq0tfQ.png"/></div></figure><p id="28cd" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">给定数据库D，查询向量<em class="mq"> q </em>的最近邻是D中的向量<em class="mq"> x </em>，使得</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/8ad058dbcb2a2380227a3971093e3ae8.png" data-original-src="https://miro.medium.com/v2/resize:fit:698/format:webp/1*G4TE6ATeEqMXTebFdM3yRw.png"/></div></figure><p id="ecac" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">最大内积搜索定义为:</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/8c6ab0305253bd1b712b640582b86e97.png" data-original-src="https://miro.medium.com/v2/resize:fit:558/format:webp/1*Jy0EygzbykZC8cM28OcNuA.png"/></div></figure><p id="049a" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">我们假设我们有一个经常被查询的静态海量数据库D。例如，D包括由矢量表示的所有网飞电影。</p><h2 id="efd0" class="kr ks jc bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">单位范数向量</strong></h2><p id="5518" class="pw-post-body-paragraph ln lo jc lp b lq lr kd ls lt lu kg lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">如果数据库D中的所有向量都有单位范数，即||u||=1，那么这两个问题就等价了。注意到</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mt"><img src="../Images/e0a07e5cf82c0898c49fb8674b2f05a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-1PxcpmhpiCRpHpxQjLGTg.png"/></div></div></figure><p id="3713" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">因此，最小化两个向量之间的欧几里德距离对应于最大化它们的内积。因此，在D中寻找q的最近邻等价于寻找具有与q的最大内积的向量。当然，我们可以缩放所有向量和查询向量以具有单位范数，但是这可能导致重要信息的丢失。向量中条目的大小至关重要。</p><h2 id="8199" class="kr ks jc bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">一般情况下的简单简化</h2><p id="f06a" class="pw-post-body-paragraph ln lo jc lp b lq lr kd ls lt lu kg lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">在[1]中提出了以下简单的简化:</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div class="gh gi my"><img src="../Images/c1b8327a04571eab343a07e652696b61.png" data-original-src="https://miro.medium.com/v2/resize:fit:478/format:webp/1*J1zWQ-1wpos3WhLBCxpCqQ.png"/></div></figure><figure class="mm mn mo mp gt is gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/2c09c2edc773395a30d6d86072c28cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:684/format:webp/1*wHUwmape_KC-BH17ThdpHg.png"/></div></figure><figure class="mm mn mo mp gt is gh gi paragraph-image"><div class="gh gi na"><img src="../Images/a3b04cca69a37311ae53cc9ccd21a840.png" data-original-src="https://miro.medium.com/v2/resize:fit:356/format:webp/1*dzIWh4q9SCclRAurQa5R3w.png"/></div></figure><p id="1e63" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">φ是数据库中所有向量的最大范数。我们将φ和向量的范数之差作为第一坐标加到每个向量上。(这将总是非负的，因为φ是最大范数。)我们添加0作为查询向量的第一坐标。</p><p id="6195" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">对于变换向量的范数，我们有:</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/920de3eca5c61301ad020b635edd4b55.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/1*OXwqGtAyyflDHUjvUoArrA.png"/></div></figure><p id="ba8b" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">此外，由于q_z的第一个坐标为0，因此</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/8151a298e4ff95523d6c20c79035f6bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:314/format:webp/1*094VIm29qt7jDd-RDm2V4w.png"/></div></figure><p id="45bb" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">因此，新空间中向量之间的欧几里德距离可以重写为</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nd"><img src="../Images/4c6f98028d5d195bb539247b2ca88cb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QggHqfKLXv6OpkTDwT51ow.png"/></div></div></figure><p id="6ca4" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">我们看到唯一依赖于查询索引<em class="mq"> i </em>的项是内积<em class="mq"> x_i^T*q </em>。因此，变换空间中的最近邻向量z_i将对应于原始空间中具有最大内积x_i的向量。</p><h2 id="d322" class="kr ks jc bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">逆变换</h2><p id="1bc3" class="pw-post-body-paragraph ln lo jc lp b lq lr kd ls lt lu kg lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">在[1]中，作者还展示了如何将最近邻搜索问题简化为最大内积搜索。感兴趣的读者可以参考[1]中的定理2，但我不会在这里讨论它，因为它不太可能有实际的重要性。</p><h2 id="5958" class="kr ks jc bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">履行</h2><p id="7982" class="pw-post-body-paragraph ln lo jc lp b lq lr kd ls lt lu kg lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">给定数据库D，简单地将上述变换应用于D中的所有向量。然后，在查询q时，调用最近邻搜索算法。</p><p id="0f0c" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">对转换进行编码非常简单:</p><pre class="mm mn mo mp gt ne nf ng nh aw ni bi"><span id="625a" class="kr ks jc nf b gy nj nk l nl nm">def transform(vecs):<br/>    maxnorm = max([np.linalg.norm(v) for v in vecs])<br/>    new_vecs = []<br/>    for v in vecs:<br/>        new_vecs.append(<br/>           np.insert(v, 0, np.sqrt(maxnorm**2-np.linalg.norm(v)**2))<br/>        )<br/>    return new_vecs</span></pre><p id="d082" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">变换之后，我们可以使用最近邻搜索库来解决最大内积问题:</p><pre class="mm mn mo mp gt ne nf ng nh aw ni bi"><span id="85db" class="kr ks jc nf b gy nj nk l nl nm">from sklearn.neighbors import NearestNeighbors<br/>X = np.array(new_vecs)<br/>nbrs = NearestNeighbors(n_neighbors=1, algorithm='kd_tree').fit(X)<br/>distances, indices = nbrs.kneighbors(np.array([q]))</span></pre><p id="f9bf" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">完整的实现可以在<a class="ae iz" href="https://github.com/konstantinkutzkov/MIPS" rel="noopener ugc nofollow" target="_blank">这个Jupyter笔记本</a>中找到。在那里，我还展示了使用Python的最近搜索比显式计算查询向量q和数据库中所有向量的内积的简单实现更有效。</p></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><p id="6aff" class="pw-post-body-paragraph ln lo jc lp b lq mg kd ls lt mh kg lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">[1]约兰·巴赫拉赫、耶胡达·芬克尔斯坦、兰·吉拉德·巴赫拉赫、利兰·卡齐尔、诺姆·柯尼希斯泰因、尼尔·尼斯、乌尔里希·帕凯。使用内积空间的欧几里德变换加速Xbox推荐系统。RecSys 2014，此处<a class="ae iz" href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/XboxInnerProduct.pdf" rel="noopener ugc nofollow" target="_blank">提供</a></p></div></div>    
</body>
</html>