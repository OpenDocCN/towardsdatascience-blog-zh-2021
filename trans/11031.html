<html>
<head>
<title>How I Deployed a Sentiment Analyser API with spaCy, Flask and Heroku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何使用 spaCy、Flask 和 Heroku 部署情感分析器 API</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-i-deployed-a-sentiment-analyser-api-with-spacy-flask-and-heroku-bd9b8f9de6cf?source=collection_archive---------19-----------------------#2021-10-27">https://towardsdatascience.com/how-i-deployed-a-sentiment-analyser-api-with-spacy-flask-and-heroku-bd9b8f9de6cf?source=collection_archive---------19-----------------------#2021-10-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8a6a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何使用您构建的模型开发 RESTful APIs</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/362e44a48996149400c7279abbe6b099.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2lOY5Lr0i3N20GWF"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@artbyhybrid?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">混合动力</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="dc0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过完成本教程，您将学会使用 Flask 将机器学习模型部署到 Heroku。因此，即使您的组织中没有机器学习工程师或软件工程师，您也将拥有部署机器学习 REST APIs 的必要技能。</p><p id="09a3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将首先使用 spaCy 创建一个情感分析模型来进行演示。然后，我将向您展示如何使用 Flask 将这个模型转换成 REST API。最后，API 将被部署到 Heroku 并集成到现有的 web 应用程序中。</p><h1 id="04fd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">用 spaCy 创建一个简单的情感分析器</h1><p id="90dc" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，我们构建了一个基本的情感分析模型，它可以识别用户输入是积极的还是消极的。我们将使用<a class="ae kv" href="https://spacy.io/universe/project/spacy-textblob" rel="noopener ugc nofollow" target="_blank"> spaCyTextBlob </a>，它从<a class="ae kv" href="https://textblob.readthedocs.io/en/dev/" rel="noopener ugc nofollow" target="_blank"> TextBlob </a>扩展了<a class="ae kv" href="https://spacy.io/" rel="noopener ugc nofollow" target="_blank"> SpaCy </a>，具有额外的文本处理能力，包括情感分析。</p><p id="57d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们导入 spaCy 和 TextBlob。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="5171" class="mu lt iq mq b gy mv mw l mx my">import spacy</span><span id="d9ce" class="mu lt iq mq b gy mz mw l mx my">from spacytextblob.spacytextblob import SpacyTextBlob</span></pre><p id="1c0f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还加载了 spaCy 语言模型，并使用 TextBlob 扩展了我们的文本处理管道。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="ad0d" class="mu lt iq mq b gy mv mw l mx my">nlp = spacy.load('en_core_web_sm')</span><span id="83eb" class="mu lt iq mq b gy mz mw l mx my">nlp.add_pipe('spacytextblob')</span></pre><p id="9aaf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的目标是建立一个情感分析模型，该模型接受用户输入的字符串并对情感进行评分。模型应该在字典中输出它的预测，这将简化我们的 API 的开发。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="c4b3" class="mu lt iq mq b gy mv mw l mx my"># User input text<br/>user_input = 'This is a wonderful campsite. I loved the serenity and the birds chirping in the morning.'</span><span id="c41d" class="mu lt iq mq b gy mz mw l mx my"># Process user input<br/>doc = nlp(user_input)</span><span id="18e2" class="mu lt iq mq b gy mz mw l mx my"># Convert the model output to a dictionary<br/>input_polarity = doc._.polarity<br/>sentiment = {<br/>    'score': input_polarity<br/>}<br/>print(sentiment)</span></pre><p id="d15e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们运行这个管道，我们应该得到以下输出:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="5a81" class="mu lt iq mq b gy mv mw l mx my">{'score': 0.85}</span></pre><p id="375f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的模型输出从-1(负面情绪)到 1(正面情绪)的分数。</p><p id="204a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要自己运行这段代码，请查看我的<a class="ae kv" href="https://github.com/rtkilian/data-science-blogging/blob/main/spaCy_sentiment.ipynb" rel="noopener ugc nofollow" target="_blank"> Google Colab 笔记本</a>。</p><h1 id="d7c1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Flask RESTful API 概念回顾</h1><p id="4692" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在我们开始开发情绪分析 Restful API 之前，让我们先回顾一些概念。</p><h2 id="a2ad" class="mu lt iq bd lu na nb dn ly nc nd dp mc lf ne nf me lj ng nh mg ln ni nj mi nk bi translated">烧瓶是什么？</h2><p id="dfb4" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Flask 是一个 Python 微型 web 框架，为您提供开发和构建 web 应用程序所需的工具。“微”指的是 Flask 不像其他框架那样执行特定的库或结构(例如<a class="ae kv" href="https://www.djangoproject.com/" rel="noopener ugc nofollow" target="_blank"> Django </a>)。Flask 的轻量级设计使框架灵活易用，受到熟悉 Python 的数据科学家的欢迎。</p><h2 id="90e6" class="mu lt iq bd lu na nb dn ly nc nd dp mc lf ne nf me lj ng nh mg ln ni nj mi nk bi translated">什么是 API？</h2><p id="86e2" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">应用程序编程接口(API)允许产品和服务基于一组规则相互通信。作为一名数据科学家，你不需要理解一个 API 是如何实现的，但是，你可以使用它的接口与它进行交互。例如，下面是简单 API 的列表:</p><ul class=""><li id="28f1" class="nl nm iq ky b kz la lc ld lf nn lj no ln np lr nq nr ns nt bi translated"><a class="ae kv" href="https://api.cryptonator.com/api/ticker/btc-usd" rel="noopener ugc nofollow" target="_blank">cryptanator</a>:加密货币汇率</li><li id="2a2c" class="nl nm iq ky b kz nu lc nv lf nw lj nx ln ny lr nq nr ns nt bi translated"><a class="ae kv" href="https://open-meteo.com/en" rel="noopener ugc nofollow" target="_blank">开放式气象</a>:天气预报</li><li id="b6dc" class="nl nm iq ky b kz nu lc nv lf nw lj nx ln ny lr nq nr ns nt bi translated"><a class="ae kv" href="https://icanhazdadjoke.com/" rel="noopener ugc nofollow" target="_blank">icanhazdaddjoke</a>:随机老爸笑话</li></ul><h2 id="ceb1" class="mu lt iq bd lu na nb dn ly nc nd dp mc lf ne nf me lj ng nh mg ln ni nj mi nk bi translated">什么是 RESTful API？</h2><p id="9ec6" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">REST 代表<strong class="ky ir"> RE </strong>表象<strong class="ky ir"> S </strong>状态<strong class="ky ir"> T </strong>转移。当一个 API 在开发时考虑了特定的约束，它就是 RESTful 的。这些约束使得其他人更容易使用您的 API 并与之通信。</p><p id="757a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在 REST 架构中，客户端(例如您的浏览器)请求在服务器上创建、读取、更新或删除(也称为“CRUD”)数据。然后，服务器将根据您的请求做出响应。</p><h1 id="6d53" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">一个简单的使用 Flask 的“Hello World”API</h1><p id="c8b2" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们将从开发一个简单的 API 来演示 Flask 的主要构件开始。</p><p id="c30d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nz">注意:我建议你使用 Python IDE 或者代码编辑器，比如</em> <a class="ae kv" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> <em class="nz"> Visual Studio 代码</em> </a> <em class="nz">，来编写你的脚本。我的应用程序是在 Windows 机器上开发的，因此您的命令可能在 Unix 或 macOS 上有所不同。</em></p><h2 id="8c77" class="mu lt iq bd lu na nb dn ly nc nd dp mc lf ne nf me lj ng nh mg ln ni nj mi nk bi translated">虚拟环境和安装库</h2><p id="c818" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">使用终端，在名为<strong class="ky ir"> flask-hello-world </strong>的新目录中创建一个名为<strong class="ky ir"> env </strong>的虚拟环境:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="a997" class="mu lt iq mq b gy mv mw l mx my">$ py -m venv env</span></pre><p id="7e6e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nz">如果你在 Unix 或 macOS 上，命令是:</em></p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="cdae" class="mu lt iq mq b gy mv mw l mx my">$ python3 -m venv env</span></pre><p id="7669" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们开始安装 Flask 和我们需要的其他库之前，激活您的虚拟环境:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="9b41" class="mu lt iq mq b gy mv mw l mx my">$ .\env\Scripts\activate</span></pre><p id="ca01" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nz">如果你在 Unix 或 macOS 上，命令是:</em></p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="452d" class="mu lt iq mq b gy mv mw l mx my">$ source env/bin/activate</span></pre><p id="b5a3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们安装<a class="ae kv" href="https://flask.palletsprojects.com/en/2.0.x/installation/" rel="noopener ugc nofollow" target="_blank">烧瓶</a>和<a class="ae kv" href="https://flask-restful.readthedocs.io/en/latest/installation.html" rel="noopener ugc nofollow" target="_blank">烧瓶-RESTful </a>:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="7b16" class="mu lt iq mq b gy mv mw l mx my">$ pip install Flask<br/>$ pip install flask-restful</span></pre><p id="42c8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，让我们为我们的服务器安装<a class="ae kv" href="https://pypi.org/project/gunicorn/" rel="noopener ugc nofollow" target="_blank"> gunicorn </a>:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="8a7c" class="mu lt iq mq b gy mv mw l mx my">$ pip install gunicorn</span></pre><h2 id="f32d" class="mu lt iq bd lu na nb dn ly nc nd dp mc lf ne nf me lj ng nh mg ln ni nj mi nk bi translated">编写我们的 app.py</h2><p id="c725" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">一切都设置好了，我们可以进入我们的<strong class="ky ir"> app.py </strong>文件了。从导入 Flask 和 Flask-RESTful 开始:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="9eaa" class="mu lt iq mq b gy mv mw l mx my">from flask import Flask<br/>from flask_restful import Resource, Api</span></pre><p id="dd93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们初始化 Flask 应用程序，并将其指定为 API:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="004f" class="mu lt iq mq b gy mv mw l mx my">app = Flask(__name__)<br/>api = Api(app)</span></pre><p id="e466" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Flask-RESTful 提供了称为资源的构建块，允许我们访问 POST、GET、PUT 和 DELETE 等 HTTP 方法。这些分别对应于我们的创建、读取、更新和删除(CRUD)操作。让我们定义一个简单的 GET 路线:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="14ac" class="mu lt iq mq b gy mv mw l mx my">class HelloWorld(Resource):<br/>    def get(self):<br/>        return {'hello': 'world'}</span></pre><p id="acb3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当需要创建我们的情绪分析应用程序时，我们将返回到这段代码，并根据需要进行调整。</p><p id="6b1a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们将 URL 为“/”的 HelloWorld 资源添加到我们的 API:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="38f9" class="mu lt iq mq b gy mv mw l mx my">api.add_resource(HelloWorld, '/')</span></pre><p id="1b7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，如果当前文件名与主文件名相同，我们希望运行应用程序。我们还在调试模式下运行，部署时将关闭该模式:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="7217" class="mu lt iq mq b gy mv mw l mx my">if __name__ == '__main__':<br/>    app.run(debug=True)</span></pre><p id="895c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你一直跟随，你的<strong class="ky ir"> app.py </strong>应该看起来像这样:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="af67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了启动我们的简单 web 应用程序，我们在终端中运行我们的<strong class="ky ir"> app.py </strong>文件:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="1460" class="mu lt iq mq b gy mv mw l mx my">$ python app.py</span></pre><p id="c08e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切按计划进行，您应该会在终端中看到以下消息:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/928975c7df1ccb1ae492bdebb4196271.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6GrIsExWh2Y2TYoPJam-zw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="c797" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了测试我们的 API，我们有几个不同的选项。最简单的方法是在新的终端窗口中使用 curl，方法是使用以下命令:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="f460" class="mu lt iq mq b gy mv mw l mx my">$ curl http://127.0.0.1:5000/</span></pre><p id="78e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您应该得到以下输出:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="5cf7" class="mu lt iq mq b gy mv mw l mx my">{<br/>    "hello": "world"<br/>}</span></pre><p id="87a3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">或者，您可以使用类似于<a class="ae kv" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>的工具，它是为构建和测试 API 而设计的。例如，下图展示了对我们的服务器的 GET 请求以及我们收到的响应。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/fe97b0ecc6f04beac8bf209f714fbe90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LjSyF4eoNTJj0ABlvCDwgA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="2e32" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，您可以使用 Python <a class="ae kv" href="https://docs.python-requests.org/en/latest/" rel="noopener ugc nofollow" target="_blank"> Requests </a>库来发送 HTTP 请求。然而，本教程没有涵盖请求库，我鼓励您阅读文档。</p><p id="7e1e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就是这样！至此，您应该已经运行了第一个“hello world”Flask API。作为参考，你可以在这个<a class="ae kv" href="https://github.com/rtkilian/flask-hello-world" rel="noopener ugc nofollow" target="_blank"> GitHub 库</a>里找到我所有的代码。</p><h1 id="c1db" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">用 spaCy 为我们的 API 添加情感分析</h1><p id="4a1f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在我们的 spaCy 情感分析器笔记本和“hello world”Flask API 之间，你应该拥有创建情感分析 API 所需的一切。</p><p id="7559" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先创建一个新的目录(我的目录名为<strong class="ky ir">情绪分析器 yelpcamp </strong>)，设置你的虚拟环境并安装你需要的库。不要忘记包括 spaCy 和 spaCyTextBlob:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="6a0b" class="mu lt iq mq b gy mv mw l mx my">$ pip install -U pip setuptools wheel<br/>$ pip install -U spacy<br/>$ python -m spacy download en_core_web_sm<br/>$ pip install spacytextblob</span></pre><p id="c63b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们通过导入和初始化我们的库来开始我们的<strong class="ky ir"> app.py </strong>文件:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="3dd9" class="mu lt iq mq b gy mv mw l mx my">from flask import Flask, request<br/>from flask_restful import Resource, Api, reqparse</span><span id="1518" class="mu lt iq mq b gy mz mw l mx my">import spacy<br/>from spacytextblob.spacytextblob import SpacyTextBlob</span><span id="1067" class="mu lt iq mq b gy mz mw l mx my">nlp = spacy.load('en_core_web_sm')<br/>nlp.add_pipe('spacytextblob')</span><span id="73b2" class="mu lt iq mq b gy mz mw l mx my">app = Flask(__name__)<br/>api = Api(app)</span></pre><p id="c974" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可能会注意到，我们正在从 Flask-RESTful 导入<a class="ae kv" href="https://flask-restful.readthedocs.io/en/latest/api.html#module-reqparse" rel="noopener ugc nofollow" target="_blank"> reqparse </a>模块。reqparse 模块简化了表单验证，允许我们在将用户输入传递到我们的情感分析模型之前检查它。</p><p id="fef7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的 API 将被部署到我的网站<a class="ae kv" href="https://github.com/rtkilian/YelpCamp" rel="noopener ugc nofollow" target="_blank"> YelpCamp </a>，对露营地评论的情绪进行分类。我将设置 reqparse 来检查表单(或来自 Postman 等工具的请求)是否包含名为“review”的字段:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="ba96" class="mu lt iq mq b gy mv mw l mx my">parser = reqparse.RequestParser()<br/>parser.add_argument('review', required=True,<br/>                    help='Review cannot be blank!')</span></pre><p id="a870" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们定义一个 POST route，它从请求正文中提取“review”字段，通过<code class="fe oe of og mq b">nlp</code>对象将其转换为 spaCy <code class="fe oe of og mq b">Doc</code>对象，并使用 spaCyTextBlob 提取情感分数:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="2fd8" class="mu lt iq mq b gy mv mw l mx my">class PredictSentiment(Resource):<br/>    def post(self):<br/>        args = parser.parse_args()<br/>        review = args['review']<br/>        doc = nlp(review)<br/>        score = doc._.polarity<br/>        return {'score': score}</span></pre><p id="3a0b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们将 URL 为'/predict '的<code class="fe oe of og mq b">PredictSentiment</code>资源添加到我们的 API 中:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="25d7" class="mu lt iq mq b gy mv mw l mx my">api.add_resource(PredictSentiment, '/predict')</span></pre><p id="a2c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，如果当前文件名与主文件名相同，我们希望运行应用程序。然而，这一次我们没有在调试模式下运行我们的 API，因为在下一步我们将把我们的应用程序部署到 Heroku。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="5731" class="mu lt iq mq b gy mv mw l mx my">if __name__ == '__main__':<br/>    app.run()</span></pre><p id="6256" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦完成，你的<strong class="ky ir"> app.py </strong>应该看起来像这样:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="bba9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在可以启动我们的 Flask 应用程序，并使用 Postman 测试我们的 API，看看我们是否收到了预期的响应。这一次，我们将向“http://127.0.0.1:5000/predict”发出发布请求，并在请求正文中包含“review ”:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/e0492c4372652eaf3b9e5793bb188d69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lmogdhIHsn4Ei3atRIVThg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="a020" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的模型以 JSON 响应，表明情绪得分为 0.60(在-1 到 1 的范围内)，这意味着我们的评论情绪非常积极。</p><p id="9e3c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们的 API 已经在本地环境中运行了，我们可以将应用程序部署到 Heroku。</p><p id="b755" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作为参考，您可以在我的<a class="ae kv" href="https://github.com/rtkilian/sentiment-analyser-yelpcamp" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上访问我的代码。</p><h1 id="09eb" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">将 API 部署到 Heroku</h1><p id="bd12" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在您的应用程序目录中，添加一个名为<strong class="ky ir"> Procfile </strong>的文件，并包含以下内容:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="340f" class="mu lt iq mq b gy mv mw l mx my">web: gunicorn app:app</span></pre><p id="85ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据 Heroku <a class="ae kv" href="https://devcenter.heroku.com/articles/procfile" rel="noopener ugc nofollow" target="_blank">文档</a>，Procfile“指定了应用程序在启动时执行的命令”。</p><p id="c8ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还需要创建一个包含在我们目录中的<strong class="ky ir"> requirements.txt </strong>文件:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="b2d3" class="mu lt iq mq b gy mv mw l mx my">pip freeze &gt; requirements.txt</span></pre><p id="c6c8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们将应用程序部署到 Heroku 之前，我们将初始化一个 Git 存储库:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="457f" class="mu lt iq mq b gy mv mw l mx my">$ git init</span></pre><p id="b025" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，我们不想在我们的虚拟环境中包含所有的包，所以我们将创建一个<strong class="ky ir">。gitignore </strong>包含以下内容:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="8290" class="mu lt iq mq b gy mv mw l mx my">env/<br/>__pycache__/</span></pre><p id="139b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们可以添加应用程序文件并提交我们的更改:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="dfc2" class="mu lt iq mq b gy mv mw l mx my">$ git add .gitignore app.py requirements.txt Procfile<br/>$ git commit -m "Initialize Git repository"</span></pre><p id="0d7b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您应该有一个类似于<a class="ae kv" href="https://github.com/rtkilian/sentiment-analyser-yelpcamp" rel="noopener ugc nofollow" target="_blank">矿</a>的目录。</p><p id="27c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要将我们的 API 部署到 Heroku，您需要注册一个免费的 Heroku 帐户，并安装<a class="ae kv" href="https://devcenter.heroku.com/articles/getting-started-with-python#set-up" rel="noopener ugc nofollow" target="_blank"> Heroku CLI </a>。之后，您可以使用终端登录 Heroku CLI:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="952a" class="mu lt iq mq b gy mv mw l mx my">$ heroku login</span></pre><p id="6e95" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在要将我们的代码链接到 Heroku 服务器，这可以通过 Git <a class="ae kv" href="https://git-scm.com/book/en/v2/Git-Basics-Working-with-Remotes" rel="noopener ugc nofollow" target="_blank"> remote </a>来实现。这可以通过从 CLI 运行以下命令来实现，该命令将创建一个 Heroku 应用程序:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="8d74" class="mu lt iq mq b gy mv mw l mx my">$ heroku create</span></pre><p id="e08e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们将代码推送到触发构建过程的 Git 远程存储库。运行以下命令后，您将看到关于部署过程的信息，并且(希望)在完成后会看到一条成功消息:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="6985" class="mu lt iq mq b gy mv mw l mx my">$ git push heroku main</span></pre><p id="13b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你成功了！输出将显示您的 API 的 URL(我的是<a class="ae kv" href="https://sentiment-analyser-yelpcamp.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">https://sentiment-analyser-yelpcamp.herokuapp.com/</a>)。或者，您可以通过 Heroku 仪表盘访问该应用程序，网址为:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/187077fb216f7311995a691e6b4e617b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fxiNte2MwpvLkWuCJui9ag.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="4ee8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了测试我们的 API 是否已经正确部署，我们可以使用 Postman。使用相同的检查，我们从部署的 API 得到与在本地机器上相同的响应。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/5c82306eb282a928530194fcf865f1ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*He73_4iodIAOSfG1kswabA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="d7c9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">(奖励)将 API 与现有的 web 应用程序集成</h1><p id="a8e2" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">大多数情况下，对于您构建的 API，您会有一个特定的用例。您可能希望在一些批量 ETL 处理作业中调用 API，或者在<a class="ae kv" href="https://streamlit.io/" rel="noopener ugc nofollow" target="_blank"> Streamlit </a>上演示一个原型。在我的例子中，我的目标是对我的网站 YelpCamp 上露营地评论的情绪进行分类。</p><p id="4c72" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">YelpCamp 是用 NodeJS 开发的。因此，我使用<a class="ae kv" href="https://github.com/axios/axios" rel="noopener ugc nofollow" target="_blank"> Axios </a>库来调用我的 API，传递评论体并返回存储在<a class="ae kv" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>中的情感评分。下面的代码演示了这个过程，但是，解释超出了本教程的范围:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h1 id="9120" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="7117" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">通过学习本教程，您现在应该了解了:</p><ul class=""><li id="bf00" class="nl nm iq ky b kz la lc ld lf nn lj no ln np lr nq nr ns nt bi translated">利用 spaCy 和 spaCyTextBlob 进行文本情感分类</li><li id="42fd" class="nl nm iq ky b kz nu lc nv lf nw lj nx ln ny lr nq nr ns nt bi translated">用 Flask 和 Flask-RESTful 开发一个简单的 REST API</li><li id="d9fb" class="nl nm iq ky b kz nu lc nv lf nw lj nx ln ny lr nq nr ns nt bi translated">将您的应用程序部署到 Heroku</li></ul><p id="c5ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您开发的模型不再需要保存在本地的 Jupyter 笔记本中。使用本教程作为指南，并开始与世界分享您的模型。</p><p id="6717" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你有什么问题吗？<a class="ae kv" href="https://twitter.com/rtkilian" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir">推我</strong> </a>或者在<a class="ae kv" href="https://www.linkedin.com/in/rtkilian/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> LinkedIn </strong> </a>上加我。</p><p id="cdde" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以在<a class="ae kv" href="https://github.com/rtkilian/sentiment-analyser-yelpcamp" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> GitHub </strong> </a>上找到这篇文章中用到的所有代码。</p></div></div>    
</body>
</html>