<html>
<head>
<title>Connecting two discrete VNets using VNet peering and ARM Templates</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用虚拟网络对等和ARM模板连接两个分立虚拟网络</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/connecting-two-discrete-vnets-using-vnet-peering-and-arm-templates-c33a96812d9c?source=collection_archive---------33-----------------------#2021-09-22">https://towardsdatascience.com/connecting-two-discrete-vnets-using-vnet-peering-and-arm-templates-c33a96812d9c?source=collection_archive---------33-----------------------#2021-09-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6d7b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用VNet对等和Azure ARM模板从我们的代码构建基础设施</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e311cb91e9443b3ad05fafb1bd884f58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8jMFzunn7XGSehe9FHYBKw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/s/photos/connection?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@othentikisra?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> israel palacio </a>拍摄</p></figure><h1 id="514e" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">动机:</h1><p id="3375" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果操作不当，连接虚拟网络有时可能会很麻烦。一次又一次地创建它，会更容易出错。因此，我们将利用来自Azure的名为Azure ARM Templates的服务，以幂等的方式部署我们的基础设施。我们也将只为一些任务使用门户网站，但它的大部分将从模板完成。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="fd6e" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">建筑:</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/fbc4160c95b201a66cdadb2b8907d10f.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*iky4GCfqRM6PGR0sU6a5Fg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">苏拉布什雷斯塔。使用VNet对等和ARM模板连接两个分立的VNet 1。2021.JPEG文件。</p></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="5883" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">先决条件:</h1><ol class=""><li id="5a1f" class="na nb it lt b lu lv lx ly ma nc me nd mi ne mm nf ng nh ni bi translated">Azure帐户</li><li id="9a88" class="na nb it lt b lu nj lx nk ma nl me nm mi nn mm nf ng nh ni bi translated">Azure虚拟机</li><li id="cc58" class="na nb it lt b lu nj lx nk ma nl me nm mi nn mm nf ng nh ni bi translated">Azure VNet</li><li id="1e66" class="na nb it lt b lu nj lx nk ma nl me nm mi nn mm nf ng nh ni bi translated">ARM模板</li></ol></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="9e90" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">Azure虚拟网络:</h1><p id="5b97" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Azure虚拟网络是Azure在云中的网络。这个虚拟网络可以细分成不同的子网。在本练习中，我们将创建两个虚拟网络:东和西，每个虚拟机有两个子网，其中东VNET仅限于私有IP，西可以访问公共IP，如上图所示。稍后，我们将使用VNet对等来连接不同地区的这两个不同的VNet。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="3e18" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">ARM模板:</h1><p id="86eb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">ARM模板是以JSON形式编写基础设施以获得最大可用性的幂等方法。创建虚拟机、虚拟网络和子网是一个非常漫长的过程，我们在创建过程中可能会出现错误，因此，ARM模板是首选。我已经创建了ARM模板，并且在我的<a class="ae ky" href="https://github.com/codexponent/oss-vnet-peering" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上。但是不要担心，我会教你如何编写ARM模板，更重要的是生成它们，因为从头开始编写非常困难。</p><p id="1ba8" class="pw-post-body-paragraph lr ls it lt b lu no ju lw lx np jx lz ma nq mc md me nr mg mh mi ns mk ml mm im bi translated">假设我已经创建了一些基础设施，我想为它创建一个ARM模板。进入<strong class="lt iu">资源组，</strong>选择<strong class="lt iu">资源，</strong>和<strong class="lt iu">导出模板。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/73a39440e58cbeeb07da96d8177c39a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6iKOihTqscmJtNdlKb1tjQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">苏拉布什雷斯塔。使用VNet对等和ARM模板连接两个分立的VNet 2。2021.JPEG文件。</p></figure><p id="cd0f" class="pw-post-body-paragraph lr ls it lt b lu no ju lw lx np jx lz ma nq mc md me nr mg mh mi ns mk ml mm im bi translated">然后点击<strong class="lt iu">下载</strong>按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/2c9682145ea9310c280b19d4ed7e485d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kX4SK8LDiD0MWt_15jHBVg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">苏拉布什雷斯塔。使用VNet对等和ARM模板连接两个分立的VNet 3。2021.JPEG文件。</p></figure><p id="d10d" class="pw-post-body-paragraph lr ls it lt b lu no ju lw lx np jx lz ma nq mc md me nr mg mh mi ns mk ml mm im bi translated">您将获得template.json和parameter.json。template . JSON包含您想要使用其详细信息创建的基础结构，parameter . JSON包含您想要为资源指定的唯一名称。在这篇文章中，我将添加我自己的默认值。您可以通过parameter.json添加唯一的名称，并输入下面给出的命令。</p><p id="245e" class="pw-post-body-paragraph lr ls it lt b lu no ju lw lx np jx lz ma nq mc md me nr mg mh mi ns mk ml mm im bi translated">在您使用CLI执行命令后，它可能无法运行，因为您必须对JSON文件进行一些整理，比如删除订阅id以实现动态可用性，还需要删除不必要的键值对。对于这篇文章，你不必担心，因为我提供的JSON已经发挥到了极致。打开代码后，这里是您需要线性输入的命令。</p><pre class="kj kk kl km gt nv nw nx ny aw nz bi"><span id="06dc" class="oa la it nw b gy ob oc l od oe">az group create --name oss-east-rg --location eastus</span><span id="07a1" class="oa la it nw b gy of oc l od oe">az group create --name oss-west-rg --location westus</span><span id="f27c" class="oa la it nw b gy of oc l od oe">az deployment group create --resource-group oss-east-rg --template-file template.json</span><span id="2873" class="oa la it nw b gy of oc l od oe">az deployment group create --resource-group oss-west-rg --template-file template.json</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="c149" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">虚拟网络对等:</h1><p id="7894" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们将使用一个门户来对等这两个虚拟网络。进入东方虚拟网络，<strong class="lt iu">设置，peering</strong>和<strong class="lt iu"> +Add </strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/d9a3cd31a694834766696192542e3549.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cO9XePleZW-zlDLQ7yIbxA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">苏拉布什雷斯塔。使用VNet对等和ARM模板连接两个分立的VNet 4。2021.JPEG文件。</p></figure><p id="d02d" class="pw-post-body-paragraph lr ls it lt b lu no ju lw lx np jx lz ma nq mc md me nr mg mh mi ns mk ml mm im bi translated">我们应该记住，我们连接的是东到西，但也是西到东，所以有两个空白的<strong class="lt iu">对等链接名称。</strong>填写基本信息，点击<strong class="lt iu">添加。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/99f287b2db0fc3980f89afae65bf065a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CgYKQKjJbuHWQm3kdE_mTw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">苏拉布什雷斯塔。使用VNet对等和ARM模板连接两个分立的VNet 5。2021.JPEG文件。</p></figure><h1 id="b0a4" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">演示:</h1><p id="718a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，让我们连接到具有公共IP地址(west)的虚拟机，然后使用不同VNet上的私有IP地址连接到east。我已经在存储库中提供了PEM文件。先从西VM说起。</p><pre class="kj kk kl km gt nv nw nx ny aw nz bi"><span id="acb2" class="oa la it nw b gy ob oc l od oe">sudo ssh -i vm.pem azureuser@104.40.10.98</span></pre><p id="dc89" class="pw-post-body-paragraph lr ls it lt b lu no ju lw lx np jx lz ma nq mc md me nr mg mh mi ns mk ml mm im bi translated">已经建立了连接。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/5b2dea9ac38e4fc92977018f7c33ef2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FjZsDtHGSSmM7VmWo6QylQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">苏拉布什雷斯塔。使用VNet对等和ARM模板连接两个分立的VNet 6。2021.JPEG文件。</p></figure><p id="266b" class="pw-post-body-paragraph lr ls it lt b lu no ju lw lx np jx lz ma nq mc md me nr mg mh mi ns mk ml mm im bi translated">现在，让我们使用私有IP连接到东部虚拟机。记得将PEM文件复制到虚拟机本身。</p><pre class="kj kk kl km gt nv nw nx ny aw nz bi"><span id="d6ab" class="oa la it nw b gy ob oc l od oe">sudo ssh -i vm.pem azureuser@10.0.0.4</span></pre><p id="0b86" class="pw-post-body-paragraph lr ls it lt b lu no ju lw lx np jx lz ma nq mc md me nr mg mh mi ns mk ml mm im bi translated">再次建立了连接。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/cafbde6eb470e9689de83b08698bf867.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*twufYulEQjmot7aI5A6rtg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">苏拉布什雷斯塔。使用VNet对等和ARM模板连接两个分立的VNet 7。2021.JPEG文件。</p></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="5f6c" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">结论:</h1><p id="5c65" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们展示了如何利用Azure ARM模板轻松创建复杂的基础设施。这只是最低限度，因为我们可以向ARM模板添加越来越多的内容。还有其他工具，如Terraform和Pulumi，我们可以利用它们以声明和命令的方式编写IaC代码。可能性是无限的，选择是无限的，你想做什么取决于你自己。如果你遇到任何问题或难以遵循这些步骤，请在下面评论这篇文章或在tsulabh4@gmail.com给我发消息。也可以在<a class="ae ky" href="https://www.linkedin.com/in/sulabhshrestha/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>和<a class="ae ky" href="https://github.com/codexponent" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上和我联系。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="214f" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">资源:</h1><p id="4eee" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">[1] Azure虚拟网络:<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/Azure/Virtual-Network/Virtual-networks-overview</a></p><p id="fcfa" class="pw-post-body-paragraph lr ls it lt b lu no ju lw lx np jx lz ma nq mc md me nr mg mh mi ns mk ml mm im bi translated">[2] ARM模板:<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/azure-resource-manager/templates/overview</a></p></div></div>    
</body>
</html>