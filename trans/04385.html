<html>
<head>
<title>Optimizing the Price-Performance Ratio of a Serverless Inference Service with Amazon SageMaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Amazon SageMaker优化无服务器推理服务的性价比</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/optimizing-the-price-performance-ratio-of-a-serverless-inference-service-with-amazon-sagemaker-5969688a2074?source=collection_archive---------44-----------------------#2021-04-13">https://towardsdatascience.com/optimizing-the-price-performance-ratio-of-a-serverless-inference-service-with-amazon-sagemaker-5969688a2074?source=collection_archive---------44-----------------------#2021-04-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="770b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用SageMaker超参数调整和Locust为AWS Lambda推理寻找最佳设置</h2></div><p id="41bf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我最近发表了一篇关于使用Amazon SageMaker Pipelines、Amazon API Gateway和AWS Lambda进行无服务器模型部署的分步指南。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/45c351398fe2ba59c58830e0c499d63e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R1tv3hxtGZS1nhmi0PRRqw.jpeg"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated"><a class="ae lb" href="https://unsplash.com/@pineapple?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">菠萝供应公司</a>在<a class="ae lb" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="400f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了AWS Lambda ，你只需为你使用的东西付费。Lambda根据请求数量、执行持续时间和分配给函数的内存量收费。那么你应该给你的推理函数分配多少内存呢？</p><p id="c90a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇文章中，我将展示如何使用<a class="ae lb" href="https://docs.aws.amazon.com/sagemaker/latest/dg/automatic-model-tuning.html" rel="noopener ugc nofollow" target="_blank"> SageMaker超参数调优</a> (HPO)作业和一个负载测试工具来自动优化无服务器推理服务的性价比。</p><p id="7dcc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将重用XGBoost模型二进制和Lambda推理容器，就像我在上一篇文章中所做的那样。我们将指定一个Lambda内存范围，并让SageMaker根据延迟-内存总得分找到最佳值。SageMaker将运行许多作业，每个作业都创建一个推理服务，对其进行负载测试，并返回分数进行优化。我们将使用<a class="ae lb" href="https://github.com/locustio/locust" rel="noopener ugc nofollow" target="_blank"> Locust </a>和<a class="ae lb" href="https://github.com/FutureSharks/invokust" rel="noopener ugc nofollow" target="_blank"> Invokust </a>包装器从SageMaker作业中加载测试。</p><h1 id="e9d4" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">演练概述</h1><p id="3511" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">我们将通过3个步骤找到Lambda的最佳内存分配:</p><ul class=""><li id="e4aa" class="mp mq iq kh b ki kj kl km ko mr ks ms kw mt la mu mv mw mx bi translated">我们将首先使用<a class="ae lb" href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html" rel="noopener ugc nofollow" target="_blank"> Boto3 </a>从SageMaker训练作业中创建和删除推理服务。</li><li id="e0f1" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la mu mv mw mx bi translated">然后，我们将使用Invokust对服务进行负载测试，并为性价比生成一个总得分。</li><li id="8202" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la mu mv mw mx bi translated">最后，我将展示如何启动SageMaker HPO作业来自动找到最佳内存值。</li></ul><h1 id="91c0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">先决条件</h1><p id="1974" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">要浏览此示例，请确保您具备以下条件:</p><ol class=""><li id="953a" class="mp mq iq kh b ki kj kl km ko mr ks ms kw mt la nd mv mw mx bi translated">对于无服务器推理服务，我们将重用我上一篇文章中的容器和二进制模型。开始之前，请确保您熟悉本例中的。</li><li id="fdd9" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la nd mv mw mx bi translated">熟悉SageMaker <a class="ae lb" href="https://docs.aws.amazon.com/sagemaker/latest/dg/automatic-model-tuning.html" rel="noopener ugc nofollow" target="_blank">超参数优化</a> (HPO)岗位。</li><li id="17de" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la nd mv mw mx bi translated">使用<a class="ae lb" href="https://www.youtube.com/watch?v=wiDHCWVrjCU" rel="noopener ugc nofollow" target="_blank">工作室</a>，一个<a class="ae lb" href="https://www.youtube.com/watch?v=X5CLunIzj3U" rel="noopener ugc nofollow" target="_blank">笔记本实例</a>，或者从你的笔记本电脑访问SageMaker环境。</li><li id="8b44" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la nd mv mw mx bi translated">将这个<a class="ae lb" href="https://github.com/SofianHamiti/amazon-sagemaker-hpo-aws-lambda-locust" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>克隆到您的环境中来遵循这些步骤。</li></ol></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="be38" class="ls lt iq bd lu lv nl lx ly lz nm mb mc jw nn jx me jz no ka mg kc np kd mi mj bi translated">步骤1:使用Boto3从SageMaker培训作业中创建和删除推理服务</h1><p id="103e" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">首先，我们将使用Boto3创建基于API Gateway和AWS Lambda的简单推理服务。每个SageMaker培训作业将通过创建一个服务开始，然后在结束前删除它。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nq"><img src="../Images/b532d0db20462bd7c008d721c3c6c439.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wi-TjCRurHWsn3Ev_DrZhQ.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片:无服务器推理服务视图</p></figure><p id="539f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于训练作业，我们将使用PyTorch估计器和来自<a class="ae lb" href="https://github.com/SofianHamiti/amazon-sagemaker-hpo-aws-lambda-locust/tree/main/source_dir" rel="noopener ugc nofollow" target="_blank"> source_dir </a>文件夹的脚本。这里我们对使用提供的容器比框架本身更感兴趣。</p><p id="8052" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">容器入口点是<a class="ae lb" href="https://github.com/SofianHamiti/amazon-sagemaker-hpo-aws-lambda-locust/blob/main/source_dir/entry_point.py" rel="noopener ugc nofollow" target="_blank"> entry_point.py </a>，你可以在<a class="ae lb" href="https://github.com/SofianHamiti/amazon-sagemaker-hpo-aws-lambda-locust/tree/main/source_dir/stack" rel="noopener ugc nofollow" target="_blank">栈文件夹</a>下找到boto3脚本。</p><h2 id="73d8" class="nr lt iq bd lu ns nt dn ly nu nv dp mc ko nw nx me ks ny nz mg kw oa ob mi oc bi translated">用Boto3创建Lambda函数</h2><p id="aebb" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">我们将使用<a class="ae lb" href="https://github.com/SofianHamiti/amazon-sagemaker-hpo-aws-lambda-locust/blob/main/source_dir/stack/api_gateway.py" rel="noopener ugc nofollow" target="_blank"> ApiGateway </a>和<a class="ae lb" href="https://github.com/SofianHamiti/amazon-sagemaker-hpo-aws-lambda-locust/blob/main/source_dir/stack/lambda_function.py" rel="noopener ugc nofollow" target="_blank"> LambdaFunction </a>类来创建服务。</p><p id="4cde" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是带有简单创建和删除函数的LambdaFunction类:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="04f8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Lambda函数的关键参数是:</p><ul class=""><li id="b4f4" class="mp mq iq kh b ki kj kl km ko mr ks ms kw mt la mu mv mw mx bi translated">容器:包含推理代码的容器图像URI。</li><li id="5f5b" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la mu mv mw mx bi translated">model _ S3 _ uri:S3的模型二进制位置。</li><li id="e710" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la mu mv mw mx bi translated">内存:分配给函数的内存。它根据SageMaker HPO的输入而变化。</li><li id="55a2" class="mp mq iq kh b ki my kl mz ko na ks nb kw nc la mu mv mw mx bi translated">role:由函数承担的IAM角色。</li></ul><h1 id="0920" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">步骤2:负载测试推理服务，并给它一个性价比分数</h1><p id="1b58" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">当一个推理服务被创建时，我们的<a class="ae lb" href="https://github.com/SofianHamiti/amazon-sagemaker-hpo-aws-lambda-locust/blob/main/source_dir/entry_point.py" rel="noopener ugc nofollow" target="_blank"> entry_point.py </a>执行一个负载测试来获得它的延迟响应性能。</p><p id="49a1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此我们使用了<a class="ae lb" href="https://github.com/locustio/locust" rel="noopener ugc nofollow" target="_blank"> Locust </a>，这是一个用Python编写的开发人员友好的开源负载测试工具。<a class="ae lb" href="https://github.com/FutureSharks/invokust" rel="noopener ugc nofollow" target="_blank"> Invokust </a>是一个从Python本身运行locust的包装器，不需要使用Locust命令行。它使得从SageMaker培训工作中运行负载测试器变得非常容易。</p><p id="5236" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">SageMaker脚本模式使得通过一个<a class="ae lb" href="https://github.com/SofianHamiti/amazon-sagemaker-hpo-aws-lambda-locust/blob/main/source_dir/requirements.txt" rel="noopener ugc nofollow" target="_blank"> requirements.txt </a>文件安装这些依赖项变得很容易。</p><h2 id="44fc" class="nr lt iq bd lu ns nt dn ly nu nv dp mc ko nw nx me ks ny nz mg kw oa ob mi oc bi translated">使用示例负载创建一个locust API用户</h2><p id="bb39" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">您可以在下面找到一个供Locust使用的用户行为示例:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="9207" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它将向推理服务发送一个示例负载，以便从中获得预测。</p><h2 id="4895" class="nr lt iq bd lu ns nt dn ly nu nv dp mc ko nw nx me ks ny nz mg kw oa ob mi oc bi translated">运行负载测试并对推理服务评分</h2><p id="2149" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">然后，我们使用Invokust模拟1000个用户，100的生成率，负载测试的运行时间为1分钟:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="7b8b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将允许我们收集推理服务的统计数据。特别是，我们希望使用响应时间的第95百分位统计数据作为评估服务性能的关键指标。</p><p id="8a77" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是来自我们入口点的负载测试代码片段:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="5ac3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在第11行中，我们为推理服务计算了一个基本的总分。为了便于说明，我们简单地将Lambda内存和响应时间的第95个百分点相乘，得到一个数字。这是我们将要求SageMaker在HPO工作中尽量减少的数字。</p><p id="4c42" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">根据您的ML项目的延迟和成本要求，随意使用更复杂的评分。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="08be" class="ls lt iq bd lu lv nl lx ly lz nm mb mc jw nn jx me jz no ka mg kc np kd mi mj bi translated">第三步:启动SageMaker HPO工作，寻找最佳性价比</h1><p id="7bae" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">现在我们准备启动我们的SageMaker HPO工作！您可以在下面找到一个示例笔记本，使用我们的代码启动一个示例笔记本:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="1456" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">HPO的工作将使用<a class="ae lb" href="https://docs.aws.amazon.com/sagemaker/latest/dg/automatic-model-tuning-how-it-works.html" rel="noopener ugc nofollow" target="_blank">贝叶斯搜索</a>，并尝试最小化我们推理服务的总得分。这是为了根据我们的XGBoost模型找到一个最佳的延迟-内存(成本)比。</p><h2 id="3e0f" class="nr lt iq bd lu ns nt dn ly nu nv dp mc ko nw nx me ks ny nz mg kw oa ob mi oc bi translated">分析您在HPO工作的结果</h2><p id="5f0f" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">当您的HPO作业结束时，您可以导航到SageMaker控制台并找到它的结果。在<em class="of"> Best training job </em>选项卡下，您可以找到SageMaker找到的最低分数以及您可以在推理服务中使用的相关Lambda内存。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi og"><img src="../Images/fed97a60be06e65f00e860892b5cb6a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cRdMGjuh3-A8k37wTKwaYQ.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片:在我的例子中，300MB似乎是分配给Lambda的一个不错的值</p></figure><p id="f292" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">快速查看该作业的CloudWatch日志，可以发现该推理服务的响应时间为53毫秒:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/e78b436333c6fb01295fb9abac3d9f63.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*BigjzeDdb-yQ7zHDyxBJtQ.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片:查看CloudWatch日志，并根据工作进行评分</p></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="85e4" class="ls lt iq bd lu lv nl lx ly lz nm mb mc jw nn jx me jz no ka mg kc np kd mi mj bi translated">结论</h1><p id="eacc" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">在本文中，我展示了如何使用Amazon SageMaker来优化无服务器推理服务的性价比。在我的<a class="ae lb" rel="noopener" target="_blank" href="/deploying-a-serverless-inference-service-with-amazon-sagemaker-pipelines-2d2f3cc96c39">上一篇关于使用SageMaker管道的无服务器部署的文章</a>中，我给Lambda函数分配了1024MB。通过使用SageMaker HPO，我们自动发现我们可以改为分配300MB，并且仍然可以从服务获得53毫秒的延迟响应。这是3倍的内存分配差异！</p><p id="8ca5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，使用这种模式来优化其他基础设施堆栈怎么样？SageMaker端点，KFServing，其他？请随意分享你的想法。</p></div></div>    
</body>
</html>