<html>
<head>
<title>Profile Memory Consumption of Python functions in a single line of code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在一行代码中分析Python函数的内存消耗</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/profile-memory-consumption-of-python-functions-in-a-single-line-of-code-6403101db419?source=collection_archive---------4-----------------------#2021-06-08">https://towardsdatascience.com/profile-memory-consumption-of-python-functions-in-a-single-line-of-code-6403101db419?source=collection_archive---------4-----------------------#2021-06-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7b0a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用内存分析器模块逐行监控函数的内存使用情况</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/40519f89890e3bd54095156ac505f6bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gBDAfqG8nLnpVhNJx_TmKA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=932180" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/tookapic-1386459/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=932180" rel="noopener ugc nofollow" target="_blank">图卡皮克</a></p></figure><p id="2f42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Python是数据科学社区中的一种流行语言，以其健壮性和大量框架而闻名。Python更喜欢简单而不是复杂，这使得它更受欢迎，但却牺牲了性能。Python程序经常容易出现内存管理问题。</p><p id="e8ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数据科学家使用Python语言在固定的内存限制下处理大量数据。如果代码执行超过RAM限制，可能会出现内存错误，程序执行会终止。一个快速的解决方案是增加内存分配以避免内存管理问题，但这并不总是可行的。</p><h2 id="2956" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">为什么内存分析很重要？</h2><p id="7cd4" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">通常新手不会释放未使用的内存，并不断分配新的变量，这可能会增加内存消耗。当代码被执行时，越来越多的内存被分配。Python自动管理内存，但在执行长Python代码时，它可能无法将内存消耗返回给操作系统。</p><p id="e649" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此需要外部工具来监控内存消耗，这将进一步帮助优化内存。</p><p id="04ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文将讨论监控Python函数内存消耗的内存分析器模块。</p><h1 id="686c" class="mt lw it bd lx mu mv mw ma mx my mz md jz na ka mg kc nb kd mj kf nc kg mm nd bi translated">内存分析器:</h1><p id="4fda" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Memory Profiler是一个开源的Python模块，它在内部使用<code class="fe ne nf ng nh b"><strong class="lb iu">psutil</strong></code> <strong class="lb iu"> </strong>模块，来监控Python函数的内存消耗。它对函数执行逐行的内存消耗分析。</p><h2 id="a53a" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">安装:</h2><p id="0ff0" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">可以使用以下命令从PyPl安装内存分析器:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="de37" class="lv lw it nh b gy nm nn l no np"><strong class="nh iu">pip install -U memory_profiler</strong></span></pre><p id="d187" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并且可以使用导入</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="3752" class="lv lw it nh b gy nm nn l no np"><strong class="nh iu">from memory_profiler import profile</strong></span></pre><h2 id="6156" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">用法:</h2><p id="2314" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">设置好一切之后，使用这个模块来跟踪函数的内存消耗就相当容易了。<code class="fe ne nf ng nh b">@profile</code> decorator可以用在每个需要跟踪的函数之前。这将按照与<a class="ae ky" href="https://pypi.org/project/line-profiler/" rel="noopener ugc nofollow" target="_blank">行分析器</a>相同的方式逐行跟踪内存消耗。</p><p id="f468" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用<code class="fe ne nf ng nh b">@profile</code>修饰所有函数后，用一组特定的参数执行python脚本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="7b9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">绕过<code class="fe ne nf ng nh b">-m memory profiler</code>到Python解释器，执行上面的Python脚本。这将加载memory_profiler模块并逐行打印内存消耗。</p><p id="ebf8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用下面的来执行Python脚本和内存分析器。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="f938" class="lv lw it nh b gy nm nn l no np"><strong class="nh iu">python -m memory_profiler &lt;filename&gt;.py</strong></span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/5a049549d0f7b0b1f9e0a98605f5e895.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*--WZVx_xXuDeyE2slwvmjA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="6a84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">成功执行后，您将得到一个逐行的内存消耗报告，类似于上图。该报告有5列:</p><ul class=""><li id="6ef6" class="nt nu it lb b lc ld lf lg li nv lm nw lq nx lu ny nz oa ob bi translated"><strong class="lb iu">行号</strong>:行号</li><li id="2115" class="nt nu it lb b lc oc lf od li oe lm of lq og lu ny nz oa ob bi translated"><strong class="lb iu">行内容</strong>:各行号处的Python代码</li><li id="efe3" class="nt nu it lb b lc oc lf od li oe lm of lq og lu ny nz oa ob bi translated"><strong class="lb iu">Mem usage</strong>:Python解释器在每次执行该行后的内存使用情况。</li><li id="d5b2" class="nt nu it lb b lc oc lf od li oe lm of lq og lu ny nz oa ob bi translated"><strong class="lb iu">增量</strong>:当前行到最后一行的内存消耗差异。它基本上表示特定Python代码行消耗的内存。</li><li id="3adc" class="nt nu it lb b lc oc lf od li oe lm of lq og lu ny nz oa ob bi translated"><strong class="lb iu">出现次数</strong>:某一行代码被执行的次数。</li></ul><p id="fd15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以跟踪Mem使用情况，以观察Python解释器的总内存占用情况，而可以观察Increment列，以查看特定代码行的内存消耗。通过观察内存使用情况，可以优化内存消耗，从而开发出生产就绪的代码。</p><h1 id="f44f" class="mt lw it bd lx mu mv mw ma mx my mz md jz na ka mg kc nb kd mj kf nc kg mm nd bi translated">结论:</h1><p id="dbbd" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">优化内存消耗与优化Python代码的时间复杂度一样重要。通过优化内存消耗，可以在一定程度上加快执行速度，并避免内存崩溃。</p><p id="9278" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还可以尝试自定义的<code class="fe ne nf ng nh b">@profile</code>装饰器来指定参数的精度。为了更好地理解，请阅读内存分析器模块的<a class="ae ky" href="https://pypi.org/project/memory-profiler/" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="3c87" class="mt lw it bd lx mu mv mw ma mx my mz md jz na ka mg kc nb kd mj kf nc kg mm nd bi translated">参考资料:</h1><p id="e914" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">[1]内存分析器文档:<a class="ae ky" href="https://pypi.org/project/memory-profiler/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/memory-profiler/</a></p></div><div class="ab cl oh oi hx oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="im in io ip iq"><p id="ff83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="oo">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://satyam-kumar.medium.com/membership" rel="noopener"> <em class="oo">中等会员</em> </a> <em class="oo">继续无限制的学习。如果你使用下面的链接，我会收到你的一小部分会员费，不需要你额外付费。</em></p><div class="op oq gp gr or os"><a href="https://satyam-kumar.medium.com/membership" rel="noopener follow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">加入我的推荐链接-萨蒂扬库马尔媒体</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">satyam-kumar.medium.com</p></div></div><div class="pb l"><div class="pc l pd pe pf pb pg ks os"/></div></div></a></div><blockquote class="ph"><p id="e94c" class="pi pj it bd pk pl pm pn po pp pq lu dk translated">感谢您的阅读</p></blockquote></div></div>    
</body>
</html>