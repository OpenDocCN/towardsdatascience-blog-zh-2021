<html>
<head>
<title>Create Interactive Map Applications in R and R Shiny for Exploring Geospatial Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在R and R创建交互式地图应用程序，探索地理空间数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/create-interactive-map-applications-in-r-and-r-shiny-for-exploring-geospatial-data-96b0f9692f0f?source=collection_archive---------0-----------------------#2021-03-28">https://towardsdatascience.com/create-interactive-map-applications-in-r-and-r-shiny-for-exploring-geospatial-data-96b0f9692f0f?source=collection_archive---------0-----------------------#2021-03-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2fba" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用地图进行输入选择的Web应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/07a45b99b5970db409123327edc30e40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*VwwUZPucSPbQdanX8mYmIg.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者制作的动画</p></figure><p id="4018" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">数字所能讲述的重要故事通常与地点有关。地理空间数据(或空间数据，也称为地理数据)是指由地理位置指示或与地理位置相关的任何数据(<a class="ae lu" href="https://www.omnisci.com/learn/geospatial" rel="noopener ugc nofollow" target="_blank"> REF </a>)。地理空间数据将地址、邮政编码或区域等位置信息与和该位置相关联的相应属性信息相结合。</p><p id="ac38" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于大多数人来说，如果不使用地图，很难探索地理空间数据。通过这个应用程序，我们展示了如何使用R and R Shiny创建一个免费的开源(FOSS)解决方案，允许用户与地理空间数据进行交互，并使用交互式地图快速找到他们想要看到的内容。</p><h1 id="b796" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Web应用程序设计</h1><p id="b0a2" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">我们选择使用<a class="ae lu" href="https://ops.fhwa.dot.gov/freight/freight_analysis/faf/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">运费分析框架</strong></a>【FAF】数据进行本次论证。FAF是一个公共数据源，提供各州和主要大都市地区之间所有运输方式的货运流量的估计和预测。</p><p id="5b3c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">与FAF数据相关联的地理信息被定义为区域。在<strong class="la iu">美国大陆地区</strong>总共有129个FAF区，每个区都可以是起点区或终点区。换句话说，有129×129个可能的始发地-目的地区域对组合。</p><p id="93d3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">用户可以浏览他们选择的任何始发地和目的地区域对之间的货运数据。该工具提供了一种直观的方法，用户可以直接从地图上选择一个区域，同时获得区域的位置、大小和边界信息，而不是从129个区域的长列表中选择一个区域。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/ffb7b002c61eca7d9fd3d34eff993d95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CyvMdybY2-Iwj_0N5Vh_dg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">运费分析框架区域(图片由作者提供)</p></figure><p id="c243" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">用户可以通过点击区域直接从地图上选择始发地和目的地区域来选择他们想要查看的数据。他们可以放大、缩小或平移地图来查找感兴趣的区域。</p><p id="8aa3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果单击原点，原点区域的质心将显示为绿色。如果单击目标区域，目标区域的质心将显示为红色。我们将在本文后面解释当选择一个区域时，如何确定区域类型(即起点和终点)。</p><p id="11d6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦选择了始发地和目的地区域，应用程序后端的R脚本将查询FAF数据，并将结果显示为所选始发地-目的地区域对的数据表和图表。</p><p id="a91e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将一步一步地解释这个web应用程序的实现，如下所示:</p><ol class=""><li id="aac5" class="mt mu it la b lb lc le lf lh mv ll mw lp mx lt my mz na nb bi translated">R and R闪亮简介</li><li id="3fc3" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated">布局用户界面(UI)</li><li id="52a7" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated">设置服务器以生成输出</li><li id="d366" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated">免费发布闪亮的应用</li></ol><p id="f1d9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="nh">注:这篇文章的代码和数据可以在</em><a class="ae lu" href="https://github.com/shi093/Map-Freight-Analysis-Framework" rel="noopener ugc nofollow" target="_blank"><em class="nh">this GitHub repo</em></a><em class="nh">找到。</em></p><h1 id="40dd" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">1.R and R闪亮简介</h1><p id="ed96" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">r是一种用于统计计算和图形的语言和环境。R的优势之一是可以很容易地制作出设计良好的出版物质量的情节。(<a class="ae lu" href="https://www.r-project.org/about.html" rel="noopener ugc nofollow" target="_blank">参考</a></p><p id="87c9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Shiny是R的一个web应用程序框架，它结合了R的计算能力和现代web的交互性。Shiny为开发者提供了卓越的能力来创建web应用程序，这些应用程序可以使用你自己的服务器或Shiny的托管服务来部署。</p><h2 id="72cf" class="ni lw it bd lx nj nk dn mb nl nm dp mf lh nn no mh ll np nq mj lp nr ns ml nt bi translated">闪亮应用的结构</h2><p id="dd3c" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">Shiny app是一个目录，包含两个R脚本，即<code class="fe nu nv nw nx b">ui.R</code>和<code class="fe nu nv nw nx b">server.R</code> <em class="nh"> </em>以及其他输入到app的文件。</p><p id="a24a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nu nv nw nx b">ui.R</code>控制应用程序的布局和外观，并在闪亮的应用程序中创建用户界面。它通过接受用户输入并在屏幕上动态显示生成的输出来为应用程序提供交互性。</p><p id="21c9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nu nv nw nx b">server.R</code>包含构建应用程序逻辑的指令，因此它就像是应用程序的大脑。它将用户的输入转换成想要的输出，如表格和图表，显示在屏幕上。</p><p id="b98b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">或者，Shiny app可以由一个名为<code class="fe nu nv nw nx b">app.R</code>的文件组成，该文件包含UI和服务器组件。一个只有一个文件(即<code class="fe nu nv nw nx b">app.R</code>)的闪亮应用的基本结构如下所示:</p><pre class="kj kk kl km gt ny nx nz oa aw ob bi"><span id="b359" class="ni lw it nx b gy oc od l oe of">library(shiny)</span><span id="9efc" class="ni lw it nx b gy og od l oe of">ui &lt;- fluidPage(<br/>  # front end interface<br/>)</span><span id="a415" class="ni lw it nx b gy og od l oe of">server &lt;- function(input, output, session) {<br/>  # back end logic<br/>}</span><span id="ad01" class="ni lw it nx b gy og od l oe of">shinyApp(ui = ui, server = server)</span></pre><p id="fcaa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">保持两个独立的R文件，即<code class="fe nu nv nw nx b">ui.R</code>和<code class="fe nu nv nw nx b">server.R</code> <em class="nh">、</em>通常被认为是一个好的实践，特别是对于较大的应用程序，具有独立的<code class="fe nu nv nw nx b">ui.R</code>和<code class="fe nu nv nw nx b">server.R</code>文件使得代码更容易管理。</p><h1 id="ae3c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">2.布局用户界面(UI)</h1><p id="72e8" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">首先，我们将所有需要的库加载到应用程序中。应用程序界面通常使用<code class="fe nu nv nw nx b">fluidPage</code> <em class="nh"> </em>创建，这样可以确保页面根据每个设备的分辨率动态布局(<a class="ae lu" href="https://www.analyticsvidhya.com/blog/2016/10/creating-interactive-data-visualization-using-shiny-app-in-r-with-examples/" rel="noopener ugc nofollow" target="_blank"> REF </a>)，这样应用程序界面可以在不同屏幕分辨率的不同设备上流畅运行。</p><p id="be84" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们使用<code class="fe nu nv nw nx b">fluidRow</code>和<code class="fe nu nv nw nx b">column</code>从网格系统构建我们的定制布局。行由<code class="fe nu nv nw nx b">fluidRow()</code>函数创建，包括由<code class="fe nu nv nw nx b">column()</code>函数定义的列(<a class="ae lu" href="https://shiny.rstudio.com/articles/layout-guide.html" rel="noopener ugc nofollow" target="_blank"> REF </a>)。</p><p id="9de0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还使用Shiny的HTML标签函数为用户界面添加内容，比如<code class="fe nu nv nw nx b">br, div, span, HTML</code>等。这些功能与常见的HTML5标签相似。</p><p id="a7e0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用<code class="fe nu nv nw nx b">span()</code>函数添加的应用程序“运费分析框架FAF4 vs. FAF5，2017年”的标题显示在界面顶部，后面是一个<code class="fe nu nv nw nx b">fluidRow()</code>，左边是一个名为“Zone”的地图，右边是一组静态(如<code class="fe nu nv nw nx b">span("select")</code>)和动态文本输出(如<code class="fe nu nv nw nx b">htmlOutput("od_info")</code>)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="8605" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">闪亮的应用程序包含输入和输出对象。输入允许用户通过修改他们的值与应用程序交互(我们将在后面讨论输入对象)。输出是显示在应用程序中的对象(<a class="ae lu" href="https://www.paulamoraga.com/book-geospatial/sec-shinyexample.html" rel="noopener ugc nofollow" target="_blank">参考</a>)。输出对象总是与渲染函数配合使用，例如:</p><pre class="kj kk kl km gt ny nx nz oa aw ob bi"><span id="f2ca" class="ni lw it nx b gy oc od l oe of">ui &lt;- fluidPage(<br/>  leafletOutput("Zone")<br/>)</span><span id="2360" class="ni lw it nx b gy og od l oe of">server &lt;- function(input, output, session) {<br/>  output$Zone &lt;- renderLeaflet({<br/>    # generate the map<br/>  })<br/>}</span></pre><p id="b80d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe nu nv nw nx b">ui</code>中我们使用<code class="fe nu nv nw nx b">leafletOutput()</code>，在<code class="fe nu nv nw nx b">server()</code>中我们使用<code class="fe nu nv nw nx b">renderLeaflet()</code>。在<code class="fe nu nv nw nx b">renderLeaflet()</code>中，我们写下返回传单地图的说明。</p><p id="4c9a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此应用程序中显示的输出对象类型包括:</p><p id="d6f3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="nh">活页</em> </strong>用于创建交互式地图，如<code class="fe nu nv nw nx b">leafletOutput("Zone")</code></p><p id="ca66" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="nh"> html </em> </strong>用于将反应输出变量显示为html，如<code class="fe nu nv nw nx b">htmlOutput("od_info")</code></p><p id="4b5c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="nh"> DT </em> </strong>用于显示交互表格中的数据，如<code class="fe nu nv nw nx b">DT:dataTableOutput("od_vol")</code></p><p id="b2f4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="nh"> plotly </em> </strong>用于创建与数据交互的图形，如<code class="fe nu nv nw nx b">plotlyOutput("od_ton_chart”)</code></p><h1 id="d150" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">3.设置服务器以生成输出</h1><h2 id="aee9" class="ni lw it bd lx nj nk dn mb nl nm dp mf lh nn no mh ll np nq mj lp nr ns ml nt bi translated">导入数据文件</h2><p id="484f" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">数据文件与R文件位于相同的位置。我们使用<code class="fe nu nv nw nx b">read.csv()</code>函数读取CSV文件(<code class="fe nu nv nw nx b">centroid.csv</code><code class="fe nu nv nw nx b">od_mode_vol_45.csv</code><em class="nh">)</em>，使用<strong class="la iu"> rgdal </strong>包的<code class="fe nu nv nw nx b">readOGR()</code>函数读取FAF区域的shape file(<code class="fe nu nv nw nx b">faf4_zone2.shp</code>)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="36c1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">区域shapefile中的每个要素都是一个多边形。以下是shapefile中属性数据的示例。表中的每一行都用区域ID、区域名称和几何定义了一个多面要素(即区域)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/19689499d94ac9b52dc157d8117b8e91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OFYHZgaljzpjEobleCVOZQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自faf4_zone2的数据示例(图片由作者提供)</p></figure><p id="f263" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nu nv nw nx b">centroid.csv</code>中的每一行用区域id、区域名称、经度和纬度定义了一个FAF区域质心(即区域的中心位置)。注意<code class="fe nu nv nw nx b">centroid.csv</code>中的区域ID和区域名称与shapefile中的对应。因此，我们可以使用区域ID作为从区域多边形到区域质心的关键字，反之亦然。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/8d9c1cd06acfd4f129eb1bae8d9123f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CEeabIinPC6fBWhBc5g_bw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据示例来自centroid.csv(图片由作者提供)</p></figure><p id="73c0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nu nv nw nx b">od_mode_vol_45.csv</code> <em class="nh"> </em>包含每个始发地-目的地区域对(使用区域id定义)按运输方式(如卡车、铁路、水路、航空等)计算的重量和价值的货运数据。此文件中的数据是从原始的FAF版本5 (FAF5)数据和FAF版本4 (FAF4)数据设计而来的。</p><p id="0cf5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">FAF5数据提供2017年<strong class="la iu"><em class="nh"/></strong>的货运走势预估；而FAF4数据提供了2017年<strong class="la iu"> <em class="nh">的货运预测</em> </strong>。该应用程序比较了每个始发地-目的地对的FAF5与FAF4的2017年数据。</p><p id="4ea5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">文件<code class="fe nu nv nw nx b">od_mode_vol_45.csv</code>中的起点ID和终点ID对应于<code class="fe nu nv nw nx b">centroid.csv</code> <em class="nh"> </em>和<code class="fe nu nv nw nx b">faf4_zone2.shp</code>中的区域ID字段。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/5ccf900e8052c91008362a9468bc054f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L1O0GLrHqBdLnO0Ehdv8lw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据样本来自od_mode_vol_45.csv(图片由作者提供)</p></figure><h2 id="732b" class="ni lw it bd lx nj nk dn mb nl nm dp mf lh nn no mh ll np nq mj lp nr ns ml nt bi translated">使用全局变量来跟踪区域选择</h2><p id="d0de" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">让我们先解决房间里的大象。应用程序需要判断点击(或选择)的区域应该是起始区域还是目标区域。</p><p id="64a1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们假设当用户开始使用应用程序时，第一个点击的区域将是源区域，第二个点击的区域将是目标区域。</p><p id="30d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然而，如果用户希望通过选择另一对始发地和目的地区域来继续使用该应用程序，该怎么办？如果用户在地图上不断点击，不断改变选择怎么办？</p><blockquote class="om on oo"><p id="5b41" class="ky kz nh la b lb lc ju ld le lf jx lg op li lj lk oq lm ln lo or lq lr ls lt im bi translated">为了解决这个问题，我们需要跟踪用户点击地图的总次数。</p></blockquote><p id="e5b6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面的<strong class="la iu">全局变量</strong>用于跟踪用户的区域选择动作。因为我们需要在不同的函数中访问和改变这些变量的值，所以有必要将这些变量定义为全局变量。</p><pre class="kj kk kl km gt ny nx nz oa aw ob bi"><span id="238b" class="ni lw it nx b gy oc od l oe of">click_count &lt;- 0<br/>type &lt;- 0<br/>origin &lt;- ""<br/>dest &lt;- ""<br/>origin_id &lt;- 0<br/>dest_id &lt;- 0</span></pre><ul class=""><li id="3bd2" class="mt mu it la b lb lc le lf lh mv ll mw lp mx lt os mz na nb bi translated">变量<code class="fe nu nv nw nx b">click_count</code>用于跟踪自会话开始以来地图上的累计点击次数。<strong class="la iu"> <em class="nh">注意其初始值设为0 </em> </strong>。</li><li id="a1f0" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt os mz na nb bi translated">变量<code class="fe nu nv nw nx b">type</code>用于将<code class="fe nu nv nw nx b">click_count</code>转换为区域类型，即始发地区域或目的地区域。它的值由模数<code class="fe nu nv nw nx b">click_count</code>乘以2计算得出:</li></ul><pre class="kj kk kl km gt ny nx nz oa aw ob bi"><span id="b85e" class="ni lw it nx b gy oc od l oe of"># with click_count initiated with value 0</span><span id="ebc7" class="ni lw it nx b gy og od l oe of">type &lt;&lt;- click_count%%2</span><span id="49fd" class="ni lw it nx b gy og od l oe of">if (type ==0 ){<br/>  # treat as origin zone<br/>}     <br/>if (type == 1){<br/>  # treat as destination zone<br/>}</span><span id="fedc" class="ni lw it nx b gy og od l oe of"># add one to the accumulative map click counts<br/>click_count &lt;&lt;- click_count+1</span></pre><blockquote class="om on oo"><p id="0a60" class="ky kz nh la b lb lc ju ld le lf jx lg op li lj lk oq lm ln lo or lq lr ls lt im bi translated">上面的代码将被嵌入到一个函数中，要改变函数内部全局变量的值，我们需要使用<strong class="la iu">全局赋值</strong>操作符<code class="fe nu nv nw nx b">&lt;&lt;-</code>。当使用赋值运算符<code class="fe nu nv nw nx b">&lt;&lt;-</code>时，该变量属于全局范围。</p></blockquote><ul class=""><li id="6bcb" class="mt mu it la b lb lc le lf lh mv ll mw lp mx lt os mz na nb bi translated">变量<code class="fe nu nv nw nx b">origin</code>和<code class="fe nu nv nw nx b">dest</code>用于存储所选始发地和目的地区域的描述性区域名称。</li><li id="84a5" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt os mz na nb bi translated">变量<code class="fe nu nv nw nx b">origin_id</code>和<code class="fe nu nv nw nx b">dest_id</code>用于存储所选起点和终点区域的区域id。</li></ul><h2 id="3468" class="ni lw it bd lx nj nk dn mb nl nm dp mf lh nn no mh ll np nq mj lp nr ns ml nt bi translated">Shiny中的反应式编程</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="73d9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Shiny使用一个<strong class="la iu">反应式编程模型</strong>来简化R-powered web应用程序的开发。Shiny从用户界面获取输入，用<strong class="la iu"> <em class="nh">监听变化，观察</em> </strong>或<strong class="la iu"> <em class="nh">无功。</em> </strong></p><p id="44e8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">反应源通常是通过浏览器界面的用户输入。我们通过在构建输出的<code class="fe nu nv nw nx b">server()</code>中的反应表达式(如<code class="fe nu nv nw nx b">render*()</code>和<code class="fe nu nv nw nx b">reactive()</code>函数)中包含输入<code class="fe nu nv nw nx b">input$variable_selected </code>的值来创建反应。当输入发生变化时，所有依赖于输入的输出都将使用更新后的输入值自动更新(或重建)。</p><p id="ca84" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="nh">传单</em> </strong>当用户与地图和对象交互时，它们会将输入值(或事件)发送到Shiny。对象事件名称通常使用这种模式:</p><blockquote class="om on oo"><p id="2c1a" class="ky kz nh la b lb lc ju ld le lf jx lg op li lj lk oq lm ln lo or lq lr ls lt im bi translated">输入$MAPID_OBJCATEGORY_EVENTNAME</p></blockquote><p id="fea9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于<code class="fe nu nv nw nx b">leafletOutput("Zone")</code>，点击其中一个多边形形状(即FAF区)将在<code class="fe nu nv nw nx b">input$Zone_shape_click</code>更新闪亮的输入。</p><p id="3963" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">点击事件被设置为NULL(如果该事件从未发生过),或者list()包括:对象的纬度和经度是可用的；否则，鼠标光标；和layerId，如果有的话。</p><p id="ca05" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们的例子中，基于区域Id的<em class="nh"> layerId </em>字段包含在多边形对象中；因此区域ID的值将在<code class="fe nu nv nw nx b">input$Zone_shape_click</code>事件的<em class="nh">事件$Id </em>中返回。</p><pre class="kj kk kl km gt ny nx nz oa aw ob bi"><span id="c8ea" class="ni lw it nx b gy oc od l oe of">addPolygons(data=zone.rg, col="black", weight = 1, <strong class="nx iu">layerId = ~id</strong>, label = zone_labels, highlight = highlightOptions(color = "blue",weight = 2, bringToFront = F, opacity = 0.7))</span></pre><p id="a6a8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们希望应用程序的服务器端对地图上的点击做出响应，所以我们需要创建反应式表达式，使用<code class="fe nu nv nw nx b">reactive()</code>函数来结合用户的选择。使用<code class="fe nu nv nw nx b">reactive()</code>函数也有助于减少代码中的重复。</p><p id="6e2c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nu nv nw nx b">selected_zone()</code>返回点击(或选择)区域的质心。</p><pre class="kj kk kl km gt ny nx nz oa aw ob bi"><span id="1fb5" class="ni lw it nx b gy oc od l oe of">selected_zone &lt;- reactive({<br/>      p &lt;- input$Zone_shape_click<br/>      subset(centroid, id==p$id )<br/>    })</span></pre><p id="6339" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nu nv nw nx b">selected_od()</code>返回所选始发地-目的地区域对的信息(包括区域名称和区域id)。请注意，它会一直等待，直到选择了起始区域和目标区域才返回值。</p><p id="3092" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="nh">如果选择了一个新的原点区域，上一轮选择的目的区域将被重置。</em></p><pre class="kj kk kl km gt ny nx nz oa aw ob bi"><span id="6b56" class="ni lw it nx b gy oc od l oe of">selected_od &lt;- reactive({<br/>      p &lt;- input$Zone_shape_click<br/>      # return selected origin-destination zone pair<br/>    })</span></pre><h2 id="5820" class="ni lw it bd lx nj nk dn mb nl nm dp mf lh nn no mh ll np nq mj lp nr ns ml nt bi translated">使用带光泽的传单</h2><p id="2c12" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated"><strong class="la iu"> <em class="nh">传单</em> </strong>是最流行的用于交互式地图的开源JavaScript库之一。<strong class="la iu"> <em class="nh">活页</em> </strong>包装包含强大而方便的功能，可与闪亮的应用程序集成(<a class="ae lu" href="https://rstudio.github.io/leaflet/shiny.html" rel="noopener ugc nofollow" target="_blank">参考</a>)。可以通过以下基本步骤创建传单地图:</p><ol class=""><li id="9320" class="mt mu it la b lb lc le lf lh mv ll mw lp mx lt my mz na nb bi translated">通过调用leaflet()创建地图小部件</li><li id="3d51" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated">通过使用图层功能(例如，添加切片、添加标记、添加多边形)来修改地图微件，将图层(即，要素)添加到地图中。</li><li id="b5b8" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated">根据需要重复步骤2。</li><li id="5b0c" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated">打印地图微件以显示它。</li></ol><pre class="kj kk kl km gt ny nx nz oa aw ob bi"><span id="c307" class="ni lw it nx b gy oc od l oe of">output$Zone &lt;- renderLeaflet({<br/>  # create zone labels<br/>  # create map widget called m<br/>  # add base map and the FAF zone polygon layer<br/>})</span></pre><p id="b94b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">观察者使用热切评估策略，即一旦他们的依赖关系改变，他们就调度自己重新执行。</p><p id="c17d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们更新<code class="fe nu nv nw nx b">input$Zone_shape_click</code>对应的地图。当<code class="fe nu nv nw nx b">input$Zone_shape_click</code>改变时，观察器将自动重新执行。</p><pre class="kj kk kl km gt ny nx nz oa aw ob bi"><span id="0b0d" class="ni lw it nx b gy oc od l oe of">observe({<br/>      p &lt;- input$Zone_shape_click # get input value<br/>      if (is.null(p))             <br/>        return()<br/>                            <br/>      m2&lt;-leafletProxy("Zone", session = session) # get map widget<br/>      <br/>      # create zone labels<br/>      <br/>      selected &lt;- selected_zone() # get selected zone centroid<br/>      # create selected zone label<br/>      <br/>      type &lt;&lt;- click_count%%2<br/>      if (type ==0 ){ <br/>        # clear the centroids displayed<br/>        # add a marker, the centroid of the new origin zone<br/>      }<br/>      <br/>      if (type == 1){<br/>        # add a marker, the centroid of the new destination zone<br/>      }<br/>      click_count &lt;&lt;- click_count+1    # keep track of map clicks<br/>    })</span></pre><p id="0d70" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先获取所选区域，并使用前面解释的逻辑确定所选区域是源区域还是目标区域。通过显示所选区域的质心来更新地图，并对起点和终点使用不同的颜色。</p><blockquote class="om on oo"><p id="395d" class="ky kz nh la b lb lc ju ld le lf jx lg op li lj lk oq lm ln lo or lq lr ls lt im bi translated">为了修改页面中已经运行的地图，我们使用了<code class="fe nu nv nw nx b">leafletProxy()</code>函数来代替<code class="fe nu nv nw nx b"><em class="it">leaflet()</em></code>调用。</p></blockquote><p id="d312" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通常我们使用<code class="fe nu nv nw nx b">leaflet</code>来创建地图的静态方面，使用<code class="fe nu nv nw nx b">leafletProxy</code>来管理动态元素，这样就可以在点击时更新地图，而不用重新绘制整个地图。关于如何使用该功能的详细信息，请参见<a class="ae lu" href="https://rstudio.github.io/leaflet/shiny.html" rel="noopener ugc nofollow" target="_blank"> RStudio网站</a>。</p><h2 id="4756" class="ni lw it bd lx nj nk dn mb nl nm dp mf lh nn no mh ll np nq mj lp nr ns ml nt bi translated">添加输出</h2><p id="f65c" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">现在，我们在Shiny应用程序中显示数据，包括几个用于交互式可视化的输出。</p><p id="8b04" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nu nv nw nx b">output$od_info</code> <em class="nh"> </em>对象是无功端点，它使用无功源<code class="fe nu nv nw nx b">input$Zone_shape_click</code>。每当<code class="fe nu nv nw nx b">input$Zone_shape_click</code>改变时，<code class="fe nu nv nw nx b">output$od_info</code>被通知需要重新执行。此输出动态显示选定的源区域和目标区域的名称。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/6fac1bdc51f7142f3a849eb59d2f1dd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fc6DN6Mn8YQyFpkPzdgybQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">od_info的输出(图片由作者提供)</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="c431" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们使用R package <strong class="la iu"> DT </strong>将数据对象(矩阵或数据框)显示为HTML页面上的表格。在<code class="fe nu nv nw nx b">output$od_vol</code>中，我们首先通过<code class="fe nu nv nw nx b">selected_od()</code>获取所选始发地和目的地区域的信息，然后过滤<code class="fe nu nv nw nx b">od_mode_vol</code>中存储的FAF数据，以获取所选始发地和目的地区域对的结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/b5b9b423fbd0465efeb67596c643d3ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qTKFuuxvZI99zHyhlzSbSw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">所选始发地和目的地区域对的FAF数据比较(图片由作者提供)</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="b1a5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">除了将查询结果显示为数据表之外，我们还使用条形图和圆环图来显示结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/8df993549a0afa7ae7b072036748c6a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OmwUeKTxDK7IyVcRyf3NTw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="4973" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们使用<code class="fe nu nv nw nx b">renderPlotly()</code>函数来渲染一个反应式表达式，该表达式根据输入值<code class="fe nu nv nw nx b">input$Zone_shape_click</code> <em class="nh"> </em>到<em class="nh"> </em> <code class="fe nu nv nw nx b">selected_od()</code> <em class="nh">生成<strong class="la iu"/>图形。</em></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="a1ea" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要制作一个圆环图，使用<code class="fe nu nv nw nx b">add_pie()</code>函数的<code class="fe nu nv nw nx b">hole= </code>参数设置要从饼图中切掉的半径的分数。该值可以在<code class="fe nu nv nw nx b">0.01</code>和<code class="fe nu nv nw nx b">0.99</code>之间。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><h1 id="b901" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">4.免费发布闪亮的应用</h1><p id="c2ca" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated"><em class="nh"> Shinyapps.io </em>是一款软件即服务(SaaS)产品，用于在云中托管闪亮的应用。RStudio负责托管应用程序和维护服务器的所有细节，因此我们可以专注于编写应用程序。</p><p id="dd70" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一个闪亮的应用程序可以在几分钟内部署到shinyapps.io上。只要按照这个详细的<a class="ae lu" href="https://shiny.rstudio.com/articles/shinyapps.html#:~:text=Shinyapps.io%20is%20an%20online,focus%20on%20writing%20great%20apps!&amp;text=Use%20the%20tokens%20generated%20by,to%20configure%20your%20rsconnect%20package." rel="noopener ugc nofollow" target="_blank">一步一步的指示</a>就可以了。</p><p id="a69f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="nh"> Shinyapps.io </em>提供<em class="nh"> </em>免费和付费计划。通过免费计划，您可以同时部署多达5个闪亮的应用程序，并且每月有多达25个小时的活动时间由该帐户下托管的所有应用程序共享。</p></div><div class="ab cl ow ox hx oy" role="separator"><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb"/></div><div class="im in io ip iq"><div class="kj kk kl km gt pd"><a href="https://huajing-shi.medium.com/membership" rel="noopener follow" target="_blank"><div class="pe ab fo"><div class="pf ab pg cl cj ph"><h2 class="bd iu gy z fp pi fr fs pj fu fw is bi translated">用我的推荐链接-华景石加入媒体</h2><div class="pk l"><h3 class="bd b gy z fp pi fr fs pj fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pl l"><p class="bd b dl z fp pi fr fs pj fu fw dk translated">huajing-shi.medium.com</p></div></div><div class="pm l"><div class="pn l po pp pq pm pr ks pd"/></div></div></a></div><p id="dbbb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">r代码和输入数据可从my <a class="ae lu" href="https://github.com/shi093/Map-Freight-Analysis-Framework" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>获得。</p></div><div class="ab cl ow ox hx oy" role="separator"><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb"/></div><div class="im in io ip iq"><h2 id="580f" class="ni lw it bd lx nj nk dn mb nl nm dp mf lh nn no mh ll np nq mj lp nr ns ml nt bi translated">参考</h2><ol class=""><li id="132b" class="mt mu it la b lb mn le mo lh ps ll pt lp pu lt my mz na nb bi translated"><a class="ae lu" href="https://shiny.rstudio.com/articles/basics.html" rel="noopener ugc nofollow" target="_blank">闪亮应用的基本组成部分</a></li><li id="2fc2" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated"><a class="ae lu" href="https://shiny.rstudio.com/articles/shinyapps.html#:~:text=Shinyapps.io%20is%20an%20online,focus%20on%20writing%20great%20apps!&amp;text=Use%20the%20tokens%20generated%20by,to%20configure%20your%20rsconnect%20package." rel="noopener ugc nofollow" target="_blank">shiny apps . io入门</a></li><li id="1b42" class="mt mu it la b lb nc le nd lh ne ll nf lp ng lt my mz na nb bi translated"><a class="ae lu" href="https://www.analyticsvidhya.com/blog/2016/10/creating-interactive-data-visualization-using-shiny-app-in-r-with-examples/" rel="noopener ugc nofollow" target="_blank">在R中使用闪亮的应用程序创建交互式数据可视化(带示例)</a></li></ol></div></div>    
</body>
</html>