<html>
<head>
<title>How to Deploy a Secure API with FastAPI, Docker and Traefik</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用FastAPI、Docker和Traefik部署安全API</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-deploy-a-secure-api-with-fastapi-docker-and-traefik-b1ca065b100f?source=collection_archive---------2-----------------------#2021-07-21">https://towardsdatascience.com/how-to-deploy-a-secure-api-with-fastapi-docker-and-traefik-b1ca065b100f?source=collection_archive---------2-----------------------#2021-07-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9636" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">配置HTTP <strong class="ak"> S </strong>的指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/dda9997ed60843f9a7620a353384f849.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2-P_Tn7jCY3brd0x"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@flyd2069?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">飞:D </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="5e2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们部署一个API来服务一个机器学习模型时，我们很少关心那个绿色的挂锁，它使得HTTP连接被认为是安全的，浏览器是快乐的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/cf05160bacc4eed4326384ddb225472b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cVk9gTX-uhn-i7yf.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="4410" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们通常认为HTTPS是理所当然的，我们可能认为它只是通过一些简单的配置就可以打开<strong class="lb iu"><em class="lw"/></strong>。</p><p id="48dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事实是，添加HTTPS需要几个步骤。</p><blockquote class="lx ly lz"><p id="0b49" class="kz la lw lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated">这就是这篇文章的目的:解释为什么HTTPS很重要，以及当你用Python构建web应用和API时，如何将它添加到你的部署中。 </p></blockquote><p id="fc78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是我们将在本帖中介绍的内容:</p><ol class=""><li id="0912" class="md me it lb b lc ld lf lg li mf lm mg lq mh lu mi mj mk ml bi translated"><strong class="lb iu">HTTPS简介:它是如何运作的，为什么你应该关注它？</strong></li><li id="79ad" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu mi mj mk ml bi translated"><strong class="lb iu">用FastAPI构建API </strong></li><li id="cd44" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu mi mj mk ml bi translated"><strong class="lb iu">介绍Traefik及其如何处理HTTPS </strong></li><li id="7e7e" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu mi mj mk ml bi translated"><strong class="lb iu">通过Docker集成FastAPI和Traefik</strong></li><li id="0947" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu mi mj mk ml bi translated"><strong class="lb iu">在AWS上部署</strong></li></ol><p id="91b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个指南将最终帮助您添加HTTPS到您的项目。您可以重用以下代码来构建安全的项目。</p><p id="0d2a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事不宜迟，让我们直接开始吧🚀</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><p id="5f1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lw"> PS*:此代码在</em><a class="ae ky" href="https://github.com/ahmedbesbes/fastapi-ssl" rel="noopener ugc nofollow" target="_blank"><em class="lw">Github</em></a><em class="lw">上有。</em></p><p id="1807" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lw"> PS**:如果你想了解更多关于FastAPI、Docker和Github的动作，一定要看看我之前的</em> <a class="ae ky" rel="noopener" target="_blank" href="/how-to-deploy-a-machine-learning-model-with-fastapi-docker-and-github-actions-13374cbd638a"> <em class="lw">帖子</em> </a> <em class="lw">。</em></p><div class="my mz gp gr na nb"><a rel="noopener follow" target="_blank" href="/how-to-deploy-a-machine-learning-model-with-fastapi-docker-and-github-actions-13374cbd638a"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd iu gy z fp ng fr fs nh fu fw is bi translated">如何用FastAPI、Docker和Github动作部署机器学习模型</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">具有CI/CD的端到端管道</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">towardsdatascience.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np ks nb"/></div></div></a></div></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="2117" class="nq nr it bd ns nt nu nv nw nx ny nz oa jz ob ka oc kc od kd oe kf of kg og oh bi translated">复制本教程需要什么</h1><ul class=""><li id="08ff" class="md me it lb b lc oi lf oj li ok lm ol lq om lu on mj mk ml bi translated">注册的域名。你可以花几块钱在T42买到一个</li><li id="145f" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu on mj mk ml bi translated">安装在本地机器上的Docker和docker-compose:你可以遵循官方的<a class="ae ky" href="https://docs.docker.com/engine/install/ubuntu/" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="e49e" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu on mj mk ml bi translated">部署API的远程服务器:我在AWS EC2上使用了一个<code class="fe oo op oq or b">t2-medium</code>实例。任何同等的东西都应该是好的。<br/>确保这个实例有<strong class="lb iu">固定的IP地址</strong>。</li><li id="1a85" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu on mj mk ml bi translated">在您的域提供者上，创建一个指向实例IP地址的A记录。我目前拥有ahmedbesbes.com，为了这个教程，我创造了以下记录:<strong class="lb iu">ssl.ahmedbesbes.com。</strong>你可以通过选择任何你想要的子域来对你的域做同样的事情。<br/>OVH的界面看起来是这样的(<a class="ae ky" href="https://www.ovh.com/" rel="noopener ugc nofollow" target="_blank"> OVH </a>是我的域名提供商)</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/aa9574eba08abf5138e64000b3fa715c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F4Jq0IjPUmBSBWCCPEPb1w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><h1 id="3457" class="nq nr it bd ns nt ot nv nw nx ou nz oa jz ov ka oc kc ow kd oe kf ox kg og oh bi translated">什么是HTTPS，你为什么要关心它？</h1><p id="d57a" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">HTTPS是基于加密协议的HTTP。这个协议被称为传输层安全性(<strong class="lb iu"> TLS </strong>)，它以前被称为安全套接字层(<strong class="lb iu"> SSL </strong>)。</p><p id="3b83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">换句话说，HTTPS是加密的，以增加数据传输的安全性。</p><h2 id="f889" class="pb nr it bd ns pc pd dn nw pe pf dp oa li pg ph oc lm pi pj oe lq pk pl og pm bi translated">它是如何工作的？</h2><p id="cd26" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">HTTPS背后的协议TLS使用不对称的<a class="ae ky" href="https://en.wikipedia.org/wiki/Public-key_cryptography" rel="noopener ugc nofollow" target="_blank">公钥基础设施</a>。该系统使用两种不同的密钥来加密双方之间的通信:</p><ol class=""><li id="1687" class="md me it lb b lc ld lf lg li mf lm mg lq mh lu mi mj mk ml bi translated">私人钥匙🔐:此密钥由网站所有者控制，它是私有的，位于远程web服务器上。它用于<strong class="lb iu">解密由公钥加密的信息</strong></li><li id="2bd1" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu mi mj mk ml bi translated">公钥🔑:任何希望以安全方式与服务器交互的人都可以使用此密钥。这个密钥的作用是<strong class="lb iu">加密数据</strong>,私钥稍后会解密这些数据。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pn"><img src="../Images/3a4cf1bc94860e8b56d6f5eabedcb0a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/0*LKx2hwNFpCQkUXmu.jpg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者修改</p></figure><h2 id="6442" class="pb nr it bd ns pc pd dn nw pe pf dp oa li pg ph oc lm pi pj oe lq pk pl og pm bi translated">我们为什么需要HTTPS？</h2><p id="6117" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">HTTPS是一个非常有用的协议。您需要它有三个主要原因:</p><ul class=""><li id="b0e7" class="md me it lb b lc ld lf lg li mf lm mg lq mh lu on mj mk ml bi translated"><strong class="lb iu">隐私</strong>:这样就没人能拦截或偷听你的消息(消息可以是你发布给朋友的文字，你填写表格的信用卡信息，图像，视频，或者你通过网络上传的任何东西)。当通过HTTPS发送时，该数据被<strong class="lb iu">加密，</strong>即变成一个长的字母数字串。</li><li id="2b1c" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu on mj mk ml bi translated">完整性:这样你发送的信息在到达目的地的途中不会被任何形式的操纵。</li><li id="b768" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu on mj mk ml bi translated"><strong class="lb iu">认证</strong>:这样你请求的远程服务器就能确定你就是你声称的那个人</li></ul><p id="8ece" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了给你的应用增加一个安全层，HTTPS还是高质量软件实践的保证。这对于建立可信的用户群非常重要。</p><p id="0616" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">主要的互联网公司都非常重视HTTPS。事实上，谷歌<a class="ae ky" href="https://seo-hacker.com/google-adopt-https/" rel="noopener ugc nofollow" target="_blank">在2014年宣布</a>拥有HTTPS将提高你在搜索结果中的排名。谷歌还让Chrome将所有没有HTTPS的网站标记为不安全。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi po"><img src="../Images/3743977a5dce39c8c9b68f96e34190cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gXob6tnDGmEyefhn.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">看完这个谁还想访问你的网站？(图片由作者提供)</p></figure><p id="f99b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是时候将HTTPS添加到您的应用程序中了！</p><h1 id="b29e" class="nq nr it bd ns nt ot nv nw nx ou nz oa jz ov ka oc kc ow kd oe kf ox kg og oh bi translated">用FastAPI构建最小API</h1><p id="6622" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">在这一节中，我们将在一个非常简单的例子上安装并运行FastAPI。接下来我们将看到如何保护它。</p><p id="6744" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在进入代码之前，下面是项目结构的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pp"><img src="../Images/672973ca16ccd789e309f2c7378ec233.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*UZOaseU-JdhVjVPlFvQFyg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="9731" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从创建虚拟环境开始:</p><pre class="kj kk kl km gt pq or pr ps aw pt bi"><span id="170b" class="pb nr it or b gy pu pv l pw px"><strong class="or iu">mkdir fastapi-ssl &amp;&amp; cd _<br/>pipenv install fastapi</strong></span></pre><p id="3bac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">没什么特别的，我们将创建一个有两条路线的API:</p><ul class=""><li id="1c68" class="md me it lb b lc ld lf lg li mf lm mg lq mh lu on mj mk ml bi translated">一个处理<strong class="lb iu"> GET请求</strong>并在浏览器上显示以下JSON响应</li></ul><pre class="kj kk kl km gt pq or pr ps aw pt bi"><span id="8a3c" class="pb nr it or b gy pu pv l pw px"><strong class="or iu">{"message": "Hello FastAPI + SSL"}</strong></span></pre><ul class=""><li id="93cd" class="md me it lb b lc ld lf lg li mf lm mg lq mh lu on mj mk ml bi translated">另一个处理<strong class="lb iu"> POST请求。</strong>这个路由需要一个包含两个键:<code class="fe oo op oq or b">text</code>和<code class="fe oo op oq or b">author</code>的主体，并发回一个JSON对象作为响应，其中包含已经发送的相同的<code class="fe oo op oq or b">text</code>和<code class="fe oo op oq or b">author</code>以及一个附加的<code class="fe oo op oq or b">status</code>消息。</li></ul><pre class="kj kk kl km gt pq or pr ps aw pt bi"><span id="310a" class="pb nr it or b gy pu pv l pw px"><strong class="or iu">{"status": "message received", "text": "Hello", "author": "Ahmed"}</strong></span></pre><p id="a730" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的代码定义了这两条路线。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="py pz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一个非常简单的API，有两条路径</p></figure><p id="1dc2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查看这篇<a class="ae ky" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank">文章</a>，了解更多关于用FastAPI构建API的信息。</p><h1 id="9cc5" class="nq nr it bd ns nt ot nv nw nx ou nz oa jz ov ka oc kc ow kd oe kf ox kg og oh bi translated">什么是Traefik？它如何帮助HTTPS？</h1><p id="22bb" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">在用Docker打包app之前，我们先介绍一下Traefik。</p><blockquote class="lx ly lz"><p id="eac8" class="kz la lw lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated">Traefik是一个开源的反向代理和负载平衡器，适用于基于HTTP和TCP的应用程序，它简单、动态、自动、快速、功能全面、经过生产验证，提供指标，并与每一种主要的集群技术集成…</p></blockquote><p id="3d16" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Traefik的目标是拦截来自互联网的传入HTTP请求，并将它们路由到Docker运行的专用容器。它可以将任何DNS记录附加到正在运行的服务上。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qa"><img src="../Images/de21de62d94ed0cc250cb71e5a00ba9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9_W9o_E-Eks0awsQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">特拉菲克在中间</p></figure><p id="75c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Traefik是云原生的。这意味着它可以轻松地与Docker和Kubernetes等云技术集成。在本教程中，我们将Traefik链接到Docker。</p><p id="2373" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的樱桃:Traefik自动支持<strong class="lb iu">让我们加密</strong>证书。这意味着它会自动为您处理这些文件的创建和更新，以确保HTTPS配置正确。</p><h1 id="fceb" class="nq nr it bd ns nt ot nv nw nx ou nz oa jz ov ka oc kc ow kd oe kf ox kg og oh bi translated"><strong class="ak">让我们加密什么？</strong></h1><blockquote class="lx ly lz"><p id="ae47" class="kz la lw lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated">Let's Encrypt是一个免费的、自动化的、开放的认证机构(CA)，为公众的利益而运行。这是由<a class="ae ky" href="https://www.abetterinternet.org/" rel="noopener ugc nofollow" target="_blank">互联网安全研究小组(ISRG) </a>提供的服务。</p></blockquote><p id="6288" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Let's Encrypt是一个会为我们颁发免费SSL证书的组织。</p><h2 id="487e" class="pb nr it bd ns pc pd dn nw pe pf dp oa li pg ph oc lm pi pj oe lq pk pl og pm bi translated"><strong class="ak">什么是SSL证书？</strong></h2><p id="ddc7" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">SSL证书允许网站拥有HTTPS。</p><p id="886e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它是一个保存在部署应用程序的远程服务器上的文件。它使SSL/TLS加密成为可能，并保存诸如公钥和网站身份等信息。</p><p id="2165" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当客户端(例如您的浏览器)尝试连接到安全网站时，它首先会获得此证书的副本。这允许客户端检查远程服务器的身份并获得公钥，以便启动加密会话。</p><h1 id="dcfd" class="nq nr it bd ns nt ot nv nw nx ou nz oa jz ov ka oc kc ow kd oe kf ox kg og oh bi translated">为HTTPS设置Traefik</h1><p id="1343" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">让我们从配置Traefik开始。这可以使用下面的TOML文件来完成。该文件将位于<code class="fe oo op oq or b">services/traefik</code>中</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="py pz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Traefik配置文件</p></figure><p id="fa7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们详细介绍一下每一部分都发生了什么:</p><p id="d209" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe oo op oq or b"><strong class="lb iu">[entrypoints]</strong></code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="py pz l"/></div></figure><p id="7f4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此部分指定Traefik将侦听的端口。这些端口是<strong class="lb iu"> 80 </strong>和<strong class="lb iu"> 443 </strong>。80是默认的HTTP端口，443是HTTPS端口。我们将分别称它们为<code class="fe oo op oq or b">web</code>和<code class="fe oo op oq or b">websecure</code>。</p><p id="4709" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们告诉Traefik将HTTP重定向到HTTPS。</p><p id="c378" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe oo op oq or b"><strong class="lb iu">[accessLog]</strong></code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="py pz l"/></div></figure><p id="b6a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个部分告诉Traefik将日志打印到<code class="fe oo op oq or b">stdout</code>以了解谁给谁打了电话。</p><p id="2cfa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe oo op oq or b"><strong class="lb iu">[providers]</strong></code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="py pz l"/></div></figure><p id="6fa9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本节中，我们将配置所谓的提供者。</p><blockquote class="lx ly lz"><p id="439c" class="kz la lw lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated"><em class="it">提供商</em>是基础设施组件，无论是编排器、容器引擎、云提供商还是键值存储。其思想是，Traefik查询提供者API，以便找到有关路由的相关信息，当Traefik检测到变化时，它会动态更新路由。</p></blockquote><p id="ca40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">我们希望Traefik在Docker容器前充当代理，所以我们将选择Docker作为提供者之一。</strong></p><p id="7e40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将<code class="fe oo op oq or b">exposedByDefault</code>设置为<code class="fe oo op oq or b">false</code>仅仅意味着Traefik不会在所有容器前充当代理。它只会在那些有docker-compose中描述的特定标签的人面前这样做。(我们将在下面的Docker部分介绍这些标签)</p><p id="8915" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe oo op oq or b"><strong class="lb iu">[certificatesResolvers.letsencrypt.name]</strong></code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="py pz l"/></div></figure><p id="8126" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本节配置证书解析器。换句话说，Traefik将通过<a class="ae ky" href="https://github.com/ietf-wg-acme/acme/" rel="noopener ugc nofollow" target="_blank"> ACME </a>协议与Let's Encrypt通信:要做到这一点，您必须设置一个有效的电子邮件地址和文件名，Traefik将把它从Let's Encrypt接收的信息保存在这里。当Traefik与Let's Encrypt通信时，可以成功生成和更新证书。</p><h1 id="73f0" class="nq nr it bd ns nt ot nv nw nx ou nz oa jz ov ka oc kc ow kd oe kf ox kg og oh bi translated">使用Docker准备部署</h1><p id="eba3" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">在本节中，我们在docker-compose文件中定义了两个容器:一个用于FastAPI web服务，另一个用于启动Traefik。</p><p id="86e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="lw">注意，您可以有多个运行不同服务的容器，Traefik会将流量路由到这些容器。</em> </strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="py pz l"/></div></figure><p id="8d26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们详细说明每个容器中发生了什么:</p><p id="e7e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> — </strong> <code class="fe oo op oq or b"><strong class="lb iu">api</strong></code></p><p id="064d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们首先通过引用以下Dockerfile文件的路径来构建映像:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="py pz l"/></div></figure><p id="f582" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们定义将被Traefik读取的docker标签</p><ul class=""><li id="4372" class="md me it lb b lc ld lf lg li mf lm mg lq mh lu on mj mk ml bi translated"><code class="fe oo op oq or b">traefik.enable=true</code>确保Traefik看到该容器并将流量路由到该容器</li><li id="bf44" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu on mj mk ml bi translated">其他标签定义了指向容器的DNS记录(ssl.ahmedbesbes.com，也就是我为这个API设置的域)。他们还告诉Traefik使用TLS并使用Let's Encrypt来解析证书。</li></ul><p id="dea5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">——</strong>——<code class="fe oo op oq or b"><strong class="lb iu">traefik</strong></code></p><p id="53c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们首先从官方注册中提取图像。</p><p id="6e39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将容器上的端口80和443映射到主机上的端口80和443。</p><p id="f06f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们定义了三个卷:</p><ol class=""><li id="3a84" class="md me it lb b lc ld lf lg li mf lm mg lq mh lu mi mj mk ml bi translated">第一个卷使Traefik知道其他容器</li><li id="b0f5" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu mi mj mk ml bi translated">第二个卷将Traefik配置文件传递给容器</li><li id="4c35" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu mi mj mk ml bi translated">第三个卷将生成的证书保存在主机上，这样就不会在每次容器重新启动时重新生成它们。这很重要，因为Let's Encrypt对您可以获得的证书数量有限制</li></ol><h1 id="477e" class="nq nr it bd ns nt ot nv nw nx ou nz oa jz ov ka oc kc ow kd oe kf ox kg og oh bi translated">在AWS上部署</h1><p id="7d05" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">确保本地一切正常，连接到虚拟机，克隆存储库，并在根目录下运行以下命令:</p><pre class="kj kk kl km gt pq or pr ps aw pt bi"><span id="1ac9" class="pb nr it or b gy pu pv l pw px"><strong class="or iu">docker-compose up --build -d</strong></span></pre><p id="ee72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让Github动作的部署更顺利，看看我之前的<a class="ae ky" rel="noopener" target="_blank" href="/how-to-deploy-a-machine-learning-model-with-fastapi-docker-and-github-actions-13374cbd638a">帖子</a>。</p><h1 id="8833" class="nq nr it bd ns nt ot nv nw nx ou nz oa jz ov ka oc kc ow kd oe kf ox kg og oh bi translated">资源</h1><p id="7b37" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">下面是我用来学习HTTPS、Traefik和用Docker部署FastAPI应用程序的资源的汇编列表。</p><p id="5827" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不要犹豫，让我知道你在这方面找到的其他有用的资源😉</p><div class="my mz gp gr na nb"><a href="https://howhttps.works/" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd iu gy z fp ng fr fs nh fu fw is bi translated">HTTPS是如何运作的</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">你有没有想过为什么你的浏览器地址栏会出现一个绿色的锁图标？为什么它很重要？我们也是，而且…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">howhttps。作品</p></div></div><div class="nk l"><div class="qb l nm nn no nk np ks nb"/></div></div></a></div><div class="my mz gp gr na nb"><a href="https://www.valentinog.com/blog/traefik/" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd iu gy z fp ng fr fs nh fu fw is bi translated">使用Docker、Traefik和Let's Encrypt部署FastAPI应用程序</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">当用Docker和Let's Encrypt把所有的部分组合起来配置Traefik时，我用了15个…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">www.valentinog.com</p></div></div><div class="nk l"><div class="qc l nm nn no nk np ks nb"/></div></div></a></div><div class="my mz gp gr na nb"><a href="https://fastapi.tiangolo.com/tr/deployment/docker/" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd iu gy z fp ng fr fs nh fu fw is bi translated">使用Docker - FastAPI部署</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">警告当前页面仍然没有该语言的翻译。但是你可以帮忙翻译一下…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">fastapi.tiangolo.com</p></div></div><div class="nk l"><div class="qd l nm nn no nk np ks nb"/></div></div></a></div><div class="my mz gp gr na nb"><a href="https://www.digitalocean.com/community/tutorials/how-to-use-traefik-v2-as-a-reverse-proxy-for-docker-containers-on-ubuntu-20-04" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd iu gy z fp ng fr fs nh fu fw is bi translated">如何在Ubuntu 20.04 | DigitalOcean上使用Traefik v2作为Docker容器的反向代理</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">Docker可能是在生产环境中运行web应用程序的一种有效方式，但是您可能希望在…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">www.digitalocean.com</p></div></div><div class="nk l"><div class="qe l nm nn no nk np ks nb"/></div></div></a></div><div class="my mz gp gr na nb"><a href="https://traefik.io/blog/traefik-2-tls-101-23b4fbee81f1/" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd iu gy z fp ng fr fs nh fu fw is bi translated">如何用TLS - Traefik 2 &amp; TLS 101配置Traefik 2</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">每个人的HTTPS (&amp; TCP over TLS)！我喜欢成为一名开发人员有成百上千的原因(除了对…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">traefik.io</p></div></div><div class="nk l"><div class="qf l nm nn no nk np ks nb"/></div></div></a></div><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="qg pz l"/></div></figure><div class="my mz gp gr na nb"><a href="https://www.digitalocean.com/community/tutorials/how-to-use-traefik-v2-as-a-reverse-proxy-for-docker-containers-on-ubuntu-20-04" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd iu gy z fp ng fr fs nh fu fw is bi translated">如何在Ubuntu 20.04 | DigitalOcean上使用Traefik v2作为Docker容器的反向代理</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">Docker可能是在生产环境中运行web应用程序的一种有效方式，但是您可能希望在…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">www.digitalocean.com</p></div></div><div class="nk l"><div class="qh l nm nn no nk np ks nb"/></div></div></a></div><p id="ef9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://www.cloudflare.com/fr-fr/learning/ssl/what-is-https/" rel="noopener ugc nofollow" target="_blank">https://www . cloud flare . com/fr-fr/learning/SSL/what-is-https/</a></p><h1 id="9bbf" class="nq nr it bd ns nt ot nv nw nx ou nz oa jz ov ka oc kc ow kd oe kf ox kg og oh bi translated">感谢阅读🙏</h1><p id="5d58" class="pw-post-body-paragraph kz la it lb b lc oi ju le lf oj jx lh li oy lk ll lm oz lo lp lq pa ls lt lu im bi translated">让我们结束它。这篇文章提供了一个机会:</p><ul class=""><li id="4d3b" class="md me it lb b lc ld lf lg li mf lm mg lq mh lu on mj mk ml bi translated">了解HTTPS及其带来的好处</li><li id="30cf" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu on mj mk ml bi translated">了解关于Traefik以及如何使用它作为反向代理来创建HTTPS连接的更多信息</li><li id="c946" class="md me it lb b lc mm lf mn li mo lm mp lq mq lu on mj mk ml bi translated">使用Docker通过Traefik部署和管理FastAPI</li></ul><p id="8f03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这是在您的项目中实施HTTPS的良好开端。</p><p id="00e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，代码可以在<a class="ae ky" href="https://github.com/ahmedbesbes/fastapi-ssl" rel="noopener ugc nofollow" target="_blank"> Github </a>上获得:你可以随意使用它或者为你的项目修改它。</p><p id="576f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我就讲到这里，下次见！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi qi"><img src="../Images/dd0564e2ac1f60795e518ddbb55558d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Yqa6ALaZZ4bfTrEi"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@karsten116?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卡斯滕·怀恩吉尔特</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="316f" class="nq nr it bd ns nt ot nv nw nx ou nz oa jz ov ka oc kc ow kd oe kf ox kg og oh bi translated">新到中？您可以每月订阅5美元，并解锁无限的文章— <a class="ae ky" href="https://ahmedbesbes.medium.com/membership" rel="noopener">单击此处。</a></h1></div></div>    
</body>
</html>