<html>
<head>
<title>Python makes spreadsheets Excel’lent</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python使电子表格Excel'lent</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/python-makes-spreadsheets-excellent-f48ce0c648e3?source=collection_archive---------16-----------------------#2021-04-10">https://towardsdatascience.com/python-makes-spreadsheets-excellent-f48ce0c648e3?source=collection_archive---------16-----------------------#2021-04-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0165" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Python和VBA实现Microsoft Excel工作流的自动化</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3025bfd083f2be3b8385379855c32599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HxaFLrhwnuQOpfqN"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@goumbik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卢卡斯·布拉塞克</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="58f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个数据时代，python已经成为全球许多开发人员最广泛采用的语言。这意味着有许多潜在的图书馆等着被利用。</p><p id="cadd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然python最近成为了分析数据的首选，并在许多任务中拥有从低到高的广泛应用；Microsoft Excel有着悠久的历史，并且在大多数情况下仍然是用于分析/管理/可视化数据的不可或缺的工具。</p><p id="bdfe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">想象一下，如果我们可以利用python中的开源库来自动化我们在Excel中的工作流程；这会让我们的生活变得超级方便！站在巨大的开源python社区的肩膀上，我们可以在Excel中利用他们的功能，这个社区有数千个不同用例的包。</p><p id="4739" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我有一个这样的需求，我想在下面讨论一下，在<code class="fe ls lt lu lv b">xlwings</code>的帮助下，我能够通过VBA将我的Excel前端与python后端集成在一起，并且只需点击一个按钮，就可以自动完成一个相当繁琐的手动过程！</p><p id="400e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，这篇文章的主要目的是向您展示如何利用这个名为<code class="fe ls lt lu lv b">xlwings</code>的强大python包通过VBA与Excel通信，并在此过程中自动完成一些任务。python代码可能有VBA的变通办法，但对于我的特殊用例，我无法规避对python的需求，因为VBA无法完成一些像<code class="fe ls lt lu lv b">nsepy</code>这样的python库能够完成的任务。</p><h1 id="004a" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">问题是</h1><p id="6db4" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">我保留了一张表，用来跟踪我的股票以及它们在一天结束时的表现。为此，我需要获取我投资组合中每只股票的收盘价，并每天努力手工输入。任何手动过程都容易出错，我以前就犯过这种错误，我在更新一些股票的收盘价时犯了一个错误，我的计算显示，我的风险比我想象的高得多；但当我反复核对时，情况并非如此，我意识到我在一只股票的十位数字中错误地输入了9，而不是6。那些在键盘上使用数字小键盘的人可能会遇到这个问题</p><p id="f3fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我知道了这个名为<code class="fe ls lt lu lv b">nsepy</code>的库，它由<a class="ae kv" href="https://github.com/swapniljariwala" rel="noopener ugc nofollow" target="_blank"> Swapnil Jariwala </a>维护，帮助从NSE服务器获取与NSE上列出的任何给定股权/期权相关的所有历史数据，但该库完全是用python编写的。如果我能在Excel中使用python的能力，那该多好啊！</p><p id="ee8f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是完全可能的。还有另一个叫做<code class="fe ls lt lu lv b">xlwings</code>的python库，它专门解决了excel与python的集成问题，瞧！问题解决了！！</p><p id="a702" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了给你一些关于这个问题的背景，这里有一张我用来保存我的股票账户的表格的一部分。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/c9f1cde6570b7dcad07567527d4f1449.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*xPNa9LxtLx_pzmdJVGa6Ig.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片由Vinayak提供</p></figure><p id="67c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我有脚本/股份/股票的ISIN编号及其名称，从同一工作簿的其他工作表中引用的平均买入价格，我过去在一天结束时手动输入的收盘价，以及基于每个脚本的我当前的头寸。</p><p id="d7f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，您应该能够实际创建如下内容</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/1a8569321a05f5a5c329b198abf645d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*faU4UBVOraPkhxugsqMX4Q.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片由Vinayak提供</p></figure></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="4cca" class="lw lx iq bd ly lz nc mb mc md nd mf mg jw ne jx mi jz nf ka mk kc ng kd mm mn bi translated">设置xlwings</h1><p id="b8e3" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">像任何其他包一样，您可以简单地用python包安装程序安装“xlwings ”,如下所示</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="508e" class="nl lx iq lv b gy nm nn l no np">pip install xlwings</span></pre><p id="ab7e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我建议您为这个项目创建一个虚拟环境，以避免您已经存在的包安装中的依赖冲突。这篇文章不会涉及它，但是你可以<a class="ae kv" href="https://uoa-eresearch.github.io/eresearch-cookbook/recipe/2014/11/26/python-virtual-env/" rel="noopener ugc nofollow" target="_blank">看这里</a>如果你想用pip安装一个虚拟环境或者<a class="ae kv" href="https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html#creating-an-environment-with-commands" rel="noopener ugc nofollow" target="_blank">看这里</a>如果你像我一样喜欢conda。</p><p id="1685" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">设置管道的一部分，即python管道。接下来，您应该安装excel与xlwings集成所需的部分。为此，<strong class="ky ir">保存并关闭您现在从安装xlwings的环境中打开的所有excel工作簿</strong>，只需运行以下命令</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="afbc" class="nl lx iq lv b gy nm nn l no np">xlwings addin install</span></pre><p id="4917" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这应该会无缝地发生，但有时，如果你在Windows 10机器上使用Excel 2016，你可能会遇到如下错误</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="e04e" class="nl lx iq lv b gy nm nn l no np">xlwings 0.17.0</span><span id="a695" class="nl lx iq lv b gy nq nn l no np">[Errno 2] No such file or directory: 'C:\\Users\\nayak\\AppData\\Roaming\\Microsoft\\Excel\\XLSTART\\xlwings.xlam'</span></pre><p id="09cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这可以通过使用简单的mkdir命令创建丢失的目录来解决</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="11c4" class="nl lx iq lv b gy nm nn l no np">mkdir C:\Users\nayak\AppData\Roaming\Microsoft\Excel\XLSTART</span></pre><p id="5f02" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">成功安装xlwings后，下次打开Excel时，您会看到在顶部的工具栏中为“xlwings”创建了一个选项卡。该选项卡还包含解释器和python路径，如果您有不同的虚拟环境要执行python函数，则必须指定这些路径。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/b6a7005c03666912bd40a05c255f1a87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qVNVCSEDiSIm3BymxXIW0Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片由Vinayak提供</p></figure><p id="4212" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我使用anaconda来维护我的环境，所以我提供了到我的conda的路径和我想要使用的相应环境。默认情况下，<code class="fe ls lt lu lv b">xlwings</code>将检测一个环境(主要是您安装了这个库的环境)，但是如果没有检测到，您就必须手动给出您的anaconda发行版的路径和环境名称。</p><p id="10fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要找到您的anaconda发行版在哪里，您可以从Windows开始菜单打开anaconda提示符，在该提示符下，首先通过运行命令激活您已经安装了<code class="fe ls lt lu lv b">xlwings</code>的环境</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="242d" class="nl lx iq lv b gy nm nn l no np">conda activate your_env_name</span></pre><p id="eeb3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并随后运行</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="9b65" class="nl lx iq lv b gy nm nn l no np">where python</span></pre><p id="6ef4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这可能会带来几个结果，但你需要把重点放在第一个；请看下面我的环境“分享”中的第一个结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/f4f222686cb7f49320ff00b1fbc424b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O4oy1SaAnZ1sK7GND6h4JA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片由Vinayak提供</p></figure><p id="a078" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里的路径是<code class="fe ls lt lu lv b">C:\\Users\nayak\Anaconda3\env\shares\python.exe</code>，所以在康达路径框中是<code class="fe ls lt lu lv b">C:\\Users\nayak\Anaconda3</code>，在康达环境框中是<code class="fe ls lt lu lv b">shares</code>。这将有助于调用python函数的宏理解应该在哪个环境中执行python代码。如果您没有使用anaconda发行版来管理您的环境，那么您可以使用您的python环境做一个等效的练习，您可以给出解释器的路径和python的路径，而不是在conda中这样做。</p><p id="0d30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，您需要在Excel界面中启用<code class="fe ls lt lu lv b">xlwings</code>的用户自定义函数(UDF)。打开Excel后，使用Alt + L + H导航到加载项框，然后您将看到一个带有多个复选框的屏幕，询问您需要为此工作簿启用哪些加载项。点击<code class="fe ls lt lu lv b">xlwings</code>旁边的方框，点击确定。</p><p id="5e73" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这之后需要做的最后一步是授权访问所有想要使用xlwings等第三方插件的宏。您可以通过导航到<em class="nt">文件&gt;选项&gt;信任中心设置&gt;宏设置</em>来完成此操作，并在宏设置中选择<em class="nt">启用所有宏</em>，然后在开发者宏设置中选择<em class="nt">信任对VBA项目对象模型的访问</em>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/c40d47b559e545118e2840fc59188567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I9ylhs36Ve-xJcLNvsqmxg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片由Vinayak提供</p></figure><p id="16bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">至此，我们已经准备好再次转向python方面了。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="6049" class="lw lx iq bd ly lz nc mb mc md nd mf mg jw ne jx mi jz nf ka mk kc ng kd mm mn bi translated"><strong class="ak">创建项目</strong></h1><p id="41a3" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">通过从cmd提示符或终端或shell运行以下命令，您可以快速开始一个项目</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="bd4d" class="nl lx iq lv b gy nm nn l no np">xlwings quickstart project_name</span></pre><p id="d529" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将创建一个以project_name作为文件夹名称的项目，默认情况下，您将在该文件夹中获得两个文件。</p><ul class=""><li id="210f" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated"><code class="fe ls lt lu lv b">project_name.py</code>:这是一个python文件，应该包含您的宏可以调用来修改工作表的代码。</li><li id="601f" class="nv nw iq ky b kz oe lc of lf og lj oh ln oi lr oa ob oc od bi translated"><code class="fe ls lt lu lv b">project_name.xlsm</code>:这是一个启用宏的excel文件，为空，包含两张表，分别是<code class="fe ls lt lu lv b">Sheet1</code>和<code class="fe ls lt lu lv b">xlwings.config</code>文件。您可以在此工作簿中创建其他工作表，并向其中添加任意数量的宏。回调的逻辑必须写在上面创建的python文件中。</li></ul><p id="4b1c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我所做的是我创建了一个项目，并将我的excel文件的内容复制到xlsm文件中，并根据我的喜好重命名该表。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="072e" class="lw lx iq bd ly lz nc mb mc md nd mf mg jw ne jx mi jz nf ka mk kc ng kd mm mn bi translated"><strong class="ak">python后端逻辑</strong></h1><p id="7ef7" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">现在是你自动化你的项目所需要的代码的主要部分。在这种情况下，您可以从上面的“xlsm”工作簿的任何工作表中访问任何单元格。</p><p id="5407" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以像在任何其他python脚本中一样编写任意数量的自定义函数，并在这里使用它们。我已经在main函数中编写了代码，我将用它来更新每日收盘价。为了便于理解，我已经给出了下面的代码。你可以在这里立刻看到完整的代码。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="3078" class="nl lx iq lv b gy nm nn l no np">import xlwings as xw<br/>wb = xw.Book.caller()</span></pre><p id="4817" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我是从工作簿内部调用的，所以我可以使用上面的语法并获取工作簿对象。如果您想获取对其他工作簿的引用，您可以</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="e813" class="nl lx iq lv b gy nm nn l no np">wb = xw.book(file_path)</span></pre><p id="6761" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里的file_path指的是保存excel文件的路径。然后，要访问任何工作表，基本上可以使用index或工作表的名称，要访问工作表中某个范围的值，可以在它上面链接range命令。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="f213" class="nl lx iq lv b gy nm nn l no np"># Refer by index<br/>DATE = wb.sheets[0].range("B1").value</span><span id="5d51" class="nl lx iq lv b gy nq nn l no np"># Refer by name<br/>SHARE_NAME = wb.sheets["sheet_name"].range("C1").value</span></pre><p id="4bdd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦你得到了一个股票的ISIN代码和它的名字，nsepy就可以帮助你获取在NSE上列出的所有股票的bhavcopy(价格列表),你可以在任何给定的有效NSE日期过滤该脚本的收盘价。nsepy是一个由Swapnil Jariwala维护的库，你可以在这里参考它的<a class="ae kv" href="https://nsepy.xyz/" rel="noopener ugc nofollow" target="_blank">文档。</a></p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="c301" class="nl lx iq lv b gy nm nn l no np">from nsepy.history import get_price_list</span><span id="8df7" class="nl lx iq lv b gy nq nn l no np"># Get the pricelist/bhavcopy for a given date and only keep the relevant info<br/>price_list = get_price_list(DATE)<br/>price_list = price_list[["SYMBOL", "CLOSE", "ISIN"]]</span><span id="03d9" class="nl lx iq lv b gy nq nn l no np"># An inline function to query the close price given a script name<br/>get_close = lambda x: price_list[price_list.ISIN == x]["CLOSE"]</span><span id="6466" class="nl lx iq lv b gy nq nn l no np"># Read the ISIN Code of our script name<br/>ISIN = wb.sheets[sheet_name].range(f"A1").value<br/>ISIN = ISIN.strip()</span><span id="0852" class="nl lx iq lv b gy nq nn l no np"># Use the inline function above to get the close price of our share<br/>close_price = get_close(ISIN)</span><span id="c8ee" class="nl lx iq lv b gy nq nn l no np"># Copy the share price value to Excel<br/>wb.sheets["sheet_name"].range(f"C1").value = float(close_price)</span></pre><p id="14c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你有多个脚本，你可以循环这个代码来获得所有脚本的收盘价，并根据你的意愿将它们写到Excel表中。</p><p id="9246" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这只是实际代码的一部分，可以在我的<a class="ae kv" href="https://github.com/ElisonSherton/Shares_Closing_Updater" rel="noopener ugc nofollow" target="_blank"> github repo上找到，这里是这个项目的</a>。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="b1f5" class="lw lx iq bd ly lz nc mb mc md nd mf mg jw ne jx mi jz nf ka mk kc ng kd mm mn bi translated"><strong class="ak">Excel前端逻辑</strong></h1><p id="5825" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">现在我们已经定义了python逻辑，我们需要将它连接到一个宏，并将其分配给主表单中的一个按钮。为此，您需要首先插入一个按钮。你可以去<em class="nt">开发者&gt;插入&gt;按钮</em>然后把一个按钮拖到表单中。</p><p id="6c0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后你可以点击<em class="nt"> Alt + F11 </em>调出VBA界面来定义一个宏。现在，您可以在放置按钮的同一个工作表中定义一个sub，如下所示。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="fdc7" class="nl lx iq lv b gy nm nn l no np">Sub CallUpdate()<br/>    mymodule = "Python_File_Name_Here"<br/>    RunPython ("import " &amp; mymodule &amp; ";" &amp; mymodule &amp; ".main()")<br/>End Sub</span></pre><p id="4590" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">宏中的这段代码将执行以下操作:</p><ul class=""><li id="177c" class="nv nw iq ky b kz la lc ld lf nx lj ny ln nz lr oa ob oc od bi translated">查找名为“Python_File_Name_Here”的文件</li><li id="f9c1" class="nv nw iq ky b kz oe lc of lf og lj oh ln oi lr oa ob oc od bi translated">导入该文件中的模块</li><li id="d35d" class="nv nw iq ky b kz oe lc of lf og lj oh ln oi lr oa ob oc od bi translated">调用指定python文件中的main函数。</li></ul><p id="72c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这段代码可以用许多不同的方式进行调整；如果你除了main之外还有另一个函数，你想调用它，你可以写</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="410b" class="nl lx iq lv b gy nm nn l no np">RunPython (“import “ &amp; mymodule &amp; “;” &amp; mymodule &amp; “.other_function_name()”)</span></pre><p id="53f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这仍然可以正常工作。您可以在VBA中进行一些检查，在python中进行一些检查，并在需要时让两个接口自由通信，这不是很好吗？</p><p id="4ea8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，对于您已经创建的按钮，您可以通过右键单击该按钮并转到分配宏选项来分配该宏，并最终选择该宏<code class="fe ls lt lu lv b">CallUpdate</code>并单击确定。</p><p id="0d21" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，每当您单击按钮(我将其命名为Update Close)，计算将在conda环境<code class="fe ls lt lu lv b">shares</code>中运行，输出将在excel表的c列中更新。这样，我就不必在网上手动查找每只股票的收盘价，然后将其填入Excel中，只需单击一个按钮即可完成！！</p><p id="9bcd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你也可以在python中定义函数，这些函数可以像Excel中的公式一样被调用，还可以做更多的事情，但我会在以后的文章中介绍这些内容…</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="8e15" class="lw lx iq bd ly lz nc mb mc md nd mf mg jw ne jx mi jz nf ka mk kc ng kd mm mn bi translated"><strong class="ak">结论</strong></h1><p id="90d9" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">希望这篇文章能帮助你理解如何借助python为你的excel工作流插上翅膀:)</p><h1 id="f559" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">参考</h1><ul class=""><li id="7f23" class="nv nw iq ky b kz mo lc mp lf oj lj ok ln ol lr oa ob oc od bi translated"><a class="ae kv" href="https://github.com/ElisonSherton/Shares_Closing_Updater" rel="noopener ugc nofollow" target="_blank"> Github代码回购帖子中的所有代码</a></li><li id="5a15" class="nv nw iq ky b kz oe lc of lf og lj oh ln oi lr oa ob oc od bi translated"><a class="ae kv" href="https://docs.xlwings.org/en/stable/quickstart.html" rel="noopener ugc nofollow" target="_blank"> xlwings官方文档</a></li></ul></div></div>    
</body>
</html>