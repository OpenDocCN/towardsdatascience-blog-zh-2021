<html>
<head>
<title>Building Keras from Source: A Follow-Along Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从源代码构建Keras:后续指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-keras-from-source-a-follow-along-guide-2bcc4cea3aec?source=collection_archive---------20-----------------------#2021-11-19">https://towardsdatascience.com/building-keras-from-source-a-follow-along-guide-2bcc4cea3aec?source=collection_archive---------20-----------------------#2021-11-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="eea5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">构建Keras的分步指南。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7bf70049d554718103df488c363f5dee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N4Bm-mklgQ7Whiafoy5EEA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="kv">照片由</em><a class="ae kw" href="https://unsplash.com/@viazavier" rel="noopener ugc nofollow" target="_blank">T5】劳拉·奥克 </a> <em class="kv">上</em> <a class="ae kw" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> <em class="kv">下</em> </a></p></figure><h1 id="a7ec" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">前奏:</h1><p id="e832" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">Keras最近通过将代码库托管在一个单独的存储库中，朝着改善开发者体验迈出了一大步。正如在<a class="ae kw" href="https://github.com/tensorflow/community/blob/master/rfcs/20200205-standalone-keras-repository.md" rel="noopener ugc nofollow" target="_blank"> RFC </a>中提到的，主要目标之一是消除由于核心<a class="ae kw" href="https://www.tensorflow.org/" rel="noopener ugc nofollow" target="_blank"> TensorFlow </a>库的长构建时间而导致的冗长反馈循环。由于这一变化，现在可以在非常可行的时间内运行测试。</p><p id="d703" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">这篇博文旨在成为Keras构建和测试过程的实践指南。让我们开始吧！</p><h1 id="68c7" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">从源构建:</h1><p id="a83e" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">对于这里所有的新手，我想花点时间解释一下“从源代码构建”到底是什么意思。这可能意味着很多事情(在这里最好的解释是<a class="ae kw" href="https://stackoverflow.com/questions/1622506/programming-definitions-what-exactly-is-building" rel="noopener ugc nofollow" target="_blank">这里是</a>)，但是在我们的例子中，它意味着以下内容:</p><p id="0486" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">将源代码编译成可安装包，并将所有模块链接到各自的端点。[1]" </p><p id="e857" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">注意，即使在这次迁移之后，仍然可以通过调用<code class="fe mr ms mt mu b">from tensorflow import keras</code>来访问Keras。这是由黄金API实现的。这些是Keras库为TensorFlow库提供的端点。因此，即使Keras是单独开发的，对于用户来说，它仍然停留在<code class="fe mr ms mt mu b">tf.keras</code>。你可以在这篇<a class="ae kw" href="https://stackoverflow.com/questions/1622506/programming-definitions-what-exactly-is-building" rel="noopener ugc nofollow" target="_blank">帖子</a>中了解到这一点。实现这一点的代码可在<a class="ae kw" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/api_template.__init__.py" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><p id="7e4d" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">我假设您是在Linux机器上这样做的。额外的好处是，这可以与支持TPU的云虚拟机完美配合。</p><p id="3683" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">以下所有命令都是直接采用或受官方Keras贡献的<a class="ae kw" href="https://github.com/keras-team/keras/blob/master/CONTRIBUTING.md" rel="noopener ugc nofollow" target="_blank">指南</a>的启发。请在打开PR之前进行同样的操作。</p><p id="d4d4" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">我还创建了一个<a class="ae kw" href="https://colab.research.google.com/github/AdityaKane2001/keras_build_test/blob/main/Keras_build_test_notebook.ipynb" rel="noopener ugc nofollow" target="_blank"> Colab笔记本</a>，你可以用它来轻松地构建和测试代码！</p><h2 id="d1aa" class="mv ky iq bd kz mw mx dn ld my mz dp lh ly na nb lj mc nc nd ll mg ne nf ln ng bi translated">第1部分:设置环境</h2><p id="6a45" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">就像TensorFlow一样，Keras使用了<a class="ae kw" href="https://bazel.build/" rel="noopener ugc nofollow" target="_blank">Bazel</a>【2】，一个基于图形的构建管理系统。这意味着您可以构建一次Keras，后续的构建将重用自上一次构建以来没有更改的部分。因此，重建所需的时间大大减少。下面是我们设置环境的方法:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">安装巴泽尔。</p></figure><p id="97b1" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">接下来，我们建立一个虚拟python环境。如果您在开发机器上工作，建议这样做。在Colab中，在基础环境中重新安装Keras就可以了。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">设置虚拟环境。</p></figure><p id="b2ac" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">接下来，我们克隆我们的开发分支。我们还安装了TensorFlow的夜间版本，这确保了我们与主TensorFlow repo保持同步。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">克隆存储库并更新环境。</p></figure><h2 id="671b" class="mv ky iq bd kz mw mx dn ld my mz dp lh ly na nb lj mc nc nd ll mg ne nf ln ng bi translated">第2部分:更新golden APIs(如果有的话)</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">需要更新的文件的文件结构。</p></figure><p id="463b" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">这部分仅适用于您添加了一些新文件的情况。您需要在以下文件中添加它们的名称。这确保您的模块将被构建，并在以后可供用户访问。</p><h2 id="1b91" class="mv ky iq bd kz mw mx dn ld my mz dp lh ly na nb lj mc nc nd ll mg ne nf ln ng bi translated">第3部分:构建和安装</h2><p id="11ac" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">现在是过程的关键。在这里，我们构建并安装我们的Keras版本。为此，请使用以下命令:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用Bazel构建。</p></figure><p id="fadf" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">执行上述命令后，Keras将根据您的更改重新安装。</p><p id="5505" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">如果你只想进行测试，那么你可以用<code class="fe mr ms mt mu b">bazel test</code>代替<code class="fe mr ms mt mu b">bazel build</code>。在这种情况下，您可以修改代码并再次运行<code class="fe mr ms mt mu b">bazel test</code>。您不需要像我们使用<code class="fe mr ms mt mu b">bazel build</code>那样手动安装软件包。</p><p id="98b4" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">示例:</p><pre class="kg kh ki kj gt nj mu nk nl aw nm bi"><span id="34e6" class="mv ky iq mu b gy nn no l np nq">bazel test keras/layers/convolutional_test</span></pre><p id="1ed5" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">在这里，您可以运行任意多的测试。您可以使用以下命令运行所有测试:</p><pre class="kg kh ki kj gt nj mu nk nl aw nm bi"><span id="5b67" class="mv ky iq mu b gy nn no l np nq">bazel test — test_timeout 300,450,1200,3600 — test_output=errors — keep_going — define=use_fast_cpp_protos=false — build_tests_only — build_tag_filters=-no_oss — test_tag_filters=-no_oss keras/…</span></pre><h1 id="7908" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">常见错误:</h1><pre class="kg kh ki kj gt nj mu nk nl aw nm bi"><span id="9321" class="mv ky iq mu b gy nn no l np nq">ERROR: /home/jupyter/.cache/bazel/_bazel_jupyter/ebc81b3ee71ff9bb69270887ebdc0d7b/external/bazel_skylib/lib/unittest.bzl:203:27: name ‘analysis_test_transition’ is not defined</span><span id="002a" class="mv ky iq mu b gy nr no l np nq"># OR </span><span id="e8a3" class="mv ky iq mu b gy nr no l np nq">ERROR: error loading package ‘’: Extension ‘lib/unittest.bzl’ has errors<br/>ERROR: error loading package ‘’: Extension ‘lib/unittest.bzl’ has errors<br/>INFO: Elapsed time: 3.557s<br/>INFO: 0 processes.<br/>FAILED: Build did NOT complete successfully (0 packages loaded)</span></pre><p id="842d" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">重新启动虚拟机。这种情况发生在安装之后，因为path不会在整个系统中更新。</p><pre class="kg kh ki kj gt nj mu nk nl aw nm bi"><span id="0d3e" class="mv ky iq mu b gy nn no l np nq">ImportError: cannot import name ‘saved_metadata_pb2’ from ‘keras.protobuf’ (unknown location)</span></pre><p id="393b" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">请更改目录，然后重试。这是由于本地和全球环境的混合造成的。</p><h1 id="e516" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">承认</h1><p id="e94c" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">我感谢TPU研究云(TRC)[3]对这个项目的支持。TRC在该项目期间允许TPU进入。谷歌通过提供谷歌云信用来支持这项工作。感谢Keras团队的Scott Zhu在整个过程中对我的指导。</p><h1 id="387e" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">离别的思绪</h1><p id="2fdd" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated">Keras是一个用于深度学习的通用而灵活的库。它被成千上万的开发者使用，是一个巨大的开源项目。如果你发现了一个bug或者想要在Keras中实现一个特性，自己动手吧！没有什么比看着自己的代码被无数人使用更令人高兴的了。随着能够轻松构建Keras，每个人都有能力改进代码库，让Keras成为更好的产品。</p><h1 id="bb3b" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">参考</h1><p id="c875" class="pw-post-body-paragraph lp lq iq lr b ls lt jr lu lv lw ju lx ly lz ma mb mc md me mf mg mh mi mj mk ij bi translated"><em class="mq">【1】Greg Mattes关于StackOverflow的回答(</em><a class="ae kw" href="https://stackoverflow.com/questions/1622506/programming-definitions-what-exactly-is-building" rel="noopener ugc nofollow" target="_blank">)https://stack overflow . com/questions/1622506/programming-definitions-what-just-is-building</a><em class="mq">)</em></p><p id="e66e" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">[2]“Bazel——一个快速、可伸缩、多语言和可扩展的构建系统”(<a class="ae kw" href="https://bazel.build/" rel="noopener ugc nofollow" target="_blank">https://bazel.build/</a>)</p><p id="4ddc" class="pw-post-body-paragraph lp lq iq lr b ls ml jr lu lv mm ju lx ly mn ma mb mc mo me mf mg mp mi mj mk ij bi translated">[3] TPU研究云(<a class="ae kw" href="https://sites.research.google/trc/about/" rel="noopener ugc nofollow" target="_blank">https://sites.research.google/trc/about/</a>)</p></div></div>    
</body>
</html>