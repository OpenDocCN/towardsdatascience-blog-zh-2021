<html>
<head>
<title>Stop Using Pandas to Read/Write Data — This Alternative is 7 Times Faster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">停止使用Pandas来读/写数据—这种替代方案速度快7倍</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/stop-using-pandas-to-read-write-data-this-alternative-is-7-times-faster-893301633475?source=collection_archive---------3-----------------------#2021-10-22">https://towardsdatascience.com/stop-using-pandas-to-read-write-data-this-alternative-is-7-times-faster-893301633475?source=collection_archive---------3-----------------------#2021-10-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ecc7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">读取和写入CSV数据集的速度比熊猫快7倍</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/573748e1460d1447d204f8999208035d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d0_2HRWNWrl8NJH4eMN5Og.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">凯西·霍纳在<a class="ae ky" href="https://unsplash.com/s/photos/speed-of-light?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="9927" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我喜欢Python的熊猫图书馆。这是我分析、转换和预处理数据的首选方式。但是当读取和保存数据文件的时候，它是慢的。这是一个巨大的时间浪费，特别是如果你的数据集的大小是千兆字节。</p><p id="3296" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">想象一下，您想要查看存储在本地或云上的千兆字节的CSV数据。您将使用Pandas进行分析，尽管您知道在读取CSV文件时速度非常慢。因此，大部分时间都在等待读写操作完成。有更好的方法。</p><p id="9755" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它被称为py Arrow——Apache Arrow项目的一个惊人的Python绑定。它引入了更快的数据读/写时间，并且不会干扰您的数据分析管道。这是两全其美，因为你仍然可以使用熊猫进行进一步的计算。</p><p id="6163" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以将PyArrow与Pip和Anaconda一起安装:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="ed63" class="ma mb it lw b gy mc md l me mf">pip install pyarrow<br/>conda install -c conda-forge pyarrow</span></pre><p id="da40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">找视频版？你很幸运:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mg mh l"/></div></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="dcdb" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">让我们创建一个虚拟数据集</h1><p id="9404" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">让我们从库导入开始。今天你会需要很多:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="1e8a" class="ma mb it lw b gy mc md l me mf">import random<br/>import string<br/>import numpy as np<br/>import pandas as pd<br/>import pyarrow as pa<br/>import pyarrow.csv as csv<br/>from datetime import datetime</span></pre><p id="d152" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将创建一个有点大的数据集。它将包含大约1100万个日期、浮点和字符串值。日期信息完全是虚构的，以分钟为间隔从2000年到2021年。其他列也是完全随机的:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="b1ba" class="ma mb it lw b gy mc md l me mf">def gen_random_string(length: int = 32) -&gt; str:<br/>    return ''.join(random.choices(<br/>        string.ascii_uppercase + string.digits, k=length)<br/>    )<br/><br/>dt = pd.date_range(<br/>    start=datetime(2000, 1, 1),<br/>    end=datetime(2021, 1, 1),<br/>    freq='min'<br/>)<br/><br/>np.random.seed = 42<br/>df_size = len(dt)<br/>print(f'Dataset length: {df_size}')<br/><br/><br/>df = pd.DataFrame({<br/>    'date': dt,<br/>    'a': np.random.rand(df_size),<br/>    'b': np.random.rand(df_size),<br/>    'c': np.random.rand(df_size),<br/>    'd': np.random.rand(df_size),<br/>    'e': np.random.rand(df_size),<br/>    'str1': [gen_random_string() for x in range(df_size)],<br/>    'str2': [gen_random_string() for x in range(df_size)]<br/>})</span></pre><p id="6f10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它看起来是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/8e433564652c896950b963d816667904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hZTqgYv9txMkXMi_71aQjQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片1-虚拟数据集(作者提供的图片)</p></figure><p id="9e9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是11，046，241行混合数据类型，因此生成的CSV文件将非常庞大。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="e1df" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">用熊猫读/写CSV文件</h1><p id="eca9" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">我们将使用熊猫作为基线解决方案。如果像PyArrow这样的库不存在的话，你就会用到它。这一节只包含代码—您将在本文后面找到比较和图表。</p><p id="3dfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下代码将我们的数据集<code class="fe nm nn no lw b">df</code>保存到一个CSV文件:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="7e63" class="ma mb it lw b gy mc md l me mf">df.to_csv('csv_pandas.csv', index=False)</span></pre><p id="9ad2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你不在乎写速度，你可以节省一些磁盘空间。熊猫的<code class="fe nm nn no lw b">to_csv()</code>函数有一个可选参数<code class="fe nm nn no lw b">compression</code>。让我们看看如何使用它将数据集保存为<code class="fe nm nn no lw b">csv.gz</code>格式:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="4010" class="ma mb it lw b gy mc md l me mf">df.to_csv('csv_pandas.csv.gz', index=False, compression='gzip')</span></pre><p id="e3b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，您可以使用<code class="fe nm nn no lw b">read_csv()</code>功能阅读两个版本:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="8cf4" class="ma mb it lw b gy mc md l me mf">df1 = pd.read_csv('csv_pandas.csv')<br/>df2 = pd.read_csv('csv_pandas.csv.gz')</span></pre><p id="a36c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里没有什么新的或有趣的，但我想涵盖所有的基础。接下来看看PyArrow是怎么工作的。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="b53d" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">用PyArrow读/写CSV文件</h1><p id="10b6" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">关于PyArrow，您应该知道一件事——它不能处理日期时间列。您必须将<code class="fe nm nn no lw b">date</code>属性转换成时间戳。方法如下:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="69d6" class="ma mb it lw b gy mc md l me mf">df_pa = df.copy()<br/>df_pa['date'] = df_pa['date'].values.astype(np.int64) // 10 ** 9</span></pre><p id="0c62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是数据集更改后的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/b8b162d9c3569d83c9f701c6100fd3f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zyIwcbYAfpwYzwMj1LYTYw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图2 —时间戳转换后的虚拟数据集(图片由作者提供)</p></figure><p id="efca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还是同样的信息，只是呈现方式不同。现在可以将DataFrame转换为PyArrow表。这是将数据集转储到磁盘之前的一个必要步骤:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="66cc" class="ma mb it lw b gy mc md l me mf">df_pa_table = pa.Table.from_pandas(df_pa)</span></pre><p id="2cc2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的机器(M1 MacBook Pro)上，转换需要1.52秒，并且将被包含到比较图表中。</p><p id="da71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用PyArrow的<code class="fe nm nn no lw b">csv.write_csv()</code>函数转储数据集:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="a537" class="ma mb it lw b gy mc md l me mf">csv.write_csv(df_pa_table, 'csv_pyarrow.csv')</span></pre><p id="3677" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加压缩需要更多的代码:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="4465" class="ma mb it lw b gy mc md l me mf">with pa.CompressedOutputStream('csv_pyarrow.csv.gz', 'gzip') as out:<br/>    csv.write_csv(df_pa_table, out)</span></pre><p id="70b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用<code class="fe nm nn no lw b">csv.read_csv()</code>功能读取压缩和未压缩的数据集:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="06b2" class="ma mb it lw b gy mc md l me mf">df_pa_1 = csv.read_csv('csv_pyarrow.csv')<br/>df_pa_2 = csv.read_csv('csv_pyarrow.csv.gz')</span></pre><p id="ec60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">两者都将以<code class="fe nm nn no lw b">pyarrow.Table</code>格式读取，所以使用下面的命令将它们转换成Pandas数据帧:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="56bc" class="ma mb it lw b gy mc md l me mf">df_pa_1 = df_pa_1.to_pandas()</span></pre><p id="db63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是你今天应该知道的。让我们看看这些在性能上的比较。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="2ee1" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">熊猫和皮阿罗——你应该用哪一个？</h1><p id="7476" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">如果你的数据很大，每次都用PyArrow。就这么简单。原因如下。</p><p id="5032" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图显示了使用Pandas和PyArrow保存数据帧所需的时间，包括未压缩版本和压缩版本:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/18bb173b6dc9481778424f1be6520b20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E4vGiPYbPR_dTstpCvTvpQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3 —熊猫vs. PyArrow以秒为单位节省时间(熊猫CSV:54.5；熊猫CSV。GZ: 182人；py arrow CSV:7.76；皮阿罗CSV。GZ: 84)(图片由作者提供)</p></figure><p id="75eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">未压缩文件的速度提高了约7倍，压缩文件的速度提高了约2倍。我知道会发生什么，我仍然印象深刻。</p><p id="dd7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，让我们比较一下读取时间——读取熊猫和PyArrow的CSV文件需要多长时间:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/cca9176b961c9d26528417d71a500485.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Umei4AFwxn3F1aEwxJJkXw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4 —熊猫vs. PyArrow阅读时间(秒)(熊猫CSV:17.8；熊猫CSV。GZ: 28名；py arrow CSV:2.44；皮阿罗CSV。GZ: 9.09分)(图片由作者提供)</p></figure><p id="2efe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们获得了类似的性能提升——未压缩数据集约为7倍，压缩数据集约为3倍。我说不出话来。看在上帝的份上，这是相同的文件格式。</p><p id="8213" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，让我们看看文件大小有什么不同。这两个库之间应该存在任何差异:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/8715df09273690aaae4e59cfb89a8bf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w5jeST1VclJ4CzGNVi1YoQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图5 — Pandas与PyArrow文件大小(GB)(Pandas CSV:2.01；熊猫CSV。GZ:1.12；py arrow CSV:1.96；皮阿罗CSV。GZ: 1.13)(图片由作者提供)</p></figure><p id="8145" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在未压缩版本中略有不同，但这可能是因为我们用Pandas存储datetime对象，用PyArrow存储integers。不出所料，没什么值得大书特书的。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="2348" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">结论</h1><p id="0950" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">总而言之，如果你的应用程序经常从磁盘上保存/加载数据，那么把这些操作交给PyArrow是一个明智的决定。见鬼，对于相同的文件格式，速度快了7倍。想象一下，我们引入了<a class="ae ky" rel="noopener" target="_blank" href="/csv-files-for-storage-no-thanks-theres-a-better-option-72c78a414d1d">拼花</a>文件格式。这是下一篇文章将要讨论的内容。</p><p id="5a0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你对皮阿罗有什么看法？日常使用中有没有遇到什么痛点？请在下面的评论区分享你的想法。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><p id="f74a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">喜欢这篇文章吗？成为 <a class="ae ky" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="nt">中等会员</em> </a> <em class="nt">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="nu nv gp gr nw nx"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd iu gy z fp oc fr fs od fu fw is bi translated">通过我的推荐链接加入Medium-Dario rade ci</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">medium.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol ks nx"/></div></div></a></div></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="473d" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">保持联系</h1><ul class=""><li id="19f6" class="om on it lb b lc ng lf nh li oo lm op lq oq lu or os ot ou bi translated">注册我的<a class="ae ky" href="https://mailchi.mp/46a3d2989d9b/bdssubscribe" rel="noopener ugc nofollow" target="_blank">简讯</a></li><li id="ec9a" class="om on it lb b lc ov lf ow li ox lm oy lq oz lu or os ot ou bi translated">在YouTube<a class="ae ky" href="https://www.youtube.com/c/BetterDataScience" rel="noopener ugc nofollow" target="_blank">上订阅</a></li><li id="a70c" class="om on it lb b lc ov lf ow li ox lm oy lq oz lu or os ot ou bi translated">在<a class="ae ky" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li></ul></div></div>    
</body>
</html>