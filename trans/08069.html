<html>
<head>
<title>DataOps Automation — Creating Azure Data Factory with git integration using Bicep</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DataOps自动化——使用Bicep创建与git集成的Azure数据工厂</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/dataops-automation-creating-azure-data-factory-with-git-integration-using-bicep-376fd3b5bc81?source=collection_archive---------10-----------------------#2021-07-24">https://towardsdatascience.com/dataops-automation-creating-azure-data-factory-with-git-integration-using-bicep-376fd3b5bc81?source=collection_archive---------10-----------------------#2021-07-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="3bf1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Azure Data Factory的一个重要特性是git集成，它允许我们将Azure Data Factory工件置于源代码控制之下。这是在以后实现持续集成和交付的必要步骤，那么为什么不用Bicep以完全自动化的方式将基础设施作为代码来配置呢？</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/cf864897a6c4c88475efea104e5f2b07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HzDcdeTCGa9vVDuUQulXAQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者准备的图像</p></figure><p id="13b1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在微软官方文档中有一个很好的主题，解释了如何通过Azure门户将Azure数据工厂与git集成。在这篇文章中，我将解释如何使用Bicep(Azure的新IaC语言)来实现这一点，以便将这一步包含到您的CI/CD流程中，以及如何只在需要的环境中部署。</p><h1 id="3aa2" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">Azure数据工厂Git集成</h1><p id="f969" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">好的，但是为什么我需要在ADF上使用git呢？为了解释这一点，我将列出git集成提供的一些优势，摘自<a class="ae le" href="https://docs.microsoft.com/en-us/azure/data-factory/source-control#advantages-of-git-integration" rel="noopener ugc nofollow" target="_blank">微软的文档</a>:</p><h2 id="188b" class="mi lg it bd lh mj mk dn ll ml mm dp lp kb mn mo lt kf mp mq lx kj mr ms mb mt bi translated"><strong class="ak">源码控制</strong></h2><p id="065f" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">随着您的数据工厂工作负载变得至关重要，您可能希望将您的工厂与Git集成，以利用如下几个源代码控制优势:</p><ul class=""><li id="c486" class="mu mv it js b jt ju jx jy kb mw kf mx kj my kn mz na nb nc bi translated">跟踪/审计变更的能力。</li><li id="5655" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn mz na nb nc bi translated">能够恢复引入错误的更改。</li></ul><h2 id="9285" class="mi lg it bd lh mj mk dn ll ml mm dp lp kb mn mo lt kf mp mq lx kj mr ms mb mt bi translated"><strong class="ak">部分保存</strong></h2><p id="4797" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">针对数据工厂服务进行创作时，不能将更改保存为草稿，所有发布都必须通过数据工厂验证。无论您的管道没有完成，或者您只是不想在计算机崩溃时丢失更改，git集成都允许数据工厂资源的增量更改，而不管它们处于什么状态。配置git存储库允许您保存更改，仅当您测试了您满意的更改后才发布。</p><h2 id="4dd7" class="mi lg it bd lh mj mk dn ll ml mm dp lp kb mn mo lt kf mp mq lx kj mr ms mb mt bi translated">协作和控制</h2><p id="823d" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">如果您有多个团队成员为同一个工厂工作，您可能希望让您的团队成员通过代码审查过程相互协作。您还可以设置您的工厂，这样不是每个贡献者都有相同的权限。一些团队成员可能只被允许通过Git进行更改，只有团队中的某些人被允许将更改发布到工厂。</p><h2 id="0517" class="mi lg it bd lh mj mk dn ll ml mm dp lp kb mn mo lt kf mp mq lx kj mr ms mb mt bi translated">更好的CI/CD</h2><p id="d1df" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">如果您正在使用<a class="ae le" href="https://docs.microsoft.com/en-us/azure/data-factory/continuous-integration-deployment" rel="noopener ugc nofollow" target="_blank">连续交付流程</a>部署到多个环境中，git集成使得某些操作变得更加容易。这些行动包括:</p><ul class=""><li id="df28" class="mu mv it js b jt ju jx jy kb mw kf mx kj my kn mz na nb nc bi translated">将您的发布管道配置为在您的“开发”工厂发生任何更改时自动触发。</li><li id="64d2" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn mz na nb nc bi translated">定制工厂中可作为资源管理器模板中的参数的属性。只保留所需的一组属性作为参数，并对其他所有内容进行硬编码是非常有用的。</li></ul><h2 id="d89a" class="mi lg it bd lh mj mk dn ll ml mm dp lp kb mn mo lt kf mp mq lx kj mr ms mb mt bi translated">更好的性能</h2><p id="02e1" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">一个集成git的普通工厂的加载速度比一个针对数据工厂服务的创作快10倍。这种性能改进是因为资源是通过Git下载的。</p><h1 id="b158" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">Git集成仅适用于开发环境</h1><p id="65b6" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">微软推荐了两个流程来在ADF上执行CI/CD，(你可以在<a class="ae le" rel="noopener" target="_blank" href="/azure-data-factory-ci-cd-made-simple-building-and-deploying-your-arm-templates-with-azure-devops-30c30595afa5">这篇文章</a>上查看)，在这两种情况下，开发仅发生在开发数据工厂工作区中，并且工件通过CI/CD部署来提升。这意味着我们不应该为非开发环境(如UAT或生产环境)创建这种集成。我还将介绍如何识别环境并为您的开发环境创建集成:)</p><h1 id="5179" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">逐步为Azure数据工厂创建Bicep模板</h1><p id="9459" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">为了使解释简单，我将展示二头肌文件的每个阶段。每个阶段都是一个可部署的文件，您可以使用命令单独执行</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="02b4" class="mi lg it nj b gy nn no l np nq"><em class="nr">az deployment group create -f &lt;your file&gt;.bicep -g &lt;your resource group&gt;</em></span></pre><p id="cb4e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，我们将有完整的文件可供使用。</p><h2 id="c5be" class="mi lg it bd lh mj mk dn ll ml mm dp lp kb mn mo lt kf mp mq lx kj mr ms mb mt bi translated">创建数据工厂工作空间</h2><p id="5f1b" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">在第一阶段，我们只创建具有最基本配置的工作区。您可以看到，对于位置，我们使用的是执行此部署的资源组的位置。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h2 id="7ed3" class="mi lg it bd lh mj mk dn ll ml mm dp lp kb mn mo lt kf mp mq lx kj mr ms mb mt bi translated">链接GitHub和Azure数据工厂</h2><p id="e30f" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">在这个阶段，我们实现了这篇文章的第一个目标:创建<strong class="js iu"> git集成。</strong>我包含了与GitHub repo连接所需的参数，然后是“属性”部分。现在让我们检查参数:</p><ol class=""><li id="8e88" class="mu mv it js b jt ju jx jy kb mw kf mx kj my kn nu na nb nc bi translated"><strong class="js iu">帐户名</strong> - <strong class="js iu"> </strong>这是你的GitHub/Azure DevOps帐户名。</li><li id="8d0d" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nu na nb nc bi translated"><strong class="js iu"> repositoryName </strong> -你的存储库的名称，注意开头不需要你的帐户名。</li><li id="70cd" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nu na nb nc bi translated"><strong class="js iu"> collaborationBranc </strong> -将用于集成您的特性分支的分支。这将取决于你的分支策略。对于git流应该是开发分支，对于GitHub流应该是主/主。</li><li id="4d08" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nu na nb nc bi translated"><strong class="js iu">root folder</strong>——您的repo中的文件夹，databricks工件将在其中进行版本控制。</li><li id="8611" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nu na nb nc bi translated"><strong class="js iu"> projectName </strong> -该参数仅用于Azure DevOps。这是您的repo的团队项目名称。</li><li id="06b8" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nu na nb nc bi translated"><strong class="js iu">类型</strong>——这个参数定义你的回购是托管在GitHub还是Azure DevOps上。对于GitHub，该值必须为:</li></ol><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="489c" class="mi lg it nj b gy nn no l np nq">FactoryGitHubConfiguration</span></pre><p id="e3e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于Azure Devops，该值为:</p><pre class="kp kq kr ks gt ni nj nk nl aw nm bi"><span id="1aad" class="mi lg it nj b gy nn no l np nq">FactoryVSTSConfiguration</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/e7fb5d1ed0f76131e3f8c7e8059cf839.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*kPiiBIbO9dRU8xDRdSdOmg.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者准备的图像</p></figure><h2 id="ce6f" class="mi lg it bd lh mj mk dn ll ml mm dp lp kb mn mo lt kf mp mq lx kj mr ms mb mt bi translated">检查环境</h2><p id="705c" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">如上所述，我们必须只在开发环境中创建git集成。如果你只使用GitHub或者Azure DevOps，这个阶段对你的场景应该足够了。要检查这一点，我们需要以下步骤:</p><ol class=""><li id="57b0" class="mu mv it js b jt ju jx jy kb mw kf mx kj my kn nu na nb nc bi translated">一个环境参数。</li><li id="b27f" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nu na nb nc bi translated">将<strong class="js iu"> repoConfiguration </strong>的内容提取到外部变量。</li><li id="e615" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nu na nb nc bi translated">使用三元if来检查提供的环境是否是开发。如果是，则使用该变量，如果不是，则使用空组。</li></ol><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nw"><img src="../Images/a6b21d4efb5b3828b6c10d65def6214e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sR-iArVHnrubuSbaaH4a4A.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者准备的图像</p></figure><p id="25a8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个阶段的二头肌锉刀:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h2 id="1900" class="mi lg it bd lh mj mk dn ll ml mm dp lp kb mn mo lt kf mp mq lx kj mr ms mb mt bi translated">将GitHub或Azure DevOps链接到Azure数据工厂</h2><p id="6d92" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">如果在你的场景中你既有Azure DevOps又有GitHub，你可以准备你的模板来支持它。这个模板更加灵活，可以用在更多的场合。让我们检查一下与上一个的不同之处:</p><ol class=""><li id="d708" class="mu mv it js b jt ju jx jy kb mw kf mx kj my kn nu na nb nc bi translated">包括一个“用户友好的”参数来指示回购的类型。</li><li id="1bb7" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nu na nb nc bi translated">检查类型参数并创建一个具有预期值的变量。</li><li id="3955" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nu na nb nc bi translated">创建两个配置，一个用于GitHub，一个用于Azure DevOps。</li><li id="a12d" class="mu mv it js b jt nd jx ne kb nf kf ng kj nh kn nu na nb nc bi translated">如果嵌套在第一个三元组中，则包含另一个三元组</li></ol><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nx"><img src="../Images/a5b71cd38a0fcf01e0c3c4b95d7a838f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*axZ5TeO8PChLhDkzhOEbhA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">作者准备的图像</p></figure><p id="7ab9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面你可以查看最终的二头肌模板:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h1 id="1785" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">现实生活中的例子</h1><p id="d465" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">为了在更现实的情况下检查这些例子，我一直在GitHub的一个存储库中工作，使用管道配置和工作的例子。你可以在DevOps Nights GitHub这里查看:【github.com】DevOps Nights/azuredevops-YAML-quick start-templates</p><p id="6385" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<a class="ae le" rel="noopener" target="_blank" href="/azure-data-factory-ci-cd-made-simple-building-and-deploying-your-arm-templates-with-azure-devops-30c30595afa5">这篇文章</a>中，我展示了如何将这个二头肌模板用于Azure DevOps管道。</p><p id="e1cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我希望这篇文章能帮助你以更自动化的方式创建你的ADF，下一篇文章再见！</p><h2 id="84fa" class="mi lg it bd lh mj mk dn ll ml mm dp lp kb mn mo lt kf mp mq lx kj mr ms mb mt bi translated">参考</h2><p id="1f69" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated"><a class="ae le" href="https://docs.microsoft.com/en-us/azure/data-factory/source-control#advantages-of-git-integration" rel="noopener ugc nofollow" target="_blank">源代码管理— Azure数据工厂|微软文档</a></p><p id="6f13" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae le" href="https://docs.microsoft.com/en-us/rest/api/datafactory/factories/configure-factory-repo#factoryvstsconfiguration" rel="noopener ugc nofollow" target="_blank">工厂—配置工厂回购— REST API (Azure数据工厂)|微软文档</a></p><p id="5055" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae le" href="https://docs.microsoft.com/en-us/azure/templates/microsoft.datafactory/factories?tabs=json" rel="noopener ugc nofollow" target="_blank">Microsoft.DataFactory/factories 2018–06–01—ARM模板参考|微软文档</a></p></div></div>    
</body>
</html>