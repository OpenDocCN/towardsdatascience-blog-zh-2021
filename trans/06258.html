<html>
<head>
<title>Including R in your Flat Data Workflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在平面数据工作流中包含R</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/including-r-in-your-flat-data-workflow-282356342094?source=collection_archive---------36-----------------------#2021-06-04">https://towardsdatascience.com/including-r-in-your-flat-data-workflow-282356342094?source=collection_archive---------36-----------------------#2021-06-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="85b1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用GitHub Actions + R自动获取和清理数据</h2></div><p id="00f1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">GitHub OCTO团队最近发布了他们的第一个项目:<a class="ae le" href="https://octo.github.com/projects/flat-data" rel="noopener ugc nofollow" target="_blank"> <strong class="kk iu">平面数据</strong> </a>。该项目旨在提供“一种简单的模式，将工作数据集引入您的存储库并对它们进行版本控制。”它成功地做到了！我最近将平面数据合并到我的项目之一<a class="ae le" href="https://github.com/connorrothschild/police-killings" rel="noopener ugc nofollow" target="_blank">中，允许我最终停止半定期地手动更新数据(哎呀！).工作时，我找不到任何关于使用R处理平面数据的文档。在这里，我将解释我将R脚本合并到平面数据管道中所采取的步骤。</a></p><blockquote class="lf lg lh"><p id="4ebb" class="ki kj li kk b kl km ju kn ko kp jx kq lj ks kt ku lk kw kx ky ll la lb lc ld im bi translated"><strong class="kk iu">注:</strong>如果你想跟随，GitHub repo可以在<a class="ae le" href="https://github.com/connorrothschild/flat-demo-r-processing/" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></blockquote><h1 id="f04b" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">什么是平面数据？</h1><p id="188b" class="pw-post-body-paragraph ki kj it kk b kl me ju kn ko mf jx kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated"><a class="ae le" href="https://octo.github.com/projects/flat-data" rel="noopener ugc nofollow" target="_blank">平面数据</a>解决了执行相同的重复任务——检索、清理、然后重新发布数据——的问题，这通常会影响希望呈现快速更新数据(例如，每天更新的新冠肺炎数据)的开发人员。尽管存在替代解决方案，但是平面数据简单、直观，并且可以直接与您的GitHub存储库集成:</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/694e9813e6146e7d3847fd1128c5f8dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XL3viTlICIxMDx4pR6xSxw.png"/></div></div><p class="mv mw gj gh gi mx my bd b be z dk translated">GitHub平面数据工作流程。图片via <a class="ae le" href="https://octo.github.com/projects/flat-data" rel="noopener ugc nofollow" target="_blank"> GitHub Octo </a>。</p></figure><p id="03f1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如上所述，这个想法本质上是读入数据(<em class="li"> data.json </em>)，进行一些后处理(<em class="li"> process.js </em>)，并输出一些更好的数据(<em class="li"> processed-data.json </em>)。</p><h1 id="4e3a" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">在R中做</h1><p id="c720" class="pw-post-body-paragraph ki kj it kk b kl me ju kn ko mf jx kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">平面数据项目最重要的步骤是<em class="li">后处理</em>。这发生在数据检索之后的<strong class="kk iu">和数据输出</strong>之前的<strong class="kk iu">，并且可以用几种不同的语言来完成。默认情况下，OCTO团队的<a class="ae le" href="https://github.com/githubocto/flat-postprocessing/tree/main/examples" rel="noopener ugc nofollow" target="_blank">示例</a>是用JavaScript/TypeScript完成的，一位用户已经给出了用<a class="ae le" href="https://github.com/pierrotsmnrd/flat_data_py_example" rel="noopener ugc nofollow" target="_blank"> Python </a>进行后处理的示例。然而，据我所知，还没有任何在后处理阶段包含R的例子，这就是这篇文章的原因！</strong></p><p id="b4ca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">在平面数据管道中使用R非常简单，只需安装必要的软件包，然后从后处理类型脚本文件中获取R清理脚本。让我们探索一下它是如何工作的。</strong></p><p id="098b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将从<a class="ae le" href="https://mappingpoliceviolence.org/" rel="noopener ugc nofollow" target="_blank">警察暴力地图</a>主页上获取数据，整理后重新发布。(这些经过清理的数据是我对警察暴力进行可视化的来源。)下面是最终的<a class="ae le" href="https://flatgithub.com/connorrothschild/flat-demo-r-processing?filename=output.csv&amp;sha=61df289b127a70513b334d686de65ed79ce48a96" rel="noopener ugc nofollow" target="_blank">数据输出</a>。</p><h1 id="be6d" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">01.设置<code class="fe mz na nb nc b">flat.yml</code></h1><p id="747f" class="pw-post-body-paragraph ki kj it kk b kl me ju kn ko mf jx kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">任何平面数据管道的第一步都是创建<code class="fe mz na nb nc b">.github/workflows/flat.yml</code>，它将包含项目的配置。你可以通过使用GitHub的<a class="ae le" href="https://marketplace.visualstudio.com/items?itemName=GitHubOCTO.flat" rel="noopener ugc nofollow" target="_blank"> VSCode扩展</a>或者手动创建你自己的YAML文件来实现。我们在这个项目中使用的YAML文件与<a class="ae le" href="https://github.com/marketplace/actions/flat-data" rel="noopener ugc nofollow" target="_blank">样板文件</a>非常相似，但有一些不同:</p><pre class="mk ml mm mn gt nd nc ne nf aw ng bi"><span id="025d" class="nh ln it nc b gy ni nj l nk nl">name: Update data<br/>on:<br/>  schedule:<br/>    - cron: 0 0 * * * # Runs daily. See https://crontab.cronhub.io/<br/>  workflow_dispatch: {}<br/>  push:<br/>    branches:<br/>      - main # Or master, or whatever branch you'd like to 'watch'<br/>jobs:<br/>  scheduled:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      # This step installs Deno, which is a Javascript runtime<br/>      - name: Setup deno<br/>        uses: denoland/setup-deno@main<br/>        with:<br/>          deno-version: v1.x<br/>      # Check out the repository so it can read the files inside of it and do other operations<br/>      - name: Check out repo<br/>        uses: actions/checkout@v2<br/>      # The Flat Action step<br/>      - name: Fetch data<br/>        uses: githubocto/flat@v2<br/>        with:<br/>          http_url: https://mappingpoliceviolence.org/s/MPVDatasetDownload.xlsx # File to download<br/>          downloaded_filename: raw.xlsx # Name of downloaded file<br/>          postprocess: ./postprocess.ts # Runs upon completion</span></pre><p id="d5f5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可能会在<code class="fe mz na nb nc b">http_url</code>和<code class="fe mz na nb nc b">schedule</code>中对这个工作流程进行调整。要确认这一点，请访问GitHub的<a class="ae le" href="https://github.com/marketplace/actions/flat-data" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="6db4" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">02.后处理</h1><p id="f443" class="pw-post-body-paragraph ki kj it kk b kl me ju kn ko mf jx kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">我们从上一部分的最后一行代码开始:</p><pre class="mk ml mm mn gt nd nc ne nf aw ng bi"><span id="4539" class="nh ln it nc b gy ni nj l nk nl">postprocess: ./postprocess.ts</span></pre><p id="0c96" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里，我们引用一个名为<code class="fe mz na nb nc b">postprocess.ts</code>的打字稿文件。数据下载完成后，GitHub将运行<em class="li">该脚本</em>进行任何额外的处理步骤。该文件必须是<code class="fe mz na nb nc b">.js</code>或<code class="fe mz na nb nc b">.ts</code>文件。</p><p id="f6ac" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那些擅长用JavaScript处理数据的人也许能够在JavaScript本身中编写他们的额外处理<em class="li"/>，但是我们中很少有人擅长用JavaScript处理数据。此外，一些用户希望将他们现有的项目和工作流迁移到平面数据，因此包含JavaScript之外的语言(在本例中是R)是非常必要的。</p><p id="4fc0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我在工作流程中使用的<code class="fe mz na nb nc b">postprocess.ts</code>文件如下所示(这可能有助于了解<a class="ae le" href="https://deno.land/manual@v1.10.2/examples/subprocess" rel="noopener ugc nofollow" target="_blank"> Deno如何工作</a>):</p><pre class="mk ml mm mn gt nd nc ne nf aw ng bi"><span id="086f" class="nh ln it nc b gy ni nj l nk nl">// 1. Install necessary packages<br/>const r_install = Deno.run({<br/>    cmd: ['sudo', 'Rscript', '-e', "install.packages(c('dplyr', 'readxl', 'readr', 'lubridate', 'stringr'))"]<br/>});<br/><br/>await r_install.status();<br/><br/>// 2. Forward the execution to the R script<br/>const r_run = Deno.run({<br/>    cmd: ['Rscript', './clean.R']<br/>});<br/><br/>await r_run.status();</span></pre><p id="4b1b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的脚本相当简单:它1)安装包，2)运行处理脚本，标题为<code class="fe mz na nb nc b">clean.R</code>。</p><p id="be47" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一步很重要。在建立这个工作流程时，包管理是我遇到的最大问题；如果你有问题，请注意这一步。您需要识别R处理脚本中需要的所有包，但是由于虚拟机权限，您不能在脚本本身中安装这些包<em class="li">。相反，你必须通过命令行运行它们，使用<code class="fe mz na nb nc b">sudo Rscript -e</code>，就像我上面做的那样(在步骤1中)。</em></p><p id="b78e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">命令<code class="fe mz na nb nc b">sudo Rscript -e</code>位于R脚本中运行的任何常规函数或命令之前。它通过命令行执行这些命令，而不是在脚本中。(我们添加sudo是为了克服系统用户权限问题。)更多内容，见<a class="ae le" href="https://stackoverflow.com/questions/18306362/run-r-script-from-command-line" rel="noopener ugc nofollow" target="_blank">本页</a>。</p><h1 id="124a" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">03.清理数据！</h1><p id="9994" class="pw-post-body-paragraph ki kj it kk b kl me ju kn ko mf jx kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">我的<code class="fe mz na nb nc b">clean.R</code>脚本是这样的，我在<code class="fe mz na nb nc b">postprocess.ts</code>的底部引用了它:</p><pre class="mk ml mm mn gt nd nc ne nf aw ng bi"><span id="d5a0" class="nh ln it nc b gy ni nj l nk nl"># Load libraries<br/>library(dplyr)<br/>library(stringr)<br/><br/># Read in data, with the same name that we specified in `flat.yml`<br/>raw_data &lt;- readxl::read_excel("./raw.xlsx")<br/><br/># All the processing!<br/>clean_data &lt;- raw_data %&gt;% <br/>  rename("Date" = `Date of Incident (month/day/year)`,<br/>         "Link" = `Link to news article or photo of official document`,<br/>         "Armed Status" = `Armed/Unarmed Status`, <br/>         "Age" = `Victim's age` , <br/>         "Race" = `Victim's race`, <br/>         "Sex" = `Victim's gender`, <br/>         "Image" = `URL of image of victim`, <br/>         "Name" = `Victim's name`) %&gt;% <br/>  mutate(Zipcode = as.character(Zipcode),<br/>         Year = lubridate::year(Date),<br/>         Sex = ifelse(is.na(Sex), 'Unknown', Sex)) %&gt;% <br/>  arrange(Date)<br/><br/>### Additional processing goes here...<br/><br/># Output data<br/>readr::write_csv(clean_data, "./output.csv")</span></pre><p id="03e4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">显然，上述清理脚本中的内容无关紧要。它的功能和其他R脚本一样:它读入数据(基于我们在<code class="fe mz na nb nc b">postprocess.ts</code>中下载的数据)，做一些清理，然后输出新数据。<a class="ae le" href="https://github.com/connorrothschild/flat-demo-r-processing/blob/master/clean.R" rel="noopener ugc nofollow" target="_blank">真实剧本</a>大概55行左右。现在你知道为什么把后处理放在R中更好了！</p><h1 id="babc" class="lm ln it bd lo lp lq lr ls lt lu lv lw jz lx ka ly kc lz kd ma kf mb kg mc md bi translated">总而言之</h1><p id="509e" class="pw-post-body-paragraph ki kj it kk b kl me ju kn ko mf jx kq kr mg kt ku kv mh kx ky kz mi lb lc ld im bi translated">在完成这些步骤并将上述内容推送到存储库后，GitHub将自动设置动作并每天运行它。然后，您可以在<strong class="kk iu">动作</strong>选项卡中检查每次运行的日志。该选项卡将有助于调试，您也可以在这里手动强制执行工作流。总之，执行GitHub平面数据工作流的过程，加上一个R后处理脚本，看起来像这样:</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nm"><img src="../Images/df1fa4012f6fc7a6e88a33bd33b0857e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aSlhfJEHa5ZcnD_9mDvOuA.png"/></div></div><p class="mv mw gj gh gi mx my bd b be z dk translated">GitHub平面数据工作流，包括用于后处理的R脚本。图片作者。</p></figure><p id="ddcb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢阅读！你可以通过阅读这篇文章附带的<a class="ae le" href="https://github.com/connorrothschild/flat-demo-r-processing" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>了解更多；否则，请通过<a class="ae le" href="https://twitter.com/CL_Rothschild" rel="noopener ugc nofollow" target="_blank"> Twitter </a>发送任何问题🙂</p></div><div class="ab cl nn no hx np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="im in io ip iq"><p id="b67e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="li">原载于</em> <a class="ae le" href="https://www.connorrothschild.com/post/flat-data-r" rel="noopener ugc nofollow" target="_blank"> <em class="li">我的博客</em> </a> <em class="li">。</em></p></div></div>    
</body>
</html>