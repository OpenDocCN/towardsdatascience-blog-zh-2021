<html>
<head>
<title>Native Sessionization In Apache Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Spark中的本机会话化</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/native-sessionization-in-apache-spark-624883a8a9e2?source=collection_archive---------10-----------------------#2021-10-03">https://towardsdatascience.com/native-sessionization-in-apache-spark-624883a8a9e2?source=collection_archive---------10-----------------------#2021-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b6ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Spark 3.2.0的下一个版本中，在许多新特性中，有一个将使我们在使用Spark结构化流解决<em class="kl">会话化</em>问题时变得更加容易。</p><p id="0a18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在进入细节之前，让我们澄清一些流概念，如<em class="kl">窗口。</em></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/13bbd51df147e995d9f256a9c17138fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*owAfNFCPP-WMBMy0k4S_ng.jpeg"/></div></div><p class="ky kz gj gh gi la lb bd b be z dk translated">照片由<a class="ae lc" href="https://unsplash.com/@lucabravo?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">卢卡·布拉沃</a>在<a class="ae lc" href="https://unsplash.com/s/photos/windows?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="067f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当你向窗外看时，你只能看到陆地的一部分，而不能看到全部。这里是一样的🤓</p><p id="feac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在流式传输中，由于数据流是无限的，所以我们不能尝试使用批处理方法对数据进行分组，这也没有意义。</p><blockquote class="ld"><p id="0791" class="le lf iq bd lg lh li lj lk ll lm kk dk translated">那么，你是如何分组的呢？</p></blockquote><p id="fc0c" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">窗口、窗口和窗口。</p><p id="6703" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Windows将数据流分成有限大小的“块”，我们可以在这些块上进行计算。如前所述，没有他们，这是不可能的。</p><p id="076c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最常见的窗口类型是<em class="kl">翻转窗口、滑动窗口、</em>和<strong class="jp ir"> <em class="kl">会话窗口。</em>T15】</strong></p><p id="76aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以想象，在这篇文章中，我们将讨论后者。</p><blockquote class="ls lt lu"><p id="dbcd" class="jn jo kl jp b jq jr js jt ju jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj kk ij bi translated"><strong class="jp ir">会话窗口</strong></p></blockquote><p id="e0ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">会话窗口捕获数据中的一段活动时间，该时间因<strong class="jp ir">非活动间隙</strong>而终止。与<em class="kl">翻滚</em>和<em class="kl">滑动</em>窗口相反，它们没有重叠，也没有固定的开始和结束时间。</p><p id="28cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">非活动间隙将用于关闭当前会话，并且以下事件将被分配给新会话。</p><p id="737b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为会话的一个例子，考虑在您最喜欢的音乐提供商那里听音乐。</p><p id="3b2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦您播放了第一首歌曲，将为您的用户创建一个会话窗口，这个会话将在一段时间(比如10分钟)不活动后结束。</p><p id="0f57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着，如果你只听一首歌，窗口将在10分钟后关闭，但如果你继续听更多的歌曲，窗口不会关闭，直到达到不活动的时期。</p><p id="ad89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当研究用户在特定时间段内参与某项活动时，它们在数据分析中特别有用。</p><blockquote class="ld"><p id="cd07" class="le lf iq bd lg lh li lj lk ll lm kk dk translated">如何在Spark&lt; 3.2.0</p></blockquote><p id="4cae" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">This would be too long to cover 😩, and there are great posts about it, as a hint search for <em class="kl">flatMapGroupsWithState中创建会话窗口？</em></p><blockquote class="ld"><p id="f271" class="le lf iq bd lg lh li lj lk ll lm kk dk translated">如何在Spark ≥3.2.0中创建会话窗口</p></blockquote><p id="8462" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">这正是你在这里的原因，今天是你的幸运日，因为它们比以前简单多了，简单多了🎉。</p><p id="8667" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你需要定义的只是你的时间列(必须是<em class="kl"> TimestampType) </em>和不活动的间隙。</p><pre class="kn ko kp kq gt ly lz ma mb aw mc bi"><span id="023e" class="md me iq lz b gy mf mg l mh mi">def session_window(timeColumn: Column, gapDuration: String)</span></pre><p id="71da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们举个简单的例子。</p><blockquote class="ls lt lu"><p id="3158" class="jn jo kl jp b jq jr js jt ju jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj kk ij bi translated">输入数据:</p></blockquote><pre class="kn ko kp kq gt ly lz ma mb aw mc bi"><span id="14f9" class="md me iq lz b gy mf mg l mh mi">{"time":"2021-10-03 19:39:34", "user_id":"a"} - first event<br/>{"time":"2021-10-03 19:39:41", "user_id":"a"} - gap &lt; 10 seconds<br/>{"time":"2021-10-03 19:39:42", "user_id":"a"} - gap &lt; 10 seconds<br/>{"time":"2021-10-03 19:39:49", "user_id":"a"} - gap &lt; 10 seconds<br/>{"time":"2021-10-03 19:40:03", "user_id":"a"} - <strong class="lz ir">gap &gt; 10 seconds</strong></span></pre><blockquote class="ls lt lu"><p id="92a8" class="jn jo kl jp b jq jr js jt ju jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj kk ij bi translated">让我们使用会话窗口对这些数据进行分组:</p></blockquote><pre class="kn ko kp kq gt ly lz ma mb aw mc bi"><span id="05cd" class="md me iq lz b gy mf mg l mh mi">val sessionDF = df<br/>    .groupBy(<em class="kl">session_window</em>('time, "10 seconds"), 'user_id)<br/>    .count</span></pre><p id="581d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简单对吗？😭</p><blockquote class="ls lt lu"><p id="5d76" class="jn jo kl jp b jq jr js jt ju jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj kk ij bi translated">输出:</p></blockquote><pre class="kn ko kp kq gt ly lz ma mb aw mc bi"><span id="386f" class="md me iq lz b gy mf mg l mh mi">+------------------------------------------+-------+-----+<br/>|session_window                            |user_id|count|<br/>+------------------------------------------+-------+-----+<br/>|{2021-10-03 19:39:34, 2021-10-03 19:39:59}|a      |4    |<br/>+------------------------------------------+-------+-----+</span></pre><p id="fd46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，我们有4个事件落在第一个会话窗口中，因为非活动期始终小于10秒。第五个事件将出现在该用户的下一个会话窗口中，因为活动间隔大于10秒。</p><h2 id="3818" class="md me iq bd mj mk ml dn mm mn mo dp mp jy mq mr ms kc mt mu mv kg mw mx my mz bi translated">结论</h2><p id="f9aa" class="pw-post-body-paragraph jn jo iq jp b jq na js jt ju nb jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">Spark发展很快，以前不可能的事情现在可能会发生，跟上时代总是好的，不仅是Spark，而是每项技术。</p></div></div>    
</body>
</html>