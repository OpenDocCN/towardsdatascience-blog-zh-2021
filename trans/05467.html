<html>
<head>
<title>How to Improve D3.js Graphs with Annotations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何改进带注释的D3.js图形</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-improve-d3-js-graphs-with-annotations-252fbb9c5bb5?source=collection_archive---------27-----------------------#2021-05-14">https://towardsdatascience.com/how-to-improve-d3-js-graphs-with-annotations-252fbb9c5bb5?source=collection_archive---------27-----------------------#2021-05-14</a></blockquote><div><div class="fc ik il im in io"/><div class="ip iq ir is it"><h2 id="e1f6" class="iu iv iw bd b dl ix iy iz ja jb jc dk jd translated" aria-label="kicker paragraph">数据可视化</h2><div class=""/><div class=""><h2 id="6801" class="pw-subtitle-paragraph kc jf iw bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">一个简短的教程，将简单的D3.js图形转换成带有上下文的精彩图形</h2></div><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gi gj ku"><img src="../Images/e02ddecbb8af35cfd4d1704d949f981c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fejJxu6znbzrgzbbEFcETw.png"/></div></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><p id="fd98" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">数据驱动库(D3)是用来构建图表和绘画的最著名的Javascript库之一。关于图形，有许多网站提供现成的代码，如<a class="ae mg" href="https://www.d3-graph-gallery.com/" rel="noopener ugc nofollow" target="_blank"> D3图库</a>和<a class="ae mg" href="https://www.data-to-viz.com/" rel="noopener ugc nofollow" target="_blank">从数据到视觉</a>。然而，这些网站只提供基本代码，没有提示或细节来突出数据背景或见解。</p><p id="bae3" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">在本教程中，我利用了<a class="ae mg" href="https://d3-annotation.susielu.com/" rel="noopener ugc nofollow" target="_blank"> d3-annotation </a>库来扩展由D3 Graph Gallery提供的两个简单的图形，以使它们对普通读者更具可读性:</p><ul class=""><li id="b8b9" class="mh mi iw lm b ln lo lq lr lt mj lx mk mb ml mf mm mn mo mp bi translated">简单的条形图</li><li id="1f19" class="mh mi iw lm b ln mq lq mr lt ms lx mt mb mu mf mm mn mo mp bi translated">简单的折线图</li></ul><blockquote class="mv mw mx"><p id="ff6c" class="lk ll my lm b ln lo kg lp lq lr kj ls mz lu lv lw na ly lz ma nb mc md me mf ip bi translated">从来没有人因为一个数字而做出决定。他们需要一个故事。(丹·卡尼曼)</p></blockquote><p id="5c78" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">所有代码都在我的<a class="ae mg" href="https://github.com/alod83/data-science/tree/master/DataVisualization/D3Graphs" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>中。</p><h1 id="2bb7" class="nc nd iw bd ne nf ng nh ni nj nk nl nm kl nn km no ko np kp nq kr nr ks ns nt bi translated">条形图</h1><p id="8b5c" class="pw-post-body-paragraph lk ll iw lm b ln nu kg lp lq nv kj ls lt nw lv lw lx nx lz ma mb ny md me mf ip bi translated">第一个例子是由D3图形库提供的<a class="ae mg" href="https://www.d3-graph-gallery.com/graph/barplot_horizontal.html" rel="noopener ugc nofollow" target="_blank">简单条形图</a>，如下图所示:</p><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gi gj nz"><img src="../Images/b9dee457ade2a6a0c177be7a5352c4d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pUOLImtE-jejGRtaZQcXjw.png"/></div></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><p id="e63d" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">该图尝试绘制以下数据集:</p><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div class="gi gj oa"><img src="../Images/cf4e145c302ba55cf5e8b3c485a055db.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*wvIxUk18f5lt1HqC5r6uKA.png"/></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><p id="c73e" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">从数据上下文的角度来看，该图至少提出了两个问题:</p><ul class=""><li id="8229" class="mh mi iw lm b ln lo lq lr lt mj lx mk mb ml mf mm mn mo mp bi translated">栏中的国家没有排序，因此很难理解哪个国家比其他国家表现得更好。</li><li id="7e84" class="mh mi iw lm b ln mq lq mr lt ms lx mt mb mu mf mm mn mo mp bi translated">图表上没有焦点，因此读者应该想象图表想要表达什么。</li></ul><p id="cc4e" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">为了改进图表，我将这两个问题分开处理。</p><p id="52ef" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">关于条形图的顺序，可以通过根据值字段将所有结果按降序排列来改进图表。在D3中，这可以通过<code class="fe ob oc od oe b">sort</code>功能实现:</p><pre class="kv kw kx ky gu of oe og oh aw oi bi"><span id="c7b5" class="oj nd iw oe b gz ok ol l om on">data.sort(function(x, y){return d3.descending(x.Value, y.Value);})</span></pre><p id="ac21" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">该函数需要一个函数作为输入参数，该函数指定用于对每对字段进行排序的规则。</p><p id="0bc9" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">关于图形没有焦点的事实，我可以将焦点放在单个国家，例如法国，并用不同于其他国家的颜色来表示它。此外，我可以将其他国家的颜色改为灰色，以减少其他国家产生的噪音。这可以通过为每个国家生成的矩形指定特定颜色来实现:</p><pre class="kv kw kx ky gu of oe og oh aw oi bi"><span id="bacb" class="oj nd iw oe b gz ok ol l om on">svg.selectAll("myRect")<br/>    // other code<br/>    .attr("fill", function(d){ if (d.Country == 'France') return "#cc0000" ; else return "#a3a3c2"})</span></pre><p id="13cb" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">所描述的效果提供了下图:</p><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gi gj oo"><img src="../Images/ad39cac8b906a933324e99a2ad7483bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y5akp10IMrmJqmVo4e_msQ.png"/></div></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><p id="34d4" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">现在，我可以想象描述为什么法国在排名中达到了第三的位置。也许这是由于它去年强有力的营销政策。因此，我可以向图表添加注释，解释上下文。</p><p id="acdc" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">首先，我通过指定文本(在<code class="fe ob oc od oe b">note</code>字段中)、颜色和位置(通过<code class="fe ob oc od oe b">x, y, dx</code>和<code class="fe ob oc od oe b">dy</code>键)来构建注释:</p><pre class="kv kw kx ky gu of oe og oh aw oi bi"><span id="cd7d" class="oj nd iw oe b gz ok ol l om on">const annotations = [<br/>    {<br/>    note: {<br/>      label: "Thanks to its marketing policy, in 2021 France has reached the third position.",<br/>      title: "France product sales",<br/>      wrap: 200,  // try something smaller to see text split in several lines<br/>      padding: 10   // More = text lower<br/>      <br/>    },<br/>    color: ["#cc0000"],<br/>    x: x(2500),<br/>    y: 100,<br/>    dy: 100,<br/>    dx: 100<br/>  }</span></pre><p id="1b7e" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">然后我将注释附加到SVG图中:</p><pre class="kv kw kx ky gu of oe og oh aw oi bi"><span id="3ad2" class="oj nd iw oe b gz ok ol l om on">const makeAnnotations = d3.annotation()<br/>  .annotations(annotations)</span><span id="1780" class="oj nd iw oe b gz op ol l om on">svg.append("g")<br/>  .call(makeAnnotations)</span></pre><p id="d9de" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">下图显示了最终结果:</p><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gi gj oq"><img src="../Images/98414fa417de0ecaca4641ed6a9b262f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lLWZ5aCLNpvE5ZuH438mYQ.png"/></div></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><h1 id="d463" class="nc nd iw bd ne nf ng nh ni nj nk nl nm kl nn km no ko np kp nq kr nr ks ns nt bi translated">折线图</h1><p id="d89e" class="pw-post-body-paragraph lk ll iw lm b ln nu kg lp lq nv kj ls lt nw lv lw lx nx lz ma mb ny md me mf ip bi translated">第一个例子是由D3图形库提供的<a class="ae mg" href="https://www.d3-graph-gallery.com/graph/connectedscatter_tooltip.html" rel="noopener ugc nofollow" target="_blank">简单折线图</a>，如下图所示:</p><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gi gj or"><img src="../Images/3aa64f1c7f4d7bcf8d9609d509586bd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QDQcUmz3HlrAZjXMTix1Zw.png"/></div></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><p id="31ce" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">这条线主要存在两个问题:</p><ul class=""><li id="17cc" class="mh mi iw lm b ln lo lq lr lt mj lx mk mb ml mf mm mn mo mp bi translated">y轴没有标签，因此很难理解测量单位。</li><li id="f920" class="mh mi iw lm b ln mq lq mr lt ms lx mt mb mu mf mm mn mo mp bi translated">与上图类似，没有上下文。</li></ul><p id="7579" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">关于y轴标签，添加起来很简单。我在SVG图像中添加了一些文本(例如<em class="my">收入</em>),我将它旋转了90度，放在y轴附近:</p><pre class="kv kw kx ky gu of oe og oh aw oi bi"><span id="8fcb" class="oj nd iw oe b gz ok ol l om on">svg.append("text")<br/>      .attr("transform", "rotate(-90)")<br/>      .attr("y", 0 - margin.left)<br/>      .attr("x",0 - (height / 2))<br/>      .attr("dy", "1em")<br/>      .style("text-anchor", "middle")<br/>      .text("Earnings");</span></pre><p id="4d73" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">关于语境，要看数据。我可以想象，这些数据指的是法国在特定时期的收入。我注意到在18日星期三有一次失败，而从20日星期五开始数据再次上升。因此，我可以用两点来强调这两个方面。</p><p id="7903" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">第一个注释应该突出显示所有的<em class="my">翻转</em>周期，因此我可以使用一个<code class="fe ob oc od oe b">d3.annotationCalloutCircle</code>，而第二个注释只能突出显示一个点，对应于星期五20日，因此我可以使用一个<code class="fe ob oc od oe b">d3.annotationCalloutElbow</code>。</p><p id="4d8a" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">下面是构建注释的代码:</p><pre class="kv kw kx ky gu of oe og oh aw oi bi"><span id="4a5e" class="oj nd iw oe b gz ok ol l om on">var parseDate = function(d){ return d3.timeParse("%Y-%m-%d")(d)}<br/>      const annotations = [<br/>       // first annotation<br/>        {<br/>      note: {<br/>        label: "Earnings plummeted",<br/>        title: "April 17th - 19th",<br/>        wrap: 150,  // try something smaller to see text split in several lines<br/>        padding: 10   // More = text lower<br/>      <br/>     },<br/>     color: ["#cc0000"],<br/>     x: x(parseDate('2018-04-18')),<br/>     y: y(8197),<br/>     dy: -100,<br/>     dx: -5,<br/>     subject: {<br/>      radius: 50,<br/>      radiusPadding: 5<br/>    },<br/>    type: d3.annotationCalloutCircle,<br/>    },<br/>    // second annotation<br/>        {<br/>      note: {<br/>        label: "Strong Recovery",<br/>        title: "April 20th",<br/>        wrap: 150,  // try something smaller to see text split in several lines<br/>        padding: 10   // More = text lower<br/>      <br/>     },<br/>     color: [" #00b300"],<br/>     x: x(parseDate('2018-04-20')),<br/>     y: y(8880.23),<br/>     dy: 40,<br/>     dx: 40,<br/>    type: d3.annotationCalloutElbow,<br/>    },<br/>    <br/>      ]<br/>      <br/>      window.makeAnnotations = d3.annotation()<br/>        .annotations(annotations)<br/>     <br/>        svg.append("g")<br/>    .call(makeAnnotations)</span></pre><p id="40ef" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">我定义了一个变量<code class="fe ob oc od oe b">parseDate</code>，它解析一个字符串并返回一个日期。</p><p id="709e" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">下图显示了最终的图形:</p><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gi gj os"><img src="../Images/f9acaba313cdf04d45cd919c48b8f0cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D--2lnzM3rmdp_gtKiEmJQ.png"/></div></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><h1 id="b5e3" class="nc nd iw bd ne nf ng nh ni nj nk nl nm kl nn km no ko np kp nq kr nr ks ns nt bi translated">摘要</h1><p id="3a6a" class="pw-post-body-paragraph lk ll iw lm b ln nu kg lp lq nv kj ls lt nw lv lw lx nx lz ma mb ny md me mf ip bi translated">在这个简短的教程中，我举例说明了如何改进条形图和折线图，以便提供一些背景信息。我已经开发了<code class="fe ob oc od oe b">d3-annotation</code>库，这是d3注释的第三方库。</p><p id="9ba4" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">在接下来的几天里，我将写一篇关于改进地理地图的教程…敬请期待；)</p><p id="ab73" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">如果你想了解我的研究和其他活动的最新情况，你可以在<a class="ae mg" href="https://twitter.com/alod83" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae mg" href="https://www.youtube.com/channel/UC4O8-FtQqGIsgDW_ytXIWOg?view_as=subscriber" rel="noopener ugc nofollow" target="_blank"> Youtube </a>和<a class="ae mg" href="https://github.com/alod83" rel="noopener ugc nofollow" target="_blank"> Github </a>上关注我。</p><h1 id="aa05" class="nc nd iw bd ne nf ng nh ni nj nk nl nm kl nn km no ko np kp nq kr nr ks ns nt bi translated">相关文章</h1><div class="ot ou gq gs ov ow"><a rel="noopener follow" target="_blank" href="/how-to-build-a-basic-line-in-d3-js-38f67055043f"><div class="ox ab fp"><div class="oy ab oz cl cj pa"><h2 class="bd jg gz z fq pb fs ft pc fv fx jf bi translated">如何在D3.js中构建基本行</h2><div class="pd l"><h3 class="bd b gz z fq pb fs ft pc fv fx dk translated">在处理数据时，最重要的一个方面是数据的表示。因此，不同的工具和…</h3></div><div class="pe l"><p class="bd b dl z fq pb fs ft pc fv fx dk translated">towardsdatascience.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk le ow"/></div></div></a></div><div class="ot ou gq gs ov ow"><a href="https://medium.datadriveninvestor.com/getting-started-with-d3-js-maps-e721ba6d8560" rel="noopener  ugc nofollow" target="_blank"><div class="ox ab fp"><div class="oy ab oz cl cj pa"><h2 class="bd jg gz z fq pb fs ft pc fv fx jf bi translated">D3.js地图入门</h2><div class="pd l"><h3 class="bd b gz z fq pb fs ft pc fv fx dk translated">用流行的Javascript库构建交互式Choropleth地图的快速教程</h3></div><div class="pe l"><p class="bd b dl z fq pb fs ft pc fv fx dk translated">medium.datadriveninvestor.com</p></div></div><div class="pf l"><div class="pl l ph pi pj pf pk le ow"/></div></div></a></div><div class="ot ou gq gs ov ow"><a rel="noopener follow" target="_blank" href="/how-to-build-a-dynamic-bar-chart-in-observablehq-through-sqlite3-f8f8b6509ac8"><div class="ox ab fp"><div class="oy ab oz cl cj pa"><h2 class="bd jg gz z fq pb fs ft pc fv fx jf bi translated">如何通过sqlite3在Observablehq中构建动态条形图</h2><div class="pd l"><h3 class="bd b gz z fq pb fs ft pc fv fx dk translated">一个现成的笔记本，利用了Observablehq提供的最新sqlite3特性</h3></div><div class="pe l"><p class="bd b dl z fq pb fs ft pc fv fx dk translated">towardsdatascience.com</p></div></div><div class="pf l"><div class="pm l ph pi pj pf pk le ow"/></div></div></a></div><h1 id="c219" class="nc nd iw bd ne nf ng nh ni nj nk nl nm kl nn km no ko np kp nq kr nr ks ns nt bi translated">上下文分析能帮助提取有意义的见解吗？</h1><p id="3953" class="pw-post-body-paragraph lk ll iw lm b ln nu kg lp lq nv kj ls lt nw lv lw lx nx lz ma mb ny md me mf ip bi translated"><strong class="lm jg">上下文分析</strong>包括围绕数据集的所有<em class="my">世界的分析。数据集周围的世界可能包括不同的方面。例如，如果您正在测量一段时间内海面的温度，环境可能包括天气条件、一些船只的存在等等。</em></p><p id="705c" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">定义上下文分析有三个要素:</p><ul class=""><li id="4675" class="mh mi iw lm b ln lo lq lr lt mj lx mk mb ml mf mm mn mo mp bi translated">事件</li><li id="1f70" class="mh mi iw lm b ln mq lq mr lt ms lx mt mb mu mf mm mn mo mp bi translated">环境</li><li id="2c87" class="mh mi iw lm b ln mq lq mr lt ms lx mt mb mu mf mm mn mo mp bi translated">时间</li></ul><p id="48e9" class="pw-post-body-paragraph lk ll iw lm b ln lo kg lp lq lr kj ls lt lu lv lw lx ly lz ma mb mc md me mf ip bi translated">在这里阅读更多<a class="ae mg" rel="noopener" target="_blank" href="/can-context-analysis-help-extract-meaningful-insights-178a21a88e9f"/>。</p></div></div>    
</body>
</html>