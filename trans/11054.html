<html>
<head>
<title>Training Speed of TensorFlow in macOS Monterey</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">马科斯蒙特里的张量流训练速度</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/training-speed-of-tensorflow-in-macos-monterey-3b8020569be1?source=collection_archive---------8-----------------------#2021-10-28">https://towardsdatascience.com/training-speed-of-tensorflow-in-macos-monterey-3b8020569be1?source=collection_archive---------8-----------------------#2021-10-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="650a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">M1 SoC中的GPU训练与Quadro RTX6000中的结果以及M1 Max SoC中的评估进行比较</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2b94668fbac880d2fe44dfdb9c9c08e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yk9snhKDnzVH8GxIQeiizg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><blockquote class="lf lg lh"><p id="f68e" class="li lj lk ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">[更新]2021年10月30日</p><p id="5062" class="li lj lk ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">我上传了一组用于训练基准的Python代码和图片数据到<a class="ae mf" href="https://github.com/tkshirakawa/benchmark_TensorFlow_macOS" rel="noopener ugc nofollow" target="_blank">我的GitHub </a>。更多细节见本文底部。</p></blockquote></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="c06b" class="mg mh it bd mi mj mk dn ml mm mn dp mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">背景</h2><p id="8cd8" class="pw-post-body-paragraph li lj it ll b lm nc ju lo lp nd jx lr mp ne lu lv mt nf ly lz mx ng mc md me im bi translated">新的OS，macOS Monterey，来了！我等这个新操作系统等了很久，因为TensorFlow/Keras模型的GPU训练(=更快的计算)将得到官方支持。这意味着我存储在Windows工作站中的深度学习代码将是活的，实际上在macOS机器中也是活的。</p><p id="4ed9" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">但是我现在不打算把我的生态系统完全转移到Mac上。我知道我的MacBook Air M1(我用它来工作、学习、娱乐和处理私人事务)不够坚固，无法胜任如此繁重的任务。当然，作为一款日常使用的入门级笔记本电脑，我当然对它适当的功率和效率感到满意。此外，正如<a class="ae mf" href="https://medium.com/macoclock/apple-neural-engine-in-m1-soc-shows-incredible-performance-in-core-ml-prediction-918de9f2ad4c" rel="noopener">我过去的文章“M1 SoC中的苹果神经引擎在预测方面表现出令人难以置信的性能”</a>所述，M1在我的研究所需的图像分割任务中表现出令人难以置信的预测(推理)速度。令人印象深刻的是，M1足球在某些情况下击败了英伟达巨头RTX。</p><p id="4fd8" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">然而，除了预测，训练任务复杂而繁重。的确，有时需要几天(不是几分钟或几小时！)用于在Windows工作站中使用十万幅图像进行培训。</p><p id="f825" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">在本文中，我将展示我的试验，在苹果的M1 SoC上对TensorFlow/Keras模型的GPU训练。我将速度与Quadro RTX6000和M1 Max SoC中的估计进行了比较。</p><blockquote class="nh"><p id="976c" class="ni nj it bd nk nl nm nn no np nq me dk translated">现在，TensorFlow for macOS支持蒙特雷的GPU训练！</p></blockquote></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="4327" class="mg mh it bd mi mj mk dn ml mm mn dp mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">方法</h2><p id="680b" class="pw-post-body-paragraph li lj it ll b lm nc ju lo lp nd jx lr mp ne lu lv mt nf ly lz mx ng mc md me im bi translated">在M1 SoC的CPU和GPU上完成了图像分割的训练任务。我按照<a class="ae mf" href="https://developer.apple.com/metal/tensorflow-plugin/" rel="noopener ugc nofollow" target="_blank">官方的步骤安装了TensorFlow for macOS Monterey </a>。我在装有nVidia高端GPU之一Quadro RTX6000的Windows工作站上使用了相同的代码进行比较。此外，我还估算了M1 Max SoC的速度。我的估算很简单，将M1的计算时间除以4，因为M1有8核GPU，M1有32核GPU。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/be657c87ab63eb4aaa43b5ec1940529b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ae0rBaqrwWriSBuMJIemwA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表1。作者的特征和条件/图像</p></figure><p id="9a31" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">表1显示了测试条件，下面的屏幕电影是在macOS Monterey上的训练场景。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">TensorFlow 2.6在macOS Monterey上的GPU训练/图片由作者提供</p></figure></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="8f59" class="mg mh it bd mi mj mk dn ml mm mn dp mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">结果</h2><p id="478f" class="pw-post-body-paragraph li lj it ll b lm nc ju lo lp nd jx lr mp ne lu lv mt nf ly lz mx ng mc md me im bi translated">不出所料，M1的GPU培训比CPU培训快两倍。对于尺寸为512×512像素的灰度图像，训练速度为328毫秒。这导致了十万张图片的9小时6分钟。屏幕电影显示M1正在使用其GPU的全部能力。</p><p id="6a62" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">另一方面，RTX6000显示了它在这个领域的力量，计算机图形学、CAD、数值模拟和深度学习领域。特别是AMP(自动混合精度),这种计算技术同时使用32位和16位浮点数来实现比单一32位精度更高的速度和更低的内存消耗，显示出有效的增益。M1足球必须接受十到二十倍落后(我从来没有说它慢)。</p><p id="e80a" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">在M1 Max的后面估计通过它的32核GPU提高两到六倍(这是我的梦想估计)。</p><p id="8f50" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">下表分别显示了M1 SoC的实际结果和我对M1 Max的估计。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/f9f34652282f30e7840c41f32b8cf5b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P6wO7VOzzN13Kd1rV3urLw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表二。前两个时期的训练速度/图片由作者提供</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/00b54858b1cae4bf23a2f7815902a66b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CjEktQvv6YSJTK7_XaeTLw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表3。作者对M1 Max SoC / Image中32核GPU训练速度的估算</p></figure></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="812e" class="mg mh it bd mi mj mk dn ml mm mn dp mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">讨论</h2><p id="7318" class="pw-post-body-paragraph li lj it ll b lm nc ju lo lp nd jx lr mp ne lu lv mt nf ly lz mx ng mc md me im bi translated">我对这个结果感到欣慰。M1足球“仅”落后十到二十倍。这个苹果的入门硅消耗10或15W的电力，而RTX6000对最大功率295W有很大的胃口！</p><p id="ced1" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">在这种背景下，这种比较可能毫无意义。</p><p id="f878" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">然而，在M1·马克斯看来，这是有意义的。事实上，结果(再次这是估计！)作为笔记本电脑芯片似乎不错，但苹果表示，新的SoC是为专业用途而设计的。“专业用途”一词意味着M1 Max/Pro和其他高端芯片应该在专业场合用于相同或至少相似的目的和/或目标。机器永远不可能在工作负荷的任何时刻说“这对我来说太重了”。即使是笔记本电脑，这样的用户也会期望相同的性能。</p><p id="f3a4" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">在这种情况下，M1 Max可能不是我满意的选择。</p><p id="5090" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">用于Windows和Linux机器的TensorFlow已经开发了多年。nVidia GPUs和CUDA库为性能提供了强有力的支持。我认为为苹果芯片实现的TensorFlow还不够优化。事实上，Core ML和Metal APIs，苹果公司用于高性能计算的纯API，似乎将所有的CPU，GPU和ANE(苹果神经引擎)用于其繁重的计算。上面的电影明显揭示了Mac上的TensorFlow只用GPU。我认为，各种内核的综合使用是苹果SoC的具体优势。会留下很大的优化空间。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="4d5d" class="mg mh it bd mi mj mk dn ml mm mn dp mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">结论</h2><ul class=""><li id="76a5" class="nw nx it ll b lm nc lp nd mp ny mt nz mx oa me ob oc od oe bi translated">我可以使用我的smiley MacBook Air在M1 SoC的GPU上训练我的TensorFlow/Keras模型。训练速度比在它的CPU上快两倍。</li><li id="00dc" class="nw nx it ll b lm of lp og mp oh mt oi mx oj me ob oc od oe bi translated">然而，与庞然大物RTX6000相比，SoC并没有神奇的力量，而是取决于它的功耗。</li><li id="334e" class="nw nx it ll b lm of lp og mp oh mt oi mx oj me ob oc od oe bi translated">M1 Max SoC的估算结果看起来和笔记本电脑一样好，但不足以满足我的使用=十万张图片的深度学习。</li><li id="de9d" class="nw nx it ll b lm of lp og mp oh mt oi mx oj me ob oc od oe bi translated">根据TensorFlow for macOS内核间任务分配的优化情况，这种情况在未来可能会有所改变。</li></ul></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><p id="4f25" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated"><em class="lk">不管怎样，不管结果如何，老实说，我想要一台新的M1 Max MacBook Pro！:&gt; </em></p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h2 id="3602" class="mg mh it bd mi mj mk dn ml mm mn dp mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">[更新]2021年10月30日</h2><p id="ae59" class="pw-post-body-paragraph li lj it ll b lm nc ju lo lp nd jx lr mp ne lu lv mt nf ly lz mx ng mc md me im bi translated">我上传了一组Python代码和图像数据到<a class="ae mf" href="https://github.com/tkshirakawa/benchmark_TensorFlow_macOS" rel="noopener ugc nofollow" target="_blank">我的GitHub </a>。</p><blockquote class="lf lg lh"><p id="93d2" class="li lj lk ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">注意:GitHub中的文件与上面文章中使用的原始代码不同，因为原始代码包含研究信息。</p></blockquote><p id="9e89" class="pw-post-body-paragraph li lj it ll b lm ln ju lo lp lq jx lr mp lt lu lv mt lx ly lz mx mb mc md me im bi translated">下面的表2+显示了从该释放组获得的结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/8693ab2141780e9538cfa79936c75031.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qutLmTsC0FCjSQiH7dgIJw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表2+。前两个时期的训练速度/图片由作者提供</p></figure></div></div>    
</body>
</html>