<html>
<head>
<title>Migrating from AWS Glue to BigQuery for ETL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从AWS Glue迁移到BigQuery进行ETL</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/migrating-from-aws-glue-to-bigquery-for-etl-ac12980f2036?source=collection_archive---------16-----------------------#2021-09-13">https://towardsdatascience.com/migrating-from-aws-glue-to-bigquery-for-etl-ac12980f2036?source=collection_archive---------16-----------------------#2021-09-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/e43814f68c133272a097eb4873d72d65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E9HEwb7Rw2_zXpaG"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">安德鲁·鲁伊斯在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="9002" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我用大量AWS胶水记录了我们的旅程【https://tymlez-au.medium.com/ T4】</p><h1 id="92f1" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">为什么要迁移？</h1><p id="f410" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">自从几年前在AWS re:invent上看到关于AWS Glue的主题演讲，我就对它感兴趣，它似乎在“你知道的工具”和“没有设置”之间取得了很好的平衡，有一段时间它工作得很好。<br/>它在某种程度上填补了这些工具通常具有的无服务器编排的空白&amp;。</p><p id="f37a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不幸的是，为了做到这一点，它必须清除这些工具所具有的一些USP，这样做会造成复杂性。</p><p id="7af4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">AWS Glue为我们的批量摄取提供了很好的服务，但很快就发现，尽管AWS Kinesis是一个受支持的输入，但它在当前版本中无法扩展到实时摄取。</p><p id="4c36" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要一种不那么痛苦的替代解决方案。</p><h1 id="38c5" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">我们的胶水管道</h1><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mh"><img src="../Images/4fea7e8451edbf28c108196b15e1cafc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BbW3SK1RDn9x5Fvq-Tt06w.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">TYMLEZ的AWS仪表数据设置(图片由作者提供)</p></figure><p id="177a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">简而言之，glue pipeline接收批量数据，这些数据是我们的计量技术和智能仪表读数转储到S3的(稍后将详细介绍这一点，因为这很重要)，并通过各种脚本运行这些数据，以将数据转换为我们需要的数据。</p><p id="6af7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">具体设置可以在这里了解更多:<a class="ae kf" href="https://tymlez-au.medium.com/smart-meter-data-etl-systems-at-tymlez-5643e232dfbb" rel="noopener">https://tymlez-au . medium . com/smart-meter-data-ETL-systems-at-tymlez-5643 e 232 dfbb</a></p><p id="9fbb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">编排是通过AWS Glue触发器串行完成的(例如，当这一步完成时，运行下一步)，不幸的是，这意味着每次都需要部署来使用它们，这大大减慢了开发过程，并且由于其他问题(这里讨论:<a class="ae kf" href="https://tymlez-au.medium.com/aws-glue-is-a-mess-886cc1d13ca9" rel="noopener">https://tymlez-au . medium . com/AWS-Glue-is-a-mess-886 cc 1d 13 ca 9</a>)没有简单的方法来设置一个简单的本地环境来手动运行这些项目。</p><p id="cb56" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">简而言之——它制造的麻烦比解决的问题还多。</p><h1 id="2b95" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">为什么是GCP？</h1><p id="4d5a" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">很简单——因为BigQuery。当谈到轻松处理大量数据时，市场上没有像Google BigQuery这样的产品。</p><p id="10a6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">归结起来就是简单，我们的工作流在从设备读取时非常标准，设备每x分钟发出一次JSON——我们需要获取该JSON并将其写入我们的数据仓库。</p><h2 id="e9b4" class="mm lf it bd lg mn mo dn lk mp mq dp lo kr mr ms ls kv mt mu lw kz mv mw ma mx bi translated">AWS流程:</h2><p id="21eb" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">设备-&gt;<em class="my">处理器* </em> " - &gt; Kinesis - &gt; AWS胶表- &gt;雅典娜</p><p id="773d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让Kinesis与AWS Glue Tables一起工作几乎是不可能的(试图在本地开发这一点甚至更难)。</p><h2 id="f8f5" class="mm lf it bd lg mn mo dn lk mp mq dp lo kr mr ms ls kv mt mu lw kz mv mw ma mx bi translated">GCP流量:</h2><p id="0023" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">设备-&gt;<em class="my">处理器*</em>-&gt;big query</p><p id="69d9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="my">*处理器是某种形式的处理能力，如EC2、Lambda、云函数等</em></p><p id="3e00" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">GCP流只是工作，它工作得如此简单，以至于我可以在这里包含我用来为开发摄取的代码:</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="e492" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦数据进入BigQuery，我们只需使用一个标准的ELT模式，根据需要将数据分成一堆新表，并设置它们通过cron运行。</p><p id="a896" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的管道现在看起来像这样:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nb"><img src="../Images/a08684f103ab8f9c0f4f091104a0c932.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Y5xpS-sMTs506nDI_gNlg.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">多重云设置(图片由作者提供)</p></figure><p id="48db" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">大型PySpark脚本被直接处理BigQuery中导入数据的SQL数据所取代。</p><pre class="mi mj mk ml gt nc nd ne nf aw ng bi"><span id="2d5e" class="mm lf it nd b gy nh ni l nj nk">CREATE OR REPLACE TABLE data_clean AS ( SELECT x FROM data…)</span><span id="5ae3" class="mm lf it nd b gy nl ni l nj nk">CREATE OR REPLACE TABLE data_business AS ( SELECT x FROM data_clean…)</span><span id="4d5c" class="mm lf it nd b gy nl ni l nj nk">CREATE OR REPLACE TABLE prediction_input AS ( SELECT x FROM data_business…)</span><span id="18fb" class="mm lf it nd b gy nl ni l nj nk">CREATE OR REPLACE MODEL usage_forecast OPTIONS(model_type=’ARIMA_PLUS’...</span></pre><p id="b926" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意，作为使用SQL的这一步骤的一部分，我们还可以直接从BigQuery中训练一个模型？我们不仅将数据ETL到BI和其他报告所需的表格中，还生成了一个ARIMA+模型，用于根据大量不同的输入预测数据。此外，我们可以单独使用相同的数据来训练AutoML模型进行测试。</p><h1 id="8615" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">ML管道— Sagemaker vs Vertex。人工智能</h1><p id="45cd" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">Sagemaker很棒，它允许通过SAGEMAKER.invoke_endpoint请求进行真正干净的模型部署。它可以处理很多事情，比如为训练好的模型轻松地创建端点，以便进行预测。</p><p id="8efd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">GCP有顶点。AI与此类似，尽管它不太成熟，不支持AutoML模型的端点创建，但目前更简单的是简单地批处理日期预测模型，并使它们在BigQuery或其他表中可用，然后可以通过静态API查询。</p><p id="ac7a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这也可以通过Cron非常简单地完成，方法是基于以前的日期批量创建日期预测输入，并针对重新训练的模型运行批量预测。</p><p id="c975" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不需要步进机、触发器或任何东西——如果一天内需要更新，这也是很好的幂等方法。</p><h1 id="98dd" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">数据可视化— Quicksight与Data Studio</h1><p id="6dec" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">AWS有Quicksight作为它的BI工具，但是我从来没有用过它，它看起来总是限制太多。有时，您希望快速搭建一个仪表盘，从数据中获得一些高管或董事会层面的见解，而无需花费大量时间。</p><p id="7fbd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">谷歌有Data Studio，在我看来，这是一个非常好的产品，感觉就像是谷歌产品套件的一部分。</p><p id="8c54" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我可以创建一个数据集，并与我们业务中的任何人共享，以便创建特定的BI仪表板。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nm"><img src="../Images/d831d7a4eb09cbc8c3efb636ba0b3147.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z9HXL2eD9-9oLLfJePq1Ug.png"/></div></div></figure><p id="999f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，谁可以拖放图表并将其与易于理解的数据表示联系起来:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nn"><img src="../Images/cb5dd74e455da965fcd9b9d0ba562428.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n79aHDMGUAz9QsF4H6E4hw.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">我们的数据工作室设置(图片由作者提供)</p></figure><p id="ca4f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我特别喜欢Blend Data接口，它抽象了许多需要完成的底层连接，以便从系统中获取大部分数据，并允许您轻松地连接几个表以获得所需的结果:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/1349dfa089f9677fb3f83d40a417e39f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Lns3O0M7tQqnzF43UyG4Q.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">混合数据界面(图片由作者提供)</p></figure><h1 id="4f35" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="a8b2" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">当我们开始深入挖掘它的流功能时，我们的AWS Glue之旅有点艰难，如此多的层的编排增加了我们没有预料到的巨大开销，虽然大多数都是在AWS产品套件中处理的，但将我们的管道切换到GCP和BigQuery有太多的好处不容忽视。</p><p id="b421" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一步是通过使用Cloud Composer (Airflow)来协调每个表的创建，并提供一个监控仪表板来帮助我们检测故障并采取行动，从而完成我们的部署。</p><h2 id="0a8b" class="mm lf it bd lg mn mo dn lk mp mq dp lo kr mr ms ls kv mt mu lw kz mv mw ma mx bi translated"><em class="np">更新—2021年9月13日</em></h2><p id="d444" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我要说的是，在我发表上一篇文章后，AWS与我取得了联系，我与AWS Glue产品团队通了电话，用他们的话说，我已经“触及了几乎所有可能的尖锐边缘”(这似乎是我的一个持续主题——也许我应该转行做QA工程师？)，他们有一系列令人兴奋的更新正在进行中，应该可以解决其中的许多问题，我期待着看到它们，因为我仍然坚持认为，对于不太复杂的数据批处理，AWS Glue是一个具有很高可见性的优秀产品。</p><h1 id="1c7f" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">关于作者</h1><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/f12ace949fcddde23e96e9dfaf38edc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*fjiykoTpZuxFPos1.jpeg"/></div></figure><p id="0b25" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">首席技术官丹·沃伊斯</strong></p><p id="8f22" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Dan负责TYMLEZ的技术战略、架构和开发。<br/>一位从业超过20年的创业老手，擅长建立高绩效开发团队，并带领他们成功地为澳大利亚和英国的一些大公司提供解决方案。</p></div></div>    
</body>
</html>