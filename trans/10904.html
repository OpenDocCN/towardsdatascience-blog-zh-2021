<html>
<head>
<title>Third Times the Charm?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第三次魅力？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/third-times-the-charm-91835dc0facb?source=collection_archive---------26-----------------------#2021-10-22">https://towardsdatascience.com/third-times-the-charm-91835dc0facb?source=collection_archive---------26-----------------------#2021-10-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bf61" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">时间序列特征工程，三种方法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d7e9bca88ce5ce5166a877faf40da223.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VGI5ArSBlPdKdQ_Mv0RB1g.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">本杰明·雷曼在Unsplash<a class="ae kv" href="http://unsplash.com" rel="noopener ugc nofollow" target="_blank">拍摄的照片</a></p></figure><p id="63b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">生存分析是许多不同行业的共同问题。其中包括医学试验中的患者存活率、客户流失和硬件故障等。使用机器学习的生存分析是一个复杂的过程，超出了单个博客的范围。然而，生存分析模型中常见的计算对其他时间序列应用也是有用的。不幸的是，时间序列数据，尤其是硬件故障和在线客户流失的时间序列数据会变得非常大，这使得在pandas的单台机器上处理这些数据变得非常困难。在这篇博客中，我们将考虑这些计算(移动平均)之一，并讨论熊猫的替代方案来创建这些功能。</p><p id="6f29" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该博客将使用来自<a class="ae kv" href="http://www.backblaze.com" rel="noopener ugc nofollow" target="_blank"> Backblaze </a>的数据，其中包含数据中心所有硬盘的<a class="ae kv" href="https://www.backblaze.com/b2/hard-drive-test-data.html" rel="noopener ugc nofollow" target="_blank">每日智能统计数据</a>。在2021年的<a class="ae kv" href="https://www.backblaze.com/blog/backblaze-drive-stats-for-q2-2021/" rel="noopener ugc nofollow" target="_blank"> Q2，Backblaze </a>的数据中心有将近180，000个驱动器。我们将考虑一项分析来预测硬盘驱动器的预期寿命，给出其迄今为止的统计数据。在最近的数据中，有124列数据。其中，Backblaze <a class="ae kv" href="https://www.backblaze.com/blog/what-smart-stats-indicate-hard-drive-failures/" rel="noopener ugc nofollow" target="_blank">积极监控</a>少数可能的故障指标。这些是:</p><ul class=""><li id="4f84" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">SMART 5:重新分配的扇区计数</li><li id="101f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">SMART 187:报告了不可纠正的错误</li><li id="ebb1" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">SMART 188:命令超时</li><li id="eac6" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">SMART 197:当前待定扇区计数</li><li id="17da" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">SMART 198:不可纠正的扇区计数</li></ul><p id="bae2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在此分析中，我们将假设所有每日数据都存储在云数据仓库中，我们将展示为所有5个指标创建移动平均值的三种方法。此外，对于此分析，我们感兴趣的是驱动器温度对故障的影响，因此我们还将考虑SMART 194。</p><p id="b9c6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">许多数据科学家最喜欢在一台机器上研究熊猫。要使用pandas构建移动平均线，必须首先从数据仓库中提取数据。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="d438" class="ml mm iq mh b gy mn mo l mp mq">sqltext = """SELECT date, serial_number, model, failure, <br/>smart_5_raw, smart_187_raw, smart_188_raw, <br/>smart_194_raw, smart_197_raw, smart_198_raw <br/>FROM daily <br/>WHERE model = 'ST12000NM0008' <br/>AND date between '2020-10-01' and '2020-12-31' ORDER BY serial_number, date<br/>"""</span><span id="7ffb" class="ml mm iq mh b gy mr mo l mp mq">df = pd.read_sql(sqltext, engine, parse_dates=['date'])</span></pre><p id="6b40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个区域的7天移动平均值(本例中为温度)可由下式得出</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="87a0" class="ml mm iq mh b gy mn mo l mp mq">df['mean_temp_7'] = df.groupby('serial_number')['smart_194_raw'] \    <br/>                      .rolling(7,<br/>                       min_periods=1).mean().reset_index(drop=True)</span></pre><p id="024a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这可以对每个其他特征重复进行。或者，可以创建滚动分组</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="6e68" class="ml mm iq mh b gy mn mo l mp mq">rolling_group = df.groupby('serial_number').rolling(7, <br/>                                              min_periods=1)</span></pre><p id="c930" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以应用下一个<code class="fe ms mt mu mh b">agg</code></p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="defb" class="ml mm iq mh b gy mn mo l mp mq">tdf = rolling_group.agg({'smart_5_raw': 'mean',<br/>                         'smart_187_raw': 'mean',<br/>                         'smart_188_raw': 'mean',<br/>                         'smart_194_raw': 'mean',<br/>                         'smart_197_raw': 'mean',<br/>                         'smart_198_raw': 'mean'})</span></pre><p id="c21b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个新的数据框中，要素名称现在包含了7天的滚动平均值，因此请重命名这些要素以明确它们所包含的内容。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="699e" class="ml mm iq mh b gy mn mo l mp mq">moving_avg_df = tdf.rename(columns=<br/>                    {'smart_5_raw': 'mean_smart_5_raw',<br/>                     'smart_187_raw': 'mean_smart_187_raw',<br/>                     'smart_188_raw': 'mean_smart_188_raw',<br/>                     'smart_194_raw': 'mean_smart_194_raw',<br/>                     'smart_197_raw': 'mean_smart_197_raw',<br/>                     'smart_198_raw': 'mean_smart_198_raw'})</span></pre><p id="3218" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，将这些移动平均线合并回原始数据框架。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="f1e2" class="ml mm iq mh b gy mn mo l mp mq">final_df = df.merge(moving_avg_df.reset_index(level='serial_number',<br/>                                              drop=True),<br/>                    left_index=True, right_index=True)</span></pre><p id="6ed6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于多年的数据，这在单台机器上非常耗时。但是，可以利用这个数据存储在云数据仓库中的事实。我们可以用SQL计算字段的7天移动平均值，如下所示</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="2f33" class="ml mm iq mh b gy mn mo l mp mq">avg(&lt;field&gt;) OVER(PARTITION BY serial_number ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS mean_&lt;field&gt;</span></pre><p id="5931" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这意味着我们可以通过修改发送到<code class="fe ms mt mu mh b">pd.read_sql</code>的sql将最终数据直接拉入pandas数据帧。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="158f" class="ml mm iq mh b gy mn mo l mp mq">sqltext = """<br/>SELECT date<br/>, serial_number<br/>, model<br/>, failure<br/>, smart_5_raw, smart_187_raw<br/>, smart_188_raw, smart_194_raw<br/>, smart_197_raw, smart_198_raw <br/>, AVG(smart_5_raw) OVER(PARTITION BY serial_number ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS mean_smart_5_raw<br/>, AVG(smart_187_raw) OVER(PARTITION BY serial_number ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS mean_smart_187_raw<br/>, AVG(smart_188_raw) OVER(PARTITION BY serial_number ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS mean_smart_188_raw<br/>, AVG(smart_194_raw) OVER(PARTITION BY serial_number ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS mean_smart_194_raw<br/>, AVG(smart_197_raw) OVER(PARTITION BY serial_number ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS mean_smart_197_raw<br/>, AVG(smart_198_raw) OVER(PARTITION BY serial_number ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS mean_smart_198_raw<br/>FROM daily <br/>WHERE model = 'ST12000NM0008' <br/>AND date between '2020-10-01' and '2020-12-31'<br/>ORDER by serial_number, date<br/>"""<br/>final_df = pd.read_sql(sqltext, engine, parse_dates=['date'])</span></pre><p id="3a9c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这给了我们和熊猫一样的数据。</p><p id="98c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，因为这些数据位于云数据仓库中，如果<a class="ae kv" href="http://rasgoml.com" rel="noopener ugc nofollow" target="_blank"> Rasgo </a>连接到该仓库，您可以使用Rasgo为这些转换创建代码，并在仓库上从Python执行它们，并将数据保存回仓库。</p><p id="d84b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，连接到Rasgo</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="2930" class="ml mm iq mh b gy mn mo l mp mq">import pyrasgo<br/>rasgo = pyrasgo.connect('&lt;Your API Key&gt;')</span></pre><p id="d9ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">连接到数据源(包含硬盘驱动器统计信息的表)，</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="85a9" class="ml mm iq mh b gy mn mo l mp mq">datasource = rasgo.get.data_source(id=&lt;Data Source ID)</span></pre><p id="fc10" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建转换以创建移动平均值(在这种情况下，我们将为任意大小的窗口创建它。转换文本将是包含在<a class="ae kv" href="https://jinja.palletsprojects.com/" rel="noopener ugc nofollow" target="_blank"> Jinja模板</a>中的SQL select语句。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="1665" class="ml mm iq mh b gy mn mo l mp mq">sqltext = """SELECT *<br/>{%- for column in fields_to_average -%}<br/>    {%- for window in window_sizes -%}<br/>        , avg({{column}}) OVER(PARTITION BY {{serial_dim}} ORDER BY {{date_dim}} ROWS BETWEEN {{window - 1}} PRECEDING AND CURRENT ROW) AS mean_{{column}}_{{window}}<br/>    {%- endfor -%}<br/>{%- endfor -%}<br/>FROM {{source_table}}"""</span><span id="771f" class="ml mm iq mh b gy mr mo l mp mq">new_transform = rasgo.create.transform(name="moving_average",<br/>                                       source_code=sqltext)</span></pre><p id="490b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，可以通过调用以下命令将此模板应用于单个字段的数据</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="5d99" class="ml mm iq mh b gy mn mo l mp mq">newsource = datasource.transform(transform_name='moving_average',<br/>                            fields_to_average = ['SMART_194_RAW'],<br/>                            serial_dim = "SERIAL_NUMBER",<br/>                            date_dim = "DATE",<br/>                            window_sizes = [7]})</span></pre><p id="20d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以在数据仓库上创建数据，并通过调用</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="cbbf" class="ml mm iq mh b gy mn mo l mp mq">transformed_source = newsource.to_source(new_table_name=<br/>                                             "&lt;New Table Name&gt;")</span></pre><p id="8b06" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以将这些变换链接在一起，为所有六个特征创建移动平均值。此外，可以组合以类似方式构建的其他转换来创建附加功能。但是，由于转换是为了获取要素列表和窗口大小而构建的，因此可以同时创建所有六个要素的7天和14天移动平均值。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="1765" class="ml mm iq mh b gy mn mo l mp mq">newsource = datasource.transform(<br/>                    transform_name='moving_average',<br/>                    fields_to_average = ['SMART_5_RAW',<br/>                                         'SMART_187_RAW',<br/>                                         'SMART_188_RAW', <br/>                                         'SMART_194_RAW',<br/>                                         'SMART_197_RAW',<br/>                                         'SMART_198_RAW'],<br/>                    serial_dim = "SERIAL_NUMBER",<br/>                    date_dim = "DATE",<br/>                    window_sizes = [7, 14])</span></pre><p id="ee2d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这可以发表为</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="3db5" class="ml mm iq mh b gy mn mo l mp mq">newsource = newsource.to_source(new_table_name="&lt;New Table Name&gt;")</span></pre><p id="70ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种方法有几个优点。首先，如前所述，这些特性是在云数据仓库上创建的，并立即保存到该仓库的一个表中。除了利用仓库运行计算的能力之外，它还节省了将数据移入和移出运行Python的计算机的I/O时间。当它被保存到数据库中时，所有有权访问仓库的用户都可以立即使用它，而不仅仅是同一台计算机上的用户。最后，因为它是在Rasgo中发布的，所以可以从该源创建要素</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="729e" class="ml mm iq mh b gy mn mo l mp mq">newsource = rasgo.publish.features_from_source(data_source_id=newsource.id,<br/>                                   dimensions=['DATE',<br/>                                               'SERIAL_NUMBER',<br/>                                               'MODEL'],<br/>                                   granularity=['day',<br/>                                                'serial_number',<br/>                                                'model'],<br/>                                   features=['MEAN_SMART_5_RAW_7',<br/>                                            'MEAN_SMART_187_RAW_7',<br/>                                            'MEAN_SMART_188_RAW_7',<br/>                                            'MEAN_SMART_194_RAW_7',<br/>                                            'MEAN_SMART_197_RAW_7',<br/>                                            'MEAN_SMART_198_RAW_7'],<br/>                                   tags=['drive_failure'],<br/>                                   sandbox=False)</span></pre><p id="d408" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这使得这些功能可以在Rasgo平台上被发现，并且可以与Rasgo中的其他功能结合使用。此外，Rasgo将生成一个功能配置文件，允许快速查看生成的功能。</p><p id="b5ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该特征配置文件包括显示值分布的直方图</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/c4674828f4a7651ed1f7f57da0452035.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ayu8HwYiCQLdrOBI7VK5bw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="cdad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一段时间内的平均值</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/be587b4232ce929497d4619b61f6182e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*INV8daDgfErvkfkNYtDR1w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="d371" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此功能的常见统计信息</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/1e57892b6e128b7168080a3f63b3ef15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7hTsxAUnssVvn6aZstr1kw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="1b7f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">随着时间的推移，此功能与其他功能之间的比较</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi my"><img src="../Images/b64bccc583ab3e115878c775477afa01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*skpXfC_cxAc_DxClNnU31g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="d518" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以及这个特征和另一个特征的分布的比较</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/d2b4ee2aa339196775ff07a53d39b8ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vSUSrnWxUgESVvCBmSVupQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="cc4b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然数据科学家在pandas中工作很舒服，但在生成要素时利用云数据仓库的能力有相当大的优势。在这篇博客中，我们看到了一个数据科学家如何从在pandas本地工作，到为团队的其他成员创建甚至探索在Rasgo中使用的功能。</p></div></div>    
</body>
</html>