<html>
<head>
<title>Exploring Model Hyperparameter Search Space with PyCaret &amp; MLflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用PyCaret &amp; MLflow探索模型超参数搜索空间</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/exploring-model-hyperparameter-search-space-with-pycaret-mlflow-b6c630d71723?source=collection_archive---------20-----------------------#2021-11-24">https://towardsdatascience.com/exploring-model-hyperparameter-search-space-with-pycaret-mlflow-b6c630d71723?source=collection_archive---------20-----------------------#2021-11-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6d6b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">时间序列预测的简化回归模型</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6b6161a0a6ecf053195791e8bb345d6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VbGPTRNOY0yYR6gW"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@antonov?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Serg Antonov </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><h2 id="3370" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">📚介绍</h2><p id="4f1e" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">您是否曾经查看过模型的超参数，并想知道它们对模型的性能有什么影响？你并不孤单。虽然有些影响可以直观地得出，但在其他情况下，结果却与直观相反。这些超参数不单独工作(单变量)而是相互结合(多变量)的事实加剧了这种情况。在决定网格搜索的搜索空间时，理解超参数对模型性能的影响变得更加重要。选择错误的搜索空间会导致浪费挂钟时间，而不会提高模型性能。</p><p id="a72f" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">在本文中，我们将看到如何将Pycaret与MLFlow结合使用，以更好地理解模型超参数。这将有助于我们在执行网格搜索时选择一个好的搜索空间。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h2 id="4996" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">📖建议的先前阅读</h2><p id="f767" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">在本文中，我们将以PyCaret的时间序列模块为例来探讨这个概念。具体来说，我们将研究用于预测的简化回归模型。如果你不熟悉这些模型，我推荐这篇短文。</p><p id="1c6e" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">👉<a class="ae ky" href="https://github.com/pycaret/pycaret/discussions/1760" rel="noopener ugc nofollow" target="_blank">用于时间序列预测的简化回归模型</a></p><p id="4c26" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">另外，如果您不熟悉PyCaret和MLFlow是如何协同工作的，这是一篇很有帮助的短文。</p><p id="a9d6" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">👉【MLFlow时序实验测井</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h2 id="ceb3" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">1️⃣简化回归模型超参数</h2><p id="9900" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">简化的回归模型有几个超参数，但是有几个重要的是<code class="fe na nb nc nd b">sp</code>和<code class="fe na nb nc nd b">window_length</code>。在上面的“上一次阅读”中，建议在将数据传递到回归器进行建模之前对其进行去季节性处理。<code class="fe na nb nc nd b">sp</code>表示用于消除数据季节性差异的季节周期。此外，建模者需要决定在训练过程中将多少先前的滞后馈入回归模型。这由<code class="fe na nb nc nd b">window_length</code>超参数控制。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="566e" class="kz la it nd b gy ni nj l nk nl"><strong class="nd iu"><em class="nm">sp :</em></strong><em class="nm"> int, optional<br/>Seasonality period used to deseasonalize, by default 1</em></span><span id="4c28" class="kz la it nd b gy nn nj l nk nl"><strong class="nd iu"><em class="nm">window_length</em></strong><em class="nm"> : int, optional<br/>Window Length used for the Reduced Forecaster, by default 10</em></span></pre></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h2 id="799e" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">2️⃣超参数直觉</h2><p id="2d40" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">许多数据集表现出季节性模式。这意味着任何给定时间点的值将紧密跟随一个或多个季节的数据(由季节周期或<code class="fe na nb nc nd b">sp</code>确定)。因此，保持<code class="fe na nb nc nd b">sp</code>固定在季节周期可能是直观的(例如，可以从ACF图中获得)。类似地，人们可能希望将至少一个季度的数据传递给回归器，以便对自回归属性进行建模。因此，我们的直觉可能会告诉我们让<code class="fe na nb nc nd b">window_length</code>也等于季节周期。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h2 id="5c36" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">PyCaret的3️⃣实验</h2><p id="9bbd" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">现在，我们来看一个数据集，看看这些超参数有什么影响。在这个练习中，我们将使用经典的“航空公司”数据集。注意:本文末尾提供了一个Jupyter笔记本供参考。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/6980654cf838a8dc21e84c3bb1a95d1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*os_mAUk64cZS6g-YVAUQkw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">航空数据集(图片由作者提供)</p></figure><p id="f21d" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">该数据集展示了12个月的季节性模式，这由ACF在12的倍数(12、24、36等)处的峰值来指示。)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/57cf83f7eb164dd595053386b82faf6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rB4Bdehenj1sO8wmeq4ATA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ACF:航空公司数据集(图片由作者提供)</p></figure><h2 id="7ef3" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">尝试窗口长度</h2><p id="db3e" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">让我们创建一个<code class="fe na nb nc nd b">pycaret</code>实验，在这里我们改变<code class="fe na nb nc nd b">window_length</code>，并检查它对模型性能的影响。我们将在设置中启用MLflow日志记录。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="f197" class="kz la it nd b gy ni nj l nk nl">exp.setup(<br/>    <em class="nm">data</em>=y, <em class="nm">fh</em>=12, <em class="nm">session_id</em>=42,<br/>    <em class="nm">log_experiment</em>=True,<br/>    <em class="nm">experiment_name</em>="my_exp_hyper_window",<br/>    <em class="nm">log_plots</em>=True<br/>)</span><span id="7b0d" class="kz la it nd b gy nn nj l nk nl"><em class="nm">#### Create models with varying window lengths ----<br/></em>for window_length in np.arange(1, 25):<br/>    exp.create_model("lr_cds_dt", <em class="nm">window_length</em>=window_length)</span></pre><p id="4ff0" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">现在可以在MLflow中可视化该实验的结果。MLflow提供了一个非常方便的功能来比较一个实验的多次运行。我们可以利用这个特性来看看<code class="fe na nb nc nd b">window_length</code>的影响。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/4989d735311e7fd9eff570194e602557.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jBQMDexwHNolvItGcivcmA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">MLflow中可视化窗口长度的影响(图片由作者提供)</p></figure><p id="d171" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">结果与我们的直觉相符，即在窗口中包含至少12个点提供了最佳性能。任何低于11分的数据都会降低性能，因为我们没有包括上一个赛季的数据。任何超过12个数据点的结果都相当稳定，接近最佳度量值。</p><h2 id="7964" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">对季节周期进行实验</h2><p id="e29b" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">接下来，我们对<code class="fe na nb nc nd b">sp</code>重复同样的操作。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="180a" class="kz la it nd b gy ni nj l nk nl"><em class="nm">#### Setup experiment with MLFlow logging ----<br/></em>exp.setup(<br/>    <em class="nm">data</em>=y, <em class="nm">fh</em>=12, <em class="nm">session_id</em>=42,<br/>    <em class="nm">log_experiment</em>=True,<br/>    <em class="nm">experiment_name</em>="my_exp_hyper_sp",<br/>    <em class="nm">log_plots</em>=True<br/>)</span><span id="cd98" class="kz la it nd b gy nn nj l nk nl"><em class="nm">#### Create a model with varying seasonal periods ----<br/></em>for sp in np.arange(1, 25):<br/>    model = exp.create_model("lr_cds_dt", <em class="nm">sp</em>=sp)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/62b01e532c192fa30858c487e2128001.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T46sY0nzv8mPzdRcWp8EFA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">MLflow中显示的季节周期的影响(图片由作者提供)</p></figure><p id="788a" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">这个实验的结果有点出乎意料。虽然我们在季节周期=12时得到了好的结果，但在季节周期=3、4、6、8和9时也得到好的结果。这可能是因为对于月度数据(如航空数据集)，周期3、6、9分别代表1、2和3个季度。这些也可以是数据重复自身的有效周期。4和8的季节周期有点难以直观地解释，但可能表示数据分别一年重复3次或两年重复3次(也不是完全没有问题，尽管可能性比其他周期小)。</p><p id="2e5b" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">无论如何，这带来了超参数直觉和调优的挑战。通常很难提前确定“最佳”超参数，但至少我们可以直观地将它们设置为一个合理的值。此外，如上所述，超参数不倾向于孤立工作(单变量)。它们相互作用，还会以其他非直观的方式影响模型性能。接下来让我们检查一个多变量的情况。</p><h2 id="d378" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">尝试窗口长度和季节周期(多元)</h2><p id="138d" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">在这个实验中，我们同时考虑<code class="fe na nb nc nd b">window_length</code>和<code class="fe na nb nc nd b">sp</code>来探索搜索空间。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="cf17" class="kz la it nd b gy ni nj l nk nl"><em class="nm">#### Create a model with varying window_length &amp; sp ----</em></span><span id="caaf" class="kz la it nd b gy nn nj l nk nl">runs = 50<br/>window_lengths = np.random.randint(1, 25, runs)<br/>sps = np.random.randint(1, 25, runs)</span><span id="ec83" class="kz la it nd b gy nn nj l nk nl">for window_length, sp in zip(window_lengths, sps):<br/>    model = exp.create_model(<br/>        "lr_cds_dt", w<em class="nm">indow_length</em>=window_length, <em class="nm">sp</em>=sp<br/>    )</span></pre><p id="3a06" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">MLflow还提供了使用等高线图可视化双变量数据的能力。在这种情况下，我们在x轴上绘制了<code class="fe na nb nc nd b">window_length</code>，在y轴上绘制了<code class="fe na nb nc nd b">sp</code>。颜色代表选择的度量标准(本例中为MAE)。蓝色阴影越浅，误差越小，因此这种情况下超参数选择越好。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/1753cc3a3d1765f859b9e4d312d8301b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ll4cqOB1hNDi53olXNHq9A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在MLflow中可视化的窗口长度和季节周期的影响(图片由作者提供)</p></figure><p id="e94c" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">我们可以从这些结果中看到，即使在多变量设置中，任何小于12个数据点的<code class="fe na nb nc nd b">window_length</code>都不会给出最佳结果(蓝色阴影)。任何高于12的值似乎都相当不错。对于季节周期，只要<code class="fe na nb nc nd b">window_length</code>大于12，精确值似乎对双变量设置没有很大影响。(注意:如果您想知道，黑色区域是没有足够的样本点来构建轮廓的区域)。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h2 id="b962" class="kz la it bd lb lc ld dn le lf lg dp lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">🚀结论和下一步措施</h2><p id="7cff" class="pw-post-body-paragraph lv lw it lx b ly lz ju ma mb mc jx md li me mf mg lm mh mi mj lq mk ml mm mn im bi translated">我们现在可以使用这种直觉来指导我们未来遇到类似数据集时的超参数搜索空间。或者，查看下面的参考资料，了解<code class="fe na nb nc nd b">pycaret</code>如何以最佳和自动化的方式执行超参数调优。</p><p id="a72a" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">👉<a class="ae ky" href="https://github.com/pycaret/pycaret/discussions/1791" rel="noopener ugc nofollow" target="_blank">py caret中时间序列模型的基本超参数调整</a></p><p id="3ea0" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated"><code class="fe na nb nc nd b">pycaret</code>还为用户提供了在超参数调整期间控制搜索空间的选项。用户可能希望像我们在本文中所做的那样，基于手动评估来这样做。查看下面的文章了解更多细节。</p><p id="7002" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">👉<a class="ae ky" href="https://github.com/pycaret/pycaret/discussions/1795" rel="noopener ugc nofollow" target="_blank">py caret中时序模型的高级超参数调整</a></p><p id="3306" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">暂时就这样了。如果你想和我联系(我经常发布关于时间序列分析的文章)，你可以通过下面的渠道找到我。下次见，预测快乐！</p><p id="b2ff" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">🔗<a class="ae ky" href="https://www.linkedin.com/in/guptanick/" rel="noopener ugc nofollow" target="_blank">领英</a></p><p id="e8d8" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">🐦<a class="ae ky" href="https://twitter.com/guptanick13" rel="noopener ugc nofollow" target="_blank">推特</a></p><p id="3912" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated">📘<a class="ae ky" href="https://github.com/ngupta23" rel="noopener ugc nofollow" target="_blank"> GitHub </a></p><p id="dcb1" class="pw-post-body-paragraph lv lw it lx b ly mo ju ma mb mp jx md li mq mf mg lm mr mi mj lq ms ml mm mn im bi translated"><em class="nm">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://ngupta13.medium.com/membership" rel="noopener"> <strong class="lx iu"> <em class="nm">中等会员</em> </strong> </a> <em class="nm">继续</em> <strong class="lx iu"> <em class="nm">无限制学习</em> </strong> <em class="nm">。如果你使用下面的链接，</em> <strong class="lx iu"> <em class="nm">，我会收到你的一部分会员费，而不会对你产生额外的费用</em> </strong> <em class="nm">。</em></p><div class="ns nt gp gr nu nv"><a href="https://ngupta13.medium.com/membership" rel="noopener follow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">通过我的推荐链接加入Medium—Nikhil Gupta</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">阅读Nikhil Gupta(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接支持…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">ngupta13.medium.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj ks nv"/></div></div></a></div></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="6015" class="ok la it bd lb ol om on le oo op oq lh jz or ka ll kc os kd lp kf ot kg lt ou bi translated">📗资源</h1><ol class=""><li id="4415" class="ov ow it lx b ly lz mb mc li ox lm oy lq oz mn pa pb pc pd bi translated"><a class="ae ky" href="https://nbviewer.ipython.org/github/ngupta23/medium_articles/blob/main/time_series/pycaret/pycaret_mlflow_hyperparams.ipynb" rel="noopener ugc nofollow" target="_blank"> <strong class="lx iu"> Jupyter笔记本</strong> </a>包含本文代码</li></ol></div></div>    
</body>
</html>