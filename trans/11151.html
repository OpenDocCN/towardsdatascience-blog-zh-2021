<html>
<head>
<title>Growth Hack: Sending Slack Alerts from BigQuery (SQL)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">增长黑客:从 BigQuery (SQL)发送松弛警报</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/slack-alerts-from-a-sql-query-on-bigquery-f626b767304c?source=collection_archive---------8-----------------------#2021-11-01">https://towardsdatascience.com/slack-alerts-from-a-sql-query-on-bigquery-f626b767304c?source=collection_archive---------8-----------------------#2021-11-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d517" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何根据 SQL 查询的结果发送时差警报？</h2></div><p id="0ad9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据我们数据仓库中的数据发送松弛警报是我最喜欢的增长技巧之一。在过去 2 年多的时间里，它帮助我们的团队检测准备流失的用户，回收被遗弃的购物车，或者检测高质量的用户。而且反应要快！</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/898f499cebf7fa4ad4289aa78ea0f7ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gkv7nvKnifkU1e6ohF9Szg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片由<a class="ae lu" href="https://pixabay.com/fr/users/apassingstranger-20265584/" rel="noopener ugc nofollow" target="_blank"> apassingstranger </a>在<a class="ae lu" href="https://pixabay.com" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>上拍摄</p></figure><p id="594d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们一直使用<a class="ae lu" href="https://cloud.google.com/composer" rel="noopener ugc nofollow" target="_blank"> AirFlow </a>来执行 SQL，并根据结果向 Slack 发送警报。对于每个警报，我们必须创建一个新的 DAG。这对于 2 或 3 个警报来说是没问题的，但是随着我们的成长，这种方法变得混乱了。气流开始被警报 Dag 淹没，我们需要一种更快的方法来设置新的警报。</p><p id="1222" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我们创造了一个更好的系统，我将在本文中分享！😁</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi lv"><img src="../Images/6b92beeac0cf6a87078230dd839039c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3U-BAV-kSZiTfII3-yUoww.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者图片</p></figure><h1 id="5838" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">它只需要一个主表</h1><p id="fbf1" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">现在，根据 SQL 查询的结果建立一个新的时差警报只需要主表中的一行。</p><p id="4a51" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们只需要插入要执行的 SQL 代码、CRON 触发器、要发送给 Slack 的格式化消息以及可选的 intro 消息。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="ab gu cl mt"><img src="../Images/2f4999e0c232c2366ac82ea110adcdc7.png" data-original-src="https://miro.medium.com/v2/format:webp/1*Gp91vLcoLhSkJoYdnQpb2w.png"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者截图</p></figure><p id="261b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">介绍消息(如果有)将首先发送。将为 SQL 查询产生的每一行发送格式化的消息。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mu"><img src="../Images/33fc57318a27db7d2f5c7005d71e991c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rjj8s9g6xxCc_FNSkkveBw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者图片</p></figure><p id="ec7d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那么，让我们来深入研究一下这个系统吧！</p><h1 id="c723" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">体系结构</h1><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi mv"><img src="../Images/37c108aa9e4e39a02981d3e160b04949.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vGIhrVH7_HMCPTHS_5kpNw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者模式</p></figure><p id="ccc1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该架构使用经典的生产者/消费者模式。它包括:</p><ul class=""><li id="0238" class="mw mx it kk b kl km ko kp kr my kv mz kz na ld nb nc nd ne bi translated"><strong class="kk iu">云调度器:</strong>启动系统。它定期调用我们的生产者，由 CRON 定义。</li><li id="d355" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu">主表:</strong>包含要触发的警报的所有信息。托管在 BigQuery 上。</li><li id="f089" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu"> Producer: </strong>查询主表，查找应该触发的警报，并将其推送到发布/订阅主题。</li><li id="3e45" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu">消费者:</strong>订阅发布/订阅以了解要执行的警报。执行 SQL 查询，并在必要时向 Slack 发送预警。</li><li id="8d3e" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu"> Pub/sub: </strong>一个分离生产者和消费者的简单话题。</li></ul><h1 id="fdd6" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">主表</h1><p id="e42c" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">主表包含所有关于预警的信息:<br/> <em class="nk">要执行什么 SQL？什么时候执行？把结果送到哪里？等等。</em></p><p id="ad8e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我决定在 BigQuery 上托管主表，但是您可以使用任何其他 SGBD。甚至 Google Sheet 也能工作。</p><p id="60a8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们的表具有以下结构:</p><ul class=""><li id="fb55" class="mw mx it kk b kl km ko kp kr my kv mz kz na ld nb nc nd ne bi translated"><strong class="kk iu">名称:</strong>警报的名称。我们将使用它作为一个 ID，这样我们的生产者可以告诉我们的消费者执行哪个警报。*</li><li id="c094" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu">描述:</strong>描述，用于提供信息。</li><li id="acdc" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu"> cron: </strong> CRON 表达式，用于确定给定警报的执行频率。</li><li id="42c1" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu"> last_execution: </strong>记录一个警报的上次执行时间，这样我们就知道下一次什么时候执行它</li><li id="4d69" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu"> sql: </strong>要执行的 sql 代码。该 SQL 的结果将包含作为警报发送的数据</li><li id="fca7" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu"> intro_msg: </strong>可选地，我们可以决定用一条介绍消息来介绍我们的提醒。</li><li id="09e4" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu"> row_msg: </strong>在 Slack 中显示数据的格式化方式。</li><li id="e846" class="mw mx it kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk iu">通道:</strong>我们希望在其中发送警报的空闲通道。</li></ul><p id="a433" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nk"> * BigQuery 不支持自动递增的 id 或唯一约束。因此，我们将通过名称来引用警报。确保你没有重复的。如果使用另一个 SGBDR，使用自动递增的整数作为 ID 可能更好。</em></p><p id="8102" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要创建主表，可以使用以下指令:</p><pre class="lf lg lh li gt nl nm nn no aw np bi"><span id="271a" class="nq lx it nm b gy nr ns l nt nu">CREATE OR REPLACE TABLE [your_schema].master (<br/>    name STRING,<br/>    description STRING,<br/>    cron STRING,<br/>    last_execution datetime,<br/>    sql STRING,<br/>    intro_msg STRING,<br/>    row_msg STRING,<br/>    channel STRING<br/>);</span></pre><h2 id="4b0f" class="nq lx it bd ly nv nw dn mc nx ny dp mg kr nz oa mi kv ob oc mk kz od oe mm of bi translated"><strong class="ak">示例:基于中等帖子发送每日警报</strong></h2><p id="36c6" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">假设您想要在每天早上 7:00 执行 SQL 查询的<strong class="kk iu">，并将格式化的结果发送到名为<strong class="kk iu"><em class="nk"># medium-alerts</em></strong>的通道。</strong></p><pre class="lf lg lh li gt nl nm nn no aw np bi"><span id="e4c4" class="nq lx it nm b gy nr ns l nt nu">## Number of posts by category published yesterday on medium<br/>SELECT category, count(post_id) as nb_posts<br/>FROM medium<br/>WHERE publishing_date = <!-- -->DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)<br/>GROUP BY category</span></pre><p id="13a2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于这种情况，执行将产生以下结果:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi og"><img src="../Images/6b100928cefcf95ef9f7a63d54de26b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g9LcLGlvn5HE8PFbs7Guyg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者截图</p></figure><p id="046a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据期望的输出格式，每行:<br/> <code class="fe oh oi oj nm b">{nb_posts} where published in {category}</code></p><p id="892f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">因此，主表需要包含以下记录:</strong></p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="ab gu cl mt"><img src="../Images/2f4999e0c232c2366ac82ea110adcdc7.png" data-original-src="https://miro.medium.com/v2/format:webp/1*Gp91vLcoLhSkJoYdnQpb2w.png"/></div></figure><p id="5db8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">因此，我们的时差警报将如下所示:</strong></p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ok"><img src="../Images/7055373c1590fc6a62739de528b8ac0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nrlS-4XqC4nyhGoRC50ICA.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者图片</p></figure><h1 id="d28b" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">生产者和消费者</h1><h2 id="358c" class="nq lx it bd ly nv nw dn mc nx ny dp mg kr nz oa mi kv ob oc mk kz od oe mm of bi translated">GCP 服务帐户</h2><p id="6188" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">首先，我们必须创建一个有权限运行我们系统的服务帐户。尽管有多种解决方案来处理这个问题，但让我们简化一下，创建一个包含这个项目所需的所有权限的服务帐户。</p><p id="a7ef" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">进入<strong class="kk iu"> GCP </strong> <strong class="kk iu"> IAM </strong>(身份和访问管理)，导航至您的<strong class="kk iu">服务账户</strong>。创建一个新的服务帐户，并为其命名。</p><p id="29b1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">添加所需的权限。首先，您需要以下内容:</p><pre class="lf lg lh li gt nl nm nn no aw np bi"><span id="39b5" class="nq lx it nm b gy nr ns l nt nu">Cloud Functions Invoker<br/>Pub/Sub Publisher<br/>BigQuery Data Viewer<br/>BigQuery Job User</span></pre><p id="ebec" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为您的消费者必须写入主表来更新最后的执行日期，所以您也可以授予<code class="fe oh oi oj nm b">BigQuery Data Editor</code>权限。但是如果这样做，您的服务帐户将拥有对 BigQuery 中所有内容的写权限。为了加强安全性，我们可以在您的主表上直接在表级别应用这些权限。</p><p id="a28a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，请转到<strong class="kk iu"> BigQuery </strong>，打开您的主表，并点击<strong class="kk iu"> Share </strong>。<br/>授予您的服务帐户<code class="fe oh oi oj nm b">BigQuery Data Editor</code>角色。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ol"><img src="../Images/891ea1ed5678ddbca677457f2543ed48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mhPNjzc9qbD2WDb5Dz_NPw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者截图</p></figure><h2 id="183d" class="nq lx it bd ly nv nw dn mc nx ny dp mg kr nz oa mi kv ob oc mk kz od oe mm of bi translated">发布/订阅</h2><p id="81ce" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">现在，您将不得不创建一个发布/订阅主题来分离您的生产者和您的消费者。只需转到 Pub/Sub，创建一个主题，并给它一个名称。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi om"><img src="../Images/05371ac9f097510f253509d4afd37cd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LfOdFDc83GygFvjtp2hXgg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者截图</p></figure><h2 id="f164" class="nq lx it bd ly nv nw dn mc nx ny dp mg kr nz oa mi kv ob oc mk kz od oe mm of bi translated">生产者</h2><p id="bc7e" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们的生产者将运行主表，并根据 CRON 表达式寻找要触发的警报。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi on"><img src="../Images/111c0a1a541549c50609514723341832.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_dOmDIOqKUo7SuYSVEQDdA.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者截图</p></figure><p id="7203" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要设置您的生产者，只需进入<strong class="kk iu"> GCP 云功能</strong>，并创建一个新功能。</p><p id="da97" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">命名它(我已经选择称它为 BigqueryAlertProducer)，选择 HTTP 作为你的<strong class="kk iu">触发类型</strong>，选择<strong class="kk iu">要求认证</strong>来触发你的函数。</p><p id="b737" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用之前创建的<strong class="kk iu">运行时服务帐户</strong>。</p><p id="b469" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，使用以下代码创建您的函数:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="oo op l"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">返回一个计数不是必须的，但是它可能有助于调试。不要忘记替换[您的项目]和[您的模式]。</p></figure><p id="7c51" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将<code class="fe oh oi oj nm b">get_alerts_to_execute</code>设置为进入终点。<br/>添加到<strong class="kk iu"> requirement.txt </strong>中的以下库:</p><pre class="lf lg lh li gt nl nm nn no aw np bi"><span id="3b79" class="nq lx it nm b gy nr ns l nt nu">google-cloud-bigquery<br/>google-cloud-pubsub<br/>croniter</span></pre><h2 id="f0f7" class="nq lx it bd ly nv nw dn mc nx ny dp mg kr nz oa mi kv ob oc mk kz od oe mm of bi translated">消费者</h2><p id="2778" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们的消费者将订阅 Pub/Sub，并执行通过主题收到的每个警报。为此，它必须从 BigQuery(主表)中读取 SQL 查询，执行它，如果需要，将格式化的结果发送到 Slack。最后，将警报的最后执行日期更新到主表中。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oq"><img src="../Images/0e656d0b6db15b3d6b46e55fb2421f1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C7r7GelWUqbTlGFCwDEqcw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者截图</p></figure><p id="f217" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">再次，创建一个新的云函数。</p><p id="c8f0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">命名它，选择<strong class="kk iu"> Cloud Pub/Sub </strong>作为您的<strong class="kk iu">触发器类型，</strong>并选择之前创建的主题。</p><p id="3b4f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用与生产者相同的<strong class="kk iu">运行时服务帐户</strong>。</p><p id="5c35" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，使用以下代码创建您的函数:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="oo op l"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">不要忘记替换您的 _PROJECT 和 _SCHEMA。</p></figure><p id="c953" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意，我们必须将 SLACK_BOT_TOKEN 设置为环境变量。在下一步中，我们将创建机器人并获取令牌。然后，您必须编辑您的函数，将令牌添加到您的运行时环境变量中。</p><p id="e947" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将<code class="fe oh oi oj nm b">trigger_pubsub</code>设置为入口端点。<br/>添加到<strong class="kk iu"> requirement.txt </strong>中的以下库:</p><pre class="lf lg lh li gt nl nm nn no aw np bi"><span id="cd25" class="nq lx it nm b gy nr ns l nt nu">google-cloud-bigquery<br/>google-cloud-pubsub<br/>croniter<br/>slack_sdk</span></pre><h2 id="46dd" class="nq lx it bd ly nv nw dn mc nx ny dp mg kr nz oa mi kv ob oc mk kz od oe mm of bi translated">调度程序</h2><p id="ad43" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">最后，让我们设置一个调度程序，它将每隔 X 分钟触发我们的生产者。</p><p id="b37a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">转到云调度程序，并创建一个新作业。给它一个名称和描述。然后，你必须通过一个 CRON 表达式来设置执行频率。比如用<code class="fe oh oi oj nm b">*/10 * * * *</code>每 10mn 发射一次。这个网站可能对定义你的 CRON 表达式有很大的帮助。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi or"><img src="../Images/4a27bebf5fe6f410df9629ebd59d7017.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oeyO6yES0CrOZzC6wM1aWw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者截图</p></figure><p id="9d22" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<strong class="kk iu">配置执行</strong>部分，选择<strong class="kk iu"> HTTP </strong>作为您的<strong class="kk iu">目标类型</strong>，选择<strong class="kk iu"> POST </strong>作为您的<strong class="kk iu"> HTTP 方法</strong>，并复制/粘贴您的<strong class="kk iu">生产者的 URL </strong>。</p><p id="c0a8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了调用生产者云函数，您需要对 HTTP 请求进行身份验证。设置以下标题:</p><pre class="lf lg lh li gt nl nm nn no aw np bi"><span id="6463" class="nq lx it nm b gy nr ns l nt nu">Content-Type: application/octet-stream<br/>User-Agent: Google-Cloud-Scheduler</span></pre><p id="4196" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<strong class="kk iu">认证头</strong>中，选择<code class="fe oh oi oj nm b">Add OIDC token</code>。并选择您之前创建的服务帐户。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi os"><img src="../Images/65f2ba3246757e02cdd400e3b8128e2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_2qLPq00nnHGHEburVt0Nw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者截图</p></figure><h1 id="fc78" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">Slack 应用</h1><p id="bc18" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这是最后一步！为了在空闲时发送警报，我们需要创建一个应用程序。</p><p id="1987" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">进入<a class="ae lu" href="https://api.slack.com/apps" rel="noopener ugc nofollow" target="_blank">https://api.slack.com/apps</a>，点击<strong class="kk iu">创建新应用</strong>。<br/>选择从头开始创建<strong class="kk iu"/>，给它一个名字并选择你的工作空间。</p><p id="f775" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在应用程序基本信息页面中，您可以随意个性化您的机器人外观🤖</p><p id="a51a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，使用左侧菜单导航至<strong class="kk iu"> OAuth &amp;权限</strong>。在 Bot Token 作用域中，您需要添加两个作用域:<code class="fe oh oi oj nm b">channel:read</code>和<code class="fe oh oi oj nm b">chat:write</code>。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ot"><img src="../Images/192e94624495be575c84293600c19359.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5kljd_OIGugERBdQplRGSg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者截图</p></figure><p id="714f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">向上滚动到您的工作区的<strong class="kk iu"> OAuth 令牌</strong>部分，并点击<strong class="kk iu">安装到工作区</strong>。按照流程安装您的应用程序。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ou"><img src="../Images/47419190f3334479af600561142ec090.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SD8tJBRA4wSk_wYR6WUCLw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">作者截图</p></figure><p id="9f4e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成后，回到同一个部分，在这里你可以访问你的应用程序的<strong class="kk iu"> Bot 用户 OAuth 令牌</strong>。从<code class="fe oh oi oj nm b">xoxb-...</code>开始。</p><p id="f68c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是您需要向您的消费者提供 Slack 访问权的令牌。复制它，编辑您的消费者函数，并将您的令牌添加到运行时环境变量中。</p><p id="cdcb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您只需将您的应用程序添加到您想要发送警报的 Slack 频道。</p><p id="9341" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就是这样！🎉🎉</p><h1 id="5532" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="1ddf" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">现在，您已经有了一个功能齐全的松弛预警系统，它基于您将在数据库中定义的任何自定义查询。尽管我们在本文中使用了 BigQuery，但是您可以将完全相同的系统用于任何数据库或任何云提供商。将架构翻译成 AWS lambda 和 SQS 并不困难。</p><p id="f20a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，正如我之前所说的:基于 SQL 的松弛警报是我最喜欢的基于数据的增长技巧之一。能够检测您的数据或重要用户行为的趋势，并通过专用渠道提供给您的团队，帮助我们防止客户流失，转化更多客户，等等💪</p></div></div>    
</body>
</html>