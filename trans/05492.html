<html>
<head>
<title>How To Predict Customer Churn From Your Website Logs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从你的网站日志中预测客户流失</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-predict-customer-churn-from-your-website-logs-bb02ea58385a?source=collection_archive---------14-----------------------#2021-05-15">https://towardsdatascience.com/how-to-predict-customer-churn-from-your-website-logs-bb02ea58385a?source=collection_archive---------14-----------------------#2021-05-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="cff6" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="7aa4" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">大规模音乐流媒体服务流失分析和预测实用指南(PySpark和Plotly)</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/6336cf60eee99e6c5712ec34bc08b267.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j8N-mHs4FP9rLjs-"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">照片由<a class="ae le" href="https://unsplash.com/@brucemars?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">布鲁斯·马尔斯</a>在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="d532" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><a class="ae le" href="#7942" rel="noopener ugc nofollow">简介</a> <br/> <a class="ae le" href="#dbeb" rel="noopener ugc nofollow">如何预测客户流失？</a> <br/> ∘ <a class="ae le" href="#9092" rel="noopener ugc nofollow">第一步:清理网站日志数据</a> <br/> ∘ <a class="ae le" href="#7ec3" rel="noopener ugc nofollow">第二步:将您的网站日志转换为用户日志数据集</a> <br/> ∘ <a class="ae le" href="#0e3f" rel="noopener ugc nofollow">第三步:探索两个用户群的数据(流失与停留)</a> <br/> ∘ <a class="ae le" href="#7039" rel="noopener ugc nofollow">第三步:使用ML算法预测客户流失</a> <br/> <a class="ae le" href="#f118" rel="noopener ugc nofollow">结论</a></p><h1 id="7942" class="mb mc iq bd md me mf mg mh mi mj mk ml kf mm kg mn ki mo kj mp kl mq km mr ms bi translated">介绍</h1><p id="0400" class="pw-post-body-paragraph lf lg iq lh b li mt ka lk ll mu kd ln lo mv lq lr ls mw lu lv lw mx ly lz ma ij bi translated">许多在线公司从订阅模式中获得很大一部分收入，因此追踪有多少客户停止使用他们的产品或服务是非常重要的。<strong class="lh ja">客户流失定义为现有客户取消订阅。如果我们能建立一个模型来预测一个当前客户是否会流失(1)或者不会流失(0)，那么公司就可以通过提供更多的促销或者改善服务来防止他们的用户流失。如果你想了解更多关于客户流失的信息，请查看这个<a class="ae le" href="https://www.profitwell.com/customer-churn/calculate-churn-rate" rel="noopener ugc nofollow" target="_blank">博客</a>。</strong></p><p id="2a99" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在许多面向客户的企业中，Spotify等音乐流媒体服务可以利用其网站和应用程序上的庞大用户交互数据来预测客户流失。由于网站日志通常是“大数据”，因此使用Spark等大数据库来分析它们并预测大规模流失是非常必要的。在本文中，我将从一个高层次的角度来指导您的流失预测项目，并分享一些可视化和预测结果。如果想跳转到实用教程，请查看我的<a class="ae le" href="https://www.kaggle.com/suhong/a-tutorial-using-plotly-spark-churn-prediction" rel="noopener ugc nofollow" target="_blank"> Kaggle帖子</a>(复制我的笔记本可以在线玩笔记本)或者<a class="ae le" href="https://github.com/suhongkim/Churn-Prediciton-At-Scale" rel="noopener ugc nofollow" target="_blank"> Github资源库</a> (fork或者下载代码到你的本地系统)</p><blockquote class="my mz na"><p id="2f4a" class="lf lg nb lh b li lj ka lk ll lm kd ln nc lp lq lr nd lt lu lv ne lx ly lz ma ij bi translated">你想先看看我的代码吗？请检查我的Kaggle笔记本或Github库。</p></blockquote><div class="nf ng gp gr nh ni"><a href="https://www.kaggle.com/suhong/a-tutorial-of-customer-churn-analysis-prediction" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd ja gy z fp nn fr fs no fu fw iz bi translated">客户流失分析与预测教程</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">使用Kaggle笔记本探索和运行机器学习代码|使用来自多个数据源的数据</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">www.kaggle.com</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw ky ni"/></div></div></a></div><div class="nf ng gp gr nh ni"><a href="https://github.com/suhongkim/Churn-Prediciton-At-Scale.git" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd ja gy z fp nn fr fs no fu fw iz bi translated">suhongkim/大规模流失预测</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">利用Sparkify(音乐流媒体网站)的用户日志文件的大数据，分析数据并预测用户流失</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">github.com</p></div></div><div class="nr l"><div class="nx l nt nu nv nr nw ky ni"/></div></div></a></div></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h1 id="dbeb" class="mb mc iq bd md me of mg mh mi og mk ml kf oh kg mn ki oi kj mp kl oj km mr ms bi translated">如何预测客户流失？</h1><p id="8f12" class="pw-post-body-paragraph lf lg iq lh b li mt ka lk ll mu kd ln lo mv lq lr ls mw lu lv lw mx ly lz ma ij bi translated">为了展示如何在实践中建立预测模型，我们将使用从虚拟音乐流媒体公司收集的虚构网站日志数据，该公司名为“Sparkify”，来自Udacity的数据科学Nanodegree。首先，我们需要将这些疯狂的网站日志转换成一个干净的、聚合的用户日志数据集。然后，我们将使用Plotly可视化库分析数据集中与客户流失相关的要素。最后，我们将提取有意义的特征，并选择适当的机器学习算法来预测客户流失。让我们开始吧！</p><h2 id="9092" class="ok mc iq bd md ol om dn mh on oo dp ml lo op oq mn ls or os mp lw ot ou mr iw bi translated">第一步:清理网站日志数据</h2><p id="1d80" class="pw-post-body-paragraph lf lg iq lh b li mt ka lk ll mu kd ln lo mv lq lr ls mw lu lv lw mx ly lz ma ij bi translated">让我们看看网站日志数据集的模式，并检查描述，以了解从网站收集了哪些类型的信息。请注意，粗体列名与客户流失有关，其他列名与网站日志信息有关。</p><pre class="kp kq kr ks gt ov ow ox oy aw oz bi"><span id="fd99" class="ok mc iq ow b gy pa pb l pc pd">| Column        | Type   | Description                           <br/>|---------------|--------|---------------------------------------- <br/>| <strong class="ow ja">ts</strong>            | long   | the timestamp of user log                <br/>| sessionId     | long   | an identifier for the current session   <br/>| auth          | string | the authentification log                <br/>| itemInSession | long   | the number of items in a single session <br/>| method        | string | HTTP request method (put/get)                                   <br/>| status        | long   | http status <br/>| userAgent     | string | the name of HTTP user agent             <br/>| <strong class="ow ja">userId</strong>        | string | the user Id                             <br/>| <strong class="ow ja">gender</strong>        | string | the user gender (F/M)                         <br/>| <strong class="ow ja">location</strong>      | string | the user location in US             <br/>| firstName     | string | the user first name                     <br/>| lastName      | string | the user last                           <br/>| <strong class="ow ja">registration</strong>  | long   | the timestamp when user registered      <br/>| <strong class="ow ja">level</strong>         | string | the subscription level (free, paid)                                  <br/>| <strong class="ow ja">artist</strong>        | string | the name of the artist played by users <br/>| <strong class="ow ja">song</strong>          | string | the name of songs played by users<br/>| length        | double | the length of a song in seconds  <br/>| <strong class="ow ja">page</strong>          | string | the page name visited by users</span><span id="f0f4" class="ok mc iq ow b gy pe pb l pc pd">** the categories of <strong class="ow ja">page</strong>:  Home, Login, LogOut, Settings, Save Settings, about, NextSong, Thumbs Up, Thumbs Down, Add to Playlist, Add Friend, Roll Advert, Upgrade, Downgrade, help, Submit Downgrade, Cancel, <strong class="ow ja">Cancellation Confrimation</strong></span></pre><p id="7c62" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我删除了一些<code class="fe pf pg ph ow b">userId</code>为空的记录，然后添加了一个目标列(<code class="fe pf pg ph ow b">churn</code>)和三个额外的列，如下所示。</p><ul class=""><li id="d081" class="pi pj iq lh b li lj ll lm lo pk ls pl lw pm ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">churn</code>(整数):使用<code class="fe pf pg ph ow b">Cancellation Confirmation</code>事件为付费和免费用户定义的流失状态(1:流失，0:停留)</li><li id="caef" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">ds</code>(日期):时间戳数据转换成的日期戳<code class="fe pf pg ph ow b">ts</code></li><li id="e8e0" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">dsRestration</code>(日期):从时间戳数据转换的日期戳<code class="fe pf pg ph ow b">registration</code></li><li id="ce79" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">locCity</code>(字符串):来自<code class="fe pf pg ph ow b">location</code>数据的城市名称</li></ul><pre class="kp kq kr ks gt ov ow ox oy aw oz bi"><span id="3784" class="ok mc iq ow b gy pa pb l pc pd">Below is the sample of new columns<br/>+------+-----+----------+--------------+--------------+<br/>|userId|<strong class="ow ja">churn</strong>|        ds|dsRegistration|       locCity|<br/>+------+-----+----------+--------------+--------------+<br/>|100010|    0|2018-10-08|    2018-09-27|    Bridgeport|<br/>|200002|    0|2018-10-01|    2018-09-06|       Chicago|<br/>|   125|    1|2018-10-12|    2018-08-01|Corpus Christi|<br/>+------+-----+----------+--------------+--------------+</span></pre><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="pw px l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">网站日志数据集</p></figure><h2 id="7ec3" class="ok mc iq bd md ol om dn mh on oo dp ml lo op oq mn ls or os mp lw ot ou mr iw bi translated">第二步:将你的网站日志转换成用户日志数据集</h2><p id="8572" class="pw-post-body-paragraph lf lg iq lh b li mt ka lk ll mu kd ln lo mv lq lr ls mw lu lv lw mx ly lz ma ij bi translated">为了预测用户的流失状态，需要为每个用户转换网站日志数据。首先，我们需要丢弃一些与客户流失事件无关的列，比如会话日志和用户名。然后，我们可以基于<code class="fe pf pg ph ow b">userId</code>转换数据，有两种类型的数据:用户信息和用户活动。我们的数据中的用户信息列是<code class="fe pf pg ph ow b">churn</code>、<code class="fe pf pg ph ow b">gender</code>、<code class="fe pf pg ph ow b">level</code>和<code class="fe pf pg ph ow b">locCity</code>，对于每个用户必须是相同的。</p><pre class="kp kq kr ks gt ov ow ox oy aw oz bi"><span id="88e1" class="ok mc iq ow b gy pa pb l pc pd">+------+-----+------+-----+--------------+<br/>|userId|churn|gender|level|       locCity|<br/>+------+-----+------+-----+--------------+<br/>|100010|    0|     F| free|    Bridgeport|<br/>|200002|    0|     M| free|       Chicago|<br/>|   125|    1|     M| free|Corpus Christi|<br/>+------+-----+------+-----+--------------+</span></pre><p id="bc7a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">对于用户活动数据，我们需要聚集日志数据来创建一些有意义的特性。我在下面列出了添加到用户日志数据集中的新列。</p><ul class=""><li id="a00a" class="pi pj iq lh b li lj ll lm lo pk ls pl lw pm ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">lifeTime</code> (long):用户生存期是用户在网站上存在的时间，数字表示从注册日期到最后一次活动登录日期的天数</li><li id="d10d" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">playTime</code> (double):歌曲播放时间是指用户访问<code class="fe pf pg ph ow b">next song</code>页面时，总播放歌曲的平均时间(秒)</li><li id="8642" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">numSongs</code> (long):每个用户的歌曲名称总数</li><li id="232b" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">numArtists</code> (long):每个用户的艺术家姓名总数</li><li id="bc8e" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">numPage_*</code> (long):每个页面、每个用户的页面访问总数。请注意，<code class="fe pf pg ph ow b">Cancellation</code>和<code class="fe pf pg ph ow b">Conform cancellation</code>页面不考虑用于特征组，因为它们用于生成<code class="fe pf pg ph ow b">churn</code>标签。另外，<code class="fe pf pg ph ow b">Login</code>和<code class="fe pf pg ph ow b">Register</code>在我们的数据集中对所有用户都没有计数，所以它们会被自动删除</li></ul><pre class="kp kq kr ks gt ov ow ox oy aw oz bi"><span id="d706" class="ok mc iq ow b gy pa pb l pc pd">+--------------+-----------------+--------+----------+-------------+<br/>|lifeTime(days)|    PlayTime(sec)|numSongs|numArtists|    numPage_*|<br/>+--------------+-----------------+--------+----------+-------------+<br/>|            55|318224.4166666667|     269|       252|            1|<br/>|            70|187044.0476190476|     378|       339|            3|<br/>|            72|           1762.0|       8|         8|            0|<br/>+--------------+-----------------+--------+----------+-------------+</span></pre><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="pw px l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">用户日志数据集</p></figure><p id="4407" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在开始可视化之前，让我们用几个数字总结一下我们到目前为止所做的工作！</p><pre class="kp kq kr ks gt ov ow ox oy aw oz bi"><span id="b4e3" class="ok mc iq ow b gy pa pb l pc pd">The shape of the raw data: (286500, 18)<br/>The shape of the clean data: (278154, 18)<br/>The shape of the website-log data: (278154, 22)<br/>The shape of the User-Log data(df_user): (225, 26)</span><span id="32c8" class="ok mc iq ow b gy pe pb l pc pd">The number of users (unique userId): 225<br/>The count of churned users (1): 52<br/>The count of Not-Churned users (0): 173</span><span id="8200" class="ok mc iq ow b gy pe pb l pc pd">The logging period: 2018-10-01 - 2018-12-03</span></pre><h2 id="0e3f" class="ok mc iq bd md ol om dn mh on oo dp ml lo op oq mn ls or os mp lw ot ou mr iw bi translated">第三步:探索两个用户群的数据(搅动与停留)</h2><p id="771a" class="pw-post-body-paragraph lf lg iq lh b li mt ka lk ll mu kd ln lo mv lq lr ls mw lu lv lw mx ly lz ma ij bi translated">将与我们的目标价值相关的特征可视化非常重要，因为我们对客户流失事件背后的机制有更好的直觉。让我们从揭示每月被搅动的用户数量是如何变化的开始(这个小型数据集的记录周期是2个月长)</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="py px l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图片作者:苏红·金</p></figure><blockquote class="my mz na"><p id="f612" class="lf lg nb lh b li lj ka lk ll lm kd ln nc lp lq lr nd lt lu lv ne lx ly lz ma ij bi translated">总用户数从10月份的213人下降到11月份的187人。具体来说，停留用户数略微增加了4人，而流失用户数减少了一半以上(10月份为55人，11月份为22人)，这表明Sparkify服务成功地留住了现有客户。如果我们有更多关于Sparkify业务和活动的数据，我们就可以从这一观察中分析什么样的因素会影响更少的客户流失。</p></blockquote><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="py px l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图片作者:苏红·金</p></figure><blockquote class="my mz na"><p id="866f" class="lf lg nb lh b li lj ka lk ll lm kd ln nc lp lq lr nd lt lu lv ne lx ly lz ma ij bi translated">我们可以观察到男性用户倾向于搅拌更多。</p><p id="c35a" class="lf lg nb lh b li lj ka lk ll lm kd ln nc lp lq lr nd lt lu lv ne lx ly lz ma ij bi translated">免费订阅级别的用户在请求<code class="fe pf pg ph ow b">Submit Downgrade</code>但未到达<code class="fe pf pg ph ow b">cancellation confirmation</code>页面时可能处于流失状态—请注意，我们仅在用户访问取消确认页面时定义流失状态。因此，这一类别中的那些过去的订户可以成为营销人员为该网站留住更多用户的主要目标。</p></blockquote><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="py px l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图片作者:苏红·金</p></figure><blockquote class="my mz na"><p id="e075" class="lf lg nb lh b li lj ka lk ll lm kd ln nc lp lq lr nd lt lu lv ne lx ly lz ma ij bi translated">你可以从上面的散点图中看到的流失率是每个城市中流失用户与人口的比例。由于该数据集是合成的，城市的流失率显示出许多极值，如0%或100% ，这导致<strong class="lh ja">我们需要为我们的预测模型排除该特征的结论。</strong></p></blockquote><p id="462e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">到目前为止，我们已经探索了分类特征，如性别、订阅级别和位置(第一个图表“时间分析”只是为了了解被搅动的用户的趋势)。正如您在步骤2部分看到的，我们生成了新的数字特征来描述网站上的用户活动。让我们把它们形象化！</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="py px l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图片作者:苏红·金</p></figure><blockquote class="my mz na"><p id="0518" class="lf lg nb lh b li lj ka lk ll lm kd ln nc lp lq lr nd lt lu lv ne lx ly lz ma ij bi translated">搅动的用户倾向于比停留的用户具有更短的寿命和歌曲播放时间。</p><p id="80b5" class="lf lg nb lh b li lj ka lk ll lm kd ln nc lp lq lr nd lt lu lv ne lx ly lz ma ij bi translated">兴奋组倾向于选择种类稍少的歌曲和艺术家(两张图看起来相似，可能有很高的相关性)</p></blockquote><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="py px l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图片作者:苏红·金</p></figure><blockquote class="my mz na"><p id="3997" class="lf lg nb lh b li lj ka lk ll lm kd ln nc lp lq lr nd lt lu lv ne lx ly lz ma ij bi translated">当我们从原始数据集中的页面列中创建17个不同的特征时，我选择了一些重要的特征来在上面的图表中可视化。其中，<strong class="lh ja">我注意到页面</strong> <code class="fe pf pg ph ow b"><strong class="lh ja">SubmitDowngrade</strong></code> <strong class="lh ja">与其他页面相比似乎具有离散分布，因此我决定将该特征从预测模型的数值变量更改为分类变量。</strong></p></blockquote><h2 id="7039" class="ok mc iq bd md ol om dn mh on oo dp ml lo op oq mn ls or os mp lw ot ou mr iw bi translated">第三步:使用ML算法预测客户流失</h2><p id="afcd" class="pw-post-body-paragraph lf lg iq lh b li mt ka lk ll mu kd ln lo mv lq lr ls mw lu lv lw mx ly lz ma ij bi translated">通过可视化，我们最终可以通过修改用户日志数据集来为预测模型选择我们的特征，如下所示。</p><ul class=""><li id="6fcc" class="pi pj iq lh b li lj ll lm lo pk ls pl lw pm ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">LocCity</code>将从特征集中删除，因为它有许多极值</li><li id="290b" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">numSongs</code>和<code class="fe pf pg ph ow b">numArts</code>高度相关(0.99)，因此<code class="fe pf pg ph ow b">numSongs</code>将仅被选择用于特征集</li><li id="97c5" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma pn po pp pq bi translated"><code class="fe pf pg ph ow b">numPage_SubmitDowngrade</code>将被转换为只有两个值的分类特征<code class="fe pf pg ph ow b">page_SubmitDowngrade</code>:已访问或无</li><li id="21eb" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma pn po pp pq bi translated">与<code class="fe pf pg ph ow b">page</code>栏相关的特征相互之间有很多关联，所以我只选择了7个特征:<code class="fe pf pg ph ow b">numPage_About</code>、<code class="fe pf pg ph ow b">numPage_Error</code>、<code class="fe pf pg ph ow b">numPage_RollAdvert</code>、<code class="fe pf pg ph ow b">numPage_SaveSettings</code>、<code class="fe pf pg ph ow b">numPage_SubmitDowngrade</code>、<code class="fe pf pg ph ow b">numPage_ThumbsDown</code>、<code class="fe pf pg ph ow b">numPage_Upgrade</code></li></ul><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pz"><img src="../Images/bc59aabd194c69c73ba4d186c3c3280c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w-Jn2ItdMFLtMJ7s_CrMzw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图片作者:苏红·金</p></figure><pre class="kp kq kr ks gt ov ow ox oy aw oz bi"><span id="b1d1" class="ok mc iq ow b gy pa pb l pc pd">The schema of df_feat<br/> |-- userId: string, User Identification Info (not used for feature)<br/> |-- <strong class="ow ja">label</strong>: integer, the target(Churn) for the prediction model<br/> &lt;Categorical Features&gt;<br/> |-- gender: string ('F' or 'M')<br/> |-- level: string ('paid' or 'free')<br/> |-- page_SubmitDowngrade: string ('visited' or 'none')<br/> &lt;Numerical Features&gt; <br/> |-- lifeTime: integer <br/> |-- playTime: double <br/> |-- numSongs: long <br/> |-- numPage_About: long <br/> |-- numPage_Error: long <br/> |-- numPage_RollAdvert: long <br/> |-- numPage_SaveSettings: long <br/> |-- numPage_SubmitUpgrade: long <br/> |-- numPage_ThumbsDown: long <br/> |-- numPage_Upgrade: long </span></pre><p id="5e7e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">让我们开始使用Spark中的ML库来构建预测模型的管道。为了更好的交叉验证，我将所有的特征转换和一个估计器合并到一个管道中，并将其送入<code class="fe pf pg ph ow b">CrossValidator</code>。管道有三个主要部分。</p><ol class=""><li id="aecc" class="pi pj iq lh b li lj ll lm lo pk ls pl lw pm ma qa po pp pq bi translated"><strong class="lh ja">特征转换</strong>:类别变量将被<code class="fe pf pg ph ow b">StringIndexer</code>和<code class="fe pf pg ph ow b">OneHotEncoder</code>转换成一个热点编码向量。然后，使用<code class="fe pf pg ph ow b">VectorAssembler.</code>将分类向量和数值变量组装成密集特征向量</li><li id="3510" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma qa po pp pq bi translated"><strong class="lh ja">特性重要性选择</strong>:我构建了一个定制的<code class="fe pf pg ph ow b">FeatureSelector</code>类，使用一个基于树的评估器只提取重要的特性。这一步是可选的，所以我没有将它用于逻辑回归或LinearSVC模型。</li><li id="184f" class="pi pj iq lh b li pr ll ps lo pt ls pu lw pv ma qa po pp pq bi translated"><strong class="lh ja">估计器</strong>:最后一步是使用ML算法来估计每个用户的流失标签。</li></ol><p id="005e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">有了这个管道，我选择了五个不同的估值器来根据F1分数选择带有默认参数的最佳算法，因为我们的数据是不平衡的。作为下面的结果，我为我们的预测模型选择了<code class="fe pf pg ph ow b">RandomForestClassifier</code>，它显示了最高的验证分数(0.78)。</p><pre class="kp kq kr ks gt ov ow ox oy aw oz bi"><span id="6322" class="ok mc iq ow b gy pa pb l pc pd">&lt;The result of the model selection&gt;<br/>--------------------<br/><strong class="ow ja">LogisticRegressionModel</strong>: numClasses=2, numFeatures=16<br/>train_f1: 0.8275, test_f1: 0.7112<br/>--------------------<br/><strong class="ow ja">LinearSVCModel</strong>: numClasses=2, numFeatures=16<br/>train_f1: 0.8618, test_f1: 0.7472<br/>--------------------<br/><strong class="ow ja">DecisionTreeClassificationModel</strong>: depth=5, numNodes=31, numFeatures=7<br/>idx                name     score<br/>0    0            lifeTime  0.439549<br/>1    1            numSongs  0.207649<br/>2    2  numPage_ThumbsDown  0.137043<br/>3    3  numPage_RollAdvert  0.096274<br/>4    4            playTime  0.062585<br/>5    5       numPage_Error  0.045681<br/>6    6       numPage_About  0.011218</span><span id="51e4" class="ok mc iq ow b gy pe pb l pc pd">train_f1: 0.9373, test_f1: 0.7667<br/>--------------------<br/><strong class="ow ja">RandomForestClassificationModel</strong>:numTrees=20, numFeatures=12<br/>    idx                   name     score<br/>0     0               lifeTime  0.315996<br/>1     1               playTime  0.174795<br/>2     2     numPage_ThumbsDown  0.101804<br/>5     5               numSongs  0.089395<br/>3     3     numPage_RollAdvert  0.080125<br/>6     6        numPage_Upgrade  0.053891<br/>4     4          numPage_About  0.053557<br/>7     7          numPage_Error  0.051073<br/>8     8   numPage_SaveSettings  0.033237<br/>9     9  numPage_SubmitUpgrade  0.024314<br/>11   11            genderVec_M  0.012589<br/>10   10          levelVec_paid  0.009225</span><span id="d57b" class="ok mc iq ow b gy pe pb l pc pd">train_f1: 0.9086, test_f1: 0.7788<br/>--------------------<br/><strong class="ow ja">GBTClassificationModel</strong>: numTrees=20, numFeatures=11<br/>    idx                   name     score<br/>0     0     numPage_ThumbsDown  0.276418<br/>1     1               lifeTime  0.191477<br/>2     2               numSongs  0.104416<br/>4     4     numPage_RollAdvert  0.080323<br/>5     6          numPage_About  0.074554<br/>9     5          levelVec_free  0.068573<br/>3     3               playTime  0.067631<br/>6     7        numPage_Upgrade  0.050553<br/>7     8          numPage_Error  0.042485<br/>10    9            genderVec_M  0.029921<br/>8    10  numPage_SubmitUpgrade  0.013649</span><span id="6e74" class="ok mc iq ow b gy pe pb l pc pd">train_f1: 1.0, test_f1: 0.7615</span></pre><p id="69a6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">最后，我运行了交叉验证来调整<code class="fe pf pg ph ow b">RandomForestClassifier</code>的超参数。由于我们的数据集非常小，您可以观察到几乎完美的训练分数，表明模型过度拟合。因此，我选择了一些交叉验证参数映射，以使该模型与我在上述模型选择中使用的默认模型(numTrees=20)相比不那么复杂。<strong class="lh ja">结果显示，具有10棵树和16个最大箱的模型具有稍好的性能，但是没有很好地克服过拟合问题。我假设这个问题可以通过增加更多的数据来解决。</strong></p><pre class="kp kq kr ks gt ov ow ox oy aw oz bi"><span id="21ce" class="ok mc iq ow b gy pa pb l pc pd"><strong class="ow ja">RandomForestClassificationModel</strong>: numTrees=10, numFeatures=11<br/><strong class="ow ja">Best parameters</strong>:[('bootstrap', True), ('cacheNodeIds', False), ('checkpointInterval', 10), ('featureSubsetStrategy', 'auto'), <strong class="ow ja">('impurity', 'gini'), ('maxBins', 16), ('maxDepth', 5), ('numTrees', 10)</strong>, ('maxMemoryInMB', 256), ('minInfoGain', 0.0), ('minInstancesPerNode', 1), ('minWeightFractionPerNode', 0.0), ('seed', -5400988877677221036), ('subsamplingRate', 1.0)]<br/>    idx                             name     score<br/>0     0                         lifeTime  0.346846<br/>1     1                         playTime  0.160187<br/>2     2                         numSongs  0.104921<br/>5     5               numPage_ThumbsDown  0.102716<br/>6     6                    numPage_About  0.075681<br/>4     4                  numPage_Upgrade  0.075326<br/>3     3               numPage_RollAdvert  0.048552<br/>7     7                    numPage_Error  0.044421<br/>8     8             numPage_SaveSettings  0.028647<br/>9     9                    levelVec_free  0.009174<br/>10   10  page_SubmitDowngradeVec_visited  0.003529</span><span id="e400" class="ok mc iq ow b gy pe pb l pc pd"><strong class="ow ja">train_f1: 0.9287, valid_f1: 0.7608 test_f1: 0.7255</strong></span></pre><h1 id="f118" class="mb mc iq bd md me mf mg mh mi mj mk ml kf mm kg mn ki mo kj mp kl mq km mr ms bi translated">结论</h1><p id="58e2" class="pw-post-body-paragraph lf lg iq lh b li mt ka lk ll mu kd ln lo mv lq lr ls mw lu lv lw mx ly lz ma ij bi translated">在本文中，我们解决了最具挑战性和最常见的业务问题之一——如何预测客户流失。从令人讨厌的巨大网站日志中，我们提取了每个用户的几个有意义的特征，并基于两个用户组(搅动与停留)将它们可视化，以进行更多分析。最后，我们建立了包括特征变换和估计器的ML流水线，它被馈送到交叉验证器用于模型选择和超参数调整。最终模型显示了相当高的测试分数(f1分数:0.73)，但由于小数据集大小(128MB)的限制，它也存在过拟合问题。由于Udacity在AWS cloud上提供了完整的数据集(12GB ),我有一个计划来部署这个Spark集群，以便很快处理过拟合问题。</p><p id="a496" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">当然，在不考虑数据大小的情况下，我们可以做很多事情来改进这个模型。首先，不管时间因素如何，大多数特征都是聚合的。日志收集时间为2个月，因此最好使用不同的方法(如加权总和)强调最近的日志。此外，我们可以应用一些策略来处理数据不平衡(这个<a class="ae le" href="https://www.analyticsvidhya.com/blog/2017/03/imbalanced-data-classification/" rel="noopener ugc nofollow" target="_blank">博客</a>将帮助你得到一些想法)。此外，我们可以将这个问题建模为时间序列模型，因为流失率应该定期报告给业务利益相关者。</p><p id="6ade" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我希望这个项目能够为您提供一个教程，教您如何使用数据科学和机器学习技能来处理大数据，以解决现实世界中的一个问题。另外，使用Spark和Plotly库也是很好的练习。感谢您的阅读，并希望通过我的<a class="ae le" href="http://www.linkedin.com/in/suhongkim" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>随时与您联系！</p></div></div>    
</body>
</html>