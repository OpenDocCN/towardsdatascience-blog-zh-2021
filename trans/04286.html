<html>
<head>
<title>Exploring hail reports with BigQuery and Data Studio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery和Data Studio探索冰雹报告</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/exploring-hail-reports-with-bigquery-and-data-studio-dd6f903b624b?source=collection_archive---------26-----------------------#2021-04-11">https://towardsdatascience.com/exploring-hail-reports-with-bigquery-and-data-studio-dd6f903b624b?source=collection_archive---------26-----------------------#2021-04-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e248" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在Data Studio中使用新的地理空间功能</h2></div><p id="ea5f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们通过探索NOAA风暴预测中心冰雹风暴报告的公共数据集，来体验一下Data Studio中新的地理空间功能。请跟随我——有一个免费的BigQuery沙箱可供您使用。Data Studio是一款免费产品。</p><h2 id="fc2c" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">在BigQuery中查询</h2><p id="ae2f" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">转到位于<a class="ae lz" href="https://console.cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/bigquery</a>的BigQuery web控制台，键入以下查询:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="09ea" class="lb lc iq mf b gy mj mk l ml mm">SELECT <br/>  FORMAT_DATE('%B', event_begin_time) AS month,<br/>  magnitude AS hail_inches, <br/>  <strong class="mf ir">event_point</strong><br/>FROM `bigquery-public-data.noaa_historic_severe_storms.storms_2020`<br/>WHERE event_type = 'hail'</span></pre><p id="e2c8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的查询中需要注意的重要一点是event_point是一个地理类型。如果您的表有纬度和经度列，那么使用以下命令从这些列创建一个地理类型:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="fc1c" class="lb lc iq mf b gy mj mk l ml mm">ST_GeogPoint(longitude, latitude) as event_point</span></pre><p id="fad4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于加载地理数据的更多信息，请查阅<a class="ae lz" href="https://cloud.google.com/bigquery/docs/gis-data" rel="noopener ugc nofollow" target="_blank"> BigQuery docs </a>。</p><h2 id="4f39" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">Data Studio中的地理空间数据</h2><p id="edd3" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">然后使用BigQuery web控制台中的下拉菜单“Explore Data ”,选择Data Studio。</p><p id="b7f3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Data Studio中，将图表更改为地图:</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/25f156932bdaace1d8fd0c0427916aac.png" data-original-src="https://miro.medium.com/v2/resize:fit:628/format:webp/1*dNrgsWTWW8-CidwjuXTfDg.png"/></div></figure><p id="2cc6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后拖动可用字段来设置图表，如下所示:</p><ul class=""><li id="4c2b" class="mr ms iq kh b ki kj kl km ko mt ks mu kw mv la mw mx my mz bi translated">拖动hail_inches字段作为位置维度。根据冰雹的大小，圆圈会变大或变小。</li><li id="c49e" class="mr ms iq kh b ki na kl nb ko nc ks nd kw ne la mw mx my mz bi translated">将event_point字段拖动到地理空间字段。它将设置圆圈的位置。</li><li id="a63e" class="mr ms iq kh b ki na kl nb ko nc ks nd kw ne la mw mx my mz bi translated">移除颜色度量。</li></ul><p id="77f8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将是它的样子:</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nf"><img src="../Images/ebf293ffa1feecc62efcd40e4d8ba90e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v4RjCM_5KKTUdENwDcm1qQ.png"/></div></div></figure><p id="06bc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是大量的数据。让我们允许用户过滤东西。</p><h2 id="3d94" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">过滤</h2><p id="2e7d" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">将“月份”字段拖到顶部显示“过滤器”的位置。这将允许用户按月过滤图表。</p><p id="95ce" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果观众只选择一月和二月，他们会得到:</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nk"><img src="../Images/6df81df8e4ad6053c5197a54251ab72b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_lJs8ztoWgWxSMMERMQH-A.png"/></div></div></figure><h2 id="3960" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">BigQuery中的聚合</h2><p id="6896" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们当然可以使用BigQuery来聚集数据，然后在Data Studio中可视化聚集的数据。例如，让我们按月找到质心并显示它们，而不是显示每个月的所有冰雹报告。</p><p id="b04c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在的问题是:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="f662" class="lb lc iq mf b gy mj mk l ml mm">SELECT <br/>  FORMAT_DATE('%B', event_begin_time) AS month,<br/>  COUNT(*) AS num_events,<br/>  ST_CENTROID_AGG(event_point) AS centroid<br/>FROM `bigquery-public-data.noaa_historic_severe_storms.storms_2020`<br/>WHERE event_type = 'hail'<br/>GROUP BY month</span></pre><p id="61df" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">按如下方式设置Data Studio:</p><ul class=""><li id="b66d" class="mr ms iq kh b ki kj kl km ko mt ks mu kw mv la mw mx my mz bi translated">将质心设置为地理空间字段</li><li id="7e92" class="mr ms iq kh b ki na kl nb ko nc ks nd kw ne la mw mx my mz bi translated">将月份设置为颜色维度(这样不同的月份会有不同的颜色)</li></ul><p id="6386" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将获得以下关于形心逐月变化的视图:</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nl"><img src="../Images/e6776c66aa6e1bfcb13526c9af4ead2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wo8tNfN7fDwJbrai0I6dNQ.png"/></div></div></figure><h2 id="9af9" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">结合两种方法</h2><p id="d936" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我们还可以通过以下方式将这两种方法(总量+点数)结合起来:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="d30d" class="lb lc iq mf b gy mj mk l ml mm">WITH hail AS (<br/>SELECT <br/>  FORMAT_DATE('%B', event_begin_time) AS month,<br/>  MAX(magnitude) AS max_hail, <br/>  COUNT(*) AS num_events,<br/>  <strong class="mf ir">ST_UNION_AGG</strong>(event_point) AS <strong class="mf ir">points</strong>,<br/>  ST_CENTROID_AGG(event_point) AS <strong class="mf ir">centroid</strong><br/>FROM `bigquery-public-data.noaa_historic_severe_storms.storms_2020`<br/>WHERE event_type = 'hail'<br/>GROUP BY month<br/>)</span><span id="84db" class="lb lc iq mf b gy nm mk l ml mm">SELECT <br/>  *,<br/>  <strong class="mf ir">ST_CONVEXHULL</strong>(points) AS <strong class="mf ir">hull</strong><br/>FROM hail</span></pre><p id="7b81" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们既有单个的点，也有像质心和外壳这样的集合。</p><p id="594d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一月份的船体:</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nn"><img src="../Images/730981e359d204643500df7e552e3b8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y1z-BgN-FQurxzR0Q1U0Eg.png"/></div></div></figure><p id="021f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">相对于单个点:</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi no"><img src="../Images/73e3999d11ea092051394fcb91781fc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aKAY3-uwog52NDanKDi5Gg.png"/></div></div></figure><h2 id="5980" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">共享报告</h2><p id="b2f3" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">要共享报告，请单击共享按钮。选择创建新报告。</p><p id="193f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，选择“添加控件”，选择下拉列表，并将控件字段设置为“月”。类似地，添加另一个控件，选择Slider并将控件字段设置为hail_inches。该报告现在将如下所示:</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi np"><img src="../Images/44df49b6004b34700ecf0dd23917416f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uh6S6FYDd-CJqQDyN-7ZFg.png"/></div></div></figure><p id="ca85" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将报告的名称更改为2020年冰雹月报告。然后单击“查看”,查看与您共享报告的人会看到什么。注意他们如何使用月份和滑块来探索。例如，这是所有1.7英寸以上冰雹的视图。地图会自动缩放至感兴趣的区域。</p><figure class="ma mb mc md gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nq"><img src="../Images/aa1a11f15294d013d9a6f7f9cee4b67a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-rdY2APTQw0SZVUCOeaULw.png"/></div></div></figure><p id="ec35" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要将报告嵌入为iframe，您可以通过选择“Share”下的下拉菜单来获得嵌入的html代码。</p><h2 id="165b" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">稍后自定义报告</h2><p id="2bb8" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">你可以通过导航到<a class="ae lz" href="https://datastudio.google.com/" rel="noopener ugc nofollow" target="_blank">https://datastudio.google.com/</a>找到你正在处理的报告。数据的来源将在“数据源”中，以防您想要定制查询。</p><p id="79a2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p></div></div>    
</body>
</html>