<html>
<head>
<title>Deploying a Scalable End to End Customer Churn Prediction Solution with AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS部署可扩展的端到端客户流失预测解决方案</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-a-scalable-end-to-end-customer-churn-prediction-solution-with-aws-cbf3536be996?source=collection_archive---------17-----------------------#2021-05-13">https://towardsdatascience.com/deploying-a-scalable-end-to-end-customer-churn-prediction-solution-with-aws-cbf3536be996?source=collection_archive---------17-----------------------#2021-05-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c5ec" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><em class="kf">用于生产就绪的端到端客户流失预测管道的部署包</em></h2></div><p id="6a5f" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">由<a class="ae lc" href="https://www.linkedin.com/in/sunbc0120/" rel="noopener ugc nofollow" target="_blank">百川孙</a>、<a class="ae lc" href="https://www.linkedin.com/in/cfrenzel/" rel="noopener ugc nofollow" target="_blank">查理斯弗伦泽尔</a>、<a class="ae lc" href="https://www.linkedin.com/in/yin-song-19b2702b/" rel="noopener ugc nofollow" target="_blank">宋寅</a>和<a class="ae lc" href="https://au.linkedin.com/in/eduthie" rel="noopener ugc nofollow" target="_blank">伊登迪希</a></p><p id="1551" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">失去客户要花钱。发现可能会离开的客户，然后阻止他们流失，这样可以省钱。如果你能留住客户更长时间，最大化他们一生的收入，这不是很好吗？如果这可以通过机器学习大规模实现，那不是更好吗？</p><p id="1f04" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">猜猜看，现在你可以了！</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi ld"><img src="../Images/47ffb0dbd609189df73d558fe19a33e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*ZTNtFWpDbgDG_n_6"/></div><p class="ll lm gj gh gi ln lo bd b be z dk translated"><em class="kf">来源:金次郎</em><a class="ae lc" href="http://www.brandonlepine.art/" rel="noopener ugc nofollow" target="_blank"><em class="kf">www.brandonlepine.art/</em></a><em class="kf">，承蒙</em> <a class="ae lc" href="https://giphy.com/" rel="noopener ugc nofollow" target="_blank"> <em class="kf">吉菲</em> </a></p></figure><p id="19a4" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这篇博文中，您将使用AWS服务部署一个端到端的客户流失预测解决方案。您将使用<a class="ae lc" href="https://aws.amazon.com/sagemaker/" rel="noopener ugc nofollow" target="_blank"> Amazon SageMaker </a>和<a class="ae lc" href="https://aws.amazon.com/step-functions/?step-functions.sort-by=item.additionalFields.postDateTime&amp;step-functions.sort-order=desc" rel="noopener ugc nofollow" target="_blank"> AWS步骤函数</a>构建自动训练和推理管道，用于机器学习流失检测。除了识别最有可能流失的客户之外，随需应变的能力，作为ETL过程运行，支持预处理，并具有可解释性。AWS 上的<a class="ae lc" href="https://github.com/awslabs/aws-customer-churn-pipeline" rel="noopener ugc nofollow" target="_blank">客户流失渠道是以基础设施为模板的代码，使其能够扩展和重新应用。该解决方案作为参考实施，使各种规模的组织更容易实施端到端的训练和推理管道。</a></p><p id="0797" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">该解决方案通过使用<a class="ae lc" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> Amazon Lambda </a>调用来触发管道运行，从而支持数据摄取、培训/再培训和推理。它利用亚马逊<a class="ae lc" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> S3 </a>与亚马逊SageMaker和AWS Step功能直接集成，由<a class="ae lc" href="https://aws.amazon.com/glue/?nc2=type_a&amp;whats-new-cards.sort-by=item.additionalFields.postDateTime&amp;whats-new-cards.sort-order=desc" rel="noopener ugc nofollow" target="_blank">亚马逊胶水</a>和<a class="ae lc" href="https://aws.amazon.com/athena/?nc2=type_a&amp;whats-new-cards.sort-by=item.additionalFields.postDateTime&amp;whats-new-cards.sort-order=desc" rel="noopener ugc nofollow" target="_blank">亚马逊雅典娜</a>支持。这使得能够自动运行、快速试验、快速部署，并轻松纳入TB级的扩展数据大小。</p><h1 id="9081" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">解决方案概述🏗️</h1><p id="001e" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">以下架构图说明了该解决方案的工作流程:</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mm"><img src="../Images/9086f4bbe6ec77badd8cb9bf5c69c27b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hui0nZd31HyI30qp8gHsNA.png"/></div></div><p class="ll lm gj gh gi ln lo bd b be z dk translated">作者图片</p></figure><p id="c60e" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">该工作流程包括以下步骤:</p><ol class=""><li id="8d5d" class="mr ms iq ki b kj kk km kn kp mt kt mu kx mv lb mw mx my mz bi translated">一个用来存放数据、云形成模板和模型人工制品的S3桶</li><li id="3a75" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">Amazon Glue Crawler扫描来自S3的数据，并将其加载到Athena数据库</li><li id="b45f" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">指向S3的训练和推理数据的Amazon Athena数据库</li><li id="2d80" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">一个训练管道步骤功能工作流(状态空间机器),由Amazon Lambda触发器组成，这些触发器运行Amazon SageMaker预处理和Amazon SageMaker训练作业</li><li id="dc18" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">推理管道步骤功能工作流(状态空间机器),由运行Amazon SageMaker预处理和Amazon SageMaker推理作业的Amazon Lambda触发器组成</li></ol><p id="d4ff" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在开始之前，您首先需要一个配置了凭证的AWS帐户设置，如本<a class="ae lc" href="https://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/setup-credentials.html" rel="noopener ugc nofollow" target="_blank">文档</a>中所述。此外，确保已经安装了<a class="ae lc" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS命令行界面</a> AWS CLI。本教程假设您有一个具备必要的<a class="ae lc" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started.html" rel="noopener ugc nofollow" target="_blank">身份访问管理IAM权限</a>的环境。</p><p id="a1e6" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><strong class="ki ir"> <em class="nf">请记住，运行本教程将在您的AWS帐户中产生费用！！！</em>T19】</strong></p><h1 id="98e5" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">对数据的快速浏览📊</h1><p id="b71c" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">在本例中，您将使用一个虚构的电信公司的合成流失数据集，其结果<code class="fe ng nh ni nj b">Churn?</code>被标记为<code class="fe ng nh ni nj b">True</code>(流失)或<code class="fe ng nh ni nj b">False</code>(未流失)。功能包括客户详细信息，如计划和使用信息。客户流失数据集是公开可用的，并在Daniel T. Larose的书<a class="ae lc" href="https://www.amazon.com/dp/0470908742/" rel="noopener ugc nofollow" target="_blank">发现数据中的知识</a>中提到。作者将其归功于加州大学欧文分校的机器学习数据集仓库。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nk"><img src="../Images/ea4d025e68dc31d10dd759a149d315b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7l7nToSFzPWh0NFw.png"/></div></div><p class="ll lm gj gh gi ln lo bd b be z dk translated">作者图片</p></figure><p id="c69e" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">请记住，这个数据集可以用您自己的数据替换，只要代码库被更新以适应它。换句话说，如果你的目标是将它重新应用到你的数据中，这篇文章是你实现目标的第一步！继续读下去，你就会明白怎么做了。</p><h1 id="13b1" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">启动解决方案🚀</h1><p id="e002" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">首先将<a class="ae lc" href="https://github.com/awslabs/aws-customer-churn-pipeline" rel="noopener ugc nofollow" target="_blank"> Github repo </a>克隆到本地文件夹中。</p><pre class="le lf lg lh gt nl nj nm nn aw no bi"><span id="e8ca" class="np lq iq nj b gy nq nr l ns nt">git clone <a class="ae lc" href="https://github.com/awslabs/aws-customer-churn-pipeline.git" rel="noopener ugc nofollow" target="_blank">https://github.com/awslabs/aws-customer-churn-pipeline.git</a></span></pre><p id="04a2" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在克隆的目录中应该有一个名为<code class="fe ng nh ni nj b">standup.sh</code>的文件。接下来，我们将使用这个脚本来构建必要的基础设施，以运行训练和推理管道。该脚本只接受三个命令:您希望为堆栈及其相关资源指定的名称、堆栈的区域以及存放所有工件和数据的AWS Bucket名称。您可以像下面这样运行该命令:</p><p id="1991" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><code class="fe ng nh ni nj b">bash standup.sh {STACK_NAME} {S3_BUCKET_NAME} {REGION}</code></p><p id="2790" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><code class="fe ng nh ni nj b">bash standup.sh churn-pipeline churn-pipeline-artifacts ap-southeast-2</code></p><p id="6d42" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这将开始使用调用AWS CLI和部署<a class="ae lc" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> Amazon CloudFormation </a>模板在您的默认AWS帐户中建立必要的资源。</p><p id="2a63" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">具体来说，该脚本将创建:</p><ol class=""><li id="11be" class="mr ms iq ki b kj kk km kn kp mt kt mu kx mv lb mw mx my mz bi translated">Amazon Athena数据库，包含基于堆栈名称的主要工作组名称</li><li id="8761" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">一个Amazon Glue爬虫，以及爬虫的IAM角色，扫描数据并从指定的S3存储桶将其加载到数据库中</li><li id="3f0a" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">将训练、推理和预处理python脚本上传到您的S3桶中</li><li id="4912" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">将AWS步骤功能<code class="fe ng nh ni nj b">pipeline.yaml</code>上传到您的S3桶中</li><li id="c593" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">为训练和推理部署AWS步骤函数管道。这是基于上述S3的位置，并创造了多个亚马逊Lambda和亚马逊SageMaker工作。</li><li id="4cbd" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">将堆栈名称和区域写入<code class="fe ng nh ni nj b">delete_resources.sh</code>，以便稍后可以使用该脚本来拆除AWS基础设施</li></ol><p id="6a0b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">一旦直立完成，你的云形成控制台应该看起来如下，所有堆栈显示绿色。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nu"><img src="../Images/f609453a01841a833a0814208b5f3854.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*N08VmyYBdFRY9xHh.png"/></div></div><p class="ll lm gj gh gi ln lo bd b be z dk translated">作者图片</p></figure><p id="b098" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">同样，如果您转到Athena控制台，您现在会看到用于训练和推理的表格。</p><p id="5125" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">注意，数据库的名称将基于您在<code class="fe ng nh ni nj b">standup.sh</code>中分配的S3存储桶名称。</p><p id="0868" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">最后，如果您转到Step Functions菜单，您将看到两个状态机(或工作流)，一个用于训练，另一个用于推理。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nk"><img src="../Images/ef819058568b3db42cf370edbe12b2d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*728MVRGMjgheDakZ.png"/></div></div><p class="ll lm gj gh gi ln lo bd b be z dk translated">作者图片</p></figure><p id="be65" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这两个管道都被设计为按需或按计划运行，能够自动部署打包的代码，因此在部署中几乎没有工作和风险。本节和下一节将解释每个管道是如何工作的，让您更接近完全自动化的机器学习流失管道。</p><h1 id="b97a" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">自动化培训渠道🤖</h1><p id="cb59" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">培训管道使用亚马逊Lambdas和亚马逊SageMaker，通过七个步骤向亚马逊S3输出经过全面培训、验证和优化的客户流失模型。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nv"><img src="../Images/2d6124f566e7e085cb3aff799a48032b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Akro7FFziERdhFHk.png"/></div></div><p class="ll lm gj gh gi ln lo bd b be z dk translated">作者图片</p></figure><p id="1e84" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">让我们首先通过调用Amazon Lambda来启动培训管道:</p><pre class="le lf lg lh gt nl nj nm nn aw no bi"><span id="44ea" class="np lq iq nj b gy nq nr l ns nt">aws lambda --region ${REGION} invoke --function-name invokeTrainingStepFunction --payload "{ '': ''}" out</span></pre><p id="3b4f" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">您应该会得到200代码，表明Lambda触发了</p><pre class="le lf lg lh gt nl nj nm nn aw no bi"><span id="9dd1" class="np lq iq nj b gy nq nr l ns nt">{"StatusCode": 200,  "ExecutedVersion": "$LATEST"}</span></pre><h2 id="c86a" class="np lq iq bd lr nw nx dn lv ny nz dp lz kp oa ob mb kt oc od md kx oe of mf og bi translated">步骤1: SageMaker培训步骤预处理🎛️</h2><p id="6001" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">现在，工作开始了！让我们回顾一下它正在采取的步骤。</p><p id="b652" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">Amazon SageMaker的预处理作业是在使用<a class="ae lc" href="https://github.com/aws/sagemaker-scikit-learn-container" rel="noopener ugc nofollow" target="_blank"> SageMaker的Scikit Learn容器直接从Amazon Athena表中查询的数据上运行的。</a></p><p id="2d25" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">使用<code class="fe ng nh ni nj b">scripts/preporcessing.py</code>按以下顺序运行该步骤:</p><ol class=""><li id="6080" class="mr ms iq ki b kj kk km kn kp mt kt mu kx mv lb mw mx my mz bi translated">使用<a class="ae lc" href="https://github.com/awslabs/aws-data-wrangler" rel="noopener ugc nofollow" target="_blank"> awswrangler </a>从Athena表中读取数据</li><li id="68af" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">通过随机拆分将数据分为训练数据集和验证数据集</li><li id="5a1a" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">缺失值被估算，分类值被热编码</li><li id="2c12" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">然后，经过分割和预处理的数据集将作为csv文件写回S3</li><li id="3ad0" class="mr ms iq ki b kj na km nb kp nc kt nd kx ne lb mw mx my mz bi translated">预处理器被保存以在推理管道中使用</li></ol><p id="c350" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">预处理脚本和云形成模板<code class="fe ng nh ni nj b">pipeline.yaml</code>的阶跃函数参数是可更新的。例如，容器的入口点参数在CloudFormation中设置为:</p><pre class="le lf lg lh gt nl nj nm nn aw no bi"><span id="a968" class="np lq iq nj b gy nq nr l ns nt">"ContainerArguments": [      <br/>     "--database",      <br/>     "${AthenaDatabaseName}",<br/>     "--region",      <br/>     "${AWS::Region}",      <br/>     "--table",      <br/>     "train",      <br/>     "--train-test-split-ratio",      <br/>     "0.2"]</span></pre><p id="c11e" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">数据库名<code class="fe ng nh ni nj b">{AthendaDatabaseName}</code>作为栈名传入，并附上<code class="fe ng nh ni nj b">-db</code>。从您传递给<code class="fe ng nh ni nj b">standup.sh</code>的变量中设置区域。表名默认为训练数据名，在本例中为“train”。最后，训练和测试之间的随机分割在这里被设置为默认值，25%的数据用于测试。</p><p id="b2c1" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">对于这篇博文，您将保留<code class="fe ng nh ni nj b">pipeline.yaml</code>的设置。请记住，可以根据您的数据更改所有这些配置。</p><h2 id="c806" class="np lq iq bd lr nw nx dn lv ny nz dp lz kp oa ob mb kt oc od md kx oe of mf og bi translated">步骤2 : SageMaker超参数调整步骤📈</h2><p id="b275" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">超参数调整步骤为您的模型找到超参数的最佳组合。在本例中，您使用<a class="ae lc" href="https://en.wikipedia.org/wiki/XGBoost" rel="noopener ugc nofollow" target="_blank"> XGBoost </a>将流失建模为二元结果(将流失/不会流失)。具体来说，您将尝试通过最大化曲线下的<a class="ae lc" href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic" rel="noopener ugc nofollow" target="_blank">区域，在重复的并行运行中找到最佳的正则化项、深度和树分裂组合(默认为总共2个)来实现最高的精度。在给定可用数据的情况下，这将产生最准确的模型。</a></p><p id="744d" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">值得注意的是，这里没有脚本。使用<a class="ae lc" href="https://github.com/aws/sagemaker-xgboost-container" rel="noopener ugc nofollow" target="_blank"> SageMaker的XGBoost容器</a>，所有配置都作为JSON直接传递给<code class="fe ng nh ni nj b">pipeline.yaml</code>中的SageMaker。和以前一样，默认值是硬编码的。然而，像管道的所有部分一样，它们可以根据需要进行更新。要更深入地了解使用Amazon SageMaker进行超参数调整以及可能的输入类型，请参见<a class="ae lc" href="https://docs.aws.amazon.com/sagemaker/latest/dg/automatic-model-tuning.html" rel="noopener ugc nofollow" target="_blank">这里的</a>。</p><h2 id="8d2b" class="np lq iq bd lr nw nx dn lv ny nz dp lz kp oa ob mb kt oc od md kx oe of mf og bi translated">步骤3: SageMaker步骤获得最佳超参数⭐️</h2><p id="abd0" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">此步骤调用Lambda函数来记录最佳执行模型(和超参数配置)，然后将其传递到步骤函数工作流中的下一步。</p><h2 id="22cf" class="np lq iq bd lr nw nx dn lv ny nz dp lz kp oa ob mb kt oc od md kx oe of mf og bi translated">步骤4: SageMaker培训步骤👾</h2><p id="4b2c" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">现在确定了最佳模型，您将再次重新训练，以获得完全训练的模型和输出模型可解释性度量。</p><p id="3e78" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">同样，这个步骤使用来自<code class="fe ng nh ni nj b">pipeline.yaml</code>的SageMaker配置来运行SageMaker的XGBoost容器映像。这一次，培训从优化的超参数和<a class="ae lc" href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_debugger.html" rel="noopener ugc nofollow" target="_blank"> SageMaker调试器</a>设置开始。使用调试器运行训练作业，除了完整训练的模型之外，还允许将可解释性度量输出到S3。</p><p id="2b05" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">可解释性度量显示了每个特性如何影响客户流失。结合像<a class="ae lc" href="https://github.com/slundberg/shap" rel="noopener ugc nofollow" target="_blank"> SHAP </a>这样的技术，能够从整体上解释模型，更重要的是，能够了解如何在单个客户基础上确定分数。</p><h2 id="ea36" class="np lq iq bd lr nw nx dn lv ny nz dp lz kp oa ob mb kt oc od md kx oe of mf og bi translated">步骤5: SageMaker步骤保存模型💾</h2><p id="c6aa" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">这一步调用一个Lambda函数将训练好的模型作为Amazon SageMaker模型工件保存到S3。</p><h2 id="c7f7" class="np lq iq bd lr nw nx dn lv ny nz dp lz kp oa ob mb kt oc od md kx oe of mf og bi translated">步骤6: SageMaker获取模型Url🔦</h2><p id="e40f" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">这一步从S3检索模型URI，用于下一步的模型评估。</p><h2 id="b925" class="np lq iq bd lr nw nx dn lv ny nz dp lz kp oa ob mb kt oc od md kx oe of mf og bi translated">步骤7: SageMaker步骤模型评估🧪</h2><p id="3f11" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">最后一步是对训练和测试数据进行全面评估，并向S3输出结果报告。模型评估步骤在这里作为一个模块，因为它允许为不同的客户流失用例定制指标、图表和挂钩。</p><p id="001b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">首先，训练好的模型直接从其存储的S3 URI加载。然后，它生成测试数据的分类报告，并将结果作为<code class="fe ng nh ni nj b">evaluation.json</code>输出回S3。最后，输出SHAP值和要素重要性图，并保存回S3。请注意，与<strong class="ki ir">步骤4 SageMaker训练步骤中的SageMaker调试器步骤不同，</strong>这些输出直接发送到您命名的S3桶，而不是其他地方的SageMaker默认桶。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi oh"><img src="../Images/2e5de5790dd3f3c8e4b8f4a39729f153.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kj6YCOXhetZJMb2H.png"/></div></div><p class="ll lm gj gh gi ln lo bd b be z dk translated">作者图片</p></figure><h1 id="93a8" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">自动推理管道🤖</h1><p id="a30d" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">推理管道使用从训练管道生成的Amazon SageMaker人工制品对看不见的数据进行推理，然后分两步将其放回S3。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/0fe1e8bd2b32064225862b58d7ae43b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/0*hDamkZG6sbtRhKzq.png"/></div><p class="ll lm gj gh gi ln lo bd b be z dk translated">作者图片</p></figure><h2 id="bb08" class="np lq iq bd lr nw nx dn lv ny nz dp lz kp oa ob mb kt oc od md kx oe of mf og bi translated">SageMaker推理步骤预处理🎛️</h2><p id="5cbf" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">在这一步中，您将加载保存的预处理程序并转换数据，使其格式适合运行流失推断。</p><p id="9b6f" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">与培训管道相同，这是通过调用Amazon Lambda触发的。</p><pre class="le lf lg lh gt nl nj nm nn aw no bi"><span id="2545" class="np lq iq nj b gy nq nr l ns nt">lambda --region ${REGION} invoke --function-name invokeInferStepFunction --payload "{ '': ''}" out</span></pre><p id="bf07" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">和以前一样，200代码表示作业启动成功，推理管道开始运行。</p><pre class="le lf lg lh gt nl nj nm nn aw no bi"><span id="68ae" class="np lq iq nj b gy nq nr l ns nt">{"StatusCode": 200,    "ExecutedVersion": "$LATEST"}</span></pre><p id="846b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在<code class="fe ng nh ni nj b">pipeline.yaml </code>中查看显示，推断数据被假定在表名<code class="fe ng nh ni nj b">infer</code>下。</p><pre class="le lf lg lh gt nl nj nm nn aw no bi"><span id="a0fe" class="np lq iq nj b gy nq nr l ns nt">"ContainerArguments": [        <br/>       "--database",        <br/>       "${AthenaDatabaseName}",         <br/>       "--region",         <br/>       "${AWS::Region}",         <br/>       "--table",          <br/>       "infer"]</span></pre><p id="f4ed" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">和以前一样，数据库名<code class="fe ng nh ni nj b">{AthendaDatabaseName}</code>作为栈名传入，并附上<code class="fe ng nh ni nj b">-db</code>。区域设置为传递到<code class="fe ng nh ni nj b">standup.sh</code>的区域。同样，SageMaker的配置几乎完全相同，容器映像仍然使用SageMaker的Scikit Learn的容器。</p><p id="f24b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这里的例外是您将使用<code class="fe ng nh ni nj b">scripts/inferpreprocessing.py</code>而不是<code class="fe ng nh ni nj b">scripts/preprocessing.py </code>。该脚本从<strong class="ki ir">训练管道步骤1 </strong>加载保存的训练预处理器，用于新数据。然后，转换后的要素以前缀<code class="fe ng nh ni nj b">data/intermediate</code>的形式输出回S3，进入您指定的S3存储桶。</p><h2 id="fe51" class="np lq iq bd lr nw nx dn lv ny nz dp lz kp oa ob mb kt oc od md kx oe of mf og bi translated">批量转换输入数据集(推理)⚡️</h2><p id="6b16" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">既然推理数据集的格式正确，您就可以获得流失预测。下一步利用<a class="ae lc" href="https://docs.aws.amazon.com/sagemaker/latest/dg/batch-transform.html" rel="noopener ugc nofollow" target="_blank"> Amazon SageMaker的批处理转换</a>特性，以批处理作业的形式直接运行推理，然后将数据结果写到前缀<code class="fe ng nh ni nj b">/data/inference_result</code>中的S3。</p><p id="f740" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">您的最终结果应该包括每个客户的流失概率得分:</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi oj"><img src="../Images/66160e4327ebf3980566381515a68788.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1Z3GJktGOjBj8bDd.png"/></div></div><p class="ll lm gj gh gi ln lo bd b be z dk translated">作者图片</p></figure><h2 id="53e1" class="np lq iq bd lr nw nx dn lv ny nz dp lz kp oa ob mb kt oc od md kx oe of mf og bi translated">清理🗑</h2><p id="bb92" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">要清理资源以防止进一步收费，请运行以下文件:</p><p id="2b2f" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><code class="fe ng nh ni nj b">bash delete_resources.sh</code></p><p id="4b33" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这将拆除Churn管道的云形成堆栈。要确认所有东西都被删除了，去你的CloudFormation控制台。控制台现在应该没有所有相关的堆栈。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi nk"><img src="../Images/74453466fe7eca051b3a035a4b424d80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ifEY0hlL4iR-tRJG.png"/></div></div><p class="ll lm gj gh gi ln lo bd b be z dk translated">作者图片</p></figure><p id="1816" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">请注意，由于该进程没有生成S3存储桶，因此运行管道得到的所有文件仍将在那里。如果您不想保留这些文件，您需要清空存储桶并单独删除它们。</p><h1 id="ae0c" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">结论🙏</h1><p id="fb75" class="pw-post-body-paragraph kg kh iq ki b kj mh jr kl km mi ju ko kp mj kr ks kt mk kv kw kx ml kz la lb ij bi translated">在这篇博文中，你学习了如何在AWS 上部署一个带有<a class="ae lc" href="https://github.com/awslabs/aws-customer-churn-pipeline" rel="noopener ugc nofollow" target="_blank">客户流失渠道的端到端客户流失解决方案。你首先利用S3、亚马逊Athena、亚马逊Glue、AWS Step Functions和亚马逊SageMaker建立了数据处理和工作流的必要资源。然后，您为流失预测创建一个培训工作流，包括特征预处理、超参数调整、模型可解释性和评估。最后，您使用训练好的模型运行推理工作流，以根据看不见的数据生成批量流失预测。对于这两个工作流步骤，您都调用了Amazon Lambda来自动部署变更。现在，您已经掌握了足够的信息来获取客户流失渠道，并在您的用例中运行它！</a></p><p id="8566" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这个博客非常适合开始使用自动化的客户流失预测解决方案。也就是说，还可以做更多的事情来支撑管道。例如，数据完整性检查，像<a class="ae lc" href="https://github.com/awslabs/python-deequ" rel="noopener ugc nofollow" target="_blank"> PyDeequ </a>或<a class="ae lc" href="https://sagemaker.readthedocs.io/en/stable/amazon_sagemaker_model_monitoring.html" rel="noopener ugc nofollow" target="_blank">亚马逊SageMaker模型监视器</a>可以添加到管道中，以进一步提高模型完整性。通过改变容器图像和数据库部分，可以将工作负载换成其他形式的数据，如文本。此外，可以通过使用<a class="ae lc" href="https://aws.amazon.com/codepipeline/" rel="noopener ugc nofollow" target="_blank"> AWS代码管道</a>或类似的服务来完全自动化，这些服务将构建所有的基础设施并运行由单个提交触发的两个工作流。</p></div></div>    
</body>
</html>