<html>
<head>
<title>Skewed Data in Spark? Add SALT to Compensate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spark中的数据失真？加盐来补偿</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/skewed-data-in-spark-add-salt-to-compensate-16d44404088b?source=collection_archive---------2-----------------------#2021-12-09">https://towardsdatascience.com/skewed-data-in-spark-add-salt-to-compensate-16d44404088b?source=collection_archive---------2-----------------------#2021-12-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2ce6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用SALT技术处理偏斜数据的分步指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/02d8d6baedec8e7a91e6590da07f7306.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ZALlrKJIP5NMSrp8t0MDw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片:@ tangerinenwt<a class="ae ky" href="https://unsplash.com/photos/ClhHUlP2H8c" rel="noopener ugc nofollow" target="_blank">Unsplash</a></p></figure><p id="06c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用Apache Spark已经有一段时间了，那么您一定看到过以下错误:<code class="fe lv lw lx ly b">java.lang.OutOfMemoryError: Java heap space</code></p><p id="be88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">内存不足(OOM)错误是阻止Spark作业成功完成的最常见错误之一。不均匀分布的键，称为数据倾斜，通常会导致这个问题。</p><p id="23da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有许多方法可以解决Spark中的内存不足问题。蛮力的方法是给执行程序增加更多的内存，并希望它能起作用。Spark也有许多调整参数来重新平衡内存。倾斜的数据是一个数据集问题。除了优化火花参数，用户通常有责任使用数据本身来解决问题。本文将使用SALT来解决数据倾斜问题。</p><h1 id="6163" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">了解数据不对称</h1><p id="2061" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">在Spark中，大范围转换涉及分区之间的数据洗牌。混洗是将数据从映射器传输到缩减器的过程。</p><blockquote class="mw mx my"><p id="e91b" class="kz la mz lb b lc ld ju le lf lg jx lh na lj lk ll nb ln lo lp nc lr ls lt lu im bi translated">shuffle是Spark重新分配数据的机制，以便在分区之间对数据进行不同的分组。— Spark文档</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/e77a95e9c5812f308837a41164582f8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_izQ1hFyAoe7sTCUGTKLlw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="43c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">洗牌是一个昂贵的操作。如左图所示，混排通常不是1:1复制，因为哈希键通常用于确定数据如何分组以及复制到哪里。这个过程通常意味着数据通过无数的执行器和机器被复制。如果您有一个比其他键大得多的键，这个“热键”会导致数据倾斜。</p><p id="8b0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数据偏斜与Spark无关，这是数据集的本质。例如，如果我们执行一些需要按城市细分的销售分析。纽约、芝加哥、旧金山等人口较多的城市更有可能出现数据倾斜问题。</p><p id="c13d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一个问题变成了，</p><p id="8e48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">我们如何平衡密钥分布，使某些密钥不会成为热点？</strong></p><p id="003e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个问题的答案是使现有的键略有不同，这样它们可以均匀地处理。一种选择是找到另一个字段，将其作为组合键添加，或者散列整个键集。同样，这只有在我们选择的新字段使组合键均匀分布的情况下才有效。如果这不起作用，你需要一些随机性来帮助，这就引入了盐。</p><h1 id="6d15" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">盐是什么？</h1><blockquote class="mw mx my"><p id="5960" class="kz la mz lb b lc ld ju le lf lg jx lh na lj lk ll nb ln lo lp nc lr ls lt lu im bi translated">在密码学中，salt是随机数据，用作散列数据的单向函数的附加输入，是密码或短语— <a class="ae ky" href="https://en.wikipedia.org/wiki/Salt_(cryptography)" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">维基百科</strong> </a></p></blockquote><p id="4ce4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">密码学中的SALT思想在不知道数据集的任何上下文的情况下给密钥引入了随机性。这个想法是，对于一个给定的热键，如果它与不同的随机数组合，我们最终会注意到在一个分区中处理给定键的所有数据。SALT的一个显著优点是它与任何键都无关，并且您不必担心一些上下文相似的键再次具有相同的值。</p><p id="d4a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Spark中，SALT是一种添加随机值来均匀推送Spark分区数据的技术。对于像join操作这样需要洗牌的大范围转换，采用这种方法通常是好的。</p><p id="7d63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图显示了SALT将如何改变密钥分布。键1(浅绿色)是导致单个分区中数据倾斜的热键。在应用SALT之后，原始密钥被分成3个部分，并驱动新密钥洗牌到与以前不同的分区。在这种情况下，键1进入3个不同的分区，原始分区可以在这3个分区中并行处理。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/1a8d8a45a077689cd8dd3df42cf45711.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*13zBRu0FZWvjAZvPnRm0YQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h1 id="dfa3" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">如何在火花中使用盐</h1><p id="dbb8" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">在Spark中使用盐的过程可以分解为:</p><ol class=""><li id="4d99" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">添加一个新字段，并用随机数填充它。</li><li id="7536" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">将这个新字段和现有的键组合成一个组合键，执行任何转换。</li><li id="a1ce" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">处理完成后，合并最终结果。</li></ol><p id="e7af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以写一行spark代码，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><h1 id="153b" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">最终想法</h1><p id="5a33" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">今天，大多数数据处理不会自动抵消高度倾斜的数据，而是由用户应用特定的逻辑来平衡数据。SALT是在不知道数据上下文的情况下解决扭曲数据问题的通用方法。我希望这是有助于解决数据失真问题的信息。</p></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><p id="ebbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望这个故事对你有帮助。本文是我的工程&amp;数据科学系列的<strong class="lb iu">部分，目前包括以下内容:</strong></p><div class="oc od gp gr oe"><div role="button" tabindex="0" class="ab bv gv cb fp of og bn oh ks ex"><div class="oi l"><div class="ab q"><div class="l di"><img alt="Chengzhi Zhao" class="l de bw oj ok fe" src="../Images/51b8d26809e870b4733e4e5b6d982a9f.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/2*SGCkys53sdZUZKnpRQoq_A.jpeg"/><div class="fb bw l oj ok fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://chengzhizhao.medium.com/?source=post_page-----16d44404088b--------------------------------" rel="noopener follow" target="_top">赵承志</a></p></div></div><div class="on oo gw l"><h2 class="bd iu ty nf fp tz fr fs ua fu fw is bi translated">数据工程和数据科学故事</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi ub au uc ud ue qi uf an eh ei ug uh ui el em eo de bk ep" href="https://chengzhizhao.medium.com/list/data-engineering-data-science-stories-ddab37f718e7?source=post_page-----16d44404088b--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="uj l fo"><span class="bd b dl z dk">47 stories</span></div></div></div><div class="pa dh pb fp ab pc fo di"><div class="di os bv ot ou"><div class="dh l"><img alt="" class="dh" src="../Images/4ba0357365403d685da42e6cb90b2b7e.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/da:true/resize:fill:388:388/1*b4EVtemQ1EQEup3o1ewz1w.gif"/></div></div><div class="di os bv ov ow ox"><div class="dh l"><img alt="" class="dh" src="../Images/89f9120acd7a8b3a37b09537198b34ca.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*xj-YsbUEN_pMA4IS7hE6hw.jpeg"/></div></div><div class="di bv oy oz ox"><div class="dh l"><img alt="" class="dh" src="../Images/1f0d78b4e466ea21d6a5bd7a9f97c526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*zF1_SxRakCIMJ2sgKtyP1w.jpeg"/></div></div></div></div></div><p id="7870" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你也可以<a class="ae ky" href="https://chengzhizhao.medium.com/subscribe" rel="noopener"> <strong class="lb iu">订阅我的新文章</strong> </a>或者成为<a class="ae ky" href="https://chengzhizhao.medium.com/membership" rel="noopener"> <strong class="lb iu">推荐媒介会员</strong> </a> <strong class="lb iu"> </strong>可以无限制访问媒介上的所有故事。</p><p id="771b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果有问题/评论，<strong class="lb iu">请不要犹豫，写下这个故事的评论</strong>或者通过<a class="ae ky" href="https://www.linkedin.com/in/chengzhizhao/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>或<a class="ae ky" href="https://twitter.com/ChengzhiZhao" rel="noopener ugc nofollow" target="_blank"> Twitter </a>直接<strong class="lb iu">联系我。</strong></p></div></div>    
</body>
</html>