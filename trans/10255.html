<html>
<head>
<title>How to Cut Your AWS ECS Costs with Fargate Spot and Prefect</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Fargate Spot和Prefect降低您的AWS ECS成本</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-cut-your-aws-ecs-costs-with-fargate-spot-and-prefect-1a1ba5d2e2df?source=collection_archive---------9-----------------------#2021-09-29">https://towardsdatascience.com/how-to-cut-your-aws-ecs-costs-with-fargate-spot-and-prefect-1a1ba5d2e2df?source=collection_archive---------9-----------------------#2021-09-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="059d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Python中的无服务器数据工程管道</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c3a9d6dc3917a63bbbc20f78ff2cd996.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HJWo6Z6LvP8kxjdsIGI8VQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://www.pexels.com/@kampus?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Kampus出品</a>来自<a class="ae kv" href="https://www.pexels.com/photo/people-in-the-office-using-a-desktop-computer-for-discussion-8636591/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a></p></figure><p id="357d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi ls translated"><span class="l lt lu lv bm lw lx ly lz ma di"> P </span> <a class="ae kv" href="https://www.prefect.io/" rel="noopener ugc nofollow" target="_blank"> refect </a>是一个灵活的工具，用于编排现代数据堆栈。与市场上的许多其他解决方案相比，它不会将您束缚于任何特定的执行框架或云提供商——无论您是想使用GCP上的<a class="ae kv" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank">Kubernetes</a>、<a class="ae kv" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank"> AWS ECS </a>、裸机服务器，还是诸如<a class="ae kv" href="https://coiled.io/" rel="noopener ugc nofollow" target="_blank"> Coiled </a>的按需分布式Dask集群，Prefect都能满足您的需求。与任何灵活的平台一样，您需要配置一些东西来让Prefect知道您的数据工作流应该在哪里运行。在本文中，我们将研究如何利用AWS ECS Fargate上的spot实例作为您的经济高效的执行层。</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="71fc" class="mg mh iq mc b gy mi mj l mk ml"><strong class="mc ir">Table of contents</strong></span><span id="0f0e" class="mg mh iq mc b gy mm mj l mk ml">· <a class="ae kv" href="#2587" rel="noopener ugc nofollow">Spot instances &amp; Prefect</a><br/>  ∘ <a class="ae kv" href="#0e6b" rel="noopener ugc nofollow">Why spot instances?</a><br/>  ∘ <a class="ae kv" href="#5281" rel="noopener ugc nofollow">What value does Prefect provide in managing containers deployed to spot instances?</a><br/>· <a class="ae kv" href="#a7fb" rel="noopener ugc nofollow">Architecture</a><br/>· <a class="ae kv" href="#af91" rel="noopener ugc nofollow">Prefect Setup</a><br/>  ∘ <a class="ae kv" href="#e80f" rel="noopener ugc nofollow">Sign up or sign in</a><br/>  ∘ <a class="ae kv" href="#55d2" rel="noopener ugc nofollow">Create an API Key</a><br/>  ∘ <a class="ae kv" href="#98be" rel="noopener ugc nofollow">Install Prefect</a><br/>  ∘ <a class="ae kv" href="#f88c" rel="noopener ugc nofollow">Create a service account for the ECSAgent</a><br/>· <a class="ae kv" href="#3338" rel="noopener ugc nofollow">AWS Setup</a><br/>  ∘ <a class="ae kv" href="#7f59" rel="noopener ugc nofollow">Store the ECSAgent’s API Key as an encrypted parameter</a><br/>  ∘ <a class="ae kv" href="#ad64" rel="noopener ugc nofollow">Configure the ECS cluster</a><br/>  ∘ <a class="ae kv" href="#4ba7" rel="noopener ugc nofollow">Prepare the IAM roles</a><br/>  ∘ <a class="ae kv" href="#43f9" rel="noopener ugc nofollow">Task execution role</a><br/>  ∘ <a class="ae kv" href="#6f39" rel="noopener ugc nofollow">Task role</a><br/>  ∘ <a class="ae kv" href="#d836" rel="noopener ugc nofollow">Create a CloudWatch log group</a><br/>  ∘ <a class="ae kv" href="#bb0c" rel="noopener ugc nofollow">Register a task definition for the ECSAgent</a><br/>  ∘ <a class="ae kv" href="#1fd5" rel="noopener ugc nofollow">Look up your subnet IDs</a><br/>  ∘ <a class="ae kv" href="#566f" rel="noopener ugc nofollow">Start a continuously running ECS Service for the ECSAgent</a><br/>  ∘ <a class="ae kv" href="#29bd" rel="noopener ugc nofollow">Validate the agent setup in the Prefect UI</a><br/>· <a class="ae kv" href="#5b72" rel="noopener ugc nofollow">Deploy an example Prefect flow</a><br/>  ∘ <a class="ae kv" href="#1e8c" rel="noopener ugc nofollow">Build a custom Docker image for your Prefect flows</a><br/>· <a class="ae kv" href="#a041" rel="noopener ugc nofollow">Conclusion</a></span></pre></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="2587" class="mu mh iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">Spot实例和完美</h1><h2 id="0e6b" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">为什么点实例？</h2><p id="713c" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">首先，为什么首先要使用spot实例呢？原因很简单:节约成本。即时实例的成本比按需实例低70%。</p><h2 id="5281" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">Prefect在管理部署到spot实例的容器方面提供了什么价值？</h2><p id="7245" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">虽然spot实例可以节省大量成本，但它们有一个明显的缺点:它们可以在两分钟的通知后关闭。提督有助于克服这一缺点，因为:</p><ul class=""><li id="5266" class="ob oc iq ky b kz la lc ld lf od lj oe ln of lr og oh oi oj bi translated">它提供了<strong class="ky ir">可见性</strong>，其中作业由于spot实例关闭而失败，</li><li id="4edd" class="ob oc iq ky b kz ok lc ol lf om lj on ln oo lr og oh oi oj bi translated">由于名为<strong class="ky ir"> Lazarus </strong>的服务，它可以自动<strong class="ky ir">重启</strong>此类失败的工作流。正如<a class="ae kv" href="https://docs.prefect.io/orchestration/concepts/services.html#how-is-it-useful" rel="noopener ugc nofollow" target="_blank">提督文献</a>所解释的:</li></ul><blockquote class="op oq or"><p id="c0f9" class="kw kx os ky b kz la jr lb lc ld ju le ot lg lh li ou lk ll lm ov lo lp lq lr ij bi translated">“Lazarus流程旨在优雅地重试由Prefect无法控制的因素导致的故障。最常见的需要Lazarus干预的情况是<strong class="ky ir">基础设施问题</strong>，例如Kubernetes pods在能够完成一次运行之前无法运行或被删除。</p></blockquote><ul class=""><li id="3aac" class="ob oc iq ky b kz la lc ld lf od lj oe ln of lr og oh oi oj bi translated">提督<strong class="ky ir">自动化</strong>许多<strong class="ky ir">繁琐的任务</strong>，否则你将不得不做部署你的工作负载到ECS，如创建和注册新的任务定义，注销旧的任务定义，等等。</li><li id="bf62" class="ob oc iq ky b kz ok lc ol lf om lj on ln oo lr og oh oi oj bi translated">提督也允许你直接从提督用户界面修改“运行ECS任务”的元数据。这样，您可以在特定的每次运行的基础上调整工作流所需的资源，如<strong class="ky ir"> CPU </strong>和<strong class="ky ir">内存</strong>。</li></ul></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="a7fb" class="mu mh iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">体系结构</h1><p id="e1b7" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">在您的AWS帐户中，您创建了一个带有<strong class="ky ir">perfect ECS agent</strong>流程的<strong class="ky ir"> ECS服务</strong>。这个过程不断地轮询Prefect Cloud API以获得新的流运行。然后，当注入您为每个特定运行(<em class="os">例如，CPU、内存</em>)提供的元数据时，Prefect会自动将计划的流运行部署为ECS任务。<strong class="ky ir"> ECS控制平面</strong>负责提供基础设施并将集装箱放置在<strong class="ky ir"> ECS数据平面</strong>上。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/f7c030ae9ccd323873914cd3916048b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*9SVvMOVlRZsCbLyTufAV5A.jpeg"/></div></figure><p id="0977" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将重点关注使用Fargate作为您的数据平面，ECS允许您为每个ECS集群添加多达六个<strong class="ky ir">容量提供者</strong>。这样，您的ECS数据层可以同时使用<code class="fe ox oy oz mc b">FARGATE_SPOT</code>、<code class="fe ox oy oz mc b">FARGATE</code>、<code class="fe ox oy oz mc b">EXTERNAL</code>本地服务器和自我管理的定制<code class="fe ox oy oz mc b">EC2</code>实例，可能使用GPU。容量提供程序允许您定制群集资源，以满足您期望的延迟、维护和容量需求。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="af91" class="mu mh iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">完美设置</h1><h2 id="e80f" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">注册或登录</h2><p id="2c75" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">如果您还没有帐户，<a class="ae kv" href="https://cloud.prefect.io/" rel="noopener ugc nofollow" target="_blank">注册</a>一个“标准”的提督云帐户。虽然也有一个“入门”选项，但标准版有更多的功能。这两个计划都有一个非常慷慨的10，000次免费成功任务运行的等级。你可以在这里找到更多关于那个的信息。</p><h2 id="55d2" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">创建API密钥</h2><p id="f01d" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">一旦登录，您就可以<a class="ae kv" href="https://cloud.prefect.io/user/keys" rel="noopener ugc nofollow" target="_blank">创建一个API密匙</a>来使用Prefect Cloud验证您的本地开发环境。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/596fd81a6d6431b99d25a37c2c9acaf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3HGDgtaRnCp6BYRz0ToBlg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">完美的云用户界面——作者图片</p></figure><h2 id="98be" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">安装提督</h2><p id="7cb4" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">要在本地计算机上安装带有AWS子模块的提督，请使用:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="6b83" class="mg mh iq mc b gy mi mj l mk ml">pip install "prefect[aws]"</span></pre><p id="af2c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，您可以切换到Prefect Cloud后端，并使用您之前生成的API密钥进行身份验证:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="e297" class="mg mh iq mc b gy mi mj l mk ml">prefect backend cloud<br/>prefect auth login --key <strong class="mc ir">&lt;</strong>YOUR-API-KEY<strong class="mc ir">&gt;</strong></span></pre><p id="ef0f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">成功认证后，您现在可以注册新的流，启动新的代理，并在Prefect Cloud UI中查看它们。</p><blockquote class="op oq or"><p id="bbc1" class="kw kx os ky b kz la jr lb lc ld ju le ot lg lh li ou lk ll lm ov lo lp lq lr ij bi translated"><strong class="ky ir">注意:</strong>旧版本的提督使用的API令牌对代理和用户有不同的作用域。从0.15.0开始，你应该使用API键。如果你想知道更多，这篇博文解释了这一变化的原因。</p></blockquote><h2 id="f88c" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">为ECSAgent创建服务帐户API密钥</h2><p id="3296" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">虽然API密匙是为认证用户而设计的，但服务帐户API密匙是为机器而设计的，即自动化过程，如完美代理和CI/CD工具。要为ECSAgent创建新密钥，请转到<a class="ae kv" href="https://cloud.prefect.io/team/service-accounts" rel="noopener ugc nofollow" target="_blank">团队的服务帐户页面</a>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/4337a24b45771d5b44c3e520f5d601e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tTBwKNvqIr2QGorGbuZKvg.png"/></div></div></figure></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="3338" class="mu mh iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">AWS设置</h1><p id="c405" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">下面演示的整个设置可以在<a class="ae kv" href="https://gist.github.com/anna-geller/45c99852c22cc44fa260156b47339c0f" rel="noopener ugc nofollow" target="_blank"> this GitHub Gist </a>中找到，作为一个bash脚本，您可以调整并运行它:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="2fd9" class="mg mh iq mc b gy mi mj l mk ml">bash prefect_ecs_agent_deploy_script.bash</span></pre><blockquote class="op oq or"><p id="76d3" class="kw kx os ky b kz la jr lb lc ld ju le ot lg lh li ou lk ll lm ov lo lp lq lr ij bi translated">在运行它之前，您需要用您的帐户ID替换<code class="fe ox oy oz mc b">AWS_ACCOUNT_ID</code>,并设置其他变量，如代码注释中所述。</p></blockquote><p id="be37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在接下来的小节中，我们将从要点开始逐步介绍所有步骤，以便您理解创建了哪些资源，以及如何根据您的用例调整这个脚本。</p><h2 id="7f59" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">将ECSAgent的API密钥存储为加密参数</h2><p id="4a67" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">为了在我们的AWS ECS服务中安全地访问先前创建的服务帐户的API密钥，我们希望将它作为加密的秘密存储在<a class="ae kv" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" rel="noopener ugc nofollow" target="_blank"> AWS系统管理器参数存储</a>中。确保设置您的AWS区域、API键，并调整其他变量:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="9f5f" class="mg mh iq mc b gy mi mj l mk ml"><em class="os">export </em>AWS_REGION=us-east-1<br/><em class="os">export </em>ECS_CLUSTER_NAME=prefectEcsCluster<br/><em class="os">export </em>ECS_LOG_GROUP_NAME=/ecs/prefectEcsAgent<br/><em class="os">export </em>ECS_SERVICE_NAME=prefectECSAgent<br/><em class="os">export </em>PREFECT_API_KEY=yourPrefectCloudAPIKey<br/><em class="os">export </em>AWS_PAGER=""</span><span id="aea8" class="mg mh iq mc b gy mm mj l mk ml">aws ssm put-parameter --type SecureString --name <!-- -->PREFECT__CLOUD__API_KEY<!-- --> --value $<!-- -->PREFECT_API_KEY<!-- --> --region $AWS_REGION</span></pre><p id="76e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ox oy oz mc b">AWS_PAGER</code>变量被设置为禁用AWS CLI的分页输出。</p><h2 id="ad64" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">配置ECS群集</h2><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="0d74" class="mg mh iq mc b gy mi mj l mk ml"><em class="os">aws </em>ecs create-cluster --cluster-name $ECS_CLUSTER_NAME \<br/>--capacity-providers FARGATE_SPOT FARGATE \<br/>--default-capacity-provider-strategy \<br/>capacityProvider=FARGATE_SPOT,weight=3 \<br/>capacityProvider=FARGATE,base=1,weight=2 \<br/>--region $AWS_REGION</span></pre><p id="0fac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们设置了<code class="fe ox oy oz mc b">base=1</code>,因为至少ECSAgent进程的一个ECS任务将作为ECS服务全天候运行。由于该服务必须始终运行以实现健壮的调度，因此为该流程使用spot实例没有意义。</p><p id="997f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过利用<strong class="ky ir">权重</strong>，我们指定了<code class="fe ox oy oz mc b">FARGATE_SPOT</code>和<code class="fe ox oy oz mc b">FARGATE</code>之间的比率，这意味着我们60%的流量将被部署到<code class="fe ox oy oz mc b">FARGATE_SPOT</code>，40%将在<code class="fe ox oy oz mc b">FARGATE</code>容量提供商上运行。你应该根据你的需要调整这个比例。</p><p id="0a1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，<code class="fe ox oy oz mc b">FARGATE_SPOT</code>应该仅用于可中断的工作负载，例如常规(<em class="os">例如每小时</em>)批处理作业。如果您喜欢标准的Fargate集群，请使用:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="4a44" class="mg mh iq mc b gy mi mj l mk ml"><em class="os">aws </em>ecs create-cluster --cluster-name $ECS_CLUSTER_NAME \<br/>--region $AWS_REGION</span></pre><h2 id="4ba7" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">准备IAM角色</h2><p id="d166" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">AWS区分了<strong class="ky ir">任务执行角色</strong>(授予启动任务中定义的<strong class="ky ir">容器</strong>的访问权限的一般角色)和<strong class="ky ir">任务角色</strong>，后者在容器启动后授予实际<strong class="ky ir">应用程序</strong>权限。您可以在本文的第4部分找到更详细的解释:</p><div class="pc pd gp gr pe pf"><a href="https://aws.plainenglish.io/8-common-mistakes-when-using-aws-ecs-to-manage-containers-3943402e8e59" rel="noopener  ugc nofollow" target="_blank"><div class="pg ab fo"><div class="ph ab pi cl cj pj"><h2 class="bd ir gy z fp pk fr fs pl fu fw ip bi translated">使用AWS ECS管理集装箱时的8个常见错误</h2><div class="pm l"><h3 class="bd b gy z fp pk fr fs pl fu fw dk translated">包括避免它们的AWS最佳实践</h3></div><div class="pn l"><p class="bd b dl z fp pk fr fs pl fu fw dk translated">aws .平原英语. io</p></div></div><div class="po l"><div class="pp l pq pr ps po pt kp pf"/></div></div></a></div><h2 id="43f9" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">任务执行角色</h2><p id="95d9" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">#1.创建承担信任策略的角色:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="fe4b" class="mg mh iq mc b gy mi mj l mk ml"><em class="os">cat </em>&lt;&lt;EOF <em class="os">&gt;ecs_tasks_trust_policy.json<br/></em>{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Service": [<br/>          "ecs-tasks.amazonaws.com"<br/>        ]<br/>      },<br/>      "Action": "sts:AssumeRole"<br/>    }<br/>  ]<br/>}<br/>EOF<br/><br/><em class="os">aws </em>iam create-role --role-name prefectECSAgentTaskExecutionRole \<br/>--assume-role-policy-document file://ecs_tasks_trust_policy.json --region $AWS_REGION</span></pre><p id="1e4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">#2.附加一般服务角色策略<code class="fe ox oy oz mc b">AmazonECSTaskExecutionRolePolicy</code>:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="81a5" class="mg mh iq mc b gy mi mj l mk ml"><em class="os">aws </em>iam attach-role-policy --role-name prefectECSAgentTaskExecutionRole \<br/>--policy-arn "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"</span></pre><p id="feb4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">#3.附加我们的自定义角色策略，因为ECS任务将需要从任务环境变量中的<a class="ae kv" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" rel="noopener ugc nofollow" target="_blank"> AWS系统管理器参数存储</a>中检索API密匙。</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="1e22" class="mg mh iq mc b gy mi mj l mk ml"><em class="os">cat </em>&lt;&lt;EOF <em class="os">&gt;ecs_tasks_execution_role.json<br/></em>{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "ssm:GetParameters"<br/>      ],<br/>      "Resource": "*"<br/>    }<br/>  ]<br/>}<br/>EOF<br/><br/><em class="os">aws </em>iam put-role-policy --role-name prefectECSAgentTaskExecutionRole \<br/>--policy-name prefectECSAgentTaskExecutionRolePolicy \<br/>--policy-document file://ecs_tasks_execution_role.json</span></pre><p id="7a4b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，您可以将范围缩小到我们需要的特定秘密，而不是<code class="fe ox oy oz mc b">"Resource": “*"</code>:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="c1c9" class="mg mh iq mc b gy mi mj l mk ml">"Resource": "arn:aws:ssm:YOUR_REGION:YOUR_AWS_ACCOUNT_ID:parameter/PREFECT__CLOUD__API_KEY"</span></pre><h2 id="6f39" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">任务角色</h2><p id="fb15" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">该角色需要<strong class="ky ir">授予对AWS资源</strong>的完全访问权限，如CloudWatch、EC2、ECS、IAM、S3等。对于每次流运行，Prefect都会创建一个新的ECS任务定义。在这样做的时候，它需要为一个流检索关于您的VPC、子网、安全组和IAM权限的信息。此外，必须授权it部门创建新的CloudWatch日志流，并为每次流运行放置日志。下面的策略描述了必要的权限:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="fa3f" class="mg mh iq mc b gy mi mj l mk ml"><em class="os"># permissions needed by Prefect to register new task definitions, deregister old ones, and create new flow runs as ECS tasks</em></span><span id="a207" class="mg mh iq mc b gy mm mj l mk ml"><em class="os">cat </em>&lt;&lt;EOF <em class="os">&gt;ecs_task_role.json<br/></em>{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ec2:AuthorizeSecurityGroupIngress",<br/>                "ec2:CreateSecurityGroup",<br/>                "ec2:CreateTags",<br/>                "ec2:DescribeNetworkInterfaces",<br/>                "ec2:DescribeSecurityGroups",<br/>                "ec2:DescribeSubnets",<br/>                "ec2:DescribeVpcs",<br/>                "ec2:DeleteSecurityGroup",<br/>                "ecs:CreateCluster",<br/>                "ecs:DeleteCluster",<br/>                "ecs:DeregisterTaskDefinition",<br/>                "ecs:DescribeClusters",<br/>                "ecs:DescribeTaskDefinition",<br/>                "ecs:DescribeTasks",<br/>                "ecs:ListAccountSettings",<br/>                "ecs:ListClusters",<br/>                "ecs:ListTaskDefinitions",<br/>                "ecs:RegisterTaskDefinition",<br/>                "ecs:RunTask",<br/>                "ecs:StopTask",<br/>                "iam:PassRole",<br/>                "logs:CreateLogStream",<br/>                "logs:PutLogEvents",<br/>                "logs:DescribeLogGroups",<br/>                "logs:GetLogEvents"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}<br/>EOF</span><span id="26ed" class="mg mh iq mc b gy mm mj l mk ml"><em class="os">aws </em>iam create-role --role-name prefectTaskRole --assume-role-policy-document file://ecs_tasks_trust_policy.json --region $AWS_REGION</span><span id="dc03" class="mg mh iq mc b gy mm mj l mk ml"><em class="os">aws </em>iam put-role-policy --role-name prefectTaskRole --policy-name prefectTaskRolePolicy --policy-document file://ecs_task_role.json</span></pre><blockquote class="op oq or"><p id="4987" class="kw kx os ky b kz la jr lb lc ld ju le ot lg lh li ou lk ll lm ov lo lp lq lr ij bi translated"><strong class="ky ir">注意:</strong>上面提到的一些权限被定义为允许在ECS 上启动<a class="ae kv" href="https://cloudprovider.dask.org/en/latest/aws.html#" rel="noopener ugc nofollow" target="_blank">临时Dask集群。如果你想把范围缩小到绝对必要的提督标准权限，</a><a class="ae kv" href="https://github.com/PrefectHQ/prefect/pull/4302#issuecomment-814650079" rel="noopener ugc nofollow" target="_blank">这个Github问题</a>可以帮到你。</p></blockquote><p id="774d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当使用带有AWS ECS的提督时，您可能希望使用S3作为提督<a class="ae kv" href="https://docs.prefect.io/orchestration/execution/storage_options.html#aws-s3" rel="noopener ugc nofollow" target="_blank">存储</a>和<a class="ae kv" href="https://docs.prefect.io/api/latest/engine/results.html#s3result" rel="noopener ugc nofollow" target="_blank">结果</a>后端。因此，向任务角色添加S3权限是可行的。以下是如何创建允许对特定S3时段执行任何操作的任务角色。</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="ae79" class="mg mh iq mc b gy mi mj l mk ml"><em class="os"># adjust it to include permissions needed by your flows<br/>cat </em>&lt;&lt;EOF <em class="os">&gt;ecs_task_role_s3.json<br/></em>{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Action": [<br/>        "s3:*"<br/>      ],<br/>      "Resource": "arn:aws:s3:::*prefect*"<br/>    }<br/>  ]<br/>}<br/>EOF</span><span id="55e4" class="mg mh iq mc b gy mm mj l mk ml"><em class="os">aws </em>iam put-role-policy --role-name prefectTaskRole --policy-name prefectTaskRoleS3Policy --policy-document file://ecs_task_role_s3.json</span></pre><blockquote class="op oq or"><p id="f43d" class="kw kx os ky b kz la jr lb lc ld ju le ot lg lh li ou lk ll lm ov lo lp lq lr ij bi translated">上述策略授予对名称中包含单词“prefect”的<strong class="ky ir"> S3存储桶执行任何操作的访问权限</strong> —为了提高安全性，您可以指定想要与Prefect一起使用的确切的S3存储桶名称。</p></blockquote><h2 id="d836" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">创建云观察日志组</h2><p id="09ec" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">在执行期间，每个ECS任务将容器日志发送到CloudWatch <strong class="ky ir">日志流</strong>。日志流被分成<strong class="ky ir">日志组</strong>。为了让ECS任务发送这些容器日志，我们需要创建日志组并在任务定义中指定它。</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="929b" class="mg mh iq mc b gy mi mj l mk ml">aws logs create-log-group --log-group-name $<!-- -->ECS_LOG_GROUP_NAME <!-- -->--region $AWS_REGION</span></pre><h2 id="bb0c" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">为ECSAgent注册任务定义</h2><p id="69f0" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">我们最终可以为我们的总监的ECSAgent流程注册任务定义。</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="bb34" class="mg mh iq mc b gy mi mj l mk ml"><em class="os"># search-replace the AWS_ACCOUNT_ID below with your AWS account ID. Also, replace or add ECS Agent labels</em></span><span id="cd4b" class="mg mh iq mc b gy mm mj l mk ml"><em class="os">cat </em>&lt;&lt;EOF <em class="os">&gt;prefect_ecs_agent_task_definition.json<br/></em>{<br/>    "family": "$ECS_SERVICE_NAME",<br/>    "requiresCompatibilities": [<br/>        "FARGATE"<br/>    ],<br/>    "networkMode": "awsvpc",<br/>    "cpu": "512",<br/>    "memory": "1024",<br/>    "taskRoleArn": "arn:aws:iam::AWS_ACCOUNT_ID:role/prefectTaskRole",<br/>    "executionRoleArn": "arn:aws:iam::AWS_ACCOUNT_ID:role/prefectECSAgentTaskExecutionRole",<br/>    "containerDefinitions": [<br/>        {<br/>            "name": "$ECS_SERVICE_NAME",<br/>            "image": "prefecthq/prefect:latest-python3.8",<br/>            "essential": true,<br/>            "command": [<br/>                "prefect",<br/>                "agent",<br/>                "ecs",<br/>                "start"<br/>            ],<br/>            "environment": [<br/>                {<br/>                    "name": "PREFECT__CLOUD__AGENT__LABELS",<br/>                    "value": "['prod']"<br/>                },<br/>                {<br/>                    "name": "PREFECT__CLOUD__AGENT__LEVEL",<br/>                    "value": "INFO"<br/>                },<br/>                {<br/>                    "name": "PREFECT__CLOUD__API",<br/>                    "value": "https://api.prefect.io"<br/>                }<br/>            ],<br/>            "logConfiguration": {<br/>                "logDriver": "awslogs",<br/>                "options": {<br/>                    "awslogs-group": "$ECS_LOG_GROUP_NAME",<br/>                    "awslogs-region": "$AWS_REGION",<br/>                    "awslogs-stream-prefix": "ecs",<br/>                    "awslogs-create-group": "true"<br/>                }<br/>            },<br/>            "secrets": [<br/>                {<br/>                    "name": "PREFECT__CLOUD__API_KEY",<br/>                    "valueFrom": "arn:aws:ssm:$AWS_REGION:AWS_ACCOUNT_ID:parameter/PREFECT__CLOUD__API_KEY"<br/>                }<br/>            ]<br/>        }<br/>    ]<br/>}<br/>EOF<br/><br/><em class="os">aws </em>ecs register-task-definition --cli-input-json file://prefect_ecs_agent_task_definition.json --region $AWS_REGION</span></pre><h2 id="1fd5" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">查找您的子网id</h2><p id="2d3c" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">要将此ECS任务作为连续运行的服务运行，我们必须选择此任务应在其中运行的VPC和子网。在本演示中，我们将使用默认VPC及其对应的公共子网。每个地区都有默认的VPC，所以除非需要，否则不必创建任何新的VPC。</p><p id="dd4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是您如何查找所选地区的id:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pu"><img src="../Images/4825b4320953af23c223ed37bd0df644.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vwiL0avlAKRqJEIppBFJIg.png"/></div></div></figure><p id="70ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">或者，您可以从AWS CLI中查找这些id:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="37c8" class="mg mh iq mc b gy mi mj l mk ml">aws ec2 describe-subnets --region $AWS_REGION</span></pre><p id="9a89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了方便起见，下面是如何提取id并将它们导出为环境变量的方法——我们将在下一节中使用它们:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="6d69" class="mg mh iq mc b gy mi mj l mk ml">export VPC=$(aws ec2 describe-vpcs --filters Name=is-default,Values=true)</span><span id="c326" class="mg mh iq mc b gy mm mj l mk ml">export VPC_ID=$(echo $VPC | jq -r '.Vpcs | .[0].VpcId')</span><span id="2f0a" class="mg mh iq mc b gy mm mj l mk ml">SUBNETS=$<em class="os">(aws </em>ec2 describe-subnets --filters Name=vpc-id,Values=$VPC_ID --region $AWS_REGION<em class="os">)</em></span><span id="7646" class="mg mh iq mc b gy mm mj l mk ml"><em class="os">export </em>SUBNET1=$<em class="os">(echo </em>$SUBNETS | <em class="os">jq </em>-r '.Subnets | .[0].SubnetId'<em class="os">)<br/>export </em>SUBNET2=$<em class="os">(echo </em>$SUBNETS | <em class="os">jq </em>-r '.Subnets | .[1].SubnetId'<em class="os">)<br/>export </em>SUBNET3=$<em class="os">(echo </em>$SUBNETS | <em class="os">jq </em>-r '.Subnets | .[2].SubnetId'<em class="os">)</em></span></pre><h2 id="566f" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">为ECSAgent启动持续运行的ECS服务</h2><p id="7e88" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">此服务的好处是，ECS控制面板将确保此过程始终运行。如果出现问题，ECS将为我们的完美代理创建一个新的容器。</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="ddc5" class="mg mh iq mc b gy mi mj l mk ml"><em class="os">aws </em>ecs create-service \<br/>    --service-name $ECS_SERVICE_NAME\<br/>    --task-definition $ECS_SERVICE_NAME:1 \<br/>    --desired-count 1 \<br/>    --launch-type FARGATE \<br/>    --platform-version LATEST \<br/>    --cluster $ECS_CLUSTER_NAME \<br/>    --network-configuration awsvpcConfiguration="{subnets=[$SUBNET1, $SUBNET2, $SUBNET3],assignPublicIp=ENABLED}" --region $AWS_REGION</span></pre><h2 id="29bd" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">在完美用户界面中验证代理设置</h2><p id="ef77" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">如果一切按预期运行，我们应该看到一个新的ECSAgent准备好部署新的流运行。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pv"><img src="../Images/5ccef0d9926c6997119248cec064042f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YgEZjMbNQp983olDQjO8fg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">完美代理页面-按作者分类的图片</p></figure></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="5b72" class="mu mh iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">部署一个示例完美流</h1><p id="1c08" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">如果您还没有任何完美的项目，您可以从CLI创建它:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="a891" class="mg mh iq mc b gy mi mj l mk ml">prefect create project “ECS_Flows”</span></pre><p id="7a10" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您可以使用<a class="ae kv" href="https://docs.prefect.io/orchestration/flow_config/run_configs.html#ecsrun" rel="noopener ugc nofollow" target="_blank"> ECSRun </a>部署一个示例流，它将为ECS任务提供元数据，例如:</p><ul class=""><li id="3a08" class="ob oc iq ky b kz la lc ld lf od lj oe ln of lr og oh oi oj bi translated">自定义容器<code class="fe ox oy oz mc b">image</code>，</li><li id="8378" class="ob oc iq ky b kz ok lc ol lf om lj on ln oo lr og oh oi oj bi translated">ECS代理<code class="fe ox oy oz mc b">labels</code>，</li><li id="0e5a" class="ob oc iq ky b kz ok lc ol lf om lj on ln oo lr og oh oi oj bi translated">为您的流定制AWS权限，以<code class="fe ox oy oz mc b">task_role_arn</code>的形式提供，</li><li id="697d" class="ob oc iq ky b kz ok lc ol lf om lj on ln oo lr og oh oi oj bi translated">还有<code class="fe ox oy oz mc b">cpu</code>和<code class="fe ox oy oz mc b">memory</code>。</li></ul><p id="fcd0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意，在这个流中，我们还指定了<code class="fe ox oy oz mc b">S3</code>存储——这将把流文件上传到指定的S3存储桶。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pw px l"/></div></figure><p id="e9ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确保用您的AWS帐户ID替换<code class="fe ox oy oz mc b">123456</code>。</p><p id="6c06" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，如果您向您的<code class="fe ox oy oz mc b">ECSRun</code>提供一个定制的ECR映像，请确保也显式地指定<code class="fe ox oy oz mc b">execution_role_arn</code>，否则，您将得到一个ClientException，告诉您<strong class="ky ir"> Fargate需要任务定义具有执行角色ARN来支持ECR映像</strong>。您可以这样指定:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="136c" class="mg mh iq mc b gy mi mj l mk ml">RUN_CONFIG = ECSRun(<br/>    labels=["prod"],<br/>    task_role_arn="arn:aws:iam::XXX:role/prefectTaskRole",<br/>    execution_role_arn="arn:aws:iam::XXX:role/prefectECSAgentTaskExecutionRole",<br/>    run_task_kwargs=dict(cluster="prefectEcsCluster", launchType="FARGATE",),<br/>    image="XXX.dkr.ecr.us-east-1.amazonaws.com/prefect-custom-image:latest"<br/>)</span></pre><h2 id="1e8c" class="mg mh iq bd mv nl nm dn mz nn no dp nd lf np nq nf lj nr ns nh ln nt nu nj nv bi translated">为您的完美流程构建一个定制的Docker映像</h2><p id="76cc" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">如果您的流需要定制的包依赖项，比如<code class="fe ox oy oz mc b">pandas</code>或<code class="fe ox oy oz mc b">scikit-learn</code>，那么创建一个已经包含这些依赖项的定制容器映像被认为是最佳实践。以下是你如何做到这一点。</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="682b" class="mg mh iq mc b gy mi mj l mk ml">cat &lt;&lt;EOF &gt;Dockerfile<br/>FROM prefecthq/prefect:latest-python3.9<br/>RUN pip install --upgrade pip \\<br/>&amp;&amp; pip install pandas scikit-learn boto3<br/>EOF</span></pre><p id="8acc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，要构建Docker映像并将其推送到ECR，请使用:</p><pre class="kg kh ki kj gt mb mc md me aw mf bi"><span id="daf1" class="mg mh iq mc b gy mi mj l mk ml">export AWS_REGION=<!-- -->us-east-1<br/>export AWS_ACCOUNT_ID=123456789<br/>export IMAGE_NAME=prefect-custom-image<br/>export IMAGE_TAG=latest<br/><br/>docker build -t $IMAGE_NAME .</span><span id="17dc" class="mg mh iq mc b gy mm mj l mk ml">aws ecr create-repository --repository-name $IMAGE_NAME --region $AWS_REGION</span><span id="f6bc" class="mg mh iq mc b gy mm mj l mk ml">docker tag "$IMAGE_NAME":"$IMAGE_TAG" "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME":"$IMAGE_TAG"</span><span id="fa6d" class="mg mh iq mc b gy mm mj l mk ml">aws ecr get-login-password | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com</span><span id="6247" class="mg mh iq mc b gy mm mj l mk ml">docker push "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME":"$IMAGE_TAG"</span></pre><p id="10bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在您可以在您的<code class="fe ox oy oz mc b">ECSRun</code> <a class="ae kv" href="https://docs.prefect.io/api/latest/run_configs.html#ecsrun" rel="noopener ugc nofollow" target="_blank">运行配置</a>中指定这个映像(流程要点中的第14行)。</p></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="a041" class="mu mh iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">结论</h1><p id="8566" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">在本文中，我们研究了如何将AWS ECS Fargate设置为完美代理。我们调查了各种容量提供商配置以优化成本，并解释了根据您的需求定制此设置所需的所有步骤。</p><p id="0870" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">资源:</strong></p><ul class=""><li id="a197" class="ob oc iq ky b kz la lc ld lf od lj oe ln of lr og oh oi oj bi translated"><a class="ae kv" href="https://aws.amazon.com/blogs/aws/aws-fargate-spot-now-generally-available/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/AWS/AWS-fargate-spot-now-generally-available/</a></li><li id="40a3" class="ob oc iq ky b kz ok lc ol lf om lj on ln oo lr og oh oi oj bi translated">Fargate spot —成本节约演示:<a class="ae kv" href="https://tomgregory.com/aws-fargate-spot-vs-fargate-price-comparison/" rel="noopener ugc nofollow" target="_blank">https://Tom Gregory . com/AWS-fargate-spot-vs-fargate-price-comparison/</a></li><li id="6f35" class="ob oc iq ky b kz ok lc ol lf om lj on ln oo lr og oh oi oj bi translated">深潜:<a class="ae kv" href="https://aws.amazon.com/blogs/compute/deep-dive-into-fargate-spot-to-run-your-ecs-tasks-for-up-to-70-less/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/compute/deep-dive-into-fargate-spot-to-run-your-ECS-tasks-for-up-to-70-less/</a></li><li id="ddab" class="ob oc iq ky b kz ok lc ol lf om lj on ln oo lr og oh oi oj bi translated"><a class="ae kv" href="https://ecsworkshop.com/capacity_providers/fargate/" rel="noopener ugc nofollow" target="_blank">https://ecsworkshop.com/capacity_providers/fargate/</a></li></ul></div></div>    
</body>
</html>