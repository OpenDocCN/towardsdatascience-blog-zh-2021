<html>
<head>
<title>How to Double A/B Testing Speed with CUPED</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用CUPED使A/B测试速度加倍</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-double-a-b-testing-speed-with-cuped-f80460825a90?source=collection_archive---------3-----------------------#2021-05-18">https://towardsdatascience.com/how-to-double-a-b-testing-speed-with-cuped-f80460825a90?source=collection_archive---------3-----------------------#2021-05-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d47f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">微软的方差缩减正在成为行业标准。</h2></div><p id="5c30" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用已有数据的受控实验(CUPED)是由<a class="ae lb" href="https://exp-platform.com/Documents/2013-02-CUPED-ImprovingSensitivityOfControlledExperiments.pdf" rel="noopener ugc nofollow" target="_blank">微软在2013年</a>创造的一种方差缩减技术。从那以后，它已经在Booking.com的<a class="ae lb" href="https://www.kdd.org/kdd2016/papers/files/adp0945-xieA.pdf" rel="noopener ugc nofollow" target="_blank"/>、<a class="ae lb" href="https://booking.ai/how-booking-com-increases-the-power-of-online-experiments-with-cuped-995d186fff1d" rel="noopener ugc nofollow" target="_blank"/>、<a class="ae lb" href="https://medium.com/bbc-data-science/increasing-experiment-sensitivity-through-pre-experiment-variance-reduction-166d7d00d8fd" rel="noopener"> BBC </a>等许多地方实施。</p><p id="041d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">简而言之，CUPED使用实验前的数据来控制实验中北极星度量的自然变化。通过去除自然变异，我们可以进行需要较小样本量的统计测试。CUPED可以添加到几乎任何A/B测试框架中；它的计算效率很高，编码也相当简单。</p><p id="be1e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，它的发音是<em class="lc">库伊-PED </em>。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ld"><img src="../Images/cc7ebef018f517aee2c9ce4ff56ee794.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r9empMdWjpMaftsp__4lKw.png"/></div></div></figure><h1 id="7184" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">技术TLDR</h1><p id="ad66" class="pw-post-body-paragraph kf kg iq kh b ki mh jr kk kl mi ju kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated"><strong class="kh ir"> 1)选择一个预实验协变量(<em class="lc"> X </em>)。</strong>协变量应与实验的北极星度量(<em class="lc"> Y </em>)高度相关，且不应受实验处理的影响。通常，最佳协变量是实验期之前的北极星度量。</p><p id="a2f6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> 2)计算每个实验条件下的CUPED调整度量(<em class="lc">ŷ</em>)。</strong>因此，我们不用公制平均值(<em class="lc"> Y </em>)来计算升力，而是用经过顶部调整的公制:<em class="lc">ŷ</em>。</p><pre class="le lf lg lh gt mm mn mo mp aw mq bi"><span id="59ea" class="mr lq iq mn b gy ms mt l mu mv">Y_HAT = avg(Y) - (cov(X,Y)/var(X)) * avg(X)</span></pre><p id="bd44" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">3)计算每个实验条件的CUPED调整方差。</p><pre class="le lf lg lh gt mm mn mo mp aw mq bi"><span id="7b2b" class="mr lq iq mn b gy ms mt l mu mv">VAR_Y_HAT = var(Y) * (1 - corr(X,Y))</span></pre><p id="5ff7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用CUPED调整后的指标。在下一节中，我们将在t-test中使用CUPED调整的指标。</p><h1 id="1d9a" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">但是，CUPED实际上是如何工作的呢？</h1><p id="b3c4" class="pw-post-body-paragraph kf kg iq kh b ki mh jr kk kl mi ju kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">好的，让我们踩一下刹车，试着理解发生了什么。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi mw"><img src="../Images/65090024f6937afa50f7a91831f76603.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*BwccUTDUDSbTzbK6FMGsdw.gif"/></div></div></figure><p id="fbb2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在进行经典A/B测试时，有3个因素会影响我们确定统计显著性的能力:样本大小(<em class="lc"> n </em>)、标准差(<em class="lc"> σ </em>)和提升量(<em class="lc">δ</em>)，也就是处理均值和控制均值之间的差异。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/078d30eb8d5d869b3c82b04fe1148c4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:612/format:webp/1*DRFP1c3zJAcE3Z3n-JpgqQ.png"/></div></figure><p id="e1cf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们希望找到最极端的t统计量，我们的目标是增加<em class="lc"> n </em>和<em class="lc">δ</em>，同时减少<em class="lc"> σ </em>。不幸的是，这些值通常被认为是固定的；我们在实验开始时确定样本量，并祈祷治疗是有效的，从而有很大的提升。</p><p id="a748" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">另一方面，标准差是我们选择的北极星度量的一个特征。太好了，那么把高方差指标换成低方差指标？这可能行得通，但CUPED提供了另一种选择。通过使用实验之前的数据，CUPED能够控制我们的度量固有的变化并消除它。</p><p id="bb17" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">微软的团队确定了两种利用蒙特卡罗抽样概念来减少方差的方法。这是两者的关键点:<strong class="kh ir">任何预实验数据都是独立于实验的，因此可以用来减少方差。</strong>我们知道这是真的，因为当我们将用户随机分为对照组和治疗组时，我们可以假设两个实验组具有相同的特征，即所有混杂变量在这些组之间均匀分布。</p><p id="23f5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，因为我们可以选择任何不受治疗系统影响的协变量，我们将理想地找到最小化<em class="lc"> Y </em>方差的协变量。不出所料，通常这个协变量就在实验之前的<em class="lc"> Y </em>。</p><h2 id="1000" class="mr lq iq bd lr my mz dn lv na nb dp lz ko nc nd mb ks ne nf md kw ng nh mf ni bi translated"><strong class="ak">计算调整后的度量值和方差</strong></h2><p id="988f" class="pw-post-body-paragraph kf kg iq kh b ki mh jr kk kl mi ju kn ko mj kq kr ks mk ku kv kw ml ky kz la ij bi translated">好了，现在我们有了一些背景，让我们来了解如何计算CUPED。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi nj"><img src="../Images/b81ec485b3b3452f8bdfa9f5402779ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:344/format:webp/1*SDGXKoJbQKUgH-WhfoQ74A.png"/></div></div><p class="nk nl gj gh gi nm nn bd b be z dk translated">CUPED调整的度量公式</p></figure><p id="dc82" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于每个治疗中的每个用户，我们将计算他们的CUPED调整值，其中…</p><ul class=""><li id="f13a" class="no np iq kh b ki kj kl km ko nq ks nr kw ns la nt nu nv nw bi translated"><em class="lc">ŷi(y形帽)</em>是CUPED调整的度量，</li><li id="2a2e" class="no np iq kh b ki nx kl ny ko nz ks oa kw ob la nt nu nv nw bi translated"><em class="lc">易</em>是北极星的公制、</li><li id="dc70" class="no np iq kh b ki nx kl ny ko nz ks oa kw ob la nt nu nv nw bi translated"><em class="lc"> θ (theta) </em>为常数，值为<em class="lc"> cov(X，Y)/var(X)，</em>其中<em class="lc"> X </em>和<em class="lc"> Y </em>对应给定处理中的所有用户，</li><li id="313d" class="no np iq kh b ki nx kl ny ko nz ks oa kw ob la nt nu nv nw bi translated"><em class="lc"> Xi </em>是反，而</li><li id="f9ab" class="no np iq kh b ki nx kl ny ko nz ks oa kw ob la nt nu nv nw bi translated"><em class="lc"> i </em>是给定用户对应的下标。</li></ul><p id="7313" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样。很简单，对吧？</p><p id="de19" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可能会注意到，这个方程看起来很像线性回归。事实证明，我们实际上在做普通最小二乘(OLS)回归同样的事情；<em class="lc"> θ </em>的最优值为<em class="lc"> </em>与OLS回归系数相同:<em class="lc"> cov(X，Y)/var(X) </em>。</p><p id="30d5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在做了更多的工作后，我们确定…</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/aa9665bc8c4ca57574dfbcf2dd556bd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*GYSFvp-it05CqgA5IRG8kQ.png"/></div></figure><p id="73dd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你明白为什么<em class="lc"> X </em>和<em class="lc"> Y </em>之间的高相关性会导致方差的最大减少吗？</p><p id="9d58" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们已经有了CUPED调整的指标和该指标的方差，我们可以运行t-test，并有望观察到更小的p值。如果你是手工计算，注意分母必须考虑到我们的处理和控制有不同的方差。这并不是一个糟糕的计算——只需点击<a class="ae lb" href="https://www.statsdirect.co.uk/help/parametric_methods/utt.htm" rel="noopener ugc nofollow" target="_blank">此链接</a>获取完整的公式。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div class="gh gi od"><img src="../Images/d64d9dc61ca479e73739154b930a9ff3.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*vT2umgzlAr1vjejrvy0K9A.png"/></div></figure><p id="a229" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">最后一点:缺失数据</strong></p><p id="ef7a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">CUPED工作得很好，直到我们没有用户的预实验数据。例如，我们可以对以前从未访问过我们网站的新用户进行实验。在这种情况下，我们实施最简单的解决方案，只对这些用户使用未调整的指标。现在，如果您的所有用户都是第一次使用，您可能希望选择不同的预实验<em class="lc"> X </em>，但这取决于您。</p><h1 id="844c" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">实施说明(Microsoft 2013)</h1><ul class=""><li id="b654" class="no np iq kh b ki mh kl mi ko oe ks of kw og la nt nu nv nw bi translated">一般来说，最佳的预实验窗口是1-2周。较短的窗口不能捕获足够的方差，而较长的窗口会捕获噪声。</li><li id="889a" class="no np iq kh b ki nx kl ny ko nz ks oa kw ob la nt nu nv nw bi translated">对于更长的实验，需要更长的预实验窗口，以确保在实验期间和实验之前观察到相同的用户。</li><li id="d297" class="no np iq kh b ki nx kl ny ko nz ks oa kw ob la nt nu nv nw bi translated">CUPED性能高度依赖于度量；在用户群体中具有高方差的度量将表现良好。</li><li id="e688" class="no np iq kh b ki nx kl ny ko nz ks oa kw ob la nt nu nv nw bi translated">确保你的协变量<em class="lc"> X </em>在治疗和控制之间均匀分布。如果它受到治疗的系统性影响，CUPED就无效了。</li><li id="22aa" class="no np iq kh b ki nx kl ny ko nz ks oa kw ob la nt nu nv nw bi translated">上面的CUPED方法仅移除可以线性解释的方差。非线性方法将在以后的文章中讨论。</li></ul></div><div class="ab cl oh oi hu oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ij ik il im in"><p id="0686" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lc">查看评论中这篇论文和其他资源的链接。</em></p></div></div>    
</body>
</html>