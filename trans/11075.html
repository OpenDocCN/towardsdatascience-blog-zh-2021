<html>
<head>
<title>Automate Multiple CSV Files to BigQuery Pipelines with Google Sheets and Apps Script</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Google Sheets 和 Apps 脚本将多个 CSV 文件自动转换为 BigQuery 管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automate-multiple-csv-to-bigquery-pipelines-with-google-sheets-apps-script-3ff05f535a09?source=collection_archive---------29-----------------------#2021-10-28">https://towardsdatascience.com/automate-multiple-csv-to-bigquery-pipelines-with-google-sheets-apps-script-3ff05f535a09?source=collection_archive---------29-----------------------#2021-10-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="10e2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将一些简单的数据放入 BigQuery，而不必使用大量工具或复杂的工作流</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7da1463b6cff2694778bf80cd8b70cde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SOe5xf0wnLh8CMQ1"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/photos/JKUTrJ4vK00" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/JKUTrJ4vK00</a></p></figure><p id="b749" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">想要将 CSV 文件的多个管道自动加载到不同的 BigQuery 项目/数据集/表，并从单个 Google Sheet 控制它们吗？什么事？那么这篇文章就送给你了。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="2dbd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个过程甚至允许您配置是否希望自动化在每次向 BigQuery 表中截断或追加数据。不错吧？</p><h1 id="f27d" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">背景</h1><p id="a58e" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">不久前，我<a class="ae kv" href="https://www.techupover.com/automatically-load-csv-files-from-google-drive-into-bigquery-using-appscript/" rel="noopener ugc nofollow" target="_blank">写了一个使用 Google Apps 脚本</a>将 CSV 文件加载到 BigQuery 的过程。这个过程在代码中使用了检测到的 CSV 文件类型的定义、BigQuery 的加载模式以及其他一些东西。我意识到对于入门者来说，这可能是多余的，需要他们自己写太多的代码。因此，我重写了这个过程，使之更加简单，使用一个 Google Sheet 作为管道管理器。</p><h1 id="ab73" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">先决条件</h1><ul class=""><li id="3299" class="mw mx iq ky b kz mr lc ms lf my lj mz ln na lr nb nc nd ne bi translated">谷歌账户</li><li id="a3cd" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">谷歌应用程序脚本—【script.google.com T4】</li><li id="7504" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">谷歌大查询项目、数据集、表—<a class="ae kv" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank">console.cloud.google.com</a></li><li id="c2e6" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">此<a class="ae kv" href="https://docs.google.com/spreadsheets/d/1OOs3bEff7f6KOdMwFqwXlAXPCyB13RZ8e6oHcexAMZE/copy" rel="noopener ugc nofollow" target="_blank">谷歌表单的副本</a></li><li id="288d" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">要加载到 BigQuery 的 CSV 文件</li><li id="24a7" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">来自<a class="ae kv" href="https://github.com/usaussie/appscript-multiple-bigquery-pipelines-google-sheet" rel="noopener ugc nofollow" target="_blank">这个</a>仓库的代码</li></ul><h1 id="6d04" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">Google 工作表和驱动设置</h1><p id="08f8" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">首先，将 google sheet 复制到你自己的 google 账户中。然后创建一些 Google Drive 文件夹来存放您的 CSV 文件。</p><p id="cd66" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您将需要一个谷歌驱动器“源”文件夹为每一个不同类型的 CSV。如果你愿意，你可以有多个“已处理”文件夹，或者如果你希望所有的东西都在同一个地方，你可以有同一个“已处理”文件夹。这真的取决于你。</p><p id="d2b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，您将在适当的列中用 Google Drive ID 更新 Google 工作表。在浏览器中使用 Google Drive 时，ID 位于 URL 的末尾。例如:如果 Google Drive 文件夹的 URL 是<em class="nk">https://Drive . Google . com/Drive/u/0/folders/1-zfa 8 svucirp xf J2 Cun 31 a</em>，那么 Drive 文件夹的 ID 就是“<em class="nk">1-zfa 8 svucirp xf J2 Cun 31 a</em>”，这就是你要放入 Google Sheet 的列中的内容。</p><h1 id="d8b5" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">BigQuery 设置</h1><p id="8c6f" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">对于要加载的每种 CSV 类型，您都需要一个 BigQuery 表。如果你有 4 种不同的 CSV 文件，那么你需要 4 个不同的表格。这些可以跨任意数量的 BigQuery 项目和数据集进行拆分，但是最终每个 CSV 类型都需要一个表。</p><p id="f744" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您已经设置了 BigQuery 表，那么您需要做的就是用适当的信息(项目 ID、数据集 ID、表 ID)更新 Google 工作表</p><p id="e3f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您需要创建一个新的 BigQuery 表，最简单的方法(无需编写任何代码)是通过 BigQuery 控制台上传一个 CSV，并使用 Autodetect 为您设置模式。然后，该类型 CSV 的每个后续加载将保证工作。</p><p id="95d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">上传 CSV 以创建 BigQuery 表:</strong></p><ol class=""><li id="8da7" class="mw mx iq ky b kz la lc ld lf nl lj nm ln nn lr no nc nd ne bi translated">【https://console.cloud.google.com/bigquery T2】号</li><li id="0802" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr no nc nd ne bi translated">单击左侧导航栏上的项目名称</li><li id="a4ee" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr no nc nd ne bi translated">单击 3 点菜单并创建一个新数据集</li><li id="73f1" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr no nc nd ne bi translated">点击数据集名称，然后点击<em class="nk">创建表</em></li></ol><p id="ecc2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您的表被创建时，将它的 ID 与项目 ID 和数据集 ID 一起放入 Google Sheet。</p><h1 id="2a11" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">创建您的应用程序脚本项目并配置代码</h1><p id="35b6" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">到目前为止，您应该已经有了一个 Google Sheet，其中填充了许多关于您的 Google Drive 文件夹、您的 BigQuery 项目/数据集/表的详细信息，现在剩下要做的就是将代码放入适当的位置，使它们一起工作。</p><p id="4bca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在 Google 表单中，打开脚本编辑器。在撰写本文时，如果你使用的是个人 gmail.com 账户，这将通过<strong class="ky ir">工具- &gt;脚本编辑器</strong>菜单项实现。如果您使用的是组织/学校帐户，这将通过<strong class="ky ir">扩展- &gt;应用程序脚本</strong>菜单项实现。</p><p id="30c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将打开应用程序脚本编辑器。</p><p id="269a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从这个 github 存储库中复制 code.gs 文件内容，并粘贴到现有的 Code.gs 文件中。</p><p id="e0ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">单击+图标添加一个新的 HTML 文件，并将其命名为“email ”,这样您的文件列表如下所示:</p><p id="6eb7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从同一个 github 存储库中复制 email.html 文件内容，并将其粘贴到 Apps 脚本中的 email.html 文件中。</p><p id="3d8e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用左侧服务菜单旁边的+图标添加 BigQuery 和 Drive 服务(因此您的服务列表看起来也像上面的截图)。</p><p id="ff24" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开 Code.gs 文件并更新文件顶部的变量。您可以在这里设置诸如工作表标签名称(如果您已经从原始模板中更改了它们)以及该流程也可以发送的电子邮件通知中的信息。</p><p id="1ebd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就是这样。这就是你需要做的所有设置。</p><h1 id="3d70" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">让这东西跑起来，好吗？</h1><ul class=""><li id="4980" class="mw mx iq ky b kz mr lc ms lf my lj mz ln na lr nb nc nd ne bi translated">将适当类型的 CSV 文件放入 Google 工作表指定的 Google Drive 文件夹中</li><li id="0801" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">在应用程序脚本中，单击顶部的运行按钮，运行列出的唯一函数</li><li id="a3c4" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">当你第一次运行这个程序时，谷歌会询问你是否确定，以一些安全/批准提示的形式。这是正常的…这是您授权访问您的应用程序脚本项目，以便能够使用您的 Google Drive、BigQuery 和 Gmail 内容/服务。这是不允许谷歌或其他任何人对你的帐户做事情。只要确保你不与其他人分享谷歌表单，他们可能会用它来做一些邪恶的事情(因为他们也可以看到和编辑这些代码)。</li><li id="9849" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">这些提示看起来有点像这样:</li><li id="2886" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">之后…脚本将第一次运行。</li><li id="575d" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">检查 Google Sheet 的日志选项卡，看看它是否做了什么。</li><li id="5699" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">现在，为了好玩，再放几个 CSV 到文件夹中，然后再次运行该函数。看…成功了！</li><li id="546f" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">接下来，您将希望设置一个触发器来按计划自动运行该功能。只需使用应用程序脚本项目左侧的触发器菜单来设置触发器，如下所示:</li></ul><p id="87bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在…真的是这样。简单吧？</p><p id="a979" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在 BigQuery 控制台中看到自动化作业的结果——在 BigQuery 中查看作业，然后查看数据集和表，您应该会很快看到表中的数据。如果你改变了这个网址中的 id…这就是你应该去查看的地方:<a class="ae kv" href="https://console.cloud.google.com/bigquery?project=id&amp;page=jobs" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/bigquery?project=id&amp;page =乔布斯</a>(这也在谷歌表单日志中)。</p><h1 id="122e" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">万岁！</h1><p id="49e1" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">希望这比<a class="ae kv" href="https://www.techupover.com/automatically-load-csv-files-from-google-drive-into-bigquery-using-appscript/" rel="noopener ugc nofollow" target="_blank">的原始文章/方法</a>更容易理解，并且不需要使用很多工具或复杂的工作流程就可以将一些简单的数据导入 BigQuery。</p><p id="3acc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我知道这个过程可以通过从 CSV 文件中自动检测模式来改进，以创建初始表，并且应该有更多的错误处理…但是…这是为了后面的提交和拉请求:-)</p><p id="f520" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是代码:<a class="ae kv" href="https://github.com/usaussie/appscript-multiple-bigquery-pipelines-google-sheet" rel="noopener ugc nofollow" target="_blank">https://github . com/usaussie/app script-multiple-big query-pipelines-Google-sheet</a></p><p id="95c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇文章大概贴在<a class="ae kv" href="https://www.techupover.com/" rel="noopener ugc nofollow" target="_blank">techupover.com</a>和<a class="ae kv" href="http://techupover.medium.com" rel="noopener">techupover.medium.com</a>上。也可以在 Twitter 上关注我<a class="ae kv" href="http://twitter.com/techupover" rel="noopener ugc nofollow" target="_blank"> @techupover </a></p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="b9a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nk">原载于 2021 年 10 月 28 日</em><a class="ae kv" href="https://www.techupover.com/manage-multiple-bigquery-csv-pipelines/" rel="noopener ugc nofollow" target="_blank"><em class="nk">【https://www.techupover.com】</em></a><em class="nk">。</em></p></div></div>    
</body>
</html>