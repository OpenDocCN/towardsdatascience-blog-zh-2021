<html>
<head>
<title>SQL Nested Window Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL嵌套窗口函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sql-window-functions-64c26bd643fd?source=collection_archive---------16-----------------------#2021-04-26">https://towardsdatascience.com/sql-window-functions-64c26bd643fd?source=collection_archive---------16-----------------------#2021-04-26</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><h2 id="98d9" class="ip iq ir bd b dl is it iu iv iw ix dk iy translated" aria-label="kicker paragraph">辅导的</h2><div class=""/><div class=""><h2 id="1ce3" class="pw-subtitle-paragraph jx ja ir bd b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dk translated">嵌套的Case表达式:无限可能</h2></div><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj kp"><img src="../Images/19d5ab475d532dc06dd22e317cb60cec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HDTl5hwwWLcIwwEZpzaDBw.jpeg"/></div></div><p class="lb lc gk gi gj ld le bd b be z dk translated">卡尔·弗雷德里克森</p></figure><blockquote class="lf lg lh"><p id="6f7c" class="li lj lk ll b lm ln kb lo lp lq ke lr ls lt lu lv lw lx ly lz ma mb mc md me ik bi translated">不要用你自己的极限来定义我的宇宙的参数。—匿名</p></blockquote><p id="55b8" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">一个<strong class="ll jb">日落</strong>美得令人望而生畏。每当我看到它，我意识到我只受到视角和视野的限制。超越这些限制的是一个无限可能性的世界。在那个世界里，我是自由的。我可以自由想象，希望和梦想。我可以自由地<strong class="ll jb">绘制一条</strong>通向<strong class="ll jb">想象力</strong>和<strong class="ll jb">创造力</strong>未知目的地的路线。我不受年龄、背景、性别或种族的限制。我的思想是画布，想法是原材料。<strong class="ll jb">所以</strong>，是用<strong class="ll jb"> SQL窗口</strong>功能实现的。<strong class="ll jb">只有</strong>有限的视角和视野阻碍了他们<strong class="ll jb">创造性的</strong>用法。</p><p id="0043" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">为了突破自我强加的限制，我鼓励想象和实验。在这篇<strong class="ll jb">高级</strong>教程中，我通过将<code class="fe mi mj mk ml b">CASE Expression</code>添加到SQL窗口函数中，打开了深入学习的大门。作为一个高级主题，我将介绍与学习相关的基础知识。如果你需要一本关于SQL窗口函数的初级读本，我推荐我以前写的一篇文章，<strong class="ll jb"> SQL窗口函数，一段爱恨交加的关系</strong>。</p><div class="mm mn gq gs mo mp"><a rel="noopener follow" target="_blank" href="/sql-window-functions-78593bcabf4"><div class="mq ab fp"><div class="mr ab ms cl cj mt"><h2 class="bd jb gz z fq mu fs ft mv fv fx ja bi translated">SQL窗口函数</h2><div class="mw l"><h3 class="bd b gz z fq mu fs ft mv fv fx dk translated">爱恨交加的关系</h3></div><div class="mx l"><p class="bd b dl z fq mu fs ft mv fv fx dk translated">towardsdatascience.com</p></div></div><div class="my l"><div class="mz l na nb nc my nd kz mp"/></div></div></a></div><h2 id="e8eb" class="ne nf ir bd ng nh ni dn nj nk nl dp nm mf nn no np mg nq nr ns mh nt nu nv ix bi translated">基础知识</h2><p id="b1c8" class="pw-post-body-paragraph li lj ir ll b lm nw kb lo lp nx ke lr mf ny lu lv mg nz ly lz mh oa mc md me ik bi translated">我们可以在任何允许有效表达式的语句或子句中使用<code class="fe mi mj mk ml b">CASE Expression</code>。比如可以在<code class="fe mi mj mk ml b">SELECT</code>、<code class="fe mi mj mk ml b">UPDATE</code>、<code class="fe mi mj mk ml b">DELETE</code>、<code class="fe mi mj mk ml b">SET</code>等语句中，在<code class="fe mi mj mk ml b">PARTITION BY</code>、<code class="fe mi mj mk ml b">ORDER BY</code>、<code class="fe mi mj mk ml b">WHERE</code>、<code class="fe mi mj mk ml b">HAVING</code>等从句中使用<code class="fe mi mj mk ml b">CASE Expression</code>。<strong class="ll jb">利用</strong>语句和SQL窗口函数的能力始于<strong class="ll jb">语法</strong>。我们可以将<code class="fe mi mj mk ml b">CASE Expression</code>包含在<code class="fe mi mj mk ml b">Window_Function()</code>中，如下图所示。</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj ob"><img src="../Images/5a0341854570a4b788e6320acfe31317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JIElZPXCTfqwMY5L9L8_tQ.jpeg"/></div></div><p class="lb lc gk gi gj ld le bd b be z dk translated">语法、窗口函数和CASE表达式</p></figure><p id="9fc7" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">使用窗口功能时，记住<strong class="ll jb">处理顺序事项</strong>很重要。首先执行<code class="fe mi mj mk ml b">OVER()</code>子句，然后执行<code class="fe mi mj mk ml b">PARTITION BY</code>、<code class="fe mi mj mk ml b">ORDER BY</code>和<code class="fe mi mj mk ml b">Window_Function()</code>。<code class="fe mi mj mk ml b">ORDER BY</code>子句确定<code class="fe mi mj mk ml b">Window_Function</code>如何将计算、<code class="fe mi mj mk ml b">AVG(), SUM(), MAX()</code>或<code class="fe mi mj mk ml b">CASE Expression</code>逻辑应用于<code class="fe mi mj mk ml b">PARTITION BY</code>子句中的行。<code class="fe mi mj mk ml b">CASE Expression</code>遍历这些条件，并在第一个条件评估为真时返回一个<strong class="ll jb">单值</strong>。所以，一旦条件为真，它将停止读取并返回结果。如果没有条件为真，它将返回ELSE子句中的值。</p><h2 id="1ef6" class="ne nf ir bd ng nh ni dn nj nk nl dp nm mf nn no np mg nq nr ns mh nt nu nv ix bi translated">入门指南</h2><p id="8bd3" class="pw-post-body-paragraph li lj ir ll b lm nw kb lo lp nx ke lr mf ny lu lv mg nz ly lz mh oa mc md me ik bi translated">重要的是要知道，在Oracle、SQL Lite、SQL Server、MySQL、Postgres和Redshift等数据库平台上有不同的SQL窗口函数实现。<code class="fe mi mj mk ml b">Window_Function()</code>功能中<code class="fe mi mj mk ml b">CASE Expression</code>的数量和支持可能因平台而异。下面的<strong class="ll jb">表</strong>显示了<code class="fe mi mj mk ml b">Window_Function(),</code> <code class="fe mi mj mk ml b">PARTITION BY</code>或<code class="fe mi mj mk ml b">ORDER BY</code>子句是否支持<code class="fe mi mj mk ml b">CASE Expression</code>语法。表格<strong class="ll jb">不包含</strong> <strong class="ll jb">不包含</strong>所有的SQL窗口函数。然而，我列出了一些你可能会遇到的更常见的问题。</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj oc"><img src="../Images/6defe46a30ac08689da2c8a2ff91928c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XfRZfRCWkUMtyotqRX1xXg.jpeg"/></div></div><p class="lb lc gk gi gj ld le bd b be z dk translated">SQL窗口函数</p></figure><p id="f137" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">虽然该表是一个很好的参考，但确定您的数据库平台是否支持case语句的一个更快、更简单的方法是在<code class="fe mi mj mk ml b">Window_Function</code>中使用<code class="fe mi mj mk ml b">case when 1 = 1 then 1 else 0 end</code>，如下图所示。</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj ob"><img src="../Images/e4aba9fc5138ad25d6a696a39fa5a928.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YtLOdCAYL4ZrIyBRZdYSHw.jpeg"/></div></div><p class="lb lc gk gi gj ld le bd b be z dk translated">窗口函数，案例表达式测试</p></figure><p id="9893" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">测试时，我建议分别测试语法的各个部分，以确定SQL平台是否支持该函数。如果查询执行，窗口函数支持<code class="fe mi mj mk ml b">CASE Expression</code>。</p><p id="b015" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">虽然有可能在<code class="fe mi mj mk ml b">PARTITION BY</code>子句中使用<code class="fe mi mj mk ml b">CASE Expression</code>，但我很少在项目中使用<strong class="ll jb"/>。所以，我不在本教程中涉及。话虽如此，我还是很快补充一句，不要让那限制你从<strong class="ll jb">探索</strong>它。您可能会发现它有用的多个实例。所以，继续被<strong class="ll jb">创意</strong>和<strong class="ll jb">推动</strong>可能的极限。在本教程的剩余部分，我们将看看如何在<code class="fe mi mj mk ml b">Window_Function()</code>和<code class="fe mi mj mk ml b">ORDER BY</code>子句中使用<code class="fe mi mj mk ml b">Case Expression</code>。</p><h2 id="feee" class="ne nf ir bd ng nh ni dn nj nk nl dp nm mf nn no np mg nq nr ns mh nt nu nv ix bi translated">我们的数据</h2><p id="d929" class="pw-post-body-paragraph li lj ir ll b lm nw kb lo lp nx ke lr mf ny lu lv mg nz ly lz mh oa mc md me ik bi translated">我们虚构示例中的数据包括每个州的商店收入数据。目的是使用<code class="fe mi mj mk ml b">SUM()</code>窗口函数和<code class="fe mi mj mk ml b">CASE Expression</code>添加三个额外的指标，即调整后的收入、新店收入和州收入。我们想衡量<strong class="ll jb">无销售税</strong>或<strong class="ll jb">新店开业</strong>对一个州的公司收入的影响。我们可以编写<strong class="ll jb">单独的查询</strong>来获得答案，但是嵌套的<code class="fe mi mj mk ml b">CASE Expression</code>是最高效的。在本教程结束时，您将看到如何<strong class="ll jb">添加指标</strong>，并对<code class="fe mi mj mk ml b">CASE Expression</code>进行微小的修改。</p><p id="2b45" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">也就是说，让我们深入研究SQL Server文本编辑器中显示在下面的代码<strong class="ll jb">。对于<strong class="ll jb">调整后的收入，</strong>当<code class="fe mi mj mk ml b">CASE Expression</code>执行且记录没有销售税时，<code class="fe mi mj mk ml b">Sales_Tax = NO</code>，收入为预计收入的95%。</strong></p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj od"><img src="../Images/5047f1207fd11670d08af890f6c96e43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zdOXDGaaNdEAocALj_XEfQ.jpeg"/></div></div></figure><p id="71a8" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">使用<strong class="ll jb">新店收入，</strong>当<code class="fe mi mj mk ml b">CASE Expression</code>执行时，记录是新店，<code class="fe mi mj mk ml b">New_Store = 'YES'</code>，我们计算收入。否则，case语句返回值零。对于<strong class="ll jb">州收入，</strong>当<code class="fe mi mj mk ml b">CASE Expression</code>执行且记录没有销售税时，<code class="fe mi mj mk ml b">Sales_Tax = NO</code>，收入为预计收入的95%。</p><p id="1e14" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">我可以通过修改<code class="fe mi mj mk ml b">CASE Expression</code>来继续创建额外的指标。最后，<code class="fe mi mj mk ml b">Case Support</code>列使用<code class="fe mi mj mk ml b">case when 1 = 1 then 1 else 0 end</code>来测试<code class="fe mi mj mk ml b">Max()</code>窗口函数是否支持SQL Server中的<code class="fe mi mj mk ml b">CASE Expression</code>。成功的查询执行意味着<code class="fe mi mj mk ml b">CASE Expression</code>被支持。<strong class="ll jb">不要担心</strong>填充<code class="fe mi mj mk ml b">Case Support</code>列的值。目标只是确保查询语句运行。</p><h2 id="a6de" class="ne nf ir bd ng nh ni dn nj nk nl dp nm mf nn no np mg nq nr ns mh nt nu nv ix bi translated">排序依据:我们的方案</h2><p id="5edd" class="pw-post-body-paragraph li lj ir ll b lm nw kb lo lp nx ke lr mf ny lu lv mg nz ly lz mh oa mc md me ik bi translated"><code class="fe mi mj mk ml b">ORDER BY</code>条款是<code class="fe mi mj mk ml b">Window_Function()</code>中隐藏的<strong class="ll jb">超能力</strong>。她平常的用法掩盖了她真正的美丽和优雅。理解并掌握她的优点将会打开解决问题的新境界。让我们看一个例子来帮助解释我的意思。</p><p id="1991" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">我们场景中的数据包括一个计算机制造商的计算机销售交易的<strong class="ll jb">估计值</strong>。每年12月，部门销售主管都试图通过与<code class="fe mi mj mk ml b">OPEN_DATE</code>达成交易来增加收入。根据经验，她知道在<strong class="ll jb">6月</strong>日<code class="fe mi mj mk ml b">OPEN_DATE</code>的生意比其他月份更有价值。因此，她向她的数据团队发送了一个请求，要求提供一个列表，让<strong class="ll jb">将6月</strong>的交易排在每个州的最前面。当她收到清单时，她会将它分发给每个州的区域销售经理。数据分析师使用如下所示的SQL逻辑完成请求。</p><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj od"><img src="../Images/b45dc0e97c7d5fbd6a014256315a3512.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D-jmKbeJxCR6qZCNJwpB5g.jpeg"/></div></div></figure><p id="9ab6" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated"><strong class="ll jb">说明</strong>:数据分析师使用<code class="fe mi mj mk ml b"><strong class="ll jb">DENSE_RANK()</strong></code>函数创建每个区域的优先级列表。<code class="fe mi mj mk ml b">OVER()</code>子句创建执行空间。<code class="fe mi mj mk ml b">PARTITION BY</code>子句将<code class="fe mi mj mk ml b">State</code>数据分成不同的组。如果记录的日期在<code class="fe mi mj mk ml b">6/1/2017</code>和<code class="fe mi mj mk ml b">6/30/2017</code>之间，则<code class="fe mi mj mk ml b">CASE Expression</code>返回一个<code class="fe mi mj mk ml b">1</code>，而<code class="fe mi mj mk ml b">ELSE</code>返回一个超出这些日期的<code class="fe mi mj mk ml b">0</code>。<code class="fe mi mj mk ml b">DESC</code>按照从1到0的降序对<code class="fe mi mj mk ml b">CASE</code>表达式结果集进行排序。<code class="fe mi mj mk ml b">DESC</code>将<code class="fe mi mj mk ml b">Estimated_Value</code>从最高到最低排序。结果是一个<code class="fe mi mj mk ml b">priority</code>列，根据<code class="fe mi mj mk ml b">ORDER BY</code>排序，六月份的<code class="fe mi mj mk ml b">OPEN_DATE</code>交易在估计价值中排名最高。</p><h2 id="bdfd" class="ne nf ir bd ng nh ni dn nj nk nl dp nm mf nn no np mg nq nr ns mh nt nu nv ix bi translated">一个关键:慢慢来</h2><p id="d6d2" class="pw-post-body-paragraph li lj ir ll b lm nw kb lo lp nx ke lr mf ny lu lv mg nz ly lz mh oa mc md me ik bi translated">有效使用<code class="fe mi mj mk ml b">Window_Function()</code>和<code class="fe mi mj mk ml b">CASE Expression</code>的一个关键是<strong class="ll jb">花时间</strong>去了解你的数据集。这意味着将样本数据导出到电子表格中。当<code class="fe mi mj mk ml b">Window_Function()</code>执行<code class="fe mi mj mk ml b">CASE Expression</code>时，您可以做笔记或<strong class="ll jb">模拟</strong>预期的结果。一个<code class="fe mi mj mk ml b">Window_Function()</code>和<code class="fe mi mj mk ml b">CASE Expression</code>的组合提供了大量的<strong class="ll jb">动力</strong>，所以如果处理不当很容易死机和烧毁。你可以花上几个小时试图弄懂那些在电子表格中发现的结果。大多数情况下，当我犯了<strong class="ll jb">错误</strong>时，那是因为我<strong class="ll jb">跳过了</strong>这一步。</p><p id="8649" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated">我用<code class="fe mi mj mk ml b">Case Expressions</code>和<code class="fe mi mj mk ml b">Window_Functions()</code>做过一些很神奇的项目。本教程只是触及了无限创造性编码可能性的表面。我希望这些信息能帮助你探索和创造性地解决复杂的问题。继续成长，用<code class="fe mi mj mk ml b">CASE Expressions</code>和<code class="fe mi mj mk ml b">Window_Functions()</code>推动可能的极限。</p><p id="808f" class="pw-post-body-paragraph li lj ir ll b lm ln kb lo lp lq ke lr mf lt lu lv mg lx ly lz mh mb mc md me ik bi translated"><strong class="ll jb"> <em class="lk">分享灵感</em> </strong> <em class="lk">:分享每一个按键和每一课，都让我想起我在Vanguard Jr .高中八年级时的英语和打字老师Reeves女士。她帮助一个笨拙的小男孩相信，只要有足够的纪律、善良和爱，他可以做得更好。不断分享并激励他人变得比他们想象的更伟大。</em></p></div></div>    
</body>
</html>