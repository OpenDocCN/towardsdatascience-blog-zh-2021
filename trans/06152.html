<html>
<head>
<title>Optimize Pandas Memory Usage for Large Datasets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为大型数据集优化Pandas的内存使用</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/optimize-pandas-memory-usage-while-reading-large-datasets-1b047c762c9b?source=collection_archive---------7-----------------------#2021-06-02">https://towardsdatascience.com/optimize-pandas-memory-usage-while-reading-large-datasets-1b047c762c9b?source=collection_archive---------7-----------------------#2021-06-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ab72" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">有效利用数据类型来防止内存崩溃</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/40519f89890e3bd54095156ac505f6bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gBDAfqG8nLnpVhNJx_TmKA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=932180" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/tookapic-1386459/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=932180" rel="noopener ugc nofollow" target="_blank">图卡皮克</a>的图片</p></figure><p id="1906" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Pandas是一个流行的用于数据科学的Python包，因为它为数据探索和可视化提供了强大、富于表现力和灵活的数据结构。但是当处理大规模数据集时，它失败了，因为它不能处理大于内存的数据。</p><p id="af68" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Pandas提供了大量用于数据探索和可视化的API，这使得它在数据科学家社区中更受欢迎。<strong class="lb iu"> <em class="lv"> Dask、modin、Vaex </em> </strong>是一些开源包，可以提升Pandas库的性能，处理大型数据集。</p><p id="f418" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当数据集的大小相对大于内存时，最好使用这样的库，但是当数据集大小相对等于或小于内存大小时，我们可以在读取数据集时优化内存使用。在本文中，我们将讨论如何在使用<code class="fe lw lx ly lz b"><strong class="lb iu">pandas.read_csv()</strong></code>、<code class="fe lw lx ly lz b"><strong class="lb iu">pandas.read_excel() </strong></code>或<code class="fe lw lx ly lz b"><strong class="lb iu">pandas.read_excel()</strong></code>函数加载数据集时优化内存使用。</p><h1 id="6826" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">想法:</h1><p id="fb78" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">数据类型是Python用来理解如何存储和操作数据的内部构造。在使用Pandas <code class="fe lw lx ly lz b">read_</code>函数读取数据集时，默认数据类型被分配给每个要素列。通过观察特征值，Pandas决定数据类型并将其加载到RAM中。</p><p id="6920" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于整数值，Pandas赋值为int64，float64赋值为float 64，string值作为对象赋值。其思想是通过观察最大和最小特征值来降级特征数据类型。熊猫分配的默认数据类型列表有:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/21b90575814aecf5f84fc4c8665939fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*BhPgaBmtlE-eAM9Q4SZ6Mg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(作者图片)，熊猫默认数据类型</p></figure><blockquote class="my"><p id="69c5" class="mz na it bd nb nc nd ne nf ng nh lu dk translated">与int64数据类型相比，int8数据类型的值占用的内存少8倍。</p></blockquote><p id="9409" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">按照下面提到的列表获取每个数据类型的范围:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/0415e88b3e408faa1d37421a56a7c5c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*4eMUql7kfw2Xdg_OCWVAuw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(<a class="ae ky" href="https://jakevdp.github.io/PythonDataScienceHandbook/02.01-understanding-data-types.html" rel="noopener ugc nofollow" target="_blank">来源</a>)、数据类型及其范围</p></figure><h2 id="ab0f" class="no mb it bd mc np nq dn mg nr ns dp mk li nt nu mm lm nv nw mo lq nx ny mq nz bi translated">数据:</h2><p id="2e9a" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">我们将使用来自Kaggle 的<a class="ae ky" href="https://www.kaggle.com/c/nyc-taxi-trip-duration" rel="noopener ugc nofollow" target="_blank">纽约出租车行程持续时间数据集进行进一步演示。用熊猫读取数据，占用467MB。使用Pandas <code class="fe lw lx ly lz b"><strong class="lb iu">.info()</strong></code> <strong class="lb iu"> </strong>函数可以观察默认的数据类型和内存使用情况。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/f00217e2ba9148c1a7c7f5359ac75da1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*CMqRQWDEBpqq0sXl5frWag.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)、分配的默认数据类型和内存使用情况</p></figure><h1 id="ebb7" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">数字特征:</h1><p id="b09f" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">对于所有数值，Pandas将float64数据类型分配给至少有一个float值的特性列，将int64数据类型分配给所有特性值都为整数的特性列。</p><h2 id="1aaf" class="no mb it bd mc np nq dn mg nr ns dp mk li nt nu mm lm nv nw mo lq nx ny mq nz bi translated">整数:</h2><p id="2e16" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">在<a class="ae ky" href="https://www.kaggle.com/c/nyc-taxi-trip-duration" rel="noopener ugc nofollow" target="_blank">New York Taxi Trip Duration dataset</a>中，默认情况下<code class="fe lw lx ly lz b">vendor_id</code>、<code class="fe lw lx ly lz b">passenger_count</code>、<code class="fe lw lx ly lz b">trip_duration </code>列被指定为int64数据类型。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/f00ac5422bf9ff73640cb308f9edffed.png" data-original-src="https://miro.medium.com/v2/resize:fit:816/format:webp/1*OkJXKVURccN5IKOy0Upo0A.png"/></div></figure><p id="07a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过观察特性<code class="fe lw lx ly lz b">vendor_id</code>、<code class="fe lw lx ly lz b">passenger_count</code>的最小值和最大值，可以在int8数据类型中调整，特性<code class="fe lw lx ly lz b">trip_duration</code>可以在int32数据类型中调整。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi gj"><img src="../Images/6cf2a034976813542690818d10f75eee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xKzzJMPM0jDNmNLMzHWl7A.png"/></div></div></figure><p id="2d54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">int64数据类型的<code class="fe lw lx ly lz b">vendor_id</code>、<code class="fe lw lx ly lz b">passenger_count</code>功能的内存使用量分别为11，669，152字节，减少了约88%，为1，458，644字节。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/92f697a8e02c6d2c6c95cab50ad695d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*sD2V-_h9jqh_SLPQmdTF4A.png"/></div></figure><p id="0752" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">int64数据类型的<code class="fe lw lx ly lz b">trip_duration</code>特性的内存使用量分别为11，669，152字节，减少了约50%，为5，834，576字节。</p><h2 id="ac56" class="no mb it bd mc np nq dn mg nr ns dp mk li nt nu mm lm nv nw mo lq nx ny mq nz bi translated">浮动:</h2><p id="0f13" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">在<a class="ae ky" href="https://www.kaggle.com/c/nyc-taxi-trip-duration" rel="noopener ugc nofollow" target="_blank">纽约出租车行程持续时间数据集</a>中，默认情况下<code class="fe lw lx ly lz b">pickup_longitude</code>、<code class="fe lw lx ly lz b">pickup_latitude</code>、<code class="fe lw lx ly lz b">dropoff_longitude</code>、<code class="fe lw lx ly lz b">dropoff_latitude</code>列被指定为float64数据类型。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi od"><img src="../Images/2d409ca139253dd47ba595738ad2e8f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*N1lPZZ2-RCQN3j6dm4fRVg.png"/></div></figure><p id="dc7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过观察上述特性的最小值和最大值，我们可以将数据类型从float64降级到float16。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/f3f415fd706706a427f1f34e333116fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9vwxzVGeZZ9CmQG3CK_wPA.png"/></div></div></figure><p id="dbfa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用float64数据类型的上述特性的内存使用量分别为11，669，152字节，减少了约75%，为2，917，288字节。</p><h1 id="6f0f" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">日期时间:</h1><p id="f072" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">默认情况下，<code class="fe lw lx ly lz b">pickup_datetime</code>、<code class="fe lw lx ly lz b">dropoff_datetime </code>列被指定为对象数据类型，可以降级为日期时间格式。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/32232ec9c470993d1564dbd2dafad7ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*as0W29jI_kcksK6TgC3ujg.png"/></div></figure><p id="9b4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">具有object数据类型的上述功能的内存使用量分别为110，856，944字节，减少了约90%，为11，669，152字节。</p><h1 id="c177" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">分类:</h1><p id="b424" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">熊猫将非数字特征列指定为对象数据类型，该类型可以降级为类别数据类型。通常，非数字特征列具有分类变量，这些变量通常是重复的。例如，性别特征列只有“男性”和“女性”两个类别，这两个类别在所有重新占用空间的实例中反复出现。将其分配给<a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/categorical.html" rel="noopener ugc nofollow" target="_blank">类别</a>数据类型是一种相对紧凑的表示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/fd28cba07f5021fd4a9c8fd0985d4688.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IG0IFvjbscgSYnABRYcmYA.png"/></div></div></figure><p id="8e44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数据类型为object的特性<code class="fe lw lx ly lz b">store_and_fwd_flag</code>的内存使用量为90，435，928字节，减少了约98%，为1，458，848字节。</p><p id="6a07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当任何分类特征的唯一类别数相对小于数据集实例数时，必须将其转换为类别数据类型。</p><h1 id="93d4" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">读取数据时进行类型转换:</h1><p id="4516" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated"><code class="fe lw lx ly lz b">pandas.read_csv</code>带有一个<code class="fe lw lx ly lz b">type </code>参数，该参数接受用户提供的键值格式的数据类型，可以使用该格式代替默认格式。DateTime特性列可以传递给<code class="fe lw lx ly lz b">parse_dates</code>参数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/65aa1097962ba0e3786085f9e698e744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zPHC-EUPditBUDb3ZY8big.png"/></div></div></figure><blockquote class="oi oj ok"><p id="7017" class="kz la lv lb b lc ld ju le lf lg jx lh ol lj lk ll om ln lo lp on lr ls lt lu im bi translated">使用默认数据类型读取相同的<a class="ae ky" href="https://www.kaggle.com/c/nyc-taxi-trip-duration" rel="noopener ugc nofollow" target="_blank">纽约出租车行程持续时间数据集</a>使用了427MB内存。在类型转换之后，内存使用减少了大约70%,只有135MB。</p></blockquote><h1 id="1acb" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">结论:</h1><p id="3ae2" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">本文讨论的类型转换技术可以在一定程度上减少Pandas read函数对数据的内存占用。如果数据集的大小与RAM相比非常大，那么优化数据类型可能没有帮助。对于如此大的数据集，必须尝试并行化库，如Dask、Vaex、Modin。</p><p id="acb8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了更好的理解，请跟随我的一些关于扩大熊猫环境的文章:</p><ul class=""><li id="ea0d" class="oo op it lb b lc ld lf lg li oq lm or lq os lu ot ou ov ow bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/4-libraries-that-can-parallelize-the-existing-pandas-ecosystem-f46e5a257809"> <strong class="lb iu"> 4个可以并行化现有熊猫生态系统的库</strong> </a></li><li id="4199" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/how-dask-accelerates-pandas-ecosystem-9c175062f409"><strong class="lb iu">Dask如何加速熊猫生态系统？</strong>T15】</a></li><li id="50a6" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/process-dataset-with-200-million-rows-using-vaex-ad4839710d3b"> <strong class="lb iu">使用Vaex </strong> </a>处理2亿行数据集</li><li id="e3a2" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/speed-up-your-pandas-workflow-by-changing-a-single-line-of-code-11dfd85efcfb"> <strong class="lb iu">通过改变一行代码</strong> </a>来加速你的熊猫工作流程</li></ul><h1 id="5391" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">参考资料:</h1><p id="69ab" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">[1]熊猫文档:<a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/reference/io.html" rel="noopener ugc nofollow" target="_blank">https://Pandas . pydata . org/Pandas-docs/stable/reference/io . html</a></p><blockquote class="my"><p id="5a31" class="mz na it bd nb nc pc pd pe pf pg lu dk translated">感谢您的阅读</p></blockquote></div></div>    
</body>
</html>