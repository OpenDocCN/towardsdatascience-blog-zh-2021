<html>
<head>
<title>Dealing with Long Running Jupyter Notebooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">处理长时间运行的Jupyter笔记本</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/dealing-with-long-running-jupyter-notebooks-83ab7fca7692?source=collection_archive---------35-----------------------#2021-07-15">https://towardsdatascience.com/dealing-with-long-running-jupyter-notebooks-83ab7fca7692?source=collection_archive---------35-----------------------#2021-07-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="eb50" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">当您的浏览器与Jupyter笔记本断开连接时，这是非常令人沮丧的！</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9a438444334c1fa5060f550d5309afd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E34R89ZjbN9He9of"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">内森·杜姆劳在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="eca1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" href="https://www.saturncloud.io" rel="noopener ugc nofollow" target="_blank">Saturn Cloud，我们管理着一个数据科学平台</a>，该平台提供Jupyter笔记本、Dask集群以及部署模型、仪表盘和作业的方式。因此，我们经常帮助客户对他们的笔记本电脑进行故障诊断，网络断开是一个常见问题。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="a56c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已经有很多客户在为长时间运行的Jupyter笔记本而苦恼——那些需要几个小时或更长时间才能运行的笔记本。他们经常来找我们，因为这些长时间运行的笔记本电脑在某个时候会失去服务器和浏览器之间的连接，这在云服务中很常见。通常云服务会正常地重新连接，不会有任何问题，但是在Jupyter的情况下，如果连接丢失，那么Jupyter将停止保存任何输出。Jupyter笔记本将所有状态存储在浏览器中，这意味着如果运行代码的服务器和查看代码的浏览器之间出现连接问题，笔记本的状态就会丢失。</p><p id="a3c3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们客户的长时间运行的代码中有一个错误，并且连接曾经中断，那么用户就不能看到代码的输出和它所创建的错误消息。试图在没有输出的情况下调试这些模型是徒劳的。在本地使用Jupyter时这不是问题，因为计算机与自身的连接是无限稳定的，但在云中工作时这是一个问题。</p><h1 id="5022" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">背景</h1><p id="a221" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Jupyter笔记本将所有状态存储在浏览器中，因此需要持续的网络连接。这是一个众所周知的设计问题，有许多含义。虽然网络问题不会导致笔记本中的代码停止执行，但它会影响输出保存到笔记本的方式。</p><p id="65e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Jupyter笔记本的流程是:</p><ul class=""><li id="0854" class="mw mx iq ky b kz la lc ld lf my lj mz ln na lr nb nc nd ne bi translated">服务器将输出推送到您的浏览器。</li><li id="9907" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">您的浏览器将其添加到笔记本对象中(并将其呈现到屏幕上)。</li><li id="1007" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">您的浏览器会将笔记本保存回服务器。</li></ul><p id="f32e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在网络切断的情况下，该流中断，并且没有输出被保存。长期的解决方案是对Jupyter本身进行修改，以处理间歇性连接，这是一个非常活跃的讨论领域。目前还没有将它添加到开源Jupyter的时间表。</p><p id="3587" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，有一个短期战略。</p><h1 id="c02d" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">解决办法</h1><p id="75cd" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们只需少量代码就可以调整Jupyter，使其将输出直接保存到服务器上的一个文件中。通过这样做，即使网络连接中断，服务器仍会存储输出。这并不完美——在理想的情况下，这种输出仍然会出现在笔记本本身中，但是将它们存储在某个地方而不是丢失是一种改进。将这段代码放在您长期运行的笔记本的顶部:</p><p id="9bf3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在你的笔记本顶部执行。<em class="nk"> TADA！</em>现在，当您运行笔记本电脑时，所有输出都将镜像到<code class="fe nl nm nn no b">data.log</code>平面文件中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/ccd9e6fcec29587200150dacf9d13b95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*N5R5sbGIbaMeOPQD.jpg"/></div></div></figure><p id="0ea6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">工作原理:</strong>在Jupyter笔记本中，普通的<code class="fe nl nm nn no b">stdout</code>和<code class="fe nl nm nn no b">stderr</code>文件对象被替换为<code class="fe nl nm nn no b">ipykernel.iostream.OutStream</code>对象(这就是它们在浏览器中的显示方式)。这个对象有一个echo对象，默认为可以传播输出的<code class="fe nl nm nn no b">None</code>。因此，第一组代码行粘贴了一个Python文件对象来代替echo，所有普通的<code class="fe nl nm nn no b">stdout</code>和<code class="fe nl nm nn no b">stderr</code>现在也被复制到磁盘上。异常由python日志记录系统处理。在默认配置中，它不输出到<code class="fe nl nm nn no b">stdout</code>或<code class="fe nl nm nn no b">stderr</code>，因此第二组代码行对其进行了修补，并设置了log leve。</p><h1 id="0997" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="ec6e" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">有了这个解决方案，长时间运行Jupyter笔记本电脑的最大痛苦就不复存在了。也就是说，在aat Saturn，我们通常建议使用更好的硬件(GPU)或并行化(Dask ),以避免您的笔记本电脑需要等待10个小时才能运行。然而，如果您的问题是不可并行化的，这是一个合理的变通方法。然而，如果<strong class="ky ir">您不知道如何实现并行化，但希望您做到了</strong>，您应该告诉我们！我们真的很擅长！</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="9133" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">声明:我是<a class="ae kv" href="https://www.saturncloud.io/s/home/" rel="noopener ugc nofollow" target="_blank">土星云</a>的CTO。我们让您的团队轻松连接云资源。想用Jupyter和Dask？部署模型、仪表板或作业？在笔记本电脑或4 TB Jupyter实例上工作？完全透明地了解谁在使用哪些云资源？我们做所有这些，甚至更多。</p><p id="b21e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nk">原载于2021年7月15日</em><a class="ae kv" href="https://saturncloud.io/blog/long-running-notebooks/" rel="noopener ugc nofollow" target="_blank"><em class="nk">https://Saturn cloud . io</em></a><em class="nk">。</em></p></div></div>    
</body>
</html>