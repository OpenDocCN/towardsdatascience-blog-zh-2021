<html>
<head>
<title>Streaming to Apple Home with a custom AI layer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过自定义人工智能层流式传输到Apple Home</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/streaming-to-apple-home-with-a-custom-ai-layer-b8ccebfc09?source=collection_archive---------30-----------------------#2021-09-09">https://towardsdatascience.com/streaming-to-apple-home-with-a-custom-ai-layer-b8ccebfc09?source=collection_archive---------30-----------------------#2021-09-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/1d3f247aeb4b56416ed3bab24ccc4184.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pD4mpTelEgmjTqDd"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">由<a class="ae jd" href="https://unsplash.com/@mrmarkdejong?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马克·德容</a>在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><div class=""/><div class=""><h2 id="b73c" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">如何将旧网络摄像头用作现代安全摄像头</h2></div><h1 id="79f8" class="kv kw jg bd kx ky kz la lb lc ld le lf km lg kn lh kp li kq lj ks lk kt ll lm bi translated">介绍</h1><p id="8934" class="pw-post-body-paragraph ln lo jg lp b lq lr kh ls lt lu kk lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">家庭自动化系统如今变得越来越受欢迎。智能家居中可以实现的一个功能是安全摄像头。</p><p id="1a0d" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我选择不花钱买一个全新的摄像头，而是使用一个简单的网络摄像头，并将其传输到远程控制应用程序。</p><p id="eecd" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">有趣的是，使用这种<strong class="lp jh">定制</strong>解决方案，可以很容易地在图像上添加<strong class="lp jh">层</strong>信息<strong class="lp jh">，并且对于我们数据科学家来说，限制是天空(或相机分辨率)。</strong></p><h1 id="13c2" class="kv kw jg bd kx ky kz la lb lc ld le lf km lg kn lh kp li kq lj ks lk kt ll lm bi translated">设置</h1><p id="b152" class="pw-post-body-paragraph ln lo jg lp b lq lr kh ls lt lu kk lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在这里，我将描述一个简单的设置，一个网络摄像头和一个RaspberryPi连接到一个<a class="ae jd" href="https://software.intel.com/content/www/us/en/develop/hardware/neural-compute-stick.html" rel="noopener ugc nofollow" target="_blank">神经计算棒</a>。</p><p id="84c7" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">它们可以组装在一起，构建一个集成了人工智能的网络服务器。硬件连接很简单，人们只需注意将NCS连接到Raspberry的<em class="mo"> USB3.0 </em>端口，即可获得<strong class="lp jh">更好的性能</strong>。</p><p id="3589" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">网络摄像头记录视频，Pi获取帧，并使用计算棒<strong class="lp jh">在它们上面添加一些信息</strong>。</p><figure class="mq mr ms mt gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mp"><img src="../Images/6383af09969f2c9844a4ab55bf6c2873.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kYBjmJ9E4UWH5ezOWToeLA.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">设置。图片作者。</p></figure><h1 id="6535" class="kv kw jg bd kx ky kz la lb lc ld le lf km lg kn lh kp li kq lj ks lk kt ll lm bi translated">流式传输帧:网络服务器</h1><p id="616c" class="pw-post-body-paragraph ln lo jg lp b lq lr kh ls lt lu kk lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">我们需要发送帧，为此我们将使用一个简单的web服务器，通过http将ffmpeg兼容的帧发送到给定的端口。</p><p id="3b9f" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">webserver 的核心在下面的代码中:每次调用enerator时，捕捉一个帧，调用一个模型并提供结果图像，这一切都非常快。</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="fc25" class="mz kw jg mv b gy na nb l nc nd">def generator():    <br/>    import io<br/>    global model<br/>    cap = cv2.VideoCapture(0)<br/>    while True:<br/>        ret, frame = cap.read()<br/>        frame = model.process(frame)<br/>        encode_return_code, image_buffer = cv2.imencode('.jpg', frame)<br/>        io_buf = io.BytesIO(image_buffer)        yield (b'--frame\r\n'+               b'Content-Type: image/jpeg\r\n\r\n' + io_buf.read() + b'\r\n')</span><span id="c907" class="mz kw jg mv b gy ne nb l nc nd">@app.route("/video")<br/>def video():<br/>    return Response(generator(), mimetype='multipart/x-mixed-replace; boundary=frame')</span></pre><p id="1168" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">使用<a class="ae jd" href="https://flask.palletsprojects.com/en/2.0.x/" rel="noopener ugc nofollow" target="_blank"> Flask </a>和<a class="ae jd" href="https://flask.palletsprojects.com/en/2.0.x/" rel="noopener ugc nofollow" target="_blank"> OpenCV </a>可以从通过USB连接到RPi的摄像机获取视频帧序列，然后将它们流式传输到可以使用许多不同工具访问的网页。</p><h1 id="66dd" class="kv kw jg bd kx ky kz la lb lc ld le lf km lg kn lh kp li kq lj ks lk kt ll lm bi translated">人工智能层</h1><p id="d061" class="pw-post-body-paragraph ln lo jg lp b lq lr kh ls lt lu kk lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">当捕捉到帧时，可以使用图像分类模型对其进行解析，并将关于图像中存在哪个对象的信息添加到帧中。</p><p id="e2a0" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">使用openVINO，分类过程将像</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="f435" class="mz kw jg mv b gy na nb l nc nd">exec_net.infer(inputs={self.input_blob: images})</span></pre><p id="c840" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">另一个更有趣的可能性是使用YOLO模型。经典方法将模型应用于多个位置和尺度的图像。图像的高分区域被认为是检测。</p><p id="c29e" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">YOLO采用了一种完全不同的方法。它将一个<strong class="lp jh">单个</strong>神经网络应用于整个图像。该网络将图像分成多个区域，并预测每个区域的边界框和概率。因此，<strong class="lp jh">可以非常高效地识别一幅<strong class="lp jh">图像</strong>中的多个物体</strong>。</p><p id="63b3" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在这里，我描述了两个例子:一个<strong class="lp jh">分类器</strong>和<strong class="lp jh"> YOLO </strong>，但是，当然你也可以运行任何模型，只要简单地<a class="ae jd" rel="noopener" target="_blank" href="/convert-a-tensorflow2-model-to-openvino-c498f526c60b">将它转换成与神经计算棒</a>兼容的格式。</p><h1 id="e3b4" class="kv kw jg bd kx ky kz la lb lc ld le lf km lg kn lh kp li kq lj ks lk kt ll lm bi translated">向移动设备发送视频:Homebridge</h1><p id="e455" class="pw-post-body-paragraph ln lo jg lp b lq lr kh ls lt lu kk lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">一个人有了视频帧，就有可能<strong class="lp jh">将它们流式传输到其他设备</strong>，我最喜欢的方法是将其流式传输到专门用于家庭管理的应用程序，这样它们最终可以与其他设备集成。在这种情况下，我使用了<strong class="lp jh"> Homebridge </strong>。</p><p id="c77e" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">Homebridge是一个非常强大的工具，可以连接各种设备，甚至是定制设备，我们很快就会看到苹果家庭基础设施。</p><div class="ip iq gp gr ir nf"><a href="https://homebridge.io" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd jh gy z fp nk fr fs nl fu fw jf bi translated">住宅桥</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">Homebridge为您的非HomeKit智能家居设备增加了HomeKit支持。</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">homebridge.io</p></div></div></div></a></div><h2 id="50b2" class="mz kw jg bd kx no np dn lb nq nr dp lf lw ns nt lh ma nu nv lj me nw nx ll ny bi translated">ffmpeg插件</h2><p id="7075" class="pw-post-body-paragraph ln lo jg lp b lq lr kh ls lt lu kk lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在这个例子中，我选择了一个使用<a class="ae jd" href="https://ffmpeg.org" rel="noopener ugc nofollow" target="_blank"> ffmpeg </a>来读取这些帧的插件。</p><div class="ip iq gp gr ir nf"><a href="https://github.com/Sunoo/homebridge-camera-ffmpeg" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd jh gy z fp nk fr fs nl fu fw jf bi translated">Sunoo/homebridge-camera-ffmpeg</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">Homebridge插件提供基于FFmpeg的相机支持在安装这个插件之前，你应该安装Homebridge…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">github.com</p></div></div><div class="nz l"><div class="oa l ob oc od nz oe ix nf"/></div></div></a></div><p id="cd4b" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这应该被配置为从端口<em class="mo"> :5000 </em>(或者配置在Flask中的端口)上的<em class="mo">本地主机</em>读取帧。也可以为设备和其他设置选择名称。</p><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="bcaf" class="mz kw jg mv b gy na nb l nc nd">"accessories": [<br/>{<br/>            "name": "Camera FFmpeg",<br/>            "cameras": [<br/>                {<br/>                    "name": "raspiwebcam",<br/>                    "videoConfig": {<br/>                        "source": "-f mjpeg -i <a class="ae jd" href="http://localhost:5000/video" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/video</a>"<br/>                    }<br/>                }<br/>            ],<br/>            "platform": "Camera-ffmpeg"<br/>        }<br/>    ]</span></pre><h1 id="7eef" class="kv kw jg bd kx ky kz la lb lc ld le lf km lg kn lh kp li kq lj ks lk kt ll lm bi translated">苹果Home应用</h1><p id="a0e0" class="pw-post-body-paragraph ln lo jg lp b lq lr kh ls lt lu kk lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">当<strong class="lp jh"> Homebridge </strong>设置好后，服务器<strong class="lp jh">启动并运行</strong>我们就可以在<a class="ae jd" href="https://www.apple.com/ios/home/" rel="noopener ugc nofollow" target="_blank"> Apple Home app </a>中检查来自网络摄像头的图像了。</p><p id="cb13" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">正如你在下面的截图中所看到的(我知道来自网络摄像头的图像质量很差)</p><p id="b3b3" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><a class="ae jd" href="https://github.com/fvalle1/ai_server/blob/master/server/classify.py" rel="noopener ugc nofollow" target="_blank">基于初始的图像分类器</a>可以添加关于模型当前正在看到哪个对象的信息。</p><figure class="mq mr ms mt gt is gh gi paragraph-image"><div class="gh gi of"><img src="../Images/aba2a23c49ed1056c7060c6d7e02077f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*mjQU1mUr5HVz7WsIEOYw3g.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">苹果首页截图。图片作者。</p></figure><h1 id="02f1" class="kv kw jg bd kx ky kz la lb lc ld le lf km lg kn lh kp li kq lj ks lk kt ll lm bi translated">跑步yolo</h1><div class="ip iq gp gr ir nf"><a href="https://pjreddie.com/darknet/yolo/" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd jh gy z fp nk fr fs nl fu fw jf bi translated">YOLO:实时目标检测</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">你只看一次(YOLO)是一个最先进的，实时对象检测系统。在Pascal Titan X上，它处理…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">pjreddie.com</p></div></div><div class="nz l"><div class="og l ob oc od nz oe ix nf"/></div></div></a></div><p id="333f" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">一个简单的脚本可以用来处理帧和检测帧上的物体</p><figure class="mq mr ms mt gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oh"><img src="../Images/1af293848e3504a1290334e81ac1231b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nGpjJHQWor6CdiNVV6A3RQ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">苹果主页上的yolo。图片作者。</p></figure><p id="b771" class="pw-post-body-paragraph ln lo jg lp b lq mj kh ls lt mk kk lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">现在我们已经准备好在相机上捕捉<a class="ae jd" href="https://twitter.com/search?q=%23CaughtOnNestCam&amp;src=typed_query" rel="noopener ugc nofollow" target="_blank">每一个有趣和可爱的东西</a>！</p><h1 id="58d7" class="kv kw jg bd kx ky kz la lb lc ld le lf km lg kn lh kp li kq lj ks lk kt ll lm bi translated">密码</h1><p id="9c46" class="pw-post-body-paragraph ln lo jg lp b lq lr kh ls lt lu kk lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">https://github.com/fvalle1/ai_server/tree/raspbian的<a class="ae jd" href="https://github.com/fvalle1/ai_server/tree/raspbian" rel="noopener ugc nofollow" target="_blank">是一个仓库，里面有让所有这些正常工作所需的所有脚本和代码片段。</a></p></div></div>    
</body>
</html>