<html>
<head>
<title>Data Processing and Analysis: pandas vs SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据处理和分析:熊猫vs SQL</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-processing-and-analysis-pandas-vs-sql-66b4f75db54d?source=collection_archive---------45-----------------------#2021-05-25">https://towardsdatascience.com/data-processing-and-analysis-pandas-vs-sql-66b4f75db54d?source=collection_archive---------45-----------------------#2021-05-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/9d3c521ad7330ae1fe6064b16fa60ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*XZPKKd8r8XcRYRTdB8j2VA.jpeg"/></div><p class="iv iw gj gh gi ix iy bd b be z dk translated">照片由伊戈尔·沙巴林拍摄</p></figure><div class=""/><p id="ddc2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">SQL是许多数据库中访问和操作数据的主要工具。它设计用于处理存储在数据库容器(称为表)中的表格数据，允许您有效地访问、分组、合并和分析不同表中的数据。反过来，Pandas库被设计为高效地对加载到Python脚本中的数据集执行所有这些操作。所以，pandas DataFrame是一个类似于SQL表的二维数据结构。</p><p id="5d89" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文提供了pandas和MySQL示例，说明了如何使用这些工具来组合数据集，以及如何对其中的数据进行分组、聚合和分析。</p><h1 id="fb26" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">准备您的工作环境</h1><p id="ecb5" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">为了遵循本文提供的示例，请确保在Python环境中安装了pandas库。如果您还没有它，最简单的安装方法是使用pip命令:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="d8ca" class="mi kx jb me b gy mj mk l ml mm">pip install pandas</span></pre><p id="a52d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要使用SQL示例，您需要访问MySQL数据库。有关如何在您的系统中安装它的详细信息，请参考《MySQL 8.0参考手册》中位于<a class="ae mn" href="https://dev.mysql.com/doc/refman/8.0/en/installing.html" rel="noopener ugc nofollow" target="_blank">https://dev.mysql.com/doc/refman/8.0/en/installing.html</a>的“安装和升级MySQL”一章，或MySQL未来版本的相应章节。</p><p id="d5b8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦有了MySQL数据库，就需要在其中创建几个示例表。为此，您可以在mysql &gt;提示符下执行以下SQL语句:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="0fbb" class="mi kx jb me b gy mj mk l ml mm">CREATE DATABASE mydb;<br/>USE mydb;</span><span id="66ce" class="mi kx jb me b gy mo mk l ml mm">CREATE TABLE stocks(<br/> dt DATE,<br/> symbol CHAR(10),<br/> price DECIMAL(10, 4)<br/>);</span></pre><p id="0647" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，您需要安装一个Python驱动程序，以便从Python内部与MySQL服务器进行通信。这可以使用pip命令来完成，如下所示:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="293c" class="mi kx jb me b gy mj mk l ml mm">pip install mysql-connector-python</span></pre><h1 id="77b8" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">获取数据</h1><p id="fbc2" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">要继续下去，您需要获得一些数据来处理。许多流行API的Python包装器将数据作为pandas对象返回。在下面的代码片段中，您通过yfinance Python包装器调用Yahoo Finance API。特别是，您获得了几个报价机的股票价格数据。数据以熊猫数据帧的形式返回，将在文章示例中使用:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="139e" class="mi kx jb me b gy mj mk l ml mm">import pandas as pd<br/>import yfinance as yf<br/>stocks = pd.DataFrame()<br/>symbols = ['MSFT','AAPL','TSLA','ORCL','AMZN']<br/>for symbol in symbols:<br/> tkr = yf.Ticker(symbol)<br/> hist = tkr.history(period='5d')<br/> hist[‘Symbol’]=symbol<br/> stocks = stocks.append(hist[['Symbol', 'Close']].rename(columns={'Close: 'Price'}))</span></pre><p id="ab26" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，您可能希望将相同的数据插入到MySQL数据库表中，以便可以对相同的数据集执行SQL示例。但是，在这样做之前，您需要执行一些转换:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="a408" class="mi kx jb me b gy mj mk l ml mm">#Preparing the data <br/>stocks = stocks.reset_index().rename(columns={'Date': 'Dt'})<br/>stocks[‘Dt’] = stocks[‘Dt’].astype(str)<br/>s = stocks.values.tolist()</span></pre><p id="4f62" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下面的代码片段中，您将数据插入数据库:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="1984" class="mi kx jb me b gy mj mk l ml mm">#Inserting the data into the database<br/>import mysql.connector<br/>from mysql.connector import errorcode<br/>try:<br/> cnx = mysql.connector.connect(user='root', password='pswd',<br/> host='127.0.0.1',<br/> database=’mydb’)<br/> cursor = cnx.cursor()<br/> query_add_stocks = """INSERT INTO stocks (dt, symbol, price) <br/> VALUES (STR_TO_DATE(REPLACE( %s, '-', '/' ), '%Y/%m/%d'), %s, %s)"""<br/> #inserting the stock rows<br/> cursor.executemany(query_add_stocks, s)<br/> cnx.commit() <br/>except mysql.connector.Error as err:<br/> print("Error-Code:", err.errno)<br/> print("Error-Message: {}".format(err.msg))<br/>finally:<br/> cursor.close()<br/> cnx.close()</span></pre><h1 id="3fc7" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">对数据集执行分组</h1><p id="f8e1" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">使用DataFrame.groupby()方法，您可以将DataFrame的数据拆分为具有一个或多个列的匹配值的组，从而允许您对每个组应用聚合函数。在下面的示例中，您按股票数据框架中的符号列进行分组，然后对形成的组中的符号列应用sum()聚合函数:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="59e4" class="mi kx jb me b gy mj mk l ml mm">print(stocks.groupby('Symbol').mean().round(2))</span></pre><p id="52b2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果，您应该会看到类似这样的内容(当然，您会得到不同的数字):</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="6852" class="mi kx jb me b gy mj mk l ml mm">Price<br/>     Symbol <br/>AAPL 125.88<br/>AMZN 3231.97<br/>MSFT 245.61<br/>ORCL 78.91<br/>TSLA 583.09</span></pre><p id="55c7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果使用以下SQL查询请求数据库中的股票表，也可以得到相同的结果:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="60ce" class="mi kx jb me b gy mj mk l ml mm">SELECT<br/> symbol,<br/> ROUND(AVG(price),2) TOTAL_mean<br/>FROM<br/> stocks<br/>GROUP BY<br/> symbol<br/>ORDER BY <br/> symbol;</span></pre><p id="c6e3" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是输出:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="f03d" class="mi kx jb me b gy mj mk l ml mm">+ — — — — + — — — — — — +<br/>| symbol | TOTAL_mean |<br/>+ — — — — + — — — — — — +<br/>| AAPL | 125.88 |<br/>| AMZN | 3231.97 |<br/>| MSFT | 245.61 |<br/>| ORCL | 78.91 |<br/>| TSLA | 583.09 |<br/>+ — — — — + — — — — — — +<br/>5 rows in set (0.00 sec)</span></pre><h1 id="1225" class="kw kx jb bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">分析数据处理</h1><p id="c898" class="pw-post-body-paragraph jy jz jb ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">要执行您的分析，您可能需要执行比调用单个聚合函数更复杂的数据聚合操作，如前面的示例所示。继续我们的股票价格数据集，假设您想要确定波动性最高和最低的股票。首先，您需要通过ticker对数据集中的数据进行分组。然后，您可以使用lambda机制将几个聚合函数应用于groupby对象:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="cceb" class="mi kx jb me b gy mj mk l ml mm">print(stocks.groupby("Symbol").agg({(‘vol’, lambda x: 100*(x.max() — x.min())/x.mean())}).round(2))</span></pre><p id="13fb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以你得到了每个股票的波动性:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="67aa" class="mi kx jb me b gy mj mk l ml mm">Price<br/>     vol<br/>Symbol <br/>AAPL 2.08<br/>AMZN 1.38<br/>MSFT 3.36<br/>ORCL 0.87<br/>TSLA 7.37</span></pre><p id="9454" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于SQL，您可以使用以下SELECT语句获得相同的结果:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="16db" class="mi kx jb me b gy mj mk l ml mm">SELECT<br/> symbol,<br/> ROUND(100*((MAX(price) — MIN(price))/AVG(price)),2) volatility<br/>FROM<br/> stocks<br/>GROUP BY<br/> symbol<br/>ORDER BY<br/> symbol;</span></pre><p id="d23b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是输出:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="9bb2" class="mi kx jb me b gy mj mk l ml mm">+ — — — — + — — — — — — +<br/>| symbol | volatility |<br/>+ — — — — + — — — — — — +<br/>| AAPL | 2.08 |<br/>| AMZN | 1.38 |<br/>| MSFT | 3.36 |<br/>| ORCL | 0.87 |<br/>| TSLA | 7.37 |<br/>+ — — — — + — — — — — — +<br/>5 rows in set (0.00 sec)</span></pre><p id="824c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有关更多示例，请查看我最近在Oracle Connect上发表的文章<a class="ae mn" href="https://www.oracle.com/news/connect/run-sql-data-queries-with-pandas.html" rel="noopener ugc nofollow" target="_blank">如何使用pandas运行SQL数据查询</a>和<a class="ae mn" href="https://www.oracle.com/news/connect/using-python-pandas-time-series-data-analysis.html" rel="noopener ugc nofollow" target="_blank">使用Python和pandas编程滚动窗口数据分析</a>。</p></div></div>    
</body>
</html>