<html>
<head>
<title>Integrating Trino and Apache Ranger</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集成Trino和Apache Ranger</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/integrating-trino-and-apache-ranger-b808f6b96ad8?source=collection_archive---------6-----------------------#2021-09-27">https://towardsdatascience.com/integrating-trino-and-apache-ranger-b808f6b96ad8?source=collection_archive---------6-----------------------#2021-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fdc6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何为数据安全配置Apache Ranger和Trino。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5b807cc7f82f2e8fb0f781e889e3ea74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-ytswvVrCNbU6XR9"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@flyd2069?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">飞:D </a>上<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">的Unsplash </a></p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kw"><img src="../Images/40f8d121b0a039cee4639c6bb8a4c0dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4acldmX1IGkzOzzJSj0vcg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片由作者创作，灵感来自分别为Trino和Apache Software Foundation商标的徽标</p></figure><h1 id="e259" class="kx ky iq bd kz la lb lc ld le lf lg lh jw li jx lj jz lk ka ll kc lm kd ln lo bi translated">第一部分:概念和想法</h1><h2 id="1c73" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">背景</h2><p id="7116" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">随着对数据需求的日益增长，企业对数据安全性的要求也在不断提高。在Hadoop生态系统中，Apache Ranger是一个很有前途的数据安全框架，拥有大量插件，如HDFS、Solr、Yarn、Kafka、Hive等。<a class="ae kv" href="https://cwiki.apache.org/confluence/display/RANGER/Apache+Ranger+2.1.0+-+Release+Notes" rel="noopener ugc nofollow" target="_blank"> Apache Ranger在版本2.1.0 </a>中为prestosql添加了一个插件，但最近<a class="ae kv" href="https://trino.io/blog/2020/12/27/announcing-trino.html" rel="noopener ugc nofollow" target="_blank"> PrestoSQL被更名为Trino </a>，这破坏了Apache Ranger的PrestoSQL插件。</p><p id="4937" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">我已经提交了这个问题的补丁，这里已经有一个公开的JIRA问题<a class="ae kv" href="https://issues.apache.org/jira/browse/RANGER-3182" rel="noopener ugc nofollow" target="_blank">了</a>但是这不会阻止我们将Trino与Apache Ranger集成。对于本教程，我已经用Trino插件构建了Apache Ranger 2.1.0。如果你想从包括trino插件的源代码中构建Apache Ranger，你可以参考分支<code class="fe nc nd ne nf b">ranger-2.1.0-trino</code>上的<a class="ae kv" href="https://github.com/aakashnand/ranger/tree/ranger-2.1.0-trino" rel="noopener ugc nofollow" target="_blank">这个</a> GitHub库，出于本教程的目的，我们将<a class="ae kv" href="https://github.com/aakashnand/trino-ranger-demo" rel="noopener ugc nofollow" target="_blank">这个</a> Github库。</p><blockquote class="ng nh ni"><p id="b049" class="me mf nj mg b mh mx jr mj mk my ju mm nk mz mo mp nl na mr ms nm nb mu mv mw ij bi translated">更新时间:2022年5月20日</p><p id="0dfa" class="me mf nj mg b mh mx jr mj mk my ju mm nk mz mo mp nl na mr ms nm nb mu mv mw ij bi translated">Trino插件现已在ranger资源库中正式发布，发布于Apache Ranger-2.3<a class="ae kv" href="https://github.com/apache/ranger/tree/ranger-2.3" rel="noopener ugc nofollow" target="_blank">https://github.com/apache/ranger/tree/ranger-2.3</a></p></blockquote><h2 id="9ce1" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">组件和关键思想介绍</h2><p id="3f1e" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">阿帕奇游侠有三个关键部件<code class="fe nc nd ne nf b">ranger-admin</code>、<code class="fe nc nd ne nf b">ranger-usersync</code>和<code class="fe nc nd ne nf b">ranger-audit</code>。让我们了解一下这些组件。</p><p id="2dcb" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated"><em class="nj">注意:</em> <em class="nj">配置</em> <code class="fe nc nd ne nf b"><em class="nj">ranger-usersync</em></code> <em class="nj">超出了本教程的范围，我们不会在本教程中使用任何</em> <code class="fe nc nd ne nf b"><em class="nj">usersync</em></code> <em class="nj">组件。</em></p><h2 id="b133" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">管理员管理</h2><p id="172f" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">Ranger管理组件是一个UI组件，使用它我们可以为不同的访问级别创建策略。Ranger Admin需要一个后端数据库，在我们的例子中，我们使用Postgres作为Ranger Admin UI的后端数据库。</p><h2 id="b827" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">管理员审计</h2><p id="9999" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">Ranger审计组件收集并显示资源的每个访问事件的日志。Ranger支持两种审计方式，<code class="fe nc nd ne nf b">solr</code>和<code class="fe nc nd ne nf b">elasticsearch</code>。我们将使用<code class="fe nc nd ne nf b">elasticsearch</code>来存储ranger审计日志，这些日志也将显示在Ranger审计UI中。</p><h2 id="3686" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">特里诺</h2><p id="3572" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">Trino是一个快速分布式查询引擎。可以连接多个数据源，如<code class="fe nc nd ne nf b">hive</code>、<code class="fe nc nd ne nf b">postgres</code>、<code class="fe nc nd ne nf b">oracle</code>等。你可以在官方文档<a class="ae kv" href="https://trino.io/docs/current/" rel="noopener ugc nofollow" target="_blank">这里</a>阅读更多关于Trino和Trino连接器的信息。对于本教程，我们将使用默认目录<code class="fe nc nd ne nf b">tpch</code>，它带有虚拟数据。</p><h2 id="41ea" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">trino-Ranger-插件</h2><p id="72e7" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">阿帕奇游侠支持许多插件，如HDFS，蜂巢，纱线，特里诺等。每个插件都需要在运行该进程的主机上进行配置。Trino-Ranger-Plugin是一个组件，它将与Ranger Admin通信，以检查和下载访问策略，然后这些策略将与Trino服务器同步。下载的策略作为JSON文件存储在Trino服务器上，可以在路径<code class="fe nc nd ne nf b">/etc/ranger/&lt;service-name&gt;/policycache</code>下找到，因此在这种情况下，策略路径是<code class="fe nc nd ne nf b">/etc/ranger/trino/policycache</code></p><p id="a01c" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">下图解释了上述组件之间的通信。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/751144c6280029623389d0cb51b21436.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5NkxKbCfavJSQcGsonpm8A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="8215" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">docker-compose文件连接了上述所有组件。</p><p id="bd72" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">关于<code class="fe nc nd ne nf b">docker-compose.yml</code>的要点</p><ol class=""><li id="579a" class="no np iq mg b mh mx mk my lu nq lx nr ma ns mw nt nu nv nw bi translated">我们已经使用<code class="fe nc nd ne nf b">named-docker-volumes</code> ex: <code class="fe nc nd ne nf b">ranger-es-data</code>，<code class="fe nc nd ne nf b">ranger-pg-data</code>来持久化诸如elasticsearch和postgres等服务的数据，即使在容器重启之后</li><li id="31db" class="no np iq mg b mh nx mk ny lu nz lx oa ma ob mw nt nu nv nw bi translated">Ranger-Admin和Ranger-Trino插件的预构建tar文件可作为发布资产在这个演示存储库<a class="ae kv" href="https://github.com/aakashnand/trino-ranger-demo/releases/tag/trino-ranger-demo-v1.0" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</li><li id="5f71" class="no np iq mg b mh nx mk ny lu nz lx oa ma ob mw nt nu nv nw bi translated">ranger-Admin <a class="ae kv" href="https://cwiki.apache.org/confluence/display/RANGER/Ranger+Installation+Guide#RangerInstallationGuide-Prerequisites" rel="noopener ugc nofollow" target="_blank">进程需要至少1.5 GB的内存</a>。Ranger-Admin tar文件包含<code class="fe nc nd ne nf b">install.properties</code>和<code class="fe nc nd ne nf b">setup.sh</code>。<code class="fe nc nd ne nf b">setup.sh</code>脚本从<code class="fe nc nd ne nf b">install.properties</code>读取配置。以下补丁文件描述了与Ranger-Admin组件的默认版本<code class="fe nc nd ne nf b">install.properties</code>相比，对<code class="fe nc nd ne nf b">install.properties</code>所做的配置更改。</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="9eaa" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">4.Ranger-Trino-Plugin tar文件也包含了<code class="fe nc nd ne nf b">install.properties</code>和<code class="fe nc nd ne nf b">enable-trino-plugin.sh</code>脚本。关于trino docker环境需要注意的重要一点是，配置文件和插件目录被配置到不同的目录位置。配置是从<code class="fe nc nd ne nf b">/etc/trino</code>读取的，而插件是从<code class="fe nc nd ne nf b">/usr/lib/trino/plugins</code>加载的。这两个目录在为Trino-Ranger-Plugin配置<code class="fe nc nd ne nf b">install.properties</code>时非常重要，因此需要对Trino-Ranger-Plugin tar文件附带的默认脚本<code class="fe nc nd ne nf b">enable-trino-plugin.sh</code>进行一些额外的定制，以使其能够与dockerized Trino一起工作。这些更改在下面的修补程序文件中突出显示。基本上，这些变化引入了两个新的自定义变量<code class="fe nc nd ne nf b">INSTALL_ENV</code>和<code class="fe nc nd ne nf b">COMPONENT_PLUGIN_DIR_NAME</code>，它们可以在<code class="fe nc nd ne nf b">install.properties</code>中进行配置</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="bcff" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">5.<code class="fe nc nd ne nf b">install.properties</code>Trino Ranger插件的文件需要按照以下补丁文件所示进行配置。请注意，我们使用两个新引入的自定义变量来通知<code class="fe nc nd ne nf b">enable-plugin-script</code>Trino已经部署在docker环境中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="a9df" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">6.最后，如下图所示，将它们放在<code class="fe nc nd ne nf b">docker-compose.yml</code>中。这个文件也可以在Github库<a class="ae kv" href="https://github.com/aakashnand/trino-ranger-demo/blob/main/docker-compose.yml" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div></figure></div><div class="ab cl oe of hu og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="ij ik il im in"><h1 id="0af8" class="kx ky iq bd kz la ol lc ld le om lg lh jw on jx lj jz oo ka ll kc op kd ln lo bi translated">第二部分:设置和初始化</h1><p id="b717" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">在这一部分中，我们将部署docker-compose服务并确认每个组件的状态。</p><h2 id="90af" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">步骤1:克隆存储库</h2><pre class="kg kh ki kj gt oq nf or os aw ot bi"><span id="df0f" class="lp ky iq nf b gy ou ov l ow ox">git clone <a class="ae kv" href="https://github.com/aakashnand/trino-ranger-demo.git" rel="noopener ugc nofollow" target="_blank">https://github.com/aakashnand/trino-ranger-demo.git</a></span></pre><h2 id="c68a" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">步骤2:部署docker-compose</h2><pre class="kg kh ki kj gt oq nf or os aw ot bi"><span id="a25d" class="lp ky iq nf b gy ou ov l ow ox">$ cd trino-ranger-demo<br/>$ docker-compose up -d</span></pre><p id="5da3" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">一旦我们使用docker-compose部署服务，我们应该能够看到四个正在运行的服务。我们可以通过<code class="fe nc nd ne nf b">docker-compose ps</code>来证实这一点</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/a4cf5a51b85bf1ac0d647b69977186cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XzJrrx4UzC8TEDWUbQMsUA.png"/></div></div></figure><h2 id="a190" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">步骤3:确认服务</h2><p id="1a9e" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">让我们确认Trino和Ranger-Admin服务在以下URL上是可访问的</p><p id="7d1c" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">游侠管理员:<a class="ae kv" href="http://localhost:6080" rel="noopener ugc nofollow" target="_blank"> http://localhost:6080 </a></p><p id="4777" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">崔诺:<a class="ae kv" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a></p><p id="59b7" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">elastic search:<a class="ae kv" href="http://localhost:9200" rel="noopener ugc nofollow" target="_blank">http://localhost:9200</a></p><h2 id="021a" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">步骤4:从Ranger-Admin创建Trino服务</h2><p id="a734" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">让我们访问Ranger-Admin用户界面，并作为<code class="fe nc nd ne nf b">admin</code>用户登录。我们在上面的<code class="fe nc nd ne nf b">ranger-admin-install.properties</code>文件中配置了我们的管理员用户密码<code class="fe nc nd ne nf b">rangeradmin1</code>。正如我们在下面的截图中看到的，默认情况下，没有<code class="fe nc nd ne nf b">trino</code>服务。因此，让我们创建一个名为<code class="fe nc nd ne nf b">trino</code>的服务。<strong class="mg ir">服务名应该与在</strong> <code class="fe nc nd ne nf b"><strong class="mg ir">install.properties</strong></code> <strong class="mg ir">中为Ranger-Admin </strong>定义的名称相匹配</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/2035578258a5b201a8ecc75efcacdf0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2OUlNxXgSc7PE7yGoQvFRg.png"/></div></div></figure><p id="3502" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">请注意JDBC字符串中的主机名。从 <code class="fe nc nd ne nf b"><strong class="mg ir">ranger-admin</strong></code> <strong class="mg ir">容器trino可到达</strong> <code class="fe nc nd ne nf b"><strong class="mg ir">my-localhost-trino</strong></code> <strong class="mg ir">，因此主机名被配置为</strong> <code class="fe nc nd ne nf b"><strong class="mg ir">my-localhost-trino</strong></code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/2d4fa94812b8fb6d2e08e94d6d08bbc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQ8xPQakHAWtjr213avISA.png"/></div></div></figure><p id="ef27" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">如果我们点击测试连接，我们将得到如下所示的<em class="nj">连接失败</em>错误。这是因为Ranger-Admin进程已经在运行，并且仍在寻找我们尚未创建的名为<code class="fe nc nd ne nf b">trino</code>的服务。一旦我们点击<code class="fe nc nd ne nf b">Add</code>，它将被创建。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/c3f2b4297a58dfc7cdf54c269b2247b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3CCTPmfLyZHE59VD-N0BEA.png"/></div></div></figure><p id="9377" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">因此，让我们添加<code class="fe nc nd ne nf b">trino</code>服务，然后再次单击<code class="fe nc nd ne nf b">Test Connection</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pc"><img src="../Images/de6b88be3b39ddf7f4dfd62ad9a611ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qJSIAlXGJYh4KgKZNslsfw.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pd"><img src="../Images/d90d43f7d11cb4bb935b4ec3acd6e884.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pp4z1lq1lWPwV3q3v4hT-Q.png"/></div></div></figure><p id="8fbc" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">现在Ranger-Admin成功连接到Trino🎉</p><h2 id="97af" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">步骤5:确认Ranger审计日志</h2><p id="0d58" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">要检查审计日志，从顶部导航栏导航至审计，并点击<code class="fe nc nd ne nf b">Audit</code>。我们可以看到显示了审计日志🎉。Ranger-Admin和Elasticsearch工作正常。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pe"><img src="../Images/bd202fbfc323eff55b4ac51c08c35e0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oNW9kH_wRTZR_QJeeZ3dWA.png"/></div></div></figure></div><div class="ab cl oe of hu og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="ij ik il im in"><h1 id="e071" class="kx ky iq bd kz la ol lc ld le om lg lh jw on jx lj jz oo ka ll kc op kd ln lo bi translated">第三部分看到它在行动</h1><p id="fc5b" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">现在我们已经完成了设置，是时候创建实际的访问策略并查看它的运行情况了</p><ul class=""><li id="24df" class="no np iq mg b mh mx mk my lu nq lx nr ma ns mw pf nu nv nw bi translated">当创建<code class="fe nc nd ne nf b">trino</code>服务时，我们在连接信息中使用<code class="fe nc nd ne nf b">ranger-admin</code>作为用户名。这会使用该用户名创建默认策略，因此<code class="fe nc nd ne nf b">ranger-admin</code>用户将拥有超级权限</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pg"><img src="../Images/0b409ebcf00f9a77103d718dd678f0fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UT9I0-xMq7TpahDKI6a-7g.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ph"><img src="../Images/1c8eac6494f2c2c88456de84013c9583.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K89Ak-1MtCF_Htr1jxtZdg.png"/></div></div></figure><p id="99c9" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">为了理解访问场景并创建访问策略，我们需要创建一个测试用户。Ranger usersync服务将各种来源(如Unix、文件或AD/LDAP)的用户、组和组成员身份同步到Ranger中。Ranger usersync提供了一组丰富而灵活的配置属性，用于同步来自AD/LDAP的用户、组和组成员，支持多种使用情形。在本教程中，我们将从Ranger-Admin UI手动创建一个测试用户。</p><h2 id="9627" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">步骤1:从Ranger-Admin创建<code class="fe nc nd ne nf b">test-user</code></h2><p id="06ba" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">要创建用户，我们导航至设置→用户/组/角色→添加新用户</p><p id="d818" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">创建用户时，我们可以选择不同的角色。</p><ul class=""><li id="0a81" class="no np iq mg b mh mx mk my lu nq lx nr ma ns mw pf nu nv nw bi translated"><code class="fe nc nd ne nf b">user</code>角色是普通用户</li><li id="7e12" class="no np iq mg b mh nx mk ny lu nz lx oa ma ob mw pf nu nv nw bi translated"><code class="fe nc nd ne nf b">Admin</code>角色可以从Ranger Admin UI创建和管理策略。</li><li id="8b31" class="no np iq mg b mh nx mk ny lu nz lx oa ma ob mw pf nu nv nw bi translated"><code class="fe nc nd ne nf b">Auditor</code>角色是<code class="fe nc nd ne nf b">read-only</code>用户角色。</li></ul><p id="d548" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">现在，让我们创建一个角色为<code class="fe nc nd ne nf b">Admin</code>的用户。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pi"><img src="../Images/93f1b3193449838c08f68f9ced450d5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bsYoAOLkge645EKVQv_Vog.png"/></div></div></figure><h2 id="b76d" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">步骤2:确认进入<code class="fe nc nd ne nf b">test-user</code>和r <code class="fe nc nd ne nf b">anger-admin</code></h2><p id="b0cd" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">让我们确认用户的访问权限<code class="fe nc nd ne nf b">ranger-admin</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pj"><img src="../Images/3d2b79e26f77a86e20633089efae2fac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SecBiC49A52LGeQJjOlkAg.png"/></div></div></figure><p id="373b" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">正如我们看到的<code class="fe nc nd ne nf b">ranger-admin</code>用户可以访问模式<code class="fe nc nd ne nf b">tpch.sf10</code>下的所有表</p><p id="f6ae" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">由于我们没有为<code class="fe nc nd ne nf b">test-user</code>配置任何策略，如果我们试图访问任何目录或执行任何查询，我们应该会看到一条<em class="nj">访问被拒绝</em>消息。让我们通过从<a class="ae kv" href="https://trino.io/docs/current/installation/cli.html" rel="noopener ugc nofollow" target="_blank"> Trino CLI </a>执行查询来确认这一点</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pk"><img src="../Images/2ab1686b5ed166ffd6e85a026c6f9edf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*732kryA_exaURWuIc5X92g.png"/></div></div></figure><h2 id="3c45" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">步骤3:允许访问模式<code class="fe nc nd ne nf b">tpch.sf10</code>下的所有表<code class="fe nc nd ne nf b">test-user</code></h2><p id="55e0" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">让我们创建一个允许<code class="fe nc nd ne nf b">test-user</code>访问<code class="fe nc nd ne nf b">tpch.sf10</code>到<strong class="mg ir">所有</strong>表的策略。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pl"><img src="../Images/e5f6ba274de6a6cedc29342a1d3e9df7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uAPrRiwGTaoFiHdPIjvTYw.png"/></div></div></figure><p id="719f" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">我们还可以为每个策略分配特定的权限，但是现在让我们创建一个具有所有权限的策略。创建此策略后，我们有以下活动策略。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pm"><img src="../Images/962be4fbee4c4595e11a1d259ea67f0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dj-3muiXK2X5e7SvTBt1vA.png"/></div></div></figure><p id="67d2" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">现在让我们再次确认访问。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pn"><img src="../Images/888619535aa1f7797067f9099952da46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4paodwK3WPYVxz8GuKvaIg.png"/></div></div></figure><p id="3077" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">我们仍然收到<em class="nj">拒绝访问</em>的消息。这是因为需要为每个对象级别配置Trino ranger策略。例如，<code class="fe nc nd ne nf b">catalog</code>级策略，<code class="fe nc nd ne nf b">catalog+schema</code>级策略，<code class="fe nc nd ne nf b">catalog+schema+table </code>级策略，<code class="fe nc nd ne nf b"> information_schema</code>级策略。让我们为<code class="fe nc nd ne nf b">catalog</code>级别添加策略。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi po"><img src="../Images/e144ab48713827c2fcf295926cf04261.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F5xdrQ9QO0KXlXOW-O2KFA.png"/></div></div></figure><p id="8735" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">让我们用Trino CLI再次确认</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pp"><img src="../Images/c5385154470a6f01b5a987c508ca15e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZe-LY_V8g3dBPsE4Y3kAg.png"/></div></div></figure><p id="e004" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">我们仍然得到错误，但错误信息不同。让我们转到Ranger审计部分，了解更多相关信息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pq"><img src="../Images/98660fb49271c3903513cac8f01e1c7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*khwvQA0gy56owRcjddoHrg.png"/></div></div></figure><p id="9550" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">我们可以看到一个拒绝对名为<code class="fe nc nd ne nf b">tpch.information_schema.tables.table_schema</code>的资源进行访问的条目。在Trino中，<code class="fe nc nd ne nf b">information_schema</code>是包含关于表和表列的元数据的模式。因此也有必要为<code class="fe nc nd ne nf b">information_schema</code>添加策略。任何用户都需要访问<code class="fe nc nd ne nf b">information_schema</code>才能在Trino中执行查询，因此，我们可以在Ranger策略中使用<code class="fe nc nd ne nf b">{USER}</code>变量，将访问权限授予所有用户。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pr"><img src="../Images/6cf11a40a8ff8a22dfbe57e8db02ef2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LN_biqBYHM3EpRA5r5BSmQ.png"/></div></div></figure><p id="7442" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">让我们再次从Trino CLI确认访问。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ps"><img src="../Images/4a67165df8a8b6e4f8a80b6d93f62ff0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*InMXWfcjIfqwLgMc2bKkvQ.png"/></div></div></figure><p id="aef1" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">如果我们试图执行任何SQL函数，我们仍然会得到拒绝访问的消息。在默认策略部分，<code class="fe nc nd ne nf b">all-functions</code>策略(ID:3)是允许access执行任何SQL函数的策略。因为执行SQL函数是所有用户的要求，所以让我们编辑<code class="fe nc nd ne nf b">all-functions</code>策略(ID:3)并使用<code class="fe nc nd ne nf b">{USER}</code>变量添加所有用户来访问函数</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pt"><img src="../Images/38cd3d3dbba8978230aca50009d5d75f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OEstyHiTuT2ULbPsgoKakA.png"/></div></div></figure><p id="2619" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">总而言之，为了访问<code class="fe nc nd ne nf b">sf10</code>下的<code class="fe nc nd ne nf b">test-user</code>到<strong class="mg ir">所有</strong>表，我们添加了三个新策略，并编辑了默认的<code class="fe nc nd ne nf b">all-function</code>策略。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pu"><img src="../Images/643afa4da445669ff47e26a12a55fc26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z0sA_g1c7rjp3d3eZtgv-Q.png"/></div></div></figure><p id="7304" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">现在我们可以访问和执行针对<code class="fe nc nd ne nf b">sf10</code>模式的所有表的查询。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pv"><img src="../Images/17764c5971a69d068c5cdbd9cbefd2ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PArWWMXV1KI1DKAW1fTkCg.png"/></div></div></figure><p id="56c5" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">在下一步中，让我们了解如何为模式<code class="fe nc nd ne nf b">sf10</code>下的特定表提供对<code class="fe nc nd ne nf b">test-user</code>的访问</p><h2 id="c260" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">步骤4:授予对<code class="fe nc nd ne nf b">sf10</code>模式下特定表的访问权</h2><p id="a4b9" class="pw-post-body-paragraph me mf iq mg b mh mi jr mj mk ml ju mm lu mn mo mp lx mq mr ms ma mt mu mv mw ij bi translated">在上一步中，我们配置了策略来访问<code class="fe nc nd ne nf b">sf10</code>模式下的<strong class="mg ir">所有</strong>表，因此，<code class="fe nc nd ne nf b">schema-level</code>策略是不必要的。为了访问特定的模式，我们需要添加<code class="fe nc nd ne nf b">schema-level</code>策略，然后我们可以配置<code class="fe nc nd ne nf b">table-level</code>策略。所以让我们为<code class="fe nc nd ne nf b">tpch.sf10</code>增加<code class="fe nc nd ne nf b">schema-level</code>一项政策</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pw"><img src="../Images/4b876d4e41a5f8aa14b21f798be365ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7djM2JKqnzC0ndSsgoz03Q.png"/></div></div></figure><p id="b3e5" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">现在让我们将<code class="fe nc nd ne nf b">sf10-all-tables-policy</code>从所有表格编辑到特定表格。我们将配置一个策略，只允许访问<code class="fe nc nd ne nf b">nation</code>表</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi px"><img src="../Images/ec8d7e82cf3ab0a950022b6f844060c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fj3a3JtIGguRJDKs9d69LQ.png"/></div></div></figure><p id="b1e1" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">最后，我们有以下积极的政策</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi py"><img src="../Images/73133f03e55b46e3c9e89e22e3b6b16f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qygAoag1xpr9Lyaui9fuhw.png"/></div></div></figure><p id="bd1f" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">现在让我们再次从Trino CLI对<code class="fe nc nd ne nf b">test-user</code>执行查询。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pz"><img src="../Images/427ad11297f0644d54077c509683dd8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KaQb8DRWdx8j1-rL_9Y9uA.png"/></div></div></figure><p id="54a8" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated"><code class="fe nc nd ne nf b">test-user</code>现在可以根据需要从<code class="fe nc nd ne nf b">tpch.sf10</code>模式中访问唯一的<code class="fe nc nd ne nf b">nation</code>表。</p><p id="b751" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">如果你已经完成了所有的步骤，那么恭喜你，㊗️，现在你已经了解了如何配置Trino和Apache Ranger。</p><h2 id="1c39" class="lp ky iq bd kz lq lr dn ld ls lt dp lh lu lv lw lj lx ly lz ll ma mb mc ln md bi translated">第三部分:关键要点和结论</h2><ul class=""><li id="7f4b" class="no np iq mg b mh mi mk ml lu qa lx qb ma qc mw pf nu nv nw bi translated">从PrestoSQL更名为Trino后，Apache Ranger的GitHub库中的默认插件将无法与新的Trino一起工作，因为它仍然引用旧的<code class="fe nc nd ne nf b">io.prestosql</code>包。你可以在JIRA <a class="ae kv" href="https://issues.apache.org/jira/browse/RANGER-3182" rel="noopener ugc nofollow" target="_blank">这里</a>追踪这个问题</li><li id="9d32" class="no np iq mg b mh nx mk ny lu nz lx oa ma ob mw pf nu nv nw bi translated">更名的Trino插件将不会在新的Ranger版本2.2.0中提供。因此，与此同时，请随意使用<a class="ae kv" href="https://github.com/aakashnand/ranger/tree/ranger-2.1.0-trino" rel="noopener ugc nofollow" target="_blank">这个</a> GitHub库从源代码构建Apache Ranger，使用<a class="ae kv" href="https://github.com/aakashnand/trino-ranger-demo" rel="noopener ugc nofollow" target="_blank">这个</a> GitHub库开始Trino-Ranger集成。</li><li id="f194" class="no np iq mg b mh nx mk ny lu nz lx oa ma ob mw pf nu nv nw bi translated">为Trino配置Ranger策略并不那么直观，因为我们需要为每个级别配置访问策略。在Trino的知识库<a class="ae kv" href="https://github.com/trinodb/trino/issues/1076" rel="noopener ugc nofollow" target="_blank">这里</a>有一个关于这个的公开问题。</li><li id="dc92" class="no np iq mg b mh nx mk ny lu nz lx oa ma ob mw pf nu nv nw bi translated">尽管如此，建议配置一些基本策略，如带有<code class="fe nc nd ne nf b">{USER}</code>变量的<code class="fe nc nd ne nf b">information_schema</code>和<code class="fe nc nd ne nf b">all-functions</code>，因为这些策略对于任何用户执行查询都是必需的。</li></ul><p id="981d" class="pw-post-body-paragraph me mf iq mg b mh mx jr mj mk my ju mm lu mz mo mp lx na mr ms ma nb mu mv mw ij bi translated">由于缺乏好的文档和集成过程不太直观，集成Apache Ranger和Trino可能会很痛苦，但我希望这篇文章能让它变得简单一点。如果你正在使用Trino，我强烈推荐你加入<a class="ae kv" href="https://trino.io/slack.html" rel="noopener ugc nofollow" target="_blank"> Trino社区Slack </a>进行更详细的讨论。感谢您的阅读。</p></div></div>    
</body>
</html>