<html>
<head>
<title>Refinement of Semi-Additive Measures in DAX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DAX中半可加测度的精化</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/refinement-of-semi-additive-measures-in-dax-4e148fa83f56?source=collection_archive---------28-----------------------#2021-06-13">https://towardsdatascience.com/refinement-of-semi-additive-measures-in-dax-4e148fa83f56?source=collection_archive---------28-----------------------#2021-06-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="abfc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在之前的故事中，我解释了一些关于半加性测度的细节。这里有更多关于这个话题的提示</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0be294d61ff9d5e4ae1a6e6d000ad160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Mihc54YFYCBg7HBG"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">丹尼·米勒在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="d476" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="cb89" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我的故事<a class="ae ky" rel="noopener" target="_blank" href="/a-hard-lesson-on-filter-context-with-power-bi-and-dax-c0ce5f657af4">中，我解释了一些关于半加性度量和可能的副作用的细节。</a></p><p id="8bed" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在与一些客户讨论了这些解决方案后，我们发现了基础措施的一些奇怪的后果。现在，我将向您展示如何解决这些后果，并为您提供更详细的解决方案的灵感。</p><h1 id="ff30" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">让我们从数据开始</h1><p id="a43a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">对于本文，我使用了微软的Contoso数据集。</p><p id="9bd3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以从这里获得Power BI文件:<a class="ae ky" href="https://www.microsoft.com/en-us/download/details.aspx?id=46801" rel="noopener ugc nofollow" target="_blank"> ContosoSalesForPowerBI </a></p><p id="e967" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">由于Power BI文件缺少库存表，所以我从这里获得了原始数据库:<a class="ae ky" href="https://www.microsoft.com/en-us/download/details.aspx?id=18279" rel="noopener ugc nofollow" target="_blank"> Microsoft Contoso BI零售业演示数据集</a></p><p id="0592" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我将它加载到Azure SQL数据库中。我在数据库上创建视图来创建一个纯星型模式，而不是原始的雪花型模式，并且只将需要的数据导入到Power BI文件中。</p><p id="6d0a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我使用了自己创建的日历表，而不是原始的日期表，并使用了原始数据集的库存表。</p><h1 id="3bc0" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">基础措施</h1><p id="dd5e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">基本度量具有以下定义:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="35f4" class="mx la it mt b gy my mz l na nb">Last Stock by Date Variant 1 =</span><span id="4637" class="mx la it mt b gy nc mz l na nb">VAR LastDateWithInventory = LASTNONBLANK(‘Date’[Date],<br/>    SUM(‘Inventory’[OnHandQuantity]))</span><span id="d64c" class="mx la it mt b gy nc mz l na nb">VAR Result =<br/>    CALCULATE(<br/>        SUM(‘Inventory’[OnHandQuantity]),<br/>        LastDateWithInventory)</span><span id="74cc" class="mx la it mt b gy nc mz l na nb">RETURN<br/>    Result</span></pre><p id="07e6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">此度量通过SUM()表达式的结果获取最后一个日期。然后返回该日期的表达式结果。</p><p id="5ef7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">问题是，当您使用日期层次结构时，LASTNONBLANK()返回包含数据的周期的最后一个日期。</p><p id="1902" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">因此，当此最后日期存在值时，该度量将仅返回一个值。</p><p id="aff8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">示例见下图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/4977ccd533c418a27b29b4aa40b29e30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j3OdRuToAllGmt8fM06Bog.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1-没有小计值的结果</p></figure><p id="4635" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">因为我们只有2009年10月最后一天的数据，所以我们只能看到这个月的小计。该度量不返回其他月份的小计，也不返回2009年的总计，因为不存在31个月份的数据。2009年12月</p><p id="7a3b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在对《使用Power BI和Power Pivot for Excel分析数据》一书<em class="ne">(商业技能)</em> *进行了一些研究后，我发现了这个变体:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="3a4f" class="mx la it mt b gy my mz l na nb">Last Stock by Date Variant 2 =</span><span id="4b32" class="mx la it mt b gy nc mz l na nb">VAR LastDateWithInventory = <strong class="mt iu">LASTNONBLANK(‘Inventory’[DateKey],<br/>    NOT ( ISEMPTY(‘Inventory’) )</strong><br/>    )</span><span id="ce8a" class="mx la it mt b gy nc mz l na nb">VAR Result =<br/>    CALCULATE(<br/>        SUM(‘Inventory’[OnHandQuantity])<br/>        ,TREATAS(LastDateWithInventory<br/>                ,’Date’[Date])<br/>    )</span><span id="80eb" class="mx la it mt b gy nc mz l na nb">RETURN<br/>    Result</span></pre><p id="f553" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">不同之处在于度量如何使用数据评估最后一个日期。LASTNONBLANK()从库存表中获取最新的日期。</p><p id="58ce" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">CALCULATE()使用LASTNONBLANK()的结果，并借助TREATAS()将库存表中的日期映射到日期表。</p><p id="932f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">你可以在下面的图片中看到结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/2810dd56b8cd93cfa7e7a4ce2ba5a902.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tPa2_-AcGPa6YsEafDqN6w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图2 —每月总计的新度量</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/16792115296fc1ca98b6da59eedf20ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4kEA1rXjWTYa41TgnJwLlA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3——日级别的详细新度量</p></figure><p id="b40d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在图2中，您可以看到我们得到了每个月的结果。</p><h1 id="12c4" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">哪个结果是正确的？</h1><p id="ae85" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">但是，这可能不是正确的结果。正如您在图3中看到的，我们用数据获得了最后一天的值。</p><p id="7f28" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果我们想获得一个月中最后一天的股票价值，但是我们没有该月最后一天的数据，那么结果可能是不正确的。</p><p id="11c3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">下表显示了两种产品的库存:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/1cf1b1087b6620f08594d652b2a5342c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1wNqLoLTHviIMjHHpY4-lA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4—原始库存数据</p></figure><p id="c09e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">看看二月的M2101蓝色笔记本电脑。<br/>二月底，股票是24。</p><p id="00ce" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是三月有什么？<br/>股票是19还是0？</p><p id="139f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这同样适用于M1548白色笔记本电脑。<br/>二月的股票可以是24也可以是0。三月也一样。是19还是0？</p><p id="ab5a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这取决于数据的定义。数据定义了两个度量中哪一个是正确的。</p><p id="6878" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果没有库存数量的日期意味着库存是空的，那么0将是三月和两种产品的正确结果。另一方面，如果我们只在某些事情发生变化时才获得库存数量，那么最新的值(19)将是products和March的正确结果。</p><p id="dc2d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要考虑的数据定义是使用半累加性度量时需要考虑的一个问题。但是还有更多可能的问题。</p><h1 id="2d7a" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">没有时间背景会发生什么</h1><p id="c075" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">有时我想创建一个不设置日期过滤器的报告。在本例中，我想从Inventory表中获取最新的库存数量。</p><p id="2592" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要解决这样的请求，我需要遵循两步走的方法:</p><p id="77de" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">步骤1:为库存数据的最后日期添加一个标志。</p><p id="1f15" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我将使用<a class="ae ky" href="https://www.sqlbi.com/articles/understanding-context-transition/" rel="noopener ugc nofollow" target="_blank">上下文转换</a>向库存表添加一个计算列:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="4668" class="mx la it mt b gy my mz l na nb">Is Last Snapshot =</span><span id="bbd4" class="mx la it mt b gy nc mz l na nb">VAR LastSnapshot = CALCULATE(<br/>    MAXX(‘Inventory’<br/>    ,’Inventory’[DateKey])<br/>    ,ALL(‘Inventory’)<br/>    )</span><span id="8188" class="mx la it mt b gy nc mz l na nb">VAR Flag = IF(‘Inventory’[DateKey] = LastSnapshot, TRUE(), FALSE())</span><span id="c023" class="mx la it mt b gy nc mz l na nb">RETURN<br/>    Flag</span></pre><p id="f459" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在我可以创建一个度量，它检查日期是否被过滤。否则，该度量将只针对<em class="ne">是最后一个快照</em> = TRUE()的行。</p><p id="0d59" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">所需测量的代码如下:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="1f50" class="mx la it mt b gy my mz l na nb">Last Stock by Date Variant 3 =</span><span id="d5a6" class="mx la it mt b gy nc mz l na nb">VAR LastDateWithData =<br/>    LASTNONBLANK(‘Date’[Date],<br/>        SUM(‘Inventory’[OnHandQuantity])<br/>    )</span><span id="b872" class="mx la it mt b gy nc mz l na nb">VAR isTime =<br/>    ISFILTERED ( ‘Date’ )</span><span id="ccc4" class="mx la it mt b gy nc mz l na nb">RETURN<br/>    IF (<br/>        isTime<br/>        ,CALCULATE(<br/>            SUM ( ‘Inventory’[OnHandQuantity] )<br/>            ,TREATAS( LastDateWithData<br/>            ,’Date’[Date]<br/>            )<br/>        )<br/>        ,CALCULATE (<br/>            SUM ( ‘Inventory’[OnHandQuantity] ),<br/>            FILTER ( ‘Inventory’<br/>                ,‘Inventory’[Is Last Snapshot] = TRUE ()<br/>                )<br/>            )<br/>        )</span></pre><p id="6c9f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如您所见，该度量基于基本度量的第一个变体。</p><p id="b0b2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">结果如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/9fdfc7a3df2c729e6d4dc5659820b028.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g8pfaH3H-jhOQzYELi-Lzw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图5—有日期和无日期的库存</p></figure><p id="658c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这项措施有两个好处:</p><ol class=""><li id="9447" class="nj nk it lt b lu mn lx mo ma nl me nm mi nn mm no np nq nr bi translated">如果没有筛选日期，您可以定义要使用的日期。</li><li id="124d" class="nj nk it lt b lu ns lx nt ma nu me nv mi nw mm no np nq nr bi translated">性能提高了约30%,因为基于具有两个不同值的列过滤库存比基于相关(日期)表过滤数据要容易得多。</li></ol><p id="d554" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果您使用第二种方法，就不需要这个解决方案，因为它会返回相同的结果。</p><p id="dd39" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">好了，现在我们有三种半可加测度的工作方法。但是当我们有矛盾的需求时会发生什么呢？</p><h1 id="d586" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结合多种需求</h1><p id="8547" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我的一个客户要求我开发一种方法来计算正确的股票数量。</p><p id="a45b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">他加载股票数据的ETL过程被设计成每天加载当前的股票数量，甚至在周末也是如此。</p><p id="a96e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">主要的请求是只显示每个月最后一天的库存数量。</p><p id="3737" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">当用户没有在报告中选择任何日期时，该度量必须返回最近可用的库存数量。</p><p id="f5db" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">第三个变体正好提供了所需的结果。</p><p id="a22d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是当月呢？没有当月最后一天的可用数据。这意味着该度量不会返回任何值，这是错误的。</p><p id="0cdb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在我需要创造一种方法来改变这种行为。</p><p id="ce67" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">第一步是在实际过滤器上下文中选择具有最新数据集的日期:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="91fa" class="mx la it mt b gy my mz l na nb">VAR LastDateWithData =<br/>LASTNONBLANK (<br/>        ‘Inventory’[DateKey]<br/>        ,SUM ( ‘Inventory’[OnHandQuantity] )<br/>        )</span></pre><p id="f4fe" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是，由于我还需要库存表中数据的最后可能日期，所以我需要另一个变量:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="ef24" class="mx la it mt b gy my mz l na nb">VAR LastDateWithData_FromData =<br/>CALCULATE (<br/>    LASTNONBLANK (<br/>        ‘Inventory’[DateKey]<br/>        ,NOT ISEMPTY ( ‘Inventory’ )<br/>        )<br/>    ,REMOVEFILTERS(‘Inventory’)<br/>    )</span></pre><p id="8cd9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">REMOVEFILTERS('Inventory ')的使用确保了我可以获得整个Inventory表的最后一个可能的日期。</p><p id="29a5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果您有一个标记最新股票价值的计算列，您可以使用一个更简单的公式，就像上面显示的公式创建[Is Last Snapshot]列，</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="4fd5" class="mx la it mt b gy my mz l na nb">VAR LastDateWithData_FromData =<br/>    CALCULATE(<br/>        MAX(‘Inventory’[DateKey])<br/>        ,’Inventory’[Is Last Snapshot]<br/>        )</span></pre><p id="37b2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，我需要计算存储在变量LastDateWithData_FromData中的日期所在月份内的所有日期:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="0c96" class="mx la it mt b gy my mz l na nb">VAR AllDatesWithLastData =<br/>    CALCULATETABLE(<br/>        SUMMARIZE(<br/>            ‘Date’<br/>            ,’Date’[Date]<br/>            )<br/>        ,FILTER(‘Date’<br/>        ,INT( ‘Date’[MonthKey] ) = ( YEAR(LastDateWithData_FromData) * 100 ) + MONTH(LastDateWithData_FromData)<br/>        )<br/>        ,ALL ( ‘Date’[Date] )<br/>        )</span></pre><p id="22c3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最后一个变量是检查日期表上是否有过滤器:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="7ce8" class="mx la it mt b gy my mz l na nb">VAR isTime =<br/>    ISFILTERED ( ‘Date’ )</span></pre><p id="a364" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在我可以组合所有内容并返回正确的值:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="070f" class="mx la it mt b gy my mz l na nb">RETURN<br/>    IF (<br/>        AND ( isTime, NOT LastDateWithData IN AllDatesWithLastData )<br/>        ,CALCULATE(<br/>            SUM ( ‘Inventory’[OnHandQuantity] )<br/>            ,TREATAS( LastDateWithData<br/>                    ,’Date’[Date]<br/>                    )<br/>        )<br/>        ,CALCULATE (<br/>            SUM ( ‘Inventory’[OnHandQuantity] ),<br/>            FILTER ( ‘Inventory’<br/>                     ,‘Inventory’[Is Last Snapshot] = TRUE () )<br/>             )<br/>         )</span></pre><p id="0ec2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">关键部分是IF条件。</p><ol class=""><li id="dac2" class="nj nk it lt b lu mn lx mo ma nl me nm mi nn mm no np nq nr bi translated">当日期表<br/>上出现过滤器时</li><li id="7750" class="nj nk it lt b lu ns lx nt ma nu me nv mi nw mm no np nq nr bi translated">实际筛选器上下文中的日期不是库存表中最新数据集所在月份的一部分</li></ol><p id="2a9c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">2-a .返回由变量LastDateWithData过滤的股票数量。<br/>需要TREATAS()来将过滤器的沿袭修正到数据表中</p><p id="5d57" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">3.如果If条件不为真，则</p><p id="adb9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">3-a .我们要么是上个月出现在数据中的<br/>要么是</p><p id="f819" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">3-b .日期表上没有过滤器</p><p id="cccc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">结果看起来像下面的截图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/087fc176c6cb3b35b2f163b138b375c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UDHxGvodOZxmI0rKIHq8Rg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图6—最终结果</p></figure><p id="c3b7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">第一个表显示了第三个变量的结果，第二个表显示了组合测量的结果。</p><p id="a450" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在下面的屏幕截图中，您可以比较度量的第三个变量的结果与没有对日期表进行任何筛选的组合度量的结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/a6de6e9f1c2ff6a57e21c0d644fe3fef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vEelnzLknUnHyCwtJsC1Dg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图7 —没有日期过滤器的最终结果</p></figure><p id="6740" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如您所见，第二个表显示了数据集中最后一天的库存数量:2009年12月。</p><h1 id="b1c6" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">全部措施</h1><p id="4ca3" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在这里，您可以找到组合所有变量的测量的完整代码:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="11b1" class="mx la it mt b gy my mz l na nb">Last Stock by Date Variant 4 =<br/>VAR LastDateWithData =<br/>    LASTNONBLANK (<br/>        ‘Inventory’[DateKey]<br/>        ,SUM ( ‘Inventory’[OnHandQuantity] )<br/>        )</span><span id="dadd" class="mx la it mt b gy nc mz l na nb">VAR LastDateWithData_FromData =<br/>    CALCULATE(<br/>        MAX(‘Inventory’[DateKey])<br/>        ,’Inventory’[Is Last Snapshot]<br/>        )</span><span id="d899" class="mx la it mt b gy nc mz l na nb">// CALCULATE (<br/>// LASTNONBLANK (<br/>// ‘Inventory’[DateKey]<br/>// ,NOT ISEMPTY ( ‘Inventory’ )<br/>// )<br/>// ,REMOVEFILTERS(‘Inventory’)<br/>// )</span><span id="af12" class="mx la it mt b gy nc mz l na nb">VAR AllDatesWithLastData =<br/>    CALCULATETABLE(<br/>        SUMMARIZE(<br/>            ‘Date’<br/>            ,’Date’[Date]<br/>         )<br/>         ,FILTER(‘Date’<br/>         ,INT( ‘Date’[MonthKey] ) = ( YEAR(LastDateWithData_FromData) * 100 ) + MONTH(LastDateWithData_FromData)<br/>         )<br/>         ,ALL ( ‘Date’[Date] )<br/>         )</span><span id="9dea" class="mx la it mt b gy nc mz l na nb">VAR isTime =<br/>     ISFILTERED ( ‘Date’ )</span><span id="961b" class="mx la it mt b gy nc mz l na nb">RETURN<br/>    IF (<br/>        AND ( isTime, NOT LastDateWithData IN AllDatesWithLastData )<br/>        ,CALCULATE(<br/>            SUM ( ‘Inventory’[OnHandQuantity] )<br/>            , TREATAS( LastDateWithData<br/>                       ,’Date’[Date]<br/>                       )<br/>        )<br/>        ,CALCULATE (<br/>            SUM ( ‘Inventory’[OnHandQuantity] ),<br/>            FILTER ( ‘Inventory’<br/>                   ,‘Inventory’[Is Last Snapshot] = TRUE () )<br/>                   )<br/>)</span></pre><p id="3852" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这个DAX-Measure中，您可以找到变量LastDateWithData_FromData的两个变量。</p><h1 id="dfaf" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">注意——不要简单地复制和粘贴本文中的代码</h1><p id="cbfc" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在开始复制本文中显示的代码之前，您需要仔细确定想要的结果。</p><p id="a3ed" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">哪种变体最符合您的需求？</p><p id="cb90" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最后一种组合变体是最慢的，但也是最灵活的。但是，你需要这样的灵活性吗？如果没有，使用更简单的变体。</p><p id="16fb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">此处显示的变体适用于Power BI和SQL Server Analysis Services (SSAS)。</p><p id="a656" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是，当您专门在Power BI中工作时，您可能会对使用</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="25bf" class="mx la it mt b gy my mz l na nb">Last Stock by Date =<br/>    LASTNONBLANKVALUE('Date'[Date],<br/>        SUM('Inventory'[OnHandQuantity])<br/>    )</span></pre><p id="f097" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">同样，您需要用不同的场景测试结果，并决定这种变体是否在任何情况下都能提供正确的结果。</p><h1 id="8414" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="f46a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我总是试图理解需求，并向我的客户展示不同的场景，以确保我们谈论的是同一件事。很难避免认为“这很容易。我知道我的客户在问我什么。但是最重要的是，至少要经历两到三次迭代，才能确保双方对解决方案的预期有相同的理解。</p><p id="b6e0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最后但同样重要的是，试着理解为什么一个度量返回一个特定的结果。</p><p id="a92c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">当你理解你的方法是如何工作的，以及为什么结果会因不同的场景而不同时，你的生活会变得容易得多。</p><p id="c1b9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">一旦你理解了你的指标是如何工作的，你就离成为DAX大师更近了一步。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/c314facd33c8262e20c9f53781a3c9ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WQ6-1GeajmNmkJYK"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">吉姆·泰格曼在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="9b19" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我希望你喜欢这个旅程，谢谢你一直读到最后。</p><p id="b9f9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">*书籍参考:<br/>使用Power BI和Power Pivot for Excel分析数据(业务技能)<br/>微软出版社<br/>ISBN-13:978–1509302765<br/>ISBN-10:150930276 x</p></div></div>    
</body>
</html>