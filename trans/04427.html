<html>
<head>
<title>Spatial Cross-Validation Using scikit-learn</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用scikit-learn进行空间交叉验证</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/spatial-cross-validation-using-scikit-learn-74cb8ffe0ab9?source=collection_archive---------6-----------------------#2021-04-15">https://towardsdatascience.com/spatial-cross-validation-using-scikit-learn-74cb8ffe0ab9?source=collection_archive---------6-----------------------#2021-04-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/c6586e11b6b1dcadef7e12875058697d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ps06KdT2WVDJ1TBFd5c4yQ.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">图片由Mohit (@98mohitkumar)在<a class="ae jd" href="https://unsplash.com/photos/6M9xiVgkoN0" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供</p></figure><div class=""/><div class=""><h2 id="c8e4" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">使用scikit-learn对具有空间自相关的数据集实施交叉验证</h2></div><p id="546a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="lr">如果您想直接跳到代码，请跳到scikit-learn上的</em> <strong class="kx jh"> <em class="lr">空间交叉验证实现部分。</em> </strong></p><p id="6848" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">统计推断的一个典型而有用的假设是数据是独立同分布的(IID)。我们可以随机抽取患者子集，用正常的训练-测试分割预测他们患糖尿病的可能性，没问题。然而，在实践中，有一些类型的数据集这种假设不成立，一个典型的训练测试分割可能会引入<a class="ae jd" href="https://en.wikipedia.org/wiki/Leakage_(machine_learning)" rel="noopener ugc nofollow" target="_blank">数据泄漏</a>。当感兴趣的变量的分布是<em class="lr">而不是</em>随机时，数据被认为是自相关的——这对机器学习模型有影响。</p><p id="907f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以在许多带有地理空间成分的数据集上找到<em class="lr">空间</em>自相关。考虑下面的地图:</p><div class="ls lt lu lv gt ab cb"><figure class="lw is lx ly lz ma mb paragraph-image"><img src="../Images/369feaabd8e621edd00a9f80763a28dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*ePNRS9wzOY9sLtxcnRKerA.png"/></figure><figure class="lw is lx ly lz ma mb paragraph-image"><img src="../Images/6d514507b6ad7f82e41e67e4aeff14f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*TUQxJO3VJSAlHgrn5qGOIQ.png"/><p class="iz ja gj gh gi jb jc bd b be z dk mc di md me translated">具有<strong class="bd mf">真实人口</strong>的大马尼拉地图(左)与人口<strong class="bd mf">随机分布的地图</strong>(右)。数据在<a class="ae jd" href="https://data.humdata.org/dataset/philippines-2015-census-population-administrative-level-1-to-4" rel="noopener ugc nofollow" target="_blank">人道主义数据交换</a>公开。图片作者。</p></figure></div><p id="a304" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果数据是IID，它看起来就像右边的地图。但在现实生活中，我们有像左边这样的地图，可以很容易地观察到模式。地理第一定律指出，距离较近的事物比距离较远的事物更加相关。属性通常不会随机分布在某个位置，更有可能的情况是某个区域与其相邻区域非常相似。在上面的例子中，一个地区的人口水平很可能与邻近地区相似，而与远处的地区相反。</p><h1 id="33eb" class="mg mh jg bd mi mj mk ml mm mn mo mp mq km mr kn ms kp mt kq mu ks mv kt mw mx bi translated">我们什么时候需要空间交叉验证？</h1><p id="a005" class="pw-post-body-paragraph kv kw jg kx b ky my kh la lb mz kk ld le na lg lh li nb lk ll lm nc lo lp lq ij bi translated">当数据自相关时，我们可能要格外小心过度拟合。在这种情况下，如果我们使用随机样本进行训练测试分割或交叉验证，我们违反了IID假设，因为样本在统计上不是独立的。区域A可能在训练集中，但是验证集中的区域Z恰好离区域A只有一公里远，同时也共享非常相似的特征。该模型对于区域Z将具有更准确的预测，因为它在训练集中看到了非常相似的示例。要解决这个问题，按区域对数据进行分组可以防止模型偷窥它不应该看到的数据。以下是空间交叉验证的情况:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nd"><img src="../Images/3a2e87ff42a1fb7661f21f6637be271a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ALoitT61zdnlyrGN.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">默认交叉验证与空间交叉验证的图示。图片来自Lovelace等人[1]</p></figure><p id="d05e" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里要问的一个好问题是:我们是否总是想要防止过度拟合？直觉上，是的。但与大多数机器学习技术一样，这取决于具体情况。如果它符合您的用例，过度拟合甚至可能是有益的！</p><p id="75ee" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">假设我们有一个随机抽样的全国财富调查。我们有分布在全国各地的一组家庭的财富值，我们希望推断未调查地区的财富水平，以获得整个国家的完整财富数据。这里，目标仅仅是填充<em class="lr">空间间隙</em>。使用最近区域的数据进行训练肯定有助于更准确地填补空白！</p><p id="58ad" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果我们试图建立一个可推广的模型，也就是说，一个我们可以完全应用到另一个国家的模型，那就是另一回事了。<a class="ae jd" href="https://www.pnas.org/content/pnas/111/45/15888.full.pdf" rel="noopener ugc nofollow" target="_blank">【2】</a>在这种情况下，在训练期间利用空间自相关属性将很可能提高潜在的差模型的准确性。如果我们把这个看似不错的模型用在一个没有地面事实可以验证的领域，这尤其令人担忧。</p><h1 id="00bc" class="mg mh jg bd mi mj mk ml mm mn mo mp mq km mr kn ms kp mt kq mu ks mv kt mw mx bi translated"><strong class="ak"> <em class="ne">在scikit-learn上实现空间交叉验证</em> </strong></h1><p id="3a3e" class="pw-post-body-paragraph kv kw jg kx b ky my kh la lb mz kk ld le na lg lh li nb lk ll lm nc lo lp lq ij bi translated">为了解决这个问题，我们必须在培训和测试之间划分区域。如果这是一个正常的训练测试分割，我们可以很容易地为我们的测试数据过滤出一些区域。然而，在其他情况下，我们希望通过使用交叉验证来利用所有可用的数据。不幸的是，scikit-learn的内置CV函数随机或按目标变量分割数据，而不是按选择的列。考虑到我们的数据集包含地理编码的元素，可以实施一种变通方法。</p><p id="0173" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面的代码假设我们有一个带有行政边界的列(例如，城市、州、省)。如果你只有坐标，你可以先对数据进行技术上的聚类(比如用<a class="ae jd" href="https://scikit-learn.org/stable/modules/generated/sklearn.cluster.KMeans.html" rel="noopener ugc nofollow" target="_blank"> KMeans </a>，但是你最好先用一个像<a class="ae jd" href="https://geopandas.org/" rel="noopener ugc nofollow" target="_blank"> GeoPandas </a>这样的库把它们映射到一个带有行政边界的数据集上。(给它们分配一个像“城市”这样有意义的值，使结果更容易解释。)</p><pre class="ls lt lu lv gt nf ng nh ni aw nj bi"><span id="0ae4" class="nk mh jg ng b gy nl nm l nn no">from sklearn.model_selection import GroupKFold, cross_val_predict</span><span id="258a" class="nk mh jg ng b gy np nm l nn no">cities = df['city'].values</span><span id="b362" class="nk mh jg ng b gy np nm l nn no">group_kfold = GroupKFold(n_splits=5) </span><span id="597f" class="nk mh jg ng b gy np nm l nn no"># Generator for the train/test indices<br/>city_kfold = group_kfold.split(X, y, cities)  </span><span id="4d28" class="nk mh jg ng b gy np nm l nn no"># Create a nested list of train and test indices for each fold<br/>train_indices, test_indices = [list(traintest) for traintest in zip(*city_kfold)]<br/>city_cv = [*zip(train_indices,test_indices)]</span><span id="278a" class="nk mh jg ng b gy np nm l nn no">predictions = cross_val_predict(model, X, y, cv=city_cv)</span></pre><p id="8b73" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们有了一个CV或KFold对象，我们可以将它插入到Scikit-learn的许多交叉验证拟合函数中，如上面所示的<code class="fe nq nr ns ng b">cross_val_predict</code>，甚至可以使用参数网格搜索进行嵌套交叉验证，如<code class="fe nq nr ns ng b">RandomizedSearchCV</code>。虽然只有几行代码，但希望它能帮助第一次谷歌空间自相关的人。快乐造型！</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><p id="e85a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我非常感谢对实施、写作或直觉的反馈。有什么建议可以让这变得更好吗？请随时联系chiaraledesma@gmail.com或我的<a class="ae jd" href="https://www.linkedin.com/in/chiara-ledesma-772a0b139/" rel="noopener ugc nofollow" target="_blank"><em class="lr">LinkedIn</em></a><em class="lr">。</em></p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><h2 id="852c" class="nk mh jg bd mi oa ob dn mm oc od dp mq le oe of ms li og oh mu lm oi oj mw ok bi translated">参考</h2><p id="9c89" class="pw-post-body-paragraph kv kw jg kx b ky my kh la lb mz kk ld le na lg lh li nb lk ll lm nc lo lp lq ij bi translated">[1] R .洛夫莱斯、j .诺沃萨德和j .明肖。<a class="ae jd" href="https://geocompr.robinlovelace.net/spatial-cv.html" rel="noopener ugc nofollow" target="_blank">统计学习:空间CV </a> (2021)，用r进行地理计算。</p><p id="a097" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">[2] P. Deville等<a class="ae jd" href="https://www.pnas.org/content/pnas/111/45/15888.full.pdf" rel="noopener ugc nofollow" target="_blank">利用手机数据进行动态人口制图</a> (2014)，美国国家科学院院刊。</p></div></div>    
</body>
</html>