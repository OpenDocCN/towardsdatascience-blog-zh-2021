<html>
<head>
<title>Regression Splines in R and Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">R和Python中的回归样条</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/regression-splines-in-r-and-python-cfba3e628bcd?source=collection_archive---------5-----------------------#2021-10-03">https://towardsdatascience.com/regression-splines-in-r-and-python-cfba3e628bcd?source=collection_archive---------5-----------------------#2021-10-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="8c70" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">线性模型的扩展</h2><div class=""/><div class=""><h2 id="d7b8" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">这篇文章讨论了回归样条的基础知识以及R和Python中的实现。</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/1c0e1488d0a84cacaebfa80508ad97ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2nZMe1J9Q-CydF7m"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">卢卡斯·戴维斯在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="e673" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi me translated"><span class="l mf mg mh bm mi mj mk ml mm di"> T </span>线性模型之所以这样命名，是因为输入(自变量)和输出(因变量)之间存在线性关系。尽管我们知道现实世界的数据很有可能表现出非线性，但人们通常会将线性模型视为最佳选择之一。</p><p id="614a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">原因主要有两点。首先，通过可接受的近似，线性模型是解释起来最简单的模型之一。第二，线性模型的低复杂性使得它不太可能过度拟合数据，尤其是当你有小的n(样本大小)和大的p(可变数)时。</p><p id="fb3c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果来自线性模型的估计偏差太大而无法接受，我们需要在我们的模型中超越线性。这并不意味着我们必须直接进入神经网络，因为那里有许多更简单的模型，复杂性(方差)更低。</p><h2 id="b9ad" class="mn mo it bd mp mq mr dn ms mt mu dp mv lr mw mx my lv mz na nb lz nc nd ne iz bi translated">多项式回归的概念</h2><p id="c3ca" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">“超越线性”的最直接的方法是简单地提高预测器的等级。例如，三次回归使用X、X和X作为预测值。“立方”意味着模型中变量X的最高幂是3。三次回归模型的训练也非常简单，它估计X、X和X的系数，就像我们在具有三个独立变量的简单线性模型中所做的那样。这些提高原始预测能力的非线性模型被称为多项式回归模型。</p><p id="ffd4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">多项式回归模型实际上是基函数方法的一个特例。基函数使用应用于x的变换:b₁(X)、b₂(X)、b₃(X)、…、Bk(X)作为新变量，而不是线性模型中的x。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/374aefe14fc4c9d91d161a80548e435f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*tHCcFSqsmU4FwYf1MVUlxA.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">基函数方法。(图片来自James，Gareth等人<em class="nl">统计学习入门</em>。第112卷。纽约:施普林格，2013年。)</p></figure><p id="5d23" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">对于多项式回归，基函数是bj(x) = x^j.</p><p id="c36c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在实践中，多项式回归模型的缺点之一是它用单个多项式函数来拟合整个训练数据。在这种情况下，为了跟踪跨越整个X范围的大多数数据点，模型曲线将会超级波动(我们讨论的是只有一个自变量X的情况)。换句话说，单一多项式模型需要高次项(如X⁵)才能如此灵活。多项式模型的次数越高，模型在边界处越不稳定。</p><p id="edd2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">其中一个解决方案是使用分段多项式模型，将变量的范围分成几个不同的<strong class="lk jd">局部</strong>区域，在每个区域内，一个多项式函数与数据拟合。然而，这种类型的分段多项式有一个主要问题:它在节点(局部区域边界)是不连续的。</p><h2 id="a0c2" class="mn mo it bd mp mq mr dn ms mt mu dp mv lr mw mx my lv mz na nb lz nc nd ne iz bi translated">回归样条的概念</h2><p id="a14b" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">如果我们强制(约束)分段多项式在节点处平滑连接，我们得到一种新的方法，称为<strong class="lk jd"> <em class="nm">回归样条</em> </strong>。这里的光滑节点意味着两个分段函数在节点处是连续的，在一阶和二阶导数处也是连续的。<em class="nm">“统计学习简介”</em>中的一张图很好地说明了这个概念，如下所示。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nn"><img src="../Images/dd9aa5d352ad5fb1f35a1441b6341b3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hf3Jx1D94won7DoL-onh1w.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">分段三次:不局限于连续；连续分段三次:只约束有连续值；三次样条:被约束为在节点处具有连续值，并且在一阶和二阶导数中也是连续的。线性样条:在节点处具有连续性的线性函数。</p></figure><p id="5e50" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在上面的图中，我们可以看到回归样条(左下角)在节点处产生了一个平滑的连接。如果我们只将分段函数约束为连续的，那么接合点看起来就不那么平滑了，如右上图所示。</p><p id="4a66" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">类似于多项式回归的基表示，回归样条也可以由基函数表示。让我们用K结的三次样条作为例子模型。它可以被框定为</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi no"><img src="../Images/7aed71180f615ae5a81a34f5fcaa9c65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*tL3RkcqwpJHq6CBAU7U0Gg.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">表示带有K个节点的三次样条的基本模型。(<em class="nl">《统计学习概论》</em>)</p></figure><p id="2962" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">三次样条的基函数总数为<strong class="lk jd"> <em class="nm"> K+3 </em> </strong>，这里我们在最小二乘回归中使用<strong class="lk jd"> <em class="nm"> K+3 </em> </strong>预测器。与简单的三次模型相比，它具有<strong class="lk jd"> <em class="nm"> K </em> </strong>额外的预测值(X、X和X作为三个预测值)，因为这些额外的函数用于调整节点处的变化。</p><p id="6fba" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">三次样条中最常用的基函数之一是<strong class="lk jd"> <em class="nm">截断幂基函数</em> </strong>定义为，</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi np"><img src="../Images/e5bfb829b841a7f5e45e0db95176c1f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*lG8Z9CMpdR5L-yrHRNtWsA.png"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">截断的幂基函数，(图片来自“<em class="nl">统计学习简介</em>”)</p></figure><p id="c5f9" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">其中ξ是结。</p><p id="3a2b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">所以，总的来说，三次样条有以下预测值，X，X2，X3，h(X，ξ1)，h(X，ξ2)，...，h(X，ξK)。</p><p id="40c7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">不要被截断的幂基函数吓到。它的概念很简单，就像一个开关，当X大于它对应的纽结时，这个开关就打开了。</p><p id="f5c3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">很难直接想象三次样条中的函数，所以让我们看看1次样条的动画。下面的GIF来自<a class="ae lh" href="https://stats.stackexchange.com/questions/433458/spline-basis-function-notation-to-include-constraint-for-continuity-at-the-knots" rel="noopener ugc nofollow" target="_blank">这篇伟大的文章</a>，用来说明截断的幂函数是如何打开的。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/15740665a11e86de137fc87779216351.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*cO6ARTBZTBBxZMlM.gif"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">图来源:<a class="ae lh" href="https://stats.stackexchange.com/questions/433458/spline-basis-function-notation-to-include-constraint-for-continuity-at-the-knots" rel="noopener ugc nofollow" target="_blank">https://stats . stack exchange . com/questions/433458/spline-basis-function-notation-to-include-constraint-for-continuity-at-the-knots</a></p></figure><p id="121b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">黑色曲线的转折点准确显示了结的位置。在上面的图中总共有四个结，因此有四个额外的截断幂函数用四条彩色虚线突出显示。</p><p id="461b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">当我们看三次样条中的截断幂函数时，也是同样的想法。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/02776d5588432242bc26015c49c4f543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*bjNR_OH8Dg5e1ySD.gif"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">图来源:<a class="ae lh" href="https://stats.stackexchange.com/questions/433458/spline-basis-function-notation-to-include-constraint-for-continuity-at-the-knots" rel="noopener ugc nofollow" target="_blank">https://stats . stack exchange . com/questions/433458/spline-basis-function-notation-to-include-constraint-for-continuity-at-the-knots</a></p></figure><p id="dcb2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在黑色曲线中也有四个“转折点”,并且当X大于相应的结时，每个截断的幂函数被打开。</p><p id="3ad4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">回归样条的缺点之一是当X很小或很大(在边界区域)时，回归样条的方差很大。这可以通过向模型添加边界约束来解决，其中我们强制模型在边界区域是线性的(X的1度)。这也叫做<strong class="lk jd"> <em class="nm">自然样条</em> </strong>。因为这不是本文的重点，我们将在以后的文章中讨论。</p><h2 id="103e" class="mn mo it bd mp mq mr dn ms mt mu dp mv lr mw mx my lv mz na nb lz nc nd ne iz bi translated">回归样条的实现</h2><p id="1d40" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">好了，在了解了回归样条的基本概念之后，让我展示一下R和Python中的实现。</p><p id="177b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">幸运的是，已经为回归样条函数建立了函数，所以标准实现在R和Python中都非常简单。我将只展示基本的实现，但是您可能需要在实际情况下修改代码。</p><p id="c2da" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在<strong class="lk jd"> <em class="nm"> R </em> </strong>中，我们将使用示例数据集<strong class="lk jd"> <em class="nm">工资</em> </strong>中的<a class="ae lh" href="https://www.statlearning.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="lk jd"> ISLR </strong> </a>。执行回归样条的R包是<a class="ae lh" href="https://www.rdocumentation.org/packages/splines/versions/3.6.2" rel="noopener ugc nofollow" target="_blank"> <strong class="lk jd"> <em class="nm">样条</em> </strong> </a>。</p><pre class="ks kt ku kv gt nr ns nt nu aw nv bi"><span id="e935" class="mn mo it ns b gy nw nx l ny nz">library(splines)<br/>library(ISLR)<br/>attach(Wage)<br/>spl_mod &lt;- lm(wage ~ bs(age, knots = c(30,50)), data = Wage)</span></pre><p id="9226" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">其中函数<strong class="lk jd"> <em class="nm"> bs() </em> </strong>生成样条基函数的整个矩阵，<strong class="lk jd"> <em class="nm">节点</em> </strong>取X中节点的位置(此处为变量<strong class="lk jd"> <em class="nm">年龄</em> </strong>)，<strong class="lk jd"> <em class="nm">数据=工资</em> </strong>指定数据源，<em class="nm">工资~ </em>表示因变量为<strong class="lk jd"> <em class="nm">工资</em> </strong>(变量名)，以及<strong class="lk jd"> 【T23)</strong></p><p id="447a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然后，我们可以通过以下方式检查拟合参数:</p><pre class="ks kt ku kv gt nr ns nt nu aw nv bi"><span id="8bb2" class="mn mo it ns b gy nw nx l ny nz">summary(spl_mod)</span></pre><p id="f5f6" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在<strong class="lk jd"> <em class="nm"> Python </em> </strong>中，我们不能像在<strong class="lk jd"> <em class="nm"> R </em> </strong>中那样用一行代码编写，而是需要先生成样条的基函数矩阵，然后用线性回归模型拟合。</p><p id="5f72" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们需要几个统计模型包，</p><pre class="ks kt ku kv gt nr ns nt nu aw nv bi"><span id="af84" class="mn mo it ns b gy nw nx l ny nz"><strong class="ns jd">import pandas as pd<br/>import numpy as np<br/>import statsmodels.api as sm<br/>from patsy import dmatrix</strong></span><span id="9647" class="mn mo it ns b gy oa nx l ny nz"><br/>df = pd.read_csv('Wage.csv')<br/>basis_x = dmatrix("bs(df.age, knots=(30,50), degree=3, include_intercept=False)", {"df.age": df.age}, return_type='dataframe')<br/></span></pre><p id="24b7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">其中<strong class="lk jd"> <em class="nm"> df </em> </strong>是<strong class="lk jd"> <em class="nm">工资</em> </strong>数据集，<strong class="lk jd"> <em class="nm"> basis_x </em> </strong>是基函数的矩阵，<strong class="lk jd"> <em class="nm"> bs </em> </strong>是生成基函数的函数。装配步骤是，</p><pre class="ks kt ku kv gt nr ns nt nu aw nv bi"><span id="3986" class="mn mo it ns b gy nw nx l ny nz">spl_mod = sm.GLM(df.wage, basis_x).fit()</span></pre><p id="cb66" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们可以通过以下方式检查拟合参数:</p><pre class="ks kt ku kv gt nr ns nt nu aw nv bi"><span id="3662" class="mn mo it ns b gy nw nx l ny nz">spl_mod.params</span></pre><p id="ae53" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">就是这样。</p><p id="bb1a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果你完全理解回归样条的思想，R/Python代码只是小菜一碟，因为你所需要的是首先将X变换为基函数矩阵，然后拟合一个简单的线性回归。</p></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><p id="cf14" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">干杯！希望这篇短文有帮助。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oi"><img src="../Images/9b189d9c37b85fa3e5b74d796e2bcca2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*T0cqgJCr_ku-7ZSE"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">照片由<a class="ae lh" href="https://unsplash.com/@yutacar?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Yutacar </a>在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div></div>    
</body>
</html>