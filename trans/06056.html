<html>
<head>
<title>How to test your Spark Scala code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何测试你的Spark Scala代码</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-test-your-spark-scala-code-268e5de471fd?source=collection_archive---------8-----------------------#2021-05-31">https://towardsdatascience.com/how-to-test-your-spark-scala-code-268e5de471fd?source=collection_archive---------8-----------------------#2021-05-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="124c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">让我们使用Mockito和scalatest为Spark Scala数据帧转换编写一些测试</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fbdd79501ce32ecdc0af0f84aac682ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1PVk34MALRt1SKP4-9Hjyg.jpeg"/></div></div></figure><p id="2479" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">克里斯托夫·高尔在<a class="ae ln" href="https://unsplash.com/s/photos/code?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p><p id="6ef0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Spark转换的单元测试可能很棘手，可能你甚至不能编写try单元测试(<a class="ae ln" href="https://stackoverflow.com/a/43769845/5444759" rel="noopener ugc nofollow" target="_blank">我喜欢stackoverflow </a>的这个回答)。然而，您需要以某种方式测试您的转换。我写了这段代码来分享我最近在这个问题上的经验以及我是如何解决这个问题的。</p><h1 id="9d9f" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">问题陈述:</h1><p id="9ee7" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">假设您的数据管道中有一个如下结构的对象:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="2110" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">它读取数据-&gt;转换数据-&gt;加载到某个存储。简单的ETL，很容易。现在让我们使用Mockito和scalatest为该对象编写一个测试。</p><h1 id="9675" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">写作测试</h1><p id="91d1" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">对于测试，我将使用<a class="ae ln" href="https://github.com/mockito/mockito-scala" rel="noopener ugc nofollow" target="_blank"> mockito-scala </a>和<a class="ae ln" href="https://www.scalatest.org/" rel="noopener ugc nofollow" target="_blank"> scalatest </a>库来使用它，您需要将它添加到您的build.sbt:</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="bbb8" class="ms lp iq mo b gy mt mu l mv mw">libraryDependencies ++= Seq(</span><span id="ee36" class="ms lp iq mo b gy mx mu l mv mw">"org.scalatest" %% "scalatest" % "3.2.2" % Test,</span><span id="9cb8" class="ms lp iq mo b gy mx mu l mv mw">"org.mockito" %% "mockito-scala" % "1.16.23" % Test)</span></pre><p id="1c44" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在实际的测试类:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ml mm l"/></div></figure><p id="10b7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">万岁，我们刚刚为我们的火花代码做了一个测试🎉🎉 🎉</p><h2 id="8daf" class="ms lp iq bd lq my mz dn lu na nb dp ly la nc nd ma le ne nf mc li ng nh me ni bi translated">让我们重复一下我们在这里所做的事情:</h2><ol class=""><li id="ba95" class="nj nk iq kt b ku mg kx mh la nl le nm li nn lm no np nq nr bi translated">我们用mockito模拟IO方法，所以我们没有加载实际的文件，而是不调用<em class="ns">loaddatafrombaute</em>方法，而是替换DataFrame，它通常会返回我们为测试准备的测试数据</li><li id="b238" class="nj nk iq kt b ku nt kx nu la nv le nw li nx lm no np nq nr bi translated">类似的事情发生在<em class="ns"> writeResultsToBucket </em>方法上，它从未被调用过</li><li id="b3bf" class="nj nk iq kt b ku nt kx nu la nv le nw li nx lm no np nq nr bi translated">我们用ArgumentCaptor捕获spark转换的结果。</li><li id="58a0" class="nj nk iq kt b ku nt kx nu la nv le nw li nx lm no np nq nr bi translated">我们使用简单的断言比较了转换的实际结果和预期结果</li></ol><h1 id="43a4" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">您可能会考虑的一些其他事项:</h1><p id="644d" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated"><strong class="kt ir">测试专用火花会议:</strong></p><p id="a62f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你可以从scalatest<em class="ns">(org . scalatest . BeforeAndAfter)</em>中使用before and after，请看这里的例子:<a class="ae ln" href="https://www.scalatest.org/getting_started_with_fun_suite" rel="noopener ugc nofollow" target="_blank">https://www.scalatest.org/getting_started_with_fun_suite</a></p><p id="66e3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">或者只为测试创建一个专用的spark会话。</p><p id="95c2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">如何比较数据帧:</strong></p><p id="b3d9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">比较数据帧的更好方法可能是借助spark-fast-tests库:<a class="ae ln" href="https://github.com/MrPowers/spark-fast-tests/" rel="noopener ugc nofollow" target="_blank">https://github.com/MrPowers/spark-fast-tests/</a></p><p id="b32d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">特别是如果出于某种原因你需要比较大的数据帧，那么这个库将会非常方便</p><p id="74c3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">测试数据:</strong></p><p id="550d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">上面描述的方法依赖于您需要为您的测试准备的数据样本，因为您可能不希望查询与您的生产代码稍后要做的一样多的数据。所以你可以做以下列表中的事情:</p><ul class=""><li id="bfbd" class="nj nk iq kt b ku kv kx ky la ny le nz li oa lm ob np nq nr bi translated">如果您的样本非常小，比如只有1-2列，请在存储库中保存一个小的数据样本</li><li id="da84" class="nj nk iq kt b ku nt kx nu la nv le nw li nx lm ob np nq nr bi translated">作为测试的一部分，随时生成数据，基本上将测试数据硬编码在scala代码中</li><li id="876d" class="nj nk iq kt b ku nt kx nu la nv le nw li nx lm ob np nq nr bi translated">将样本数据保存在某个远程存储桶中，并在测试期间加载它</li><li id="d0e2" class="nj nk iq kt b ku nt kx nu la nv le nw li nx lm ob np nq nr bi translated">最后，您可以从数据库中查询示例数据</li></ul><p id="3a99" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">每种选择都有其利弊，我个人更喜欢将测试数据以某种人类可读的格式存储在存储库中，比如JSON。但是这完全取决于你项目的具体情况。</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="8ee5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">感谢阅读！让我知道你的想法，以及你如何为spark编写测试？欢迎随时在</strong> <a class="ae ln" href="https://www.linkedin.com/in/aosipenko/" rel="noopener ugc nofollow" target="_blank"> <strong class="kt ir"> LinkedIn </strong> </a> <strong class="kt ir">，</strong><a class="ae ln" href="https://github.com/subpath" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">GitHub</strong></a><strong class="kt ir">或我的网站</strong><a class="ae ln" href="https://piece-data.com/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">piece-data.com</strong></a></p><h1 id="7210" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">参考资料:</h1><ol class=""><li id="7b19" class="nj nk iq kt b ku mg kx mh la nl le nm li nn lm no np nq nr bi translated">莫奇托-斯卡拉:<a class="ae ln" href="https://github.com/mockito/mockito-scala" rel="noopener ugc nofollow" target="_blank">https://github.com/mockito/mockito-scala</a></li><li id="a73b" class="nj nk iq kt b ku nt kx nu la nv le nw li nx lm no np nq nr bi translated">https://www.scalatest.org/</li><li id="16db" class="nj nk iq kt b ku nt kx nu la nv le nw li nx lm no np nq nr bi translated">火花快速测试:<a class="ae ln" href="https://github.com/MrPowers/spark-fast-tests/" rel="noopener ugc nofollow" target="_blank">https://github.com/MrPowers/spark-fast-tests/</a></li></ol></div></div>    
</body>
</html>