<html>
<head>
<title>Visualize hierarchical data using Plotly and Datapane</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Plotly和Datapane可视化分层数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/visualize-hierarchical-data-using-plotly-and-datapane-7e5abe2686e1?source=collection_archive---------5-----------------------#2021-06-01">https://towardsdatascience.com/visualize-hierarchical-data-using-plotly-and-datapane-7e5abe2686e1?source=collection_archive---------5-----------------------#2021-06-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="6612" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="4d7f" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">使用交互式图表探索嵌套很深的通货膨胀数据集</h2></div><p id="d785" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">按类别显示数据很容易——只要用一个不起眼的条形图或饼图就行了(尽管T2有一个关于哪个最好的100年历史的争论)。</p><p id="28b0" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">但是如果每个类别都有子类别呢？而那些子类别又有子子类别？这是许多领域中常见的数据模式，包括文件系统、生物学和经济学。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi ll"><img src="../Images/24b44bd36313899d68d14c031e34ea90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iv8KIzoWvOC6tSNOi0RS3w.jpeg"/></div></div><p class="lx ly gj gh gi lz ma bd b be z dk translated">照片由<a class="ae lk" href="https://unsplash.com/@niko_photos?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> niko photos </a>在<a class="ae lk" href="https://unsplash.com/s/photos/tree?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="e432" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在本文中，我们将介绍几种交互式显示嵌套数据的方法，并讨论每种方法的优缺点。</p><h1 id="adf0" class="mb mc iq bd md me mf mg mh mi mj mk ml kf mm kg mn ki mo kj mp kl mq km mr ms bi translated">数据:美国消费者价格指数(CPI)权重</h1><p id="4f3d" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">想知道通货膨胀是如何计算的吗？从本质上讲，政府将每月收集数千种普通商品的价格数据，根据重要性进行加权，并将它们组合成一个“篮子”，广泛代表普通家庭的支出。然后，他们跟踪这些项目的价格变化，以计算出经济的整体通胀水平。</p><p id="7a00" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这个篮子可以用来粗略衡量每个人是如何花钱的。这是一个有趣的数据集，因为数据自然是分层的:从最高层的类别如“食品”一直到单个产品如“多力多滋”。</p><p id="37d4" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">[警告:通货膨胀方法论是一门深奥的学问——要小心，否则你可能会在晦涩的政府统计网站上浪费掉几天的时间！]</p><p id="b467" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">为了进行这种探索，我们将根据美国劳工统计局<a class="ae lk" href="https://www.bls.gov/cpi/tables/relative-importance/home.htm#Archived%20Relative%20Importance%20Data" rel="noopener ugc nofollow" target="_blank">的公开数据</a>来研究美国消费者价格指数的不同类别和权重。数据来自Excel文件，具有以下特征:</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi my"><img src="../Images/4d4341508cbcebb86bd86ae772d9b0f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N6y-6ehdykJ61GZyZ02Ohg.png"/></div></div></figure><p id="de3e" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">该数据包含295个不同的类别，分布在8个不同的“缩进级别”，从1—“食品和饮料”( 15.16%重量)，到8 —“生牛肉末”(0.17%重量)。请注意，它并没有深入到单个产品。这些项目按层次排列，因此每个项目的权重将等于其子项权重的总和。</p><p id="781b" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们首先将数据加载到Pandas中，并做一些预处理。特别是，我们需要使用行索引和缩进级别来获取每一行的“父级”,因为许多图形库都需要这些信息。我们最终得到以下数据框架:</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi mz"><img src="../Images/87857edda74f1775ecb0ccea151ed839.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TBFYOEbhH04h00017xgUyQ.png"/></div></div></figure><p id="0bf0" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">让我们开始一些可视化！我们将使用Plotly创建交互式图表，并使用<a class="ae lk" href="http://datapane.com" rel="noopener ugc nofollow" target="_blank"> Datapane </a>使我们的图表具有交互性，因此用户可以自己探索数据。当您有复杂的数据，而这些数据又不容易用静态图表示时，这一点尤其重要。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="e46f" class="mb mc iq bd md me nh mg mh mi ni mk ml kf nj kg mn ki nk kj mp kl nl km mr ms bi translated"><strong class="ak"> 1。旭日图</strong></h1><p id="3520" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">我们将从Sunburst图表开始:一种高级类型的饼图，其中不同级别的数据表示为同心圆。</p><p id="08a9" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">使用Plotly制作旭日图非常简单:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="nm nn l"/></div></figure><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi no"><img src="../Images/e3862dd6cffc2060b96c1e1c166b4975.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FBaB_aGUcWbfrLr1Ric5bQ.png"/></div></div></figure><p id="6ce1" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">它在我的浏览器上交互显示，但当我试图将其复制到Medium时，它显示为静态图。不过不用担心，我们可以使用Datapane将图表上传到Datapane.com，然后共享或嵌入交互式报告:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="76dd" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">运行这段代码后，Datapane生成一个报告，我们可以通过URL查看我们的绘图:<a class="ae lk" href="https://datapane.com/u/johnmicahreid/reports/visualizing-deeply-nested-data/" rel="noopener ugc nofollow" target="_blank">https://data pane . com/u/johnmicahreid/reports/visualizing-deep-nested-data/</a></p><p id="e24a" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">此时，我们可以共享报告，或者直接嵌入报告，如下所示:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="np nn l"/></div></figure><p id="3547" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">回到分析，这个图表看起来很有趣，但很混乱，很难阅读深度嵌套的小权重类别。将它限制在两个级别看起来更好:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="np nn l"/></div></figure><p id="a11f" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">通过简化图表，你遗漏了信息，但这可能是一件好事。有效的数据可视化是向你的受众传达一个清晰的信息，你的图表越明显+简单，他们就越有可能理解。</p><p id="90c1" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">对于这张图表，我希望有人理解的故事如下:“哇，看起来住房成本是通货膨胀的最大因素！”</p><h1 id="36b4" class="mb mc iq bd md me mf mg mh mi mj mk ml kf mm kg mn ki mo kj mp kl mq km mr ms bi translated">2.树形图</h1><p id="f363" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">树状图类似于旭日图，只是它们以矩形形式表示数据。它们比旭日图有优势，因为图上每个矩形的面积与你要展示的数量成正比。</p><p id="7add" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">构建树状图使用的Plotly语法与sunburst完全相同:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="nm nn l"/></div></figure><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="np nn l"/></div></figure><p id="6179" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这要清楚得多，但是区域并不完全准确，因为一些空间被边界框和文本占据了。此外，一些嵌套很深的层次被切断，难以阅读。如果我们把情节限制在前两层，我们会得到一个更整洁的画面:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="np nn l"/></div></figure><h1 id="94a7" class="mb mc iq bd md me mf mg mh mi mj mk ml kf mm kg mn ki mo kj mp kl mq km mr ms bi translated">3.桑基图</h1><p id="02b9" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">另一种选择是桑基图，它最初被发明用来显示能量在系统中的传递。如果您想要显示经过几个不同阶段的数据，请使用它—唯一的建议是进入系统的“流量”应该等于流出系统的“流量”。</p><p id="ffcd" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">Plotly中的代码要复杂得多，因为我们需要将数据转换成不同的格式:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="nm nn l"/></div></figure><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="np nn l"/></div></figure><p id="77bc" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">与前两种情况相比，我们在这里看到了一个类似的信息密度问题——有太多的信息需要一目了然，较小的类别被极度压缩。Sankey图和sunburst/treemap之间的一个有趣的区别是在图的最右端显示所有没有子节点的节点的方式，即使它们有不同的缩进级别。</p><p id="3684" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">让我们再来看看前两个级别:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="np nn l"/></div></figure><p id="566e" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这更清楚，但我个人建议不要使用桑基图，除非你有真正令人信服的理由这样做，因为它们相当不直观，数据通常可以用更好的方式表示。</p><h1 id="c19d" class="mb mc iq bd md me mf mg mh mi mj mk ml kf mm kg mn ki mo kj mp kl mq km mr ms bi translated">4.图表</h1><p id="2bd8" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">从第一原理思考问题，我们的数据本质上是一个树形结构，树是一种图形。所以让我们试着把数据形象化为图表。</p><p id="c582" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这里的代码要复杂得多，因为我们需要将数据帧转换成一系列的边和节点。我们将使用<a class="ae lk" href="https://networkx.org/" rel="noopener ugc nofollow" target="_blank"> networkx </a>来转换和存储数据，并Plotly将其可视化。不再有高级API，所以我们将手动绘制每个节点和边。</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="nm nn l"/></div></figure><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="np nn l"/></div></figure><p id="4629" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">正如你从这个viz中看到的，图很好地表现了不同量之间的<strong class="kq ja">关系</strong>，并且可以轻松地适应许多不同的节点。唯一的缺点是，您需要将鼠标悬停在每个节点上才能读取该点的值。我们还可以尝试各种技巧，如使节点的大小与权重成比例，以及不同的节点定位算法，但结果开始看起来很奇怪。</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="np nn l"/></div></figure><h1 id="0665" class="mb mc iq bd md me mf mg mh mi mj mk ml kf mm kg mn ki mo kj mp kl mq km mr ms bi translated">5.其他选择</h1><p id="5c97" class="pw-post-body-paragraph ko kp iq kq b kr mt ka kt ku mu kd kw kx mv kz la lb mw ld le lf mx lh li lj ij bi translated">冰柱图是另一种可视化嵌套数据的好方法，基本上是一组堆叠的垂直条形图。我们可以在D3.js可视化库中看到一个很好的例子:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="nq nn l"/></div><p class="lx ly gj gh gi lz ma bd b be z dk translated">Mike Bostock的D3.js文档中的Icicle embed</p></figure><p id="a4e5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><a class="ae lk" href="http://www.brendangregg.com/flamegraphs.html" rel="noopener ugc nofollow" target="_blank">火焰图</a>是一个类似的概念，但是旋转了。它们是由Brandon Gregg发明的，作为一种分析软件性能的方法。这里X轴是时间，Y轴代表函数调用深度，每个矩形代表一个不同的函数调用。</p><figure class="lm ln lo lp gt lq gh gi paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="gh gi nr"><img src="../Images/78d3391f0cc2d99976a84faf3f873b07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EtMnqEAaj_FFzUFqPt5g2A.png"/></div></div><p class="lx ly gj gh gi lz ma bd b be z dk translated">来自<a class="ae lk" href="https://upload.wikimedia.org/wikipedia/commons/b/b5/MediaWiki_flame_graph_screenshot_2014-12-15_22.png" rel="noopener ugc nofollow" target="_blank">维基共享资源</a>的火焰图示例</p></figure><p id="14ab" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这两种方法似乎都比以前的方法在显示多层次嵌套方面做得更好，但不幸的是，我还没有找到任何优秀的Python库来制作它们！如果你有任何想法，请在评论中告诉我。</p><h1 id="dbb3" class="mb mc iq bd md me mf mg mh mi mj mk ml kf mm kg mn ki mo kj mp kl mq km mr ms bi translated">最后</h1><ul class=""><li id="4816" class="ns nt iq kq b kr mt ku mu kx nu lb nv lf nw lj nx ny nz oa bi translated">嵌套数据很难很好地可视化，如果可能的话，您应该尝试一次只显示两个级别。</li><li id="a43a" class="ns nt iq kq b kr ob ku oc kx od lb oe lf of lj nx ny nz oa bi translated">除非您的数据非常符合目的和/或您的点数相对较少，否则不要使用桑基图。</li><li id="4cb8" class="ns nt iq kq b kr ob ku oc kx od lb oe lf of lj nx ny nz oa bi translated">决定是显示每个类别的<strong class="kq ja">比例</strong>更重要，还是显示类别之间的<strong class="kq ja">关系</strong>更重要。如果是后者，那么图表可能是一个不错的选择。</li><li id="984c" class="ns nt iq kq b kr ob ku oc kx od lb oe lf of lj nx ny nz oa bi translated">如果你有JS技能，冰柱图是一个很好的选择</li></ul><p id="a928" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果你有兴趣自己试验一下，这里有一些数据:</p><figure class="lm ln lo lp gt lq"><div class="bz fp l di"><div class="np nn l"/></div></figure></div></div>    
</body>
</html>