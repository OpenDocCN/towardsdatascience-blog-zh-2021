<html>
<head>
<title>Creating an environment with Airflow and DBT on AWS (part 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在自动气象站上创造一个有气流和DBT的环境(第三部分)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/creating-an-environment-with-airflow-and-dbt-on-aws-part-3-2789f35adb5d?source=collection_archive---------11-----------------------#2021-06-15">https://towardsdatascience.com/creating-an-environment-with-airflow-and-dbt-on-aws-part-3-2789f35adb5d?source=collection_archive---------11-----------------------#2021-06-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d8d8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用DBT云和DBT整合气流</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e47561ce002e17a2b704521e39744d99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VNsmeiC2t5yj8b7Q"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@realaxer?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">田宽</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="21bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" rel="noopener" target="_blank" href="/creating-an-environment-with-airflow-and-dbt-on-aws-part-1-ca13bc95f479"> part1 </a>和<a class="ae kv" rel="noopener" target="_blank" href="/creating-an-environment-with-airflow-and-dbt-on-aws-part-2-a23617d56eeb"> part2 </a>中，我们创建并配置了我们的EC2实例，使用DBT和气流，并为两者创建了一个初始项目来测试它们。现在，我们将最终一起使用气流和DBT，首先在我们的实例上，然后将DBT切换到云版本，也在那里创建一个项目。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="789f" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak"> 1。使用气流运行dbt命令</strong></h1><p id="72d0" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">正如我们已经看到的，基本上，气流调度和编排我们可以用Python运行的任何类型的任务。我们还看到了如何用命令<em class="mw"> dbt run </em>运行DBT。因此，我们可以集成它们的一种方法就是简单地创建一个DAG，在我们的操作系统上运行这个命令。</p><p id="9b84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设您连接到EC2实例并使用airflow用户，创建一个DAG文件:</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="a7e0" class="nc ma iq my b gy nd ne l nf ng">$ vi ~/airflow/dags/load_users.py</span></pre><p id="b928" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，添加以下代码:</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="6a77" class="nc ma iq my b gy nd ne l nf ng">from airflow import DAG<br/>from airflow.operators.bash import BashOperator</span><span id="ad02" class="nc ma iq my b gy nh ne l nf ng">import datetime</span><span id="fc5e" class="nc ma iq my b gy nh ne l nf ng">default_args = {<br/>    'start_date': datetime.datetime(2021,1,1)<br/>}</span><span id="f586" class="nc ma iq my b gy nh ne l nf ng">def run_dbt(task_id, command):<br/>    return BashOperator(<br/>        task_id=task_id,<br/>        bash_command='cd /home/airflow/dbt; ' + command,<br/>        do_xcom_push=False<br/>    )</span><span id="2d70" class="nc ma iq my b gy nh ne l nf ng">with DAG('load_user',<br/>    schedule_interval="@daily",<br/>    default_args=default_args, catchup=False) as dag:</span><span id="d215" class="nc ma iq my b gy nh ne l nf ng">    load_user = run_dbt('load_user', 'dbt run')</span></pre><p id="8f03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">DAG内的任务运行bash命令<em class="mw"> dbt运行</em>，使用Airflow的BashOperator。就像我们在终端上执行了命令一样。这里，我们必须从DBT文件夹(包含dbt_project.yml和其他目录的文件夹)运行这个命令，因此我们创建一个函数(run_dbt)来返回一个操作符，该操作符添加了移动到目录(' cd /home/airflow/dbt ')所需的命令。我们可以在运行dbt run时使用'- project-dir '来指定正确的路径，但我认为如果您有其他dbt命令来运行您的任务，这种方式会更简单。</p><p id="7659" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">保存文件后，您所要做的就是等待，直到新的DAG加载到web服务器中(在您的web浏览器中运行的气流)。当它是，打开开关和DAG将被执行。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/f43ac836ae514e810c641e01e4ced493.png" data-original-src="https://miro.medium.com/v2/resize:fit:562/format:webp/1*uXB3H09P3KxTGOtYu2GBmA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们的DAG运行DBT(只有一个DAG，因为我按名称过滤，好吗？)</p></figure><p id="39ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">单击DAG名称并转到图表视图。您的任务可能正在执行中(标有浅绿色)。几秒钟后，该任务将被标记为深绿色，表示成功。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/dc4f199597f08eeb620625253c4da26e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gZgPagBeNHlagf4_qfBqAA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们的dbt任务由气流执行</p></figure><p id="601a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您单击该任务并打开日志，您将看到与从终端运行DBT相同的输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/2038dfed62753e770b6795862af5f73c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hi1Ebyz5jR0KNF_D4nudzQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">输出显示了我们拥有的每个模型的执行情况(由DBT创建的每个表/视图)</p></figure><p id="2dd7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于DBT安装在Airflow的同一台机器上，我们可以只运行dbt命令来调用这个实例中的操作系统。如果您在另一台计算机上安装了DBT，您还可以使用不同的方法来远程运行该命令，例如，使用Airflow SSH Operator。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="c9ed" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">2.在DBT云上创建项目</h1><p id="53c7" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">现在，我们还可以选择不安装DBT。使用DBT云，我们可以在那里创建我们的项目，并使用他们的基础设施运行我们的工作。为此，你必须在DBT页面(<a class="ae kv" href="https://cloud.getdbt.com/login/" rel="noopener ugc nofollow" target="_blank">https://cloud.getdbt.com/login</a>)上创建一个账户。</p><p id="c21d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在登录之前，我们需要做两件事。</p><p id="3838" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，转到RDS数据库使用的安全组的规则。编辑入站规则并添加另外三个规则，所有规则的类型都是PostgreSQL，使用IP 52.45.144.63、54.81.134.249和52.22.161.231。这些IP是DBT云使用的IP，需要允许DBT连接到我们的数据库:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/9460190371a7c580b1d94a4469217f5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kjUaNwqusYNXw-Tbm85-Kw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">添加规则，以便DBT可以在我们的数据库中运行作业</p></figure><p id="ad7c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们必须做的另一件事是创建一个模式和一个用户来开发我们的DBT云项目。该用户将仅用于开发。它必须能够访问模式data_lake中的源表。此外，它将在新模式上创建表和视图(这个模式是专门为这个用户创建的)，所以它也需要拥有这个权限。因此，使用admin用户运行下面的SQL代码:</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="2909" class="nc ma iq my b gy nd ne l nf ng">create user dev_user with password '1234';<br/>create schema dbt_dev;<br/>grant all privileges on schema dbt_dev to dev_user;<br/>grant usage on schema data_lake to dev_user;<br/>grant select on all tables in schema data_lake to dev_user;</span></pre><p id="909d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好，现在回到DBT·佩奇。创建帐户后，当您第一次登录时，您会看到如下内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/1a2f2f90c632d5bb587325a1932632eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VIPA00gAhQl3l2nGdAAofg.png"/></div></div></figure><p id="f863" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们用它来配置我们的项目。单击继续。在下一页中，您将选择数据库类型。在我们的例子中，PostgreSQL，所以选择它。在下一页中，您必须建立与我们数据库的连接。选择任何你想要的名字。在PostgreSQL设置中，您将使用该信息连接到RDS数据库(与您用于连接DBeaver或SQL工具的值相同)。在开发证书中，使用我们的新用户和模式。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/adf565ddd92c2ad8867a7a1cc5a3f60d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*Ca2GWlfS7I_79IsCeUBXVw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">建立连接，在DBT云上开发我们的DBT项目</p></figure><p id="2de2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击继续。在下一页中，您可以选择使用Github/Bitbucket/Gitlab上的存储库。或者你可以使用由DBT管理的存储库。我们将使用后一种选择。因此，选择一个名称，单击创建，然后继续:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi no"><img src="../Images/c19ca9d971584a01512c49140ede310f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*A5Gy8pkCcResZ-lJ2yAq-A.png"/></div></figure><p id="c1fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下一页允许您邀请人们在项目中与您一起工作。现在，你可以点击跳过并完成。</p><p id="1046" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已经创建了我们的项目，DBT将显示此页面:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/9cdd2811dc6129be84e18048e8575050.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_2i0_ur7QWkIvD8sEAQuuQ.png"/></div></div></figure><p id="6af4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击开始开发，一个类似于IDE的页面就会打开。你需要做的第一件事是点击“初始化你的项目”。这将创建我们在DBT上运行作业所需的文件夹和文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/8aa0d3bd90bf581edb1d340f712a737b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Orx7_QL6I0Er9910f6kMuQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">开发页面，初始化项目后</p></figure><p id="8966" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，删除models中的example文件夹。在models中添加一个名为user.sql的新文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/7e2c9ca7717d49e20d498e352c3817be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ikF6_29IvlQC-4PruAuEQA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们在EC2实例上创建的相同模型，现在在DBT云上</p></figure><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="d711" class="nc ma iq my b gy nd ne l nf ng">select * from data_lake.user</span></pre><p id="6560" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">保存文件。在页面底部有一个运行命令的字段。键入“dbt run”并单击Enter(您可以在上图底部看到该字段)，您将得到以下输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/e85e595a731d0f221549f078cddd2619.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HjpQKOE1piHWIjaMOkU12A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在DBT云IDE上运行作业</p></figure><p id="0a0b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是我们如何通过DBT开发我们的数据转换。现在，假设我们想在生产环境中使用这段代码。仍然在开发页面中，单击提交并添加一些消息。现在，我们的代码在主分支中(请记住，您可以使用Github/Bitbucket/Gitlab并以更好的方式管理存储库和分支)。</p><p id="0d40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以一直使用我们的数据库主用户，但是为了更真实，在上一部分中，我们使用了一个用户，该用户只具有从我们的源模式(data_lake)读取数据的权限，并且对它自己的模式dbt_dev具有所有特权。</p><p id="a679" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，为了在“生产”环境中运行我们的作业，让我们创建另一个具有必要权限的用户。我们需要从模式data_lake中读取数据的权限，就像前面的用户一样。我们还需要在模式data_warehouse中创建对象的权限(我们的模型将在那里创建)。最后，由于在第2部分中我们已经创建了data_warehose.user表，现在我们将删除它，这样DBT重新创建它不会有任何问题。因此，使用admin用户运行以下SQL代码:</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="3448" class="nc ma iq my b gy nd ne l nf ng">create user prd_user with password '1234qwer';<br/>grant all privileges on schema data_warehouse to prd_user;<br/>grant usage on schema data_lake to prd_user;<br/>grant select on all tables in schema data_lake to prd_user;<br/>drop table data_warehouse.user;</span></pre><p id="c55b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，单击左上角的菜单，选择“环境”,然后单击“新建环境”。为环境选择一个名称，并使用我们的新用户、密码和模式data_warehouse配置连接(记住，在这个模式中，我们将使用查询结果创建对象)。不要更改其他选项。但是请注意，这里DBT云派上了用场，因为您可以选择一个自定义分支，并在将代码推送到主服务器之前运行作业。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/fd437f08a2a71cd2c3d9cb86adb6287c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qNGX8CUcEZWRvw3Y6Gm_QA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">DBT云使创建新环境、与分支机构合作变得更加容易</p></figure><p id="ce0b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建环境后，您将看到environment页面，其中还没有作业。点击新工作。</p><p id="a02d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为作业选择一个名称。在环境选项中，选择您将拥有的唯一选项。在线程中，我使用的是10，但是现在这并没有什么区别。不要更改其他选项。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/32955e89cd5b5d47fd45296debdea571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xRfgolZ8fvCIXnlKVPnmAA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创造我们的工作</p></figure><p id="64e2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">向下滚动，我们看到了将要运行的命令。由于我们的项目只有一个模型，当我们运行DBT时，这是唯一要处理的文件。但是如果您有一个更大的项目，并且只想运行您的模型的一部分，您可以过滤路径、标签和其他选项。请查阅DBT文档来探索这一点。</p><p id="b043" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该页面中还有一个选项是调度作业。我们将使用气流来完成这项工作，因此您可以取消选中“按计划运行？”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/eef892d4ebc7a9ef1f30e55a5e51aa62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E2hZMd2_3ILdN8nihmpYaQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">您可以通过DBT云直接安排工作，但只能安排您管道中的DBT部分</p></figure><p id="96e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">之后，点击页面顶部的保存。在下一页中，单击立即运行。您可能需要等待一段时间才能让您的工作正常运行。DBT将在10秒内从10重新加载页面。过一会儿，您的作业将运行并显示以下结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/d5c0da10b36312d90e00273396565317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bq96LNoze6zj6wdhpTmDjQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作业在DBT云上运行(在dbt运行之前有几个步骤)</p></figure><p id="ce82" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些步骤的最后一步是dbt run命令。单击它，您将看到我们已经知道的输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/0e517ab7c56d0ba1a6c9dc781b3e244c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rde59ntQlcqZ8zLF-5I_6A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">dbt运行命令的相同输出</p></figure><p id="b5f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已经看到了如何在我们的实例上运行DBT，如何使用气流来调度它，以及如何在DBT云上运行DBT。唯一缺少的部分是如何使用气流来运行DBT云作业。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="979c" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">3.使用气流在DBT云上运行作业</h1><p id="5293" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">为了用气流运行我们的工作，我们将使用DBT云API。因此，我们需要做的就是将适当的代码放在我们的DAG上，并像以前一样执行相同的调度。</p><p id="fbd7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，让我们得到一些我们需要的数据。在我们使用的最后一个页面中，通过我们的作业，单击作业名称。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/0ac65fa75d3f996cfc81643244583206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XjxDCloCFPwbYzpef7Erhw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">工作页面的链接，在这里我们可以找到工作id</p></figure><p id="71e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，通过浏览器上的URL，检查您的帐户和该作业的id。例如，在我的例子中，URL是<a class="ae kv" href="https://cloud.getdbt.com/#/accounts/19964/projects/32821/jobs/25507/" rel="noopener ugc nofollow" target="_blank">https://cloud . get dbt . com/#/accounts/19964/projects/32821/jobs/25507/</a>。意思是我的账号id是19964，工作id是25507。</p><p id="2e76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，转到右上角的菜单，单击个人资料。然后选择API访问。然后点击显示。这是您的API密钥，将用于向DBT API发出请求。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/8df4e57ec7bf49992d0de3682ac6df46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9jj4Uj16Ysg6ymxozwa-oQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">这是您找到API密钥的地方</p></figure><p id="4998" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，使用VSCode通过airflow用户连接到您的EC2实例。转到文件&gt;打开文件夹。选择气流，你会有路径'/home/airflow/airflow '。按回车键。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/e41f45d343609f0c7b45109ee80bc706.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*W_zK5j42fMtLj0qAv0QkpA.png"/></div></figure><p id="b319" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">右键单击dags文件夹，创建一个名为load_users_cloud.py的新文件:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/79a91dd737541fa62e59e4d7942a708d.png" data-original-src="https://miro.medium.com/v2/resize:fit:530/format:webp/1*mPvGxbmGLaECDiWTyGtqHg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">您可以使用VSCode的接口而不是终端来创建项目文件</p></figure><p id="4beb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，复制下面的代码，需要时使用自己的API键(而不是*****)、帐户id和作业id。</p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="69bb" class="nc ma iq my b gy nd ne l nf ng">from airflow import DAG<br/>from airflow.providers.http.operators.http import SimpleHttpOperator</span><span id="e1c6" class="nc ma iq my b gy nh ne l nf ng">import datetime, json</span><span id="40d5" class="nc ma iq my b gy nh ne l nf ng">default_args = {<br/>  'start_date': datetime.datetime(2021,1,1)<br/>}<br/>dbt_header = {<br/>  'Content-Type': 'application/json',<br/>  'Authorization': 'Token *****'<br/>}</span><span id="2446" class="nc ma iq my b gy nh ne l nf ng">def getDbtMessage(message):<br/>  return {'cause': message}</span><span id="f8b3" class="nc ma iq my b gy nh ne l nf ng">def getDbtApiLink(jobId, accountId):<br/>  return 'accounts/{0}/jobs/{1}/run/'.format(accountId, jobId)</span><span id="5263" class="nc ma iq my b gy nh ne l nf ng">def getDbtApiOperator(task_id, jobId, message='Triggered by Airflow', accountId=19964):<br/>  return SimpleHttpOperator(<br/>    task_id=task_id,<br/>    method='POST',<br/>    data=json.dumps(getDbtMessage(message)),<br/>    http_conn_id='dbt_api',<br/>    endpoint=getDbtApiLink(jobId, accountId),<br/>    headers=dbt_header<br/>  )</span><span id="ff53" class="nc ma iq my b gy nh ne l nf ng">with DAG('Our_medium_project',<br/>  schedule_interval="@daily",<br/>  default_args=default_args,<br/>  catchup=False) as dag:</span><span id="7468" class="nc ma iq my b gy nh ne l nf ng">  load_user_cloud = getDbtApiOperator('load_users', 25507)</span></pre><p id="406c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里，我们使用SimpleHttpOperator向API发出POST请求。getDbtApiOperator函数简化了我们创建操作符的方式。我们只需要为任务和作业id定义一个名称。如果我们在单个DAG中使用多个DBT云帐户，我们还可以定义一条在DBT上显示的作业执行消息，不过我使用的是默认值和accountID。</p><p id="151c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">保存文件并在浏览器上打开Airflow。转到管理&gt;连接。单击+添加新连接。</p><p id="024d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Conn Id中，使用dbt_api(如果使用不同的名称，还必须在上面的代码中切换名称)。在连接类型中，选择HTTP。在主机中，使用“【https://cloud.getdbt.com/api/v2/】T2”(不带引号)。保存连接。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/9f9591720b5c313e37a503dba0130209.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oRWKx1q1ooKtcKE5Ft25LA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">设置与DBT API的连接</p></figure><p id="3bba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，转到DAGs页面。为我们的新DAG打开开关。几秒钟后，你会看到深绿色的指示器，显示我们的任务被执行了。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/fca8bf83c39df8dcdd0ec75c69ad3cd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fqPp1p-0rEsl250rrl_yXw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们负责DBT任务的狗</p></figure><p id="e402" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回到DBT云页面，到求职页面。您将在作业历史记录中看到一条新记录，其中包含我们在DAG中定义的消息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/0e9bf4d821ff9e8154770d86d7cf7a6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-cPDmxAk3cLhrKm5bf5TgQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作业历史，手动执行和从气流</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="289c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，现在我们可以使用气流来运行我们的DBT作业，无论是在服务器上使用DBT云还是DBT。尽管我使用的例子非常简单，但这里的重点是两种工具之间的集成。</p><p id="d33b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您已经使用了DBT，那么您应该知道如何处理您的作业，因此您可以简单地包含Airflow来调度作业，并集成与DBT无关的其他步骤，比如将数据移动到数据仓库。<br/>如果您已经使用了Airflow，并且需要在您的数据仓库中转换数据，您可以使用DBT来利用它在模型之间创建的引用来完成这项工作，而不是使用Airflow运行所有的SQL命令，创建临时表并使用它们。<br/>不管怎样，我希望这能有点用。</p><h1 id="5db5" class="lz ma iq bd mb mc oc me mf mg od mi mj jw oe jx ml jz of ka mn kc og kd mp mq bi translated">阅读本文的所有部分:</h1><p id="a5cc" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">第1部分:<a class="ae kv" rel="noopener" target="_blank" href="/creating-an-environment-with-airflow-and-dbt-on-aws-part-1-ca13bc95f479">启动一个实例并安装气流</a> <br/>第2部分:<a class="ae kv" rel="noopener" target="_blank" href="/creating-an-environment-with-airflow-and-dbt-on-aws-part-2-a23617d56eeb">安装DBT和一些设置以简化工作<br/> </a>第3部分:使用DBT云和将气流与DBT集成</p><h1 id="3bd3" class="lz ma iq bd mb mc oc me mf mg od mi mj jw oe jx ml jz of ka mn kc og kd mp mq bi translated">参考资料:</h1><p id="0fdc" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated"><a class="ae kv" href="https://www.getdbt.com/" rel="noopener ugc nofollow" target="_blank"><em class="mw">https://www.getdbt.com/<br/></em></a><a class="ae kv" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"><em class="mw">https://airflow.apache.org/<br/></em></a><a class="ae kv" href="https://docs.getdbt.com/dbt-cloud/api" rel="noopener ugc nofollow" target="_blank"><em class="mw">https://docs.getdbt.com/dbt-cloud/api<br/></em></a><a class="ae kv" href="https://docs.getdbt.com/reference/node-selection/syntax" rel="noopener ugc nofollow" target="_blank"><em class="mw">https://docs.getdbt.com/reference/node-selection/syntax</em></a><em class="mw"><br/></em><a class="ae kv" href="https://airflow.apache.org/docs/apache-airflow-providers-http/stable/operators.html" rel="noopener ugc nofollow" target="_blank"><em class="mw">https://air flow . Apache . org/docs/Apache-air flow-providers-http/stable/operators . html</em></a></p><p id="bdfc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">对我在这里所做的事情最有帮助的来源:<br/></strong><a class="ae kv" href="https://www.datascienceacademy.com.br/" rel="noopener ugc nofollow" target="_blank"><em class="mw">https://www.datascienceacademy.com.br</em></a>(葡萄牙语)<br/><a class="ae kv" href="https://docs.getdbt.com/docs/introduction" rel="noopener ugc nofollow" target="_blank"><em class="mw">https://docs.getdbt.com/docs/introduction</em></a></p></div></div>    
</body>
</html>