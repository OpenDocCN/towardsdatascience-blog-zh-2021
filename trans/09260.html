<html>
<head>
<title>How to handle dates in SQL using in-built functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用内置函数在SQL中处理日期</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-handle-dates-in-sql-using-in-built-functions-d6ca5a345e6d?source=collection_archive---------18-----------------------#2021-08-27">https://towardsdatascience.com/how-to-handle-dates-in-sql-using-in-built-functions-d6ca5a345e6d?source=collection_archive---------18-----------------------#2021-08-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d69b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">日期函数是SQL编程中谈论最多的领域之一</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/480b828c8bb10ada34798b03335d5953.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mgAnihVPXJmDcA9w"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">埃德加·莫兰在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="7ec0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作为一名数据分析师，我用不同的时间粒度构建仪表板和报告，如每周、每月、每季度、每年。对于时间序列分析，我需要聚合数据中的时间戳。这就是日期函数发挥作用的地方。这些内置功能使分析师的任务变得更加容易。我无法想象没有内置日期功能的生活。</p><p id="c8d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">今天，我将专门讨论PostgreSQL附带的那些。但是几乎所有的SQL数据库都以某种形式支持这些。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="7f07" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是我的一些主要约会功能。</p><h2 id="ad4c" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">1.日期_trunc</h2><p id="4251" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">Date_trunc用于将日期截断为周、月、季度或年。此函数最广泛地用于创建时间序列和粒度级聚合。例如，如果您想要绘制KPI的趋势，如季度销售额、活跃用户、月订单等，可以使用该函数。</p><p id="6c24" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">语法:</strong></p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="074a" class="lz ma iq my b gy nc nd l ne nf">SELECT DATE_TRUNC('month',calendar_date) AS Month,<br/>       COUNT(DISTINCT USER) AS active_users<br/>FROM usage<br/>GROUP BY 1</span></pre><h2 id="3834" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">2.当前日期</h2><p id="bb6d" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">我认为这是我所有查询中最常用的函数。顾名思义，这个函数给出当前日期。几乎每次分析数据集时，我都会根据手头的问题将数据集限制在过去几年/几周/几个月，以缩短查询执行时间。这个函数通过获取当前日期来帮助我这样做，当前日期将成为我的结束日期，然后我提取相对于这个结束日期的开始日期。例如，让我们假设我想看看去年我的销售额逐月增长的情况。我可以使用current_date获得最近的一个月，然后从中减去12个月，得到完整的一年。</p><p id="121e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">语法:</strong></p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="fc6c" class="lz ma iq my b gy nc nd l ne nf">SELECT DATE_TRUNC('month',calendar_date) AS Month,<br/>       SUM(sales) AS monthly_sales<br/>FROM sales<br/>WHERE calendar_date BETWEEN DATE_TRUNC('month',CURRENT_DATE) -INTERVAL '12 Months' AND DATE_TRUNC('month',calendar_date)<br/>GROUP BY 1</span></pre><h2 id="727b" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">3.Datediff</h2><p id="a8a5" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">此函数给出您指定的日期部分中两个日期/时间戳之间的差异。您可以将日期部分指定为秒、分、小时、天、周、月、年等。例如，下面的查询根据用户开始和结束观看会话的时间，以分钟为单位计算电影观众人数。</p><p id="bf0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">语法:</strong></p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="72b0" class="lz ma iq my b gy nc nd l ne nf">SELECT DISTINCT movie,<br/>       SUM(datediff ('minutes',watch_start_time,watch_end_time)) AS watch_minutes<br/>FROM movie<br/>GROUP BY 1</span></pre><h2 id="85bb" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">4.日期_部分</h2><p id="97ed" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">date_part函数提取日期部分的值。例如，有时我必须从我的数据集中排除/突出周末数据来处理异常值。这个功能非常好地完成了这项工作。</p><p id="4562" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">语法:</strong></p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="d8ef" class="lz ma iq my b gy nc nd l ne nf">SELECT CASE<br/>         WHEN DATE_PART('dow',calendar_date) IN (1,6) THEN 'Weekend'<br/>         ELSE 'Weekday'<br/>       END AS time_of_week,<br/>       COUNT(DISTINCT session_id) AS sessions<br/>FROM sessions<br/>GROUP BY 1</span></pre><h2 id="b6a4" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">5.Trunc</h2><p id="5ccc" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">Trunc函数将时间戳截断为日期值。这类似于铸造一个时间戳。<br/> <strong class="ky ir">语法:</strong></p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="42bd" class="lz ma iq my b gy nc nd l ne nf">Select DISTINCT trunc(start_time) as day<br/>FROM usage</span></pre><h2 id="31e8" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">6.到时间戳</h2><p id="9ca9" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">这个函数将时间戳转换为带时区的时间戳。当我试图分析基于事件的数据时，我不得不使用它，其中一个数据源捕获UTC时区的数据，另一个数据源捕获本地时区的数据。默认情况下，会添加UTC/GMT时区。</p><p id="ace8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">语法:</strong></p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="35b5" class="lz ma iq my b gy nc nd l ne nf">SELECT to_timestamp('2011-12-18 04:38:15', 'YYYY-MM-DD HH24:MI:SS')</span></pre><p id="264e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">结果:</strong></p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="56ec" class="lz ma iq my b gy nc nd l ne nf">to_timestamp <br/>---------------------- <br/>2011-12-19 04:38:15+00</span></pre><h2 id="8ae7" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">7.Dateadd</h2><p id="9a21" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">Dateadd按指定的间隔递增日期或时间戳。例如，假设我们有一个数据集，其中包含一个持续时间为30分钟的在线测试的数据，该测试在30分钟后自动结束。如果我们只有每个考生的开始时间，我们可以使用dateadd来计算每个考生的结束时间。</p><p id="d006" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">语法:</strong></p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="4711" class="lz ma iq my b gy nc nd l ne nf">SELECT DATE_TRUNC('month',calendar_date) AS Month,<br/>       COUNT(DISTINCT USER) AS active_users<br/>FROM usage<br/>GROUP BY 1</span></pre><h2 id="d043" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">8.最后一天</h2><p id="b78f" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">Last_day返回包含给定日期的月份的最后一天的日期。例如，你可以用它来检查一年是否是闰年，一个季度的最后几天销售额如何变化，等等。</p><p id="8065" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">语法:</strong></p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="118b" class="lz ma iq my b gy nc nd l ne nf">SELECT DISTINCT year,<br/>       CASE<br/>         WHEN last_day ((year|| '-02-01')::DATE) = (year|| '-02-29')::DATE THEN 'Leap Year'<br/>         ELSE 'Not a leap Year'<br/>       END AS is_leap_year<br/>FROM years</span></pre><h2 id="776d" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">9.间隔</h2><p id="a280" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">Interval实际上是一个文字，而不是一个内置函数。这种文字允许您确定特定的时间段，如6个月、30天、45天、2周等。例如，在下面的例子中，我用它将一个纪元值转换成一个时间戳值。</p><p id="94d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">语法:</strong></p><pre class="kg kh ki kj gt mx my mz na aw nb bi"><span id="b249" class="lz ma iq my b gy nc nd l ne nf">SELECT epoch_time,<br/>       TIMESTAMP 'epoch' +(epoch_time*INTERVAL '1 seconds') AS date_time_value<br/>FROM date_time_data</span></pre><h2 id="9170" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">总结</h2><p id="5a19" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">在执行时间序列分析时，理解处理日期-时间数据类型的技术是极其重要的。我觉得SQL是一个在进一步分析之前尽可能清理数据集的好地方。通过学习这些函数，您将能够分析与趋势相关的数据，并在更短的时间内找到更深入的见解。</p><p id="b3cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望你尝试这些功能，并看到使用这些功能的好处。</p><p id="ef63" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你有任何问题或建议，请在评论区告诉我。</p><p id="1167" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读！</p><p id="6ba4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ng">下次见……</em></p></div></div>    
</body>
</html>