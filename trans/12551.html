<html>
<head>
<title>Query Pandas DataFrame with SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 SQL 查询熊猫数据帧</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/query-pandas-dataframe-with-sql-2bb7a509793d?source=collection_archive---------1-----------------------#2021-12-24">https://towardsdatascience.com/query-pandas-dataframe-with-sql-2bb7a509793d?source=collection_archive---------1-----------------------#2021-12-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0ee2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">熊猫里可以用 SQL 吗？是的，这就是方法。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3b3fe6f8b07a494ea621079d25cf9560.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W5zVX4pV6bmI-bMuazjbvA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae ky" href="https://www.pexels.com/photo/close-up-shot-of-a-panda-bear-7619816/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的<a class="ae ky" href="https://www.pexels.com/@hrvvv1994?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> .M.Q 黄</a>摄影</p></figure><h1 id="3570" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">动机</h1><p id="ac78" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Python 熊猫库和结构化查询语言(SQL)是数据科学家工具箱中最重要的工具之一。虽然 Pandas 是一个强大的数据操作工具，但是有许多数据科学家熟悉并喜欢使用 SQL 进行数据操作。在本文中，我们将研究如何使用带有<code class="fe mn mo mp mq b">pandasql</code>库的 SQL 来执行 Pandas 数据帧的数据操作。</p><h1 id="6f85" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Pandasql 是什么？</h1><p id="858f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Pandasql 是一个 python 库，允许使用 sql 操作 Pandas 数据帧。在幕后，Pandasql 从感兴趣的 Pandas 数据帧创建一个 sqlite 表，并允许用户使用 SQL 从 SQLite 表中进行查询。</p><h1 id="8d71" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Pandasql 是如何工作的？</h1><p id="8fab" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">安装 Pandasql 包。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="0ecf" class="mv la it mq b gy mw mx l my mz">!pip install -U pandasql</span></pre><p id="7233" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">导入必要的包。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="a78a" class="mv la it mq b gy mw mx l my mz">from pandasql import sqldf<br/>import pandas as pd<br/>from sklearn import datasets</span></pre><p id="90a8" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">我们使用 iris 数据集作为例子。<code class="fe mn mo mp mq b">df_feature</code>是包含特征的数据帧，而<code class="fe mn mo mp mq b">df_target</code>是包含目标的序列。Pandasql 可以在熊猫<code class="fe mn mo mp mq b">DataFrame</code>和<code class="fe mn mo mp mq b">Series</code>上运行。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="fa31" class="mv la it mq b gy mw mx l my mz">df_feature = datasets.load_iris(as_frame = True)['data']<br/>df_target = datasets.load_iris(as_frame = True)['target']</span><span id="edaa" class="mv la it mq b gy nf mx l my mz">print (type(df_feature))<br/>print (type(df_target))</span><span id="35c1" class="mv la it mq b gy nf mx l my mz">&gt;&gt; &lt;class 'pandas.core.frame.DataFrame'&gt;<br/>&gt;&gt; &lt;class 'pandas.core.series.Series'&gt;</span></pre><p id="8f83" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated"><code class="fe mn mo mp mq b">sqldf</code>方法用于查询数据帧，它需要 2 个输入:</p><ol class=""><li id="b008" class="ng nh it lt b lu na lx nb ma ni me nj mi nk mm nl nm nn no bi translated">SQL 查询字符串</li><li id="7565" class="ng nh it lt b lu np lx nq ma nr me ns mi nt mm nl nm nn no bi translated"><code class="fe mn mo mp mq b">globals()</code>或<code class="fe mn mo mp mq b">locals()</code>功能</li></ol><p id="f2ab" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">典型的查询如下所示，其中<code class="fe mn mo mp mq b">q</code>是 SQL 查询字符串。<code class="fe mn mo mp mq b">sqldf</code>返回数据帧中的结果。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="cbdd" class="mv la it mq b gy mw mx l my mz">q = "SELECT * FROM df_target LIMIT 3"<br/>sqldf(q, globals())</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/f340ed4750f4f81e459b5e04408dd00a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/0*HH9MzoMiQWUgWUf8"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="bab1" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated"><code class="fe mn mo mp mq b">globals()</code>和<code class="fe mn mo mp mq b">locals()</code>是 python 中内置的函数，用来存储函数和变量。让我们来看看<code class="fe mn mo mp mq b">globals()</code>函数是做什么的。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="c521" class="mv la it mq b gy mw mx l my mz">globals()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/09b75740a26e7b3a60fc1c7317fb0b99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2EqtbWRT0gPUqbqL"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="d1a6" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated"><code class="fe mn mo mp mq b">globals()</code>函数返回在该会话中创建的变量字典，如<code class="fe mn mo mp mq b">df_feature</code>和<code class="fe mn mo mp mq b">df_target</code>。字典的关键字是变量名，字典的值包含变量的实际值。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="e93f" class="mv la it mq b gy mw mx l my mz">print (globals().keys())</span><span id="ce0a" class="mv la it mq b gy nf mx l my mz">&gt;&gt; dict_keys(['__name__', '__doc__', '__package__', '__loader__', '__spec__', '__builtin__', '__builtins__', '_ih', '_oh', '_dh', '_sh', 'In', 'Out', 'get_ipython', 'exit', 'quit', '_', '__', '___', '_i', '_ii', '_iii', '_i1', '_exit_code', '_i2', 'sqldf', 'pd', 'datasets', '_i3', 'df_feature', 'df_target', '_i4', '_4', '_i5', '_5', '_i6'])</span></pre><p id="7ef1" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">由于<code class="fe mn mo mp mq b">globals()</code>函数输出一个字典，我们可以通过以下方式使用<code class="fe mn mo mp mq b">globals()</code>函数获取变量的访问值:</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="2e01" class="mv la it mq b gy mw mx l my mz">globals()['df_feature']</span></pre><p id="c77a" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">这将返回<code class="fe mn mo mp mq b">df_feature</code>数据帧。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/9790eb14b184b3ed1c1f3e2ff89e9002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/0*_qxl9dxX1-UAN77D"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h1 id="6f8d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">例子</h1><p id="188a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在我们已经了解了<code class="fe mn mo mp mq b">globals()</code>或<code class="fe mn mo mp mq b">locals()</code>函数如何与 Pandasql 一起工作，让我们来看一些例子。我们创建了一个名为<code class="fe mn mo mp mq b">pysqldf</code>的新函数，以避免每个查询都传入<code class="fe mn mo mp mq b">globals()</code>或<code class="fe mn mo mp mq b">locals()</code>。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="7166" class="mv la it mq b gy mw mx l my mz">pysqldf = lambda q: sqldf(q, globals())</span></pre><p id="2a76" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">我们可以用下面的方式简单地查询数据帧。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="bbe0" class="mv la it mq b gy mw mx l my mz">query = 'SELECT * FROM df_feature LIMIT 3'<br/>pysqldf(query)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/5f4e173950927ef733e21f38c9bb6f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/0*dMqrA6kh3_her2mr"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="c391" class="mv la it mq b gy mw mx l my mz">query = 'SELECT * FROM df_target LIMIT 3'<br/>pysqldf(query)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/0bbdb2ec141e5efa54ee6cd8abd336a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:164/0*90-UciJb8uh1HsAG"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="2606" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">让我们连接两个数据帧<code class="fe mn mo mp mq b">df_feature</code>和<code class="fe mn mo mp mq b">df_target</code>。如果我们使用熊猫，可以使用<code class="fe mn mo mp mq b">pd.concat</code>方法。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="e36c" class="mv la it mq b gy mw mx l my mz">pd.concat([df_feature, df_target], axis = 1).head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/d277dcbcca68c499011bb6a2e071a07d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/0*UWRZF4wwTX6hl2OK"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="ccb4" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">如果我们使用 SQL，我们将需要创建一个运行行号列，并使用行号连接两个表。由于 Pandasql 在幕后使用了 SQLite，所以 SQLite 表会默认创建<code class="fe mn mo mp mq b">rowid</code>列。该列包含从 1 开始的增量整数值。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="820c" class="mv la it mq b gy mw mx l my mz">query = 'SELECT rowid, * FROM df_feature LIMIT 3'<br/>pysqldf(query)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/58aa72d87d24bbbec8b5c5d85b7f682b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/0*YGbASNkRvR-B2SwV"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="82ac" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">我们现在可以在<code class="fe mn mo mp mq b">rowid</code>列上连接两个表。输出可以赋给另一个变量，这个变量以后可以再次用 Pandasql 查询。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="14e2" class="mv la it mq b gy mw mx l my mz">query = 'SELECT * FROM df_feature INNER JOIN df_target ON df_feature.rowid = df_target.rowid'<br/>df = pysqldf(query)<br/>df.head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/24caac2f43c5089fe8f811b950798ff9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/0*exi8jstLZrzaeS2x"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="3ed0" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">以下是我们可以执行的其他操作的示例。</p><p id="f767" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">寻找不同目标类的平均萼片长度。注意<code class="fe mn mo mp mq b">"sepal length (cm)"</code>被引号包围了。只有当列名中有空格时，才需要这样做。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="cdd4" class="mv la it mq b gy mw mx l my mz">query = 'SELECT target, AVG("sepal length (cm)") AS mean_sepal_length FROM df GROUP BY target'<br/>pysqldf(query)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/7b3fceb86f90f1874e343da1c8f3b70f.png" data-original-src="https://miro.medium.com/v2/resize:fit:426/0*XB2skjvu2BYGHtd6"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="6eb5" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated">我们还可以利用 python 中的 f 字符串来创建动态 SQL 查询字符串。</p><pre class="kj kk kl km gt mr mq ms mt aw mu bi"><span id="7fd9" class="mv la it mq b gy mw mx l my mz">COL_NAME = '"sepal length (cm)"'<br/>ALIAS = 'sepal_length'<br/>AGG = 'MAX'</span><span id="69ee" class="mv la it mq b gy nf mx l my mz">query = f"SELECT {AGG}({COL_NAME}) AS {ALIAS} FROM df"<br/>pysqldf(query)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/a6ee726c5838f1e5fde7111b99af72b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:252/0*Nd07RdS4NWPH3Pjm"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h1 id="c235" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Pandasql 的局限性</h1><ol class=""><li id="347f" class="ng nh it lt b lu lv lx ly ma od me oe mi of mm nl nm nn no bi translated">由于 Pandasql 使用 SQLite，它受到 SQLite 的所有<a class="ae ky" href="https://www.sqlite.org/omitted.html" rel="noopener ugc nofollow" target="_blank">限制。例如，SQLite 不实现右外连接或全外连接。</a></li><li id="db43" class="ng nh it lt b lu np lx nq ma nr me ns mi nt mm nl nm nn no bi translated">Pandasql 只执行查询，它不能执行 sql 操作，如更新、插入或更改表。</li></ol><h1 id="3e0c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="ca02" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Pandasql 是对数据科学家工具箱的一个很好的补充，对于那些喜欢 sql 语法而不是 Pandas 的数据科学家来说。在本文中，我们讨论了如何使用 Pandasql 查询 Pandas Dataframe 以及它的一些局限性。</p></div><div class="ab cl og oh hx oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="im in io ip iq"><p id="4d22" class="pw-post-body-paragraph lr ls it lt b lu na ju lw lx nb jx lz ma nc mc md me nd mg mh mi ne mk ml mm im bi translated"><a class="ae ky" href="https://medium.com/@edwin.tan/membership" rel="noopener">加入 Medium </a>阅读更多这样的故事。</p></div></div>    
</body>
</html>