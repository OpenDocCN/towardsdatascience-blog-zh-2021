<html>
<head>
<title>Why we must choose Kubernetes executor for Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么我们必须选择Kubernetes气流执行器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/why-we-must-choose-kubernetes-executor-for-airflow-28176062a91b?source=collection_archive---------2-----------------------#2021-09-10">https://towardsdatascience.com/why-we-must-choose-kubernetes-executor-for-airflow-28176062a91b?source=collection_archive---------2-----------------------#2021-09-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f793" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在生产环境中部署气流的技巧</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/435eae324e0113cd62efca84ef3ef01b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OVA3ZgCqowu74ONIzhBrww.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">尼科沃尔波尔<a class="ae kv" href="https://pixabay.com/pt/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3382863" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a></p></figure><p id="15ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我说的是一个坚实的、可扩展的气流基础设施。</p><blockquote class="ls lt lu"><p id="561c" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">如果你需要一点气流，最多50个Dag，最多2个开发者建造Dag。你不需要在意我会说什么，只要用docker-compose，ec2，或者局部用芹菜来调配你的气流，你就开心了。</p></blockquote><p id="dec4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是我在生产中部署气流的黄金法则:</p><ul class=""><li id="1b9f" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated">使用头盔进行气流展开</li><li id="b0b5" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">创建外部数据库。不要使用PostgreSQL容器。</li><li id="06b2" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">在托管云中部署Kubernetes。</li><li id="dcbc" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated"><strong class="ky ir">使用Kubernetes执行程序</strong></li></ul><p id="377e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我将集中在最后一个。</p><p id="5f06" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">我关心的哪些问题有解决方案:</strong></p><p id="398f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">1 —控制Kubernetes集群上的资源(内存、CPU)。<br/> 2 —许多开发人员从事不同的项目，并有不同的认可级别。所以他们使用不同的运营商和方式来建立数据管道。<br/> 3 —等幂和一致性Dag</p><p id="9dde" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">让我们一起去解决问题:</strong></p><p id="45bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">我们在云端一般会付出什么？</strong>资源(内存、CPU)</p><p id="1578" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，当有人使用PythonOperator创建一个包含许多任务的DAG来构建数据框时。您知道这个DAG使用了多少内存和CPU吗？如果你正在处理芹菜，那就复杂了，因为我们在同一个worker中运行许多任务。在Kubernetes中，每项工作都是一个pod，因此您需要预先设置工人资源，这是一个问题，因为我们有多个任务需要不同的资源。</p><p id="b2ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，最好使用<strong class="ky ir"> Kubernetes executor </strong>和<strong class="ky ir"> REQUIRE </strong>当有人编写DAG时，他们必须设置资源。这样，每个任务都是Kubernetes上的一个pod，具有不同的请求资源。</p><p id="6310" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请看这个简单的示例(您可以在气流默认示例中找到更多信息):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="f427" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">酷，所以你问我:我怎么能强迫某人设置资源？当然是利用你的说服力。不，这可以工作，但您可以在您的CI管道上使用阿德单元测试并进行验证。这个比第一个选项容易=)。</p><p id="90f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，有人会对我说:在我的公司，我们使用气流只是为了编排。我们使用芹菜，我们只使用KubernetesPodOperator，我们不在DAGs中进行转化。然后，当我们需要使用其他操作符时，首先我们测量de资源消耗，我们知道使用它是安全的，因为任务使用低资源，并且我们可以通过并行度限制来控制同一工作机上的任务数量。</p><p id="2edb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">PLUS:</strong>air flow Kubernetes executor比celery更具可伸缩性，即使我们使用KEDA来伸缩celery(另一篇文章的主题)。如果你理解了最后一段，你可以想象为什么我能保证它。如果您使用默认HPA进行气流缩放，您就不了解celery (scheduler、Redis、worker)是如何工作的。做一个测试，用一个使用高CPU的任务构建一个dag，您将看到HPA扩展更多的工作线程。但我们没有更多的任务，我们有一个任务运行使用更多的CPU，另一个工人不会帮助我们。</p><p id="736b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后同样重要的是，<strong class="ky ir">监控</strong>是关键。我用Prometheus和Grafana，它得到所有吊舱指标和气流Postgres指标。指标在本地开发和生产环境中非常重要。<br/>开发者需要本地的这些度量来设置初始资源。该公司需要监控以下问题的答案:<br/>哪些任务(pod)消耗更多内存(max)？哪些任务(pod)消耗更多CPU(最大值)？<br/>哪些任务(pod)花费了很长的时间和资源(max)？<br/>我的任务消耗ABC曲线(max)是多少？<br/>有了这些答案，公司可以为Dag校准资源，并知道他们需要优先处理哪些任务，以及根据资源消耗进行重构排序。<br/>不同的公司有不同的必需品问题，你可以和团队交流，了解必需品。</p><p id="4d67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过这种部署，开发人员需要更多地关注幂等性。他们需要创建一致的任务，每次执行都花费相同的资源，因此，当运行这些任务时，他们通常会获得相同的结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/d47de1e9070ad6fa604403fc51582f34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gb08ImKB_bqiw2vpZAJ1yQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">气流Grafana仪表板—自行创建</p></figure><p id="7512" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">图表中的这条红线是当我们不设置任务中的资源限制时可能发生的情况。这个任务需要更多的资源，如果库伯内特需要这些资源来完成其他任务，他会杀死这个豆荚。我们可以有一个全局配置来创建pod限制，但重要的是:任务不能完成工作，或者它会花费不必要的资源。</p><p id="9b05" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我建议您可以优化您的资源，因为这是我们向云支付的费用。您可以确切地知道哪些任务是瓶颈，并且可以对监控您的集群有更深入的了解。<br/> ***我并不是说使用Kubernetes executor更容易，您的团队需要更多的Kubernetes和容器知识，规则流只是一个批处理编排。因此，流式传输或批处理间隔最长可达一分钟，还有其他更好的解决方案，也许您只能创建管道来监控这些流式传输管道。</p><p id="a488" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">来源:</p><p id="52d6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://airflow.apache.org/docs/helm-chart/stable/index.html" rel="noopener ugc nofollow" target="_blank">阿帕奇气流舵图——舵图文档</a></p><p id="26ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://www.astronomer.io/guides/airflow-executors-explained" rel="noopener ugc nofollow" target="_blank">气流执行者解释|阿帕奇气流指南(天文学家. io) </a></p><p id="308f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://airflow.apache.org/docs/" rel="noopener ugc nofollow" target="_blank">文档|阿帕奇气流</a></p></div></div>    
</body>
</html>