<html>
<head>
<title>An Introduction to Apache Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿帕奇气流简介</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/an-introduction-to-apache-airflow-21111bf98c1f?source=collection_archive---------6-----------------------#2021-04-17">https://towardsdatascience.com/an-introduction-to-apache-airflow-21111bf98c1f?source=collection_archive---------6-----------------------#2021-04-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5172" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">作为数据科学家，这是一个很好的管道自动化工具</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/917e9a2c5696d5ab7a2c78626255d91c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h4TLlisFk7XvtREAsS7C7Q.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">克里斯托夫·高尔在<a class="ae ky" href="https://unsplash.com/s/photos/tech?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="6b2b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">什么是阿帕奇气流？</h1><p id="f578" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">成为数据科学家的很大一部分是能够自动进化模型并生成报告。对于需要定期收集数据、生成周期报告等的模型。手动运行程序非常耗时且不可扩展。能够自动化整个数据管道来生成报告是非常有用的。这正是阿帕奇气流带来的东西。</p><p id="a09c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">Apache Airflow是一个开源的作业调度程序，它可以组织、执行和监控任何周期性时间间隔内的任何工作流。这个项目是从Airbnb开始的，已经被很多大公司如谷歌和亚马逊接手。</p><h1 id="bedd" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">气流是如何工作的？</h1><p id="a25b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Airflow利用有向无环图(Dag)来创造就业机会。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/67935ad466ee401e7773eb7d12d771a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DRVNuj3UAH8rqqzelbtkIA.png"/></div></div></figure><p id="485c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">DAG由节点和有向箭头组成。每个节点都是一个函数，当该函数运行时将被执行，每个箭头都指向当前节点之后将被执行的下一个节点。对于有多个箭头进入的节点，必须先完成所有的依赖关系，然后节点才能启动。</p><p id="7912" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">图中的每个节点都由一个运算符定义。有许多运算符，如BashOperator、PythonOperator等。每个操作员负责运行该操作员类型的功能。例如，如果您有一个PythonOperator，您可以告诉操作员运行python函数。这是所有可能的<a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow/stable/_api/airflow/operators/index.html" rel="noopener ugc nofollow" target="_blank">气流操作员</a>的列表。</p><p id="a2ce" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">每个DAG由DAG python文件指定，该文件指定节点和节点之间的依赖关系。</p><h2 id="40ce" class="mt la it bd lb mu mv dn lf mw mx dp lj ma my mz ll me na nb ln mi nc nd lp ne bi translated">气流DAGs页面</h2><p id="b62d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">从Dag视图中，您可以看到当前注册到Airflow中的所有Dag。从这里，您可以查看作业的状态、触发现有作业、刷新作业等等。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/28ebc5aa8dfeddc166f3b7d05dc6d84d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8eZ2o59rYDBENAyPP6nTLg.png"/></div></div></figure><h1 id="9bdf" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">设置气流</h1><p id="4340" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">设置气流非常简单。此设置过程将用于MacOS，但在线也有相应的Windows设置步骤。在安装过程之前，请确保您已经安装了自制软件[ <a class="ae ky" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">说明</a> ]。家酿是一个软件包安装程序，它使得安装程序和软件包更加简单。</p><h2 id="dafc" class="mt la it bd lb mu mv dn lf mw mx dp lj ma my mz ll me na nb ln mi nc nd lp ne bi translated">1.安装Python3和pip</h2><p id="0d11" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">安装Python3，然后检查以确保Python版本是3+</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="1932" class="mt la it nh b gy nl nm l nn no">% brew install python</span><span id="1998" class="mt la it nh b gy np nm l nn no">% python --version<br/>python 3.8.3</span></pre><p id="3522" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">安装pip</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="e365" class="mt la it nh b gy nl nm l nn no">% curl <a class="ae ky" href="https://bootstrap.pypa.io/get-pip.py" rel="noopener ugc nofollow" target="_blank">https://bootstrap.pypa.io/get-pip.py</a> -o get-pip.py</span><span id="fcac" class="mt la it nh b gy np nm l nn no">% python get-pip.py</span></pre><p id="350b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要安装Airflow，请确保pip版本为20.2.4</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="aaac" class="mt la it nh b gy nl nm l nn no">% pip install --upgrade pip==20.2.4</span><span id="e21d" class="mt la it nh b gy np nm l nn no">% pip --version<br/>pip 20.2.4 from /usr/local/anaconda3/lib/python3.8/site-packages/pip (python 3.8)</span></pre><h2 id="fbb6" class="mt la it bd lb mu mv dn lf mw mx dp lj ma my mz ll me na nb ln mi nc nd lp ne bi translated">2.[可选]创建虚拟环境安装气流</h2><p id="db37" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一般来说，安装一个虚拟环境是一个很好的实践，这样你就不会把你的本地环境和很多包聚集在一起。虚拟环境可以很容易地激活和停用。安装<code class="fe nq nr ns nh b">virtualenv</code>并为虚拟环境创建一个名称，本例中的名称是<code class="fe nq nr ns nh b">venv</code>。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="149a" class="mt la it nh b gy nl nm l nn no">% pip install virtualenv</span><span id="baf9" class="mt la it nh b gy np nm l nn no">% virtualenv -p python venv</span></pre><p id="0727" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在激活虚拟环境，这样所有的包都会安装到虚拟环境中，而不是您的计算机上。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="be48" class="mt la it nh b gy nl nm l nn no">% source venv/bin/activate</span></pre><p id="9850" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，您的虚拟环境被激活。你的控制台现在应该有<code class="fe nq nr ns nh b">(venv)</code>在它前面。</p><h2 id="f08c" class="mt la it bd lb mu mv dn lf mw mx dp lj ma my mz ll me na nb ln mi nc nd lp ne bi translated">3.安装和设置气流</h2><p id="d93f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在新的<code class="fe nq nr ns nh b">airflow</code>目录中安装气流</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="0627" class="mt la it nh b gy nl nm l nn no">(venv) % mkdir airflow &amp;&amp; cd airflow</span><span id="fa4d" class="mt la it nh b gy np nm l nn no">(venv) % pip install apache-airflow</span></pre><p id="997f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">设置正确的目录结构，并创建一个新的气流文件夹。首先用<code class="fe nq nr ns nh b">pwd</code>获得airflow文件夹的路径，然后将其作为airflow主目录导出到该路径。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="fa17" class="mt la it nh b gy nl nm l nn no">(venv) % pwd<br/>/Users/&lt;username&gt;/airflow/airflow</span><span id="cb50" class="mt la it nh b gy np nm l nn no">(venv) % export AIRFLOW_HOME=/Users/&lt;userid&gt;/airflow/airflow</span></pre><p id="8212" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最后，初始化气流数据库。Airflow使用Sqlite数据库来跟踪所有airflow DAGs的元数据。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="dfb4" class="mt la it nh b gy nl nm l nn no">(venv) % airflow db init</span></pre><p id="4995" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，您应该会看到airflow目录中的一堆文件。在下面的终端输出中，我使用了一个名为<code class="fe nq nr ns nh b">tree</code>的包，但是<code class="fe nq nr ns nh b">ls</code>也可以工作。是一个非常有用的查看目录结构的包。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="81ed" class="mt la it nh b gy nl nm l nn no">(venv) % brew install tree</span><span id="4ed1" class="mt la it nh b gy np nm l nn no">(venv) f.liang@fliang-ltm airflow % tree<br/>.<br/>├── airflow.cfg<br/>├── airflow.db<br/>├── logs<br/>│   └── scheduler<br/>│     ├── 2021-04-16<br/>│     └── latest -&gt; /Users/&lt;userid&gt;/airflow/logs/scheduler/2021-04-16<br/>├── unittests.cfg<br/>└── webserver_config.py</span></pre><h2 id="52de" class="mt la it bd lb mu mv dn lf mw mx dp lj ma my mz ll me na nb ln mi nc nd lp ne bi translated">4.启动气流</h2><p id="6a4f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在第一次启动Airflow时，您必须创建一个新用户。我刚刚对大多数字段使用了简单的<code class="fe nq nr ns nh b">admin</code>，但是你可以自定义它。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="6615" class="mt la it nh b gy nl nm l nn no">(venv) % airflow users create \<br/>      --role Admin \<br/>      --username admin \<br/>      --email admin \<br/>      --firstname admin \<br/>      --lastname admin \<br/>      --password admin</span></pre><p id="a472" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要检查用户是否已成功添加，请列出所有用户</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="843b" class="mt la it nh b gy nl nm l nn no">(venv) % airflow users list<br/>id | username | email | first_name | last_name | roles<br/>===+==========+=======+============+===========+======<br/>1  | admin    | admin | admin      | admin     | Admin</span></pre><p id="b5f3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后启动Airflow作业调度程序</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="54c9" class="mt la it nh b gy nl nm l nn no">% airflow scheduler</span></pre><p id="5117" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">创建一个新的终端(Mac上的<code class="fe nq nr ns nh b">CMD + T</code>，并再次设置<code class="fe nq nr ns nh b">AIRFLOW_HOME</code>路径。如果您之前设置了虚拟环境，请不要忘记激活虚拟环境。如果不这样做，那么<code class="fe nq nr ns nh b">airflow</code>命令在新的终端中将不起作用。然后启动web服务器。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="84d3" class="mt la it nh b gy nl nm l nn no">(venv) % export AIRFLOW_HOME=/Users/&lt;userid&gt;/airflow/airflow</span><span id="96ba" class="mt la it nh b gy np nm l nn no">(venv) % airflow webserver</span></pre><p id="84e3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">从这里开始，一切都应该设置好了，所以打开任何网络浏览器并转到<a class="ae ky" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> localhost:8080 </a>。8080应该是您的<code class="fe nq nr ns nh b">airflow.cfg</code>文件中的默认端口，但是如果这不起作用，请打开您的airflow.cfg文件，查找<code class="fe nq nr ns nh b">web_server_port</code>字段并将其设为8080。在这里，只需输入您之前创建的用户名和密码(用户名和密码都是<code class="fe nq nr ns nh b">admin</code>)并登录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/3c966f9d12c6ceefe95875b5f7ba97cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8yVCRQYraYDfkwRk0rSMXw.png"/></div></div></figure><p id="5884" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">登录后，您可以浏览并运行许多示例airflow作业。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/f950f207ad806aa34d45b88781d21eab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HHm3nvBvK-2sXpqOKo3Vzw.png"/></div></div></figure><h1 id="5cac" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">5.创建您自己的Dag</h1><p id="5930" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">要阻止示例dag的显示，请打开您的<code class="fe nq nr ns nh b">airflow.cfg</code>文件并将<code class="fe nq nr ns nh b">load_examples</code>设置为<code class="fe nq nr ns nh b">False</code>，然后创建一个Dag文件夹，如<code class="fe nq nr ns nh b">airflow.cfg</code>中的<code class="fe nq nr ns nh b">dags_folder</code>变量所指定的。故障dags文件夹路径为<code class="fe nq nr ns nh b">AIRFLOW_HOME/dags</code>。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="9287" class="mt la it nh b gy nl nm l nn no">(venv) % mkdir /Users/&lt;userid&gt;/airflow/airflow/dags</span></pre><p id="ea88" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">将您的DAG文件添加到<code class="fe nq nr ns nh b">dags/</code>文件夹中，Airflow scheduler将自动拾取DAG，并在几分钟内将其反映在web服务器中。任何编译错误也会显示在UI和logs文件夹中。</p><h1 id="6347" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="bc92" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Apache Airflow对于任何机器学习工程师或数据科学家来说都是一个非常方便的工具，可以用来安排和自动化工作流。通过用docker容器替换虚拟环境并将docker映像托管在云中，工程师可以在几分钟内部署和监控整个数据管道。</p></div></div>    
</body>
</html>