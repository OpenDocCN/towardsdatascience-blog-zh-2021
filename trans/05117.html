<html>
<head>
<title>Deploy Thousands of Models on SageMaker Real-Time Endpoints with Automatic Retraining Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在SageMaker实时端点上部署数千个模型，并提供自动再培训管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-thousands-of-models-on-sagemaker-real-time-endpoints-with-automatic-retraining-pipelines-4eef7521d5a3?source=collection_archive---------16-----------------------#2021-05-05">https://towardsdatascience.com/deploy-thousands-of-models-on-sagemaker-real-time-endpoints-with-automatic-retraining-pipelines-4eef7521d5a3?source=collection_archive---------16-----------------------#2021-05-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="55b6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">艾米莉·韦伯和埃里克·托宾的联合文章</h2></div><p id="0dd3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本帖也是<a class="ae lb" href="https://aws.amazon.com/sagemaker/sagemaker-month/" rel="noopener ugc nofollow" target="_blank"> SageMaker月的一部分！查看我们的日历</a>,了解SageMaker的所有入门知识——以前所未有的速度构建、培训和部署模型。利用实践研讨会、专用工具和资源来提高团队的工作效率。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/aac158ef5d9983f2e3a36098b89620b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g4qwv4d-YYhmbUtwFWGR2Q.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">在SageMaker Studio中创建自动再培训管道</p></figure><p id="c709" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你正在开发一个应用程序，向全美各城市推荐下一个最好的食品配送。在过去的两年中，您已经研究出了一个基于XGBoost的大型多分类模型，它推荐城市级别的餐馆。芝加哥、纽约、旧金山、西雅图，所有这些都由专门的SageMaker终端托管。它们从你的应用程序接收请求，处理数据，并在一位数毫秒内返回建议的餐馆。突然，一个实习生进来演示了在你的数据集中为每个客户训练一个模型的可能性。您的准确性突飞猛进，但从成本角度来看，您担心这种做法的可行性。在你的数据库中，有成千上万个不同的买家，你怎么可能为每个人提供一个模型呢？你如何让这些模型跟上最新的购买趋势？<br/> <br/>在亚马逊SageMaker 上输入<a class="ae lb" href="https://github.com/aws/amazon-sagemaker-examples/blob/master/advanced_functionality/multi_model_xgboost_home_value/xgboost_multi_model_endpoint_home_value.ipynb" rel="noopener ugc nofollow" target="_blank">多型号端点。<br/> <br/>说到底，从SageMaker的角度来看，一个模型是两件事。它是坐落在S3的训练有素的模型人工制品，它是你包装在图像中的推理脚本。无论您是使用云中的spot实例廉价地训练该模型，从您的笔记本电脑加载它，从您办公桌下的NVIDIA设备编译它，还是从H20或DataRobot移植它，只要您可以定义该模型的计算要求，您就可以在SageMaker上托管它。<br/> <br/>现在，让这笔交易更加划算的是<strong class="kh ir">您可以从一个SageMaker端点托管任意多的模型。</strong>你实际上有两个选择。如果您正在考虑一个场景，其中您有一个建模框架，比如XGBoost，并且您想要在该框架内将它扩展到成千上万个模型，您将想要选择“多模型端点”或者，如果您有几个不同的建模容器想要在单个端点上托管，您会看到我们刚刚推出的多容器方法</a><a class="ae lb" href="https://aws.amazon.com/about-aws/whats-new/2021/03/announcing-support-for-multiple-containers-on-amazon-sageamker-inference-endpoints/" rel="noopener ugc nofollow" target="_blank"/>。<br/> <br/>在这篇文章中，我们将关注“多模型端点”我们还将讨论如何通过自动再培训渠道保持这些信息的更新。<br/> <br/>你问SageMaker到底是怎么处理托管上万个模型的？很简单。我们用S3。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lt"><img src="../Images/7a13a619f1dc6357c2b6b94cef6b51cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UFijIz7IKuKZSkhUL-nlpQ.png"/></div></div></figure><p id="2128" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您要做的第一件事是选择<strong class="kh ir">将托管您的模型的容器。</strong></p><p id="b177" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在大多数情况下，最简单的方法是使用我们称之为“脚本模式”或托管容器。</p><p id="f3e6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://sagemaker.readthedocs.io/en/stable/frameworks/index.html" rel="noopener ugc nofollow" target="_blank">脚本模式</a>让你从<a class="ae lb" href="https://sagemaker.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> SageMaker Python SDK </a>和<em class="ls">导入估算器，绕过Docker构建步骤</em>。您可以使用我们的<a class="ae lb" href="https://aws.amazon.com/machine-learning/containers/" rel="noopener ugc nofollow" target="_blank">深度学习容器</a>作为基础并扩展它们，直接引入您的代码，指定框架版本，并定义您需要的任何自定义需求。SageMaker从一个<em class="ls">计算</em> <em class="ls">和一个容器视角</em>管理后端，两者都在云中为您构建一个专用实例，并帮助运行您的代码。<br/> <br/>您完全可以在SageMaker的脚本模式下运行完整的培训任务。您还可以用您的工件和推理脚本<a class="ae lb" href="https://aws.amazon.com/blogs/startups/how-startups-deploy-pretrained-models-on-amazon-sagemaker/" rel="noopener ugc nofollow" target="_blank">托管一个预训练的模型</a>。首先在SageMaker SDK中定义您的模型，就像这样。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lu"><img src="../Images/b3615c0f768dacc6fd65b80fbd786d4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SXqoFj-7_K7pv3LgQzJCww.png"/></div></div></figure><p id="0988" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，您正在使用您自己的训练图像，并且指向您自己的存储在S3的模型工件。这意味着在SageMaker上部署模型之前，你可以在任何地方训练你的模型！</p><p id="e37c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们将使用相同的SageMaker SDK来<em class="ls">创建多模型端点。</em></p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lv"><img src="../Images/1afcc07502e64195e09d19b8844e2fbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FEVVLnHdPVUtn8BvrrxoMg.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">通过SageMaker上的多模型端点服务数千个模型</p></figure><p id="c2ec" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建多模型端点<em class="ls">的最大区别在于，模型工件在调用后只出现在端点</em> <strong class="kh ir"> <em class="ls">上。SageMaker完全管理哪些工件在磁盘上，哪些工件在你的桶中。我们根据请求将这些数据从S3拷贝到端点，并将它们放入RAM以响应您的端点请求。<br/> <br/>多模型端点非常适合您训练和部署数千个模型的情况，在您的客户群中每个单元可能有一个模型。而这几千个模型需要在同一个软件框架里，所以所有TensorFlow模型，或者所有XGBoost，所有SKLearn模型等等。<a class="ae lb" href="https://docs.aws.amazon.com/sagemaker/latest/dg/multi-container-endpoints.html" rel="noopener ugc nofollow" target="_blank">另一方面，多容器端点</a>是当你总共有5-6个模型时，但是这些模型在不同的软件框架中，并且有不同的推理脚本。例如，如果您为一个TensorFlow、一个XGBoost和一个PyTorch模型提供服务，那么多容器端点是一个不错的选择。这里我们将关注多模型端点。<br/> <br/>现在，您仍然需要考虑针对该端点的流量。如果你真的在为数以万计的客户服务，实际上最好的办法就是<a class="ae lb" href="https://aws.amazon.com/contact-us/aws-sales/" rel="noopener ugc nofollow" target="_blank">直接联系我们</a>。作为亚马逊人和机器学习专家解决方案架构师，我们工作的很大一部分是直接与客户迭代他们的最终架构计划，以确保它符合最佳实践。你不必单干！我们可以帮忙。<br/> <br/>所以我们已经旋转了我们的端点。我们如何与它互动？</em></strong></p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lw"><img src="../Images/d4d2ce66a76f3ec0efd583324428a6b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bKUt6eRDJX1ZrM1HVOVgUw.png"/></div></div></figure><p id="9381" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ls">注意，我们可以在这个推理请求中传递模型工件的名称。</em>这意味着我们可以动态地确定我们想要使用哪个模型进行推理<em class="ls"/>。<br/> <br/>最常见的生产方式是<strong class="kh ir">将推理代码包装在Lambda函数中。然后你可以从你的应用程序逻辑中调用你的Lambda函数，不管它在哪里。</strong></p><h1 id="4275" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">自动再训练管道</h1><p id="95b8" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">我们已经了解了在SageMaker多模型端点上托管数千个模型，但是我们如何建立一个自动再培训管道呢？就像托管一样，你的再培训管道的核心其实是位于S3的对象，以及打包在SageMaker中的图像。有了再培训管道，在高层次上你想完成几个关键步骤。</p><ol class=""><li id="0fab" class="mu mv iq kh b ki kj kl km ko mw ks mx kw my la mz na nb nc bi translated">指向您的新数据集</li><li id="e8b6" class="mu mv iq kh b ki nd kl ne ko nf ks ng kw nh la mz na nb nc bi translated">重新培训您的模型</li><li id="ff5c" class="mu mv iq kh b ki nd kl ne ko nf ks ng kw nh la mz na nb nc bi translated">评估这个，如果好，部署！</li></ol><p id="bda1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就编排所有这些组件而言，您有多种选择。如果你刚刚开始，一般我们推荐SageMaker-native接手这个，<a class="ae lb" href="https://aws.amazon.com/sagemaker/pipelines/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir">管道</strong> </a>。Pipelines是一种直接从SageMaker Studio构建第一个MLOps工作流的简单方法，它使用了SageMaker用户体验中的所有相同结构。您可以在ide中构建一个非常好的DAG。<br/> <br/>如果你已经熟悉编排工作流，你可能会选择一些与现有企业编排策略很好地配合的东西，如Apache Airflow、Jenkins、Code Pipeline或KubeFlow。SageMaker可以很好地处理所有这些问题，并且为气流和库伯流都提供了本地插件。<br/> <br/> <strong class="kh ir">我们将在下面的管道中一步一步地这样做:</strong></p><ol class=""><li id="352b" class="mu mv iq kh b ki kj kl km ko mw ks mx kw my la mz na nb nc bi translated">为住房数据定义数据预处理脚本、培训和模型评估脚本</li><li id="1767" class="mu mv iq kh b ki nd kl ne ko nf ks ng kw nh la mz na nb nc bi translated">将脚本导入SageMaker pipelines API，创建一个有向无环图</li><li id="af6c" class="mu mv iq kh b ki nd kl ne ko nf ks ng kw nh la mz na nb nc bi translated">实现一个Lambda函数来启动管道执行</li><li id="635f" class="mu mv iq kh b ki nd kl ne ko nf ks ng kw nh la mz na nb nc bi translated">测试解决方案，执行新的管道，将模型加载到<a class="ae lb" href="https://docs.aws.amazon.com/sagemaker/latest/dg/model-registry.html" rel="noopener ugc nofollow" target="_blank">模型注册中心</a>，并将它们部署到我们的多模型端点上。</li></ol><p id="fb8b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们来看看火车步。注意，虽然这个例子使用了一个内置算法，但是您可以很容易地指向您自己的图像和/或脚本。我们构建了一个<em class="ls">估计量</em>，并使用它来定义我们的超参数。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ni"><img src="../Images/5472f87cc4201c725617428b596f667b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0wiMNz2AOFwMPAs6WX_2LQ.png"/></div></div></figure><p id="9779" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了估计器，我们将把对象<em class="ls">传递到管道API </em>。这发生在我们定义<em class="ls">训练步骤时。</em></p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nj"><img src="../Images/f7158083e45617bb66870f3c1deeec09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0NHMFUDYqBUp4KZu8nwnGw.png"/></div></div></figure><p id="2f04" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们将清洗并重复<em class="ls">管道中的所有剩余步骤。</em>这意味着我们正在创建预处理、训练、评估和有条件加载到模型注册中心的步骤。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nk"><img src="../Images/58d6583743d447c0ab4291e546b7adb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w8zCYT9IEF0w6EeDX6DDBw.png"/></div></div></figure><p id="bfa5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有了一条管道！您可以在Studio中查看这个管道并启动执行。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nl"><img src="../Images/89f95aff3a0d07464bd5cd1dd22abfd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T2BQPeYKCZZ6fDXL6_ajFw.png"/></div></div></figure><p id="65c3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们选择为每个型号创建<em class="ls">独特的渠道。</em>这意味着有一条通往芝加哥、圣地亚哥、洛杉机、休斯顿等地的管道。虽然从MLOps的角度来看，这听起来像是很大的开销，但是它确实给了您分别训练和处理每个模型的灵活性。因此，如果突然一个KNN模型开始在一个地区更好地工作，而一个深度学习模型在另一个地区更好，你可以在你认为合适的时候将这些组件添加到每个管道中。您还可以分别管理这些数据的处理，以适应独特的数据流、见解和利益相关者。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/5c7d0d9ae43382f2382823d10ed1a9ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*4ySu4SJEk7xWSRCaulTnOQ.png"/></div></figure><p id="8cb0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦这些管道执行，它们将模型放入模型注册中心。这是Studio中的一个附加层，它让您可以看到您已经创建的模型，以及这些模型的版本，因此您可以更容易地部署它们。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/8a7af09da4a4162fbbd317089e1114ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*AAcxGmS298dRNB8gsDLG0A.png"/></div></figure><p id="cd9f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们所有管道的截图，可以在Studio中看到。</p><p id="27f9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有一个我们模型包组的截图，加载在模型注册表中。</p><p id="6ee1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是单个模型包组的视图——尤其是所有版本都很容易看到！</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi no"><img src="../Images/644af5571439944d4e60f24ce4e163f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M6JEc6eusroBVefNSkkyAQ.png"/></div></div></figure><p id="1b2d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于每个版本，您可以查看这是否被批准。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi np"><img src="../Images/fe5bd6de4c4feb4771a14e4d1c7c0c42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o2_v3j_YEFHuNVHLEu4f5g.png"/></div></div></figure><p id="64fd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就这样结束了！您可能会想，<em class="ls">哎呀，这比我预期的要多得多</em>，但事实是，这实际上比一些客户开发的要简单得多。特别是当您大规模地投入复杂的数据操作时，除了最先进的模型之外，这些项目可以很容易地扩大范围。</p><p id="6f86" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是为什么把你的平台开发卸载到AWS 上是如此重要<strong class="kh ir">。这是使用托管服务的核心—通过将您的基础架构管理和开发卸载到云上的专用服务，您的团队可以专注于真正使您的业务脱颖而出的功能。所有的功能请求、平台增强、错误修复和低级软件开发都可以推给Amazon团队，优先考虑您最关心的数据科学结果。</strong></p><p id="1438" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ls">所有图片均由作者制作</em></p></div></div>    
</body>
</html>