<html>
<head>
<title>Deploying large packages on AWS Lambda using EFS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用EFS在AWS Lambda上部署大型包</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-large-packages-on-aws-lambda-using-efs-3a707f83d918?source=collection_archive---------9-----------------------#2021-08-31">https://towardsdatascience.com/deploying-large-packages-on-aws-lambda-using-efs-3a707f83d918?source=collection_archive---------9-----------------------#2021-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="7442" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/making-sense-of-big-data" rel="noopener" target="_blank">理解大数据</a></h2><div class=""/><div class=""><h2 id="dcfb" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">AWS Lambda是一个非常方便的工具，可以轻松地在线部署简单的功能。但是如果你碰巧有一个大项目或者依赖于一个大的库，这可能会变成一场噩梦。</h2></div><p id="c07e" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">AWS Lambda还是挺方便的。在云上部署一个功能真的很简单，不用担心设置。你可以在几分钟内让它运行起来。但是，它的一个主要限制是部署大小，您不能部署大于250MB的任何东西。</p><p id="aadf" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您自己的代码不太可能那么大，但是您可能需要基本设置中不包含的库，这些库很容易达到几百MB或几GB。当您使用现有的模型和您的模型的特定ML包来训练模型或运行推理时，通常就是这种情况。</p><p id="0d60" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在这种情况下，AWS EFS(弹性文件系统)来拯救。EFS是一个文件系统，可以从不同的实例挂载，包括Lambda函数。一个主要的警告是，所有这些资源应该在同一个安全组和VPC(虚拟私有云)中。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lk"><img src="../Images/7899298ca467a4eca92f8b9921334847.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o4UFooJF4mPHC3RfFLwlqA.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">架构的高级视图[图片由作者创建]</p></figure><p id="a1b5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">该设置包括以下步骤:</p><ul class=""><li id="e740" class="ma mb iq kq b kr ks ku kv kx mc lb md lf me lj mf mg mh mi bi translated">创建一个VPC和一个安全组，在以下所有步骤中使用该VPC和安全组。</li><li id="cc9e" class="ma mb iq kq b kr mj ku mk kx ml lb mm lf mn lj mf mg mh mi bi translated">创建一个EFS</li><li id="0bfc" class="ma mb iq kq b kr mj ku mk kx ml lb mm lf mn lj mf mg mh mi bi translated">创建EC2实例</li><li id="f687" class="ma mb iq kq b kr mj ku mk kx ml lb mm lf mn lj mf mg mh mi bi translated">EC2实例中的EFS山</li><li id="995d" class="ma mb iq kq b kr mj ku mk kx ml lb mm lf mn lj mf mg mh mi bi translated">安装所需的软件包</li><li id="5dd3" class="ma mb iq kq b kr mj ku mk kx ml lb mm lf mn lj mf mg mh mi bi translated">创建AWS Lambda函数</li><li id="70b5" class="ma mb iq kq b kr mj ku mk kx ml lb mm lf mn lj mf mg mh mi bi translated">在Lambda函数中挂载相同的EFS文件系统</li></ul><p id="432b" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">一旦安装了软件包，您就可以关闭EC2实例，不再需要它了。</p><p id="74e6" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这个系统的整体架构并不复杂，但是AWS界面的复杂性和部署中的某些变化使得设置起来更加困难。所需的库和CLI命令发生了变化，而AWS博客上的指南已经过时。在撰写本文时，我将尝试提供一个详细的分步说明。我将使用AWS网络控制台(【https://console.aws.amazon.com】T2)。如果您不熟悉AWS控制台，可以简单地搜索相关资源。</p><h1 id="3014" class="mp mq iq bd mr ms mt mu mv mw mx my mz kf na kg nb ki nc kj nd kl ne km nf ng bi translated">创造VPC</h1><p id="8a83" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">除非你知道你在做什么，否则我建议你使用VPC向导。默认情况下，VPC是隔离的，它不能访问互联网。将internet接入添加到VPC涉及一长串详细的步骤，如创建路由表、公共和私有子网、NAT和internet网关等。(【https://stackoverflow.com/a/55267891】)。VPC向导可以为你做这些。只需从AWS控制台转到VPC部分，然后单击启动VPC向导按钮。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nm"><img src="../Images/79b92866c3ab2584b6ad37ae65e357aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*52G7IMn5CDhsqIKzOJZRbQ.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">VPC巫师</p></figure><p id="84ab" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><em class="nn">拥有公共和私有子网的VPC</em>将为您的lambda功能提供互联网接入。但是由于NAT网关的使用，这可能具有更高的成本。如果你不要求，你可以用一个公共子网去<em class="nn"> VPC。但是你应该在做那件事之前深思熟虑，这一步之后就很难改变了。</em></p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi no"><img src="../Images/1a09512c03f836cdfe22d5d588a09560.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BZYo3kEinYn-9doA2bGQbg.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">VPC细节</p></figure><p id="5729" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">你所需要做的就是给你的VPC一个名字，并选择一个弹性IP，你可以让其余的保持原样，并创建一个VPC。</p><h1 id="b5e7" class="mp mq iq bd mr ms mt mu mv mw mx my mz kf na kg nb ki nc kj nd kl ne km nf ng bi translated">创建安全组</h1><p id="af50" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">现在我们有了一个VPC，我们需要创建一个安全组。出于本指南的目的，我将只创建一个允许所有传入/传出流量。您当然可以创建一个更适合您的安全需求的，但要确保它给你访问权限。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi np"><img src="../Images/15631e99c6ce862cb6cd99f272be5c53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nxrBxCHC2yWzAqyaoCUNqQ.png"/></div></div></figure><p id="224f" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">确保您已经选择了我们创建的VPC。你喜欢怎么命名都行。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nq"><img src="../Images/8be377a61a4087e68ea74499646931a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RBikIOjdPjo_nX-bdO3M9A.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">网络访问的入站和出站规则</p></figure><p id="f1fc" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">出于本指南的目的，我简单地设置了所有允许的传入和传出流量。理想情况下，您应该只授权访问您自己的IP地址和您需要的端口(即SSH)。</p><p id="f5da" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在我们有了VPC和安全组，我们可以创建我们的EFS、EC2实例和Lambda函数。</p><h1 id="f9eb" class="mp mq iq bd mr ms mt mu mv mw mx my mz kf na kg nb ki nc kj nd kl ne km nf ng bi translated">创建一个EFS</h1><p id="0169" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">您可以在创建EC2实例的过程中自动创建一个EFS，但是您仍然需要对其进行更改，以便从Lambda函数中进行访问。因此，更简单的方法是预先创建一个包含所有必需细节的EFS。</p><p id="6d2d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">要创建EFS，您必须转到AWS控制台上的EFS页面。您会在EFS主页上看到一个“创建文件系统”按钮。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nr"><img src="../Images/15b0eec454a7e6abea24161e90fd7b9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5MFBwkH4Een3LrbUgNeUtQ.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">创建文件系统对话框</p></figure><p id="773c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">创建文件系统后，我们需要创建一个访问点。当您进入新创建的文件系统时，有一个“访问点”选项卡，您可以在其中单击“创建访问点”按钮。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi ns"><img src="../Images/f55af4f7dbd2716f723e2ec45cb75995.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-vzxwV8nk3vVgIVtTERopA.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">接入点选项卡</p></figure><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nt"><img src="../Images/18259df2dfd12b0b5eec543c939b17fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A-EhjdXkuZNxGhp-0Y3WAQ.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">创建接入点对话框</p></figure><p id="28d4" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您可以输入任意数量的用户和组id值。设置这些值会为挂载创建一个默认的根目录。</p><p id="9bed" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我已经将权限设置为777，这将允许任何人写访问。这只是为了方便。当您以后不再需要写入时，您可以创建一个单独的只读访问点。那会更安全。</p><h1 id="94d6" class="mp mq iq bd mr ms mt mu mv mw mx my mz kf na kg nb ki nc kj nd kl ne km nf ng bi translated">创建EC2实例</h1><p id="f434" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">现在我们有了一个EFS文件系统，我们需要在同一个VPC中有一个EC2实例，以便装载和访问存储。虽然AWS可以在创建实例时自动创建EFS文件系统，但它不会创建访问点，没有访问点Lambda函数就无法挂载它。</p><p id="00fe" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">转到控制台上的EC2仪表板，并单击“启动实例”按钮。您需要选择一个Linux或OSX实例，因为您不能在Windows设备上挂载EFS。我将继续使用默认选择，一个符合条件的免费Amazon Linux 2 AMI实例t2.micro。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nu"><img src="../Images/dd844e5f9d90988eb0babbc61fed4680.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EZ9hBpTF4Ru8v1MLZdO78g.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">实例详细信息</p></figure><p id="6705" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">确定您选择了一个子网(装载EFS所需的)并将“自动分配公共IP”设定为“已启用”。</p><p id="3d2b" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在下面你会看到文件系统的设置。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nv"><img src="../Images/3adc46787f19bc5af8ef50a75af571d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3buzKy8tb4Djv4LjSRfPjQ.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">添加文件系统选项</p></figure><p id="02c2" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">单击“添加文件系统”按钮将允许您选择我们创建的EFS。您可以在这里设置EFS将被挂载到哪个文件夹。我们将在稍后安装软件包时使用它。</p><p id="e859" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们不必创建新的安全组，因此您可以取消选择它。但是要确保进入“配置安全组”步骤来选择安全组。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi nw"><img src="../Images/c23b34bc9e3c8e3cb528c0b985071356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1nAiZUg2yJ4xuY57KGPlDw.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">安全组步骤</p></figure><p id="1b6f" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在可以启动实例了。确保下载密钥文件，我们将需要它来ssh到EC2实例中。</p><h1 id="2802" class="mp mq iq bd mr ms mt mu mv mw mx my mz kf na kg nb ki nc kj nd kl ne km nf ng bi translated">安装软件包和库</h1><p id="01a5" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">现在您可以SSH到EC2实例并安装您需要的库。例如，如果您需要安装Python包，只需使用pip安装在已挂载的EFS文件夹中。</p><pre class="ll lm ln lo gt nx ny nz oa aw ob bi"><span id="9550" class="oc mq iq ny b gy od oe l of og">sudo pip3 install — target /mnt/efs/fs1 pandas</span></pre><p id="b0f5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">“/mnt/efs/fs1”是我们在创建EC2实例时为文件系统挂载设置的文件夹。</p><p id="ad55" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">你可以安装所有你想要的软件包，并上传你自己的文件。您也可以上传大型模型文件。所有文件都可以使用挂载文件夹直接从Lambda函数中访问。</p><p id="bb6d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您可以使用scp上传文件，但不能直接上传到挂载的驱动器，因为它需要root权限。您必须首先更改文件夹的权限:</p><pre class="ll lm ln lo gt nx ny nz oa aw ob bi"><span id="2183" class="oc mq iq ny b gy od oe l of og">sudo chmod 777 /mnt/efs/fs1</span></pre><p id="d021" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">同样的概念也适用于其他语言。如果您正在开发一个节点应用程序，您可以简单地使用npm将库安装到挂载的EFS中。稍后我们可以通过Lambda函数访问它们。</p><p id="ec99" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">完成安装包和上传文件后，您可以停止或终止EC2实例。如果需要进行其他更改，可以重新启动实例，甚至按照相同的步骤创建一个新实例。</p><h1 id="c27b" class="mp mq iq bd mr ms mt mu mv mw mx my mz kf na kg nb ki nc kj nd kl ne km nf ng bi translated">λ函数</h1><p id="d418" class="pw-post-body-paragraph ko kp iq kq b kr nh ka kt ku ni kd kw kx nj kz la lb nk ld le lf nl lh li lj ij bi translated">现在，您可以转到AWS控制台上的Lambda仪表板，创建您的Lambda函数，命名它并展开高级设置部分。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi oh"><img src="../Images/ecf6a484d1fd6358fd46f71cb8891c90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yBzRAHsmT2fzbFtKy0zTXA.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">Lambda高级设置</p></figure><p id="2b90" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在这里，确保您已经选择了VPC，以及我们之前创建的安全组。然后，您可以创建Lambda函数。这可能需要几分钟时间。</p><p id="8ac8" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">一旦创建了Lambda函数，并且您看到了确认消息，请进入Lambda函数的“配置”选项卡的“文件系统”部分。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi oi"><img src="../Images/b4c52fb8817047bb2b31f857595d18a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sut8I2T566hP7fMFzX0Xug.png"/></div></div></figure><p id="2b19" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">单击“Add file system”按钮将允许您选择我们之前创建的文件系统和访问点。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi oj"><img src="../Images/3583b3cb44ec2a5175834d4b8215566d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vd3GDwOI4oIKwfPh4QiYgw.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">Lambda中的文件系统设置</p></figure><p id="54bb" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">请注意，这里的挂载路径略有不同。只需复制这个路径，我们将在环境变量部分使用它。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi ok"><img src="../Images/3f4fbb4dbb4c2796d715f2b17db9897b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D6QZ79xbDBlbvD7aUXG0Tw.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">环境变量</p></figure><p id="e29e" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">对于Python，我们有PYTHONPATH环境变量。在“环境变量”选项卡下，只需单击“编辑”并添加此变量，使用我们在上一步中使用的挂载路径(即/mnt/fs1)。对于node.js应用程序，您可以设置NODE_PATH变量等等。</p><p id="2281" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在你都准备好了。你安装的包可以直接从你的Lambda函数中加载，不需要做任何其他事情。您还可以从同一个Lambda函数中访问添加到EFS的其他文件。</p></div></div>    
</body>
</html>