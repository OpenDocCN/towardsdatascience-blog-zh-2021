<html>
<head>
<title>Create Airflow roles with permissions from cli</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 cli 权限创建气流角色</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/create-airflow-roles-with-permissions-from-cli-64e05aaeb2fc?source=collection_archive---------14-----------------------#2021-11-02">https://towardsdatascience.com/create-airflow-roles-with-permissions-from-cli-64e05aaeb2fc?source=collection_archive---------14-----------------------#2021-11-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="353d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">直接从 cli 而不是 UI 创建具有 dag 级别气流权限的角色</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f349c1e13d7ab4392f29eae6b11f559e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hGq5gFbBdhxmJiQX6uJwkQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h1 id="a5bc" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">成为管理员</h1><p id="101b" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">Airflow 提供了一种通过<a class="ae mm" href="https://cloud.google.com/composer/docs/airflow-rbac" rel="noopener ugc nofollow" target="_blank"> RBAC 角色</a>管理多个用户权限的方法。这些权限可以直接从 Airflow 的 UI 编辑(RBAC 默认使用 Airflow ≥ 2.0 激活。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/ff1350ab9047729a051b0623319a53f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qAorxJBANPQsq3scEtedVA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。气流中默认 RBAC 角色的 UI 视图</p></figure><blockquote class="mo mp mq"><p id="45f2" class="lq lr mr ls b lt ms ju lv lw mt jx ly mu mv mb mc mw mx mf mg my mz mj mk ml im bi translated">只有当连接的用户拥有<strong class="ls iu">管理员角色时，才能访问这些角色。</strong></p></blockquote><p id="045b" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">默认情况下，当您第一次连接到 Airflow 时，角色是 Op，这是仅次于 Admin 的第二高角色。此角色没有足够的权限来管理角色。要成为管理员，请使用以下命令:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="736f" class="nf kz it nb b gy ng nh l ni nj">airflow users add-role -e <em class="mr">your_email</em> -r Admin</span></pre><p id="f81b" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">现在您是管理员，刷新气流页面，您应该可以访问具有角色和权限的安全菜单。</p><p id="1431" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">您将看到可以直接从 UI 编辑角色和权限。还可以创建 dag 级别的权限，即仅适用于给定 dag 的权限。现在假设您希望一些用户只访问一些特定的 Dag。直接从用户界面对多个 dag 使用 Dag 级别的权限非常容易出错且非常耗时，因为您必须从用户界面手动选择权限，甚至无法进行复制粘贴。</p><p id="4927" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">这就是为什么我创建了一个脚本，用于直接从 cli 创建具有预定义权限的角色。</p><h1 id="38af" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">剧本</h1><p id="097d" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">以下是用于创建具有足够权限来管理特定 Dag 的角色的脚本。</p><blockquote class="mo mp mq"><p id="6a29" class="lq lr mr ls b lt ms ju lv lw mt jx ly mu mv mb mc mw mx mf mg my mz mj mk ml im bi translated">最新版本托管在<a class="ae mm" href="https://github.com/TristanBilot/airflow-rbac-roles-cli" rel="noopener ugc nofollow" target="_blank">本回购</a>。</p></blockquote><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="e762" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">默认情况下，该脚本使用预定义的权限，允许用户仅访问参数中给定的 Dag，以便可以在同一个气流中托管由多个 Dag 组成的多个项目。</p></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><blockquote class="mo mp mq"><p id="b69e" class="lq lr mr ls b lt ms ju lv lw mt jx ly mu mv mb mc mw mx mf mg my mz mj mk ml im bi translated">请注意，可以根据您的特定用例在代码中直接编辑权限。气流 RBAC 许可语法的详细列表可以在<a class="ae mm" href="https://github.com/apache/airflow/blob/d1f3d8ec19d3c3b2494fbcd5a1adb5be4d4af03b/airflow/security/permissions.py" rel="noopener ugc nofollow" target="_blank">气流代码</a>中找到。</p></blockquote><h1 id="bf46" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">例子</h1><p id="a924" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">假设我的气流中有两把匕首。每个项目一个。我想为这两个项目创建一个角色，以便只授权从事特定项目的用户查看相应的 dag。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/05362fb94f467b2969b9b1f937ab5ffa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WmhLOKmkVFGwXxeeYR6VLA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。气流中的两个 Dag</p></figure><h2 id="b49b" class="nf kz it bd la nu nv dn le nw nx dp li lz ny nz lk md oa ob lm mh oc od lo oe bi translated">创建角色</h2><p id="2963" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">然后，我使用该脚本为 Dag“tutorial”创建一个访问受限的新角色。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="b56f" class="nf kz it nb b gy ng nh l ni nj">python3 rbac_roles_cli.py \<br/>-u http://localhost:4444 \<br/>-r TutorialRole \<br/>-d tutorial</span></pre><ul class=""><li id="023d" class="of og it ls b lt ms lw mt lz oh md oi mh oj ml ok ol om on bi translated">-u:(url)air flow UI 根页面的 URL。</li><li id="9d5d" class="of og it ls b lt oo lw op lz oq md or mh os ml ok ol om on bi translated">-r: (role)新角色的名称。</li><li id="31dc" class="of og it ls b lt oo lw op lz oq md or mh os ml ok ol om on bi translated">-d:(Dag)允许访问的 Dag 列表，用空格分隔。</li></ul><p id="62bb" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">如果返回错误，请检查您是否是 Airflow 的管理员，以及使用-d 选项指定的 Dag 是否存在。</p><h2 id="96bd" class="nf kz it bd la nu nv dn le nw nx dp li lz ny nz lk md oa ob lm mh oc od lo oe bi translated">向用户添加角色</h2><p id="3ec4" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">现在，我们必须使用 Airflow 的 cli 向现有用户添加新角色。如果用户尚未在 Airflow 中创建，请遵循<a class="ae mm" href="https://airflow.apache.org/docs/apache-airflow/stable/cli-and-env-variables-ref.html#create_repeat1" rel="noopener ugc nofollow" target="_blank">这些步骤</a>。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="9034" class="nf kz it nb b gy ng nh l ni nj">airflow users add-role -e tutorial_user@gmail.com -r TutorialRole</span></pre><p id="199d" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">从管理员用户的角度来看，我们可以在“Security menu”&gt;“List Roles”中看到已经正确创建了角色。通过分析权限，您可以看到 dag 级别的权限也被添加到角色中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/1451d4381249ed73d537661080b68036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HDRHTfYe4Q_JKNBQzJkrdw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。在气流 UI 视图中创建的角色</p></figure><p id="fda9" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">现在，为了确保用户只拥有已创建的角色，您可以使用以下命令删除其他角色，如 Op 或 Admin:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="b8c0" class="nf kz it nb b gy ng nh l ni nj">airflow users remove-role -e tutorial_user@gmail.com -r Op<br/>airflow users remove-role -e tutorial_user@gmail.com -r Admin</span></pre><blockquote class="mo mp mq"><p id="eda8" class="lq lr mr ls b lt ms ju lv lw mt jx ly mu mv mb mc mw mx mf mg my mz mj mk ml im bi translated">如果一个给定的用户有多个角色，这个用户的权限将是每个角色权限的总和，所以你必须小心，这个用户只有这一个角色。</p></blockquote><h2 id="9399" class="nf kz it bd la nu nv dn le nw nx dp li lz ny nz lk md oa ob lm mh oc od lo oe bi translated">测试权限</h2><p id="ac9d" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">现在，使用创建的角色登录帐户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/6259026a31caf2ba159e6202884b4e0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0WQCZaFLBzVHdZijaR617A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。用户对创建的角色中定义的 Dag 具有有限的访问权限。</p></figure><p id="54fe" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">用户现在只能访问创建角色时给出的 dag:在本例中，只能访问 Dag“tutorial”。用户甚至可以编辑 dag，查看日志和代码。如果您想个性化该用户的权限，您可以在代码中自由添加/删除一些权限。</p><h1 id="915b" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">与 Cloud Composer 兼容</h1><p id="5eb3" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">有人用 Cloud Composer 直接在 Google 云平台管理自己的气流。因为 Composer 在访问 GCP 的资源之前需要对 Google 进行认证，所以我们必须生成一个 Google 访问令牌，以便在使用脚本之前对 GCP 进行认证。</p><h2 id="736e" class="nf kz it bd la nu nv dn le nw nx dp li lz ny nz lk md oa ob lm mh oc od lo oe bi translated">创建 OAuth 凭据</h2><p id="5445" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">为了与 Google APIs 通信，我们必须使用在 GCP 创建的个人令牌。这个令牌是 OAuth 令牌。要创建该令牌，请执行以下操作:</p><p id="830a" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated"><strong class="ls iu">在 GCP</strong>:API&amp;服务<strong class="ls iu">&gt;T5】凭证<strong class="ls iu"> &gt; </strong>创建凭证<strong class="ls iu"> &gt; </strong> OAuth 客户端 ID <strong class="ls iu"> &gt; </strong>电视和受限设备</strong></p><p id="b049" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">创建了 OAuth 令牌，现在您拥有了一个<strong class="ls iu">客户端 ID </strong>和一个<strong class="ls iu">客户端秘密</strong>。</p><h2 id="a5be" class="nf kz it bd la nu nv dn le nw nx dp li lz ny nz lk md oa ob lm mh oc od lo oe bi translated">获取授权码</h2><p id="9a6a" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">在以下 URL 中替换您的用户 ID，并在浏览器中直接调用它。</p><p id="a045" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated"><a class="ae mm" href="https://accounts.google.com/o/oauth2/v2/auth?client_id=XXXX.apps.googleusercontent.com&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;scope=https://www.googleapis.com/auth/userinfo.profile&amp;response_type=code" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/o/oauth2/v2/auth?client_id=<strong class="ls iu">client _ id</strong>&amp;redirect _ uri = urn:IETF:WG:oauth:2.0:OOB&amp;scope = https://www . Google APIs . com/auth/userinfo . profile&amp;response _ type = code</a></p><p id="0f8a" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">该页面要求您使用您的 Google 帐户登录，然后复制显示的代码:这是授权代码。这个代码是临时的，所以我们将创建一个比这个更长的令牌。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/1a9538d2cfad7f6756d5606bf51d7609.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8NtyQKV9b5HmbXsOuVxduw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。谷歌授权码</p></figure><h2 id="34c7" class="nf kz it bd la nu nv dn le nw nx dp li lz ny nz lk md oa ob lm mh oc od lo oe bi translated">获取访问令牌</h2><p id="3f73" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">现在启动一个新的终端，粘贴这个 curl 并用您在上一步中复制的代码替换<strong class="ls iu"><em class="mr">authorization _ code</em></strong>，用在 GCP 用 OAuth 令牌创建的客户端 id 和 secret 替换<strong class="ls iu"> <em class="mr"> client_id </em> </strong>和<strong class="ls iu"> <em class="mr"> client_secret </em> </strong>。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="fa17" class="nf kz it nb b gy ng nh l ni nj">curl -s \<br/> — request POST \<br/> — data \<br/>“code=<strong class="nb iu"><em class="mr">authorization_code</em></strong>&amp;client_id=<strong class="nb iu"><em class="mr">client_id</em></strong>&amp;client_secret=<strong class="nb iu"><em class="mr">client_secret</em></strong>&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob&amp;grant_type=authorization_code” \<br/><a class="ae mm" href="https://accounts.google.com/o/oauth2/token" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/o/oauth2/token</a></span></pre><p id="1056" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">此 post 请求的响应应遵循以下模式:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="bba5" class="nf kz it nb b gy ng nh l ni nj">{<br/>  “<strong class="nb iu"><em class="mr">access_token</em></strong>”: “ya29.a0ARrdaM-az...”,<br/>  “expires_in”: 3599,<br/>  “refresh_token”: “1//03uXjr...”,<br/>  “scope”: “https://www.googleapis.com/auth/userinfo.profile",<br/>  “token_type”: “Bearer”,<br/>  “id_token”: “eyJaaza...“<br/>}</span></pre><p id="d758" class="pw-post-body-paragraph lq lr it ls b lt ms ju lv lw mt jx ly lz mv mb mc md mx mf mg mh mz mj mk ml im bi translated">复制响应中给出的 access_token。</p><h2 id="d28a" class="nf kz it bd la nu nv dn le nw nx dp li lz ny nz lk md oa ob lm mh oc od lo oe bi translated">使用脚本</h2><p id="3c0b" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">最后，我们将使用之前用于标准气流的相同命令，只是我们必须为访问令牌指定一个选项，以便与受 Google 保护的 Composer Airflow 页面进行交互。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="a03c" class="nf kz it nb b gy ng nh l ni nj">python3 rbac_roles_cli.py \<br/>-u <strong class="nb iu"><em class="mr">https://...composer.googleusercontent.com</em></strong> \<br/>-r TutorialRole \<br/>-d tutorial \<br/><strong class="nb iu"><em class="mr">-t access_token</em></strong></span></pre><h2 id="0be9" class="nf kz it bd la nu nv dn le nw nx dp li lz ny nz lk md oa ob lm mh oc od lo oe bi translated">将用户添加到角色</h2><p id="a76c" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">可以使用 gcloud beta cli API 添加用户。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="3273" class="nf kz it nb b gy ng nh l ni nj">gcloud beta composer environments run example-environment — location europe-west1 users add-role — -e name<a class="ae mm" href="mailto:tristan_bilot@carrefour.com" rel="noopener ugc nofollow" target="_blank">@organization.com</a> -r TutorialRole</span></pre><h1 id="d05d" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">结论</h1><p id="6a4a" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">Airflow 没有提供一种直接在 cli 中创建具有特定权限的角色的本机方法，除非使用一个复杂的、糟糕的、带有长卷的 API。提议的脚本使用 Python 轻松地操作这个 API，以便创建具有权限的角色。如果发生任何问题，请随时<a class="ae mm" href="https://github.com/TristanBilot/airflow-rbac-roles-cli/issues" rel="noopener ugc nofollow" target="_blank">提出问题</a>。尽情享受吧！</p></div></div>    
</body>
</html>