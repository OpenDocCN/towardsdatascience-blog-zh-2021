<html>
<head>
<title>Creating an environment with Airflow and DBT on AWS (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在自动气象站上创造一个有气流和DBT的环境(第二部分)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/creating-an-environment-with-airflow-and-dbt-on-aws-part-2-a23617d56eeb?source=collection_archive---------11-----------------------#2021-05-19">https://towardsdatascience.com/creating-an-environment-with-airflow-and-dbt-on-aws-part-2-a23617d56eeb?source=collection_archive---------11-----------------------#2021-05-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ba5c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">安装DBT和一些设置，使工作更容易</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/70da6c07650ff5dd2017b3dd897eb073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KndJwMEDukSRnw-s"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kv" href="https://unsplash.com/@writecodenow?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Boitumelo Phetla </a>拍摄的照片</p></figure><p id="ae05" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文第1部分的<a class="ae kv" rel="noopener" target="_blank" href="/creating-an-environment-with-airflow-and-dbt-on-aws-part-1-ca13bc95f479">中，我们启动了一个EC2实例，安装了一些操作系统需求，然后是气流。现在，我们将安装DBT。但是首先让我们做一些设置来简化一些事情。</a></p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="0d14" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak"> 1。使用airflow用户</strong>连接到ec2实例</h1><p id="127b" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">到目前为止，我们使用默认用户ec2-user连接到EC2实例。然后我们转向用户气流，我们装置的所有者。我们可以简化连接步骤，允许与气流用户直接连接。为此，首先转到VSCode，连接到EC2实例并切换到airflow用户。现在，我们需要创建一个目录来存储ssh授权的密钥，复制包含它们的文件(该文件允许使用。pem文件在我们启动实例时生成)并调整一些权限。以下是命令。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="09f6" class="nb ma iq mx b gy nc nd l ne nf">$ mkdir ~/.ssh<br/>$ sudo cp /home/ec2-user/.ssh/authorized_keys ~/.ssh/authorized_keys<br/>$ sudo chown airflow:airflow ~/.ssh/authorized_keys<br/>$ sudo chmod 700 ~/.ssh<br/>$ sudo chmod 600 ~/.ssh/authorized_keys</span></pre><p id="a7dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在VSCode中，按F1，键入SSH并选择“添加新的SSH主机”。现在，使用我们在第1部分中使用的相同命令，但是改变用户。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="ee12" class="nb ma iq mx b gy nc nd l ne nf">ssh -i airflow_server.pem airflow@myinstancehost</span></pre><p id="99f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">按照第1部分的相同说明调整的路径。pem文件在SSH配置文件中，为新连接选择一个名称，然后保存文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/1ba8848bc19b938914297a3906366d2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ALkoxuXgBhZH47reWtaqiw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">带有新连接的SSH配置文件</p></figure><p id="909c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">之后，再次按F1，选择连接到主机，并选择新的连接。现在，您已连接到带有气流用户的实例。每当您需要停止实例并再次连接时，您可以考虑对这个用户使用这个连接。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="3d84" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">2.自动启动气流服务</h1><p id="30df" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">要像第1部分那样启动airflow，我们只需运行Airflow命令(webserver和scheduler)。但是我们必须打开两个终端，并让它们在VSCode上打开。我们可以使用<em class="nh"> nohup </em>从终端分离命令。更好的选择是将这些服务作为守护进程运行。这不仅可以更容易地启动/停止服务，还可以更容易地自动启动服务和实例。</p><p id="efd7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为此，我们将使用Airflow github中的可用文件，并做一些调整。</p><p id="2a1f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，在/etc/sysconfig中创建一个文件，名为airflow:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="346d" class="nb ma iq mx b gy nc nd l ne nf">$ sudo vi /etc/sysconfig/airflow</span></pre><p id="691b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">而内容:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="ff69" class="nb ma iq mx b gy nc nd l ne nf">AIRFLOW_CONFIG=/home/airflow/airflow/airflow.cfg<br/>LD_LIBRARY_PATH=/usr/local/lib</span></pre><p id="6fd6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这定义了运行airflow命令时将使用的两个环境变量，以及Airflow配置文件的路径和sqlite正确版本的目录。</p><p id="624d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，在/usr/lib/systemd/system中创建一个名为airflow-webserver.service的文件:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="8a2e" class="nb ma iq mx b gy nc nd l ne nf">$ sudo vi /usr/lib/systemd/system/airflow-webserver.service</span></pre><p id="7c06" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">内容如下。请注意，我正在传递端口，尽管我使用的是默认值8080。如果您打算让其他应用程序使用8080端口在同一服务器上运行，您可以更改为使用另一个端口:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="8b27" class="nb ma iq mx b gy nc nd l ne nf">[Unit]<br/>Description=Airflow webserver daemon<br/>After=network.target postgresql.service mysql.service redis.service rabbitmq-server.service<br/>Wants=postgresql.service mysql.service redis.service rabbitmq-server.service</span><span id="d3e7" class="nb ma iq mx b gy ni nd l ne nf">[Service]<br/>PIDFile=/run/airflow/webserver.pid<br/>EnvironmentFile=/etc/sysconfig/airflow<br/>User=airflow<br/>Group=airflow<br/>Type=simple<br/>ExecStart=/usr/bin/bash -c 'source /home/airflow/.venv/airflow/bin/activate; airflow webserver -p 8080 --pid /run/airflow/webserver.pid'<br/>ExecReload=/bin/kill -s HUP $MAINPID<br/>ExecStop=/bin/kill -s TERM $MAINPID<br/>Restart=on-failure<br/>RestartSec=5s<br/>PrivateTmp=true</span><span id="b505" class="nb ma iq mx b gy ni nd l ne nf">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="92dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在同一个目录中创建另一个文件，名为airflow-scheduler.service:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="220c" class="nb ma iq mx b gy nc nd l ne nf">$ sudo vi /usr/lib/systemd/system/airflow-scheduler.service</span></pre><p id="ba4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">而内容:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="8170" class="nb ma iq mx b gy nc nd l ne nf">[Unit]<br/>Description=Airflow scheduler daemon<br/>After=network.target postgresql.service mysql.service redis.service rabbitmq-server.service<br/>Wants=postgresql.service mysql.service redis.service rabbitmq-server.service</span><span id="a194" class="nb ma iq mx b gy ni nd l ne nf">[Service]<br/>PIDFile=/run/airflow/webserver.pid<br/>EnvironmentFile=/etc/sysconfig/airflow<br/>User=airflow<br/>Group=airflow<br/>Type=simple<br/>ExecStart=/usr/bin/bash -c 'source /home/airflow/.venv/airflow/bin/activate; airflow scheduler --pid /run/airflow/webserver.pid'<br/>KillMode=process<br/>Restart=always<br/>RestartSec=5s</span><span id="f8c4" class="nb ma iq mx b gy ni nd l ne nf">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="9cad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，创建一个文件/usr/lib/tmpfiles . d/air flow . conf，包含:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="63dc" class="nb ma iq mx b gy nc nd l ne nf">$ sudo vi /usr/lib/tmpfiles.d/airflow.conf</span></pre><p id="929b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以及下面的内容:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="db19" class="nb ma iq mx b gy nc nd l ne nf">D /run/airflow 0755 airflow airflow</span></pre><p id="34db" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在创建一个目录，归airflow所有:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="7681" class="nb ma iq mx b gy nc nd l ne nf">$ sudo mkdir /run/airflow<br/>$ sudo chown -R airflow:airflow /run/airflow</span></pre><p id="0b39" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，现在两个服务Scheduler和Webserver能够作为守护进程运行了。要让它们自动启动，只需运行以下命令:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="7dea" class="nb ma iq mx b gy nc nd l ne nf">$ sudo systemctl enable airflow-webserver.service<br/>$ sudo systemctl enable airflow-scheduler.service</span></pre><p id="4ecd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果在启动实例后还没有启动Airflow，现在只需运行:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="088c" class="nb ma iq mx b gy nc nd l ne nf">$ sudo systemctl start airflow-webserver.service<br/>$ sudo systemctl start airflow-scheduler.service</span></pre><p id="99c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要检查服务的状态，可以运行以下命令</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="5fe9" class="nb ma iq mx b gy nc nd l ne nf">$ sudo systemctl status airflow-webserver.service<br/>$ sudo systemctl status airflow-scheduler.service</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/38fd6c0f59bb1f66d9db7acb38d94f72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hez6wDaP_U5FfNOK6ZRSVw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">绿色消息，显示服务正在运行</p></figure><p id="e871" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们期望的结果是绿色的“活动(运行)”状态。如果您遇到不同的情况，显示服务没有运行，您可以使用命令检查服务的输出(100是我想要显示的行数，您可以更改):</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="63fe" class="nb ma iq mx b gy nc nd l ne nf">$ journalctl -u airflow-webserver -n 100<br/>$ journalctl -u airflow-scheduler -n 100</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="4da7" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">3.安装DBT</h1><p id="7c37" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">现在，是时候安装DBT了。由于我们将使用Airflow来编排DBT作业，并希望进行简单而廉价的配置，因此我们将把它安装在同一台服务器上。</p><p id="5760" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您遵循了本文的第1部分，那么您已经安装了所有的操作系统需求。现在我们只需要安装Python包。首先，激活我们创建的python环境:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="eb68" class="nb ma iq mx b gy nc nd l ne nf">$ source ~/.venv/airflow/bin/activate</span></pre><p id="326f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，安装安装DBT所需的这两个包</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="7f94" class="nb ma iq mx b gy nc nd l ne nf">$ pip3 install pyicu-binary pyicu</span></pre><p id="d544" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们现在可以安装dbt，命令如下:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="5957" class="nb ma iq mx b gy nc nd l ne nf">$ pip3 install dbt</span></pre><p id="a4fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">几秒钟后，您将看到成功的消息。如果在安装dbt的过程中，您收到一些失败的消息，告知您。h文件没有找到，这可能是因为gcc包只寻找/usr/include文件夹。如果发生这种情况，运行下面的命令来创建指向gcc试图找到的文件夹中的标题的符号链接:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="0a2d" class="nb ma iq mx b gy nc nd l ne nf">$ sudo ln -sv /usr/include/python2.7/* /usr/include/</span></pre><p id="0b04" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，您可以使用以下命令检查一切是否正常:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="1833" class="nb ma iq mx b gy nc nd l ne nf">$ dbt --version</span></pre><p id="942a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该命令将显示dbt及其插件的版本。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/63ff5a38df9decf4c0b9c851503b2851.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*W2ELKhKmZr6j7tQ60r0ANQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">检查dbt版本时的输出</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="0d6a" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">4.在RDS上启动数据库</h1><p id="86c3" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">DBT是一个运行在数据仓库上的工具。虽然它与红移兼容，但也与Postgres兼容。为了避免一些意外的红移计费(由于空闲层周期过期或群集配置的资源/时间超过空闲层)，这可能非常昂贵，我们将在RDS上使用Postgres。您可以选择使用红移，只需注意我们将要进行的配置，您可能会在需要时进行切换。还要记住使用端口5439，而不是5432。</p><p id="5306" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，转到AWS管理控制台并访问RDS页面。选择创建数据库。在配置页面，选择'标准创建'，选择' PostgreSQL '，就可以保留12.5-R1版本。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/7e167c0fa8b3ff6d2bb34bb97b60b345.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nlFcUCDn8AYGBN0vY0_uCw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建数据库</p></figure><p id="7fa7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">选择自由层模板，以便更容易配置此数据库。为您的实例选择任意名称，主用户名和一些密码。</p><p id="25c9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在“公共访问”选项中，您需要选择“是”，这样您就可以从您的网络进行连接。</p><p id="ed92" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您不需要更改此页面中的任何其他选项，只需单击“创建数据库”即可。</p><p id="7666" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您将被重定向到数据库列表。选择您刚刚创建的那个。等待几分钟，直到您看到状态为“可用”。</p><p id="aec5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击数据库名称，进入配置页面。在“连接和安全”选项卡中，单击“VPC安全组”中的链接。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/ac7e6c88c797fcacf4931bc9deba2d6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CJnN9YOzeTEcmtq4T5vPIg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">打开安全组规则的链接</p></figure><p id="98b7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您将向数据库打开安全组规则。在页面的底部，有一些选项卡。选择入站规则，然后选择“编辑入站规则”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/6b24ac3bfa19535a1f4ddb97c6360960.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qTnuHcMuCfwF8sZ1sHEY7w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">向安全组添加新规则</p></figure><p id="01fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">单击“添加规则”。在类型中，选择“PostgreSQL”，在源中，使用EC2实例的私有IP。然后，点击“保存规则”。如果您找不到这个IP，您只需在一个新的选项卡上打开EC2页面，选择您的实例，并在“私有IPv4地址”中复制该IP。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/8bc5d8ea57feedb4d11192d07d8c39e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NvvyC4IFDeL9tz4mbMmiTg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">允许您的实例连接到数据库</p></figure><p id="8150" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，连接到您的新数据库(我建议使用DBeaver，但是您可以自由选择您自己的工具)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/70f81ed81774b764b27ca7bb11261ac1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cwKSIU1JrS7eCKw57531mg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在DBeaver上创建连接非常简单</p></figure><p id="3a3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在默认数据库postgres中，创建两个模式，一个名为“data_warehouse ”,另一个名为“data_lake”。如果您愿意，也可以创建一个特定的数据库来完成这项工作，但是我将保持简单，使用postgres数据库。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/ba780b15346be4445d7ef64827379e4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:616/format:webp/1*84qBqWukKarD_vxkOoOWAg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Dbeaver上的数据库连接，带有两个新模式</p></figure><p id="5423" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，在数据库上创建一个表并添加一些数据。只需在DBeaver上运行:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="166d" class="nb ma iq mx b gy nc nd l ne nf">create table data_lake.user (name varchar(256), birth_date DATE, email varchar(256));</span><span id="8dae" class="nb ma iq mx b gy ni nd l ne nf">insert into data_lake.user values<br/>('Ted Mosby', '1978-07-04', 'ted.mosby@mosbiusdesign.com'),<br/>('Robin Scherbatsky', '1980-12-04', 'bus.lady@world.com'),<br/>('Barney Stinson', '1976-11-02', 'suitup@gnb.com'),<br/>('Marshall Eriksen', '1978-03-16', 'fudge@supreme.com'),<br/>('Lily Aldrin', '1979-09-22', 'comisisoner@slapbet.com');</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="e16b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">5.配置DBT</h1><p id="b7c8" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们需要配置的第一件事是概要文件。在这个文件中，我们将信息连接到我们的数据仓库，所以当我们有不同的基础和模式时，这里是我们将要添加它们的地方。<br/>存储该文件的默认路径是在一个名为. dbt的隐藏文件夹中。您也可以更改权限以避免对该文件的未授权访问，因为现在，我们将把密码保存在该文件中。因此，要创建目录和文件:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="8052" class="nb ma iq mx b gy nc nd l ne nf">$ mkdir ~/.dbt<br/>$ vi ~/.dbt/profiles.yml</span></pre><p id="0d20" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并添加信息以连接到您的数据库，在这种情况下切换到您自己的信息:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="a7de" class="nb ma iq mx b gy nc nd l ne nf">dw_dev:<br/>  target: data_warehouse<br/>  outputs:<br/>    data_warehouse:<br/>      type: postgres<br/>      host: your-db-host<br/>      user: postgres<br/>      pass: postgres<br/>      port: 5432<br/>      dbname: postgres<br/>      schema: data_warehouse<br/>      threads: 4<br/>      keepalives_idle: 0</span></pre><p id="ed0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们需要创建dbt_project文件。该文件包含有关项目的信息。让我们也创建一个文件夹来保存我们将与DBT一起使用的文件:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="b9ea" class="nb ma iq mx b gy nc nd l ne nf">$ mkdir ~/dbt<br/>$ cd ~/dbt<br/>$ vi ~/dbt/dbt_project.yml</span></pre><p id="7e61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在DBT页面，你可以找到这个文件的例子。现在，我们将只添加一些属性。在提高DBT的使用后，您可以添加其他属性。因此，将以下内容添加到该文件中:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="30dd" class="nb ma iq mx b gy nc nd l ne nf">name: 'project_dbt_airflow'<br/>config-version: 2<br/>version: 1.0</span><span id="aefe" class="nb ma iq mx b gy ni nd l ne nf">profile: dw_dev</span><span id="fd04" class="nb ma iq mx b gy ni nd l ne nf">source-paths: ['source']<br/>data-paths: ['data']<br/>test-paths: ['test']<br/>analysis-paths: ['analysis']<br/>macro-paths: ['macro']<br/>snapshot-paths: ['snapshots']</span><span id="02c1" class="nb ma iq mx b gy ni nd l ne nf">models:</span><span id="7a47" class="nb ma iq mx b gy ni nd l ne nf">    +materialized: table<br/>    +enabled: true</span></pre><p id="d481" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，创建文件夹来存储模型。sql文件)。正如你在前面文件的内容中看到的，我们还可以有其他目录(用于测试、宏等。)，但是我们现在不打算使用它们。此外，创建一个文件来运行我们在DBT的第一个模型:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="018b" class="nb ma iq mx b gy nc nd l ne nf">$ mkdir ~/dbt/source<br/>$ vi ~/dbt/source/user.sql</span></pre><p id="739d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">加上这一行:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="5a7b" class="nb ma iq mx b gy nc nd l ne nf">select * from data_lake.user</span></pre><p id="905c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们准备第一次运行dbt。转到dbt项目文件夹并运行dbt命令:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="5c1c" class="nb ma iq mx b gy nc nd l ne nf">$ cd ~/dbt<br/>$ dbt run</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/addf5abbd77e1ac2052affb0224ce3b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3QUMJknh-2rJZrBMf8s3hQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">运行dbt run命令后的输出</p></figure><p id="eec5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">DBT现在所做的是运行查询，然后用查询的结果创建一个模型(在本例中是一个表)。如果您有一个可以从数据仓库连接访问源数据的架构(就像s3上的数据湖，由带有Spectrum的Redshift上的数据仓库访问)，您可以像这样运行模型查询您的源数据。如果不是这样，您首先必须将数据从您的源移动到您的数据仓库(正如DBT文档中所指定的，它只适用于ETL的T)。但是你总是可以在气流上增加一些步骤来做这件事，作为你管道的一部分。</p><p id="178a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">无论如何，您可以在DBeaver上检查数据仓库中的数据，使用:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="5bb9" class="nb ma iq mx b gy nc nd l ne nf">select * from data_warehouse.user;</span></pre><p id="57f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们已经在实例上安装了DBT和气流。在接下来的部分中，我们将集成它们，使用Airflow来编排DBT的作业，还将使用DBT云来检查其他集成选项。</p><h1 id="d60a" class="lz ma iq bd mb mc ns me mf mg nt mi mj jw nu jx ml jz nv ka mn kc nw kd mp mq bi translated">阅读本文的所有部分:</h1><p id="bc1a" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">第1部分:<a class="ae kv" rel="noopener" target="_blank" href="/creating-an-environment-with-airflow-and-dbt-on-aws-part-1-ca13bc95f479">启动一个实例并安装气流</a> <br/>第2部分:安装DBT和一些设置使工作更容易<br/>第3部分:<a class="ae kv" rel="noopener" target="_blank" href="/creating-an-environment-with-airflow-and-dbt-on-aws-part-3-2789f35adb5d">使用DBT云并将气流与DBT集成</a></p><h1 id="eb61" class="lz ma iq bd mb mc ns me mf mg nt mi mj jw nu jx ml jz nv ka mn kc nw kd mp mq bi translated">参考资料:</h1><p id="40ae" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated"><a class="ae kv" href="https://www.getdbt.com/" rel="noopener ugc nofollow" target="_blank">https://www.getdbt.com/</a><br/><a class="ae kv" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank">https://airflow.apache.org/</a><br/><a class="ae kv" href="https://github.com/apache/airflow/tree/master/scripts/systemd" rel="noopener ugc nofollow" target="_blank">https://github . com/Apache/air flow/tree/master/scripts/systemd</a><br/><a class="ae kv" href="https://docs.getdbt.com/reference/dbt_project.yml" rel="noopener ugc nofollow" target="_blank">https://docs.getdbt.com/reference/dbt_project.yml</a></p><p id="7972" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">对我在这里所做的大部分事情有帮助的来源:<br/></strong><a class="ae kv" href="https://www.datascienceacademy.com.br" rel="noopener ugc nofollow" target="_blank">https://www.datascienceacademy.com.br</a><br/><a class="ae kv" href="https://docs.getdbt.com/docs/introduction" rel="noopener ugc nofollow" target="_blank">https://docs.getdbt.com/docs/introduction</a></p></div></div>    
</body>
</html>