<html>
<head>
<title>Deploying Kubeflow 1.3 RC with Argo CD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Argo CD部署Kubeflow 1.3 RC</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-kubeflow-1-3-rc-with-argo-cd-ca98606b98eb?source=collection_archive---------13-----------------------#2021-04-04">https://towardsdatascience.com/deploying-kubeflow-1-3-rc-with-argo-cd-ca98606b98eb?source=collection_archive---------13-----------------------#2021-04-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8a4e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用GitOps简化和自动化Kubeflow的部署</h2></div><p id="b4e7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Kubeflow是一个流行的开源机器学习平台，运行在Kubernetes上。Kubeflow简化了许多有价值的ML工作流，即它允许用户轻松部署开发环境、使用Kubeflow管道的可扩展ML工作流、使用Katib的自动化超参数调整和神经架构搜索、团队内的轻松协作等等。如此多的功能也带来了复杂性。完整的Kubeflow部署包含许多服务和依赖项，这使得用户很难使用传统的<a class="ae lb" href="https://github.com/kubeflow/kfctl" rel="noopener ugc nofollow" target="_blank"> kfctl </a> CLI工具和KfDef YAML文件来定制、管理和安装Kubeflow。出于这个原因，即将发布的Kubeflow 1.3版本已经停止使用<a class="ae lb" href="https://github.com/kubeflow/kfctl" rel="noopener ugc nofollow" target="_blank"> kfctl </a>，取而代之的是使用标准<a class="ae lb" href="https://kustomize.io/" rel="noopener ugc nofollow" target="_blank"> Kustomize </a>，使得使用GitOps工具如<a class="ae lb" href="https://argoproj.github.io/argo-cd/" rel="noopener ugc nofollow" target="_blank"> Argo CD </a>部署Kubeflow变得更加容易。</p><p id="1156" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Argo CD 是“一个用于Kubernetes的声明式GitOps连续交付工具”。<a class="ae lb" href="https://argoproj.github.io/" rel="noopener ugc nofollow" target="_blank"> Argo项目</a>已经与Kubeflow密切相关，因为Kubeflow管道在幕后使用<a class="ae lb" href="https://argoproj.github.io/projects/argo" rel="noopener ugc nofollow" target="_blank"> Argo工作流</a>，使得<a class="ae lb" href="https://argoproj.github.io/projects/argo-cd" rel="noopener ugc nofollow" target="_blank"> Argo CD </a>成为部署Kubeflow的自然选择。GitOps的一个简单描述是使用Git存储库作为部署所需状态的真实来源。然后，一个持续的交付工具，如<a class="ae lb" href="https://argoproj.github.io/projects/argo-cd" rel="noopener ugc nofollow" target="_blank"> Argo CD </a>监控Git存储库的变更和更新部署，如果需要的话。</p><p id="34cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">遵循该指南所需的代码和清单可以在https://github.com/argoflow/argoflow找到。部署应该与本地和云中的任何Kubernetes集群兼容。注意——虽然包含了一些额外的清单以使内部部署更加容易，例如<a class="ae lb" href="https://metallb.universe.tf/" rel="noopener ugc nofollow" target="_blank">metalllb</a>和<a class="ae lb" href="https://rook.io/" rel="noopener ugc nofollow" target="_blank"> Rook Ceph </a>，但这些清单在默认情况下是禁用的。</p><h1 id="38d9" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">准备</h1><p id="5a5f" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">第一步是派生出<a class="ae lb" href="https://github.com/argoflow/argoflow" rel="noopener ugc nofollow" target="_blank"> ArgoFlow </a>存储库并在本地克隆它。接下来，您需要安装<a class="ae lb" href="https://github.com/mikefarah/yq" rel="noopener ugc nofollow" target="_blank"> yq </a> version 4来使用允许您轻松设置fork的脚本和<a class="ae lb" href="https://github.com/kubernetes-sigs/kustomize/releases/tag/kustomize%2Fv4.0.5" rel="noopener ugc nofollow" target="_blank"> Kustomize v4.0.5 </a>来安装Argo CD和提供的清单。当然，访问Kubernetes集群也是一个要求。这可以通过虚拟机或云中的工具在本地完成，如<a class="ae lb" href="https://minikube.sigs.k8s.io/docs/start/" rel="noopener ugc nofollow" target="_blank"> minikube </a>、<a class="ae lb" href="https://kind.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank"> kind </a>或<a class="ae lb" href="https://microk8s.io/" rel="noopener ugc nofollow" target="_blank"> MicroK8s </a>。但是，设置Kubernetes集群超出了本文的范围。</p><h1 id="a850" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">安装Argo CD</h1><p id="1bd7" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">为了简单起见，Argo CD将与Kubeflow安装在同一个集群上。高可用性模式下的Argo CD 2.0 的候选版本是因为我喜欢与软件保持同步。对Argo CD配置做了一些优化，包括Kustomize的v4.0.5，这是撰写本文时的最新版本。</p><p id="14ce" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本地克隆了<a class="ae lb" href="https://github.com/argoflow/argoflow" rel="noopener ugc nofollow" target="_blank"> ArgoFlow </a>的分支后，您可以在<a class="ae lb" href="https://github.com/argoflow/argoflow" rel="noopener ugc nofollow" target="_blank"> ArgoFlow </a>文件夹中执行以下命令来安装Argo CD:</p><p id="2428" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">kustomize build argocd/ | kubectl apply -f -</code></p><p id="3990" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来在本地安装Argo CD <a class="ae lb" href="https://github.com/argoproj/argo-cd/releases/latest" rel="noopener ugc nofollow" target="_blank"> CLI </a>工具。要访问Argo CD UI，您可以使用负载平衡器公开其服务，使用<code class="fe lz ma mb mc b">kubectl</code>和端口转发进入或连接到它。Argo CD <a class="ae lb" href="https://argoproj.github.io/argo-cd/getting_started/" rel="noopener ugc nofollow" target="_blank">入门页面</a>有更多关于如何操作的说明。</p><p id="c789" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，通过执行以下命令来获取用户<code class="fe lz ma mb mc b">admin</code>的默认密码:</p><p id="57ee" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=”{.data.password}” | base64 -d</code></p><p id="27d1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以使用Argo CD CLI工具登录，并按如下方式更改默认密码:</p><p id="b795" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">argocd login &lt;ARGOCD_SERVER&gt; # e.g. localhost:8080 or argocd.example.com</code></p><p id="b14b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">argocd account update-password</code></p><p id="f296" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你现在应该可以用你的新密码登录Argo CD用户界面了。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/fb9b10aa481598e891ea6bc7d2aa0226.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6QKYGIiOUjo3XlexMjab3g.png"/></div></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">阿尔戈光盘网络界面</p></figure><h1 id="1e30" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">定制Kubeflow部署</h1><p id="1df2" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">清单已经设置了一些默认值来帮助新用户入门，但是大多数人都应该更改。例如，用户应该更改默认用户的密码，并在cert-manager中设置一个颁发者，以便为Istio入口网关创建正确的证书。许多人可能需要更改的另一件事是入口网关服务，默认情况下它设置为使用负载平衡器。为了保持这篇文章的清晰和中肯，我不会在这里详细讨论如何更改这些设置，因为这会涉及到很多文件链接。<a class="ae lb" href="https://github.com/argoflow/argoflow" rel="noopener ugc nofollow" target="_blank"> ArgoFlow </a>存储库中的<a class="ae lb" href="https://github.com/argoflow/argoflow/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>提供了更改部署的这些方面的说明。</p><h2 id="d30f" class="mt ld iq bd le mu mv dn li mw mx dp lm ko my mz lo ks na nb lq kw nc nd ls ne bi translated">准备部署Kubeflow</h2><p id="b7d7" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">除了不同Kubeflow组件的Kustomize清单，<a class="ae lb" href="https://github.com/argoflow/argoflow" rel="noopener ugc nofollow" target="_blank"> ArgoFlow </a>库还包含每个Kubeflow组件的Argo CD应用程序规范。为了使人们更容易选择和部署他们想要的组件，位于根存储库中的一个<code class="fe lz ma mb mc b">kustomization.yaml</code>文件用于定义应该部署哪些Argo CD应用程序。反过来，存储库根目录中的<code class="fe lz ma mb mc b">kubeflow.yaml</code>文件是前面提到的<code class="fe lz ma mb mc b">kustomization.yaml</code>文件的Argo CD应用程序。简单来说就是一个Argo CD应用，部署其他Argo CD应用。</p><p id="da41" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，需要编辑Argo CD应用程序规范，以便它们指向您的<a class="ae lb" href="https://github.com/argoflow/argoflow" rel="noopener ugc nofollow" target="_blank"> ArgoFlow </a>存储库的分支。包含一个脚本来简化这一过程。在存储库的根目录中，只需运行下面的命令来更新所有的应用程序规范，使其指向存储库的分支:</p><p id="3a42" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">./setup_repo.sh &lt;your_repo_fork_url&gt;</code></p><p id="06fe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">奖励:用文件浏览器扩展Volumes Web应用</strong></p><p id="2b8a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于许多人来说，一个大问题是如何容易地将数据上传到安装为笔记本服务器的工作区卷的PVC，或者从安装为笔记本服务器的工作区卷的PVC下载数据。为了使这更容易，创建了一个简单的PVCViewer控制器(tensorboard-controller的稍微修改版本)。PVC查看器将与ReadWriteOnce PVCs一起工作，即使它们安装在活动的笔记本服务器上。这个特性在1.3版本中还没有准备好，因此我在这里只是把它作为一个实验性的特性来记录，因为我相信很多人都想拥有这个功能。它(还)不是上游库伯流的一部分，将来可能会改变。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nf"><img src="../Images/f6438f932d387b42c4fc22b68dd0add0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*alybnF3dDIZZTvubroiBiw.gif"/></div></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">运行中的PVC查看器演示</p></figure><p id="28eb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想要部署这个特性，您需要注释掉根<code class="fe lz ma mb mc b">kustomization.yaml</code>文件中的<code class="fe lz ma mb mc b">argocd-applications/volumes-web-app.yaml</code>条目，并取消注释以下两行:</p><pre class="me mf mg mh gt ng mc nh ni aw nj bi"><span id="8589" class="mt ld iq mc b gy nk nl l nm nn">- argocd-applications/experimental-pvcviewer-controller.yaml</span><span id="577c" class="mt ld iq mc b gy no nl l nm nn">- argocd-applications/experimental-volumes-web-app.yaml</span></pre><p id="9d1f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦您完成了对部署的定制，只需将您的更改提交并推送到您的<a class="ae lb" href="https://github.com/argoflow/argoflow" rel="noopener ugc nofollow" target="_blank"> ArgoFlow </a>存储库的分支中。</p><h1 id="7b13" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">部署Kubeflow</h1><p id="ab3f" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">在提交和推送您的更改后，您可以通过执行以下命令来安装Kubeflow:</p><p id="be48" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">kubectl apply -f kubeflow.yaml</code></p><p id="3436" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">也可以手动安装组件。例如:</p><p id="fa6a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lz ma mb mc b">kubectl apply -f argocd-applications/kubeflow-roles-namespaces.yaml</code></p><p id="88f8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您现在应该开始看到应用程序出现在Argo CD UI中，如果一切顺利，它们应该是“健康的”和“同步的”。由于Kubeflow部署中的大量资源以及一些先有鸡还是先有蛋的场景，一些应用程序可能会保持“不同步”一段时间。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi np"><img src="../Images/637f89b2aa15850044dce49576515587.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DMK-5RqsaZaEl8xWA_c-Ww.png"/></div></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">Kubeflow组件在Argo CD中的应用</p></figure><p id="f0e4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过点击一个应用程序，Argo CD将向您展示由该应用程序创建的所有资源的概述。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nq"><img src="../Images/d1cdc2065303d912d6e40fcca2002827.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MivJLVFlLISnTr805a6TKw.png"/></div></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">Argo CD中Jupyter Web应用程序资源概述</p></figure><p id="a104" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过点击任何资源，Argo CD将向您显示有用的信息，例如当前部署的YAML与Git库或pod日志中声明的内容之间的差异。</p><h2 id="ce29" class="mt ld iq bd le mu mv dn li mw mx dp lm ko my mz lo ks na nb lq kw nc nd ls ne bi translated">更新您的部署</h2><p id="b068" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">要更新或更改您的部署，只需将您的更改提交并推送到您的存储库，Argo CD将自动检测并更改您的Kubernetes集群中的部署。</p><h1 id="3b8e" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">结论</h1><p id="1569" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">由于即将发布的Kubeflow 1.3使用标准Kustomize，这使得使用Argo CD等工具来管理其部署变得更加容易。此外，由于Kubeflow的大小和复杂性，使用GitOps和Argo CD的声明性方法应该使用户更容易定制和部署适合他们需求的Kubeflow。</p></div></div>    
</body>
</html>