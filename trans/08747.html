<html>
<head>
<title>Hunting threats with Pandas 🐼👊 — $MFT Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与熊猫的狩猎威胁🐼👊——MFT分析公司</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/hunting-threats-with-pandas-mft-analysis-9f96a99ef27a?source=collection_archive---------26-----------------------#2021-08-12">https://towardsdatascience.com/hunting-threats-with-pandas-mft-analysis-9f96a99ef27a?source=collection_archive---------26-----------------------#2021-08-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ed69" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">利用数据分析技术和工具改进事故响应。</h2></div><p id="2586" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我看来，看到网络安全的发展方向确实令人兴奋。事件响应甚至威胁追踪越来越多地与海量信息的处理联系在一起。我认为这一方面是由于当前设备存储和/或生成的遥测数据量，另一方面是由于越来越多的事故，其中许多是非常大的事故，涉及许多计算机，甚至一个组织的许多站点。<br/>这意味着，当我们必须在威胁追踪中找到组织内的攻击者时，或者当我们必须在DFIR演习中找到攻击者的踪迹时，我们必须处理越来越多的信息，来自多个来源、具有不同格式的数百万个事件……这简直是一场噩梦。</p><p id="715f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我一直认为，编程是任何网络安全分析师的基本技能，如果我们没有最起码的知识，我们注定要一直使用第三方工具，而这些工具并不总是符合我们的需求。在这种情况下没有什么不同，能够创建自动化数据处理的小脚本或程序将会有很大的不同。</p><h1 id="8a00" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">蟒蛇和熊猫来救援了！</h1><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lt"><img src="../Images/03c5a133f34c1874ebbb0cafad8373f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CiIm12IRMW8OMhWAgenQtg.jpeg"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">照片由<a class="ae mj" href="https://www.pexels.com/@introspectivedsgn?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">埃里克·麦克林</a>从<a class="ae mj" href="https://www.pexels.com/photo/man-in-black-and-white-panda-costume-standing-on-payphone-booth-during-night-time-4065800/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">派克斯</a>拍摄</p></figure><p id="273e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然Python有能力让使用它的程序员感到惊讶，但Pandas却让我大吃一惊！Pandas是一个数据分析和操作工具，正如它的创造者所定义的那样，它快速、强大、灵活……它们有所不足，令人震惊。😍虽然它们是独立的项目，但强烈建议使用JupyterLab与熊猫“玩耍”,它被推荐用于任何事情，如果你从未使用过它，当你使用它时，你会后悔以前没有这样做。我推荐你安装Anaconda🐍要使用JupyterLab，这不会让我们的计算机充满我们不需要的Python库，你必须有条理！😄首先，一旦安装了Anaconda，我们将通过在Anaconda控制台中运行这个命令来启动JupyterLab。</p><pre class="lu lv lw lx gt mk ml mm mn aw mo bi"><span id="e283" class="mp lc iq ml b gy mq mr l ms mt">C:&gt;jupyter notebook</span></pre><p id="2639" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦进入Jupyter界面，你就可以用Pyhton 3创建一个新的笔记本并开始游戏。</p><h1 id="dad6" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">MFT分析📂</h1><p id="5e53" class="pw-post-body-paragraph kf kg iq kh b ki mu jr kk kl mv ju kn ko mw kq kr ks mx ku kv kw my ky kz la ij bi translated">虽然我的意图是发表几篇帖子来讨论在分析师的日常工作中使用Pandas的方法，但在本例中，我们将讨论如何使用Pandas和Python来处理MFT(主文件表)。<br/>首先，在许多安全事件中，MFT是非常宝贵的资产，因为它是一个数据库，NTFS文件系统在其中跟踪存储卷上创建的所有文件和目录。需要查看该日志的情况不胜枚举，但在这种情况下，我们的受害者遭受了勒索软件的侵害。<br/>MFT不是一种舒适的工作格式，为了让我们更容易，我将使用<a class="ae mj" href="https://ericzimmerman.github.io/#!index.md" rel="noopener ugc nofollow" target="_blank"> Eric Zimmerman的MFTECmd </a>工具。🔝<br/>如果MFT不是很大，我们可以用MS Excel进行分析，但很多时候文件太大，我们需要更通用的工具。</p><p id="9b5c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最初，必须声明一些变量并运行MFETCmd工具。</p><pre class="lu lv lw lx gt mk ml mm mn aw mo bi"><span id="a9b2" class="mp lc iq ml b gy mq mr l ms mt"><strong class="ml ir">import</strong> <strong class="ml ir">os</strong><br/><strong class="ml ir">from</strong> <strong class="ml ir">subprocess</strong> <strong class="ml ir">import</strong> check_output<br/>mft_path = "<strong class="ml ir">\"</strong>C:<strong class="ml ir">\\</strong>kape<strong class="ml ir">\\</strong>collected<strong class="ml ir">\\</strong>2021-06-01T151604<strong class="ml ir">\\</strong>C<strong class="ml ir">\\</strong>$MFT<strong class="ml ir">\"</strong>"<br/>mftexplorer_path = "<strong class="ml ir">\"</strong>C:<strong class="ml ir">\\</strong>MFTExplorer<strong class="ml ir">\\</strong>MFTECmd.exe<strong class="ml ir">\"</strong>"<br/>output_folder = "C:<strong class="ml ir">\\</strong>Documents<strong class="ml ir">\\</strong>test"<br/>output_filename = "MyOutputFile.csv"</span><span id="c98c" class="mp lc iq ml b gy mz mr l ms mt">command = "<strong class="ml ir">{0}</strong> -f <strong class="ml ir">{1}</strong> --csv <strong class="ml ir">\"{2}\"</strong> --csvf <strong class="ml ir">\"{3}\"</strong>".format(mftexplorer_path, mft_path, output_folder, output_filename)<br/>print(command)<br/>output = os.popen(command).read()</span></pre><p id="0d3b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个执行的结果将是set文件夹中的一个CSV文件，这就是我们需要用来喂养熊猫的文件。🐼</p><pre class="lu lv lw lx gt mk ml mm mn aw mo bi"><span id="2776" class="mp lc iq ml b gy mq mr l ms mt"><strong class="ml ir">import</strong> <strong class="ml ir">pandas</strong> <strong class="ml ir">as</strong> <strong class="ml ir">pd</strong> <br/>pd.set_option('display.max_columns', 500)<br/><br/>data = pd.read_csv(output_folder + "<strong class="ml ir">\\</strong>" + output_filename)</span></pre><p id="1344" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此时，我们已经有了一个包含来自MFT的所有信息的数据框架。为了继续舒适地处理数据，建议调整包含日期的字段的类型。</p><pre class="lu lv lw lx gt mk ml mm mn aw mo bi"><span id="4325" class="mp lc iq ml b gy mq mr l ms mt">data.set_index("EntryNumber", inplace=<strong class="ml ir">True</strong>)<br/>data['Created0x10'] =  pd.to_datetime(data['Created0x10'], format='%Y-%m-<strong class="ml ir">%d</strong> %H:%M:%S.<strong class="ml ir">%f</strong>')<br/>data['Created0x30'] =  pd.to_datetime(data['Created0x30'], format='%Y-%m-<strong class="ml ir">%d</strong> %H:%M:%S.<strong class="ml ir">%f</strong>')<br/>data['LastModified0x10'] =  pd.to_datetime(data['LastModified0x10'], format='%Y-%m-<strong class="ml ir">%d</strong> %H:%M:%S.<strong class="ml ir">%f</strong>')<br/>data['LastModified0x30'] =  pd.to_datetime(data['LastModified0x30'], format='%Y-%m-<strong class="ml ir">%d</strong> %H:%M:%S.<strong class="ml ir">%f</strong>')<br/>data['LastRecordChange0x10'] =  pd.to_datetime(data['LastRecordChange0x10'], format='%Y-%m-<strong class="ml ir">%d</strong> %H:%M:%S.<strong class="ml ir">%f</strong>')<br/>data['LastRecordChange0x30'] =  pd.to_datetime(data['LastRecordChange0x30'], format='%Y-%m-<strong class="ml ir">%d</strong> %H:%M:%S.<strong class="ml ir">%f</strong>')</span></pre><p id="4a4c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">数据现在已准备好供查询。在这种情况下，这个MFT属于遭受勒索软件攻击的计算机，更具体地说是Avaddon。<br/>假设我们不知道勒索软件是何时执行的，并且我们想知道它以便执行调查。<br/>首先，让我们看看在MFT中哪一天对文件进行了更多的更改。</p><pre class="lu lv lw lx gt mk ml mm mn aw mo bi"><span id="b1b3" class="mp lc iq ml b gy mq mr l ms mt">dates = data["LastRecordChange0x10"]<br/>dates.index = dates.dt.to_period('d')<br/>s = dates.groupby(level=0).size()<br/>s.sort_values(ascending=<strong class="ml ir">False</strong>).head(10)</span></pre><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi na"><img src="../Images/817e15bb8f78f940f6f2b1ea880e21bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*wDuUkCBCuwW--63RHhBX9w.png"/></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">MFT发生更多变化的日子</p></figure><p id="998f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上图中，您可以看到我们如何通过几个命令提取文件的修改日期，在对数据进行分组后，我们首先获得操作系统的安装日期，然后获得攻击的日期。<br/>如果我们希望以更直观的方式查看，我们可以生成一个图表，显示过去两个月所做的更改。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi nb"><img src="../Images/c6782ab30d3564e53a1ee82471b87269.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4iJQhzrQtaTll6DWuqW8bg.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">MFT每日直方图变化</p></figure><p id="0f62" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以做的另一个测试是寻找过去4个月MFT中重复次数最多的文件，目的是发现异常。</p><pre class="lu lv lw lx gt mk ml mm mn aw mo bi"><span id="f918" class="mp lc iq ml b gy mq mr l ms mt">fig = px.bar(names_plot, x="FileName", "title=Files with more entries")<br/>Fig.show()</span></pre><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi nc"><img src="../Images/acfe1b5116a8113ac44a9b6b0b3004d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aeeyViWD82h_bZVj7Ts83A.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">具有更多条目的文件</p></figure><p id="e7cb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">勒索信！该勒索软件在执行过程中创建勒索笔记，并使用它加密的每个文件修改它们。为了更详细地查看信息，我们将执行以下操作。</p><pre class="lu lv lw lx gt mk ml mm mn aw mo bi"><span id="5692" class="mp lc iq ml b gy mq mr l ms mt">readme = data[data["FileName"].str.contains("_readme_.txt")]<br/>redme.sort_values(by="LastModified0x10", ascending=True).head()</span></pre><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi nd"><img src="../Images/66e9a55a64a4f61233ec54e1e4659f38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZQq6tCMYW7dB2YrvsV5jow.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">勒索信</p></figure><p id="84c2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，随着赎金笔记的出现，我们可以知道事件发生的时间，但现在我们将试图找出谁可能是肇事者，只有MFT。为此，我们将尝试查询勒索病毒案例中攻击者使用的最常见扩展名的文件，但仅限于创建第一封勒索信之前的12小时内。🔍</p><pre class="lu lv lw lx gt mk ml mm mn aw mo bi"><span id="983b" class="mp lc iq ml b gy mq mr l ms mt">first_note = readme1.sort_values(by="LastModified0x10", ascending=<strong class="ml ir">True</strong>).iloc[0]["LastModified0x10"]<br/>range_exe = first_note + pd.offsets.Hour(-12)<br/>data_filtered = data[(data['Created0x10'] &gt; "2021-05-22") &amp; (data['Created0x10'] &lt; "2021-05-25")]<br/>files = data_filtered[data_filtered["FileName"].str.contains("\.exe|\.ps1|\.msi|\.vba", regex=<strong class="ml ir">True</strong>)]</span></pre><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi ne"><img src="../Images/64f4fdc177494b836ca204f44816a719.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XlPvcq-huwVDdM6GmJWrdA.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">赎金可执行文件</p></figure><p id="8c5a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有了文件，我们必须找出它是如何进入电脑的，但这是MFT无法告诉我们的事情😄。虽然我们没有深入研究，但我们可以对多个MFT文件进行分析，按名称模式搜索，比较创建和修改日期，搜索具有可疑属性的文件……这是一个充满可能性的世界。</p><p id="f9a4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在以后的文章中，我将会谈到一些更高级的案例，在这些案例中，Pandas可以帮助我们进行调查，例如分析千兆字节的防火墙日志或分析Windows事件。我希望你喜欢它，并鼓励你把熊猫和朱庇特列入你的狩猎工具库。</p><p id="b9cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在<a class="ae mj" href="https://github.com/lucky-luk3/Infosec_Notebooks/blob/main/MFT_analysis_public_v0.2.ipynb" rel="noopener ugc nofollow" target="_blank">这个链接</a>找到这个笔记本，好好享受吧！</p><p id="723b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下集再见，祝狩猎愉快！</p></div></div>    
</body>
</html>