<html>
<head>
<title>Data Driven Audit | #1 Automated Sampling Using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据驱动审计| #1使用Python自动采样</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-driven-audit-1-automated-sampling-using-python-52e83347add5?source=collection_archive---------23-----------------------#2021-04-27">https://towardsdatascience.com/data-driven-audit-1-automated-sampling-using-python-52e83347add5?source=collection_archive---------23-----------------------#2021-04-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ef00" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Python自动化审计流程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4de8f7640e3afbe0c5be76ce8e52bac7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SxV9AGKX5tr6kkE8"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">克里斯里德在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="42e1" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">你将从这篇文章中学到什么</h1><ul class=""><li id="0f57" class="lr ls it lt b lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">将取样时间从一小时减少到一分钟</li><li id="3021" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">如何将文件转换为最佳格式的示例代码</li><li id="bd07" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">步骤背后的基本原理</li></ul><p id="abf5" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">你可以在下面找到脚本。</p><h1 id="2e7b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">设置</h1><p id="5dc3" class="pw-post-body-paragraph mo mp it lt b lu lv ju mr lw lx jx mt ly nd mv mw ma ne my mz mc nf nb nc me im bi translated">您从需要制作样本的客户处接收群体文件。</p><p id="5085" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">在创建示例之前，您需要执行以下步骤:</p><ol class=""><li id="665b" class="lr ls it lt b lu mq lw ms ly ng ma nh mc ni me nj mg mh mi bi translated">在Python中加载群体</li><li id="abbc" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me nj mg mh mi bi translated">移除不在范围内的实体</li><li id="50ea" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me nj mg mh mi bi translated">创建一个随机样本</li><li id="9a25" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me nj mg mh mi bi translated">导出到excel</li></ol></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><h2 id="b804" class="nr la it bd lb ns nt dn lf nu nv dp lj ly nw nx ll ma ny nz ln mc oa ob lp oc bi translated">第一步</h2><p id="8b91" class="pw-post-body-paragraph mo mp it lt b lu lv ju mr lw lx jx mt ly nd mv mw ma ne my mz mc nf nb nc me im bi translated">加载您从客户端收到的填充。你可以在这里下载数据集<a class="ae ky" href="https://mega.nz/file/EIRH0abQ#jrKpxqxoXjBVOoxnyMQBk7ir2WdDyzDDsAhs3jv4wek" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="437d" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">如您所见，客户为每个月(2015年1月、2015年2月……)创建了一个单独的表。对于我们的抽样过程，我们需要一个包含所有这些月份的合并表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/84f2cd35670586642c1d0a343b07639f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nYeKWtFhqiIprYFRsRqhIg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">population.xlsx数据集的屏幕截图</p></figure><p id="4aac" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">用以下参数读入所有纸张:</p><ul class=""><li id="c881" class="lr ls it lt b lu mq lw ms ly ng ma nh mc ni me mf mg mh mi bi translated">sheet_name = 0 |将所有工作表作为字典读入</li><li id="5a5d" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">dtype = str |读入所有数据类型为“string”的列</li></ul><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="c0d9" class="nr la it of b gy oj ok l ol om">population = pd.read_excel("population.xlsx", sheet_name = None, dtype = str)</span></pre><p id="7a5b" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">将不同的工作表连接成一个合并的工作表。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="1006" class="nr la it of b gy oj ok l ol om">population = pd.concat( population , ignore_index = True)</span></pre><p id="a083" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">现在您有了一个合并的工作表，但是您会注意到它还不是一个干净的格式。您需要执行以下清洁步骤:</p><ol class=""><li id="f37e" class="lr ls it lt b lu mq lw ms ly ng ma nh mc ni me nj mg mh mi bi translated">删除空白的行和列</li><li id="d4d2" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me nj mg mh mi bi translated">分配列名</li><li id="5e87" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me nj mg mh mi bi translated">删除不包含帐户值的行</li><li id="ca3d" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me nj mg mh mi bi translated">转换为压缩格式</li></ol></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><ol class=""><li id="3e45" class="lr ls it lt b lu mq lw ms ly ng ma nh mc ni me nj mg mh mi bi translated">删除空白行</li></ol><p id="19e9" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">使用以下参数:</p><ul class=""><li id="c36e" class="lr ls it lt b lu mq lw ms ly ng ma nh mc ni me mf mg mh mi bi translated">axis = 0 |删除具有NA值的行</li><li id="9e9a" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">how = 'all' |仅当所有值都是NA时才删除一行</li><li id="652c" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">subset = 'all' |只考虑从1开始的列(因此不包括第一列)</li></ul><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="fc1c" class="nr la it of b gy oj ok l ol om">population = population.dropna( axis = 0 , how = 'all' , subset = population.columns[1:] )</span></pre><p id="820f" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">现在，通过指定axis = 1删除没有任何值的列，并重置索引。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="d966" class="nr la it of b gy oj ok l ol om">population = population.dropna (axis = 1 , how = 'all').reset_index( drop = True)</span></pre><p id="816c" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">2.分配列名</p><p id="55e7" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">您可以从文件的第一行获取列名。使用iloc函数将第一行的值存储在变量“columns”中。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="d6d9" class="nr la it of b gy oj ok l ol om">columns = population.iloc[0]</span><span id="95f0" class="nr la it of b gy on ok l ol om">population.columns = columns</span></pre><p id="aec9" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">3.删除不包含帐户值的行</p><p id="bf96" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">仍有不包含相关信息的行，例如实体行。您需要排除所有不以数字开头的行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/a4b66659ccce228ce0ddbf554a82e4cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AbncbJez80e5fRRV9DT2pA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">标题需要删除，因为我们已经分配了它们</p></figure><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="ae89" class="nr la it of b gy oj ok l ol om">population = population.loc[ population['Financial Row'].str[:1].str.isnumeric()]</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/912d71d24390b1da23ddb49f0be290c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3TM6_VKYBtORAfOzaiRckA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">输出示例</p></figure><p id="4d83" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">干得好！开始有点像了。</p><p id="5e65" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">4.转换为压缩格式</p><p id="4da1" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">最佳实践是将数据帧转换为压缩格式。请记住，行很便宜，但列很贵。这使得以后的过滤更加容易。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="2304" class="nr la it of b gy oj ok l ol om">population = population.melt( id_vars = 'Financial Row', var_name='Entity', value_name='Amount')</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/f7d632626b79b487bd5eb00a4c9bb3e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*sJjmt5qWEloYXt0EG03-Pw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">示例输出</p></figure></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><h2 id="0c10" class="nr la it bd lb ns nt dn lf nu nv dp lj ly nw nx ll ma ny nz ln mc oa ob lp oc bi translated">第2步:排除帐户</h2><p id="e081" class="pw-post-body-paragraph mo mp it lt b lu lv ju mr lw lx jx mt ly nd mv mw ma ne my mz mc nf nb nc me im bi translated">以下客户不在范围内:</p><ul class=""><li id="834a" class="lr ls it lt b lu mq lw ms ly ng ma nh mc ni me mf mg mh mi bi translated">400XXX</li><li id="0fc7" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">500XX</li><li id="4cee" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">800XXX</li></ul><p id="1195" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">我们使用。loc函数过滤数据帧，排除以这些帐户开头的行。通过指定“~”符号，您可以让python知道您想要排除满足条件的记录。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="fa0d" class="nr la it of b gy oj ok l ol om">account_list = ["400", "500" , "800"]</span><span id="5ad4" class="nr la it of b gy on ok l ol om">population_1 = population.loc[ ~ population['Financial Row'].str[:3].isin(account_list)]</span></pre></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><h2 id="592c" class="nr la it bd lb ns nt dn lf nu nv dp lj ly nw nx ll ma ny nz ln mc oa ob lp oc bi translated">第三步:制作样品</h2><p id="0ae6" class="pw-post-body-paragraph mo mp it lt b lu lv ju mr lw lx jx mt ly nd mv mw ma ne my mz mc nf nb nc me im bi translated">你现在想做一个样品。审计中常见的样本量是20条必须随机选择的记录。</p><p id="df27" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">在示例函数中使用以下参数:</p><ul class=""><li id="4c0e" class="lr ls it lt b lu mq lw ms ly ng ma nh mc ni me mf mg mh mi bi translated">n = 20 |样本量为20</li><li id="caef" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">random_state = 1 |这允许您复制您的结果。</li></ul><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="e5ca" class="nr la it of b gy oj ok l ol om">population_1 = population_1.reset_index( drop = True)</span><span id="5344" class="nr la it of b gy on ok l ol om">population_sample = population_1.sample( n = 20, random_state = 1).reset_index()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/45d248a392613f053f00ad2e9304bd2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AMfAsHGvFMUCHKEMFrXgIQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">抽样输出</p></figure></div><div class="ab cl nk nl hx nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="im in io ip iq"><h2 id="cab3" class="nr la it bd lb ns nt dn lf nu nv dp lj ly nw nx ll ma ny nz ln mc oa ob lp oc bi translated">步骤4:将其全部导出到合并工作簿</h2><p id="c6b2" class="pw-post-body-paragraph mo mp it lt b lu lv ju mr lw lx jx mt ly nd mv mw ma ne my mz mc nf nb nc me im bi translated">您可以使用excelwriter函数将所有内容导出到合并工作簿中</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="4055" class="nr la it of b gy oj ok l ol om">with pd.ExcelWriter("sample.xlsx") as writer:<br/>   population.to_excel(writer, sheet_name = "population_source")   <br/>   population_1.to_excel(writer, sheet_name = "population_scoped")<br/>   population_sample.to_excel(writer, sheet_name = "sample")</span></pre><p id="44aa" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">干得好！您已经成功实现了采样过程的自动化。</p><p id="c4f7" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">明年，只要再次运行这个脚本，去享受阳光吧！；)</p><p id="5fb7" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated">在这里下载脚本<a class="ae ky" href="https://colab.research.google.com/drive/1FBiImj67u7q2GgnwIBN0YV6zamfESgRz?usp=sharing" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="ba32" class="pw-post-body-paragraph mo mp it lt b lu mq ju mr lw ms jx mt ly mu mv mw ma mx my mz mc na nb nc me im bi translated"><em class="os">注:这是一系列博客中的第一篇。敬请关注更多内容。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/b42a71a17d66f5fce0db07d226d5d192.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6oMvu8Kuvtm5ZAHh"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@zacdurant?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">扎克·杜兰特</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div></div>    
</body>
</html>