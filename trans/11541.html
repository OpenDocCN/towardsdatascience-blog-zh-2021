<html>
<head>
<title>How does Azure Kubernetes service perform zero downtime updates?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Kubernetes服务如何执行零停机更新？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-does-azure-kubernetes-service-perform-zero-downtime-updates-99820e17a84a?source=collection_archive---------19-----------------------#2021-11-14">https://towardsdatascience.com/how-does-azure-kubernetes-service-perform-zero-downtime-updates-99820e17a84a?source=collection_archive---------19-----------------------#2021-11-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/b17d88f55612558f2c93dd36d6e8e216.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MBvaN8sWfiJCneRI"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">诺德伍德主题公司在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><div class=""/><div class=""><h2 id="6f6c" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">本文给出了工作流的概述，并演示了如何通过python更新已部署的模型</h2></div><p id="66fb" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">机器学习模型有一个生命周期，这个周期的一部分是再培训/重新部署。模型需要更新的原因有很多(例如，特征漂移、协变量和目标之间的不同关系、改进、定期刷新等)。假设模型是<strong class="kx jh">Azure Kubernetes Services</strong>(AKS)中的一个实时应用，我们如何在不中断服务的情况下更新模型？</p><p id="a333" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh"> <em class="lr">假设</em> </strong>:熟悉<a class="ae jd" href="https://docs.microsoft.com/en-us/python/api/overview/azure/ml/?view=azure-ml-py" rel="noopener ugc nofollow" target="_blank"> Azure机器学习</a>软件开发包(SDK)和<a class="ae jd" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>。</p><figure class="lt lu lv lw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ls"><img src="../Images/3a71f136303148b3cf228e3803bbf896.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dAg-i8Q4CMdJbZLNIdQsWg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">来源:<a class="ae jd" href="https://github.com/StevenLoaiza/Machine_Learning/tree/master/deployment" rel="noopener ugc nofollow" target="_blank">史蒂文·洛艾萨</a></p></figure><h1 id="0749" class="lx ly jg bd lz ma mb mc md me mf mg mh km mi kn mj kp mk kq ml ks mm kt mn mo bi translated">Kubernetes更新工作流</h1><p id="91eb" class="pw-post-body-paragraph kv kw jg kx b ky mp kh la lb mq kk ld le mr lg lh li ms lk ll lm mt lo lp lq ij bi translated">Kubernetes提倡部署模型的零停机更新。换句话说，建模服务不会被更新中断，它将继续处理请求而不会出错。</p><p id="57cd" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">更新以分阶段的方式执行，以确保应用程序不受影响。假设您已经在Azure Kubernetes集群上部署了容器映像(模型)的第一个版本。您已经开发了模型的第二个版本，现在准备更新现有的web服务。</p><ol class=""><li id="d991" class="mu mv jg kx b ky kz lb lc le mw li mx lm my lq mz na nb nc bi translated">创建一个图像并将更新提交给web服务(下面是Python示例)。</li><li id="9f17" class="mu mv jg kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">由于这是一个渐进的展示<strong class="kx jh"> <em class="lr">版本2创建了一个</em> </strong>新pod，并将其添加到负载平衡器。</li><li id="f0b9" class="mu mv jg kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">映像版本为#1的pod将被删除，负载平衡器将停止向Pod发送请求。尽管pod被删除，但它仍保持活动状态，以完成它仍在处理的任何请求(默认的终止宽限期为30秒<a class="ae jd" href="#1785" rel="noopener ugc nofollow">【1】</a>)。</li><li id="097d" class="mu mv jg kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">重复，直到部署中的所有单元都有映像的版本#2。</li></ol><figure class="lt lu lv lw gt is gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/37acce570294ce648fc65e1b108a60c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*g-hxtLd_vamOsxm8.gif"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">来源:<a class="ae jd" href="https://github.com/StevenLoaiza/Machine_Learning/tree/master/deployment" rel="noopener ugc nofollow" target="_blank">史蒂文·洛艾萨</a></p></figure><h1 id="2f05" class="lx ly jg bd lz ma mb mc md me mf mg mh km mi kn mj kp mk kq ml ks mm kt mn mo bi translated">Python实现</h1><p id="204b" class="pw-post-body-paragraph kv kw jg kx b ky mp kh la lb mq kk ld le mr lg lh li ms lk ll lm mt lo lp lq ij bi translated">现在您已经理解了在AKS上更新图像的概念，我们将讨论如何通过python实现它。代码和配置文件位于<a class="ae jd" href="https://github.com/StevenLoaiza/Machine_Learning/tree/master/deployment" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上。</p><p id="96fc" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh"> <em class="lr">前置条件</em> </strong></p><ol class=""><li id="f49e" class="mu mv jg kx b ky kz lb lc le mw li mx lm my lq mz na nb nc bi translated">AML工作区，计算实例，AKS推理群集</li><li id="59c1" class="mu mv jg kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">已部署的AKS服务</li><li id="c409" class="mu mv jg kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">该模型的新版本</li></ol><p id="cb74" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">更新方法有许多可以改变的参数<a class="ae jd" href="#3f5d" rel="noopener ugc nofollow">【4】</a>，默认设置为<strong class="kx jh">无</strong>，保持不变。当更新建模服务时，我包括推理配置(指定环境和评分脚本的路径)、模型、自动缩放和内存。</p><figure class="lt lu lv lw gt is"><div class="bz fp l di"><div class="nj nk l"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated"><a class="ae jd" href="https://github.com/StevenLoaiza/Machine_Learning/blob/master/deployment/config.json" rel="noopener ugc nofollow" target="_blank"> config.json </a></p></figure><p id="c370" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面是<code class="fe nl nm nn no b">azure_utils.py</code>中定义的<code class="fe nl nm nn no b">AmlUtility</code>类。该类有几个函数来加载配置文件、设置环境、定义推理配置、加载新模型和部署更新。</p><figure class="lt lu lv lw gt is"><div class="bz fp l di"><div class="nj nk l"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated"><a class="ae jd" href="https://github.com/StevenLoaiza/Machine_Learning/blob/master/deployment/azure_utils.py" rel="noopener ugc nofollow" target="_blank"> azure_util.py </a></p></figure><p id="5874" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在终端上运行的示例脚本来自存储实用程序脚本的目录，它是:</p><pre class="lt lu lv lw gt np no nq nr aw ns bi"><span id="51c7" class="nt ly jg no b gy nu nv l nw nx">python azure_util.py --config_path config.json --service_name current_deployment_name --new_model model_name:2</span></pre><p id="4e55" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">只要没有错误，当建模服务更新完成时，终端上的日志将会显示。</p></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><h1 id="11b6" class="lx ly jg bd lz ma of mc md me og mg mh km oh kn mj kp oi kq ml ks oj kt mn mo bi translated">结论</h1><p id="69fc" class="pw-post-body-paragraph kv kw jg kx b ky mp kh la lb mq kk ld le mr lg lh li ms lk ll lm mt lo lp lq ij bi translated">这篇文章是为了教育目的。更新产品建模服务很可能超出了数据科学家的权限范围。停机会带来成本，因此更新和最小化成本最好留给其他专业团队。但是在开发阶段，当您迭代不同的版本时，这仍然是一个有用的特性。</p><p id="4464" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一如既往地感谢您的阅读。你可以在LinkedIn上找到我！</p><h1 id="d488" class="lx ly jg bd lz ma mb mc md me mf mg mh km mi kn mj kp mk kq ml ks mm kt mn mo bi translated">参考</h1><p id="1785" class="pw-post-body-paragraph kv kw jg kx b ky mp kh la lb mq kk ld le mr lg lh li ms lk ll lm mt lo lp lq ij bi translated">[1]:<a class="ae jd" href="https://learnk8s.io/graceful-shutdown" rel="noopener ugc nofollow" target="_blank">https://learnk8s.io/graceful-shutdown</a></p><p id="59a7" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">【2】:<a class="ae jd" href="https://www.youtube.com/watch?v=mNK14yXIZF4" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=mNK14yXIZF4</a></p><p id="f7e1" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">https://kubernetes.io/docs/concepts/workloads/pods/</p><p id="3f5d" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">[4]:<a class="ae jd" href="https://docs.microsoft.com/en-us/python/api/azureml-core/azureml.core.webservice.akswebservice?view=azure-ml-py" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/python/API/azure ml-core/azure ml . core . web service . aks web service？view=azure-ml-py </a></p><h1 id="7354" class="lx ly jg bd lz ma mb mc md me mf mg mh km mi kn mj kp mk kq ml ks mm kt mn mo bi translated">附录</h1><h2 id="d437" class="nt ly jg bd lz ok ol dn md om on dp mh le oo op mj li oq or ml lm os ot mn ou bi translated">未来相关文章</h2><ul class=""><li id="d85d" class="mu mv jg kx b ky mp lb mq le ov li ow lm ox lq oy na nb nc bi translated">在AML中注册模型</li><li id="7367" class="mu mv jg kx b ky nd lb ne le nf li ng lm nh lq oy na nb nc bi translated">在AK上部署模型并在本地调试</li><li id="4fee" class="mu mv jg kx b ky nd lb ne le nf li ng lm nh lq oy na nb nc bi translated">通过ModelDataCollector()进行日志记录</li></ul><h2 id="88e2" class="nt ly jg bd lz ok ol dn md om on dp mh le oo op mj li oq or ml lm os ot mn ou bi translated">问题</h2><p id="751b" class="pw-post-body-paragraph kv kw jg kx b ky mp kh la lb mq kk ld le mr lg lh li ms lk ll lm mt lo lp lq ij bi translated">我在测试<code class="fe nl nm nn no b">AksWebservie.update()</code><a class="ae jd" href="#3f5d" rel="noopener ugc nofollow">【4】</a>时遇到的两个问题:</p><ul class=""><li id="deba" class="mu mv jg kx b ky kz lb lc le mw li mx lm my lq oy na nb nc bi translated">关于第<a class="ae jd" href="#f0b9" rel="noopener ugc nofollow"> #3 </a>点，您可能会看到一个“<strong class="kx jh"> <em class="lr">错误:副本在回复前关闭连接”。</em> </strong>发生这种情况是因为在pod被完全删除之前请求没有完成。<strong class="kx jh">解决方案:</strong>配置pod的终止宽限期，这可能超出了数据科学家的范围。<a class="ae jd" href="#f7e1" rel="noopener ugc nofollow">【3】</a></li><li id="1aeb" class="mu mv jg kx b ky nd lb ne le nf li ng lm nh lq oy na nb nc bi translated">如果映像通过<a class="ae jd" href="https://docs.microsoft.com/en-us/python/api/azureml-monitoring/azureml.monitoring.modeldatacollector?view=azure-ml-py" rel="noopener ugc nofollow" target="_blank"> ModelDataCollector </a>转储日志，您可能会在部署过程中丢失日志。我没有找到与此问题相关的文档。<strong class="kx jh">解决方案:</strong>在非高峰时段更新映像，以最大限度地减少请求日志的丢失。</li></ul></div></div>    
</body>
</html>