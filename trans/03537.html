<html>
<head>
<title>A hard lesson on Filter Context with Power BI and DAX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于使用Power BI和DAX过滤上下文的一个很难的教训</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-hard-lesson-on-filter-context-with-power-bi-and-dax-c0ce5f657af4?source=collection_archive---------17-----------------------#2021-03-22">https://towardsdatascience.com/a-hard-lesson-on-filter-context-with-power-bi-and-dax-c0ce5f657af4?source=collection_archive---------17-----------------------#2021-03-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a288" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一个客户对他的报告有意见。我被要求找到问题并解决它。这是关于它的故事</h2></div><p id="6850" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">上周，一位客户要求我分析Power BI报告中显示的总数与导出到Excel后的数值总和之间的差异。这项任务被证明是非常具有挑战性的，最终，差异是由于Power BI和DAX如何工作以及它如何计算数字。简而言之:过滤器上下文是如何工作的。</em></p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/69da1df7b607aa15e009e1d125b31409.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6oSfG7r1H3ON4skV"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">照片由<a class="ae lv" href="https://unsplash.com/@mbaumi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米卡·鲍梅斯特</a>在<a class="ae lv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="72d1" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated"><strong class="ak">场景</strong></h1><p id="f032" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">客户是一家销售建筑材料的公司。它有一个订单积压。每天都会计算订单积压中的销售额，并将其加载到数据仓库数据库中。</p><p id="8726" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个量是所谓的半累加性度量。半累加性意味着不可能累计一段时间的总量，如仓库中的库存或银行账户的状况。</p><p id="9060" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用户选择一个月，报表显示订单编号列表和每个订单对应的销售额。</p><p id="ba53" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">总计显示所选月份所有订单的销售额。</p><p id="ca8e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于销售订单积压的快照每天都被加载到数据仓库数据库中，因此对于销售额，只需考虑所选月份的最后一天。</p><h1 id="b621" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated"><strong class="ak">问题</strong></h1><p id="9b87" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">用户得到一个订单编号列表，其中包含相应的成本中心和销售额。</p><p id="571b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其中一个用户希望对数据进行更深入的分析，将Power BI报告中的数据导出到Excel。</p><p id="52ff" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当他将所有订单的总和与Power BI报告上显示的总和进行比较时，他注意到了一个巨大的差异。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi mt"><img src="../Images/fb638a6d1066a2a487e623f5a843f142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tzMSQKNQAnKP4pFHWeuNkQ.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">Power BI与Excel的比较</p></figure><p id="ec42" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个结果是我开始调查的出发点。</p><h1 id="8e42" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated"><strong class="ak">DAX衡量标准</strong></h1><p id="d860" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">客户使用了以下DAX衡量标准:</p><pre class="lg lh li lj gt mu mv mw mx aw my bi"><span id="8e87" class="mz lx it mv b gy na nb l nc nd">Last Sales Amount = <br/> CALCULATE (<br/> SUM ( ‘SalesOrderBacklog’[SalesAmount] ),<br/> FILTER (<br/> ‘SalesOrderBacklog’,<br/> ‘SalesOrderBacklog’[Snapshot_Date]<br/> = MAX ( ‘SalesOrderBacklog’[Snapshot_Date] )<br/> )<br/> )</span></pre><p id="4319" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">乍一看，这个措施看起来还可以。</p><p id="a015" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它只考虑表中最高的日期，计算SalesAmount列的总和。</p><p id="4997" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是当你更深入地研究这个公式时，你开始注意到这个机制与你预期的略有不同:</p><ol class=""><li id="b418" class="ne nf it kk b kl km ko kp kr ng kv nh kz ni ld nj nk nl nm bi translated">您需要一次查看报告中的每一行</li><li id="367b" class="ne nf it kk b kl nn ko no kr np kv nq kz nr ld nj nk nl nm bi translated">然后，您将看到该度量对订单号和成本中心的每个组合执行一次迭代，并对每个组合执行计算</li><li id="8742" class="ne nf it kk b kl nn ko no kr np kv nq kz nr ld nj nk nl nm bi translated">您需要将选定的月份作为过滤器</li></ol><p id="11d9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当您结合这些步骤时，您会开始理解该度量正在执行以下操作:</p><ol class=""><li id="3a6c" class="ne nf it kk b kl km ko kp kr ng kv nh kz ni ld nj nk nl nm bi translated">它得到第一行。假设成本中心2130和订单号781731701的组合</li><li id="753e" class="ne nf it kk b kl nn ko no kr np kv nq kz nr ld nj nk nl nm bi translated">该度量将获取该组合在所选月份<br/>中的最新日期的行。这些行不必是所选月份中的最后一个日期</li><li id="05bd" class="ne nf it kk b kl nn ko no kr np kv nq kz nr ld nj nk nl nm bi translated">选择这些行后，它将计算SalesAmoun列的总和，并返回值。在这种情况下，20'078.38</li></ol><p id="c51a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们需要看看这个度量是如何计算总数的。</p><p id="655f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该度量不知道在表的“总计”行中考虑了哪个订单号或成本中心。</p><p id="eebb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这意味着该度量将获取所选月份中日期最晚的行。选择之后，它将计算所有这些行的SalesAmount列的总和，并返回值，在本例中为:<br/> 9'036'744.8601，表示所选月份的最后一天！</p><p id="3df2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">计算结果基于与上述行中考虑的行不同的完整行选择。</p><p id="14a2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个过程就是所有行的总和导致总数为10'183'398.1177的原因。</p><h1 id="c848" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated"><strong class="ak">不同的措施</strong></h1><p id="e976" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">在DAX，我可以用另一种方法来计算股票价值。我可以使用LASTNONBLANK()或LASTNONBLANKVALUE()函数来代替自定义公式。</p><p id="3fa7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当使用这些函数之一时，测量看起来完全不同:</p><pre class="lg lh li lj gt mu mv mw mx aw my bi"><span id="9e07" class="mz lx it mv b gy na nb l nc nd">Last Sales Amount = <br/> VAR LastDateWithData = LASTNONBLANK(‘Date ‘[Date]<br/> ,SUM ( ‘SalesOrderBacklog’[SalesAmount] )<br/> )<br/> RETURN<br/> CALCULATE(<br/> SUM ( ‘SalesOrderBacklog’[SalesAmount] )<br/> ,LastDateWithData<br/> )</span></pre><p id="0d2e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，我采用了两步走的方法:</p><ol class=""><li id="9fa5" class="ne nf it kk b kl km ko kp kr ng kv nh kz ni ld nj nk nl nm bi translated">我使用LASTNONBLANK()函数获取最新日期，该日期在SalesAmount列中有值。<br/>这一步考虑所选的月份</li><li id="6bc8" class="ne nf it kk b kl nn ko no kr np kv nq kz nr ld nj nk nl nm bi translated">然后，对具有此日期的所有行计算SalesAmount列的总和</li></ol><p id="3503" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我使用一个添加到模型中的日期表。但是使用' SalesOrderBacklog '[Snapshot _ Date]不会有任何不同。</p><p id="0d98" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用这种方法，DAX只计算这些行的结果，其中包含所选月份最后一天的数据。</p><p id="a702" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我现在导出数据时，当我导出数据并计算所有行的总和时，我得到了正确的结果。</p><h1 id="9028" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated"><strong class="ak">不同的要求</strong></h1><p id="8e9e" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">现在，我们需要了解用户的确切需求。</p><p id="8d6b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以提出以下两个问题:</p><ol class=""><li id="f9f9" class="ne nf it kk b kl km ko kp kr ng kv nh kz ni ld nj nk nl nm bi translated">您是否需要获取所选月份<br/>最后一个月的订单列表，或者</li><li id="ad2a" class="ne nf it kk b kl nn ko no kr np kv nq kz nr ld nj nk nl nm bi translated">您是否需要在所选月份打开的所有订单的列表，而不管这些订单在月末是否仍在积压列表中？</li></ol><p id="5c19" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果用户对第一个问题回答是，那么使用LASTNONBLANK()函数的度量就是正确的。</p><p id="8420" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果用户对第二个问题回答“是”,那么我们需要更改度量来计算正确的总和，并增加一部分来满足这一要求。</p><p id="11ae" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一种方法是预先计算变量中的所有行，并检查当前过滤器上下文是否是总计行:</p><pre class="lg lh li lj gt mu mv mw mx aw my bi"><span id="9446" class="mz lx it mv b gy na nb l nc nd">Sales (Order Backlog) Extd = <br/> VAR SelectedMonth = SELECTEDVALUE(‘Date’[YearMonthShort])<br/> <br/> VAR ListOfValues =<br/> CALCULATETABLE(<br/> SUMMARIZE(<br/> ‘SalesOrderBacklog’<br/> ,’SalesOrderBacklog’[Order No]<br/> ,’SalesOrderBacklog’[Costcenter]<br/> ,”SalesOrderBacklog”, [Last Sales Amount Custom]<br/> )<br/> ,FILTER(<br/> ‘Date’<br/> ,’Date’[YearMonthShort] = [Selected Month]<br/> )<br/> )<br/> <br/> RETURN<br/> IF(OR(HASONEFILTER(‘SalesOrderBacklog’[Order No])<br/> ,HASONEFILTER(‘SalesOrderBacklog’[CostCenter])<br/> )<br/> ,[Last Sales Amount]<br/> ,SUMX(<br/> ListOfValues<br/> ,SUM ( [SalesOrderBacklog] )<br/> )<br/> <br/> )</span></pre><p id="6780" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种方法的工作方式如下:</p><ol class=""><li id="d783" class="ne nf it kk b kl km ko kp kr ng kv nh kz ni ld nj nk nl nm bi translated">使用SELECTEDVALUE()函数检索选定的月份，并将其存储在selected Month变量中</li><li id="dff8" class="ne nf it kk b kl nn ko no kr np kv nq kz nr ld nj nk nl nm bi translated">变量ListOfValues得到一个包含订单编号和成本中心所有组合的表，以及每个组合的销售额总和<br/> a。该表受所选月份的限制(FILTER()函数)</li><li id="6c75" class="ne nf it kk b kl nn ko no kr np kv nq kz nr ld nj nk nl nm bi translated">IF函数检查当前过滤器上下文是否包含订单编号或成本中心的值。<br/> a .如果是，则调用基本度量返回实际行<br/>的销售额b .如果否，则计算表变量ListOfValues中所有行的总和。</li></ol><p id="d7e9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Power BI计算出正确的逐行结果和正确的总计行。但是它有两个主要缺点:</p><ol class=""><li id="209f" class="ne nf it kk b kl km ko kp kr ng kv nh kz ni ld nj nk nl nm bi translated">性能:非常慢。我等了几分钟，等待超过200万行的结果</li><li id="cbba" class="ne nf it kk b kl nn ko no kr np kv nq kz nr ld nj nk nl nm bi translated">不可伸缩:您只能对这个特定的表使用这个度量，因为它只要求order-number和cost-centre两列。</li></ol><p id="391e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我的客户决定使用通用的测量方法，而不是上面描述的最后一种方法。</p><p id="2ff2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为他的决定，我没有花任何时间试图优化这个变种。</p><h1 id="3588" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated"><strong class="ak">要吸取的教训</strong></h1><p id="20c7" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我必须吸取的最大教训是，在对DAX测量结果进行故障诊断时，不要忽略关键细节。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ns"><img src="../Images/41f3d43251f2d7af3aaa1cd67778d8cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7HVkA6aFx2ArINnh"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">照片由<a class="ae lv" href="https://unsplash.com/@magictype?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> jaikishan patel </a>在<a class="ae lv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="1911" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用DAX时，过滤器上下文是最重要的因素。</p><p id="2a24" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用户的问题误导了我，我花了很多时间回到基础去理解是怎么回事。</p><p id="0693" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我希望你觉得这篇文章有趣并且有价值。如果你对这个话题有任何疑问，请发表评论。</p></div></div>    
</body>
</html>