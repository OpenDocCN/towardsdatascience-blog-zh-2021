<html>
<head>
<title>1 Trick That Changed the Way I Write Queries Forever</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个永远改变了我编写查询方式的技巧</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/common-table-expressions-in-sql-c6dd317e1121?source=collection_archive---------10-----------------------#2021-10-24">https://towardsdatascience.com/common-table-expressions-in-sql-c6dd317e1121?source=collection_archive---------10-----------------------#2021-10-24</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="6708" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">利用通用表表达式来简化复杂查询的编写和故障排除</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/e47add8238b11d7aac8af35c57916cb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9Rg7u3Nh2FT-luBs"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Jan Antonin Kolar 在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="78fd" class="la lb iu bd lc ld le lf lg lh li lj lk ka ll kb lm kd ln ke lo kg lp kh lq lr bi translated">什么是常见的表表达式</h1><p id="a504" class="pw-post-body-paragraph ls lt iu lu b lv lw jv lx ly lz jy ma mb mc md me mf mg mh mi mj mk ml mm mn in bi translated">当编写复杂的查询时，为了可读性和调试，将它们分成更小的块通常是有用的。通用表表达式(cte)提供了这种能力，我发现它们是我的SQL工具箱中最有用的工具之一。</p><p id="fde9" class="pw-post-body-paragraph ls lt iu lu b lv mo jv lx ly mp jy ma mb mq md me mf mr mh mi mj ms ml mm mn in bi translated">cte实现起来非常简单。他们以一个简单的<code class="fe mt mu mv mw b">WITH</code>陈述开始，你要去的新CTE的名字<code class="fe mt mu mv mw b">SELECT</code>。他们是这样开始的:</p><pre class="kk kl km kn gu mx mw my bn mz na bi"><span id="8f23" class="nb lb iu mw b be nc nd l ne nf">WITH<br/>    cte_name AS (<br/>        SELECT<br/>            ...<br/>    )</span></pre><p id="9314" class="pw-post-body-paragraph ls lt iu lu b lv mo jv lx ly mp jy ma mb mq md me mf mr mh mi mj ms ml mm mn in bi translated">美妙之处在于，您可以将多个cte链接在一起，数量不限。让我们看看他们中的一些人会是什么样子。</p><pre class="kk kl km kn gu mx mw my bn mz na bi"><span id="00d9" class="nb lb iu mw b be nc nd l ne nf">WITH<br/>    cte_name AS (<br/>        SELECT<br/>            ...<br/>    ),<br/><br/>another_cte AS (<br/>    SELECT * FROM foo<br/>    JOIN cte_name ON cte_name.id = foo.id<br/>)<br/><br/>SELECT * FROM another_cte<br/>LIMIT 10</span></pre><p id="17f0" class="pw-post-body-paragraph ls lt iu lu b lv mo jv lx ly mp jy ma mb mq md me mf mr mh mi mj ms ml mm mn in bi translated">这很好地说明了这个概念。第一个CTE运行第一个查询并将其存储在名为<code class="fe mt mu mv mw b">cte_name</code>的内存中，第二个CTE将<code class="fe mt mu mv mw b">cte_name</code>表连接到第二个CTE中的<code class="fe mt mu mv mw b">foo</code>表。您可以以多种方式使用这种模式，但是它通过将复杂的查询分解成逻辑部分来简化构造。</p><p id="2339" class="pw-post-body-paragraph ls lt iu lu b lv mo jv lx ly mp jy ma mb mq md me mf mr mh mi mj ms ml mm mn in bi translated"><strong class="lu iv">注意:</strong>需要注意的一件小事是在第一个CTE分隔每张表之后<code class="fe mt mu mv mw b">,</code>在哪里。</p><p id="92f4" class="pw-post-body-paragraph ls lt iu lu b lv mo jv lx ly mp jy ma mb mq md me mf mr mh mi mj ms ml mm mn in bi translated">最后，通过在生成的CTE上运行一个独立的<code class="fe mt mu mv mw b">SELECT</code>语句来完成这个过程。</p><p id="57f8" class="pw-post-body-paragraph ls lt iu lu b lv mo jv lx ly mp jy ma mb mq md me mf mr mh mi mj ms ml mm mn in bi translated">当然，强大的功能是运行复杂得多的逻辑。每个CTE可以包含许多<code class="fe mt mu mv mw b">SELECT</code>语句、<code class="fe mt mu mv mw b">JOIN</code>语句、<code class="fe mt mu mv mw b">WHERE</code>子句等。为了可读性和可理解性，使用它们来组织您的查询。</p><p id="e1b9" class="pw-post-body-paragraph ls lt iu lu b lv mo jv lx ly mp jy ma mb mq md me mf mr mh mi mj ms ml mm mn in bi translated"><strong class="lu iv">提示:</strong>为了方便调试或构建您的查询，您可以通过简单地注释掉剩余的代码并在每个cte之后运行select来测试每个cte。像这样。</p><pre class="kk kl km kn gu mx mw my bn mz na bi"><span id="43d1" class="nb lb iu mw b be nc nd l ne nf">WITH<br/>    cte_name AS (<br/>        SELECT<br/>            ...<br/>    ) --, Make sure to comment out the comma<br/><br/>SELECT * FROM cte_name<br/>LIMIT 10<br/><br/>-- another_cte AS (<br/>--     SELECT * FROM foo<br/>--     JOIN cte_name ON cte_name.id = foo.id<br/>-- )<br/><br/>-- SELECT * FROM another_cte<br/>-- LIMIT 10</span></pre><h1 id="65b1" class="la lb iu bd lc ld le lf lg lh li lj lk ka ll kb lm kd ln ke lo kg lp kh lq lr bi translated">现实生活中的例子</h1><p id="f7e1" class="pw-post-body-paragraph ls lt iu lu b lv lw jv lx ly lz jy ma mb mc md me mf mg mh mi mj mk ml mm mn in bi translated">我为在雪花中创建的视图编写了一个查询。如果没有cte，这将会变得更加困难。</p><pre class="kk kl km kn gu mx mw my bn mz na bi"><span id="7db1" class="nb lb iu mw b be nc nd l ne nf">WITH DAILY as (<br/>    SELECT ID<br/>    FROM "LOGS_DAILY"),<br/>MAP AS (<br/>    SELECT SOURCE_ID AS ID, ANY_VALUE(UUID) AS UUID<br/>    FROM "CONTACT_MAP"<br/>    WHERE SOURCE_ID_NAME = 'ID'<br/>    AND DT = (SELECT MAX(DT) FROM "CONTACT_MAP")<br/>    GROUP BY SOURCE_ID),<br/>CONTACT AS (<br/>    SELECT CONTACT_UUID, SITE_UUID<br/>    FROM "CONTACT_MASTER"<br/>    WHERE DT = (SELECT MAX(DT) FROM "CONTACT_MASTER")),<br/>ACCOUNT AS (<br/>    SELECT *<br/>    FROM "ACCOUNT"<br/>    WHERE SITE_STATUS = 'Active')<br/>SELECT DISTINCT *<br/>FROM DAILY<br/>LEFT JOIN MAP ON MAP.ID = DAILY.ID<br/>LEFT JOIN CONTACT ON CONTACT.CONTACT_UUID = MAP.CONTACT_UUID<br/>LEFT JOIN ACCOUNT ON ACCOUNT.SITE_UUID = CONTACT.SITE_UUID<br/>LIMIT 100</span></pre><h1 id="6b88" class="la lb iu bd lc ld le lf lg lh li lj lk ka ll kb lm kd ln ke lo kg lp kh lq lr bi translated">结论</h1><p id="c076" class="pw-post-body-paragraph ls lt iu lu b lv lw jv lx ly lz jy ma mb mc md me mf mg mh mi mj mk ml mm mn in bi translated">公共表表达式(cte)是查询工具箱中的一个强大工具，它允许您获取复杂的、分层的SELECT语句，将它们分解成更易于管理的块，然后最终将它们组合在一起。如果你今天没有使用它们，试一试，我相信它们会成为你经常去的地方！</p><p id="f902" class="pw-post-body-paragraph ls lt iu lu b lv mo jv lx ly mp jy ma mb mq md me mf mr mh mi mj ms ml mm mn in bi translated">如果你喜欢阅读这样的故事，并想支持我成为一名作家，可以考虑报名成为一名媒体成员。一个月5美元，让你可以无限制地访问成千上万篇文章。如果你使用<a class="ae kz" href="https://medium.com/@broepke/membership" rel="noopener">我的链接</a>注册，我会赚一小笔佣金，不需要你额外付费。</p></div></div>    
</body>
</html>