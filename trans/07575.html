<html>
<head>
<title>Machine learning model serving for newbies with MLflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于MLflow的面向新手的机器学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/machine-learning-model-serving-for-newbies-with-mlflow-76f9f0ac3cb2?source=collection_archive---------10-----------------------#2021-07-11">https://towardsdatascience.com/machine-learning-model-serving-for-newbies-with-mlflow-76f9f0ac3cb2?source=collection_archive---------10-----------------------#2021-07-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1515" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为您的sklearn模型构建一个API的完全可复制的、分阶段的、循序渐进的教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/608c600154a9b5801a8b683fe7fd665b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hQsyovZV7gVI9SXCj7s7GA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">保持那些模型流动！(作者画的漫画很差。)</p></figure><p id="6566" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi lu translated"><span class="l lv lw lx bm ly lz ma mb mc di">一个</span>机器学习中的常见问题是构建机器学习模型的数据科学家和试图将这些模型集成到工作软件中的工程师之间的笨拙交接。数据科学家所熟悉的计算环境并不总能很好地融入生产质量系统。</p><p id="4e35" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个模型部署问题已经变得如此普遍，以至于围绕寻找解决方案出现了一个全新的术语和子领域——MLOps，或者将DevOps原则应用于将机器学习管道推向生产。</p><h1 id="a580" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">模型部署的简单方法</h1><p id="053a" class="pw-post-body-paragraph ky kz it la b lb mv ju ld le mw jx lg lh mx lj lk ll my ln lo lp mz lr ls lt im bi translated">我最喜欢的机器学习模型部署工具是<a class="ae na" href="https://www.mlflow.org/" rel="noopener ugc nofollow" target="_blank"> MLflow </a>，它自称是“管理ML生命周期的开源平台，包括实验、可复制性、部署和中央模型注册。”MLflow可以与您可能用于机器学习的几乎所有编程语言一起工作，可以在您的笔记本电脑上或云中以相同的方式轻松运行(在Databricks中集成了一个非常棒的托管版本)，可以帮助您对模型进行版本控制(特别适合协作)并跟踪模型性能，并允许您打包几乎任何模型并提供它，以便您或任何其他人可以使用它通过REST API发送自己的数据来进行预测，而无需运行任何代码。</p><p id="0e72" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你觉得这听起来很酷，那是因为它确实很酷。MLflow太酷了，做了这么多事情，以至于我花了很长时间来筛选所有的文档和教程，以弄清楚如何实际使用它。但是我做了(我想)，我用Docker做所有的事情，所以我想我应该继续下去，在混乱中添加另一个教程。因为都是用Docker容器化的，所以只需要几个命令就可以让一切正常工作。</p><h1 id="a5a1" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">佐料</h1><p id="935f" class="pw-post-body-paragraph ky kz it la b lb mv ju ld le mw jx lg lh mx lj lk ll my ln lo lp mz lr ls lt im bi translated">所有资料都可以在我的GitHub<a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial" rel="noopener ugc nofollow" target="_blank">ml flow-tutorial repo</a>中获得。接下来，将repo克隆到您的本地环境中。您可以在系统上仅运行Docker和Docker Compose来运行该示例。</p><p id="5fc2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个GitHub repo演示了一个用sklearn训练分类器模型和用mlflow服务模型的例子。</p><p id="e838" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">回购有几个不同的组成部分:</p><ul class=""><li id="1a30" class="nb nc it la b lb lc le lf lh nd ll ne lp nf lt ng nh ni nj bi translated">一个<a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/mlflow-sklearn.ipynb" rel="noopener ugc nofollow" target="_blank"> Jupyter笔记本</a>浏览管道，包括使用Python API加载注册的模型</li><li id="66d2" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">一个<a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/Dockerfile" rel="noopener ugc nofollow" target="_blank">Docker文件</a>，可用于构建本教程的Docker映像</li><li id="9db3" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">两个Docker使用mlflow注册表编写文件来运行整个训练到服务管道<a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/docker-compose.yml" rel="noopener ugc nofollow" target="_blank">和</a>或<a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/docker-compose-no-registry.yml" rel="noopener ugc nofollow" target="_blank">而不使用</a></li><li id="dabe" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">两个示例sklearn分类器模型训练脚本使用mlflow注册表构建带有的mlflow模型<a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/clf-train-registry.py" rel="noopener ugc nofollow" target="_blank">或不带</a>的ml flow模型<a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/clf-train.py" rel="noopener ugc nofollow" target="_blank"/></li><li id="e5a4" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">几个示例shell脚本，用于<a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/runServer.sh" rel="noopener ugc nofollow" target="_blank">运行注册中心的mlflow服务器</a>，<a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/serveModel.sh" rel="noopener ugc nofollow" target="_blank">服务于指定的模型</a>，以及<a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/predict.sh" rel="noopener ugc nofollow" target="_blank">使用您的测试数据的csv进行预测</a>。</li></ul><h1 id="8a2c" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">方向(TLDR版)</h1><p id="c7ff" class="pw-post-body-paragraph ky kz it la b lb mv ju ld le mw jx lg lh mx lj lk ll my ln lo lp mz lr ls lt im bi translated">要使用Docker Compose跳过并运行所有组件，您可以使用注册表运行<br/>整个教程:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="f852" class="nu me it nq b gy nv nw l nx ny">docker compose -f docker-compose.yml up --build</span></pre><p id="8f18" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">或者没有注册表:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="114b" class="nu me it nq b gy nv nw l nx ny">docker compose -f docker-compose-no-registry.yml up --build</span></pre><p id="1d2d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该模型将在端口1234上提供，通过运行包含测试数据csv的以下脚本来访问预测:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="f510" class="nu me it nq b gy nv nw l nx ny">./predict.sh test.csv</span></pre><p id="9a2c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它运行以下curl命令，将csv作为输入:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="ceec" class="nu me it nq b gy nv nw l nx ny">curl http://localhost:1234/invocations \<br/>-H ‘Content-Type: text/csv’ --data-binary @test.csv</span></pre><p id="8071" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">并返回预测概率的数组。</p><h1 id="bda1" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">方向(完整版)</h1><p id="8c80" class="pw-post-body-paragraph ky kz it la b lb mv ju ld le mw jx lg lh mx lj lk ll my ln lo lp mz lr ls lt im bi translated">第一部分将mlflow模型保存到本地磁盘，第二部分展示了如何使用mlflow registry进行模型跟踪和版本控制。</p><h1 id="6502" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">培训和服务mlflow模型(无注册)</h1><p id="ae9f" class="pw-post-body-paragraph ky kz it la b lb mv ju ld le mw jx lg lh mx lj lk ll my ln lo lp mz lr ls lt im bi translated"><code class="fe nz oa ob nq b"><a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/clf-train.py" rel="noopener ugc nofollow" target="_blank">clf-train.py</a></code>脚本使用sklearn乳腺癌数据集，训练一个简单的随机森林分类器，用mlflow将模型保存到本地磁盘。添加用于写入输出测试数据的可选标志将首先分割训练数据以添加示例测试数据文件。</p><p id="9074" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">若要训练模型，请使用以下命令:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="d022" class="nu me it nq b gy nv nw l nx ny">python clf-train.py clf-model --outputTestData test.csv</span></pre><p id="b2fa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是主脚本的代码片段。最后一行将模型组件保存到本地的<code class="fe nz oa ob nq b">clf-model</code>目录中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="93c6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过运行以下命令为模型提供服务:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="caa9" class="nu me it nq b gy nv nw l nx ny">mlflow models serve -m clf-model -p 1234 -h 0.0.0.0</span></pre><p id="dae3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，您可以通过使用csv测试数据运行以下脚本来进行预测:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="a986" class="nu me it nq b gy nv nw l nx ny">./predict.sh test.csv</span></pre><p id="6162" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它运行以下curl命令:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="82d4" class="nu me it nq b gy nv nw l nx ny">curl <a class="ae na" href="http://localhost:1234/invocations" rel="noopener ugc nofollow" target="_blank">http://localhost:1234/invocations</a> \<br/>-H ‘Content-Type: text/csv’ --data-binary @test.csv</span></pre><h1 id="1779" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">使用mlflow注册表训练和服务模型</h1><p id="e10f" class="pw-post-body-paragraph ky kz it la b lb mv ju ld le mw jx lg lh mx lj lk ll my ln lo lp mz lr ls lt im bi translated">使用mlflow注册表可以让您做很多很酷的事情:</p><ul class=""><li id="a272" class="nb nc it la b lb lc le lf lh nd ll ne lp nf lt ng nh ni nj bi translated">有一个中心位置来跟踪和分享不同的实验</li><li id="57f3" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">跟踪并轻松查看模型和代码输入参数</li><li id="b65d" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">记录和查看指标(准确性、召回率等)</li><li id="17cb" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">将您的模型版本化，并比较在相同实验下记录的不同模型的性能</li><li id="9b82" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">与任何其他可以访问注册表的用户协作，在同一个实验中注册他们的模型</li><li id="827a" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">轻松地将模型转换到不同的阶段(例如，<code class="fe nz oa ob nq b">Staging</code>、<code class="fe nz oa ob nq b">Production</code>)，这意味着，<em class="oe">不是引用特定编号的模型，而是将您最近喜欢的模型切换到特定的阶段，下游组件可以通过引用该阶段无缝地使用该新模型</em></li></ul><p id="8a9a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过运行以下脚本，首先启动mlflow服务器以在本地使用注册表:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="effe" class="nu me it nq b gy nv nw l nx ny">./runServer.sh</span></pre><p id="c457" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它只运行以下命令:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="e8c7" class="nu me it nq b gy nv nw l nx ny">mlflow server \<br/> --backend-store-uri sqlite:///mlflow.db \<br/> --default-artifact-root ./mlflow-artifact-root \<br/> --host 0.0.0.0</span></pre><p id="7736" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将运行在您的浏览器中可见的mlflow UI。</p><p id="587a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nz oa ob nq b"><a class="ae na" href="https://github.com/mtpatter/mlflow-tutorial/blob/main/clf-train-registry.py" rel="noopener ugc nofollow" target="_blank">clf-train-registry.py</a></code>脚本使用sklearn乳腺癌数据集，训练一个简单的随机森林分类器，并将模型和指标保存并注册到指定url的mlflow注册表中。添加用于写入输出测试数据的可选标志将首先分割训练数据以添加示例测试数据文件。</p><p id="aa13" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">若要训练模型，请使用以下命令:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="318e" class="nu me it nq b gy nv nw l nx ny">python clf-train-registry.py clf-model "<a class="ae na" href="http://localhost:5000" rel="noopener ugc nofollow" target="_blank">http://localhost:5000</a>" \<br/>--outputTestData test.csv</span></pre><p id="d72a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是该脚本的一个代码片段，它将最新的模型移入阶段<code class="fe nz oa ob nq b">Staging</code>，并将之前的模型移回<code class="fe nz oa ob nq b">None</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="ffc6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将新转换的<code class="fe nz oa ob nq b">Staging</code>型号服务到端口1234:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="0105" class="nu me it nq b gy nv nw l nx ny">mlflow models serve models:/clf-model/Staging -p 1234 -h 0.0.0.0</span></pre><p id="6a92" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，您可以通过使用csv测试数据运行以下脚本来进行预测:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="8312" class="nu me it nq b gy nv nw l nx ny">./predict.sh test.csv</span></pre><p id="d6c0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它再次运行下面的curl命令:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="fafe" class="nu me it nq b gy nv nw l nx ny">curl http://localhost:1234/invocations \<br/>-H ‘Content-Type: text/csv’ --data-binary @test.csv</span></pre><p id="c3f7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">就是这样！</p><p id="7a67" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有几点需要注意:</p><ul class=""><li id="c740" class="nb nc it la b lb lc le lf lh nd ll ne lp nf lt ng nh ni nj bi translated">如果您使用Docker Compose运行本教程，容器将访问并写入您的本地挂载目录。</li><li id="920b" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">当通过Python API加载模型时，您需要确保您的环境sklearn版本与您用来保存它的版本相同(这就是为什么我更喜欢在Docker中做任何事情)。</li><li id="3d3c" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">你可以用<code class="fe nz oa ob nq b">docker compose down</code>清理运行中的容器。</li></ul><p id="7b78" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">希望这是生产机器学习模型的良好开端。通过替换示例培训脚本，您应该能够将本教程用于您自己的模型。</p><p id="8e65" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在后续的文章中，我将介绍如何构建您自己的定制mlflow模型，以便您可以通过REST api提供几乎任何您喜欢的功能。敬请期待！</p></div></div>    
</body>
</html>