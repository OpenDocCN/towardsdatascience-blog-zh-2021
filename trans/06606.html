<html>
<head>
<title>D3 and R, a match made in heaven</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">D3和R，天作之合</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/d3-and-r-a-match-made-in-heaven-ff0bf82efe9a?source=collection_archive---------11-----------------------#2021-06-14">https://towardsdatascience.com/d3-and-r-a-match-made-in-heaven-ff0bf82efe9a?source=collection_archive---------11-----------------------#2021-06-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="abef" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一步一步的教程，使用你自己的数据，将D3 Gallery例子转换成R闪亮的应用程序</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/566053a9b6e93f1d05ddb4774e78c286.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tf_D956ZoVsMMdPK"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">尼古拉斯·卡佩罗在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="6b1a" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">D3的问题，以及R如何帮助。</h1><p id="36b9" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">你已经看到了华丽的D3图表画廊。你已经在纽约时报网站上看到了惊人的信息图表。也许，你受到了启发，浏览了一些D3教程，买了一个在线课程或一本书。最有可能的是，当你得知这个冷酷的事实时，你沮丧地举起了双手:</p><p id="b7e4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">D3很难。像，真的很难。</p><p id="b535" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">你可能想从图库中选择一幅令人惊叹的图表，并将其用于你的项目。然而，在你的道路上有许多障碍:</p><ul class=""><li id="0854" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">D3不能在真空中运行。它需要由服务器来呈现。</li><li id="a166" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">即使你让图库实例运行，你也不想用他们的数据，你想用<em class="nd">你的</em>数据。</li><li id="0bbc" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">D3讨厌你。</li></ul><p id="965a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我有好消息要告诉你:有一种方法可以把D3带给有R的人，R闪亮的库把R代码变成一个web应用程序，充当web服务器。事实证明，D3需要一个网络服务器来使它焕发生机。我们将从D3图库中取出其中一张图表，并在Shiny中运行。我们还将使用R的令人敬畏的Tidyverse包来分割我们自己的数据，并给用户参数来改变D3图形。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="1719" class="kw kx iq bd ky kz nl lb lc ld nm lf lg jw nn jx li jz no ka lk kc np kd lm ln bi translated">为什么要使用D3呢？</h1><p id="18a8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">为什么要将D3和R一起使用呢？R不是已经有35个图形包了吗？为什么我不用ggplot2来代替呢？是什么让D3如此特别。</p><p id="8baa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">答案很简单，D3不仅仅是另一个图形库。事实上，D3 <em class="nd">根本不是</em>图形库！它是一个JavaScript库，可以操作HTML并制作SVG(web使用的可缩放图像)。或许可以打个比方。</p><p id="f07f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果excel graphs是一辆现代汽车，那么ggplot2可能就是一辆法拉利。D3将是制造法拉利的工厂。D3可以构建构成一个伟大图形的所有小组件，并将它们拼凑成一个有凝聚力的形状。</p><p id="e839" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这里有几个你可能想考虑D3而不是R的其他图形包的原因:</p><ul class=""><li id="9ec6" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">r的图形库是你头脑的盒子。他们给你所有这些生活准则。你想把那个标签放在酒吧中间，上下倾斜56度，字体是你在黑暗网上盗版的吗？不，你不能这么做。</li><li id="8e11" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">D3没有盒子住。没有规则。你可以做出你想要的最丑的图形。继续把标签放在那里，D3不在乎。</li><li id="ae7f" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">如果可以用300行JavaScript代码制作条形图，为什么要用3行ggplot2代码呢？我们不偷工减料。这就是数据科学。</li></ul><p id="d0d7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">既然我已经把你卖了，是时候去工作了。我们将从D3图库中取出<a class="ae kv" href="https://bl.ocks.org/mbostock/1389927" rel="noopener ugc nofollow" target="_blank">这个例子</a>并修改它，直到它达到我们想要的效果。例子是D3创始人自己做的条形图；迈克·博斯托克。</p><p id="ce9b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我知道条形图并不令人兴奋。但是如果你能让R提供一个D3条形图，那么你也能让R提供一个梯度增强，反向传播，力导向的径向旭日D3图。摇滚起来。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="0c49" class="kw kx iq bd ky kz nl lb lc ld nm lf lg jw nn jx li jz no ka lk kc np kd lm ln bi translated">步骤0:安装我们需要的R包</h1><p id="731a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们将需要这个教程的3 R包。如果您已经安装了这些，请跳到步骤1。如果没有，继续从R控制台运行下面的代码来安装它们。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="e41e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">他们是做什么的？Shiny会做我们的web应用，Tidyverse会把数据切片切块，jsonlite会把我们的数据变成json这是D3喜欢的格式。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="19a2" class="kw kx iq bd ky kz nl lb lc ld nm lf lg jw nn jx li jz no ka lk kc np kd lm ln bi translated"><strong class="ak">第一步:创建闪亮的应用</strong></h1><p id="6d9a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在RStudio中，通过进入文件-&gt;新项目-&gt;新目录-&gt; shiny Web应用程序，创建一个新的Shiny应用程序。输入应用程序的名称，并选择项目所在的文件夹。最后点击“创建项目”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/39609ac28579133532765cb3b925485e.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/1*r42DUcSAcfdWL6sKDybT2A.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="nt">作者图片</em></p></figure><p id="de84" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">就像你面前有一个闪亮的应用程序一样！接下来，您需要在项目目录中创建一个名为“www”的文件夹。您可以从windows文件系统或直接从文件窗格中的RStudio(默认情况下，位于RStudio的右下角)执行此操作</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/c16cbee5d7b28b23e087e962d0678f14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*wU5_ZGR1PN61p9MXgd82sg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="nt">作者图片</em></p></figure><p id="c203" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">什么是www文件夹？这就是web文件的去处(html、css、javascript)。猜猜什么是D3脚本？</p><p id="5125" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后，让我们清除这个例子。删除UI和服务器函数中的所有内容，这样我们就有了一个全新的、空白的开始。让我们添加我们将在本教程中使用的所有包。</p><h2 id="8b7e" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated"><strong class="ak">初始app。R: </strong></h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="0840" class="kw kx iq bd ky kz nl lb lc ld nm lf lg jw nn jx li jz no ka lk kc np kd lm ln bi translated"><strong class="ak">第二步:各就各位，各就各位。</strong></h1><p id="edca" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在我们有了一个存放D3文件的地方，是时候把东西放到正确的位置了。大多数D3例子有2到4个文件。典型的有:</p><ul class=""><li id="253c" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">html文件</li><li id="889b" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">css文件</li><li id="664a" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">javascript文件</li><li id="7101" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">数据(通常是json或csv)</li></ul><p id="1791" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这些有的时候都是分开的，有的时候是合在一起的。在我们的例子中，只有一个包含css和javascript的html文件和一个存储数据的csv文件。我们需要把这些分开。我们不需要创建一个html文件，因为这就是我们的UI在Shiny复制中的功能。但是我们确实需要整理CSS和JavaScript</p><p id="ca9f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">打开你选择的代码编辑器(VS Code，Sublime，Notepad，随便什么)，将CSS复制到一个新文件中。将此文件以“style.css”的名称保存到www文件夹中。这是您想要的代码:</p><h2 id="7ca2" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated"><strong class="ak">style . CSS:</strong></h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="99ae" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接下来，您将看到两个脚本部分。第一个只有这一小段代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="afa7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这个脚本告诉您的应用程序“哟！我们用的是D3”。对于一个闪亮的应用程序，我们真的不需要index.html文件。这就是我们的UI函数所模拟的！所以这是放置这些类型的脚本的好地方，尤其是那些在标签中的。当我们这样做的时候，让我们继续调用我们的CSS文件，这样我们的应用程序就知道当它想要变得时尚的时候在哪里可以看到它！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="9aaa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后但同样重要的是实际的D3代码。这是所有东西之间最后的<script> </script>标记。把它放到一个名为“script.js”的新文件中，这个文件位于<em class="nd"> www </em>文件夹中。</p><h2 id="cfc3" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated">初始script.js</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="f3b4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果你已经做到这一步，我们都准备好了！不要担心csv文件，而不是使用它，我们将带来我们自己的数据！我们的www目录现在应该是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/62c268412cd645a1957eb5c7dfe4433b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*a7JCatpCnnMf5rdtDDe-mg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="nt">作者图片</em></p></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="e6c7" class="kw kx iq bd ky kz nl lb lc ld nm lf lg jw nn jx li jz no ka lk kc np kd lm ln bi translated"><strong class="ak">第三步:制作前端</strong></h1><p id="e34f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在是时候为我们的应用程序创建用户界面了。在我们的例子中，我们将使用“mpg”数据集中内置的Tidyverse包。该数据集列出了许多流行的汽车品牌和型号及其燃油效率指标。下面是ui函数的最终代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="acdc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">“标题面板”功能做你想做的，它为我们的应用程序创建一个标题。“选择输入”功能创建一个下拉列表，其中包含一些车辆尺寸选项。这是我们将用来改变D3图的输入。</p><p id="22c2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后，我们有一个“uiOutput”函数，它在寻找一个叫做“d3”的东西。每当你在ui函数(tableOutput、plotOutput等)中看到‘Output’这个词，就意味着UI函数正在从服务器函数中寻找一个对象。在我们的例子中，它将是一个名为d3的renderUi输出对象。我们将在下一步建造它。</p><p id="61d2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">你现在可以运行这个项目，并得到一个超级无聊的应用程序，它有一个标题和一个下拉列表。卑微的出身。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="d73d" class="kw kx iq bd ky kz nl lb lc ld nm lf lg jw nn jx li jz no ka lk kc np kd lm ln bi translated"><strong class="ak">第四步:构建后端</strong></h1><p id="c398" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">服务器功能是每一个闪亮的应用程序最好的部分。这是你研究数据科学的地方。这也是您从堆栈溢出粘贴代码并希望它工作的地方。现在想来，那两件事是一样的。</p><p id="9973" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在我们开始构建服务器函数之前，让我们看一下数据集。在RStudio控制台中，键入以下内容并按enter:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="dac4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下面是结果。这是mpg数据集。我们将获取这个有234行的数据集，并获得每个制造商的平均城市英里数。这将使我们减少到15行数据，我们将绘制图表。查看“级别”字段(紧凑型、suv等。)?这是我们将在ui函数中与下拉菜单挂钩的字段。当用户选择“suv”时，我们的服务器功能将只过滤生产suv的制造商的数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/035fe0d8eac696d93635aa0dd8891b18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*juObGAHiwTE0xO_bLuFtQQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="nt">作者图片</em></p></figure><p id="2d64" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将使用R精彩的Tidyverse库来完成这种分组和聚合。我不想太深入地学习如何用Tidyverse分割数据，这本身就值得写一篇文章。我将向您展示代码，并简要描述其工作原理。从控制台运行以下命令:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="3290" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/25356831cf95213a1bfa88a14c313005.png" data-original-src="https://miro.medium.com/v2/resize:fit:388/format:webp/1*rIdWHYmPnxyJ6USs9oYa4Q.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="nt">作者图片</em></p></figure><p id="710d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这段代码在做什么？这其实很简单。这是Tidyverse语法，从上到下读。“%&gt;%”语法是Tidyverse库将代码块的当前状态链接到下一个状态的方式。你可以把它想成‘然后做这个…’。在英语中是:</p><pre class="kg kh ki kj gt ok ol om on aw oo bi"><span id="6429" class="nv kx iq ol b gy op oq l or os">Take the mpg dataset. <br/>Filter to where the records in the class column = 'suv'.<br/>Create a new column called avgCity that is the average of city mpg<br/>Reduce the columns to just manufacturer and avgCity <br/>Remove all duplicate records<br/>Rename manufacturer to 'name' and avgCity to 'value'</span></pre><p id="54e6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">既然您已经理解了这一点，那么是时候向您展示Shiny中服务器函数的完整代码了。</p><h2 id="6a9f" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated">最终的服务器功能</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="68cc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我从上到下解释一下。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="95c9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">默认情况下，服务器函数只有输入和输出。我必须将session添加到这个参数列表中。session参数将允许Shiny从服务器函数向web页面发送信息。在我们的例子中，我们试图将R中的数据放到www文件夹中的JavaScript代码中。这个参数就是导致这种情况发生的原因。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="bb98" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">observeEvent函数在我们的ui函数中监视我们的下拉菜单，回想一下，我们给了它一个输入id“vehicle class”。如果下拉列表发生变化(比如从“suv”变为“compact”)，这个observeEvent函数将会注意到这种变化，使当前的事务状态无效，并重新运行这个代码块来确定新的事务状态。最终，它将更新我们的D3图。</p><p id="58ff" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下一个代码块与我们上面运行的Tidyverse示例相同，只有一个小的变化:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="2937" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们没有将类别硬编码为“suv ”,而是将其映射到vehicleClass下拉列表中。当您将下拉列表从紧凑型车更改为suv时，我们对mpg数据集的过滤器也会发生变化。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="aa53" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在我们使用jsonlite库。这只是获取我们聚合和过滤的数据的状态，并将其转换成json格式。D3喜欢json，所以我们喜欢json。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="0efa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这就是神奇的调味汁！这一小段代码获取我们的json有效负载，并跨会话发送它，以便我们的D3 JavaScript可以使用它！r正在向我们的www文件夹发送一条消息，说“哟！下面是数据！用它做些奇妙的事情吧！!"</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="70de" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后我们有了这一小段代码。回想一下我们的UI函数有这个<em class="nd"> uiOutput("d3 ")？</em>同样，我们可以从用户界面向服务器发送信息(通过输入$id语法)，我们也可以从服务器向用户界面发送信息。在本例中，我们创建了一个名为“output$d3”的对象，这只是一个html行，上面写着“在网页中呈现这个JavaScript代码”。脚本的名字叫“script.js”，也就是我们命名的或者D3脚本！</p><p id="0ca8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在这个例子还不能运行。尽管R现在将我们的数据以json格式发送到我们的D3脚本，但是我们的D3脚本还没有配置为接受它。直到现在，我们终于准备好冒险进入名为D3的黑暗森林深处。</p><p id="5a73" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这是我们完成的应用程序。r:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="0c41" class="kw kx iq bd ky kz nl lb lc ld nm lf lg jw nn jx li jz no ka lk kc np kd lm ln bi translated"><strong class="ak">第五步:D3 </strong></h1><p id="9674" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">2000字后，我们做到了。我们已经爬到了R山的山顶，只为发现面前的D3山这个庞然大物。我们是会绝望，像我们前面的许多人一样回头，还是会勇往直前，去一个书呆子从未去过的地方。</p><p id="3f96" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">好吧，让我们不要对此大惊小怪。我们真的只需要改变一些事情就可以了。我假设如果你真的读到这里，你会更愿意复制/粘贴到痛苦的结局。</p><p id="381d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">当Mike Bostock发布这个D3条形图代码时，他认为阅读它的人足够聪明，知道它的意思，因此他没有留下任何有用的评论来告诉我们它是如何工作的。我将假设阅读我的新版本代码的人是一个白痴，并明确地告诉你它是做什么的。为什么？</p><ol class=""><li id="2e32" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj ot mv mw mx bi translated">我是个好人。</li><li id="72f2" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj ot mv mw mx bi translated">阅读我的代码的白痴99%是我，6个月后，在我忘记了一切之后。我知道未来的我很忙，有自己的生活，也很重要。我的文档和代码注释是现在的我送给未来的我的小礼物。</li></ol><p id="2951" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">首先运行应用程序。该应用程序将实际上拉起来，你可以改变下拉菜单，并注意到没有什么变化。为了解决D3的问题，我们需要点击“在浏览器中打开”,然后在Chrome中检查代码。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/fbde8dc87625ed878b676e54002d1c79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1VERiXVsnETlHDOeLd48lA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="nt">作者图片</em></p></figure><p id="f216" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">通过在浏览器中右键单击并转到“inspect”或简单地点击cntrl + shift + j来打开Chrome检查器。单击控制台选项卡，您将看到以下错误:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/59f1c245058b2e6355546fcf2dc8e1e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*7JTtJtd6WbNXcXqWupbhXQ.png"/></div></figure><p id="cd52" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这是因为我们的D3有这样一段代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="caaf" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们不想使用示例“sample-data.csv”文件。我们想使用由Shiny的session对象发送的数据。我们可以通过将整个D3脚本封装在一个用于接收“jsondata”类型消息的函数中来解决这个问题。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="58bc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果您还记得，我们的服务器函数发出了这种类型的消息(' jsondata ')，并且包含保存我们的mpg数据的json有效负载:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="8237" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">换句话说，Shiny是以json的形式广播我们的mpg数据，D3是监听它的。如果Shiny改变了数据集(比如通过改变输入)，它将广播这个数据集的新版本，D3将监听这个改变并提取它。</p><p id="c3e4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这个函数真的是让Shiny和D3对话的神奇酱。一旦您将整个D3脚本封装在这个很酷的函数中，您就可以删除调用csv的代码。我们还想做一些改变，使我们的图形在用户界面上看起来更好，并正确映射我们的数据。在这里，我将向您展示D3脚本的完整、最终和注释版本。这些评论将注释所有这些变化的含义。</p><h2 id="99aa" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated">最终的script.js文件:</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="7eee" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您将会看到，除了少数例外，代码并没有被修改太多。我现在用#d3Graph的html id做几件事。你将会遇到的问题是，当数据失效(当你改变下拉菜单)并且一个新的版本从Shiny发送到D3时，每次发生这种情况时，都会生成一个新的图形。你最终会得到一页新的图表，一张一张地叠在一起。我在d3上添加了几行代码，为我们的图添加了一个id。每次我们的函数运行时，它都会删除解决问题的旧图。</p><p id="854a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">代码的另一个值得注意的变化是，我将我们的数据设置为等于来自脚本顶部的jsondata消息处理程序的消息:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="fb7a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我还修改了页边距，以确保D3不会将我们的图表放在离浏览器边缘太近的地方，给我们一些喘息的空间:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="f53e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后一个改变是把条形从蓝色变成紫色。我是通过打开“style.css”文件并修改条形填充值来实现的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h1 id="9d5f" class="kw kx iq bd ky kz nl lb lc ld nm lf lg jw nn jx li jz no ka lk kc np kd lm ln bi translated"><strong class="ak">第六步:运行应用</strong></h1><p id="eb57" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在我们终于可以运行应用程序了:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/c486a96ddafeb0caeb8371a95fb7490d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xc5gZqJ0ZTTyoU63xTFqpw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="nt">作者图片</em></p></figure><p id="bdba" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">更改下拉列表将会更新图表！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/0a2039c69d1433fa4a0a4ddac01a41e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PWwfeISLIahxW5Q64dj1xw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="nt">作者图片</em></p></figure><p id="0247" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">就是这样！现在你明白了如何将D3 gallery示例转换成闪亮的likes格式。您可以将自定义数据从R发送到JavaScript，并制作漂亮的图形。</p><p id="893e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下面是Github 上的<a class="ae kv" href="https://github.com/KendonDarlington/D3FromShiny" rel="noopener ugc nofollow" target="_blank">完整项目！只需下载它，并在R中打开它。自述文件将告诉您R的版本和我用来创建它的库。</a></p></div></div>    
</body>
</html>