<html>
<head>
<title>Visualization of One Million Schools Mapped by UNICEF’s Giga Initiative</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">联合国儿童基金会 Giga 计划绘制的 100 万所学校的图像</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/time-lapse-visualization-of-1-million-schools-mapped-by-unicefs-giga-initiative-using-plotly-d09629ff292d?source=collection_archive---------28-----------------------#2021-11-04">https://towardsdatascience.com/time-lapse-visualization-of-1-million-schools-mapped-by-unicefs-giga-initiative-using-plotly-d09629ff292d?source=collection_archive---------28-----------------------#2021-11-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4088" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用 python 中的 Plotly Express 制作延时动画</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/753d0b43091de9728e8d2498a6f517c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NOLgKAP_Ss6sOcNQ5GOMyg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Giga initiative 绘制的 100 万所学校地图(图片由作者提供)</p></figure><p id="6073" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">giga initiative<a class="ae lr" href="http://gigaconnect.org" rel="noopener ugc nofollow" target="_blank">http://gigaconnect.org</a>，联合国儿童基金会和国际电联的一个联合项目，旨在为世界上的每所学校提供互联网连接。为了实现这一目标，我们在 Giga 的数据科学团队一直致力于收集学校的准确位置信息。</p><p id="0014" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在 2021 年 11 月 1 日，我们已经实现了在我们的系统【https://projectconnect.unicef.org/map<a class="ae lr" href="https://projectconnect.unicef.org/map" rel="noopener ugc nofollow" target="_blank"/>中映射学校的一百万大关。为了庆祝 Giga 团队的成就，我们准备了一个特殊的视觉化的学校地图，从一开始一直到我们达到一百万大关。</p><p id="2a68" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于地图可视化，我们使用 Plotly Express。Plotly Express 提供了制作延时动画的功能。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="5d80" class="lx ly iq lt b gy lz ma l mb mc">#import all libraries</span><span id="f8cf" class="lx ly iq lt b gy md ma l mb mc">import pandas as pd<br/>import geopandas as gpd<br/>import numpy as np<br/>import plotly.express as px<br/>from datetime import datetime, timedelta<br/>import os<br/>import ffmpeg</span></pre><p id="6fce" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然而，由于我们的学校位置数据集超过 100 万个点，我们第一次使用它制作动画的尝试失败了。相反，我们采用了一种方法，使用 Plotly Express 一次“渲染”一帧时间推移动画，最后使用 ffmpeg 将渲染的帧合并到一个 MP4 文件中。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="9b12" class="lx ly iq lt b gy lz ma l mb mc">location_file = 'allschool_for_visualization.csv'<br/>df = pd.read_csv(location_file)<br/>df.head()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi me"><img src="../Images/3c3ab5b303a4bf52aa01e9b71d6b3285.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i_IN80zH5HLivU6KtBspGQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来自外部数据集的学校信息</p></figure><p id="69e5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于背景，我们使用了 mapbox 的深色贴图，它需要一个 api 键</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="f9f2" class="lx ly iq lt b gy lz ma l mb mc">px.set_mapbox_access_token('<em class="mf">your api key</em>')</span></pre><p id="8c8a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们准备了注释来显示绘制的日期和学校数量。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="5f9b" class="lx ly iq lt b gy lz ma l mb mc">annotation = {<br/>    'xref': 'paper',  <br/>    'yref': 'paper',  <br/>    'x': 0.1,  <br/>    'y': 0.1,  <br/>    'text': '',<br/>    'showarrow': False,<br/>    'arrowhead': 0,<br/>    'font': {'size': 50, 'color': 'white'}<br/>}</span></pre><p id="12d4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">由于渲染一帧需要很长时间，我们不得不使用具有更高 CPU 和内存(16 个 CPU 和 64 GB 内存)的多处理。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="7bd1" class="lx ly iq lt b gy lz ma l mb mc">import multiprocess as mp<br/>import tqdm</span></pre><p id="1cfe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">开始日期，即从“日期”字段中取最小值得到的第一帧的日期。结束日期以同样的方式收集</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="71fc" class="lx ly iq lt b gy lz ma l mb mc">start_date = min(df['date'])<br/>end_date = max(df['date'])</span></pre><p id="4e4a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后定义了一个函数来按日期呈现一个帧</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="0e11" class="lx ly iq lt b gy lz ma l mb mc">def write_imgs(days):<br/>    try:<br/>        date = start_date + timedelta(days) <br/>        date_str = str(date.year).zfill(4)+'-'+str(date.month).zfill(2)+'-'+str(date.day).zfill(2)<br/>        annotation['text'] = date_str + '    schools mapped: ' + str(len(df[df['date']&lt;date]))</span><span id="2bfd" class="lx ly iq lt b gy md ma l mb mc">fig = px.scatter_mapbox(df[df['date']&lt;date], center={'lat':0,'lon':0},lat="lat", lon="lon", zoom=2,opacity=0.5, size='size', size_max= 1.5, mapbox_style='dark',<br/>                title = 'schools')<br/>        fig.update_layout(width = 1920, height=1080, margin={"r":0,"t":0,"l":0,"b":0})<br/>        fig.add_annotation(annotation)<br/>        fig.write_image(f"frames2/frame_{days:04d}.png")</span><span id="69a8" class="lx ly iq lt b gy md ma l mb mc">return(1)<br/>    except:<br/>        return(0)</span></pre><p id="6c55" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该函数由多处理池调用，以日期数组作为输入参数</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="30cb" class="lx ly iq lt b gy lz ma l mb mc">p = mp.Pool(processes=8)<br/>arr_days=range((end_date - start_date).days)</span><span id="ee4f" class="lx ly iq lt b gy md ma l mb mc">results = list(tqdm.tqdm(p.imap_unordered(write_imgs, arr_days), total=len(arr_days)))</span></pre><p id="903e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，调用 ffmpeq 将所有帧合并成一个 mp4 文件。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="9bd2" class="lx ly iq lt b gy lz ma l mb mc">os.system("ffmpeg -i frames/frame_%4d.png -vcodec libx264 -crf 25 -pix_fmt yuv420p -r 30 -s 1920x1080 ./one_million_schools.mp4")</span></pre><p id="c391" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请点击下面的链接查看结果！</p><div class="mg mh gp gr mi mj"><a href="https://www.linkedin.com/posts/giga-connect_giga-maps-1-million-schools-activity-6859460706060906496-KbeZ" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd ir gy z fp mo fr fs mp fu fw ip bi translated">LinkedIn 上的 Giga:Giga 映射了 100 万所学校</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">我们如何弥合数字鸿沟？我们已经开始#绘制世界上每所学校的地图--向我们展示资源在哪里…</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">www.linkedin.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx kp mj"/></div></div></a></div></div></div>    
</body>
</html>