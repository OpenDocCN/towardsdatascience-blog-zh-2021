<html>
<head>
<title>Deploy a Python Visualization Panel App to Google Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将 Python 可视化面板应用程序部署到 Google Cloud Run</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-a-python-visualization-panel-app-to-google-cloud-ii-416e487b44eb?source=collection_archive---------7-----------------------#2021-12-25">https://towardsdatascience.com/deploy-a-python-visualization-panel-app-to-google-cloud-ii-416e487b44eb?source=collection_archive---------7-----------------------#2021-12-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="df03" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Google 云运行、Google 云构建和 Terraform</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/da41d05967180e7a9bdf92a8841bef7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jL8bas5xRN-HZBKVIPW-dQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">小塔德乌在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="4f80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相关文章:<a class="ae ky" rel="noopener" target="_blank" href="/deploy-a-python-visualization-panel-app-to-google-cloud-cafe558fe787?sk=98a75bd79e98cba241cc6711e6fc5be5">部署一个 Python 可视化面板 App 到 Google Cloud App Engine:Google Cloud App Engine 和 Github Actions </a>。</p><p id="838a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我上一篇<a class="ae ky" rel="noopener" target="_blank" href="/deploy-a-python-visualization-panel-app-to-google-cloud-cafe558fe787?sk=98a75bd79e98cba241cc6711e6fc5be5">博客文章</a>中，我写了如何将 Python 可视化面板应用部署到谷歌云应用引擎。App Engine 运行良好，但它可能很贵，因为无论是否有人使用它，应用程序都会持续运行。幸运的是，有一个更便宜的选项叫做 Cloud Run，它只在收到请求时运行。</p><p id="5c90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将带您了解如何使用三个简单的脚本将 Python 应用程序或仪表板部署到 Google Cloud Run，以及如何通过 Cloud Build 和 Terraform 自动化您的 Google Cloud 设置。</p><p id="2922" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我的非常简单的示例应用程序的样子。它被托管在<a class="ae ky" href="https://demo-he54wmmt4q-uc.a.run.app" rel="noopener ugc nofollow" target="_blank">这里</a>，在这篇文章发表后，它将在这里生存 3 个月。关于面板应用的更多例子和灵感，请查看<a class="ae ky" href="http://awesome-panel.org/" rel="noopener ugc nofollow" target="_blank">awesome-panel.org</a>、<a class="ae ky" href="https://panel.holoviz.org/" rel="noopener ugc nofollow" target="_blank">panel.holoviz.org</a>，以及我之前关于<a class="ae ky" rel="noopener" target="_blank" href="/visualization-and-interactive-dashboard-in-python-c2f2a88b2ba3?sk=c78ed971426bbccb89798759779aa303"> HoloViz 工具</a>的博文。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/25df28659a59a6a2b3da1fc4e9f2ff88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*njY_3b4i7CranNx2"/></div></div></figure><h1 id="7c25" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">1.设置</h1><p id="4ca2" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated"><strong class="lb iu">设置您的 Google Cloud 帐户</strong>:</p><p id="0e50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://cloud.google.com/run/docs/quickstarts/build-and-deploy/python" rel="noopener ugc nofollow" target="_blank">云运行文档</a>描述了运行项目所需的以下步骤:</p><ul class=""><li id="cf17" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated"><a class="ae ky" href="https://console.cloud.google.com/projectselector2/home/dashboard" rel="noopener ugc nofollow" target="_blank">选择或创建一个谷歌云项目</a>(我们假设项目名称和 ID 都是“你的项目”)</li><li id="118c" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://console.cloud.google.com/billing/projects" rel="noopener ugc nofollow" target="_blank">启用计费</a></li></ul><p id="63c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">在本地机器上安装并初始化 Google Cloud SDK</strong>:</p><ul class=""><li id="ad96" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated"><a class="ae ky" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank">安装谷歌云 SDK </a>:操作系统不同，说明也会有所不同，或者你可以简单地</li></ul><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="51a7" class="nm lx it ni b gy nn no l np nq">conda install -c conda-forge google-cloud-sdk</span></pre><ul class=""><li id="b07c" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">初始化 gcloud:</li></ul><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="0ce8" class="nm lx it ni b gy nn no l np nq">gcloud init</span></pre><ul class=""><li id="4f8a" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">将项目设置为“您的项目”(或您用于您的项目的任何名称/ID):</li></ul><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="46d5" class="nm lx it ni b gy nn no l np nq">gcloud config set project your-project</span></pre><h1 id="fa89" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">2.创建面板应用程序</h1><p id="3a1d" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">创建一个新目录，或者在这个目录中创建以下三个文件，或者从我的 repo 中获取:<a class="ae ky" href="https://github.com/sophiamyang/panel_cloud_run" rel="noopener ugc nofollow" target="_blank">https://github.com/sophiamyang/panel_cloud_run</a>。</p><p id="a34e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> app.py </strong></p><p id="482e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是创建 Panel 应用程序的 Python 文件。要在本地运行这个应用程序，您可以简单地执行<code class="fe nr ns nt ni b">conda install panel hvplot</code>并运行<code class="fe nr ns nt ni b">panel serve app.py</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="e528" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> requirements.txt </strong></p><p id="3c51" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该文件列出了我们的 Panel 应用程序的所有包依赖项。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="a297" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> Dockerfile </strong></p><p id="d87f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Dockerfile 安装 Python 和这个项目的依赖项，然后运行命令<code class="fe nr ns nt ni b">panel serve</code>来运行我们的面板应用程序。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h1 id="3d13" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">3.将应用程序部署到 Google Cloud Run</h1><p id="abad" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">部署您的应用程序(选择服务文件夹):</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="a70b" class="nm lx it ni b gy nn no l np nq">gcloud run deploy</span></pre><p id="6a2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在 gcloud 努力设置您的项目几分钟后，您应该能够在命令行中看到的服务 URL 上看到您的仪表板，该 URL 将类似于“service-xxx-uc.a.run.app”。</p><h1 id="69a5" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">4.通过云构建和 Terraform 将应用程序部署到 Google Cloud Run</h1><p id="8352" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">这一步对于我们这个简单的 app 来说是没有必要的。但是当你的应用变得复杂，并且有很多应用需要管理时，使用 Terraform 通常是一个好的做法。Terraform 是一个“作为编码软件工具的开源基础设施”。</p><p id="4d02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在步骤 3 中，当我们通过<code class="fe nr ns nt ni b">gcloud run deploy</code>部署应用程序时，我们在命令行中做了很多决定。例如，我们设置了项目的区域，启用了一些需要的 API，并允许未经身份验证的调用来服务。Terraform 允许我们在代码中捕捉所有这些决策，这样我们就有一个地方来查看基础设施是如何设置的。</p><p id="b529" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要将 Terraform 与 Google Cloud Run 结合使用，需要两个部分:</p><p id="c4ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第 1 部分是使用 cloudbuild.yaml 文件构建一个容器映像来执行您的应用程序(即“构建映像”步骤)，并将您的容器映像推送到<a class="ae ky" href="https://cloud.google.com/artifact-registry/docs" rel="noopener ugc nofollow" target="_blank">工件注册表</a>(即“推映像”步骤)。</p><p id="32f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> cloudbuild.yaml </strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="a0e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行以下命令:</p><ul class=""><li id="f346" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">你可能需要认证<code class="fe nr ns nt ni b">gcloud auth application-default login</code></li><li id="0fc2" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><code class="fe nr ns nt ni b">gcloud builds submit</code></li></ul><p id="eda9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用 Google Cloud Build 提交构建。完成这一步后，您应该会在 https://console . cloud . Google . com/gcr/images/your-project/global/docker 看到您的容器映像，因为-project 是您的项目 ID，docker 是我们在 cloudbuild.yaml 文件中定义的服务名。</p><p id="3af9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第 2 部分是使用 terraform 从我们刚刚创建的容器映像创建一个 Google Run 服务。</p><p id="00dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> main.tf </strong></p><p id="c832" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个 terraform 配置文件为我们创建了一个“project”变量，以便在命令行上定义项目，启用云运行服务，指定云运行服务来运行我们刚刚在第 2 部分中创建的容器映像，设置服务公共，并返回一个服务 URL。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="f01f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行以下命令:</p><ul class=""><li id="8c23" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">如果在本地运行:<code class="fe nr ns nt ni b">conda install -c conda-forge terraform</code></li><li id="fde6" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">初始化地形:<code class="fe nr ns nt ni b">terraform init</code></li><li id="27dd" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">创建一个执行计划，给我们一个回顾的机会:<code class="fe nr ns nt ni b">terraform plan -var project=your-project</code></li><li id="cc26" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">执行地形计划:<code class="fe nr ns nt ni b">terraform apply -var project=your-project</code></li></ul><p id="97ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">几分钟后，您应该会在命令行中看到您的应用程序 URL:demo-XXX-UC . a . run . app。</p><p id="48f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后如果您想要移除云运行服务，<code class="fe nr ns nt ni b">terraform destroy -var project=your-project</code>或者删除整个项目。</p><p id="56af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，正如这篇<a class="ae ky" href="https://cloud.google.com/blog/topics/developers-practitioners/predictable-serverless-deployments-terraform" rel="noopener ugc nofollow" target="_blank"> Google Cloud 博文</a>中提到的，对于持续部署的开发，请查看<a class="ae ky" href="https://cloud.google.com/solutions/managing-infrastructure-as-code" rel="noopener ugc nofollow" target="_blank">“使用 Terraform、Cloud Build 和 GitOps 将基础设施作为代码进行管理”</a>。</p><p id="de92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总的来说，本文使用三个简单的脚本将一个可视化面板应用程序部署到 Google Cloud Run，并使用另外两个文件来设置 Google Cloud Build 和 Terraform。</p><p id="b233" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于那些对视频教程感兴趣的人，这里是本文的视频版本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nv l"/></div></figure><p id="3833" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">参考文献</strong>:</p><ul class=""><li id="dc77" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated"><a class="ae ky" href="https://cloud.google.com/run/docs/quickstarts/build-and-deploy/python" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/run/docs/quick starts/build-and-deploy/python</a></li><li id="839a" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://cloud.google.com/blog/topics/developers-practitioners/predictable-serverless-deployments-terraform" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/blog/topics/developers-从业者/可预测-无服务器-部署-地形</a></li><li id="8d9b" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://github.com/GoogleCloudPlatform/serverless-expeditions/tree/main/terraform-serverless" rel="noopener ugc nofollow" target="_blank">https://github . com/Google cloud platform/server less-expeditions/tree/main/terraform-server less</a></li><li id="409d" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://cloud.google.com/solutions/managing-infrastructure-as-code" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/solutions/managing-infra structure-as-code</a></li></ul><p id="029d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">鸣谢</strong>:感谢吉姆·贝德纳的指导和支持！</p><p id="e994" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">索菲娅·杨 2021 年 12 月 24 日</p></div></div>    
</body>
</html>