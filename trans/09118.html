<html>
<head>
<title>Snowflake S3 integration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">雪花S3集成</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/snowflake-s3-integration-911bd4b03739?source=collection_archive---------16-----------------------#2021-08-23">https://towardsdatascience.com/snowflake-s3-integration-911bd4b03739?source=collection_archive---------16-----------------------#2021-08-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/2010a7c045b431328f3d1f596293b1c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KWbxbLqgYwe3MJmknKVVxQ.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">凯利·西克玛在<a class="ae jd" href="https://unsplash.com/s/photos/snowflake?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><div class=""/><div class=""><h2 id="ff5f" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">访问存储在S3的文件，作为雪花中的常规表</h2></div><p id="6987" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">雪花集成对象使我们能够从雪花与外部系统连接。在我的<a class="ae jd" rel="noopener" target="_blank" href="/aws-lambda-integration-with-snowflake-426debc9ec3a">上一篇博客</a>中，我们讲述了如何创建API集成来调用AWS Lambda。在这个博客中，我们将看到如何集成AWS S3，以便我们可以访问存储的数据，并在雪花中查询它。</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lr"><img src="../Images/95b36b817fe76749fb4ea0c28b4b1d06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k5vTUuf_NqdnbxdbjzgyyQ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><h1 id="7927" class="lw lx jg bd ly lz ma mb mc md me mf mg km mh kn mi kp mj kq mk ks ml kt mm mn bi translated">实施细节</h1><h2 id="af58" class="mo lx jg bd ly mp mq dn mc mr ms dp mg le mt mu mi li mv mw mk lm mx my mm mz bi translated">AWS IAM角色</h2><p id="7e16" class="pw-post-body-paragraph kv kw jg kx b ky na kh la lb nb kk ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">为了让雪花能够与我们的AWS帐户对话，我们需要添加交叉帐户角色。该角色将由雪花帐户中的IAM身份承担，并在我们的AWS帐户中执行操作。</p><ul class=""><li id="6904" class="nf ng jg kx b ky kz lb lc le nh li ni lm nj lq nk nl nm nn bi translated">在您的AWS帐户中创建一个<strong class="kx jh">跨帐户IAM角色</strong>。放一个虚拟账户，我们稍后会更新信任政策。</li><li id="3c90" class="nf ng jg kx b ky no lb np le nq li nr lm ns lq nk nl nm nn bi translated">将一个<strong class="kx jh">内联策略</strong>附加到上面创建的角色。</li></ul><pre class="ls lt lu lv gt nt nu nv nw aw nx bi"><span id="2afb" class="mo lx jg nu b gy ny nz l oa ob">Version: '2012-10-17'<br/>Statement:<br/>- Effect: Allow<br/>  Action:<br/>  - s3:GetObject<br/>  - s3:GetObjectVersion<br/>  Resource: arn:aws:s3:::my-snowflake-data-bucket/dev/gold/*<br/>- Effect: Allow<br/>  Action: s3:ListBucket<br/>  Resource: arn:aws:s3:::my-snowflake-data-bucket</span></pre><p id="45fa" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">上述策略允许角色在前缀下访问S3存储桶。出于安全考虑，只添加雪花所需的最低访问权限。</p><h2 id="5794" class="mo lx jg bd ly mp mq dn mc mr ms dp mg le mt mu mi li mv mw mk lm mx my mm mz bi translated">雪花集成对象</h2><ul class=""><li id="17f8" class="nf ng jg kx b ky na lb nb le oc li od lm oe lq nk nl nm nn bi translated">创建一个<strong class="kx jh">存储集成对象</strong></li></ul><pre class="ls lt lu lv gt nt nu nv nw aw nx bi"><span id="f91b" class="mo lx jg nu b gy ny nz l oa ob">create or replace storage integration my_s3_int_01<br/>  type = external_stage<br/>  storage_provider = s3<br/>  enabled = true<br/>  storage_aws_role_arn = '&lt;IAM_ROLE_ARN&gt;'<br/>  storage_allowed_locations = ('s3://my-snowflake-data-bucket/dev/gold/');</span></pre><p id="009a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">上述命令在雪花中运行时会创建一个S3集成对象。此对象在雪花帐户中创建IAM标识。AWS帐户中的所有API操作将由该用户通过承担我们在<strong class="kx jh"> storage_aws_role_arn </strong>中提到的角色来执行。</p><p id="1e8f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如上所述，集成对象创建用户和外部身份。我们需要这些来增加AWS和雪花帐户之间的信任关系。为此，我们描述刚刚创建的集成对象，并记下<strong class="kx jh">存储_ AWS _ IAM _用户_ARN </strong> &amp; <strong class="kx jh">存储_ AWS _外部_ID </strong>的值</p><pre class="ls lt lu lv gt nt nu nv nw aw nx bi"><span id="f1d0" class="mo lx jg nu b gy ny nz l oa ob">describe integration my_s3_int_01;</span></pre><p id="a0d4" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">输出:</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi of"><img src="../Images/fdf90fc85aab0bdd08da8564c39303eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b65BE9-mWjH0oOCaZ3JvLw.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><p id="cb09" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦我们有了用户和外部身份，我们就更新在第一步中创建的角色的<strong class="kx jh">信任关系</strong>。在条件下，在主体&amp;存储_ AWS _外部_ID中添加存储_ AWS _ IAM _用户_ARN的值</p><pre class="ls lt lu lv gt nt nu nv nw aw nx bi"><span id="aac8" class="mo lx jg nu b gy ny nz l oa ob">Version: '2012-10-17'<br/>Statement:<br/>- Effect: Allow<br/>  Principal:<br/>    AWS: "&lt;STORAGE_AWS_IAM_USER_ARN&gt;"<br/>  Action: sts:AssumeRole<br/>  Condition:<br/>    ForAnyValue:StringLike:<br/>      sts:ExternalId:<br/>      - "&lt;STORAGE_AWS_EXTERNAL_ID&gt;"</span></pre><p id="b1bf" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们需要将存储在S3存储桶中的文件中的任何特殊格式告诉雪花。这是唯一需要我们雪花提供的文件格式是不够的。</p><ul class=""><li id="7af7" class="nf ng jg kx b ky kz lb lc le nh li ni lm nj lq nk nl nm nn bi translated">(可选)创建文件格式</li></ul><pre class="ls lt lu lv gt nt nu nv nw aw nx bi"><span id="4a8f" class="mo lx jg nu b gy ny nz l oa ob">CREATE OR REPLACE FILE FORMAT my_csv_format_01<br/>  TYPE = CSV<br/>  FIELD_OPTIONALLY_ENCLOSED_BY='"'</span></pre><h2 id="b439" class="mo lx jg bd ly mp mq dn mc mr ms dp mg le mt mu mi li mv mw mk lm mx my mm mz bi translated">雪花外部阶段</h2><p id="8e12" class="pw-post-body-paragraph kv kw jg kx b ky na kh la lb nb kk ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">一旦我们完成了访问和格式设置，我们就创建了stage。Stage存储外部文件的元数据，在我们的例子中是s3。这用于查找需要加载到雪花表格中的数据。我们已经创建了一个简单的阶段，您也可以看看其他选项，如加密。</p><ul class=""><li id="e3fb" class="nf ng jg kx b ky kz lb lc le nh li ni lm nj lq nk nl nm nn bi translated">创建<strong class="kx jh">外部阶段</strong></li></ul><pre class="ls lt lu lv gt nt nu nv nw aw nx bi"><span id="ac55" class="mo lx jg nu b gy ny nz l oa ob">create  or replace stage my_s3_stage_01<br/>  storage_integration = my_s3_int_01<br/>  url = 's3://my-snowflake-data-bucket/dev/gold/'<br/>  file_format = my_csv_format_01;</span></pre><p id="3f35" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">上面的命令创建了雪花和S3文件前缀之间的映射。它还告诉雪花使用一种文件格式，适合存储在S3的数据。</p><ul class=""><li id="9af8" class="nf ng jg kx b ky kz lb lc le nh li ni lm nj lq nk nl nm nn bi translated">创建<strong class="kx jh">外部表</strong></li></ul><pre class="ls lt lu lv gt nt nu nv nw aw nx bi"><span id="beeb" class="mo lx jg nu b gy ny nz l oa ob">create or replace external table ext_ccfinput_test_01<br/>  with location = @my_s3_stage_01/<br/>  auto_refresh = true<br/>  file_format = (type = CSV)<br/>  pattern='.*ganalytics.*[.]csv';</span><span id="80c8" class="mo lx jg nu b gy og nz l oa ob">describe stage my_s3_stage_01;</span></pre><p id="c3ed" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">类似于stage存储在哪里可以找到数据的信息，外部表<strong class="kx jh">存储文件级元数据，</strong>比如文件名、版本标识符和相关属性。这增加了一个抽象，允许我们像在雪花中一样查询数据。</p><h2 id="d50b" class="mo lx jg bd ly mp mq dn mc mr ms dp mg le mt mu mi li mv mw mk lm mx my mm mz bi translated">检查结果</h2><p id="103c" class="pw-post-body-paragraph kv kw jg kx b ky na kh la lb nb kk ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">现在我们准备在雪花中查询来自S3的数据。我们在创建的表上发出select语句。</p><pre class="ls lt lu lv gt nt nu nv nw aw nx bi"><span id="6fef" class="mo lx jg nu b gy ny nz l oa ob">select t.$1, t.$2, t.$3, t.$4, t.$5, t.$6 from @my_s3_stage_01 as t;</span></pre><p id="aa16" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">瞧，我们得到了与s3数据文件内容一致的结果。</p><p id="27bf" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这篇博客中，我们看到了如何从snowflake访问和查询存储在S3的数据。</p><p id="59b9" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">雪花快乐！！</p></div></div>    
</body>
</html>