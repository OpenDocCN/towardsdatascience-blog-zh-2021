<html>
<head>
<title>Build Robust Google BigQuery Pipelines with Python: Part III</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python构建健壮的Google BigQuery管道:第三部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-robust-google-bigquery-pipelines-with-python-part-iii-e19c6da566f3?source=collection_archive---------31-----------------------#2021-08-12">https://towardsdatascience.com/build-robust-google-bigquery-pipelines-with-python-part-iii-e19c6da566f3?source=collection_archive---------31-----------------------#2021-08-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="8c65" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">谷歌云平台</h2><div class=""/><div class=""><h2 id="f0e3" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">BigQuery和Google Sheet隐藏的复杂性</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/fb0ef064bd9aad2529a663c57bb87406.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WQAJ-i-JK7tM0KgwbiRHzg.jpeg"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@ashkfor121?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Ashkan Forouzani </a>在<a class="ae le" href="https://unsplash.com/s/photos/jigsaw-puzzle?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="a6f4" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这是关于在Python中与BigQuery交互以构建数据管道的三篇文章系列的第三部分。</p><ul class=""><li id="346c" class="mb mc iq lh b li lj ll lm lo md ls me lw mf ma mg mh mi mj bi translated"><a class="ae le" rel="noopener" target="_blank" href="/build-robust-google-bigquery-pipelines-with-python-part-i-1ac8ca11391a">第一部分:Apache Beam与Google BigQuery API </a></li><li id="88e3" class="mb mc iq lh b li mk ll ml lo mm ls mn lw mo ma mg mh mi mj bi translated"><a class="ae le" rel="noopener" target="_blank" href="/build-robust-google-bigquery-pipelines-with-python-part-ii-2883423a1c8a">第二部分。Python中的big query</a><code class="fe mp mq mr ms b"><a class="ae le" rel="noopener" target="_blank" href="/build-robust-google-bigquery-pipelines-with-python-part-ii-2883423a1c8a">STRUCT</a></code><a class="ae le" rel="noopener" target="_blank" href="/build-robust-google-bigquery-pipelines-with-python-part-ii-2883423a1c8a"/></li><li id="4e3a" class="mb mc iq lh b li mk ll ml lo mm ls mn lw mo ma mg mh mi mj bi translated">第三部分。BigQuery和Google Sheet隐藏的复杂性</li></ul></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="593d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在Spotify，Google Sheet是一款非常受欢迎的办公工具。BigQuery的优势之一是它能够与存储在Google Sheet中的数据进行交互。您可以使用新的BigQuery数据连接器Connected Sheets访问、分析、可视化和共享电子表格中的数十亿行数据。当数据科学家或工程师与不太懂技术的用户合作时，这非常方便。然而，当涉及到Google Sheet时，BigQuery中有一些意想不到的行为，起初它们可能看起来并不直观。本文旨在深入探讨BigQuery中Google Sheet的不同用例，并帮助避免由于这些意外行为而造成的混淆，尤其是在Python管道环境中。</p><h1 id="a8b7" class="na nb iq bd nc nd ne nf ng nh ni nj nk kf nl kg nm ki nn kj no kl np km nq nr bi translated">I .从Google Sheet到BigQuery创建表格</h1><p id="0de9" class="pw-post-body-paragraph lf lg iq lh b li ns ka lk ll nt kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">在这种情况下,“创建表”一词会产生误导，更准确的说法应该是“创建表连接”BigQuery正在建立一个活动连接，而不是将数据集实际导入BigQuery。但是BigQuery console使用这个术语，所以我们现在坚持使用它。</p><p id="01ab" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">以下是从Google Sheet创建表格需要做的工作概述:</p><ol class=""><li id="0ae6" class="mb mc iq lh b li lj ll lm lo md ls me lw mf ma nx mh mi mj bi translated">为<code class="fe mp mq mr ms b">Create table from</code>选择“驱动”</li><li id="dfe6" class="mb mc iq lh b li mk ll ml lo mm ls mn lw mo ma nx mh mi mj bi translated">将URI工作表复制并粘贴到下一个框中</li><li id="d284" class="mb mc iq lh b li mk ll ml lo mm ls mn lw mo ma nx mh mi mj bi translated">为<code class="fe mp mq mr ms b">File format</code>选择谷歌表单</li><li id="7965" class="mb mc iq lh b li mk ll ml lo mm ls mn lw mo ma nx mh mi mj bi translated">记下表的元数据，如项目、数据集和表名。为表定义模式—我建议手动输入模式，因为自动检测并不总是正确的</li><li id="9f8e" class="mb mc iq lh b li mk ll ml lo mm ls mn lw mo ma nx mh mi mj bi translated">定义<code class="fe mp mq mr ms b">Header rows to skip</code>，如果没有标题，则为0，如果有n个标题行要跳过，则为n</li></ol><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ny"><img src="../Images/78793c70d69d511f609421717cac3b16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dQ00UPxiefFVC76QnMrvsA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">从Google工作表创建表格</p></figure><p id="0d11" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">一旦创建了表，您将能够在BigQuery中查询它。然而，一个常见的错误是认为数据现在作为一个单独的副本存储在BigQuery中。事实并非如此。BigQuery在这里所做的仅仅是创建一个到Google Sheet的活动连接，其含义如下:</p><ol class=""><li id="bfb8" class="mb mc iq lh b li lj ll lm lo md ls me lw mf ma nx mh mi mj bi translated">如果在Google Sheet上放置任何过滤器，BigQuery将无法显示整个数据集；Google Sheet中的过滤器实际上会立即反映出来，并影响数据在BigQuery中的外观。因此，如果您想访问BigQuery中的所有数据，请始终对单个视图使用过滤器。</li><li id="2a8d" class="mb mc iq lh b li mk ll ml lo mm ls mn lw mo ma nx mh mi mj bi translated">如果有任何模式更改，如列名更改、列类型更改，则不能在BigQuery中编辑现有模式。删除当前的BigQuery表并重做<code class="fe mp mq mr ms b">Create table</code>过程。</li></ol><h1 id="ac7a" class="na nb iq bd nc nd ne nf ng nh ni nj nk kf nl kg nm ki nn kj no kl np km nq nr bi translated">二。用Python阅读BigQuery Google Sheet数据</h1><p id="203c" class="pw-post-body-paragraph lf lg iq lh b li ns ka lk ll nt kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">如果您尝试使用服务帐户来运行作业，请确保您将服务帐户添加为Google Sheet的编辑器。</p><p id="54bd" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">将Google工作表设置为BigQuery表的最重要步骤是在Python BigQuery API中修改BigQuery客户机的范围。</p><pre class="kp kq kr ks gt nz ms oa ob aw oc bi"><span id="4bb1" class="od nb iq ms b gy oe of l og oh">import pandas as pd<br/>from google.cloud import bigquery</span><span id="da9f" class="od nb iq ms b gy oi of l og oh">scopes = (<br/>    'https://www.googleapis.com/auth/drive',<br/>    'https://www.googleapis.com/auth/drive.file',<br/>    'https://www.googleapis.com/auth/spreadsheets',<br/>)<br/>bigquery.Client.SCOPE += scopes</span><span id="be86" class="od nb iq ms b gy oi of l og oh">client = bigquery.Client()</span></pre><p id="705d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">然后，这里有一行代码将您的查询结果转换成pandas <code class="fe mp mq mr ms b">dataframe</code>。</p><pre class="kp kq kr ks gt nz ms oa ob aw oc bi"><span id="472b" class="od nb iq ms b gy oe of l og oh">gs = client.query("""SELECT * FROM `YOUR_PROJECT.YOUR_DATASET.{table}`""".format(table=table_name)).result().to_dataframe()</span></pre><h1 id="7f32" class="na nb iq bd nc nd ne nf ng nh ni nj nk kf nl kg nm ki nn kj no kl np km nq nr bi translated">三。用Python写Google Sheet</h1><p id="935a" class="pw-post-body-paragraph lf lg iq lh b li ns ka lk ll nt kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">有几个包可以让你用Python写Google Sheet。我将以<code class="fe mp mq mr ms b">pygsheets</code>为例。如果您不打算在管道中运行作业，这个包非常简单。但是，如果您计划在管道中使用包，则需要一个变通方法；出于安全原因，我们不能在我们的云服务器中存储任何服务帐户密钥文件，因此常规功能将不起作用。让我们看看这两个场景中的一些例子。</p><p id="fe1e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">假设您计划为此作业使用服务帐户密钥。这里是服务帐户的快速介绍。</p><blockquote class="oj ok ol"><p id="de76" class="lf lg om lh b li lj ka lk ll lm kd ln on lp lq lr oo lt lu lv op lx ly lz ma ij bi translated">服务帐户是与电子邮件相关联的帐户。该帐户使用一对公钥/私钥进行身份验证，这比其他选项更安全——只要私钥保持私有。— Pysheets</p></blockquote><p id="558d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">要创建服务帐户，请按照下列步骤操作:</p><ol class=""><li id="b1ef" class="mb mc iq lh b li lj ll lm lo md ls me lw mf ma nx mh mi mj bi translated">转到“凭据”选项卡并选择“创建凭据&gt;服务帐户密钥”。</li><li id="8d83" class="mb mc iq lh b li mk ll ml lo mm ls mn lw mo ma nx mh mi mj bi translated">接下来选择服务帐户为“App Engine default ”,密钥类型为JSON，然后单击创建:</li></ol><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/2e84df82aa0362a63dd2268eeb5ff175.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*QX2PB1fuX0Tmm3ffTrEISw.png"/></div></figure><p id="d776" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">3.接下来点击下载按钮下载<code class="fe mp mq mr ms b">client_secret[…].json</code>文件；请务必记住您将它保存为本地<code class="fe mp mq mr ms b">json</code>文件的位置:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi or"><img src="../Images/70d7839c481f00a83de897f5a8c9e45f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WvzrZk6iPyoMQxLSwVZ-ww.png"/></div></div></figure><p id="890f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在我们已经准备好了服务帐户密钥文件，让我们导入所需的包:</p><pre class="kp kq kr ks gt nz ms oa ob aw oc bi"><span id="2436" class="od nb iq ms b gy oe of l og oh">import requests<br/>import json<br/>import pygsheets<br/>import styx_secrets<br/>from google.oauth2 import service_account<br/>from google.cloud import bigquery<br/>import pandas as pd<br/>import numpy as np</span></pre><p id="51a5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">授权过程很简单:</p><pre class="kp kq kr ks gt nz ms oa ob aw oc bi"><span id="42c4" class="od nb iq ms b gy oe of l og oh">gc = pygsheets.authorize(client_secret='path/to/client_secret[...].json')</span></pre><p id="25f8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">然而，如果您有一个管道作业，这个过程会稍微复杂一些，因为我们需要使用一个字典作为我们的解决方法。</p><p id="99ca" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">首先，我们需要加密我们的服务帐户密钥。在Spotify，我们有一个名为<code class="fe mp mq mr ms b">styx-secrets</code>的包用于加密。请注意，为了让<code class="fe mp mq mr ms b">pygsheets</code>识别这个密钥，需要对<code class="fe mp mq mr ms b">utf-8</code>进行解码。</p><pre class="kp kq kr ks gt nz ms oa ob aw oc bi"><span id="1480" class="od nb iq ms b gy oe of l og oh">import styx_secrets</span><span id="6ee6" class="od nb iq ms b gy oi of l og oh">key1 = styx_secrets.decrypt("FIRST_HALF_OF_ENCRYPTED_KEY_STRING").decode("utf-8")<br/>key2 = styx_secrets.decrypt("SECOND_HALF_OF_ENCRYPTED_KEY_STRING").decode("utf-8")</span></pre><p id="0012" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我不得不把密匙分解成两串，因为原来的密匙串太长了，<code class="fe mp mq mr ms b">styx-secrets</code>不接受。</p><p id="9160" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">然后我们可以在一个<code class="fe mp mq mr ms b">dictionary</code>中准备密钥文件，这基本上是<code class="fe mp mq mr ms b">json</code>密钥文件的一个<code class="fe mp mq mr ms b">copy</code>和<code class="fe mp mq mr ms b">paste</code>，除了用你的加密字符串交换真实的密钥(注意解密后还需要做一些格式上的改变):</p><pre class="kp kq kr ks gt nz ms oa ob aw oc bi"><span id="310f" class="od nb iq ms b gy oe of l og oh">sc_key = {<br/>    "type": "service_account",<br/>    "project_id": "YOUR_PROJECT",<br/>    "private_key_id": "YOUR_PRIVATE_KEY_ID",<br/>    "private_key": ("-----BEGIN PRIVATE KEY-----" + key1 + key2 + "-----END PRIVATE KEY-----\n").replace("\\n", "\n"),<br/>    "client_email": "YOUR_SERVICE ACCOUNT_EMAIL",<br/>    "client_id": "SERVICE_ACCOUNT_CLIENT_ID",<br/>    "auth_uri": "https://accounts.google.com/o/oauth2/auth",<br/>    "token_uri": "https://oauth2.googleapis.com/token",<br/>    "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",<br/>    "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/xxxxxxxx"<br/>}</span><span id="7430" class="od nb iq ms b gy oi of l og oh">credentials = service_account.Credentials.from_service_account_info(<br/>    sc_key, <br/>scopes=[<br/>'https://www.googleapis.com/auth/spreadsheets',<br/>'https://www.googleapis.com/auth/drive',<br/>'https://www.googleapis.com/auth/drive.file', ])</span><span id="3401" class="od nb iq ms b gy oi of l og oh">gc = pygsheets.authorize(custom_credentials=credentials)</span></pre><p id="4151" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在我们完成了授权，我们可以玩一玩了！要写入Google工作表，这里有一个例子。</p><p id="30f8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">假设您有一个跟踪管道事件的Google Sheet，这样您的团队就可以轻松地分析数据:</p><pre class="kp kq kr ks gt nz ms oa ob aw oc bi"><span id="f33e" class="od nb iq ms b gy oe of l og oh"># open the google spreadsheet <br/>sh = gc.open('Data Incident Tracker')<br/>            <br/># select the first sheet<br/>wks = sh[0]</span><span id="e984" class="od nb iq ms b gy oi of l og oh"># import previous events<br/>track_prev = client.query("""SELECT * FROM `YOUR_PROJECT.YOUR_DATASET.{table}`""".format(table=table_name)).result().to_dataframe()<br/>            <br/># current event<br/>track_now = [{<br/>'incident_date': date_param,<br/>'num_of_tables': len(missing_list),<br/>'table_list': ', '.join(missing_list),<br/>'alert': True,<br/>'root_cause': root_cause}, ]<br/>            <br/># create new data frame with all incidents<br/>            <br/>tracker_df = pd.concat([track_prev, pd.DataFrame(track_now)])<br/>            <br/># update the first sheet with tracker_df<br/>            <br/>wks.set_dataframe(tracker_df.replace(np.nan, '', regex=True), 'A1')</span></pre><p id="a238" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">最后，请注意，如果您的表中有任何<code class="fe mp mq mr ms b">None</code>值，它们实际上将作为“NaN”字符串上传到Google Sheet中。为了避免这种情况，使用<code class="fe mp mq mr ms b">replace(np.nan, ‘’, regex=True)</code>将它们替换为空字符串，单元格将作为实际的<code class="fe mp mq mr ms b">Null</code>上传到Google工作表中。</p><p id="5b71" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这是Python系列中Google BigQuery的最后一篇文章。我希望它们对你有用。如果您有任何问题，请随时联系我们或发表评论。干杯！</p></div></div>    
</body>
</html>