<html>
<head>
<title>How to Use the STAPLE Algorithm to Combine Multiple Image Segmentations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用STAPLE算法合并多个图像分割</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-the-staple-algorithm-to-combine-multiple-image-segmentations-ce91ebeb451e?source=collection_archive---------15-----------------------#2021-08-04">https://towardsdatascience.com/how-to-use-the-staple-algorithm-to-combine-multiple-image-segmentations-ce91ebeb451e?source=collection_archive---------15-----------------------#2021-08-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="122f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">此代码示例显示了如何对医学图像数据集使用STAPLE算法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/774bdacf4165e843b05e2ffa6c4ff1a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*xDV_UoXyYYvjgLnumVC9Jw.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated"><a class="ae kr" href="https://commons.wikimedia.org/wiki/File:What_To_Draw_Image_1.png" rel="noopener ugc nofollow" target="_blank">例如，Lutz(公共领域)</a></p></figure><p id="d4a9" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">医学图像包含丰富的信息，有助于我们了解患者的健康状况。为了解开这些信息，第一步通常是<em class="lo">分割</em>，或者追踪重要结构。</p><p id="fb64" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">分割是医学图像分析中最重要的步骤，但却经常被忽视。有关分割过程的更多信息，请查看我的<a class="ae kr" rel="noopener" target="_blank" href="/how-to-segment-ct-pancreas-3a390acb3c70">胰腺分割简介</a>。</p><p id="63c9" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">定义地面真相</strong></p><p id="f289" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">医学成像和数据科学领域的研究人员面临的最大挑战之一是，我们如何定义什么是“真正的”分割？</p><p id="133e" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">从表面上看，这似乎是一个简单的问题。我们要求房间里最聪明的人(通常是放射科医生)尽最大努力分割胰腺，这是我们的基本原则，对吗？</p><p id="0f98" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这种方法有几个问题。首先，医生非常忙。让一名放射科专家完成几百次(甚至几十次)扫描是一项艰巨的任务。其次，如果同一个项目有多个放射科医生，我们怎么说哪个是最“专家”的呢？一名放射科专家在结束一天的工作时真的比一名拿着一壶咖啡的医科学生更准确吗？</p><p id="6955" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">顺便说一下，这是人工智能(AI)可以改善放射学的方法之一。研究表明，虽然人工智能模型可能不总是比人类专家更准确，但在大多数情况下，它们更精确，这意味着人工智能每次都会给出相同的预测，而人类专家往往会在他们为一个项目投入的时间和精力上有所不同。</p><p id="efea" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">要是有一种<em class="lo">民主</em>的方式来创造我们的基本事实分割就好了。如果多个示踪剂分割相同的扫描，可能会有个人之间的小错误或差异，但这些错误平均起来会成为比任何单个人的工作更好的决定。</p><p id="46c3" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">输入STAPLE算法，这是我最喜欢的算法之一，也可能是医学成像领域中最有用的代码。</p><p id="e323" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在这篇文章中，我将简要描述STAPLE，并展示一个如何在Python中使用它的例子。</p><p id="cf1f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">装订算法</strong></p><p id="2411" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">STAPLE代表“同步事实和性能水平评估”，由Warwick等人于2004年出版。STAPLE因其完善的理论和易用性而在医学成像领域被广泛接受。</p><p id="e599" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">让我们以我们的<a class="ae kr" rel="noopener" target="_blank" href="/how-to-segment-ct-pancreas-3a390acb3c70]"> CT胰腺分割任务</a>为例。提醒一下，这是通过<a class="ae kr" href="https://wiki.cancerimagingarchive.net/display/Public/Pancreas-CT" rel="noopener ugc nofollow" target="_blank">癌症成像档案馆</a>公开的数据集。假设我们有一个腹部CT扫描，其中胰腺被三位不同的放射科医生分割了三次。胰腺的每个像素都被标记为“1”(胰腺)或“0”(无胰腺)。图1显示了一个放射科医师的分割示例。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lp"><img src="../Images/0caeb4fec4d9fb31250b63b55d7fc9df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JgSM2BV9LJwIx_o25pEH1w.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated"><strong class="bd lu">图一</strong>。三位放射科医生在腹部CT中对胰腺进行分割的示例。蓝色标记为“1”(“胰腺”)。背景(透明)标记为“0”。图片作者。</p></figure><p id="f1f2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">乍一看，所有三个细分可能看起来差不多。但是如果你仔细观察，就会发现它们是不同的。左下的放射科医师有点渴望在整个腹部上绘画(甚至在黑色脂肪组织上绘画)，而右下的放射科医师可能缺少胰腺体的一部分。STAPLE将帮助我们将这些合并成一个跟踪。</p><p id="98e5" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">装订工作原理</strong></p><p id="b412" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">STAPLE是一种加权投票算法。作为第一步，该算法将通过对每个像素的简单投票，将所有三个组合成一个<em class="lo">测试分割</em>。STAPLE将对3名放射科医生的准确性进行评级，并与初始测试分段进行比较。然后，它将根据3名放射科医生的准确性对他们的投票进行加权，从而重新绘制新的第二次测试分割。如果发现放射科医师3的准确率为90%,而放射科医师1和2的准确率仅为30%和40%,则放射科医师3的权重将远远高于其他人。</p><p id="fac3" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">订书钉是一个迭代的过程；这个估计准确度和重新绘制测试分段的循环将会重复，直到测试分段收敛(停止变化)。STAPLE保证在合理的时间长度内收敛，通常运行不超过几秒钟。STAPLE将返回这个最终的测试分段作为“基础事实”。</p><p id="feb7" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这些权重是在每个图像的基础上重新计算的。因此，举例来说，如果一个放射科医师倾向于更准确，但碰巧有一个糟糕的病例，该病例不一定会基于先前的准确性被评级为更高。</p><p id="5e51" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">正如你所料，越多的评分者被用来投票，STAPLE就变得越准确。在10个或12个评价者的情况下，钉书钉产生的分割可以被认为是独立于个人贡献的，这使得它成为估计任何给定评价者的准确性的伟大工具。</p><p id="4017" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">STAPLE适用于两个评定者，但我建议你至少使用三个，因为两个评定者不足以评估评定者的准确性，而准确性是使用STAPLE的核心优势。</p><p id="b17f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">算法的缺点</strong></p><p id="9807" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">STAPLE是一个优秀的算法，也是该领域的黄金标准，但也有一些局限性。首先，因为STAPLE依赖于多数投票，它可能会倾向于<em class="lo">低估</em>你试图追踪的结构的边缘。这可能会夸大“假阳性”率的示踪剂相比，主食结合地面真相。</p><p id="3c11" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">其次，STAPLE是一种简单的投票算法，它没有考虑图像的语义或潜在属性。如果多个示踪剂标记了某个东西，它将在最终版本中显示出来，而不管实际的解剖。当多个追踪器发现随机变化或错误时，这可能会导致小的像素错误(相信我，这种情况会发生)。</p><p id="aec0" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">当使用STAPLE进行多标记分割时，这些问题往往是一致的。在<a class="ae kr" href="https://pubs.rsna.org/doi/full/10.1148/ryai.2020190183" rel="noopener ugc nofollow" target="_blank">我同事的一个标记大脑解剖的出版物</a>中，STAPLE倾向于在相邻结构之间留下小间隙，没有考虑到大脑是连续的这一事实。这导致了订书钉分割，虽然在技术上是准确的，但看起来与用于生成它的分割非常不同。</p><p id="447e" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">因此，对你的基本事实进行一些后处理可能是合适的。例如，您可以选择只保留给定类的最大的单个结构，排除小的像素错误。或者，您可以选择定义一个“背景”类来填补任何空白。例如，在腹部器官分割中，我们将“脂肪”定义为背景，因此器官中的任何间隙都将被填充(这通常与实际情况非常接近)。</p><p id="5337" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">只是一定要在你的期末论文中报告这样的后处理步骤，这样其他人就可以从你的共享知识中学习了！</p><p id="c135" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">使用装订的例子</strong></p><p id="5ee6" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在Python中，STAPLE可以通过<a class="ae kr" href="https://simpleitk.org/" rel="noopener ugc nofollow" target="_blank"> SimpleITK </a>获得。下面的代码片段说明了如何使用STAPLE来组合三个分段。我用的是SimpleITK版本2.1.0和Python 3.7.8。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lv lw l"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">例1。使用STAPLE将三个分段合并成一个单一的基本事实</p></figure><p id="a6ff" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在我们继续之前，对这个简单的ITK实现做一些快速的注释，它可能很挑剔。</p><ol class=""><li id="ef6e" class="lx ly iq ku b kv kw ky kz lb lz lf ma lj mb ln mc md me mf bi translated">SimpleITK要求输入数组是整数，可以是int16、int32或int64。这些数组必须都转换为相同的类型</li><li id="5802" class="lx ly iq ku b kv mg ky mh lb mi lf mj lj mk ln mc md me mf bi translated">STAPLE一次只能在一个类上运行。类别标签被定义为“前景值”(第二个运算符)，所有其他像素被视为背景。</li><li id="c580" class="lx ly iq ku b kv mg ky mh lb mi lf mj lj mk ln mc md me mf bi translated">对于多类分段，您必须对每个类单独运行STAPLE，然后将它们重新组合成一个数组，这是包的一个限制。</li></ol><p id="dfe9" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在我们已经生成了我们的主要部分，我们可以使用matplotlib与我们的三位评分者并排绘制它:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lv lw l"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">例2。使用matplotlib绘制我们的主食分割</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi ml"><img src="../Images/c131a48c2c3c63890f0d2fab591a3ef8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sf6fS122SyZAT2en4IBfIw.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">图二。使用STAPLE将3个胰腺分段合并为一个单一的基本事实的示例(最左侧)。作者图片</p></figure><p id="10c5" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如果你眯着眼睛，你可以分辨出我们的示踪剂和主要的地面事实之间的差异，但是很难看到。让我们强调一下每个评分者和订书钉之间的区别:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lv lw l"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">例3。绘制每位评定者与主要评定者之间的差异</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi mm"><img src="../Images/83d6e9348e2431f402c03b813ba99e6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YPnxdYFM_JZ-ZWbSfQ3Dxw.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">图3。每个评分者和订书钉之间的重叠(真阳性)以红色显示。差异用浅蓝色表示。作者图片</p></figure><p id="2e8f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在这里，差异非常明显。在胰腺的边缘有一点变化，但最大的不同是STAPLE能够纠正评分员2在分割胰腺体时犯的一个错误。</p><p id="3d8b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">总结</strong></p><p id="964c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在本教程中，我介绍了STAPLE算法，并展示了如何将来自多个跟踪器的简单分段组合成一个单一的基本事实。</p><p id="c19a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">本教程展示了一个简单的例子，但是STAPLE也适用于大型任务。在一个项目中，我们在一个由35个器官组成的数据集上使用了它，涉及17个评分者。除了评分者之间的可靠性，这也是我结合集合预测的首选方法，我用它结合了多达10个模型的输出。</p><p id="7109" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">希望这篇文章有所帮助！如有问题，欢迎评论，我会尽力解答。</p><p id="4182" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><strong class="ku ir">其他链接</strong></p><p id="e984" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">【https://nipy.org/nibabel/】T4—链接到Nibabel包，用于读/写NIFTI文件</p><p id="a274" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><a class="ae kr" href="https://simpleitk.org/" rel="noopener ugc nofollow" target="_blank">https://simpleitk.org/</a>—链接到STAPLE的SimpleITK实现</p><p id="d4c2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated"><a class="ae kr" href="http://pypi.org/projects/staple" rel="noopener ugc nofollow" target="_blank">Pypi.org/project/staple</a>——我在研究本文时发现的另一个STAPLE实现</p><p id="b3db" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">关于使用SimpleITK进行分段的更深入的教程—</p><div class="mn mo gp gr mp mq"><a href="http://insightsoftwareconsortium.github.io/SimpleITK-Notebooks/Python_html/34_Segmentation_Evaluation.html" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd ir gy z fp mv fr fs mw fu fw ip bi translated">34 _细分_评估</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">评估分割算法最常用的方法是使用参考数据来比较结果。在…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">insight software consortium . github . io</p></div></div></div></a></div><p id="361a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">链接到我其他一些关于医学成像的文章—</p><div class="mn mo gp gr mp mq"><a rel="noopener follow" target="_blank" href="/understanding-dicom-bce665e62b72"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd ir gy z fp mv fr fs mw fu fw ip bi translated">了解DICOM</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">如何阅读、书写和组织医学图像</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">towardsdatascience.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne kl mq"/></div></div></a></div><div class="mn mo gp gr mp mq"><a rel="noopener follow" target="_blank" href="/a-python-script-to-sort-dicom-files-f1623a7f40b8"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd ir gy z fp mv fr fs mw fu fw ip bi translated">对DICOM文件进行排序的Python脚本</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">这个脚本将帮助您理解和组织您的医学图像数据集</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">towardsdatascience.com</p></div></div><div class="mz l"><div class="nf l nb nc nd mz ne kl mq"/></div></div></a></div></div></div>    
</body>
</html>