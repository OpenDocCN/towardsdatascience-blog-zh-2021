<html>
<head>
<title>How to Upload Files to Google Drive using Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Airflow将文件上传到Google Drive</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-upload-files-to-google-drive-using-airflow-73d961bbd22?source=collection_archive---------10-----------------------#2021-03-25">https://towardsdatascience.com/how-to-upload-files-to-google-drive-using-airflow-73d961bbd22?source=collection_archive---------10-----------------------#2021-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3135" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">开发自定义GoogleDriveOperator</h2></div><p id="864f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi lb translated"><span class="l lc ld le bm lf lg lh li lj di">一个可以自动化的常见有用操作是将文档定期上传到Google Drive文件夹。例如，这可以是每月上传一次销售数据的Excel分析，以便与团队共享。</span></p><p id="f544" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Airflow provider package <code class="fe lk ll lm ln b">apache-airflow-providers-google</code>提供了允许与GCP上的谷歌服务轻松集成的组件。但是，它没有直接提供一个操作者直接上传一个本地文件到Google Drive。这就是为什么在本文中，我们将学习如何构建我们自己的气流操作符来实现这一点。</p><p id="1c24" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将分四个连续的步骤来完成这项工作:</p><ol class=""><li id="d401" class="lo lp iq kh b ki kj kl km ko lq ks lr kw ls la lt lu lv lw bi translated">在GCP上配置Google Drive API和创建服务帐户</li><li id="3b51" class="lo lp iq kh b ki lx kl ly ko lz ks ma kw mb la lt lu lv lw bi translated">在我们的Google Workspace上配置全域委托</li><li id="9108" class="lo lp iq kh b ki lx kl ly ko lz ks ma kw mb la lt lu lv lw bi translated">为我们的自定义GoogleDriveOperator编写代码</li><li id="0e7f" class="lo lp iq kh b ki lx kl ly ko lz ks ma kw mb la lt lu lv lw bi translated">测试一个最小的DAG上传一个文本文件到我们的Google Drive账户</li></ol><p id="61be" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">按照这些步骤，我们需要:</p><ul class=""><li id="8198" class="lo lp iq kh b ki kj kl km ko lq ks lr kw ls la mc lu lv lw bi translated">一个对GCP和它所属的谷歌工作区有管理权限的谷歌帐户</li><li id="c5f2" class="lo lp iq kh b ki lx kl ly ko lz ks ma kw mb la mc lu lv lw bi translated">气流2.0.x安装</li></ul><p id="dd81" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在Docker上创建了一个<a class="ae md" href="https://github.com/gontcharovd/google-drive-operator" rel="noopener ugc nofollow" target="_blank">公共GitHub repo </a>和一个Airflow安装以及本文中的所有代码。克隆项目并用<code class="fe lk ll lm ln b">docker-compose run</code>启动它。</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h1 id="a4ef" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">1.在GCP上配置Google Drive API和创建服务帐户</h1><p id="2d12" class="pw-post-body-paragraph kf kg iq kh b ki nd jr kk kl ne ju kn ko nf kq kr ks ng ku kv kw nh ky kz la ij bi translated">Airflow通过Google云平台上的Google Drive API将文件上传到Google Drive。</p><p id="6c05" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">转到<a class="ae md" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"><em class="ni">https://cloud.google.com/</em></a>并点击<strong class="kh ir">控制台</strong>。接受条件。迎接我们的是下面的仪表板(可能会因您的组织而有所不同)。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi nj"><img src="../Images/3fb211dd708c435a41512aea8f245a3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wGfmkIT9hVM6U91V5UhBhA.png"/></div></div></figure></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h2 id="f889" class="nv mm iq bd mn nw nx dn mr ny nz dp mv ko oa ob mx ks oc od mz kw oe of nb og bi translated">创建新的GCP项目</h2><p id="ae33" class="pw-post-body-paragraph kf kg iq kh b ki nd jr kk kl ne ju kn ko nf kq kr ks ng ku kv kw nh ky kz la ij bi translated">我们将创建一个新的GCP项目致力于这一功能。点击<strong class="kh ir">选择一个项目</strong>，然后点击<strong class="kh ir">新建项目</strong>。姑且称之为“气流驱动”。选择项目，使名称显示在顶部栏中。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi oh"><img src="../Images/7fe55c4dcb7560ae5a67ca1f57ae095d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s65irSjJ5rXyGgBke_RJQQ.png"/></div></div></figure><h2 id="9279" class="nv mm iq bd mn nw nx dn mr ny nz dp mv ko oa ob mx ks oc od mz kw oe of nb og bi translated">启用Google Drive API</h2><p id="bd62" class="pw-post-body-paragraph kf kg iq kh b ki nd jr kk kl ne ju kn ko nf kq kr ks ng ku kv kw nh ky kz la ij bi translated">既然项目已经设置好了，我们可以启用Google Drive API了。在页面顶部的搜索栏中搜索“Google Drive API”并选择第一个搜索结果。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi oi"><img src="../Images/bf796c4b1ebfccba2330ab5b32e432cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V2NbkovpWb0hcSLy9sWguw.png"/></div></div></figure><p id="5fbf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">点击<strong class="kh ir">启用</strong>启用Google Drive API。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi oj"><img src="../Images/13c6171bcacb6f35e31b99f345c793d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tcGVsW8FYIwmMV4zh93aQQ.png"/></div></div></figure></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h2 id="f639" class="nv mm iq bd mn nw nx dn mr ny nz dp mv ko oa ob mx ks oc od mz kw oe of nb og bi translated">创建服务帐户</h2><p id="a41b" class="pw-post-body-paragraph kf kg iq kh b ki nd jr kk kl ne ju kn ko nf kq kr ks ng ku kv kw nh ky kz la ij bi translated">Airflow将使用一个Google服务帐户来验证Google Drive API。服务帐户是一种特殊类型的Google帐户，代表非人类用户。</p><p id="1169" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从菜单进入<strong class="kh ir">API&amp;服务</strong>并选择<strong class="kh ir">服务账户</strong>。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi ok"><img src="../Images/53360ab1ddc7a0d383eabefede45f8d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N0BUp46k4wvYHv_Lv2KoBA.png"/></div></div></figure><p id="0aae" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">目前此项目中没有服务帐户。点击<strong class="kh ir">创建服务账户</strong>创建一个。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi ol"><img src="../Images/aba179a5faaf1e06565634cae95d679e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VEI5A_sqt85r8BFu8eAPfw.png"/></div></div></figure><p id="97cf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们将服务帐户命名为与项目“气流驱动”相同的名称。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi om"><img src="../Images/b273f2d078febb0c9892e37027575bd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dQ23wEqd5F5ZY-B0MKx-0Q.png"/></div></div></figure><p id="14ca" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">授予服务帐户此项目的<strong class="kh ir">所有者</strong>角色。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi on"><img src="../Images/af7d6fd034553dfc952cdd6c9714fb4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qm9AvtJvU8NNCgfdkvBbXg.png"/></div></div></figure><p id="4f25" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">点击<strong class="kh ir">完成</strong>。服务帐户现在可见。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi oo"><img src="../Images/ccc5edbda5d44329af0478cbec15cf9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mwho1vw3E5nsOFJXU9oACA.png"/></div></div></figure><p id="98f4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们有了服务帐户，我们创建一个包含其凭证的keyfile JSON。Airflow将使用这些凭证来验证Google Drive API。转到<strong class="kh ir">键</strong>选项卡，点击<strong class="kh ir">添加键</strong>。选择<strong class="kh ir">创建新密钥</strong>并选择JSON格式。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi op"><img src="../Images/24bbb43e3b4718951d5009bf2a18744e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VGBVxa86sMU1FJUsUFLd0A.png"/></div></div></figure><p id="b85b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您正在使用提供的<a class="ae md" href="https://github.com/gontcharovd/google-drive-operator" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>，请将JSON密钥文件保存在<code class="fe lk ll lm ln b">docker/</code>目录中。<strong class="kh ir">确保将它的路径添加到。gitignore这样你就不会不小心把你的keyfile推给GitHub了。不要与任何人共享此密钥！</strong></p><figure class="nk nl nm nn gt no"><div class="bz fp l di"><div class="oq or l"/></div></figure></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h2 id="8c37" class="nv mm iq bd mn nw nx dn mr ny nz dp mv ko oa ob mx ks oc od mz kw oe of nb og bi translated">启用全域性委派</h2><p id="4980" class="pw-post-body-paragraph kf kg iq kh b ki nd jr kk kl ne ju kn ko nf kq kr ks ng ku kv kw nh ky kz la ij bi translated">全域委托允许一个服务帐户在Google Workspace内代表另一个用户执行操作。这很重要，因为由服务帐户<a class="ae md" href="https://forum.rclone.org/t/service-account-not-allowing-to-see-files-and-folders/12527" rel="noopener ugc nofollow" target="_blank">创建或上传的文件对于其他用户来说是不可见的</a>。通过为我们的服务帐户启用域范围的委托，我们将能够以我们自己的Google帐户的名义上传文件，以便可以直接访问上传的文件。</p><p id="5e46" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">转到菜单中的<strong class="kh ir">服务账户</strong>并点击服务账户的电子邮件。这将打开一个页面，显示服务帐户的唯一ID。请记下这个数字，因为我们在配置Google Workspace时会用到它。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi os"><img src="../Images/bc4fbeb1d68d796bbf9d165aed02872a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Znq1-YOSbGLRqR67LxO7Ww.png"/></div></div></figure><p id="7040" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">展开“全域委托”下的部分。选中显示<strong class="kh ir">启用G Suite全域委托</strong>的复选框。我们可以输入“airflow.to.drive”作为同意屏幕的产品名称。这个名称并不重要，因为我们不会使用这个特性。点击<strong class="kh ir">保存</strong>。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi ot"><img src="../Images/43f61babc373126c4a7ca3f4e9b72cd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KWdc9h6Eufg4xwvt0prJ_A.png"/></div></div></figure><p id="126c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">GCP配置现在完成了！</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h1 id="95b1" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">2.在我们的Google Workspace上配置全域委托</h1><p id="a602" class="pw-post-body-paragraph kf kg iq kh b ki nd jr kk kl ne ju kn ko nf kq kr ks ng ku kv kw nh ky kz la ij bi translated">接下来，我们必须通过我们的Google Workspace为服务帐户授权域范围的委托。前往<a class="ae md" href="https://myaccount.google.com/" rel="noopener ugc nofollow" target="_blank"><em class="ni">https://myaccount.google.com/</em></a>。点击右上角的<strong class="kh ir">管理控制台</strong>。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi ou"><img src="../Images/c333dc8698f81b9111c02d18f7129d0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0KqPNi0zsgh4YZal7rka8Q.png"/></div></div></figure><p id="38da" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">转到<strong class="kh ir">安全</strong>，然后转到<strong class="kh ir">设置</strong>。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi ov"><img src="../Images/0736046fed3cb9ea3bce3959f66bbd0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9N2y7NBnO-iwcsd52OZBgw.png"/></div></div></figure><p id="0a51" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在列表底部，打开<strong class="kh ir"> API控件</strong>部分。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi ow"><img src="../Images/5107b669b286cd15535aeee8c7ec5ad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RUZ4PgVRHmrccpZRE-eXjQ.png"/></div></div></figure><p id="ab9d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">找到关于全域授权的部分，并点击<strong class="kh ir">管理全域授权</strong>。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi ox"><img src="../Images/377cfd162e89e4a5cb07df88f8291c1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*11862EoX67_6JmsJRUsaqw.png"/></div></div></figure><p id="416d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">目前，没有条目。点击<strong class="kh ir">添加新的</strong>。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi oy"><img src="../Images/ef9ffa3870fad0a68a12a4dd4f722146.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nYWijJgEyAzyW9gUdZhjKA.png"/></div></div></figure><p id="b2b9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">填写我们在上一部分中记录的服务帐户的唯一客户端ID，并添加以下范围:<a class="ae md" href="https://www.googleapis.com/auth/drive" rel="noopener ugc nofollow" target="_blank"><em class="ni">https://www.googleapis.com/auth/drive</em></a>。这将授予具有该特定客户端ID的服务帐户对Google Drive的完全访问权限。点击<strong class="kh ir">授权</strong>。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi oz"><img src="../Images/404a38b7864088d5278eb2ac1ba34dbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N6eSTIMMKYRvdeuKH182_A.png"/></div></div></figure><p id="92de" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">服务帐户现在被授权以Google Workspace中任何用户的名义将文件上传到Google Drive。</p><p id="f9a2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Google Workspace现在已经配置好了！</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h1 id="99ce" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">3.为我们的自定义GoogleDriveOperator编写代码</h1><p id="3fc4" class="pw-post-body-paragraph kf kg iq kh b ki nd jr kk kl ne ju kn ko nf kq kr ks ng ku kv kw nh ky kz la ij bi translated">在这一部分中，我们将查看自定义气流操作符的Python代码。</p><p id="f39a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">像所有气流操作符一样，我们的GoogleDriveOperator继承自气流BaseOperator类。上传本身是由<code class="fe lk ll lm ln b">apache-airflow-providers-google</code>包提供的GoogleDriveHook执行的。操作符接受我们想要上传的本地文件的路径、Google Drive上的目标文件夹以及GoogleDriveHook所需的一些参数。如果参数<code class="fe lk ll lm ln b">delete</code>设置为<code class="fe lk ll lm ln b">True</code>，上传成功后本地文件被删除。将该文件放在<code class="fe lk ll lm ln b">plugins/</code>文件夹中，以便它可以很容易地导入DAG模块。</p><figure class="nk nl nm nn gt no"><div class="bz fp l di"><div class="oq or l"/></div></figure></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h1 id="2144" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">示例DAG</h1><p id="22cd" class="pw-post-body-paragraph kf kg iq kh b ki nd jr kk kl ne ju kn ko nf kq kr ks ng ku kv kw nh ky kz la ij bi translated">现在一切都设置好了，我们可以测试GoogleDriveOperator并将一些文件上传到我们的个人Google Drive。</p><p id="eed1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们编写一个包含两个任务的最小每日DAG:</p><ol class=""><li id="9f89" class="lo lp iq kh b ki kj kl km ko lq ks lr kw ls la lt lu lv lw bi translated">使用BashOperator在<code class="fe lk ll lm ln b">$AIRFLOW_HOME</code>的<code class="fe lk ll lm ln b">tmp/</code>文件夹中创建一个包含当前日期的文本文件</li><li id="f34a" class="lo lp iq kh b ki lx kl ly ko lz ks ma kw mb la lt lu lv lw bi translated">使用GoogleDriveOperator将此文件上传到Google Drive上的指定文件夹</li></ol><figure class="nk nl nm nn gt no"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="16d9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此DAG将从2021年2月10日到2021年2月13日每天执行。每天都用内容<code class="fe lk ll lm ln b">file created on 2021-02-10</code>创建一个文件，例如<code class="fe lk ll lm ln b">my_file_2021-02-10.txt</code>。然后，这个文件被上传到我们谷歌账户的根目录下的文件夹<code class="fe lk ll lm ln b">google-drive-operator</code>。请注意，<code class="fe lk ll lm ln b">delegate_to</code>参数指定了服务帐户将上传委托给的电子邮件地址。该Google帐户将成为上传文件的所有者。</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h2 id="274a" class="nv mm iq bd mn nw nx dn mr ny nz dp mv ko oa ob mx ks oc od mz kw oe of nb og bi translated">创建气流连接</h2><p id="bbad" class="pw-post-body-paragraph kf kg iq kh b ki nd jr kk kl ne ju kn ko nf kq kr ks ng ku kv kw nh ky kz la ij bi translated">还有最后一件事要做:我们必须创建由任务<code class="fe lk ll lm ln b">upload_file</code>中的<code class="fe lk ll lm ln b">gcp_conn_id</code>指定的<a class="ae md" href="https://airflow.apache.org/docs/apache-airflow/stable/howto/connection.html" rel="noopener ugc nofollow" target="_blank">气流连接</a>。启动Airflow网络服务器，并转到<strong class="kh ir">管理</strong>选项卡。打开<strong class="kh ir">连接</strong>，用以下字段创建一个新连接:</p><ul class=""><li id="79bd" class="lo lp iq kh b ki kj kl km ko lq ks lr kw ls la mc lu lv lw bi translated">连接标识:gcp_conn_id</li><li id="29dd" class="lo lp iq kh b ki lx kl ly ko lz ks ma kw mb la mc lu lv lw bi translated">连接类型:谷歌云</li><li id="4187" class="lo lp iq kh b ki lx kl ly ko lz ks ma kw mb la mc lu lv lw bi translated">Keyfile路径:<em class="ni"> /opt/airflow/ &lt; &lt;您的JSON keyfile名称&gt; &gt; &gt;。json ( </em>或者，我们可以将这个JSON keyfile的内容粘贴到Keyfile JSON字段中)</li><li id="a936" class="lo lp iq kh b ki lx kl ly ko lz ks ma kw mb la mc lu lv lw bi translated">项目Id:驱动气流</li><li id="efc9" class="lo lp iq kh b ki lx kl ly ko lz ks ma kw mb la mc lu lv lw bi translated">范围:<a class="ae md" href="https://www.googleapis.com/auth/drive" rel="noopener ugc nofollow" target="_blank"><em class="ni">https://www.googleapis.com/auth/drive</em></a></li></ul><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi pa"><img src="../Images/f1f5cb99202718cb641117af06756d53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jnXwygRtc1QzNhe40C9y5g.png"/></div></div></figure></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h2 id="6521" class="nv mm iq bd mn nw nx dn mr ny nz dp mv ko oa ob mx ks oc od mz kw oe of nb og bi translated">运行DAG</h2><p id="6c29" class="pw-post-body-paragraph kf kg iq kh b ki nd jr kk kl ne ju kn ko nf kq kr ks ng ku kv kw nh ky kz la ij bi translated">返回到<strong class="kh ir">DAG</strong>部分并激活DAG。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi pb"><img src="../Images/b990aa1bb7931bb5b3d7cd5b2533833b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uAPhXOmWGjxmn00NkWt2fQ.png"/></div></div></figure><p id="9aab" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">执行之后，可以在我们的Google Drive文件夹中看到文本文件。</p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi pc"><img src="../Images/1f1307f274a21b5e9d6057bb15548df3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SgqPT6K8GrSS3zB4f7ifrw.png"/></div></div></figure><p id="3031" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，由于域范围的委托，文件的<strong class="kh ir">所有者</strong>是“我”。如果<code class="fe lk ll lm ln b">google-drive-operator</code>是一个共享文件夹，任何被授权的人都可以访问这些文件。</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><p id="c37d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ni">我希望你喜欢我这篇关于气流和Google Drive的文章。欢迎在评论中分享任何有趣的用例或问题！</em></p><figure class="nk nl nm nn gt no gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi pd"><img src="../Images/9ca121d763d1ac0fb72ea4c290bc5c31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tdDD0qYF4R2F4tS4C_ifyw.jpeg"/></div></div><p class="pe pf gj gh gi pg ph bd b be z dk translated"><a class="ae md" href="https://unsplash.com/@mihaisurdu?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">米海·苏尔杜</a>在<a class="ae md" href="https://unsplash.com/s/photos/air?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure></div></div>    
</body>
</html>