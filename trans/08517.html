<html>
<head>
<title>Automated Machine Learning with H2O</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">H2O的自动机器学习</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automated-machine-learning-with-h2o-258a2f3a203f?source=collection_archive---------6-----------------------#2021-08-06">https://towardsdatascience.com/automated-machine-learning-with-h2o-258a2f3a203f?source=collection_archive---------6-----------------------#2021-08-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3480" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">加速您的机器学习开发周期</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/07a7c532643e2d5488ccbff96334884a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NK6KiGQsQ9_AZBGe"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@possessedphotography?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">拥有摄影</a>的照片在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上</p></figure><h1 id="775e" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">什么是自动ML？</h1><p id="c3a5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">自动机器学习(AutoML)是机器学习管道中自动化任务的过程，例如数据预处理、超参数调整、模型选择和评估。在本文中，我们将探讨如何利用H2O的开源自动化机器学习包来加速数据科学家的模型开发过程。</p><h1 id="5d81" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">设置</h1><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="aabc" class="mp kx iq ml b gy mq mr l ms mt">pip install h2o</span></pre><p id="3785" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">让我们导入必要的包</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="9a36" class="mp kx iq ml b gy mq mr l ms mt">import h2o<br/>from h2o.automl import H2OAutoML</span></pre><p id="7380" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">初始化H2O集群。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="40ca" class="mp kx iq ml b gy mq mr l ms mt">h2o.init()</span></pre><h1 id="82d3" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">数据准备</h1><p id="dfae" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们将使用来自UCI的数据集，该数据集描述了一家银行向客户提供定期存款的营销活动。如果客户同意，目标变量为<code class="fe mz na nb ml b">yes</code>，如果客户决定不进行定期存款，目标变量为<code class="fe mz na nb ml b">no</code>。</p><p id="35de" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">将数据集作为<code class="fe mz na nb ml b">H2OFrame</code>加载</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="2704" class="mp kx iq ml b gy mq mr l ms mt">df = h2o.import_file(path='/kaggle/input/bank-marketing-campaigns-dataset/bank-additional-full.csv')</span></pre><p id="0d02" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">描述数据集。H2O提供了10行样本数据以及数字列的基本汇总统计数据。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="9f73" class="mp kx iq ml b gy mq mr l ms mt">df.describe(chunk_summary=True)</span></pre><p id="651e" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">将数据集分为训练集和测试集</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="6c0f" class="mp kx iq ml b gy mq mr l ms mt">train, test = df.split_frame(ratios=[0.8], seed = 1)</span></pre><h1 id="5186" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">火车汽车模型</h1><p id="4f15" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们配置AutoML训练参数。</p><ul class=""><li id="4991" class="nc nd iq lq b lr mu lu mv lx ne mb nf mf ng mj nh ni nj nk bi translated"><code class="fe mz na nb ml b">max_models</code>:训练模型的最大数量</li><li id="3a10" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated"><code class="fe mz na nb ml b">balance_classes</code>:设置为<code class="fe mz na nb ml b">True</code>，平衡数据不平衡任务的分类标签</li><li id="750b" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated"><code class="fe mz na nb ml b">seed</code>:设定再现性</li></ul><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="1ffe" class="mp kx iq ml b gy mq mr l ms mt">aml = H2OAutoML(max_models =25,<br/>                balance_classes=True,<br/>		seed =1)</span></pre><p id="89df" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">我们可以通过限制以下各项来限制搜索最佳模型所花费的时间:</p><ul class=""><li id="2ab9" class="nc nd iq lq b lr mu lu mv lx ne mb nf mf ng mj nh ni nj nk bi translated">使用<code class="fe mz na nb ml b">max_models</code>的最大型号数量</li><li id="c00b" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated">使用<code class="fe mz na nb ml b">max_runtime_secs</code>花费的总时间</li><li id="2abe" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated">使用<code class="fe mz na nb ml b">max_runtime_secs_per_model</code>训练任何单一模型所花费的时间。</li></ul><p id="063c" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">通过指定以下内容开始培训:</p><ul class=""><li id="23ae" class="nc nd iq lq b lr mu lu mv lx ne mb nf mf ng mj nh ni nj nk bi translated"><code class="fe mz na nb ml b">training_frame</code>:包含训练数据的数据帧</li><li id="b24f" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated"><code class="fe mz na nb ml b">y</code>:包含目标变量的<code class="fe mz na nb ml b">training_frame</code>中的列</li></ul><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="32f3" class="mp kx iq ml b gy mq mr l ms mt">aml.train(training_frame = train, y = 'y')</span></pre><p id="596d" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">此外，我们还可以指定<code class="fe mz na nb ml b">validation_frame</code>，这是一个H2OFrame，模型在训练过程中根据它进行评估。如果未设置此参数，将使用k重交叉验证来评估模型。其他可选参数参考<a class="ae kv" href="https://docs.h2o.ai/h2o/latest-stable/h2o-docs/automl.html#optional-data-parameters" rel="noopener ugc nofollow" target="_blank">文件</a>。</p><p id="d255" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">那么引擎盖下发生了什么呢？</p><p id="0300" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">H2O汽车公司按以下顺序训练和交叉验证以下模型:</p><ol class=""><li id="95db" class="nc nd iq lq b lr mu lu mv lx ne mb nf mf ng mj nq ni nj nk bi translated">三个预先指定的XGBoost GBM(梯度增压机)型号</li><li id="3c96" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nq ni nj nk bi translated">GLMs的固定网格</li><li id="2158" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nq ni nj nk bi translated">默认随机森林(DRF)</li><li id="9592" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nq ni nj nk bi translated">五个预先指定的H2O GBM</li><li id="5817" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nq ni nj nk bi translated">一种近似默认的深度神经网络</li><li id="1316" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nq ni nj nk bi translated">极度随机的森林(XRT)</li><li id="05ed" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nq ni nj nk bi translated">XGBoost GBMs的随机网格</li><li id="66f4" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nq ni nj nk bi translated">H2O GBM的随机网格</li><li id="bafb" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nq ni nj nk bi translated">深度神经网络的随机网格</li></ol><p id="92a7" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">此外，它还培训:</p><ol class=""><li id="4059" class="nc nd iq lq b lr mu lu mv lx ne mb nf mf ng mj nq ni nj nk bi translated">上面训练的所有模型的堆叠集合</li><li id="49fd" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nq ni nj nk bi translated">包含每个算法类的最佳执行模型的“最佳系列”堆叠集成</li></ol><h1 id="b207" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">估价</h1><p id="1c1d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">训练完模型后，我们可以使用排行榜来比较模型性能。H2O汽车公司制作了一个排行榜，根据预定义的指标对训练好的模型进行排名。默认情况下，它按照logloss和rmse的升序对模型进行排序，分别用于分类和回归任务。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="a5e9" class="mp kx iq ml b gy mq mr l ms mt">lb = aml.leaderboard<br/>lb.head(rows=lb.nrows)</span></pre><p id="089b" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">排行榜指标是根据交叉验证集计算的，除非在培训期间指定了<code class="fe mz na nb ml b">leaderboard_frame</code>。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="3ea6" class="mp kx iq ml b gy mq mr l ms mt">aml.train(training_frame = train,<br/>          y = 'y',<br/>	  leaderboard_frame = my_leaderboard_frame)</span></pre><p id="dec4" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">在分类任务的典型机器学习评估中，我们将有兴趣了解最佳性能模型的性能，如ROC AUC、精确度、召回率、F1、精确度、增益/提升和交叉验证数据集上的混淆度量。H2O只用两行代码就提供了所有这些指标。</p><p id="067f" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">让我们得到性能最好的模型，并检查其结果。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="37a8" class="mp kx iq ml b gy mq mr l ms mt">best_model = aml.get_best_model()<br/>print(best_model)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/97e790af538375a1d684175ea057ca94.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*xwRxbn3_RKDs6TC6KMk9GQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">交叉验证数据中报告的通用指标</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/dca929239fb3fc9c62cd07b51abe2df0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*Y0fuFByQ4sJ_znir376f5g.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">混淆矩阵和度量在各自的最大阈值</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/31cc6b93757a1d9b34130626e5e3dfc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2VZ5cM5V01pS1MIj-LhiuA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">增益/提升图表</p></figure><p id="9f93" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">我们还可以使用上面显示的相同评估指标来评估维持测试集上的最佳模型。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="a582" class="mp kx iq ml b gy mq mr l ms mt">best_model.model_performance(test)</span></pre><h1 id="907a" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">保存、加载和预测</h1><p id="b8b0" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们保存一个二进制模型</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="66c6" class="mp kx iq ml b gy mq mr l ms mt">model_path = h2o.save_model(model=best_model,path='/kaggle/working/model', force=True)</span><span id="bb41" class="mp kx iq ml b gy nu mr l ms mt">print(model_path)</span><span id="396f" class="mp kx iq ml b gy nu mr l ms mt">&gt;&gt; /kaggle/working/model/StackedEnsemble_AllModels_AutoML_20210803_232409</span></pre><p id="1fdd" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">保存的二进制模型可以加载到不同的笔记本中，并用于在测试集上进行预测。注意，用于训练保存的二进制模型的H2O版本必须与我们的推理环境中使用的版本相同。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="2de1" class="mp kx iq ml b gy mq mr l ms mt">import h2o #must be same version used during training of the model</span><span id="6df3" class="mp kx iq ml b gy nu mr l ms mt">h2o.init()</span><span id="4c96" class="mp kx iq ml b gy nu mr l ms mt">loaded_model = h2o.load_model(path='/kaggle/working/model/StackedEnsemble_AllModels_AutoML_20210803_232409')<br/>loaded_model.predict(test)</span></pre><h1 id="17b0" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">可解释性</h1><p id="487e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">H2O AutoML还提供了模型的全局可解释性的见解，如变量重要性，部分依赖图，SHAP值和模型相关性，只有一行代码</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="1435" class="mp kx iq ml b gy mq mr l ms mt">explain_model = aml.explain(frame = test, figsize = (8,6))</span></pre><p id="967d" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">此外，它还为单个记录提供了本地可解释性。我们可以在<code class="fe mz na nb ml b">frame</code>参数中输入一个<code class="fe mz na nb ml b">H2OFrame</code>，并指出我们希望使用<code class="fe mz na nb ml b">row_index</code>参数来解释哪一行。在这种情况下，我们解释测试帧的第15行的结果。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="94a2" class="mp kx iq ml b gy mq mr l ms mt">aml.explain_row(frame = test, row_index = 15, figsize = (8,6))</span></pre><h1 id="d6b0" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="eac8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在本文中，我们研究了如何使用H2O汽车公司:</p><ul class=""><li id="4b4f" class="nc nd iq lq b lr mu lu mv lx ne mb nf mf ng mj nh ni nj nk bi translated">描述数据集</li><li id="82c2" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated">用最少的人工输入训练模型</li><li id="be3c" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated">根据训练好的模型进行预测</li><li id="ab6b" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated">解释模型的预测</li></ul><p id="171a" class="pw-post-body-paragraph lo lp iq lq b lr mu jr lt lu mv ju lw lx mw lz ma mb mx md me mf my mh mi mj ij bi translated">您可以在此处找到用于训练和推理的笔记本:</p><ul class=""><li id="d7eb" class="nc nd iq lq b lr mu lu mv lx ne mb nf mf ng mj nh ni nj nk bi translated"><a class="ae kv" href="https://www.kaggle.com/edwintyh/automated-machine-learning-with-h2o" rel="noopener ugc nofollow" target="_blank">训练</a></li><li id="4f62" class="nc nd iq lq b lr nl lu nm lx nn mb no mf np mj nh ni nj nk bi translated"><a class="ae kv" href="https://www.kaggle.com/edwintyh/h2o-inference" rel="noopener ugc nofollow" target="_blank">推论</a></li></ul></div></div>    
</body>
</html>