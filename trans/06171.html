<html>
<head>
<title>How to Use SQL Window Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用SQL窗口函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-use-sql-window-functions-5d297d29f810?source=collection_archive---------26-----------------------#2021-06-02">https://towardsdatascience.com/how-to-use-sql-window-functions-5d297d29f810?source=collection_archive---------26-----------------------#2021-06-02</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><div class=""><h2 id="3e6a" class="pw-subtitle-paragraph js iu iv bd b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj dk translated">最常见的例子有代码示例</h2></div><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi kk"><img src="../Images/ec9f808c16c15698b0b4a56d520e8937.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cGzUATdMqWFK0aed5KRwAQ.jpeg"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">范妮·拉斯科在<a class="ae la" href="https://unsplash.com/s/photos/windows?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="4e48" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">无论您是在解决一个复杂的问题，还是正在面试一个需要高级SQL知识的技术职位，了解如何使用SQL窗口函数都很重要。</p><p id="b5d3" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">虽然在工作面试过程中并不总是必要的，但知道如何使用它们肯定会给面试官留下深刻印象，并在解决编码问题时节省你的时间。这些功能通常会将非常复杂的解决方案简化为更快、更容易理解的解决方案。</p><h2 id="a5f0" class="lx ly iv bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo mp bi translated">什么是窗口函数？</h2><p id="9657" class="pw-post-body-paragraph lb lc iv ld b le mq jw lg lh mr jz lj lk ms lm ln lo mt lq lr ls mu lu lv lw io bi translated">窗口函数是在各种表格行中执行的函数。这些函数不是像“正常”函数那样单独查看每一行，而是通常查看前面和/或后面的行，以便计算目标行。</p><h2 id="0745" class="lx ly iv bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo mp bi translated">最流行的窗口函数</h2><ol class=""><li id="bfe1" class="mv mw iv ld b le mq lh mr lk mx lo my ls mz lw na nb nc nd bi translated">总和</li><li id="5413" class="mv mw iv ld b le ne lh nf lk ng lo nh ls ni lw na nb nc nd bi translated">最大</li><li id="4a85" class="mv mw iv ld b le ne lh nf lk ng lo nh ls ni lw na nb nc nd bi translated">行号</li><li id="e94b" class="mv mw iv ld b le ne lh nf lk ng lo nh ls ni lw na nb nc nd bi translated">军阶</li><li id="e34d" class="mv mw iv ld b le ne lh nf lk ng lo nh ls ni lw na nb nc nd bi translated">超前/滞后</li></ol><p id="33ee" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">让我们分别来看看它们的作用以及在SQL代码中使用它们的最佳方式。</p><h2 id="97cc" class="lx ly iv bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo mp bi translated">总和</h2><p id="314b" class="pw-post-body-paragraph lb lc iv ld b le mq jw lg lh mr jz lj lk ms lm ln lo mt lq lr ls mu lu lv lw io bi translated">Sum就像它听起来的那样。它把你指定给它的任何东西加起来，或者取总和。sum window函数与典型sum函数的主要区别在于，它对每一行进行累计求和，而不是对所有行进行累计求和。</p><p id="4251" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">例如，假设您想要创建一周内花费的累计总额。你希望看到你在一周的每一天都花了多少钱，而不是一周结束时的总数。你可以使用求和窗函数。</p><pre class="kl km kn ko gt nj nk nl nm aw nn bi"><span id="6777" class="lx ly iv nk b gy no np l nq nr">SELECT<br/>   employee_name,<br/>   day_of_week,<br/>   amount_spent,<br/>   SUM(amount_spent) OVER (ORDER BY date) AS total<br/>FROM personal_finances </span></pre><p id="0505" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这将产生如下所示的输出:</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ns"><img src="../Images/71459759b851e380a582f16a3b654d1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EIqZpbPmFvQpy3MBg3wrmA.jpeg"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><p id="15e8" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">如果我们是一家公司，正在查看我们的员工花费了多少钱，那么在报表中添加一个分区可能会有所帮助。</p><pre class="kl km kn ko gt nj nk nl nm aw nn bi"><span id="4940" class="lx ly iv nk b gy no np l nq nr">SELECT<br/>   employee_name,<br/>   day_of_week,<br/>   amount_spent,<br/>   SUM(amount_spent) OVER (ORDER BY date PARTITION BY employee_name) AS total<br/>FROM personal_finances</span></pre><p id="dc8d" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">该查询的输出如下所示:</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ns"><img src="../Images/2c0c68a37d7cbf6b4fdeaaa0b36917ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AfydL_e-KXsVSDfcx2V0mA.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><h2 id="b5fa" class="lx ly iv bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo mp bi translated">最大</h2><p id="e3f9" class="pw-post-body-paragraph lb lc iv ld b le mq jw lg lh mr jz lj lk ms lm ln lo mt lq lr ls mu lu lv lw io bi translated">就像sum一样，max的工作方式类似于“普通”SQL max函数。它采用您指定的列的最大值，并取决于您对ORDER BY和PARTITION BY使用的条件。但是，请记住，这些函数是可选的。</p><p id="b3c2" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">以下是如何从每个部门中找出在公司卡上花费最多的员工:</p><pre class="kl km kn ko gt nj nk nl nm aw nn bi"><span id="472e" class="lx ly iv nk b gy no np l nq nr">SELECT<br/>   employee_name,<br/>   department,<br/>   MAX(total_spent) OVER(ORDER BY total_spent PARTITION BY   department) as max_spent<br/>FROM personal_finances</span></pre><p id="a237" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">结果将如下所示:</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi nt"><img src="../Images/dc6863a51ff4caf212e18597b0488d5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*14uEAM5likPj8kzxyMLKkg.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><h2 id="4fcf" class="lx ly iv bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo mp bi translated">行号</h2><p id="d8c7" class="pw-post-body-paragraph lb lc iv ld b le mq jw lg lh mr jz lj lk ms lm ln lo mt lq lr ls mu lu lv lw io bi translated">行号和等级非常相似，经常互换使用。就我个人而言，我更多地使用排名方式，因为我认为它更适用于我正在解决的问题。行号用于根据行在表中的顺序为行分配编号。您不必在括号中使用列名，因为您只是返回订单。</p><p id="15f1" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这里，我们按照雇员id对雇员进行排序，并根据雇员在表中的顺序为每一行分配一个行号。</p><pre class="kl km kn ko gt nj nk nl nm aw nn bi"><span id="dbba" class="lx ly iv nk b gy no np l nq nr">SELECT<br/>    ROW_NUMBER() OVER(ORDER BY employee_id),<br/>    employee_id,<br/>    employee_name<br/>FROM org_chart</span></pre><p id="96bc" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这将产生如下所示的输出:</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/e8ff5ecd6772c901709b71ada057cffa.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*NdvYK2KIcFiuB_7Ysbrzmg.png"/></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><h2 id="60d4" class="lx ly iv bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo mp bi translated">军阶</h2><p id="d8df" class="pw-post-body-paragraph lb lc iv ld b le mq jw lg lh mr jz lj lk ms lm ln lo mt lq lr ls mu lu lv lw io bi translated">Rank用于根据某个列值对行进行排序。这对于任何类型的排序问题都非常有用，并且由于ORDER BY和PARTITION BY子句的缘故，非常有用。Rank可能是所有窗口函数中我最喜欢和最常用的！</p><p id="e519" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在这里，我们可以用它来找出公司里花钱最多的人:</p><pre class="kl km kn ko gt nj nk nl nm aw nn bi"><span id="0949" class="lx ly iv nk b gy no np l nq nr">SELECT<br/>    employee_name,<br/>    employee_id,<br/>    amount_spent,<br/>    RANK(amount_spent) OVER(ORDER BY amount_spent DESC) AS spend_rank<br/>FROM employees</span></pre><p id="2c7c" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">请注意，我在ORDER BY子句后包含了DESC。这在使用rank时极其重要。必须指定是按列ASC(值变大)还是按列DESC(值变小)排序。如果不指定这一点，查询可能会返回与预期相反的结果。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/1be2b57a2e53c5daac31af365b01d930.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*1sLLExctNuIcGBzwVqzBuA.png"/></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><p id="6b6b" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">让我们看看同一个例子，但是使用PARTITION BY。</p><pre class="kl km kn ko gt nj nk nl nm aw nn bi"><span id="3b77" class="lx ly iv nk b gy no np l nq nr">SELECT<br/>    employee_name,<br/>    employee_id,<br/>    department_id,<br/>    RANK(amount_spent) OVER(ORDER BY amount_spent DESC PARTITION BY department_id) AS spend_rank<br/>FROM employees</span></pre><p id="c800" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">现在，我们正在对每个部门的最高支出者进行排名。每次检测到不同的department_id时，排名将从停止的排名号继续。输出将如下所示:</p><p id="8962" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">请注意，它并不一定要对行进行分组或重新排序，但是排名是由department_id和每个员工在其部门内的支出金额顺序决定的。</p><p id="b155" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">如果您有兴趣深入研究rank窗口函数，甚至了解rank和dense rank之间的区别，请查看我的文章<a class="ae la" rel="noopener" target="_blank" href="/how-to-use-sql-rank-and-dense-rank-functions-7c3ebf84b4e8">如何使用SQL RANK和DENSE_RANK函数</a>。</p><h2 id="f26c" class="lx ly iv bd lz ma mb dn mc md me dp mf lk mg mh mi lo mj mk ml ls mm mn mo mp bi translated">超前/滞后</h2><p id="87ca" class="pw-post-body-paragraph lb lc iv ld b le mq jw lg lh mr jz lj lk ms lm ln lo mt lq lr ls mu lu lv lw io bi translated">当你第一次了解它们的时候，理解起来会很困惑。实际上，我写了一整篇文章来解释它们的不同之处，以及记住它们的含义的技巧。查看<a class="ae la" rel="noopener" target="_blank" href="/how-to-use-sql-lead-and-lag-functions-35c0db633c5e">如何使用SQL超前和滞后函数</a>了解更多信息。</p><p id="ada6" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">第一次使用窗口函数时，尽量不要沮丧。你能做的最好的事情就是练习、练习、练习，然后将你的输出与你期望你的代码产生的结果进行比较。这是了解代码如何工作的最好方法。</p><p id="4ed2" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">请务必查看我的另一篇关于SQL窗口函数的文章，以消除您可能有的任何困惑。查询愉快！</p></div></div>    
</body>
</html>