<html>
<head>
<title>Seamlessly Porting Python and Pandas Functions to Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Python和Pandas功能无缝移植到Spark</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/seamlessly-porting-python-and-pandas-functions-to-spark-46718361b93f?source=collection_archive---------38-----------------------#2021-08-09">https://towardsdatascience.com/seamlessly-porting-python-and-pandas-functions-to-spark-46718361b93f?source=collection_archive---------38-----------------------#2021-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b68d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我们可以用简单的方法，或者困难的方法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/cbd9b5752be898b70c69278d11c89e1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ks4KCdEzkUTrrK8B"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">巴勃罗·阿罗约在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="a35d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:这里展示的代码是用于格式化的图片，但是你可以在<a class="ae kv" href="https://fugue-tutorials.readthedocs.io/en/latest/tutorials/beginner/introduction.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到它们。</p><h2 id="1da4" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">动机</h2><p id="2def" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">虽然Pandas是数据科学和数据分析师工作流中最常见的Python工具，但它不能很好地处理大数据集，因为它一次只使用一个内核。它还使用了惊人的内存量。在<a class="ae kv" href="https://wesmckinney.com/blog/apache-arrow-pandas-internals/" rel="noopener ugc nofollow" target="_blank"> Wes McKinney的博客文章</a>中，他提到经验法则是拥有5倍或10倍于数据集大小的RAM。</p><p id="d62f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当熊猫的数据处理效率低下时，数据科学家开始寻求Spark等分布式计算框架。这些框架通过使用单台机器甚至整个集群上的可用内核来加快计算速度。不利的一面是，为了利用Spark，Pandas和Python代码通常不得不与Spark兼容。</p><p id="b8a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将回顾一个使用<a class="ae kv" href="https://github.com/fugue-project/fugue" rel="noopener ugc nofollow" target="_blank"> Fugue </a>将Pandas和Python代码无缝移植到Spark的例子，这是一个用于分布式计算的开源抽象层。在经历了赋格方法之后，我们将使用Spark 3.0中可用的Spark的mapInPandas方法将其与传统方法进行比较。</p><h2 id="948b" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">示例问题</h2><p id="553a" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在这个示例问题中，我们有一个已经使用Pandas和scikit-learn训练过的机器学习模型。我们希望在一个太大的数据集上运行预测，熊猫无法使用Spark有效地处理这个数据集。本教程也将适用于转换数据的操作。我们不局限于机器学习应用。</p><p id="899c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们从制作一个简单的线性回归模型开始。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mq"><img src="../Images/51ae91a81a3957907c3b50a9572a8891.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qJcOuC5DnW9eBl8E6WICRA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">简单线性回归</p></figure><p id="7308" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们创建一个简单的<strong class="ky ir">预测</strong>函数，该函数将接收一个数据帧并创建一个名为“<strong class="ky ir">预测”</strong>的新列，其中包含预测。这部分对于熊猫用户来说并不新鲜。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mr"><img src="../Images/f2911f62448f563b2f9c2c68f04c6abb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JWobeYZ37MeyjKn8yfSGLQ.png"/></div></div></figure><h2 id="a8ee" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">用赋格在火花中执行</h2><p id="f300" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">这就是奇迹发生的地方。<a class="ae kv" href="https://github.com/fugue-project/fugue" rel="noopener ugc nofollow" target="_blank"> Fugue </a>是一个抽象层，旨在使用户能够将Pandas和Python代码移植到Spark。稍后，我们将展示如何在没有赋格的情况下手动完成，但首先，我们将看看赋格是如何完成这一点的。</p><p id="cd4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">神游有一个<strong class="ky ir">转换</strong>函数，它接受熊猫或火花数据帧和一个函数。当我们指定一个<strong class="ky ir">执行引擎</strong>时，Fugue将应用必要的转换来运行该引擎上的代码(在本例中是Spark)。如果没有指定引擎，它将在熊猫上运行。请参见下面的代码片段。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ms"><img src="../Images/1538bdad2428a81b435c0a7acaec1b91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jT-GHXUdgu0LyLy9vHvfKQ.png"/></div></div></figure><p id="4c66" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是字面意思。这将在Spark上运行。代码块中的大多数内容都很容易理解。<strong class="ky ir"> input_df </strong>可以是Pandas或Spark数据帧。<strong class="ky ir"> predict </strong>函数是我们之前定义的函数，而<strong class="ky ir"> params </strong>参数包含传递给该函数的内容。在这种情况下，我们通过了之前训练的回归模型。因为我们选择了<strong class="ky ir"> SparkExecutionEngine </strong>，所以所有代码将以并行方式在Spark上运行。</p><p id="4486" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后要理解的是<strong class="ky ir">模式</strong>参数。这是因为<strong class="ky ir">模式</strong>在Spark中被严格执行，需要显式。使用<strong class="ky ir"> "*，predicted:double" </strong>，我们指定保留所有列，并添加一个名为<strong class="ky ir">的double类型的预测</strong>的新列。这是Spark方法的一个大规模简化的语法，我们将在后面看到。</p><p id="838a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用Fugue中的<strong class="ky ir"> transform </strong>函数，我们能够在Spark上使用Pandas函数，而无需对原始函数定义进行任何修改。让我们看看如何在不赋格的情况下做等效的动作。没有必要完全理解下一节的所有内容，重点只是展示Fugue的界面简单了多少。</p><h2 id="021c" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">Spark实施</h2><p id="2645" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">这一部分是为那些想比较这些方法的人准备的。下面的代码片段是如何使用Spark的<strong class="ky ir"> mapInPandas </strong>实现的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/e6a700e6d63ee42b2e6df7289dd0d24a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JdsBSt67ifYZt1fCcmf7AQ.png"/></div></div></figure><p id="a129" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些步骤依次为:</p><ol class=""><li id="bcd9" class="mu mv iq ky b kz la lc ld lf mw lj mx ln my lr mz na nb nc bi translated">创建SparkSession (Fugue的SparkExecutionEngine在幕后完成这项工作)</li><li id="ab3c" class="mu mv iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">包装<strong class="ky ir">预测</strong>函数以处理数据帧的迭代器。这是因为该函数将接收多个数据帧(分区),并且<strong class="ky ir">预测每个集合。</strong></li><li id="a8e5" class="mu mv iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">创建一个接受Spark或Pandas数据帧的<strong class="ky ir"> run_predict </strong>函数。将数据帧转换为Spark数据帧(如果尚未转换)。</li><li id="d0be" class="mu mv iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">拉出<strong class="ky ir">模式</strong>并添加double类型的新<strong class="ky ir">“预测”</strong>列。</li><li id="a9fd" class="mu mv iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">使用<strong class="ky ir"> mapInPandas </strong>方法将操作映射到分区。</li></ol><p id="5493" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">神游的<strong class="ky ir">转换</strong>为用户处理所有这些。</p><h2 id="55a2" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">结论</h2><p id="a9b2" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在本文中，我们比较了将Pandas和Python函数引入Spark的两种方式。第一个是Fugue，我们简单地调用了<strong class="ky ir"> SparkExecutionEngine </strong>上的转换函数，所有的转换都为我们处理了。第二个是使用vanilla Spark，我们必须创建辅助函数。</p><p id="f2df" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于一个函数，我们已经在Spark实现中编写了许多样板代码。对于一个有几十个函数的代码库，实践者最终会编写大量的样板代码，使代码库变得混乱。虽然使用Fugue最简单的方法是使用<strong class="ky ir"> transform </strong>函数，但是这种编写与Pandas和Spark都兼容的代码的概念可以扩展到完整的工作流。如需了解更多详情，请随时联系(信息如下)。</p><h2 id="efc6" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">联系我们</h2><p id="e04e" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">如果您有兴趣了解更多关于神游、分布式计算或如何以更简单的方式使用Spark的知识，请随时联系我们！这里涵盖的内容只是起点。赋格团队正在给数据团队提供完整的研讨会和演示，并希望与您交谈。</p><p id="ebc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/fugue-project/fugue" rel="noopener ugc nofollow" target="_blank"> Github回购</a></p><p id="48f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://join.slack.com/t/fugue-project/shared_invite/zt-jl0pcahu-KdlSOgi~fP50TZWmNxdWYQ" rel="noopener ugc nofollow" target="_blank">松弛</a></p><p id="3c75" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://fugue-tutorials.readthedocs.io/en/latest/tutorials/beginner/index.html" rel="noopener ugc nofollow" target="_blank">赋格教程</a></p><p id="5dbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">邮箱:hello@fugue.ai</p></div></div>    
</body>
</html>