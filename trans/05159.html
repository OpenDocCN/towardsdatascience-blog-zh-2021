<html>
<head>
<title>Visualization of travel times with OTP and QGis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于OTP和QGis的旅行时间可视化</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/visualization-of-travel-times-with-otp-and-qgis-3947d3698042?source=collection_archive---------15-----------------------#2021-05-06">https://towardsdatascience.com/visualization-of-travel-times-with-otp-and-qgis-3947d3698042?source=collection_archive---------15-----------------------#2021-05-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="20c2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用开源产品和开放数据创建荷兰公共交通出行时间的惊人可视化</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6114877c381f023cf0e0bb836f519c42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M5hmmFQ7OVdW6uBJPPhXWw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片(由QGIS创建)</p></figure><p id="5558" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">荷兰公共交通的最大发展之一是公共可用数据的持续增长。结合OpenStreetMap，这为多模式出行规划者提供了充足的信息。<a class="ae lr" href="https://opentripplanner.org" rel="noopener ugc nofollow" target="_blank"> OpenTripPlanner </a>是一个非常完整的TripPlanner实现的例子。本文将向您展示如何使用OTP和QGis来可视化从一个起点到荷兰所有地区的旅行时间。</p><p id="0ed1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">时代在变，在家工作正成为新的标准，而且很可能会持续下去。2或3天到办公室将成为标准，减少从家到工作的旅行天数。在过去的几十年里，通勤时间保持不变，对于大多数人来说，每天大约一个小时的单程旅行是最长的。未来几十年，我预计每周通勤时间将保持稳定，增加每天可接受的旅行时间，这将允许人们离开城市，进入内陆地区(“乌得勒支以外”)。</p><p id="0e23" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这将提出一个问题:在一定的旅行时间内可以到达该国的哪些地区？本文将向您展示从一个位于乌得勒支市中心的虚构工作地点到荷兰所有邮政编码的旅行时间。所有的旅行都使用公共交通工具。</p><p id="0a4f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该项目的数据来源是GeoFabrik 的<a class="ae lr" href="https://download.geofabrik.de/europe/netherlands.html" rel="noopener ugc nofollow" target="_blank"> OpenStreetMap和</a><a class="ae lr" href="https://gtfs.org/" rel="noopener ugc nofollow" target="_blank"> GTFS格式</a>的<a class="ae lr" href="https://ovapi.nl/" rel="noopener ugc nofollow" target="_blank"> OVapi用于时间表</a>。基于<a class="ae lr" href="https://geojson.org/" rel="noopener ugc nofollow" target="_blank"> GeoJSON </a>文件，用<a class="ae lr" href="https://opentripplanner.org" rel="noopener ugc nofollow" target="_blank"> OpenTripPlanner 2.0 </a>进行行程时间计算，用<a class="ae lr" href="https://qgis.org" rel="noopener ugc nofollow" target="_blank"> QGis 3 </a>进行可视化。</p><p id="d235" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这篇文章的完整代码可以在G <a class="ae lr" href="https://github.com/lmeulen/GTFS-Visuals" rel="noopener ugc nofollow" target="_blank"> ithub </a>上找到。</p><p id="c060" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">计算行程时间</strong></p><p id="8100" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">第一步是计算旅行时间。从我们的出发点到这个国家的一系列地点。如前所述，计算是用OTP执行的。OTP需要一个OpenStreetMap PBF文件，其中包含您感兴趣区域的街道和步行时间，以及GTFS的公共交通时刻表。OTP jar是从<a class="ae lr" href="https://repo1.maven.org/maven2/org/opentripplanner/otp/2.0.0/" rel="noopener ugc nofollow" target="_blank"> Maven </a>下载的。阴影部分是为了简单起见，因为它包括了所有的依赖项。OSM PBF从<a class="ae lr" href="https://download.geofabrik.de/europe/netherlands.html" rel="noopener ugc nofollow" target="_blank"> GeoFabrik </a>获得，命名为‘荷兰-最新-osm . pbf’。GTFS从<a class="ae lr" href="http://gtfs.ovapi.nl/nl/" rel="noopener ugc nofollow" target="_blank"> OVapi </a>下载，并以zip ('gtfs-nl.zip ')格式下载。这三个文件都存储在同一个位置。</p><p id="1a73" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">OTP从命令行启动:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="bf9d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它将在当前目录中找到OSM和GTFS文件，并开始构建网络图。由于规模(我们正在创建一个整个国家的地图，而不是一个单一的城市)这将需要一些时间，但最终OTP服务器启动。需要12G的堆大小才能在内存中加载网络图。要测试服务器，请尝试URL<a class="ae lr" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a>。</p><p id="4b54" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">除了web接口，还有一个REST API用于使用OTP服务器。旧版本的OTP提供了一个REST-API，用于从单个位置请求带有旅行时间的等时线地图，但不幸的是，这个API在最新版本中不再可用。</p><p id="af5b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">GTFS停靠点规范是为行程时间计算定义一组目的地的一个很好的切入点。对于所有已定义的公共交通站点，我们采用LatLon坐标，并将其四舍五入到圆点后面的三个数字。1度大约是。111千米，所以xx.xxx给出100米的分辨率。在移除重复的位置之后，获得将被使用的集合。通过对LatLon位置进行舍入，可以防止重复计算，例如，在同一条道路的相对侧有两个公共汽车站。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="4f56" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">此示例显示了输入集的创建，其中使用了乌得勒支市中心的一个位置，旅行将发生在2021年3月17日16:00。相同的文件格式可用于计算在不同时间和日期具有不同起点的一组起点-目的地，但目前，旅行的起始位置和日期时间是恒定的。</p><p id="e215" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">OTP通过其REST API支持计划者请求。请求具有以下形式:</p><p id="1102" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="http://localhost:8080/otp/routers/2015/plan?%3cparam" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/OTP/routers/2015/plan？&lt;参数</a>T11】</p><p id="d2d7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">除其他外，这些参数规定了日期、时间、起点、终点和使用的方式。通过为创建的文件中的每个起点/目的地线路调用该端点，创建了到该国公共交通可到达的所有位置的旅行时间的概览:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="be4e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">生成的数据集:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lu"><img src="../Images/d3d254264550c0d06e93a5c5f5568360.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QfmALNiexn86K7dh31NN6A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="cf29" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">可视化行程时间</strong></p><p id="b857" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">将这些点添加到QGis中的地图可以合理地概述行驶时间。首先安装来自https://qgis.org<a class="ae lr" href="https://qgis.org" rel="noopener ugc nofollow" target="_blank">的QGis 3</a>，并按照本页的说明添加来自https://www.openbasiskaart.nl/qgis.html<a class="ae lr" href="https://www.openbasiskaart.nl/qgis.html" rel="noopener ugc nofollow" target="_blank">的国家底图。我们为可视化添加了ESP-28992地图als底图。</a></p><p id="200d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">通过添加“文本交付图层”并将are script的输出文件指定为源，在底图的顶部添加了包含行驶时间的图层。确保使用EndLon、EndLat作为位置列(否则仅绘制起点)。现在，它将所有计算出的旅行时间显示为地图上的点:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/27b029b3fff7b56f23a112ba3aa77f61.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/1*E4nxfxaoMp3YA_U3xfI1MQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片(由QGIS创建)</p></figure><p id="dbe4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">由于公共交通点是目的地位置的基础，点的分布很好地概括了公共交通密度。我们可以给点添加一种颜色，通过将它指定为“分级”来指示旅行时间:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/2e5a3164e27694e5ba49aec9930b63bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*uG3nlM1S1iYC_fiUDOqCGQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">QGIS图层属性屏幕(来源:QGis)</p></figure><p id="bc15" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">深绿色圆点在30分钟内，浅绿色圆点在60分钟内，黄色圆点在2小时内，橙色圆点在4小时内，红色圆点超过4小时:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/b84ae261525b153185bdfbb1076a502a.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*milf5IYWNTpIa1HuS9PtfA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片(由QGIS创建)</p></figure><p id="42be" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">虽然这是一个好的开始，但地图并没有给出完整的、易于理解的旅行时间概览。这是一大堆点。为了改进地图，我们想制作一个类似等时线的总览图。我们需要将地图划分为覆盖整个国家的区域，并根据旅行时间对这些区域进行着色。这些区域的来源将是邮政编码地图。所有邮区的形状都可以从<a class="ae lr" href="https://arc-gis-hub-home-arcgishub.hub.arcgis.com/datasets/esrinl-content::postcodevlakken-pc-4" rel="noopener ugc nofollow" target="_blank"> ArcGIS Hub </a>中获得。到达一个邮政编码的行驶时间计算为到达上图中所有可用点的平均行驶时间:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="d207" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">GeoPandas包对地理计算有很好的支持，包括在给定区域内选择点(gdf.within(…))。对于所有的邮政编码，添加一列行程时间(“travel time”)。</p><p id="e6af" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">看上面的地图，你会怀疑不是所有的邮政编码都包括在内。执行上述代码后，超过10%的邮政编码没有旅行时间。这些邮政编码被赋予到周围(接触)邮政编码的平均行程时间，加上所需时间的15分钟(用于从邮政编码到邮政编码的通勤)。如果这仍然不能产生时间，则使用完整组中的最大时间(以在以后保持带内着色)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="edd3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后将GeoPanda数据帧保存为GeoJSON文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="73f9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">导出此数据框后，可将其作为图层添加到QGis(例如，将geojson文件拖放到QGis的图层窗口):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/409011aadf5a98370ae6f34fc900adb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*g3qKxKCR_dl-90MoiV_iXA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片(由QGIS创建)</p></figure><p id="9c56" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">邮政编码区域覆盖整个国家，对于我们的目的有足够的细节。如果需要更多细节，可以使用PC6数据集。</p><p id="8db4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后一步是给形状添加颜色:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/8bf720ced6ee5f2962427a5667a8b6db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*Fn4nhCn17zUuf54zsAPFWQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">QGIS图层属性屏幕(来源:QGis)</p></figure><p id="7867" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">颜色随着15分钟而增加，并逐渐从绿色变为红色，从而显示出全国范围内到达乌得勒支市中心的旅行时间概况:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/f6367a1a58cd09cd5903f6e99837bc9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*ASEGQHaylM77E96Qo7z2lQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片(由QGIS创建)</p></figure><p id="545e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果给出了可接受的行驶时间，例如90分钟，颜色方案可以被调整为:<br/>绿色:0至60分钟<br/>浅绿色:60至90分钟<br/>黄色:90至120分钟<br/>红色:120分钟及更长时间</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/b4590b3b6f754f690fd237cdf3b23923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*bKXZTtDVNUMft68qxLk6-w.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片(由QGIS创建)</p></figure><p id="a433" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">结束语</strong></p><p id="bbd1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Open Trip Planner 2是一款成熟的开源多模型旅行规划工具。通过它的API，很容易集成到任何脚本或应用程序中。由于GeoPandas支持地理计算，因此创建地理编码数据集相对容易。QGis是一个开源地理信息系统，可以从界面使用，如本例所示，但也配备了Python接口，使其更容易集成到脚本和应用程序中。创建视觉效果既简单又有帮助，因为图形概览使数据解释更容易。</p><p id="cc39" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="ma">免责声明:本文包含的观点和意见仅归作者所有。</em></p></div></div>    
</body>
</html>