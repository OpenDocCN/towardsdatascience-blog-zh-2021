<html>
<head>
<title>Make Pandas Run Blazingly Fast</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让熊猫跑得飞快</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/make-pandas-run-blazingly-fast-3dbcd621f75b?source=collection_archive---------29-----------------------#2021-04-07">https://towardsdatascience.com/make-pandas-run-blazingly-fast-3dbcd621f75b?source=collection_archive---------29-----------------------#2021-04-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e9cc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">你不需要再等了</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bd12955f420b3a7840a213c02a227cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RZbMcpkt4S3ieAQf"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@chuttersnap?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> CHUTTERSNAP </a>拍照</p></figure><p id="84b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们都喜欢并使用熊猫。当我们作为数据探索者深入探索数据奥秘时，它是我们的日常伴侣。通常，我们处理大量的数据，如果我们的<code class="fe lv lw lx ly b">apply</code>函数能够快速运行，我们会很高兴。</p><p id="1b16" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好了，不要再等了，我向你介绍。</p><p id="d2b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将看到我们如何从这里开始:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lz"><img src="../Images/979088a022ec3e008bc182bed3d192bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*jJtt8Wq2-8clC_AM2cp1hw.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">资料来源:https://github.com/nalepae/pandarallel</p></figure><p id="6b77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对此:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi gj"><img src="../Images/892fd3fd8c54b38fdb69e97bae06dd67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*2JMAri0TzN6Ftn2hzeTJSg.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://github.com/nalepae/pandarallel" rel="noopener ugc nofollow" target="_blank">https://github.com/nalepae/pandarallel</a></p></figure><h1 id="479f" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">泛平行函数</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/c1b50fc80ebd48dc99b52a9f5dc60d17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y2ZYFYSjC_kp-JsexsAuHw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://github.com/nalepae/pandarallel" rel="noopener ugc nofollow" target="_blank">https://github.com/nalepae/pandarallel</a></p></figure><p id="b869" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面我们看到了可供我们使用的功能。</p><h1 id="7a1b" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">如何安装？</h1><p id="feba" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">这个库在pip上是可用的，所以，只需要这样做:</p><p id="c343" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">pip install pandarallel</code></p><h1 id="ef63" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">怎么用？</h1><p id="3457" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">我们首先需要导入库。</p><p id="99ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">from pandarallel import pandarallel</code></p><p id="b830" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这之后，我们需要调用<code class="fe lv lw lx ly b">.initialize()</code>让<code class="fe lv lw lx ly b">pandarallel</code>发挥它的魔力。</p><p id="7346" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">pandarallel.initialize()</code></p><p id="29aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会从Pandarallel收到一些关于你的设置的信息。</p><pre class="kj kk kl km gt my ly mz na aw nb bi"><span id="1e9f" class="nc mb it ly b gy nd ne l nf ng">INFO: Pandarallel will run on 2 workers. <br/>INFO: Pandarallel will use Memory file system to transfer data between the main process and workers.</span></pre><p id="1162" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于我使用的是Google Colab，它不提供很多CPU，所以我们只有2个工作人员。当你在你的机器上运行这个的时候，工人的数量将会更多，速度也会加快。所以，我们在这里看到的是加速的下限T21。</p><p id="36e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们看看魔法。</p><p id="c8e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将首先创建一个大型数据框来测试Pandarallel的能力。</p><pre class="kj kk kl km gt my ly mz na aw nb bi"><span id="d568" class="nc mb it ly b gy nd ne l nf ng">df = pd.DataFrame(dict(a=np.random.randint(1, 8, df_size), b=np.random.rand(df_size)))</span></pre><p id="19d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们创建了一个有五百万行的数据帧。</p><p id="c128" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建一个应用于此数据框的函数。</p><pre class="kj kk kl km gt my ly mz na aw nb bi"><span id="f729" class="nc mb it ly b gy nd ne l nf ng"><strong class="ly iu">def</strong> func(x):<br/>    <strong class="ly iu">return</strong> math.sin(x.a**2) + math.sin(x.b**2)</span></pre><p id="6811" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<strong class="lb iu"> Pandas的apply() </strong>函数:</p><pre class="kj kk kl km gt my ly mz na aw nb bi"><span id="0da4" class="nc mb it ly b gy nd ne l nf ng">%%time<br/>res = df.apply(func, axis=1)</span></pre><p id="c8b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到输出:</p><pre class="kj kk kl km gt my ly mz na aw nb bi"><span id="ac52" class="nc mb it ly b gy nd ne l nf ng">CPU times: user 2min 12s, sys: 1.64 s, total: 2min 14s <br/>Wall time: 2min 14s</span></pre><p id="f6ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面我们得到的是<strong class="lb iu">未并行化的</strong>代码，需要2分14秒。</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><p id="8201" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看由Pandarallel库并行化的代码<strong class="lb iu">。</strong></p><p id="8731" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<strong class="lb iu"> Pandarallel的parallel_apply() </strong>函数:</p><pre class="kj kk kl km gt my ly mz na aw nb bi"><span id="8a2e" class="nc mb it ly b gy nd ne l nf ng">%%time <br/>res_parallel = df.parallel_apply(func, axis=1)</span></pre><p id="e2c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到输出:</p><pre class="kj kk kl km gt my ly mz na aw nb bi"><span id="4f8d" class="nc mb it ly b gy nd ne l nf ng">CPU times: user 780 ms, sys: 271 ms, total: 1.05 s <br/>Wall time: 2min 2s</span></pre><p id="43e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所用的时间是<strong class="lb iu"> 2分2秒</strong>，比上面未并行化的代码所用的时间少，即<strong class="lb iu"> 2分14秒</strong>。节省了时间(12秒)，即使我们只使用2个工作线程(1个工作线程= CPU中的1个实际内核)。</p><p id="1394" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你不满意，这里有一个库的作者做的基准测试。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/022112d5bee82b74e4c79b58a764d35d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y7skgioVWvgz0fp_KFnkag.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:https://github.com/nalepae/pandarallel<a class="ae ky" href="https://github.com/nalepae/pandarallel" rel="noopener ugc nofollow" target="_blank"/></p></figure><p id="7319" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在4个内核(即4个工作线程)上，我们看到时间减少得更多。</p><h1 id="bee8" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">结论</h1><p id="0e87" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">只需在函数调用中做一个简单的改变，我们就能让我们的熊猫代码获得巨大的加速。这绝对是一件好事，因为数据处理需要花费大量时间，让我们远离数据分析。</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="8f80" class="ma mb it bd mc md nq mf mg mh nr mj mk jz ns ka mm kc nt kd mo kf nu kg mq mr bi translated">阿布舍克·维尔马</h1><ul class=""><li id="6eee" class="nv nw it lb b lc mt lf mu li nx lm ny lq nz lu oa ob oc od bi translated"><em class="nh">如果你喜欢这个，请关注我的</em><a class="ae ky" href="https://medium.com/@deeptechtalker" rel="noopener"><em class="nh">Medium</em></a><em class="nh">了解更多</em></li><li id="71ca" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><em class="nh">我们来连线一下</em><a class="ae ky" href="https://www.linkedin.com/in/abhishek-verma-3b63479a/" rel="noopener ugc nofollow" target="_blank"><em class="nh">LinkedIn</em></a></li><li id="ab26" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">看我在<a class="ae ky" href="https://www.kaggle.com/abhishekvermasg1" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>上的作品。</li></ul></div></div>    
</body>
</html>