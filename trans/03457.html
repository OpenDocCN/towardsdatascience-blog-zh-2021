<html>
<head>
<title>How to load and store MLFlow models in R on DataBricks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在数据块上加载和存储R中的MLFlow模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-load-and-store-mlflow-models-in-r-on-databricks-hacking-the-constraints-93ce458af7ff?source=collection_archive---------17-----------------------#2021-03-19">https://towardsdatascience.com/how-to-load-and-store-mlflow-models-in-r-on-databricks-hacking-the-constraints-93ce458af7ff?source=collection_archive---------17-----------------------#2021-03-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0322" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">破解约束</h2></div><p id="ed3c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Databricks已经成为云计算的重要组成部分，尤其是现在，在谷歌宣布在谷歌云上推出Databricks之后。然而，必须指出的是，它仍然是一项试验性的技术，在效率和覆盖面方面还有很长的路要走。</p><p id="323e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于数据科学来说，r是最强大和使用最多的语言和环境之一，年复一年，统计人员努力开发不同的库。由于这一点，你可以找到几乎所有用R实现的数学模型，这对于你能想象的大多数DS项目的成功是非常有用的。但是，R有一个重要的缺点:大数据。在处理海量数据时，SparkR和其他公式还远远不能提供一个庞大的ML库目录。大部分BigData SaaS和PaaS都专注于Python和Spark，比如Databricks，努力开发一个完整的框架，并试图定义一个ML工件的端到端周期，而不是关注在r中完全支持他们的产品</p><p id="3b6b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，当在数据块中对R模型使用MLFlow时，就会发生这种情况。诚然，Databricks支持R、Python和Scala代码，但在使用MLFlow和R时，尤其是在尝试注册ML模型时，会发现不同的弱点。</p><h1 id="1f2a" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">什么是MLFlow</h1><p id="9596" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">MLFlow 是一个围绕REST APIs构建的ML平台，它允许记录ML模型的实例作为存储库。这些实例被打包，以便发送到部署工具，但是在运行您的实验时，它还注册不同的度量、模型数据、配置或代码版本。稍后，您可以将它们可视化，并比较多次运行的输出。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi lz"><img src="../Images/308065b07e3f1111861a1df494b81e33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Lxfl391gIcVP95_OOAZ7Q.png"/></div></div></figure><p id="f569" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您不熟悉MLFlow，请查看他们的文档，并尝试使用Databticks进行免费试用。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ml"><img src="../Images/d744f68582b58b290b5deb134529c78d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fp0Dz_8lc1EV5CYHMiiHEQ.png"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">来自DataBricks <a class="ae ly" href="https://databricks.com/blog/2018/06/05/introducing-mlflow-an-open-source-machine-learning-platform.html" rel="noopener ugc nofollow" target="_blank">网站</a>的一个例子</p></figure><p id="689d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">MLFlow目前处于alpha阶段，这是它仍然存在弱点的原因，但在部署我们的ML模型时，这是一个强大的想法。</p><h1 id="bbc5" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">MLFlow如何在Python/Spark上工作</h1><p id="4458" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">让我们看一个Python上MLFlow的快速例子。首先，我们必须安装并加载库:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mq"><img src="../Images/dd529b802b165afe104e2362c81108b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*253ojVRMhodoo9VN8i2spQ.png"/></div></div></figure><p id="0ffc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在此之后，我们必须使用以下命令创建或设置实验:<em class="mr">ml flow . set _ experiment(path _ to _ experiment)。</em>在注册任何实验之前，我们可以转到给定的路径，我们会看到实验已经创建，但它是空的:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ms"><img src="../Images/59c86e7fa80189893b83444467416b89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ei34E71XDVvRKhsPjdegKQ.png"/></div></div></figure><p id="4f3a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以运行我们的模型，并在我们的实验中注册执行:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mt"><img src="../Images/85d07cceb9a0ced3dd78de87c13a26f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5hQLgf-tsbjqsRAq4e26Dw.png"/></div></div></figure><p id="0a08" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<em class="mr"> autolog() </em>我们可以自动记录所有参数、分数和模型本身，但是如果我们不想跟踪整个上下文，我们可以使用<em class="mr"> log_metric()、log_param()、log_artifact() </em>或<em class="mr"> log_model() </em>函数<em class="mr">选择保存什么。</em>实际上，我发现<em class="mr"> log_model </em>函数非常有趣，因为它允许我们跟踪带有标签的模型，这可以帮助我们稍后从存储库中加载模型。<a class="ae ly" href="https://docs.microsoft.com/es-es/azure/databricks/applications/mlflow/quick-start-python#view-results" rel="noopener ugc nofollow" target="_blank">点击此处查看文档。</a></p><p id="d717" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在此之后，如果您现在转到实验路径，您将看到您已经记录的所有实验的记录。大概是这样的:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mu"><img src="../Images/7da944c17d6932a15138dce1cb305144.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*359zst9Az9N-gtqYcJoK0w.jpeg"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">来自DataBricks <a class="ae ly" href="https://databricks.com/blog/2018/08/23/how-to-use-mlflow-to-experiment-a-keras-network-model-binary-classification-for-movie-reviews.html" rel="noopener ugc nofollow" target="_blank">网站</a>的示例</p></figure><p id="8453" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦模型被训练和记录，它可以在模型库中从无传播到试运行和生产阶段(寻找<em class="mr">transition _ model _ version _ stage()</em>函数)。在Databricks中，存储库可以在“模型”选项卡中可视化:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mv"><img src="../Images/05050cd5e3c0788c8a605b2d89f13041.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eLcjMChW1Q3u6WZfxY3kvw.jpeg"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">来自DataBricks <a class="ae ly" href="https://databricks.com/wp-content/uploads/2020/04/databricks-adds-access-control-to-mlflow-model-registry_02.jpg" rel="noopener ugc nofollow" target="_blank">网站</a>的一个例子</p></figure><p id="2cf7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，可以很容易地从存储库中加载它，用于我们的预测。用户只需调用<em class="mr">ml flow . load _ model(path _ to _ model)</em>指令，即可在笔记本中使用所需的模型。</p><h1 id="311e" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">尝试在数据块中使用MLFlow的R API</h1><p id="d499" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">遵循与Python流相同的结构，我们首先加载库并安装mlflow:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mw"><img src="../Images/94aa40fbef29c3ee02898ff0dd91a19f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lcY7weIuuNQg8OgGDG4Nmg.png"/></div></div></figure><p id="c584" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个区别出现在设置实验的时候。在R中，我们不能设定一个不存在的实验；因此，为了以防万一，必须使用try-catch来捕获错误，并在需要时创建实验。之后，让我们尝试运行执行并记录模型:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mx"><img src="../Images/e9a338e3634d0a11c0a76ddc201f7e42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nwec5ub9pJDUnDVAbrgV2w.png"/></div></div></figure><p id="fe61" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，如果我们检查实验路径，我们将看到实验和运行已经创建；然而，在存储库中没有跟踪到任何模型。这令人惊讶，因为没有返回任何错误。大多数人都被困在这里，MLFlow必须解决这个问题，但原因是:</p><blockquote class="my mz na"><p id="f77e" class="kf kg mr kh b ki kj jr kk kl km ju kn nb kp kq kr nc kt ku kv nd kx ky kz la ij bi translated"><em class="iq">registered _ model _ name(‘predictor LDA’</em>)是在<em class="iq"> mlflow.log_model，</em>中使用的一个有用的参数，不幸的是目前在R库中不可用。</p></blockquote><p id="731d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们想在R笔记本中加载MLFlow模型，这是一个令人头疼的问题，但有一个解决方案。在任何Databrick笔记本中，您可以通过在单元格的开头指定语言魔术命令<code class="fe ne nf ng nh b">%&lt;language&gt;</code>来覆盖默认语言。支持的魔法命令有:<code class="fe ne nf ng nh b">%python</code>、<code class="fe ne nf ng nh b">%r</code>、<code class="fe ne nf ng nh b">%scala</code>、<code class="fe ne nf ng nh b">%sql</code>。该解决方案通过从R notebook调用python(或使用REST API)来实现:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi ni"><img src="../Images/a7e79043ba3b2d2827aea3dbd91299f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4FNg2UT7yo0wCtg1bfRKCA.png"/></div></div></figure><p id="68fd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们首先设置在前面的R命令中创建的实验，然后寻找该实验的最后一次运行。请记住，实验和运行都在R中注册，我们唯一无法跟踪的是模型。一旦我们找到了运行，我们就可以获得创建的工件的URI，我们将使用这个URI来获得python中的模型并注册它。我们只是创建一个mlflow客户端，用<em class="mr"> create_model_version </em>指令进行注册。这个操作可能需要300秒来完成创建，所以请记住这一点(在下一个命令中使用time.sleep(300)可能会很有趣)。现在，在这个“技巧”之后，模型已经被正确地注册到模型库中，并且可以使用了。</p><p id="bfac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Databricks和MLFlow都是正在开发的强大而有前途的技术。尤其是MLFlow还是太绿了，一定要有耐心。同时，我希望这个技巧可以帮助您进行云部署。</p><p id="1c51" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mr"> Adrian Perez是一名数据科学家，拥有超级计算并行算法博士学位。你可以在他的</em> <a class="ae ly" href="https://adrianpd.medium.com/" rel="noopener"> <em class="mr">中简介</em> </a> <em class="mr">中查看更多关于他的西班牙语和英语内容。</em></p></div></div>    
</body>
</html>