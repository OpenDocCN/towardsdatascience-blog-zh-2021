<html>
<head>
<title>Google Cloud Storage (GCS) to BigQuery the simple way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google云存储(GCS)让BigQuery变得简单</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/google-cloud-storage-gcs-to-bigquery-the-simple-way-4bb74216b8c8?source=collection_archive---------6-----------------------#2021-04-22">https://towardsdatascience.com/google-cloud-storage-gcs-to-bigquery-the-simple-way-4bb74216b8c8?source=collection_archive---------6-----------------------#2021-04-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fa26" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">因为简单比复杂好(但复杂比复杂好)</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/46c2e41cdefe7aebfb0fb935ba3558e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nloEJKYScLvyi9uA"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">谁不爱一朵简单的云。在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@dianamia?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> C Dustin </a>拍摄的照片</p></figure><p id="e3e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我部署的第一个云功能就是为了完成这个任务。我们每天晚上都有大量CSV文件被放入Google云存储桶中，这些文件需要在BigQuery中进行转换和分析。</p><p id="ffde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">花了一些时间在谷歌上，我来到了<a class="ae ky" href="https://cloud.google.com/architecture/streaming-data-from-cloud-storage-into-bigquery-using-cloud-functions" rel="noopener ugc nofollow" target="_blank">这个</a>操作指南，它有点不同(JSON文件而不是CSV)，但我想我可以稍微调整一下，让它工作。毕竟，在软件和数据工程的世界里，这是一个非常普通的工作流程:找到一些<em class="lv">几乎</em>做你需要的事情，弄清楚它是如何工作的，然后调整代码来做<em class="lv">你需要的事情。而且成功了！我花了一整天全力以赴地工作，但最终我们有了一个正常工作的数据管道，如下所示:</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/257d87ce121058ae5f67a2c6b8d5e647.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6COyTHRigC1pcriTv0lcCw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将数据从谷歌云存储传输到BigQuery。图片来自<a class="ae ky" href="https://cloud.google.com/architecture/streaming-data-from-cloud-storage-into-bigquery-using-cloud-functions" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/architecture/streaming-data-from-cloud-storage-into-big query-using-cloud-functions</a></p></figure><p id="3eef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">三个云存储桶，三个Python云函数，两个PubSub主题，一个Firestore数据库，一个BigQuery数据集，六杯咖啡和一只梨树上的鹧鸪，我们准备好了！总共有十种不同的云资源，所以有十个不同的地方可以检查是否有问题(在某些时候几乎总是会有问题，尽管可能不是以你期望的方式)。</p><p id="0f62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">快进到现在(更多的云功能被开发、调试、部署，并且大部分都被淘汰了……稍后会有更多的介绍),我的想法转向了<a class="ae ky" href="https://github.com/python/peps/blob/master/pep-0020.txt" rel="noopener ugc nofollow" target="_blank">Python的禅</a>，特别是第3和第4点:</p><blockquote class="lx ly lz"><p id="63bf" class="kz la lv lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated">简单比复杂好。</p><p id="278b" class="kz la lv lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated">复杂总比复杂好。</p></blockquote><p id="2d63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是复杂和复杂有什么区别呢？根据剑桥词典:</p><blockquote class="lx ly lz"><p id="ea15" class="kz la lv lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated"><a class="ae ky" href="https://dictionary.cambridge.org/dictionary/english/complex" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">复杂</strong> </a> <strong class="lb iu">(形容词):涉及许多不同但相关的部分</strong></p><p id="7bba" class="kz la lv lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated"><a class="ae ky" href="https://dictionary.cambridge.org/dictionary/english/complicated" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">复杂的</strong> </a> <strong class="lb iu">(形容词):涉及很多不同的部分，以一种难以理解的方式</strong></p></blockquote><p id="6ab5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我看看上面的架构图，它看起来并不复杂。看起来很复杂。</p><p id="cce5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一定有更好的方法。</p><p id="5e9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果是有:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi md"><img src="../Images/153fc42070f8280389f843e25a99d4be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3NsXyxwbNLlTBKrTQdJdYQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">以简单的方式从BigQuery查询GCS数据(图片由作者使用<a class="ae ky" href="https://diagrams.mingrammer.com/" rel="noopener ugc nofollow" target="_blank">图</a></p></figure><p id="104f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事实证明，如果数据在云存储桶中，您根本不需要将数据流式传输或加载到BigQuery中，您只需要使用<a class="ae ky" href="https://cloud.google.com/bigquery/external-data-cloud-storage#creating_and_querying_a_permanent_external_table" rel="noopener ugc nofollow" target="_blank">外部表</a>的魔力。</p><p id="cb92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简单吧？您只需通过UI或<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language" rel="noopener ugc nofollow" target="_blank"> DDL </a>在BigQuery中创建一个新表(本质上是在BigQuery SQL编辑器中用SQL执行管理任务的一种方法)。在UI中，您必须确保将表格类型从默认的<code class="fe me mf mg mh b">Native table</code>更改为<code class="fe me mf mg mh b">External table</code>,因为忘记这样做将导致一个静态表格，该表格不会拾取新数据。</p><p id="9d70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">DDL(数据定义语言)实际上非常简单，在这种情况下:</p><pre class="kj kk kl km gt mi mh mj mk aw ml bi"><span id="3d10" class="mm mn it mh b gy mo mp l mq mr">CREATE OR REPLACE EXTERNAL TABLE `myproject.mydataset.mytable`<br/>OPTIONS (<br/>  format = 'CSV',<br/>  uris = ['gs://mybucket/*.csv']<br/>)</span></pre><p id="0371" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里重要的部分是*。因为这意味着任何出现在bucket中的新文件都会立即出现在BigQuery中。您还可以通过添加不同URIs的列表来聚合多个存储桶中的文件:</p><pre class="kj kk kl km gt mi mh mj mk aw ml bi"><span id="8c1f" class="mm mn it mh b gy mo mp l mq mr">CREATE OR REPLACE EXTERNAL TABLE `myproject.mydataset.mytable`<br/>OPTIONS (<br/>  format = 'CSV',<br/>  uris = ['gs://mybucket01/*.csv', 'gs://mybucket02/*.csv']<br/>)</span></pre><p id="1b31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者通过在URI中包含文件夹路径，从不同的子文件夹创建表:</p><pre class="kj kk kl km gt mi mh mj mk aw ml bi"><span id="4a70" class="mm mn it mh b gy mo mp l mq mr">CREATE OR REPLACE EXTERNAL TABLE `myproject.mydataset.mytable`<br/>OPTIONS (<br/>  format = 'CSV',<br/>  uris = ['gs://mybucket/subfolder/*.csv']<br/>)</span></pre><p id="d42f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">甚至过滤不同文件名:</p><pre class="kj kk kl km gt mi mh mj mk aw ml bi"><span id="b5d5" class="mm mn it mh b gy mo mp l mq mr">CREATE OR REPLACE EXTERNAL TABLE `myproject.mydataset.mytable`<br/>OPTIONS (<br/>  format = 'CSV',<br/>  uris = ['gs://mybucket/filename_stem*']<br/>)</span></pre><p id="f9d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，您<em class="lv">受到每个URI只能使用一个<a class="ae ky" href="https://cloud.google.com/bigquery/external-data-cloud-storage#wildcard-support" rel="noopener ugc nofollow" target="_blank">通配符</a>这一事实的约束，因此，如果您想将不同的文件过滤到不同的表中，并确保可以在BigQuery中查询新数据，不同的文件类型将需要共享一个文件名词干。</em></p><p id="8aac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一步是将文件名添加到BigQuery中。实际上有一个名为_FILE_NAME的<a class="ae ky" href="https://cloud.google.com/bigquery/external-data-cloud-storage#the_file_name_pseudo_column" rel="noopener ugc nofollow" target="_blank">伪列</a>,它将原始文件名传递到外部表中，但是您必须显式地查询(并重命名)它以使其可用。最简单的方法是使用下面的SQL通过UI创建一个视图:</p><pre class="kj kk kl km gt mi mh mj mk aw ml bi"><span id="3755" class="mm mn it mh b gy mo mp l mq mr">SELECT *, <br/>_FILE_NAME AS filename <br/>FROM <!-- -->`myproject.mydataset.mytable`</span></pre><p id="8f93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或通过DDL:</p><pre class="kj kk kl km gt mi mh mj mk aw ml bi"><span id="bd38" class="mm mn it mh b gy mo mp l mq mr">CREATE OR REPLACE VIEW <!-- -->`myproject.mydataset.myview`<br/>AS<br/>SELECT *, <br/>_FILE_NAME AS filename <br/>FROM <!-- -->`myproject.mydataset.mytable`</span></pre><p id="f017" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">厉害！</p><p id="a412" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嗯，也许吧。希望这一切都完美地工作，您的实时数据是可查询的，并且您对自己构建了一个简单、轻量级、无服务器、零维护的数据“管道”感到非常满意(从技术上来说，它甚至不能称为管道，因为您实际上没有移动任何数据)。</p><p id="022c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但事情并不总是这么简单。为什么？</p><p id="33ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个词:图式。</p><p id="caae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果(这是一个很大的假设)模式自动检测能够完美地工作，那么这种方法就非常有效。如果您查看<a class="ae ky" href="https://cloud.google.com/bigquery/docs/schema-detect" rel="noopener ugc nofollow" target="_blank">文档</a>，您会注意到为了推断模式:</p><blockquote class="lx ly lz"><p id="bfb4" class="kz la lv lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated">BigQuery通过在数据源中选择一个随机文件并扫描多达100行数据作为代表性样本来启动推断过程。然后，BigQuery检查每个字段，并尝试根据样本中的值为该字段分配一种数据类型。</p></blockquote><p id="bca4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是如果这100行不能代表所有的数据呢？如果分析的行都是有效的整数，但其他行也包含字母字符？如果BigQuery将类型推断为INT64，这将导致您对数据运行的任何查询都失败，这显然不好。</p><p id="ba02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的朋友，这意味着你可能处于BigQuery模式管理的世界中，一个你可能会也可能不会完好无损(或神志清醒)的兔子洞。或者您可能需要使用另一种方法或外部工具来自动管理模式更改，但是您试图保持简单。你只是想让它稳定可靠地工作。一劳永逸。</p><blockquote class="lx ly lz"><p id="e8f9" class="kz la lv lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated">“你吃了蓝色药丸……故事结束，你在床上醒来，相信你想相信的一切。你吃红色药丸……你呆在<a class="ae ky" href="https://en.wikipedia.org/wiki/Alice%27s_Adventures_in_Wonderland" rel="noopener ugc nofollow" target="_blank">仙境</a>，我让你看看兔子洞有多深。”—墨菲斯，《黑客帝国》(1999年)</p></blockquote><p id="f2f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有一个办法，我的朋友。不吃药。</p><p id="ab2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">处理这种模式挑战(以及系统之间许多不同的数据类型问题)的最简单方法是:</p><ol class=""><li id="b68e" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">创建一个外部表，将<em class="lv">的所有</em>数据类型设置为字符串</li><li id="3bcf" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#safe_casting" rel="noopener ugc nofollow" target="_blank"> SAFE_CAST </a>将所有字段转换为正确的数据类型</li></ol><p id="23ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看起来很简单，对吧。</p><p id="ddcf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是啊，没那么简单。怎么把所有东西都设置成string？这不是UI中的一个选项(但如果是就好了)。如果你有数百列呢？您真的不希望手工编写SQL转换代码，因为a)这将花费很长时间，b)您几乎肯定会在某个地方犯一个(可能永远无法发现的)错误。</p><p id="ef81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有很多简单的变通方法可以做到这一点，但是最好的方法——不需要外部工具，不需要通过API或使用CLI进行交互——是使用一些相对较新的BigQuery功能:脚本。</p><p id="bb95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但那是另一天的主题…</p><p id="30d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望这已经对一些人有所帮助，并消除了(至少一些)你未来生活中的并发症！</p><blockquote class="lx ly lz"><p id="6643" class="kz la lv lb b lc ld ju le lf lg jx lh ma lj lk ll mb ln lo lp mc lr ls lt lu im bi translated">最令人满意的问题是那些当你足够认真地看待它们时就会消失的问题——我，2021</p></blockquote></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><p id="13a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您觉得这(以及其他相关材料)有用和/或有趣，请跟我来！</p><p id="7fce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您还不是会员，请<a class="ae ky" href="https://jim-barlow.medium.com/membership" rel="noopener">加入Medium</a>,从这个活跃、充满活力和激情的数据人社区每月只需5美元就能获得无限的故事。也有很多其他人，但是如果你对数据感兴趣，那么这里就是你要去的地方…</p></div></div>    
</body>
</html>