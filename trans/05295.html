<html>
<head>
<title>Apache Airflow for containerized data-pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集装箱化数据管道的阿帕奇气流</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apache-airflow-for-containerized-data-pipelines-4d7a3c385bd?source=collection_archive---------14-----------------------#2021-05-10">https://towardsdatascience.com/apache-airflow-for-containerized-data-pipelines-4d7a3c385bd?source=collection_archive---------14-----------------------#2021-05-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ce69" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Airflow上使用不同版本的Python运行任务时是否会遇到问题？在本文中，我将解释如何解决这个问题。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/26f78c1c6f308ddcaca1e9086394ccab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NXf6h9ElV5AajbcB"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">弗兰克·麦肯纳在<a class="ae ky" href="https://unsplash.com/s/photos/containers?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="2332" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="c85c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您可能以前听说过Apache Airflow，或者您现在正在使用它来调度您的数据管道。而且，根据您要运行的内容，您的方法是为它使用一个操作符，您使用SparkSubmitOperator调度Spark作业，并使用BashOperator在Airflow正在运行的机器上运行一些东西。当您需要运行Python代码时，事情就变得有趣了。</p><p id="10c6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以再次查阅文档，找到著名且有用的PythonOperator。很直白。您只需将想要运行的Python代码放在那里，它将根据您的DAG的配置运行。您只需要确保您的代码运行在Python版本的Airflow上，并且您的库安装在系统上。</p><p id="8d54" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您的工作流使用Python的次数越多，您使用PythonOperator的次数就越多。您很高兴，因为您能够将Python知识用于所有数据科学任务。Airflow允许您在其中安装Python模块，因此您可以手头上有所有您喜欢的库来做非凡的事情。</p><p id="92a2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在您或您团队中的某个人想要使用新版本的Python或新的库之前，所有这一切都运行良好，此时您已经有许多任务在运行旧版本且不兼容的库，您有两个选择:</p><ul class=""><li id="aca0" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">更新库并更新所有有问题的任务。</li><li id="2407" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">根据所有现有任务使用库的过时版本。</li></ul><p id="949e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们更深入地了解这些选项，并分析第一个选项。您已经有30个任务在使用旧版本的库，因此您和您的团队可以抽出时间，用这些更改来更新库和所有这些作业。这不是一个简单的任务，但你们都做到了。最后，这是值得的，因为您有机会使用库的所有新特性，并且您的代码库是与最新趋势同步的。但是这是不可伸缩的，当你有100个任务在运行，你需要做同样的事情，会发生什么呢？或者仅仅是您的旧任务出于某种原因需要旧版本的库？</p><p id="f6d2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在我们来分析第二种选择，这种选择似乎不那么痛苦。你用一个过时版本的库开发你的任务，然后就结束了。这并不理想，但也许你知道如何用过时的版本完成工作。但同样，这是不可扩展的，一两年后，你继续用一个过时的版本开发，你将面临各种问题，其中之一是你将需要一些新的东西，在这一点上用过时的版本库很难完成，而且你做不到。这真的会挫伤积极性，并且会影响到你和你的团队。最终，你的代码库将不会是一个你可以创新和尝试新事物的快乐地方。</p><p id="fd19" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在让我们想象一个更糟糕的场景，当我们需要更新系统的Python版本或者我们的一个库与Airflow本身不兼容时。这是一个主要的问题，而且非常普遍，尤其是当团队在成长的时候。</p><p id="6cad" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">那么，我们能做些什么来解决这个问题呢？</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="76fb" class="kz la it bd lb lc nn le lf lg no li lj jz np ka ll kc nq kd ln kf nr kg lp lq bi translated">使用容器</h1><p id="d35c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们之前问题的解决方案是使用Docker容器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/d138b1afe29f2692c19100d7630205f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*aRiM5oj8PQPCtrWcdPWMmg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">气流调度集装箱化任务—作者图片</p></figure><p id="10dc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">想象一下，您可以创建一个DAG，其中每个任务都在一个Docker容器中运行，由于容器的原理，您需要安装任何版本的库或您想要用于它的语言。</p><p id="1af2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这将使您能够自主地使用新技术创建任务，而无需承担更新已经运行的任务的负担。</p><p id="0c41" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是我如何才能做到这一点呢？</p><p id="19ef" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们探讨几个选项。</p><h2 id="acc0" class="nt la it bd lb nu nv dn lf nw nx dp lj ma ny nz ll me oa ob ln mi oc od lp oe bi translated">在Kubernetes上安排作业</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/eaede74059fcc734bf379760a3e71b8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*oH-xRQr5wQrCNxdQq6HbXg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">KubernetesPodOperator的气流调度任务—图片由作者提供</p></figure><p id="c795" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果你不知道Kubernetes是什么，你可以去<a class="ae ky" href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="1c47" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通过这种方法，我们在Kubernetes中以pod的形式推出了Docker容器。这些吊舱是短暂的，这意味着一旦任务完成，吊舱被摧毁，它不会使用系统的容量。</p><p id="835a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">因此，每个任务都是一个Docker容器，每个容器都作为一个Pod在Kubernetes上启动。Airflow将日志从Kubernetes拉到任务的UI中，因此任务在哪里运行对您来说是透明的，最后您可以继续正常使用Airflow。</p><p id="e22e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为此，我们使用了<a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow-providers-cncf-kubernetes/stable/operators.html#kubernetespodoperator" rel="noopener ugc nofollow" target="_blank"> KubernetesPodOperator </a>。</p><blockquote class="og oh oi"><p id="c1d5" class="lr ls oj lt b lu mn ju lw lx mo jx lz ok mp mc md ol mq mg mh om mr mk ml mm im bi translated"><code class="fe on oo op oq b"><a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow-providers-cncf-kubernetes/stable/_api/airflow/providers/cncf/kubernetes/operators/kubernetes_pod/index.html#airflow.providers.cncf.kubernetes.operators.kubernetes_pod.KubernetesPodOperator" rel="noopener ugc nofollow" target="_blank">KubernetesPodOperator</a></code>使用Kubernetes API在Kubernetes集群中启动一个pod。通过提供一个图像URL和一个带有可选参数的命令，操作员使用Kube Python客户机来生成一个Kubernetes API请求，该请求可以动态启动这些单独的pod。用户可以使用<code class="fe on oo op oq b">config_file</code>参数指定一个kubeconfig文件，否则操作员将默认为<code class="fe on oo op oq b">~/.kube/config</code>。</p></blockquote><p id="f44b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这是我发现的更通用的解决方案，可以在主要的云提供商甚至本地安排容器化的任务。Kubernetes是作为Azure、AWS、Google Cloud、Linode等平台上的服务提供的。可能是库伯内特公司的解决方案。</p><h2 id="acbf" class="nt la it bd lb nu nv dn lf nw nx dp lj ma ny nz ll me oa ob ln mi oc od lp oe bi translated">在GKE上安排工作(Google Kubernetes引擎)</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/ee57c5ddcb38f2adb2e0bf939375228f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*hap0cY8Wk7XJROoE-y_D1Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">GKE上的气流调度任务——图片由作者提供</p></figure><p id="af10" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果你在谷歌云上，你计划使用的Kubernetes集群是托管版本(GKE)。为了方便起见，合适的操作员是<a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow-providers-google/stable/operators/cloud/kubernetes_engine.html#run-a-pod-on-a-gke-cluster" rel="noopener ugc nofollow" target="_blank">gkestartpoperator</a>。你可以使用KubernetesPodOperator，但最终需要更多的工作来设置所有的环境，如果你在谷歌云上，我认为这是推荐的方法。</p><h2 id="cce7" class="nt la it bd lb nu nv dn lf nw nx dp lj ma ny nz ll me oa ob ln mi oc od lp oe bi translated">ECS(弹性集装箱服务)上的作业调度</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/4db436274cb9189ad041116883987351.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*T8VZQUK4Rv7zMeq0htni9w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ECS上的气流调度任务—图片由作者提供</p></figure><p id="a0bb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在让我们假设你在AWS上，他们提供了一个叫做弹性库本内特服务或EKS的解决方案。如果你要在那里启动任务，你可以使用KubernetesPodOperator。</p><p id="782e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是AWS提供了另一种容器编排服务，称为弹性容器服务或ECS，正如你可能已经猜到的，其中有一个操作符来启动容器化的任务，它被称为<a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow-providers-amazon/stable/operators/ecs.html#ecs-operator" rel="noopener ugc nofollow" target="_blank"> ECSOperator </a>。</p><p id="95b7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在ECS上，没有pod，这个概念有点不同，在那里它们被称为任务。您将在ECS任务中安排气流集装箱化任务。我知道，这听起来令人困惑，但原理和豆荚是一样的，它们是短暂的。因此，一旦气流任务完成，它就不会消耗资源。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="6071" class="kz la it bd lb lc nn le lf lg no li lj jz np ka ll kc nq kd ln kf nr kg lp lq bi translated">考虑</h1><ul class=""><li id="0282" class="ms mt it lt b lu lv lx ly ma or me os mi ot mm mx my mz na bi translated">当您在群集中运行任务时，请确保您的群集拥有所有可用的权限和凭据。如果集群与Airflow运行的集群不同，并且您正在迁移任务，这是您需要考虑的问题。</li><li id="909e" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">运行任务所需的额外Kubernetes或ECS群集的成本不容小觑。你一定要考虑到这一点。</li><li id="b11d" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">一个是我们之前用来在Kubernetes上运行任务的KubernetesPodOperator，另一个是Kubernetes Executor，最后一个是使用Kubernetes来运行Airflow本身。请确保你不要混淆这些，有时网上有很多信息可能会使这种情况发生。</li><li id="76f1" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">您不一定需要在Kubernetes或ECS上运行Airflow本身，您可以在外部集群中调度任务。</li></ul></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="7da2" class="kz la it bd lb lc nn le lf lg no li lj jz np ka ll kc nq kd ln kf nr kg lp lq bi translated">结论</h1><p id="fabb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这不是银弹，因为在所有的技术决策中，总是有一个权衡。是的，容器允许你有更好的隔离，但也给你更多的操作复杂性。如果您想让这种方法为您工作，您需要有一个CI/CD管道，这样部署一个任务的新版本就不会成为负担。</p><p id="7a64" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">尽管不受我们可以用来完成任务的库或语言的限制很酷。这通常是人们所忽略的，但是能够试验和尝试新事物对团队的士气是一个主要的优势。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="a3a9" class="kz la it bd lb lc nn le lf lg no li lj jz np ka ll kc nq kd ln kf nr kg lp lq bi translated">资源</h1><ul class=""><li id="d0c8" class="ms mt it lt b lu lv lx ly ma or me os mi ot mm mx my mz na bi translated"><a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow-providers-cncf-kubernetes/stable/operators.html#howto-operator-kubernetespodoperator" rel="noopener ugc nofollow" target="_blank"> KubernetesPodOperator </a></li><li id="dd39" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow-providers-google/stable/operators/cloud/kubernetes_engine.html#run-a-pod-on-a-gke-cluster" rel="noopener ugc nofollow" target="_blank"> GKEStartPodOperator </a></li><li id="64e5" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow-providers-amazon/stable/operators/ecs.html" rel="noopener ugc nofollow" target="_blank"> ECSOperator </a></li></ul></div></div>    
</body>
</html>