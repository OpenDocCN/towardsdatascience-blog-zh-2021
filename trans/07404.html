<html>
<head>
<title>Version control Big Query with Terraform (with CI/CD too)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform的版本控制大查询(也使用CI/CD)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/version-control-big-query-with-terraform-with-ci-cd-too-a4bbffb25ad9?source=collection_archive---------5-----------------------#2021-07-06">https://towardsdatascience.com/version-control-big-query-with-terraform-with-ci-cd-too-a4bbffb25ad9?source=collection_archive---------5-----------------------#2021-07-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2891" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">确保大查询中的所有更改都是负责任的</h2></div><h1 id="bed0" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">介绍</h1><p id="ea7c" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">当人们在没有通知团队其他成员的情况下开始改变视图时，使用大查询和创建视图的团队工作可能会变得混乱。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/206df378cef4fad1a666a4e548921877.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*5PsJgpP4QVcrgLXbgn6nlQ.png"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">该片段取自作者大查询视图</p></figure><p id="53c3" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">一些团队习惯于在视图顶部使用注释，甚至是电子表格来记录变更。显然，从长远来看，这会导致一个问题，因为人们可能会忘记评论或没有正确地做。</p><p id="0f1a" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">事不宜迟，我如何对我的大查询进行版本控制，以确保我可以跟踪并在需要时回滚更改，并与我的团队一起更好地管理项目。</p><p id="5fb0" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">为了实现这一点，我们将研究两种技术，即<a class="ae mk" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>(基础设施即代码)，以及您选择的版本控制系统(Github、Gitlab等)。我们今天将使用Github！如果你从未听说过Terraform，不要太担心，这篇文章也可以算是“GCP terra form的快速介绍”!</p><h1 id="f3cc" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">快速跳跃</h1><ol class=""><li id="1225" class="ml mm iq kz b la lb ld le lg mn lk mo lo mp ls mq mr ms mt bi translated"><a class="ae mk" href="#f197" rel="noopener ugc nofollow">入门</a></li><li id="3e0e" class="ml mm iq kz b la mu ld mv lg mw lk mx lo my ls mq mr ms mt bi translated"><a class="ae mk" href="#a26d" rel="noopener ugc nofollow">初始化地形环境</a></li><li id="54b6" class="ml mm iq kz b la mu ld mv lg mw lk mx lo my ls mq mr ms mt bi translated"><a class="ae mk" href="#a26d" rel="noopener ugc nofollow">在Terraform中创建数据集和视图</a></li><li id="a389" class="ml mm iq kz b la mu ld mv lg mw lk mx lo my ls mq mr ms mt bi translated"><a class="ae mk" href="#faba" rel="noopener ugc nofollow">版本控制和设置</a></li><li id="6e19" class="ml mm iq kz b la mu ld mv lg mw lk mx lo my ls mq mr ms mt bi translated"><a class="ae mk" href="#1d7a" rel="noopener ugc nofollow"> git提交，git推送</a></li><li id="3ee3" class="ml mm iq kz b la mu ld mv lg mw lk mx lo my ls mq mr ms mt bi translated"><a class="ae mk" href="#78d8" rel="noopener ugc nofollow">做出改变并测试我们是否达到了目标</a></li><li id="5daa" class="ml mm iq kz b la mu ld mv lg mw lk mx lo my ls mq mr ms mt bi translated"><a class="ae mk" href="#9675" rel="noopener ugc nofollow">结论</a></li></ol><h1 id="f197" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">入门指南</h1><p id="7a97" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这一部分将用于尚未设置的环境。<br/>入门不多！你只需要安装:<br/> 1。<a class="ae mk" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank">地形</a>。他们提供了一个很好的指南，所以只要确保你跟着做，你应该能够在你的终端/命令提示符<br/> 2中调用<code class="fe mz na nb nc b">terraform</code>。饭桶。请为您的操作系统安装git，这样我们就可以执行基本命令，如<code class="fe mz na nb nc b">git push</code></p><p id="6156" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated"><strong class="kz ir">TL；步骤的DR</strong></p><ol class=""><li id="390b" class="ml mm iq kz b la mf ld mg lg nd lk ne lo nf ls mq mr ms mt bi translated">在GCP项目上创建服务帐户</li><li id="8cd9" class="ml mm iq kz b la mu ld mv lg mw lk mx lo my ls mq mr ms mt bi translated">为服务帐户创建并下载JSON密钥</li><li id="6cac" class="ml mm iq kz b la mu ld mv lg mw lk mx lo my ls mq mr ms mt bi translated">设置Google云存储(GCS)来存储地形状态</li><li id="7038" class="ml mm iq kz b la mu ld mv lg mw lk mx lo my ls mq mr ms mt bi translated">授予服务帐户在该存储桶中读取、写入和创建对象的权限</li><li id="8b4c" class="ml mm iq kz b la mu ld mv lg mw lk mx lo my ls mq mr ms mt bi translated">设置Terraform以连接到GCS</li></ol><p id="29ef" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated"><strong class="kz ir">首次创建服务账户和密钥的详细信息<br/>和</strong></p><p id="eb34" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">Terraform将代表我们使用一个叫做服务账户的东西与我们的谷歌云平台(GCP)项目进行互动。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/313f515f5d39e83b7b5acc81d2cebd62.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*A0oS0O2td0JD0zla7BQlTQ.png"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">该片段摘自授予IAM角色的作者GCP项目</p></figure><p id="ec6f" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">继续用谷歌提供的<a class="ae mk" href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" rel="noopener ugc nofollow" target="_blank">教程</a>创建你的GCP项目。当您到达选择IAM角色的提示时(截至2021年6月的教程中的步骤7)，出于本教程的原因，您需要授予<strong class="kz ir"> <em class="nh">大查询数据编辑器</em> </strong>角色，如上面的代码片段所示。随着您的进步，请随意将权限缩小到仅需要的内容。单击下一步和完成。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/b4708752b0608e9316bc25982d42abe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/1*vSPRkOasevNsmdA_TLFaog.png"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">该片段摘自作者GCP创建新密钥的项目</p></figure><p id="47f7" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">创建服务帐户后，单击服务帐户，您将看到一个类似于上面代码片段的屏幕。选择<em class="nh">键- &gt;添加键- &gt;创建新键。</em>接下来会出现一个弹出窗口，选择JSON，点击create。它将下载一个JSON文件。保管好它！</p><p id="97a2" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated"><strong class="kz ir">创建一个Google云存储(GCS)来存储地形状态</strong></p><p id="2e97" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">Terraform state基本上记住并告诉Terraform你的基础设施现在是什么样子。我建议阅读<a class="ae mk" href="https://www.terraform.io/docs/language/state/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform文档</a>来更好地理解它。我们将使用GCS来存储状态，主要有两个原因:<br/> -在Github上共享状态通常不是一个好的做法，因为它可能包含敏感信息<br/> -您不需要担心丢失它和重建基础设施</p><p id="cb25" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">因此，让我们开始按照这里的教程<a class="ae mk" href="https://cloud.google.com/storage/docs/creating-buckets" rel="noopener ugc nofollow" target="_blank">创建一个GCS bucket</a>。记住您创建的存储桶名称，因为我们稍后将使用它。在该存储桶上，选择permission并添加之前创建的具有Storage Admin权限的服务帐户。你可以按照这个<a class="ae mk" href="https://cloud.google.com/storage/docs/access-control/using-iam-permissions" rel="noopener ugc nofollow" target="_blank">教程</a>去做。</p><h1 id="a26d" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">初始化地形环境</h1><p id="b8c5" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">创建一个工作文件夹，在这个文件夹中，我们将创建一个名为<code class="fe mz na nb nc b">providers.tf</code>的文件。我通常使用Visual Studio代码来管理我的Terraform配置。tf是一个Terraform配置文件，我们所有的Terraform内容都将存放在其中。平台提供商基本上是你将要与之合作的平台，无论是微软Azure、GCP、AWS还是其他。我将这个文件命名为<code class="fe mz na nb nc b">providers.tf,</code>,因为这是我保存所有提供者配置的地方，你可以随意命名，但是提供者会是一个更好的标准。</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="01a0" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">将以上内容粘贴到您的<code class="fe mz na nb nc b">providers.tf</code>中。在名为terraform {…}的第一个“块”中，我们告诉terraform将我们的状态存储在GCS中。将<em class="nh"> YOUR_BUCKET_NAME </em>更改为您之前创建的BUCKET名称。前缀基本上只是桶内的文件夹。<br/>下一个称为provider的块表示我们正在使用<a class="ae mk" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/getting_started" rel="noopener ugc nofollow" target="_blank"> Terraform Google Provider </a>配置，并用您的<em class="nh"> YOUR_PROJECT_NAME </em>对其进行初始化。</p><p id="ec81" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">现在，Terraform还不能读取您的GCS存储，这就是我们的服务帐户发挥作用的地方。将有一些方法向Terraform声明您的服务帐户，但是我们将使用的方法将在稍后在Github上设置CI/CD时有用。我们将把环境变量设置为我们先前下载的JSON文件，所以把那个JSON文件也移到您的项目文件夹中。在同一文件夹中，打开终端/命令提示符，并将环境设置为:</p><p id="e37f" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">Windows用户:</p><pre class="lu lv lw lx gt nl nc nm nn aw no bi"><span id="0e64" class="np kg iq nc b gy nq nr l ns nt">set GOOGLE_CREDENTIALS=JSON_FILE_NAME.json</span></pre><p id="136d" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">Linux/macOS:</p><pre class="lu lv lw lx gt nl nc nm nn aw no bi"><span id="d211" class="np kg iq nc b gy nq nr l ns nt">export GOOGLE_CREDENTIALS=JSON_FILE_NAME.json</span></pre><p id="bae1" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">Terraform上的Google provider将自动从环境变量中检测服务帐户密钥。现在您的第一个Terraform命令来初始化环境了！</p><pre class="lu lv lw lx gt nl nc nm nn aw no bi"><span id="04a8" class="np kg iq nc b gy nq nr l ns nt">terraform init</span></pre><p id="9298" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">如果一切顺利，您应该会在控制台上看到许多绿色文本。GCS现在应该显示一个名为state的文件夹和该文件夹中一个以. tfstate结尾的文件。</p><p id="9b3d" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">然而，如果你遇到了错误，不要担心，仔细阅读是什么错误。如果是关于NewClient()失败的问题，请确保您的环境变量被正确地设置到JSON文件中。如果是关于拒绝访问，请确保您在Google IAM页面上为您的服务帐户提供了适当的访问权限。</p><h1 id="f80a" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">创建我们的第一个数据集和视图</h1><p id="e35b" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">太好了！现在我们已经初始化了我们的环境，我们可以开始使用Terraform管理大型查询。</p><p id="c709" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">就像我们如何用<code class="fe mz na nb nc b">providers.tf</code>来管理我们的提供商一样，我们将创建<code class="fe mz na nb nc b">bigquery.tf</code>来管理我们的大查询。您甚至可以深入到数据集、表和视图的3个独立文件，但目前，我们将只创建<code class="fe mz na nb nc b">bigquery.tf</code>。我们将在<code class="fe mz na nb nc b">bigquery/views/vw_aggregrated.sql</code>创建另一个文件夹来存储我们的视图SQL。</p><pre class="lu lv lw lx gt nl nc nm nn aw no bi"><span id="3b7e" class="np kg iq nc b gy nq nr l ns nt"># Some demo content in vw_aggregrated.sql</span><span id="6885" class="np kg iq nc b gy nu nr l ns nt">SELECT <br/>   LoadDate, Origin, Destination, COUNT(ID) AS counts<br/>FROM<br/>   `terraform-testing-gcp.demoset.DemoTable`<br/>GROUP BY<br/>   1, 2, 3</span></pre><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="6594" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">将上面的代码复制粘贴到<code class="fe mz na nb nc b">bigquery.tf</code>中。为了理解发生了什么，第一个资源包含两个参数，第一个是资源类型<em class="nh">(Google _ big query _ dataset)</em>，第二个是ID <em class="nh"> (views) </em>您可以自己定义。你可以在这里找到谷歌提供商可用的资源。我们正在美国使用ID为<em class="nh">“views”</em>的<em class="nh">“Google _ big query _ dataset”</em>块创建数据集。我已经给了它一个描述和一些标签。标签是完全可选的，你可以删除它们。</p><p id="a1d2" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">接下来，我们创建一个资源<em class="nh">“Google _ big query _ table”</em>，ID为<em class="nh">“VW _ aggregated”</em>。对于dataset_id，它引用我们之前创建的<em class="nh">视图</em> dataset_id。这一次，由于我们正在创建一个视图，我们将不得不打开一个视图块，如教程<a class="ae mk" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/bigquery_table#view" rel="noopener ugc nofollow" target="_blank">这里</a>所述。我们将传入的第一个参数是我们想要使用的SQL。有两种方法可以做到这一点，一种是直接将SQL键入bigquery.tf本身，例如:<code class="fe mz na nb nc b">query = "SELECT * FROM ... WHERE 1 = 1</code>。然而，我们正在研究可维护性，所以我们已经在<code class="fe mz na nb nc b">bigquery/views/vw_aggregated.sql</code>的一个文件夹中定义了我们的SQL。</p><p id="860f" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">好吧！让我们运行一个命令来标准化我们的Terraform代码格式，然后试运行我们的配置。Terraform plan将基本上“计划”并让我们知道什么资源将被创建/删除/修改等。</p><pre class="lu lv lw lx gt nl nc nm nn aw no bi"><span id="9762" class="np kg iq nc b gy nq nr l ns nt">terraform fmt<br/>terraform plan</span></pre><p id="a677" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">如果你看到<code class="fe mz na nb nc b">x resource to be created</code>，x是一个数字，你就可以走了！如果您正在获取<code class="fe mz na nb nc b">x resource to be deleted</code>，请检查并验证这是否是有意的。一旦确认这是预期的操作，运行<code class="fe mz na nb nc b">terraform apply</code>应用配置。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/003e50ae8e0fe20414da1ddece0fb9cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/1*4fSJbOf-sbr-c0Xl-M0zEA.png"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">Terraform创建的author大查询数据集的片段</p></figure><p id="aa4d" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">如果操作正确，检查您的大查询UI，您应该看到您在Terraform配置中定义的资源已创建！在我们的例子中，创建了一个名为<em class="nh">视图</em>和<em class="nh"> vw_aggregated </em>的数据集。</p><h1 id="faba" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">版本控制设置</h1><p id="bd1f" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在我们验证了我们的Terraform配置按预期工作后，是时候对配置的变更进行版本控制了。第一步是创建一个Github项目，并将其设置为私有repo，因为您不希望您的基础设施设置公开:)。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/bd9e2102f5bbb46111c0ecb5fb624912.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/1*ZGB6T21ukWsKzC9mYyNfcg.png"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">作者Github秘密创作画面片段</p></figure><p id="274a" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">按照Github的指南创建一个名为<code class="fe mz na nb nc b">GOOGLE_CREDENTIALS</code>的秘密。这个秘密的值将是我们刚才用来设置环境变量的JSON密钥文件的内容。只需用文本编辑器打开JSON文件，并将内容复制粘贴到秘密值字段中。它应该类似于上面的代码片段。</p><p id="03bd" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">我们将保持的“秘密”是服务帐户密钥，以允许Github动作在每次我们提交更改时帮助应用我们的Terraform配置。<br/> Github secret在我们的场景中非常棒，原因有两个:<br/> -我们不需要提交我们的JSON密钥文件，其他贡献者/成员可以下载和滥用<br/> - Github操作将应用配置，并且您不需要向贡献者分发具有写权限的服务帐户。这迫使贡献者/成员总是提交他们的工作和变更，以便将其应用到生产中</p><p id="3deb" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">接下来，我们需要告诉Github Actions，一旦提交发生，需要做什么。创建一个名为<code class="fe mz na nb nc b">.github/workflows</code>的文件夹，并将以下内容粘贴到新创建的名为<code class="fe mz na nb nc b">terraform.yml</code>的目录中的一个文件中。</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="2cdf" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">在推送至Github之前，我们需要排除一些文件或文件夹。在根文件夹上，创建一个名为<code class="fe mz na nb nc b">.gitignore</code>的文件，并粘贴以下内容。这将排除我们之前复制到目录中的JSON键，以及任何状态文件(如果有的话)。也可以随意添加自己的文件！</p><pre class="lu lv lw lx gt nl nc nm nn aw no bi"><span id="3448" class="np kg iq nc b gy nq nr l ns nt">*.json<br/>*.tfstate</span></pre><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/147582334852c08c8597abd161867064.png" data-original-src="https://miro.medium.com/v2/resize:fit:464/format:webp/1*re1EqNeOylmd9LmOwEOnVA.png"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">作者项目目录的一个片段</p></figure><p id="451b" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">对于那些仍然对我们之前创建的许多文件感到困惑的人来说，如果你完全按照这个教程来做(忽略<code class="fe mz na nb nc b">vw_origin_KUL.sql</code>)，你的目录应该是这样的。</p><h1 id="1d7a" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">git提交，git推送</h1><p id="e6ad" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">黄金时刻来了。以下命令将初始化git并将您的配置推送到Github。理想情况下，如果运行良好，Github Actions将在您的代码被推送的那一刻开始运行。</p><pre class="lu lv lw lx gt nl nc nm nn aw no bi"><span id="10e2" class="np kg iq nc b gy nq nr l ns nt">terraform fmt<br/>git add .<br/>git remote add origin LINK_TO_YOUR_GIT_REPO<br/>git branch -M main<br/>git commit -m "Initial commit"<br/>git push -u origin main</span></pre><p id="c46c" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated"><em class="nh"> git add </em>将在该目录中添加新的和已更改的文件和文件夹，除了那些在<code class="fe mz na nb nc b">.gitignore</code>中定义的。<br/><em class="nh">git remote add originhttps://github.com/…</em>会定义你当前目录应该属于的库。<br/> <em class="nh"> git branch -M main </em>将创建一个名为main<br/><em class="nh">git commit-M " YOUR _ MESSAGE _ HERE "</em>将创建一个“changelog”，一个好的消息将帮助你自己和你团队中的其他人识别出什么被更改了，而无需阅读太多代码<br/><em class="nh">git push-u origin main</em>将把你的代码推送到主分支。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi ny"><img src="../Images/f917fe8966d7d353c7c2ceb9cb818602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eqT2JaphC4rVJF4SD_lyJg.png"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">作者Github操作工作流页面的片段</p></figure><p id="7a5e" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">现在检查你的Github库，你应该在那里看到你的代码。单击Actions选项卡，您将看到我们之前在<code class="fe mz na nb nc b">.github/workflows/terraform.yml</code>创建的工作流。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi od"><img src="../Images/601c541b42eae6e16afcb2f5aca9798f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*c3eFy8vUbUHDRD9mvflt6Q.png"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">作者Github操作工作流详细信息的片段</p></figure><p id="d030" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">如果你看到一个绿色或橙色的勾号在跑，你就可以走了！如果出现错误，只需点击进入工作流程并阅读每个步骤的日志，因为错误很容易缩小范围。如你所见，这些步骤是我们在<code class="fe mz na nb nc b">.github/workflows/terraform.yml</code>中定义的。</p><h1 id="78d8" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">做出改变并测试我们是否达到了目标</h1><p id="16e6" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们几乎完成了整个管道！接下来是测试我们计划实现的目标是否已经实现。让我们对<code class="fe mz na nb nc b">bigquery/views/vw_aggregated.sql</code>做一些改变。我已将我的查询更改为</p><pre class="lu lv lw lx gt nl nc nm nn aw no bi"><span id="c416" class="np kg iq nc b gy nq nr l ns nt"># Some demo content in vw_aggregrated.sql</span><span id="4f3e" class="np kg iq nc b gy nu nr l ns nt">SELECT <br/>   CAST(LoadDate AS DATE) AS LoadDate, <br/>   Origin, Destination, COUNT(ID) AS counts<br/>FROM<br/>   `terraform-testing-gcp.demoset.DemoTable`<br/>GROUP BY<br/>   1, 2, 3</span></pre><p id="fa59" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">现在，我们将需要添加任何已更改的内容，创建一个changelog消息，然后将其推送到我们的存储库，以便Github Actions可以为我们应用它。总是<code class="fe mz na nb nc b">terraform fmt</code>保证代码标准化。</p><pre class="lu lv lw lx gt nl nc nm nn aw no bi"><span id="084b" class="np kg iq nc b gy nq nr l ns nt">terraform fmt<br/>git add .<br/>git commit -m "Updated vw_aggregated to CAST LoadDate"<br/>git push origin main</span></pre><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/849b1bd666c3f89485addd83c9f9e5af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*I9XXjWA_XQpjSIYCLaErcA.png"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">作者Github commit的一个片段</p></figure><p id="21d5" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">检查回购，我们可以看到我所做的更改(<em class="nh"> jonathanlawhh </em>)，如上面的片段所示。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi of"><img src="../Images/06b8b68e114c5a85a01905045185e0bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VADsyiXtPLnuxk6HJ800yw.png"/></div></div><p class="mb mc gj gh gi md me bd b be z dk translated">更新后的作者Github操作工作流片段</p></figure><p id="d29c" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">检查“Actions”选项卡，我们可以看到该提交的工作流已成功完成！</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div class="gh gi og"><img src="../Images/fd13bf899e933a56564cb3fd084ad4f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/1*BlqZzhHv1cBIemmx-f_MYw.png"/></div><p class="mb mc gj gh gi md me bd b be z dk translated">更新后的作者大查询视图片段</p></figure><p id="d511" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">最后，我们可以看到大查询中的视图已经按照预期进行了更新。</p><h1 id="9675" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">结论</h1><p id="3e93" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">总之，我们首先建立一个Github存储库，初始化一个Terraform环境，并将Terraform配置推送到Github存储库。与此同时，我们还准备了一个CI/CD配置<code class="fe mz na nb nc b">terraform.yml</code>，以便在我们推出变更时帮助部署我们的配置。至此，可以有把握地说，我们已经实现了使用Terraform对大查询进行版本控制的目标，并实现了对我们项目的持续集成和部署。</p><p id="edf9" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">希望这篇文章足以启动您的实现，并帮助您更多地了解Terraform可以实现什么！当然，实现可以根据您的环境进行改进。</p><p id="f10b" class="pw-post-body-paragraph kx ky iq kz b la mf jr lc ld mg ju lf lg mh li lj lk mi lm ln lo mj lq lr ls ij bi translated">如果您有任何问题，请随时联系我，甚至通过<br/> Messenger widget向我问好:<a class="ae mk" href="https://jonathanlawhh.com" rel="noopener ugc nofollow" target="_blank">https://jonathanlawhh.com</a><br/>电子邮件:jon_law98@hotmail.com</p></div></div>    
</body>
</html>