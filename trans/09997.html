<html>
<head>
<title>A love-hate relationship with Databricks Notebooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">对Databricks笔记本爱恨交加</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/databricks-notebooks-a-love-hate-relationship-8f73e5b291fb?source=collection_archive---------3-----------------------#2021-09-21">https://towardsdatascience.com/databricks-notebooks-a-love-hate-relationship-8f73e5b291fb?source=collection_archive---------3-----------------------#2021-09-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4fa6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在这篇文章中，我给出了我对这个工具的看法，以及根据你的团队的技能和成熟度，你可以使用它来交付解决方案的各种方法。</h2></div><p id="23d9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">自从两年前我开始使用Databricks以来，我一直对笔记本有一种奇怪的又爱又恨的关系。你们中有些人可能也有同感。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/ddc7c7c0befdfb8dc325de645e3070a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NzGgHINYZHaOIWke"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">凯利·西克玛在<a class="ae lr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="609a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">笔记本正在使“大数据”民主化</strong></h1><p id="5d41" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">笔记本电脑将留在数据领域。从经典的Jupyter笔记本电脑到Databricks和Azure Synapse Analytics等其他SaaS解决方案推动的“在生产中运行”方法。</p><p id="678a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我曾经认为笔记本是一个超级强大的工具，它可以让没有或很少编程知识的开发人员构建复杂的数据集和ML模型。</p><p id="7d1d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看到它们在一些云提供商(如Azure)中与Data Factory等工具集成得如此之好，让ETL编排变得超级简单、可视化和直观，这真是太棒了。特别提及笔记本参数和输出，它们确实有助于模块化数据管道。</p><p id="3352" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Databricks笔记本很容易成为大多数非高级数据用户在云上运行数据处理代码的事实方式。事实是，Databricks消除了让代码在云上运行的大部分摩擦和复杂性，因为使用Databricks的用户已经在使用它了。因此，没有更多的“但它在我的笔记本电脑上工作”这样的借口。</p><p id="5345" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总之，多亏了笔记本电脑，用户可以非常快速地传递价值，而不会遇到工程瓶颈。不幸的是，所有这些好的特性都是有代价的。</p><h1 id="12b0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">易用性是一把双刃剑</strong></h1><p id="ab08" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">为了能够在笔记本电脑上运行代码，您需要一个集群来进行计算。因此，即使用户只想使用Pandas编写一些简单的数据处理代码，您也必须为集群虚拟机和dtu付费。如果团队中的任何人都有权创建集群，那么也很容易以过大的集群而告终，并毫无理由地增加成本。</p><blockquote class="mp mq mr"><p id="094c" class="kf kg ms kh b ki kj jr kk kl km ju kn mt kp kq kr mu kt ku kv mv kx ky kz la ij bi translated">“这个数据集非常大，大约有4GB但是不要担心，我已经用3个工人创建了这个群集，所以我认为这足以启动，但是如果需要，我们可以在以后添加更多。顺便说一下，我用熊猫是因为我不想学习PySpark :D”</p></blockquote><p id="fa2a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们必须记住，Databricks主要是作为一个托管平台构建的，用于在云上运行Spark，而不是在单个节点上运行代码。直到一年前，甚至没有一个单节点集群选项可用(只有将workers设置为0的变通方法)。</p><p id="a38f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">另一方面，当你需要做的不仅仅是SQL查询或一些简单的脚本时，你开始感觉到使用笔记本的痛苦。</p><p id="2eca" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">试图将良好的编程实践应用到笔记本中是相当困难和令人沮丧的。没有办法用基本的“import”命令导入你自己的类，你被迫使用官方的hacky变通办法，如“%run”从其他笔记本加载代码。调试封装的代码简直是一场噩梦，因为没有调试器，唯一的方法就是使用print语句(欢迎来到80年代)。关于单元测试，嗯……你需要非常有创造力！</p><p id="07b2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这时，你会开始考虑跳到一个合适的IDE，比如PyCharm或者VS Code(在Python的情况下)，重新开始编写健壮的软件。可能是个好决定。不幸的是，一旦您执行了这一步，设置的复杂性就会增加，结果，您可能会失去一些人。不是每个人都有处理这种复杂性所需的软件工程技能。</p><h1 id="8a75" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">找到最佳点</strong></h1><p id="1b85" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">选择何种方式编写代码将取决于开发团队的成熟度和技能。越是成熟和先进，他们就越有能力应对复杂性。从评估开始，以衡量当前的团队技能。大多数团队成员主要是具有多年关系数据库工作经验的SQL开发人员，但很少或根本没有编程技能吗？还是大部分团队成员都非常精通软件工程和CI/CD实践？或许介于两者之间？</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mw"><img src="../Images/9a5048eb0c96052392cd089cee7ed0b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l27xgE4YGXvQOvM0hbWUwg.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者图片</p></figure><p id="7d49" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你想建立一个面向未来的项目，找到适合所有团队成员大部分能力的中庸工作方式是必须的。否则事情会出错。这并不是第一次因为创建项目的人离开了公司，而团队中没有其他人有能力让项目继续下去而导致项目中断。</p><h1 id="702c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">选择适合您团队的方法</strong></h1><p id="c4ba" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">在与不同技能的人一起参与不同的项目并分析了不同的可能性之后，我想到了下面一套方法，你可以根据你的团队能够处理的复杂程度来应用这些方法。</p><h2 id="25cd" class="mx lt iq bd lu my mz dn ly na nb dp mc ko nc nd me ks ne nf mg kw ng nh mi ni bi translated"><strong class="ak">选项1:仅笔记本电脑</strong></h2><p id="0423" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">Databricks中开箱即用的代码开发体验。只需在单元格中编写代码，必要时结合语言。</p><p id="3204" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">提供一套笔记本模板对加快解决方案的开发非常有帮助。此外，它将有助于建立一个标准的代码组织，有助于保持代码的有序性和易读性。</p><ul class=""><li id="1767" class="nj nk iq kh b ki kj kl km ko nl ks nm kw nn la no np nq nr bi translated"><strong class="kh ir">优点:</strong>对所有数据开发人员来说简单明了。</li><li id="39e3" class="nj nk iq kh b ki ns kl nt ko nu ks nv kw nw la no np nq nr bi translated"><strong class="kh ir">缺点:</strong>没有IDE开发，没有代码重用，只有试错调试，没有单元测试，代码会很快变得乱七八糟。</li></ul><h2 id="a8e9" class="mx lt iq bd lu my mz dn ly na nb dp mc ko nc nd me ks ne nf mg kw ng nh mi ni bi translated"><strong class="ak">选项2:笔记本+作为笔记本的一套实用功能</strong></h2><p id="3d01" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">与前一个选项相同，增加了一组捆绑在笔记本中的实用程序功能，可以从其他笔记本导入(%run)。这些功能可以包括从SQL数据库或增量表中读取或写入数据的功能…任何可以轻松重用的功能。</p><p id="4c4a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">与以前几乎相同的复杂性，一切都保留在Databricks工作区内，实用程序功能对所有开发人员完全透明，如果需要，可以在现场轻松更改。</p><p id="5be8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，为一些笔记本提供关于如何使用该实用程序功能的示例是非常有帮助的，或者更好的是，将它们合并到笔记本模板中。</p><ul class=""><li id="ff7f" class="nj nk iq kh b ki kj kl km ko nl ks nm kw nn la no np nq nr bi translated"><strong class="kh ir">优点:</strong>对所有数据开发人员来说简单明了，对效用函数代码重用，效用函数透明，易于现场更改。</li><li id="9809" class="nj nk iq kh b ki ns kl nt ko nu ks nv kw nw la no np nq nr bi translated"><strong class="kh ir">缺点:</strong>没有IDE开发，只有试错调试，没有单元测试，运行笔记本导入代码感觉不对。</li></ul><h2 id="731e" class="mx lt iq bd lu my mz dn ly na nb dp mc ko nc nd me ks ne nf mg kw ng nh mi ni bi translated"><strong class="ak">方案三:笔记本+一套实用功能代码包</strong></h2><p id="6a78" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">与前面的方法相比，主要的区别是捆绑效用函数的方式。在这种情况下，开发一个可以使用“import”语句导入的自定义代码包。</p><p id="f6d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，复杂性增加得更多，因为解决方案的代码不仅存在于Databricks工作区中。代码包需要在本地机器上开发，这为使用IDE、合适的调试引擎甚至包括单元测试提供了可能性。这也意味着，将代码提交到Git存储库，并包含一个CI/CD管道来发布包，以便可以从Databricks笔记本中使用它。</p><p id="e89b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">至于其余的开发人员，他们只需要相信这些实用功能完成了他们的工作，并专注于其余的逻辑。同样，提供一些使用示例将对代码包的采用非常有帮助。</p><ul class=""><li id="16cf" class="nj nk iq kh b ki kj kl km ko nl ks nm kw nn la no np nq nr bi translated"><strong class="kh ir">优点:</strong>通过IDE开发、适当的调试和单元测试对实用函数进行代码重用，使用“import”语句导入代码。</li><li id="e0ce" class="nj nk iq kh b ki ns kl nt ko nu ks nv kw nw la no np nq nr bi translated"><strong class="kh ir">缺点:</strong>代码包需要通过CI/CD构建和发布，代码变得不那么透明，用户只需信任它的功能。</li></ul><h2 id="eccc" class="mx lt iq bd lu my mz dn ly na nb dp mc ko nc nd me ks ne nf mg kw ng nh mi ni bi translated"><strong class="ak">选项4:笔记本作为“主”功能+转换&amp;实用功能作为代码包</strong></h2><p id="75f1" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">在这种情况下，我们在复杂性上更进一步。数据转换的逻辑现在也可以成为代码包的一部分。使用笔记本作为编排函数运行和注入参数的“主要”代码。</p><p id="0385" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种方法带来了充分的测试可能性，因为所有的代码都可以在本地机器上开发。另一方面，缺乏软件工程技能的数据开发人员被排除在开发之外。但是，它们仍然可以提供SQL查询作为参数传递给<em class="ms"> spark.sql()。</em></p><p id="83e6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种设置的另一个缺点是在本地机器上工作时失去了与Hive Metastore的连接。因此，如果你的组织大量使用它，这可能是一个大问题。变通办法是使用Databricks Connect将您的代码发布到Databricks集群(如果您可以忍受<a class="ae lr" href="https://docs.databricks.com/dev-tools/databricks-connect.html#limitations" rel="noopener ugc nofollow" target="_blank">已知的限制</a>)，或者，在您的本地机器中存储数据集的样本，也可以用样本模拟Hive Metastore。</p><ul class=""><li id="46a0" class="nj nk iq kh b ki kj kl km ko nl ks nm kw nn la no np nq nr bi translated"><strong class="kh ir">优点:</strong>代码可重用性、IDE开发、正确的调试，以及对所有代码的单元测试，将笔记本电脑作为可用于编排的“主要”设备。</li><li id="9a5e" class="nj nk iq kh b ki ns kl nt ko nu ks nv kw nw la no np nq nr bi translated"><strong class="kh ir">缺点:</strong>代码包需要通过CI/CD构建和发布，不适合没有软件工程技能的人，无法从本地机器访问Databricks Hive Metastore。</li></ul><h2 id="bf37" class="mx lt iq bd lu my mz dn ly na nb dp mc ko nc nd me ks ne nf mg kw ng nh mi ni bi translated"><strong class="ak">选项5:仅代码包</strong></h2><p id="5e1b" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">这是硬核的方式。在本地机器上将所有逻辑编写在一个代码包中。你还记得火花峰会的命令吗？在Hadoop时代，它总是有效的，所以你为什么要改变它呢？</p><p id="fd73" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，前面方法的所有问题也适用。同样的代码应该可以应用于任何Spark集群，不管它是托管在Databricks、Kubernetes还是其他什么地方。</p><ul class=""><li id="0bd8" class="nj nk iq kh b ki kj kl km ko nl ks nm kw nn la no np nq nr bi translated"><strong class="kh ir">优点:</strong>代码可重用性、IDE开发、正确的调试和所有代码的单元测试，相同的代码可以在任何Spark集群中运行(无论它托管在哪里)。</li><li id="6f8e" class="nj nk iq kh b ki ns kl nt ko nu ks nv kw nw la no np nq nr bi translated"><strong class="kh ir">缺点:</strong>代码包需要通过CI/CD构建和发布，不适合没有软件工程技能的人，无法从本地机器访问Databricks Hive Metastore。</li></ul><h1 id="a01e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">向前移动</strong></h1><p id="ba21" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">我希望你能把前面的方法作为灵感的来源，而不是唯一的选择。我相信你能想出更好的方案来满足你团队的需求。</p><p id="428c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当然，选择其中一个选项并不意味着你必须永远坚持下去。只要团队在成长，技能组合就会扩大，团队就越有可能转移到更复杂、更健壮的设置。</p><p id="975e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我看来，我会推荐从选项2开始，因为这是一种非常直接的方式来编写具有一定可重用性的代码，同时还涉及到SQL开发人员。复杂性的降低有助于更快地交付MVP。这将满足涉众，他们将给出反馈并要求新的需求。稍后，您可以在“工业化”阶段将重点放在代码的健壮性上，转移到选项3和4，同时团队继续扩展和开发处理更多复杂性所需的技能。</p><h1 id="9c13" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="ff0c" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">笔记本时尚将会持续下去，不仅是Databricks，其他SaaS的替代产品，如Azure Synapse Analytics，都在推动将笔记本部署到生产中。它们扩展了数据开发人员的视野，允许没有编程技能的数据管理员利用“大数据”技术的可能性。</p><p id="c347" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你有一个良好的软件工程基础，你会很快发现笔记本电脑的局限性，你可能迟早会想摆脱它们。幸运的是，有一些折中的解决方案可以帮助在不落下任何人的情况下两全其美，并且您可以根据您的团队技能进行微调。</p><p id="4b99" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢您的阅读，我希望您发现这是有帮助的！</p></div></div>    
</body>
</html>