<html>
<head>
<title>Debugging for Dockerized ML applications in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中Dockerized ML应用程序的调试</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/debugging-for-dockerized-ml-applications-in-python-2f7dec30573d?source=collection_archive---------19-----------------------#2021-07-31">https://towardsdatascience.com/debugging-for-dockerized-ml-applications-in-python-2f7dec30573d?source=collection_archive---------19-----------------------#2021-07-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0394" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用VScode和debugpy使调试变得轻而易举</h2></div><p id="43fa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在过去的几年里，Docker在ML应用程序中变得无处不在。它可以让使用不同硬件的工程师轻松协作，并简化从个人笔记本电脑上的原型开发到生产中的计算集群的过渡。另一方面，它为工程师在开发和维护生产模型时带来了额外的复杂性。</p><p id="ca93" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我的专业工作中，我发现调试是由于这种额外的复杂性而变得更加困难的事情之一。在这篇文章中，我将概述我当前使用VSCode和debugpy的设置，当应用于模型训练应用程序时，它们极大地简化了这个过程。</p><h1 id="0122" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">我们为什么需要这个？</h1><p id="2c02" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">调试代码时，我们希望能够尽可能准确地检查运行时的环境。任何偏离都会导致修复程序在运行时环境中不起作用。</p><p id="b776" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在掌握Docker的同时，我的调试过程通常需要围绕我希望在本地开发环境中检查的Python脚本重新创建支架，然后直接调试该脚本。在包含bash脚本、多个入口点和使用环境变量的模型训练应用程序中，这会迅速增加大量开发开销。随着这种复杂性的增加，出现错误的可能性也增加了，从而使整个过程变得缓慢和令人沮丧。</p><p id="546f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么我们如何避免这种情况呢？我们需要一个可以与Docker交互的调试系统，让我们的代码按照设计的那样运行！</p><h1 id="46b5" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">解决方案</h1><p id="c404" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">最终对我来说最有效的是一个调试器，它可以连接到运行模型训练应用程序的Docker容器，并直接检查给定Python脚本的环境。</p><p id="5866" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是<a class="ae ly" href="https://github.com/microsoft/debugpy" rel="noopener ugc nofollow" target="_blank"> debugpy </a>的用武之地！</p><p id="f574" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个包以前被称为ptvsd，是由微软开发的，专门用于Python的VSCode。它实现了您期望的所有常见调试工具，并允许连接到远程环境，比如Docker容器，甚至通过SSH连接到远程机器。</p><p id="3c3e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">顺便说一下，debugpy实现了调试适配器协议(DAP)，这是开发工具与调试器通信的标准化方式。</p><p id="0a12" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Docker容器中使用debugpy非常简单，需要3个不同的步骤。在演示整个过程之前，我将依次深入其中的每一个。</p><ol class=""><li id="49ee" class="lz ma iq kh b ki kj kl km ko mb ks mc kw md la me mf mg mh bi translated">在Python中配置debugpy</li><li id="26a5" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la me mf mg mh bi translated">配置与Docker容器的连接</li><li id="82b1" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la me mf mg mh bi translated">设置断点</li></ol><h1 id="9c1a" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">在Python中配置debugpy</h1><p id="9d72" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">在您要调试的脚本中，下面的代码片段应该添加在任何其他代码之前。</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="28ac" class="mw lc iq ms b gy mx my l mz na">import debugpy<br/><br/>debugpy.listen(("0.0.0.0", 5678))<br/>print("Waiting for client to attach...")<br/>debugpy.wait_for_client()</span></pre><p id="bba5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将设置debugpy在端口5678上监听客户端连接，并且还将暂停执行，直到客户端通过该端口连接。</p><h1 id="98e1" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">配置与Docker容器的连接</h1><p id="ec8b" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">现在我们已经配置了Python脚本，我们需要确保当它在Docker容器中运行时，VSCode调试器客户端可以连接到debugpy。</p><p id="e08d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，当您运行Docker容器时，debugpy监听的端口必须映射到一个本地端口</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="d1e3" class="mw lc iq ms b gy mx my l mz na">docker run \ <br/>   -p 5678:5678 \  # map container port to local port<br/>   temp-container</span></pre><p id="f4a0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其次，我们需要创建一个<code class="fe nb nc nd ms b">launch.json</code>文件来配置本地VSCode调试客户端将如何运行。这个最小的例子告诉调试器连接到端口<code class="fe nb nc nd ms b">5678</code>，当我们运行容器时，这个端口将被映射到相同编号的Docker端口。</p><pre class="mn mo mp mq gt mr ms mt mu aw mv bi"><span id="f45f" class="mw lc iq ms b gy mx my l mz na">{<br/>   "version":"0.2.0",<br/>   "configurations":[<br/>      {<br/>         "name":"Python: Docker Attach",<br/>         "type":"python",<br/>         "request":"attach",<br/>         "connect":{<br/>            "host":"localhost",<br/>            "port":5678<br/>         },<br/>         "pathMappings":[<br/>            {<br/>               "localRoot":"${workspaceFolder}",<br/>               "remoteRoot":"."<br/>            }<br/>         ]<br/>      }<br/>   ]<br/>}</span></pre><h1 id="5d02" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">设置断点</h1><p id="e38d" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">当我第一次尝试这样做时，我感到很惊讶，当你在Python脚本的本地版本上通过VSCode UI设置断点时，这将对应于在你的Docker容器内运行的复制脚本！来自VSCode的纯魔法。</p><p id="162b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，还可以使用<code class="fe nb nc nd ms b">debugpy.breakpoint()</code>通过debugpy API显式设置断点。这样做的另一个好处是，如果您排除了步骤(1)中提到的debugpy配置，这些调用将被忽略，这提供了一种临时删除调试的快速方法。</p><h1 id="3630" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">正在调试</h1><p id="7c9e" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">你应该可以走了！下面的GIF展示了一个标准的调试方法</p><ul class=""><li id="a6ca" class="lz ma iq kh b ki kj kl km ko mb ks mc kw md la ne mf mg mh bi translated">在用户界面中添加断点</li><li id="78f7" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la ne mf mg mh bi translated">重新构建并运行Docker容器</li><li id="99d7" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la ne mf mg mh bi translated">连接调试器</li></ul><figure class="mn mo mp mq gt ng gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi nf"><img src="../Images/6d98de4bb9090a717141e7d9a313bc2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*tkD-QqtcEtUs6IdRTiDh2A.gif"/></div></div></figure><p id="d4b8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是这个例子的完整代码。调试愉快！😃</p><div class="nn no gp gr np nq"><a href="https://github.com/sam-watts/vscode-docker-debugging" rel="noopener  ugc nofollow" target="_blank"><div class="nr ab fo"><div class="ns ab nt cl cj nu"><h2 class="bd ir gy z fp nv fr fs nw fu fw ip bi translated">GitHub-Sam-watts/vs code-docker-debugging:一个用于调试长时间运行的、dockerized…</h2><div class="nx l"><h3 class="bd b gy z fp nv fr fs nw fu fw dk translated">用vscode - GitHub调试python中长时间运行的dockerized程序的模板…</h3></div><div class="ny l"><p class="bd b dl z fp nv fr fs nw fu fw dk translated">github.com</p></div></div><div class="nz l"><div class="oa l ob oc od nz oe nl nq"/></div></div></a></div><h1 id="fec0" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">链接</h1><ul class=""><li id="9767" class="lz ma iq kh b ki lt kl lu ko of ks og kw oh la ne mf mg mh bi translated">debugpy Github:<a class="ae ly" href="https://github.com/microsoft/debugpy" rel="noopener ugc nofollow" target="_blank">https://github.com/microsoft/debugpy</a></li><li id="448b" class="lz ma iq kh b ki mi kl mj ko mk ks ml kw mm la ne mf mg mh bi translated">码头工人运行参考:<a class="ae ly" href="https://docs.docker.com/engine/reference/run/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/engine/reference/run/</a></li></ul></div></div>    
</body>
</html>