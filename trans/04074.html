<html>
<head>
<title>Airtable &amp; Python Made Possible II: Uploading Data into Airtable from Python using Airtable’s API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Airtable &amp; Python使之成为可能II:使用Airtable的API将数据从Python上传到Airtable</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/airtable-python-made-possible-ii-uploading-data-into-airtable-from-python-using-airtables-api-3075009abf98?source=collection_archive---------14-----------------------#2021-04-06">https://towardsdatascience.com/airtable-python-made-possible-ii-uploading-data-into-airtable-from-python-using-airtables-api-3075009abf98?source=collection_archive---------14-----------------------#2021-04-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/369e6b947597c561059d8bd4a2eaf67c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UaIvW_Z9NQUwGnoiJzbrUQ.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者的图片说明。</p></figure><div class=""/><div class=""><h2 id="6da2" class="pw-subtitle-paragraph kf jh ji bd b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dk translated">如何将Python设计的数据存储回Airtable用户友好的关系数据库</h2></div></div><div class="ab cl kx ky hx kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="im in io ip iq"><h2 id="ab35" class="le lf ji bd lg lh li dn lj lk ll dp lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated"><strong class="ak">内容:</strong></h2><p id="e78d" class="pw-post-body-paragraph ma mb ji mc b md me kj mf mg mh km mi ln mj mk ml lr mm mn mo lv mp mq mr ms im bi translated">— <a class="ae mt" href="#5510" rel="noopener ugc nofollow">了解关系数据&amp;记录id</a><br/>—<a class="ae mt" href="#8863" rel="noopener ugc nofollow">匹配字段值到记录id</a><br/>—<a class="ae mt" href="#81e5" rel="noopener ugc nofollow">在Airtable </a> <br/> — <a class="ae mt" href="#e939" rel="noopener ugc nofollow">匹配(&amp;上传)多条记录</a> <br/> — <a class="ae mt" href="#971b" rel="noopener ugc nofollow">更新Airtable </a> <br/> — <a class="ae mt" href="#08b3" rel="noopener ugc nofollow">中的记录从</a> <code class="fe mu mv mw mx b"><a class="ae mt" href="#08b3" rel="noopener ugc nofollow">pandas</a></code> <a class="ae mt" href="#08b3" rel="noopener ugc nofollow">到Airtable </a> <br/> — <a class="ae mt" href="https://gist.github.com/KalebNyquist/4424fc1ef3dc6bb4fc0b5a7122ada4bc" rel="noopener ugc nofollow" target="_blank">🎉<em class="my">复制粘贴表格功能</em> </a> <em class="my"> <br/> </em> — <a class="ae mt" rel="noopener" target="_blank" href="/downloading-airtable-data-into-python-89e5c7107a24">⏮️第一部分:将Airtable数据下载到Python中</a></p></div><div class="ab cl kx ky hx kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="im in io ip iq"><p id="fcdd" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">Python是一种成熟的编程语言，尽管年代久远，但最近经历了某种复兴——<a class="ae mt" href="https://www.wired.com/story/python-language-more-popular-than-ever/" rel="noopener ugc nofollow" target="_blank">最近成为第二种最广泛使用的通用编程语言</a>。这种繁荣可能是由数据科学领域的快速发展推动的，Python在这一领域占据主导地位，因为Python相对容易学习，但对数据工程和数据分析都很有用。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/9436c6bc6ad3986715fb724ae2092290.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5reT1j0aILRm1y4rBZp8GQ.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">请务必阅读本教程的第一部分，使用Airtable的API将Airtable数据下载到Python中。</p></figure><p id="1519" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">因为某些经济部门获取丰富数据的门槛相对较低，所以它们采用Python驱动的数据科学的速度相对较快。例如，金融部门从根本上讲是关于一个特定的数据点——<a class="ae mt" href="https://link.springer.com/chapter/10.1057/978-1-137-41160-0_4#:~:text=Most%20notably%2C%20Hayek%20argued%20that,the%20members%20of%20society%2C%20for" rel="noopener ugc nofollow" target="_blank">“价格”</a>——因此毫不奇怪，像<a class="ae mt" href="https://fortune.com/2018/06/14/citigroup-python-resume-languages/" rel="noopener ugc nofollow" target="_blank">花旗集团这样的组织向其新任分析师</a>教授Python来管理他们的价格数据。经验科学，无论是应用科学还是学术科学，从根本上讲都是关于数据驱动的观察，因此所有学科的许多<a class="ae mt" href="https://astrofrog.github.io/py4sci/" rel="noopener ugc nofollow" target="_blank">科学家都学习Python </a>作为他们教育的一部分，以理解他们观察到的所有数据点。当然还有软件开发部门，包括我们每天花费越来越多的时间参与的所有应用程序，如网飞，这些应用程序将我们在其平台上的每次点击、查看或其他交互记录为数据点。猜猜看，网飞在“整个内容生命周期”中使用Python <a class="ae mt" href="https://netflixtechblog.com/python-at-netflix-bba45dae649e" rel="noopener ugc nofollow" target="_blank">来优化他们的产品。</a></p><p id="2534" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">然而，在获取丰富数据方面，并不是每个组织都这么容易。例如，我的专业是非营利和社会变革部门。对于我们这些在“真实世界”(即，而不是在电脑屏幕或股票报价机后面)中工作的人来说，获得关于我们运营的有用数据可能需要一些真正的努力和规划。好消息是，一旦我们获得了这些数据，Python的能力就变得唾手可得了。换句话说，我相信获取数据的最初障碍并不会使“真实世界”的组织丧失利用Python所提供的功能的资格。</p><p id="6079" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">进入<a class="ae mt" href="https://airtable.com/invite/r/9jyJBxR8" rel="noopener ugc nofollow" target="_blank">气动工作台</a>。Airtable将关系数据库结构与用户友好的图形界面结合在一起，降低了入门门槛(特别是对于那些以低数据素养为特征的“真实世界”组织环境)。理想情况下，我们不仅希望能够在Airtable中收集可以在Python中使用的数据，还希望能够在Python中生成可以在Airtable中查看的数据集。拥有这种功能可以实现数据透明和审计，同时也使组织中的非程序员能够自己分析数据。</p><p id="bc94" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">在之前的教程中，我一步一步地讲解了如何使用Airtable基础的API将Airtable数据下载到Python中。在这里，我带来了完整的教程:如何使用相同的技术和<code class="fe mu mv mw mx b">requests</code>库将Python数据上传到<a class="ae mt" href="https://airtable.com/invite/r/9jyJBxR8" rel="noopener ugc nofollow" target="_blank"> Airtable </a>的分步指南。然而，要充分利用Airtable的关系数据结构，需要一些仔细的预处理。本教程将涵盖这两个方面:首先是预处理步骤，然后是实际的上传步骤——上传步骤是在Airtable中创建新记录还是更新旧记录。</p></div><div class="ab cl kx ky hx kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="im in io ip iq"><p id="fc70" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">🎉<em class="my">特别奖励</em>:如果你没有时间看完整的教程，请点击这里访问我的<a class="ae mt" href="https://gist.github.com/KalebNyquist/f0e533caabf8fcd751a757d5eec28798" rel="noopener ugc nofollow" target="_blank">防呆的Airtable上传功能</a>，我将其推广用于多个项目。您可以按原样运行它，它将指导您查找任何缺失的信息(例如，从哪里获取API密钥)并突出显示可能的错误。欢迎你免费复制、粘贴和修改这段代码，但是如果你想分享你的感激之情，你可以<a class="ae mt" href="https://ko-fi.com/kalebnyquist" rel="noopener ugc nofollow" target="_blank">点击这里给我买杯咖啡</a>。</p></div><div class="ab cl kx ky hx kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="im in io ip iq"><h1 id="5510" class="ni lf ji bd lg nj nk nl lj nm nn no lm ko np kp lq kr nq ks lu ku nr kv ly ns bi translated">了解关系数据和记录id</h1><p id="d1d0" class="pw-post-body-paragraph ma mb ji mc b md me kj mf mg mh km mi ln mj mk ml lr mm mn mo lv mp mq mr ms im bi translated">与Google Sheets或Microsoft Excel相比，Airtable的“魔力”在于关系数据的集成。除了更加规范的数据管理，Airtable的关系数据结构意味着一个表中的数据可以在另一个表中访问，以便于分析。这是通过“链接到另一个记录”字段类型完成的。</p><p id="6835" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">例如，如下图所示，在“People”表中有四个条目在Rogers Park工作。这些人的名字是布鲁斯·巴克、杰拉德·格里尔、卢拉·洛扎诺和马尔孔·麦金托什，他们分别在9、3、4和8班工作。在“位置”表中，这些人汇总在一行中，总共有24个班次。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nt"><img src="../Images/bd2a004680fdd5d06275ed832df41457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zTuhhea8D6ZQ-rF6cagBew.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><strong class="bd nu">图1:“链接到另一个字段记录”字段类型如何创建关系数据结构。</strong>图片作者。</p></figure><p id="de4a" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">在图形web界面中，关系数据由浅蓝色方框表示，带有与<a class="ae mt" href="https://support.airtable.com/hc/en-us/articles/202624179-The-Name-Field" rel="noopener ugc nofollow" target="_blank">“主字段”</a>相对应的可读文本。当我们通过API而不是图形web界面访问Airtable数据时，这种关系数据看起来非常不同，可能有点吓人。</p><p id="047e" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">请考虑“人员”表中的观察结果:</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="68ac" class="le lf ji mx b gy nz oa l ob oc">{'id': 'recrN5WVNHl1pGxET',<br/> 'fields': {'Name': 'Bruce Buck',<br/>             'Shifts': 9,<br/>             'Location': ['rec887G00dQIujFel'],<br/> 'createdTime': '2021-02-17T22:59:38.000Z'}</span></pre><p id="8a14" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">并且，从“位置”表中:</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="e0e6" class="le lf ji mx b gy nz oa l ob oc">{'id': 'rec887G00dQIujFel',<br/> 'fields': {'Name': 'Rogers Park',<br/>            'People': ['recrN5WVNHl1pGxET',<br/>                       'recMQieZAnYIu860r',<br/>                       'recXyTN7Mo9LNtxhe',<br/>                       'recqYx6e3BrvxFv2s'],<br/>            'Total Shifts': 24,<br/> 'createdTime': '2021-02-17T22:59:56.000Z'}</span></pre><p id="c4b6" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">如果仔细观察，您会发现直观表示为“Bruce Buck”的数据的<code class="fe mu mv mw mx b">id</code>为<code class="fe mu mv mw mx b">recrN5WVNHl1pGxET</code>，而直观表示为“Rogers Park”的数据的<code class="fe mu mv mw mx b">id</code>为<code class="fe mu mv mw mx b">rec887G00dQIujFel</code>。通过像这样使用记录id来引用关系数据，Airtable可以灵活地处理可能出现的复杂性(例如:如果有两个不同的Bruce Bucks呢？如果用户改变了定位的方式，不再用名字，而是用街道地址，那该怎么办？).</p><p id="10e5" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">当通过API将数据从Python上传到Airtable时，这种关系数据结构就有了含义。例如，假设我们有一个编码的webscraper在一个关于Rogers Park的网站上寻找Bruce Buck。webscraper不是寻找与<code class="fe mu mv mw mx b">"recrN5WVNHl1pGxET"</code>匹配的字符串，而是寻找与<code class="fe mu mv mw mx b">"Bruce Buck"</code>匹配的字符串。但是如果我们上传<code class="fe mu mv mw mx b">"Bruce Buck"</code>到一个关系数据字段，而不是一个记录id数组，Airtable的API将为列 错误返回一个<strong class="mc jj"> <em class="my">无效值。</em></strong></p><p id="c121" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">幸运的是，这是一个简单的问题，有一个显而易见的解决方案，(除了几个例外)将可靠地工作，正如我们现在将看到的。</p><h1 id="8863" class="ni lf ji bd lg nj od nl lj nm oe no lm ko of kp lq kr og ks lu ku oh kv ly ns bi translated">将字段值与记录id匹配</h1><p id="2625" class="pw-post-body-paragraph ma mb ji mc b md me kj mf mg mh km mi ln mj mk ml lr mm mn mo lv mp mq mr ms im bi translated">在Python中，字典是基本的“映射”类型，用于将一个值从另一个值或“键”转换。出于我们的目的，我们需要创建一个记录id和字段值的字典，如下所示:</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oi"><img src="../Images/131ba437c1cfcb49997a91f5c735b040.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vm8lyPmK6mct83x-VCih8A.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><strong class="bd nu">图2:记录id和字段值的字典。</strong>图片作者。</p></figure><p id="23db" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">使用Airtable记录的列表，比如从本教程的<a class="ae mt" rel="noopener" target="_blank" href="/downloading-airtable-data-into-python-89e5c7107a24">第一部分(“下载”)生成的记录，作为起点，只需要一些简单的Python代码就可以创建这个字典。</a></p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="4d60" class="le lf ji mx b gy nz oa l ob oc">1 | record_dict = {}<br/>2 | match_field = "Name"</span><span id="b32a" class="le lf ji mx b gy oj oa l ob oc">3 | for record in airtable_records:<br/>4 |     if match_field in record['fields']:<br/>5 |         record_value = record['fields'][match_field]<br/>6 |         record_dict.update({record_value : record['id']})</span></pre><p id="1c77" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">第(1)行创建一个空字典。第(2)行定义了Airtable列，我们将记录id与该列的值进行匹配。第(3)行开始对每个Airtable记录进行迭代，为了防止错误，第(4)行检查我们从中提取数据的字段中是否存在值。第(5)和(6)行获取这个值，将它与记录id匹配，并相应地更新字典。</p><p id="3961" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">⚠️ <em class="my">注意，在这个解决方案中，如果有重复的值(例如，两个“Bruce Buck ”),就会产生冲突。这可以用in air table(“Bruce Buck 1”和“Bruck Buck 2”)或Python(用附加代码)解决。这个问题的最佳解决方案将依赖于上下文。</em></p><p id="2607" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">创建了这个字典后，我们可以开始映射过程，如下图所示:</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ok"><img src="../Images/a197b17a55d8e93aa2316d06c54616de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PCCaYyIG0PF8hokHwweT6Q.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><strong class="bd nu">图3:使用Python字典从概念上匹配惟一字段值和Airtable记录id。</strong>图片作者。</p></figure><p id="5d6f" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">有许多方法可以达到这个结果。对于单个值，<code class="fe mu mv mw mx b">record_dict["Dawn Douglas"]</code>或<code class="fe mu mv mw mx b">record_dict.get("Dawn Douglas")</code>都可以；对于熊猫数据系列，<code class="fe mu mv mw mx b">pd.Series(data).map(record_dict)</code>将转换它能找到匹配的所有值。</p><p id="f4ac" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">但是，如果我们找不到匹配的呢？这就是将数据上传到Airtable的过程变得相当复杂的地方，但如果我们愿意采取一些额外的步骤，仍然是完全可行的。但是首先我们需要通过API在Airtable中创建新记录的基本机制。</p><h1 id="81e5" class="ni lf ji bd lg nj od nl lj nm oe no lm ko of kp lq kr og ks lu ku oh kv ly ns bi translated">在Airtable中创建新记录</h1><p id="fcc8" class="pw-post-body-paragraph ma mb ji mc b md me kj mf mg mh km mi ln mj mk ml lr mm mn mo lv mp mq mr ms im bi translated">在本教程的第一部分的<a class="ae mt" rel="noopener" target="_blank" href="/downloading-airtable-data-into-python-89e5c7107a24">中，我们使用<code class="fe mu mv mw mx b"><a class="ae mt" href="https://2.python-requests.org/en/master/" rel="noopener ugc nofollow" target="_blank">requests</a></code>库通过</a><a class="ae mt" href="https://restfulapi.net/http-methods/#get" rel="noopener ugc nofollow" target="_blank"> GET </a>方法从Airtable下载数据。现在，使用类似的代码，我们将使用<a class="ae mt" href="https://restfulapi.net/http-methods/#post" rel="noopener ugc nofollow" target="_blank"> POST </a>方法创建一条记录(稍后，我们将使用<a class="ae mt" href="https://restfulapi.net/http-methods/#patch" rel="noopener ugc nofollow" target="_blank"> PATCH </a>方法更新一条记录)。</p><p id="9cd0" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">比较一下，注意用斜体标出的差异:</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="1ae3" class="le lf ji mx b gy nz oa l ob oc"><strong class="mx jj"># Download</strong><br/>response = requests.<em class="my">get</em>(url, <em class="my">params=params</em>, headers=headers)</span><span id="29ab" class="le lf ji mx b gy oj oa l ob oc"><strong class="mx jj"># Upload New<br/></strong>response = requests.<em class="my">post</em>(url, <em class="my">data=upload_json</em>, headers=headers)</span></pre><p id="895f" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">我们可以使用相同的网址(<code class="fe mu mv mw mx b">"https://api.airtable.com/v0/" + base_id + "/" + table_name</code>)用于下载和上传。但是，我们必须扩展标题，以便:</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="a86c" class="le lf ji mx b gy nz oa l ob oc">{"Authorization" : "Bearer " + api_key,<br/> "Content-Type" : "application/json"}</span></pre><p id="70ca" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">这个新的<code class="fe mu mv mw mx b">Content-Type</code>头的存在是对我们的一个暗示，当上传数据到Airtable时，我们现在以<a class="ae mt" href="https://restfulapi.net/introduction-to-json/" rel="noopener ugc nofollow" target="_blank"> JSON </a>的形式发送数据(你可能认为这是下载时传递参数的镜像)。</p><p id="47e7" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">为了具体说明这一点，我们来看一个例子。</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="887f" class="le lf ji mx b gy nz oa l ob oc"><strong class="mx jj"># Step 1</strong><br/>upload_data = {"Name" : "Otis Osborn",<br/>               "Shifts" : 9,<br/>               "Location" : ["<!-- -->rec887G00dQIujFel"]<!-- -->}</span><span id="1d03" class="le lf ji mx b gy oj oa l ob oc"><strong class="mx jj"># Step 2</strong><br/>upload_dict = {"records" : [{"fields" : upload_data}], <br/>               "typecast" : False}</span><span id="8094" class="le lf ji mx b gy oj oa l ob oc"><strong class="mx jj"># Step 3<br/></strong>upload_json = json.dumps(upload_dict)</span><span id="355c" class="le lf ji mx b gy oj oa l ob oc"><strong class="mx jj"># Step 4</strong><br/>response = requests.<em class="my">post</em>(url, data=upload_json, headers=headers)</span></pre><p id="186d" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">步骤(1)创建了一个我们想要上传到Airtable的数据字典。请注意字符串、整数和列表数据类型的使用。这里确保字段名和数据类型匹配是很重要的——如果您遇到错误，请参考您的库的<a class="ae mt" href="https://airtable.com/api" rel="noopener ugc nofollow" target="_blank"> API文档</a>。</p><p id="8ced" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">步骤(2)将该数据子集化到Airtable的API可以读取的另一个字典中。您可以将<code class="fe mu mv mw mx b">"typecast"</code>设置为真或假。如果由于某种原因，您无法在步骤1中获得匹配的数据类型，将此设置为True会将字符串转换为Airtable对相应数据类型的最佳猜测。</p><p id="b65f" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">步骤(3)将这个字典转换成JSON，步骤(4)将最终产品上传到Airtable。如果成功，Airtable将发送回一个响应，当调用<code class="fe mu mv mw mx b">response.json()</code>时，该响应将如下所示:</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="8d2b" class="le lf ji mx b gy nz oa l ob oc">{'records': [<br/>  {'id': 'recoiMuxqVvbNMRlG',<br/>   'fields': {'Name': 'Otis Osborn',<br/>              'Location': ['rec887G00dQIujFel'],<br/>              'Shifts': 9},<br/>   'createdTime': '2021-02-19T14:41:41.000Z'}]}</span></pre><p id="2bfb" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">请注意，除了“创建时间”之外，我们现在还有另一个关键的新数据，一个专门针对该记录的id。</p><p id="68d4" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">我们可以通过检查图形界面来验证是否添加了Otis Osborn:</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/b2ba5c81d328882c70c8c0f220270522.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*8mU8jV-hc8Ji-eG9EIfALw.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><strong class="bd nu">图4:在图形界面中识别新记录。</strong>作者图片。</p></figure><p id="f775" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">很简单。这样可以一次只向Airtable添加一条记录。然而，当我们开始批量匹配和创建多个任意大小的Airtable记录时，我们开始遇到匹配问题。</p><h1 id="e939" class="ni lf ji bd lg nj od nl lj nm oe no lm ko of kp lq kr og ks lu ku oh kv ly ns bi translated">匹配(&amp;上传)多条记录</h1><p id="b393" class="pw-post-body-paragraph ma mb ji mc b md me kj mf mg mh km mi ln mj mk ml lr mm mn mo lv mp mq mr ms im bi translated">之前，我们使用基于Airtable数据下载的Python字典将字段值与记录id进行匹配。然而，当我们将新数据上传到Airtable时，Python字典就过时了。</p><p id="b0e2" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">例如，想象一下，如果我们在数据集中两次遇到“Otis Osborn ”,并且我们知道这个“Otis Osborn”是同一个人(即，不存在Otis 1和Otis 2)。如果我们在匹配多个记录时没有保持Python字典的更新，那么将会为同一个Otis Osborn创建两个单独的记录。</p><p id="39cd" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">一种解决方案是在每次新上传后重新下载Airtable数据，但这将是带宽密集型的，尤其是对于较大的数据集。一个更好的解决方案是使用我们在向Airtable上传新的关系数据条目时收到的响应数据来更新Python字典。</p><p id="9373" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">下面，这个过程就直观的表现出来了。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nt"><img src="../Images/0d5b406e978a687d9ec821ab8c2f00a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pv5j8c3_F9XUh4Mi3X7I4A.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><strong class="bd nu">图5:当没有找到预先存在的匹配时，创建一个具有唯一字段值的新记录的过程。</strong>与上面的<a class="ae mt" href="#3e28" rel="noopener ugc nofollow">图3 </a>比较。图片作者。</p></figure><p id="017e" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">在您将该图与上面的<a class="ae mt" href="#3e28" rel="noopener ugc nofollow">图3 </a>进行比较之后，让我们考虑如何对这些步骤进行编码。</p><p id="9371" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated"><strong class="mc jj"> <em class="my">步骤1:尝试将字段值与记录ID </em> </strong>匹配</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="a9ec" class="le lf ji mx b gy nz oa l ob oc">match_value = "Otis Osborn"<br/>record_id = record_dict.get(match_value)</span></pre><p id="fdbc" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">这里，我们将一个Airtable字段值与一个记录id进行匹配。在这个特定的例子中，我们知道Otis Osborn不在字段值和记录id的字典中，所以<code class="fe mu mv mw mx b">record_dict.get("Otis Osborn")</code>将返回一个<a class="ae mt" href="https://realpython.com/null-in-python/" rel="noopener ugc nofollow" target="_blank"> Python NoneType对象</a>。</p><p id="5e29" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated"><strong class="mc jj"> <em class="my">第二步:在Airtable中新建一条记录</em> </strong></p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="f342" class="le lf ji mx b gy nz oa l ob oc">match_field = "Name"<br/>if record_id is None:<br/>    upload_data = {match_field : match_value}<br/>    upload_dict = {"records" : [{"fields" : upload_data}]}<br/>    response = requests.post(url, data=upload_json, headers=headers)</span></pre><p id="65ea" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">因为记录id是<code class="fe mu mv mw mx b">None</code>，我们指示计算机将Otis Osborn上传到Airtable。我们创建一个简单的数据字典，将这个简单的字典添加到为Airtable上传而格式化的“上传字典”中，然后发送一个POST请求。</p><p id="4b19" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated"><strong class="mc jj"> <em class="my">第三步:解析Airtable响应</em> </strong></p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="9ca9" class="le lf ji mx b gy nz oa l ob oc">airtable_record = response.json()['records'][0]</span></pre><p id="512f" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">上面的代码帮助我们导航Airtable响应。因为我们成功上传了一条记录，所以我们取回了一条记录，索引在<code class="fe mu mv mw mx b">[0]</code>。</p><p id="fd94" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated"><strong class="mc jj"> <em class="my">第四步:获取Airtable记录ID </em> </strong></p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="9c9d" class="le lf ji mx b gy nz oa l ob oc">record_id = airtable_record['id']</span></pre><p id="23d9" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">记录ID应该类似于:<code class="fe mu mv mw mx b">rec3QjKqz8RiCz26r</code>。这使我们到达了相同的点，好像我们已经在字典中有了这个字段值和记录ID对，但是如果我们想要避免重复上传，我们还有一个步骤。</p><p id="c185" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated"><strong class="mc jj"> <em class="my">第五步:更新字段值和记录id的字典</em> </strong></p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="5e9e" class="le lf ji mx b gy nz oa l ob oc">record_dict.update({match_value : record_id})</span></pre><p id="0ef5" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">恭喜你。至此，我们已经完成了进行匹配代码的另一次迭代所需的所有工作。保持这个Python字典与Airtable同步是通过API上传数据最困难的部分。</p><p id="a6c8" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">现在我们已经完成了匹配和/或创建记录的复杂过程，我们准备进入上传过程的最后一部分:<em class="my">使用Python更新</em> Airtable记录。</p><h1 id="971b" class="ni lf ji bd lg nj od nl lj nm oe no lm ko of kp lq kr og ks lu ku oh kv ly ns bi translated">更新Airtable中的记录</h1><p id="4046" class="pw-post-body-paragraph ma mb ji mc b md me kj mf mg mh km mi ln mj mk ml lr mm mn mo lv mp mq mr ms im bi translated">在Airtable中更新记录的过程与创建记录的过程非常相似，只有几个关键的区别，具体如下。</p><p id="13ba" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">第一个区别是API请求中使用的URL:它需要指向我们正在更新的特定记录。幸运的是，我们需要做的只是将记录ID附加到我们用来创建新记录的URL上，就像这样:</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="4a95" class="le lf ji mx b gy nz oa l ob oc">url + "https://api.airtable.com/v0/" + base_id + "/" + table_name<br/>record_url = url + "/" + record_id<!-- --> </span></pre><p id="ab94" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">第二个区别是我们通过API发送的数据字典。由于我们在更新时一次只上传一条记录，所以字典要简单得多(参见上面的步骤2)。</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="d108" class="le lf ji mx b gy nz oa l ob oc">upload_dict = {“fields” : upload_data, “typecast” : typecast}</span></pre><p id="a2da" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">第三个区别是我们使用的RESTful方法。为了创作，我们发帖；为了更新，我们将打补丁，就像这样:</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="e53b" class="le lf ji mx b gy nz oa l ob oc"><strong class="mx jj"># Upload Update<br/></strong>response = requests.<em class="my">patch</em>(record_url, <em class="my">data=</em>upload_json, headers)</span></pre><p id="e4cf" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">与本教程的其余部分相比，这似乎没什么大不了的，但是更新Airtable记录的能力允许您创建可伸缩的数据解决方案，将Python的分析能力与Airtable的用户友好的数据存储能力结合起来。</p><h1 id="08b3" class="ni lf ji bd lg nj od nl lj nm oe no lm ko of kp lq kr og ks lu ku oh kv ly ns bi translated">从熊猫到飞行桌</h1><p id="9e1d" class="pw-post-body-paragraph ma mb ji mc b md me kj mf mg mh km mi ln mj mk ml lr mm mn mo lv mp mq mr ms im bi translated"><code class="fe mu mv mw mx b"><a class="ae mt" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">pandas</a></code>是Python中一个流行的数据分析和操作包。在处理Airtable数据时，我们可能会有一个类似于下面这样的pandas数据帧，其中记录id构成了索引值:</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div class="gh gi om"><img src="../Images/a9b1aed6c67550987c35fb68b596b41b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*AEAA88MlGs-KkDslYbKLHA.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><strong class="bd nu">图6:熊猫数据表，在Jupyter笔记本界面上显示。</strong>图片作者。</p></figure><p id="1a56" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">在这种情况下，我们的第一步是将dataframe (" <code class="fe mu mv mw mx b">df</code>")转换为字典中的字典。我们可以使用代码为<code class="fe mu mv mw mx b">df.to_dict(orient="index")</code>的来实现这一点，它将生成如下所示的内容:</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="68c1" class="le lf ji mx b gy nz oa l ob oc">{'rec6vFIUEH4Fk9Z4a': {'Shifts': 4,<br/>  'Name': 'Alva Arnold',<br/>  'Location': ['recyz79aQzGl3LXPT']},<br/> 'recrN5WVNHl1pGxET': {'Shifts': 9,<br/>  'Name': 'Bruce Buck',<br/>  'Location': ['rec887G00dQIujFel']},<br/> 'recUzv7g6PZi4FGbB': {'Shifts': 8,<br/>  'Name': 'Charlotte Chaney',<br/>  'Location': ['recSZBITRlt2juAJ0']},<br/> ...}</span></pre><p id="c701" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">我们现在可以迭代字典中的每个键值对，如下所示:</p><pre class="ne nf ng nh gt nv mx nw nx aw ny bi"><span id="d48c" class="le lf ji mx b gy nz oa l ob oc">dict_of_dicts = df.to_dict(orient="index")<br/>for record_id, upload_data in dict_of_dicts.items():<br/>   <!-- -->record_url = url + "/" + record_id<br/>   upload_dict = {"records" : [{"fields" : upload_data}]}<strong class="mx jj"><br/>   </strong>upload_json = json.dumps(upload_dict)<br/>   requests.post(url, data=upload_json, headers=headers)</span></pre><p id="f56a" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">现在，我们可以无缝地从pandas转移到Airtable，反之亦然(<a class="ae mt" rel="noopener" target="_blank" href="/downloading-airtable-data-into-python-89e5c7107a24#7693">见本教程的第一部分下载Airtable数据到pandas dataframe </a>)！</p><h1 id="f838" class="ni lf ji bd lg nj od nl lj nm oe no lm ko of kp lq kr og ks lu ku oh kv ly ns bi translated">结论</h1><figure class="ne nf ng nh gt iv"><div class="bz fp l di"><div class="on oo l"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">来源:<a class="ae mt" href="https://giphy.com/gifs/thinkproducts-LS9OaDuFiA09eR0Q1C" rel="noopener ugc nofollow" target="_blank"> GIPHY </a></p></figure><p id="7d42" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">首先，如果你遵循了上面的每一个步骤，仍然有问题，欢迎你将我的简单的Airtable帮助函数复制并粘贴到你的项目中。这个Python代码片段不仅将上述所有思想集成到一个函数中，而且还将打印故障排除消息，以帮助您找出不工作的地方。</p><p id="ef04" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">一旦你把Airtable上传到工作中，天空就是极限。我使用Python-to-Airtable上传来促进数据审计方面的协作，增加数据分析的透明度，并用生成的数据作为数据库的种子。<a class="ae mt" href="mailto:contact@kalebnyquist.me" rel="noopener ugc nofollow" target="_blank">给我写封短信</a>分享你创造性的Python-Airtable集成！</p><p id="5e08" class="pw-post-body-paragraph ma mb ji mc b md mz kj mf mg na km mi ln nb mk ml lr nc mn mo lv nd mq mr ms im bi translated">对于Python- <a class="ae mt" href="https://airtable.com/invite/r/9jyJBxR8" rel="noopener ugc nofollow" target="_blank"> Airtable </a>开发者来说，有令人兴奋的消息，据报道，更多的功能正在向我们走来。特别是，有一个元数据API<a class="ae mt" href="https://airtable.com/api/meta" rel="noopener ugc nofollow" target="_blank">正在开发中，它让开发者能够列出库、表、字段类型和视图。除此之外，这将使定位下载数据<em class="my">和上传数据</em>更加容易，而不会因为键错误或数据类型不匹配而中断。当元数据API发布时，如果您对本教程的第三部分感兴趣，请对本文发表评论或鼓掌。</a></p></div><div class="ab cl kx ky hx kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="im in io ip iq"><h1 id="bcdb" class="ni lf ji bd lg nj nk nl lj nm nn no lm ko np kp lq kr nq ks lu ku nr kv ly ns bi translated">承认</h1><ul class=""><li id="9739" class="op oq ji mc b md me mg mh ln or lr os lv ot ms ou ov ow ox bi translated">这篇文章的最初草稿是作为熨斗学校华盛顿DC校区的奖学金的一部分而制作的。对于那些对学习Python驱动的数据分析感兴趣的人，我强烈推荐<a class="ae mt" href="https://flatironschool.com/scholarships/2022q2ar/?utm_campaign=ec2a7f51-e911-403e-8e92-50950d9f7c32&amp;utm_source=emailbatch&amp;utm_medium=email&amp;utm_term=txtlink" rel="noopener ugc nofollow" target="_blank">熨斗学校的数据科学训练营</a>。</li><li id="5336" class="op oq ji mc b md oy mg oz ln pa lr pb lv pc ms ou ov ow ox bi translated">感谢David T，这位读者发现了原始代码样本中的一个错误。你能发现这个错误吗？<code class="fe mu mv mw mx b">{"Authorization" : "Bearer" + api_key, "Content-Type" : "application/json"}</code></li><li id="6a6b" class="op oq ji mc b md oy mg oz ln pa lr pb lv pc ms ou ov ow ox bi translated">此外，感谢我在BuyMeACoffee.com和Ko-fi.com<a class="ae mt" href="https://ko-fi.com/kalebnyquist" rel="noopener ugc nofollow" target="_blank">的支持者们，是他们让我有可能整理这些教程。如果这篇教程对你有价值，我会欢迎你的支持！☕</a></li></ul></div></div>    
</body>
</html>