<html>
<head>
<title>Stop Using CSVs for Storage — This File Format is Faster and Lighter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">停止使用CSV存储—这种文件格式更快、更轻便</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/stop-using-csvs-for-storage-this-file-format-is-faster-and-lighter-8fec7ebad6fc?source=collection_archive---------18-----------------------#2021-09-13">https://towardsdatascience.com/stop-using-csvs-for-storage-this-file-format-is-faster-and-lighter-8fec7ebad6fc?source=collection_archive---------18-----------------------#2021-09-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c78c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">CSV耗费您的时间、磁盘空间和金钱。有一个解决办法。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6d23b6efba7c4ff1659d4ed3131e66f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MozYZWLbkL7YrUOiPJFp2Q.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://www.pexels.com/@divinetechygirl?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">克里斯蒂娜·莫里路</a>从<a class="ae ky" href="https://www.pexels.com/photo/man-standing-infront-of-white-board-1181345/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">派克斯</a>拍摄</p></figure><p id="c1ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CSV不是唯一可用的数据存储格式。事实上，如果您不打算动态查看和编辑数据，这可能是您应该选择的最后一种方法。如果您计划转储大型数据集并使用自动化进行处理，那么使用CSV将是一个漫长且代价高昂的错误。</p><p id="9433" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">想象一下，你收集了大量的数据，并将它们存储在云中。您没有对文件格式做太多的研究，所以您选择了CSV。你的费用高得惊人！一个简单的调整可以减少一半，如果不是更多的话。这个调整就是——你已经猜到了——选择不同的文件格式。</p><p id="5f8a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天，您将了解ORC数据格式的来龙去脉，这是一种最初为加快Hive处理速度而开发的存储解决方案。不，你不需要一个大数据环境来跟进。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e36d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">兽人——这是什么？</h1><p id="122a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">ORC代表<em class="mz">优化行列</em>。这是一种针对Hive中的读写进行优化的数据格式，Hive是一种针对大数据环境的数据查询和分析工具。</p><p id="efdc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有任何使用Hive的经验，你就会知道它的速度有多慢。无论数据集大小如何，即使是最简单的查询也要花费很长时间。Hortonworks的人在2013年决定加快Hive的速度，这导致了ORC文件格式的开发。</p><p id="ca5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ORC文件由条带组成，这些条带包含索引数据、行数据和页脚。下图大致向您展示了ORC文件在表面之下的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl na"><img src="../Images/c15071f9fd65b9cd5bdcb9058a8be324.png" data-original-src="https://miro.medium.com/v2/format:webp/1*EU-L_9blYyiDEdsw6xhpPg.jpeg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1 — ORC文件格式结构(图片由作者提供)</p></figure><p id="3d0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个条带的索引数据包括每列的最小值和最大值以及它们的行索引位置。此外，索引位置提供了偏移量，因此ORC可以在右<em class="mz">块</em>中进行搜索。换句话说，ORC提供了行跳过功能，这使得读取速度比其他选择更快。</p><p id="cc25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mz">文件页脚</em>包含ORC文件中的条带列表和关于每个条带的元数据，比如行数、数据类型和汇总统计数据。</p><p id="0cd8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Python中，可以使用<code class="fe nb nc nd ne b">read_orc</code>函数用熊猫读取ORC文件。不幸的是，对于编写ORC文件来说，没有替代函数。你将不得不使用<code class="fe nb nc nd ne b">pyarrow</code>库来这样做。以下是安装方法:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="ef83" class="nj md it ne b gy nk nl l nm nn"># Pip<br/>pip install pyarrow<br/><br/># Anaconda<br/>conda install -c conda-forge pyarrow</span></pre><p id="4180" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有其他库可以使用ORC，但是PyArrow可以在所有主流操作系统上运行——包括M1 MAC电脑。</p><p id="591c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您已经具备了开始工作所需的一切。打开JupyterLab或任何其他<a class="ae ky" rel="noopener" target="_blank" href="/top-4-python-and-data-science-ides-for-2021-and-beyond-3bbcb7b9bc44?source=user_profile---------0----------------------------">数据科学IDE </a>，因为下一节将介绍ORC的基础知识。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3a0d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">如何在Python中使用ORC？</h1><p id="b0fd" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">让我们从导入库并创建一个相对较大的数据集开始。你将需要Numpy，熊猫和PyArrow跟随。数据集将有1000万行随机数，分布在五列中:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="d783" class="nj md it ne b gy nk nl l nm nn">import numpy as np<br/>import pandas as pd<br/>import pyarrow as pa<br/>import pyarrow.orc as orc <br/><br/>np.random.seed = 42<br/>df_size = 10_000_000<br/><br/>df = pd.DataFrame({<br/>    'a': np.random.rand(df_size),<br/>    'b': np.random.rand(df_size),<br/>    'c': np.random.rand(df_size),<br/>    'd': np.random.rand(df_size),<br/>    'e': np.random.rand(df_size)<br/>})<br/>df.head()</span></pre><p id="bea8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是数据集的外观:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl na"><img src="../Images/c7748d7bde57febe3f89e163c4db9060.png" data-original-src="https://miro.medium.com/v2/format:webp/1*clmSjWt9lk1C72CT1trEoA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片2-随机虚拟数据集(作者提供的图片)</p></figure><p id="1b8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来就本地保存吧。您可以使用以下命令通过PyArrow将数据帧写入ORC文件格式:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="20ca" class="nj md it ne b gy nk nl l nm nn">table = pa.Table.from_pandas(df, preserve_index=False)<br/>orc.write_table(table, '10M.orc')</span></pre><p id="32de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所看到的，保存数据到ORC文件需要更多的输入，因为还没有一个官方的Pandas writer函数。不过，阅读也是一样的。</p><p id="4d1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用以下命令从您的计算机中读取ORC文件:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="95e9" class="nj md it ne b gy nk nl l nm nn">df = pd.read_orc('10M.orc')</span></pre><p id="8813" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不会变得更容易。您现在知道如何使用Python读取和保存ORC文件了。下一节介绍了与CSV文件格式的比较，包括文件大小、读取和写入时间。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="015d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">CSV和ORC——你应该使用哪一个？</h1><p id="d505" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果您需要即时更改甚至查看数据，许多高度优化的文件格式都是无用的。如果不是这样，通常应该避免CSV、XML和JSON文件格式。接下来你会明白为什么。</p><p id="35b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图显示了在本地保存我们的10M数据帧所需的时间:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/a89749a5bd8bbc556672407abec34c67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VX5swb1Fz07btgvxWLq3_Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3 — CSV与Feather本地保存时间(秒)(CSV:34；兽人:9.49)(图片由作者提供)</p></figure><p id="5fbb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">没有与<a class="ae ky" rel="noopener" target="_blank" href="/stop-using-csvs-for-storage-this-file-format-is-150-times-faster-158bd322074e">羽毛</a>的差别那么大，但还是很明显。</p><p id="a636" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，让我们比较一下读取时间—读取不同格式的相同数据集需要多长时间:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/d7c186445d5087c30e22df2511cb3923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fxnRcEtpVmKOMaAe-ygo0A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4 — CSV与ORC读取时间(秒)的对比(CSV:3.72；ORC: 2.48)(图片由作者提供)</p></figure><p id="3337" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">很接近了，但是ORC读起来还是更快。相比之下，读取<a class="ae ky" rel="noopener" target="_blank" href="/stop-using-csvs-for-storage-this-file-format-is-150-times-faster-158bd322074e">羽毛</a>格式的相同文件只需要0.326秒。</p><p id="e11f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CSV读取速度较慢的部分原因是文件大小的增加。下面的图像向你展示了ORC到底有多小:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/cb63b9d0da1a2121fcfdbbf8a4573752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NOzO5Eh19ewHosrH3Njb8A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图5 — CSV与ORC文件大小(CSV:963.5 MB；ORC: 379.5 MB)(图片由作者提供)</p></figure><p id="7fa6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，CSV文件占用的空间是ORC文件的两倍多。</p><p id="5a1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您每天存储千兆字节的数据，选择正确的文件格式至关重要。在这方面，ORC是更好的CSV。如果你需要更多的压缩，你应该试试镶木地板或T2羽毛。</p><p id="1dee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总而言之，即使对Python代码进行最小的调整，也能显著减少磁盘使用量并节省时间。如果您将这些操作扩展到万亿字节的数据，就不难看到好处。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="873b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mz">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="mz">中等会员</em> </a> <em class="mz">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="nr ns gp gr nt nu"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd iu gy z fp nz fr fs oa fu fw is bi translated">通过我的推荐链接加入Medium-Dario rade ci</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">medium.com</p></div></div><div class="od l"><div class="oe l of og oh od oi ks nu"/></div></div></a></div></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6865" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">保持联系</h1><ul class=""><li id="1c20" class="oj ok it lb b lc mu lf mv li ol lm om lq on lu oo op oq or bi translated">在<a class="ae ky" href="https://medium.com/@radecicdario" rel="noopener">媒体</a>上关注我，了解更多类似的故事</li><li id="1241" class="oj ok it lb b lc os lf ot li ou lm ov lq ow lu oo op oq or bi translated">注册我的<a class="ae ky" href="https://mailchi.mp/46a3d2989d9b/bdssubscribe" rel="noopener ugc nofollow" target="_blank">简讯</a></li><li id="c6cd" class="oj ok it lb b lc os lf ot li ou lm ov lq ow lu oo op oq or bi translated">在<a class="ae ky" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li></ul></div></div>    
</body>
</html>