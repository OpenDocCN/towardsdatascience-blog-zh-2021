<html>
<head>
<title>What to Log? From Python ETL Pipelines!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">记录什么？来自 Python ETL 管道！</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/what-to-log-from-python-etl-pipelines-9e0cfe29950e?source=collection_archive---------18-----------------------#2021-11-16">https://towardsdatascience.com/what-to-log-from-python-etl-pipelines-9e0cfe29950e?source=collection_archive---------18-----------------------#2021-11-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ab7e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">ETL 管道的详细日志结构！</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1e37c97ed5a2d424ef3f1479982491ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tEoYIy-McRbjM3B3zo4yyw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">学分- <a class="ae kv" href="https://burst.shopify.com/photos/logs-of-all-shapes-and-sizes?q=log" rel="noopener ugc nofollow" target="_blank">爆发</a></p></figure><p id="7f4b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作为我工作的一部分，我一直在将一些在传统的基于工具的框架上开发的 ETL 工作转换成 python 框架，并且遇到了一些挑战。这几个挑战是编排、代码管理、日志、版本控制等。对他们中的一些人来说，在工具上开发他们并不需要太多的努力。但是，在像 python ETL 这样的手写代码中，这些都是相当大的挑战！这就带来了一个挑战，也就是我们今天的话题！</p><p id="38f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，我们今天主要关注的是“什么”，而不是描述“如何”，因为平台上已经有许多好文章。</p><p id="8f9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">词汇</strong>:</p><ol class=""><li id="303e" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">介绍</li><li id="3ac9" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">ETL 框架</li><li id="b01f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">日志的结构！！</li><li id="987b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用我们的日志结构的示例 ETL 作业。</li><li id="7e04" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">代码位置。</li></ol><p id="27b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">简介</strong>:当我们在工具上设计和开发 ETL 管道时，我们关注像源、目标对象、转换逻辑和一些处理管道的支持任务这样的组件。这些工具还将为所有正在运行的作业生成日志，并且可以通过其内部界面进行监控。基本上，我的意思是说开发/维护日志在工具中并不是一项具有挑战性的活动。而在 python 中，这是一个需要处理的独立活动。今天，在我们的帖子中，我们将讨论 ETL 作业的基本框架，我们可以在任何管道中记录的细节的粗略想法，然后我们将它们组织到我们的 ETL 代码中，最后，我们将开发一个记录日志的示例场景。</p><p id="6f9f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ETL 框架</strong>:正如我们已经知道的，有不同种类的 ETL 作业，如合并/上插流程、分段加载、SCD 2 加载、增量作业、直接插入加载等。所有这些 ETL 作业都有一个非常基本的结构(如下面的 python 所示),即调用管道中的模块、提取模块、转换模块和加载模块的主要功能，现在，我们可以使用下面的框架来确定 ETL 日志的外观。</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="d1f8" class="ml mm iq mh b gy mn mo l mp mq">def extract():<br/>    pass<br/><br/>def transformation():<br/>    pass<br/><br/>def load():<br/>    pass<br/><br/>def main():<br/>    extract()<br/>    transformation()<br/>    load()<br/>    <br/>if __name__=="__main__":<br/>    main()</span></pre><p id="4195" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">日志的结构</strong>:当我们勾勒出 ETL 工作的蓝图时，让我们试着列出一个粗略的想法，我们可以从工作中跟踪哪些细节。</p><p id="9824" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以记录的一系列细节—</p><ul class=""><li id="cd84" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr mr ly lz ma bi translated">显示初始化的元素/组件，如文件夹位置、文件位置、服务器 id、用户 id 详细信息、作业中的流程详细信息</li><li id="2cf7" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mr ly lz ma bi translated">显示提取阶段详细信息，如源文件名、源文件计数(如果需要)、文件格式、文件大小、源表名、源数据库连接详细信息(除了任何秘密身份证明(用户/密码))、文件/源表缺失或无法获取数据消息时的任何异常或错误。</li><li id="3735" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mr ly lz ma bi translated">显示转换阶段的详细信息，如在数据处理期间内存不足时的失败/异常消息，以及任何数据/格式转换的详细信息(如果需要)。</li><li id="3bb0" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mr ly lz ma bi translated">显示加载阶段详细信息，如文件/目标位置、加载的记录数、加载失败、任何数据库加载的约束、加载摘要详细信息。</li><li id="0690" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr mr ly lz ma bi translated">显示作业摘要，如流程运行时间、内存使用情况、CPU 使用情况，这些也可以在提取、转换和加载级别进行跟踪，以均匀地确定作业的瓶颈。</li></ul><p id="1b75" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们把上面的细节整合到我们的 ETL 框架中，看看我们的日志结构是什么样子的！</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="14e7" class="ml mm iq mh b gy mn mo l mp mq">##basic config<br/>##logging.config.fileConfig('logging.conf')<br/>logger = logging.getLogger(__name__)<br/>logger.setLevel(logging.DEBUG)<br/><br/><br/>#job parameters config<br/>config = configparser.ConfigParser()<br/>config.read('etlConfig.ini')<br/>JobConfig = config['ETL_Log_Job']<br/><br/><br/>formatter = logging.Formatter('%(levelname)s:  %(asctime)s:  %(process)s:  %(funcName)s:  %(message)s')<br/>##creating handler<br/>stream_handler = logging.StreamHandler()<br/>file_handler = logging.FileHandler(JobConfig['LogName'])<br/>file_handler.setFormatter(formatter)<br/>logger.addHandler(file_handler)<br/><br/>def extract(counter):<br/><br/>    logger.info('Start Extract Session')<br/>    try:<br/>        pass<br/>    except ValueError as e:<br/>        logger.error(e)<br/>    logger.info("extract completed!")<br/><br/>def transformation(counter):<br/>    logger.info('Start Transformation Session')<br/>    pass<br/>    logger.info("Transformation completed,data ready to load!")<br/><br/>def load(counter):<br/>    logger.info('Start Load Session')<br/>    try:<br/>       pass<br/>    except Exception as e:<br/>        logger.error(e)</span><span id="caba" class="ml mm iq mh b gy ms mo l mp mq"><br/>def main():<br/><br/>    start = time.time()<br/>    ##extract<br/>    start1 = time.time()<br/>    extract()<br/>    end1 = time.time() - start1<br/>    logger.info('Extract CPU usage {}%'.format(psutil.cpu_percent()))<br/>    logger.info("Extract function took : {} seconds".format(end1))<br/><br/>    ##transformation<br/>    start2 = time.time()<br/>    transformation()<br/>    end2 = time.time() - start2<br/>    logger.info('Transform CPU usage{}%'.format(get_cpu_usage_pct()))<br/>    logger.info("Transformation took : {} seconds".format(end2))<br/><br/>    ##load<br/>    start3 = time.time()<br/>    load()<br/>    end3 = time.time() - start3<br/>    logger.info('Load CPU usage {}%'.format(psutil.cpu_percent()))<br/>    logger.info("Load took : {} seconds".format(end3))<br/>    end = time.time() - start<br/>    logger.info("ETL Job took : {} seconds".format(end))<br/>    logger.info('Session Summary')<br/>    logger.info('RAM memory {}% used:'.format(psutil.virtual_memory().percent))<br/>    logger.info('CPU usage {}%'.format(psutil.cpu_percent()))<br/>    print("multiple threads took : {} seconds".format(end))<br/><br/><br/>if __name__=="__main__":<br/>    logger.info('ETL Process Initialized')<br/>    main()</span></pre><p id="2390" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">而且，如果您观察上面的代码结构，我已经创建了一个配置文件来维护所有作业级别的详细信息。通过将该文件导入到您的代码中，您可以利用代码的不同部分，包括用于日志记录。</p><p id="9a7a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">etlConfig.ini:</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="7554" class="ml mm iq mh b gy mn mo l mp mq">##ETL jobs Parameters<br/><br/>[ETL_Log_Job] ##Job name<br/>Job_Name = etl_log_job.py<br/>LogName = etl_log_job.log<br/>TgtConnection = Customers.db<br/>SrcConnection = Customers.db<br/>SrcObject = customer_file.csv<br/>TgtObject = customer</span><span id="261d" class="ml mm iq mh b gy ms mo l mp mq">##Add more job details as needed</span></pre><p id="68a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">使用我们的日志结构的示例 ETL 作业</strong>:</p><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="6645" class="ml mm iq mh b gy mn mo l mp mq">import logging.config<br/>import time<br/>import psutil<br/>import configparser<br/>import pandas as pd<br/>import sqlite3</span><span id="3b70" class="ml mm iq mh b gy ms mo l mp mq">##basic config<br/>##logging.config.fileConfig('logging.conf')<br/>logger = logging.getLogger(__name__)<br/>logger.setLevel(logging.DEBUG)</span><span id="5a5b" class="ml mm iq mh b gy ms mo l mp mq">#job parameters config<br/>config = configparser.ConfigParser()<br/>config.read('etlConfig.ini')<br/>JobConfig = config['ETL_Log_Job']</span><span id="37f6" class="ml mm iq mh b gy ms mo l mp mq">formatter = logging.Formatter('%(levelname)s:  %(asctime)s:  %(process)s:  %(funcName)s:  %(message)s')<br/>##creating handler<br/>stream_handler = logging.StreamHandler()<br/>file_handler = logging.FileHandler(JobConfig['LogName'])<br/>file_handler.setFormatter(formatter)<br/>logger.addHandler(file_handler)</span><span id="2b5e" class="ml mm iq mh b gy ms mo l mp mq">def extract():</span><span id="ab18" class="ml mm iq mh b gy ms mo l mp mq">logger.info('Start Extract Session')<br/>    logger.info('Source Filename: {}'.format(JobConfig['SrcObject']))</span><span id="5737" class="ml mm iq mh b gy ms mo l mp mq">try:<br/>        df = pd.read_csv(JobConfig['SrcObject'])<br/>        logger.info('Records count in source file: {}'.format(len(df.index)))<br/>    except ValueError as e:<br/>        logger.error(e)<br/>        return<br/>    logger.info("Read completed!!")<br/>    return df</span><span id="fd56" class="ml mm iq mh b gy ms mo l mp mq">def transformation(tdf):<br/>    try:<br/>        tdf = pd.read_csv(JobConfig['SrcObject'])<br/>        tdf[['fname', 'lname']] = tdf.NAME.str.split(expand=True)<br/>        ndf = tdf[['ID', 'fname', 'lname', 'ADDRESS']]<br/>        logger.info('Transformation completed, data ready to load!')<br/>    except Exception as e:<br/>        logger.error(e)<br/>        return<br/>    return ndf</span><span id="4b2b" class="ml mm iq mh b gy ms mo l mp mq">def load(ldf):<br/>    logger.info('Start Load Session')<br/>    try:<br/>        conn = sqlite3.connect(JobConfig['TgtConnection'])<br/>        cursor = conn.cursor()<br/>        logger.info('Connection to {} database established'.format(JobConfig['TgtConnection1']))<br/>    except Exception as e:<br/>        logger.error(e)<br/>        return<br/>    #3Load dataframe to table<br/>    try:<br/>        for index,row in ldf.iterrows():<br/>            query = """INSERT OR REPLACE INTO {0}(id,fname,lname,address) VALUES('{1}','{2}','{3}','{4}')""".format(JobConfig['TgtObject'],row['ID'],row['fname'],row['lname'],row['ADDRESS'])<br/>            cursor.execute(query)</span><span id="e2b3" class="ml mm iq mh b gy ms mo l mp mq">except Exception as e:<br/>        logger.error(e)<br/>        return<br/>    conn.commit()<br/>    logger.info("Data Loaded into target table: {}".format(JobConfig['TgtObject']))<br/>    return</span><span id="bce8" class="ml mm iq mh b gy ms mo l mp mq">def main():</span><span id="5ff7" class="ml mm iq mh b gy ms mo l mp mq">start = time.time()</span><span id="0efc" class="ml mm iq mh b gy ms mo l mp mq">##extract<br/>    start1 = time.time()<br/>    tdf = extract()<br/>    end1 = time.time() - start1<br/>    logger.info('Extract CPU usage {}%'.format(psutil.cpu_percent()))<br/>    logger.info("Extract function took : {} seconds".format(end1))</span><span id="c413" class="ml mm iq mh b gy ms mo l mp mq">##transformation<br/>    start2 = time.time()<br/>    ldf = transformation(tdf)<br/>    end2 = time.time() - start2<br/>    logger.info('Transform CPU usage {}%'.format(psutil.cpu_percent()))<br/>    logger.info("Transformation took : {} seconds".format(end2))</span><span id="909f" class="ml mm iq mh b gy ms mo l mp mq">##load<br/>    start3 = time.time()<br/>    load(ldf)<br/>    end3 = time.time() - start3<br/>    logger.info('Load CPU usage {}%'.format(psutil.cpu_percent()))<br/>    logger.info("Load took : {} seconds".format(end3))<br/>    end = time.time() - start<br/>    logger.info("ETL Job took : {} seconds".format(end))<br/>    ##p = psutil.Process()<br/>    ##ls = p.as_dict()<br/>    ##print(p.as_dict())<br/>    logger.info('Session Summary')<br/>    logger.info('RAM memory {}% used:'.format(psutil.virtual_memory().percent))<br/>    logger.info('CPU usage {}%'.format(psutil.cpu_percent()))<br/>    print("multiple threads took : {} seconds".format(end))</span><span id="d151" class="ml mm iq mh b gy ms mo l mp mq">if __name__=="__main__":<br/>    logger.info('ETL Process Initialized')<br/>    main()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/304cedd3ad2c4a7a03c8c1e4dfc466b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fjkDzywzafHB6rPX6KWF3A.png"/></div></div></figure><pre class="kg kh ki kj gt mg mh mi mj aw mk bi"><span id="fbf7" class="ml mm iq mh b gy mn mo l mp mq">##Log output for above sample job</span></pre><p id="b17b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还可以对日志做一些改进:</p><ol class=""><li id="ad0e" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">通过为作业实现配置/参数文件，维护作业日志也将变得容易。</li><li id="df42" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">我们可以添加系统级的摘要细节，以便以后优化或识别作业中的瓶颈。能够识别提取、转换和加载的 CPU 性能/使用情况可以为开发人员提供更多帮助。</li><li id="be50" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">如果我们正在加载目标，尝试跟踪加载摘要，这将有助于识别加载数据的一致性。</li><li id="5bbd" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">python 中的日志模块在 ETL 作业中使用简单有效。</li><li id="d253" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">此外，提供进程 id 或线程 id 详细信息可能有助于以后在其他平台上对进程进行故障排除。</li><li id="f539" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">给出服务器或节点上作业运行的详细信息将有助于挖掘根本原因。</li></ol><p id="c275" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">样本代码位置</strong>:</p><div class="mu mv gp gr mw mx"><a href="https://github.com/Shivakoreddi/ETL-Log-Structure" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd ir gy z fp nc fr fs nd fu fw ip bi translated">GitHub-Shivakoreddi/ETL-Log-Structure</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">github.com</p></div></div><div class="ng l"><div class="nh l ni nj nk ng nl kp mx"/></div></div></a></div><p id="df1e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢您阅读这篇文章，未来的工作将涉及开发 python ETL 作业的其他挑战，如编排、代码管理、版本控制等。</p><p id="cd68" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">参考</strong>:</p><ol class=""><li id="f44f" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">埃利奥特·福布斯，<a class="ae kv" href="https://tutorialedge.net/python/python-logging-best-practices/" rel="noopener ugc nofollow" target="_blank">https://tutorialedge . net/python/python-logging-best-practices/</a>(2017)</li></ol></div></div>    
</body>
</html>