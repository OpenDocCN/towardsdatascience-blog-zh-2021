<html>
<head>
<title>Forecasting Manhattan Valley Condo Sales with NumPyro</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用NumPyro预测曼哈顿山谷公寓的销售</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/forecasting-manhattan-valley-condo-sales-with-numpyro-9ac6e6fb8182?source=collection_archive---------20-----------------------#2021-09-05">https://towardsdatascience.com/forecasting-manhattan-valley-condo-sales-with-numpyro-9ac6e6fb8182?source=collection_archive---------20-----------------------#2021-09-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="430d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用贝叶斯方法生成基于概率的预测</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/78663489f04167da2a6943804d94a3d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z35oa9rO3qwnJG_71GHAyQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:图片来自<a class="ae ky" href="https://pixabay.com/photos/apartments-condos-flats-balconies-924786/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="d729" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://num.pyro.ai/en/stable/getting_started.html" rel="noopener ugc nofollow" target="_blank"> NumPyro </a>是一个日益流行的概率编程工具，用于贝叶斯分析。与其他贝叶斯库相比，使用NumPyro的一个主要优势是速度。NumPyro由<a class="ae ky" href="https://github.com/google/jax" rel="noopener ugc nofollow" target="_blank"> JAX </a>提供支持，这允许使用自动签名来区分原生Python和NumPy函数。更重要的是，XLA可以用于在GPU和TPU上运行NumPy程序，这使得性能特别快。</p><p id="db28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">NumPyro本身构建于PyTorch之上，而PyMC3(另一个特别流行的贝叶斯库)构建于Theano之上。</p><p id="b587" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了使用NumPyro的速度优势之外，该库还提供了大量的概率编程工具——在这个例子中，我们将研究时间序列预测的用例。</p><p id="dfc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，NumPyro将用于预测曼哈顿山谷每季度的总公寓销售量。</p><h1 id="ca16" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">数据</strong></h1><p id="2ce1" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">数据来源于<a class="ae ky" href="https://data.cityofnewyork.us/Housing-Development/NYC-Calendar-Sales-Archive-/uzf5-f8n2" rel="noopener ugc nofollow" target="_blank">纽约公开数据</a>，曼哈顿山谷的公寓——电梯公寓——的销售价格是从2003年到2015年按季度汇总的。</p><p id="a0c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在处理时间序列时，一个很好的经验法则是时间序列越长，数据就越有意义。</p><p id="2ccd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们以房地产销售为背景来考虑这个问题。</p><p id="53e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在曼哈顿谷——有时会发生非常昂贵的房产销售，这可能会极大地扭曲该时期的总销售额。例如，2004年公寓的平均价格为825，983美元，但最贵的公寓售价超过45，388，000美元！</p><p id="daf6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这方面，在这种情况下，使用每月时间序列会导致2004年7月出现异常大的峰值(当时出售了价值4500万美元的房产)。使用季度数据有助于在一定程度上消除这些异常。</p><p id="f765" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当按季度合并销售数据时，我们会发现，在某些季度，总体销售会出现明显的高峰。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/b9069efe2d58533bd1f31abab0ec3a4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:752/format:webp/1*kfWkgKjHs4uYD6YOUdphRQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:Jupyter笔记本输出</p></figure><h1 id="c8f0" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">时间序列</strong></h1><p id="1fa8" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">当使用传统的时间序列模型(如ARIMA模型)时，一个特别重要的考虑因素是特定序列的季节性趋势。如果一个时间序列以一定的时间间隔显示出重复的模式(不同于这些重复模式随机发生的循环时间序列)，那么这使得该序列更容易预测。</p><p id="8a22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到，严格地说，在这种情况下，时间序列不遵循季节模式，或者至少不是一个重要的模式。自相关滞后低于证明的95%置信区间(蓝色阴影)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/12057db923e520eec14cb29ffdc7a785.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*LAOPr9JwLgojVOJAYUUXfw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:Jupyter笔记本输出</p></figure><p id="4a4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也就是说，使用贝叶斯分析的目的是提供一个概率预测。换句话说，虽然我们无法确切知道一个时间序列是否遵循特定的模式，但我们可以对它是否遵循特定模式进行概率评估。</p><p id="6a72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的自相关函数中，我们可以看到相关性大约在每9个滞后时达到峰值。</p><p id="c8ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从图表本身来看，我们看到销售似乎在大约每8-10个季度达到峰值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/29728a2a0e846a819f340b2538b24ce0.png" data-original-src="https://miro.medium.com/v2/resize:fit:752/format:webp/1*Y9yw1qLOqMDzvSO1DtWBzA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:Jupyter笔记本输出</p></figure><p id="0f5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从这个角度来看，让我们假设一个季节性因素为<strong class="lb iu"> 10 </strong>来进行预测。请注意，在运行模型时，确实可以尝试不同的季节因素来确定哪些因素提供了最佳预测。</p><h1 id="60ca" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用季节性全球趋势(SGT)模型进行预测</h1><p id="88be" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在这个例子中，使用了由<a class="ae ky" href="https://num.pyro.ai/en/stable/tutorials/time_series_forecasting.html" rel="noopener ugc nofollow" target="_blank"> num.pyro.ai </a>网站提供的模板——它复制了最初在r</p><p id="a874" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SGT模型使用学生的t分布代替正态分布来表示可能性，因为前者的尾部更重。</p><p id="30f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该模型由趋势和季节组件组成，并且该模型使用所谓的<strong class="lb iu">级别</strong>和<strong class="lb iu"> s </strong>组件来更新趋势值。</p><p id="7500" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如在SGT模型的函数下定义的，level_sm和s_sm都定义如下:</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="dc02" class="mz lw it mv b gy na nb l nc nd">level_sm = numpyro.sample("level_sm", dist.Beta(1, 2))<br/>    s_sm = numpyro.sample("s_sm", dist.Uniform(0, 1))</span></pre><p id="68d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本质上，这只是表示贝塔分布和均匀分布都作为<strong class="lb iu">连续概率分布</strong>，模型的随机成分根据计算的概率随时间更新。</p><p id="720b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是该模型的主要优势之一。例如，我们在自相关函数中看到，模型中可能存在某种季节性模式——但还没有显示出具有统计显著性。可能的情况是，在更长的一段时间内，我们可能会观察到一个显著的季节性模式——但只是没有足够的数据来调查是否是这样。但是，该模型可用于定义在特定时期观察季节模式的概率，并相应地生成基于概率的预测。</p><p id="2b94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该模型还可以更擅长处理不确定性——我们可能无法肯定地说公寓销售何时会出现大幅增长——但我们可以尝试给出一个概率。</p><p id="4e3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设我们在设计的数据集上总共有52个季度，前40个季度将用于训练目的，其余12个季度用于测试目的。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="1f0b" class="mz lw it mv b gy na nb l nc nd">y_train, y_test = jnp.array(data[:40], dtype=jnp.float32), data[40:]</span></pre><p id="45b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在定义函数、训练和测试集时，可以生成5000个MCMC(马尔可夫链蒙特卡罗)样本。<a class="ae ky" href="https://github.com/mfouesneau/NUTS" rel="noopener ugc nofollow" target="_blank"> NUTS </a>(或No-U-Turn采样器)是一种加速采样过程的方法，它避免了通过随机游走方法生成样本，而是选择识别可能的候选点，从而更快地生成目标分布。</p><p id="234c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该模型运行如下:</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="6a81" class="mz lw it mv b gy na nb l nc nd">%%time<br/>kernel = NUTS(sgt)<br/>mcmc = MCMC(kernel, num_warmup=5000, num_samples=5000, num_chains=4)<br/>mcmc.run(random.PRNGKey(0), y_train, seasonality=10)<br/>mcmc.print_summary()<br/>samples = mcmc.get_samples()</span></pre><p id="1c91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该模型生成以下结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/79c7f21266b33d9d6656ea851a0d7ba0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xRx0FwpsWazl3xeg5-JZLQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:Jupyter笔记本输出</p></figure><p id="0951" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，可以进行预测，并且可以估计预测的准确性。</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="710b" class="mz lw it mv b gy na nb l nc nd">&gt;&gt;&gt; predictive = Predictive(sgt, samples, return_sites=["y_forecast"])<br/>&gt;&gt;&gt; forecast_marginal = predictive(random.PRNGKey(1), y_train, seasonality=10, future=12)[<br/>&gt;&gt;&gt;     "y_forecast"<br/>&gt;&gt;&gt; ]</span><span id="349a" class="mz lw it mv b gy nf nb l nc nd">&gt;&gt;&gt; y_pred = jnp.mean(forecast_marginal, axis=0)<br/>&gt;&gt;&gt; sMAPE = jnp.mean(jnp.abs(y_pred - y_test) / (y_pred + y_test)) * 200<br/>&gt;&gt;&gt; msqrt = jnp.sqrt(jnp.mean((y_pred - y_test) ** 2))<br/>&gt;&gt;&gt; print("sMAPE: {:.2f}, rmse: {:.2f}".format(sMAPE, msqrt))</span><span id="5f8a" class="mz lw it mv b gy nf nb l nc nd">sMAPE: 38.90, rmse: 22167788.00</span></pre><p id="6bb6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一下预测图，试图更好地理解这些数字。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/d1f450f0d3deaa72f2932fd3e40f4aef.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/format:webp/1*d4qxAh4fdDIFV-9KsjwDQA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:Jupyter笔记本输出</p></figure><p id="7f21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到，该模型总体上捕捉到了整体趋势，即测试集中前几个季度的销售额下降，随后出现显著上升趋势。虽然主要预测(橙色线)没有捕捉到某个特定季度的公寓销售大幅飙升，但概率区(浅蓝色)大致表明，未来可能会出现大幅飙升。</p><p id="482e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在RMSE(均方根误差)的基础上，22，167，788的RMSE与通过测试集计算的37，448，102的总平均销售额相比是显著的。</p><p id="3a5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，由于RMSE受到异常值的显著影响，我们可以预计在这种情况下这个数字会很大。当查看原始<a class="ae ky" href="https://num.pyro.ai/en/stable/tutorials/time_series_forecasting.html" rel="noopener ugc nofollow" target="_blank">示例</a>中所示的lynx数据集分析时，计算出的RMSE 1249.29与测试集中计算出的平均值1978.41相比也非常显著。</p><p id="fbcb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这方面，贝叶斯主导的时间序列模型具有价值，因为它可以帮助提供一系列情景的预测，并消除处理较小数据集时固有的不确定性。在这种特殊情况下，该模型非常有用，因为虽然我们无法确定地定义季节性因素，但我们可以使用基于概率的方法来估计趋势和季节性因素的波动。</p><h1 id="223f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="a9ca" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">总之，在这个例子中，您已经看到了NumPyro如何用于:</p><ul class=""><li id="6df3" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">定义SGT(季节性、全球趋势)模型</li><li id="3d8b" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">使用这样的模型来随着时间更新概率估计</li><li id="c453" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">利用不掉头采样器生成MCMC样本</li><li id="6175" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">生成概率导向的预测并确定其准确性</li></ul><p id="d834" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">非常感谢您的时间，任何问题或反馈都非常欢迎。你可以在michael-grogan.com找到更多我的内容。</p><p id="9ff2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nv">免责声明:本文是在“原样”的基础上编写的，没有担保。它旨在提供数据科学概念的概述，不应被解释为专业建议。本文中的发现和解释是作者的发现和解释，不被本文中提到的任何第三方认可或隶属于任何第三方。</em></p></div></div>    
</body>
</html>