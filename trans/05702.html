<html>
<head>
<title>Machine Learning with Docker and Kubernetes: Install a Cluster from Scratch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker和Kubernetes的机器学习:从头开始安装集群</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/machine-learning-with-docker-and-kubernetes-install-a-cluster-from-scratch-9dc73bfdc55a?source=collection_archive---------19-----------------------#2021-05-21">https://towardsdatascience.com/machine-learning-with-docker-and-kubernetes-install-a-cluster-from-scratch-9dc73bfdc55a?source=collection_archive---------19-----------------------#2021-05-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b48b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Kubernetes，Docker，Python和sci kit-机器和深度学习的学习:如何扩大数据科学家的努力</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c3e81212e324c19f5ac868ba4d58f745.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yAy6yZggRv_ILho1_VyIgA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Annamária Borsos摄影</p></figure><p id="2832" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果我们想要扩展我们的机器和深度学习工作，开源容器编排平台Kubernetes无疑是最重要的工具之一。为了理解Kubernetes对数据科学家的效用，我们可以考虑一下我们开发和容器化的所有应用程序。我们将如何协调和安排所有这些集装箱？我们如何在不中断服务的情况下升级我们的机器学习模型？我们如何扩展模型并通过互联网提供给用户？如果我们的模型被更多我们认为的人使用会发生什么？如果我们之前没有考虑架构，我们将需要增加计算资源，当然还需要手动创建新实例并重新部署应用程序。Kubernetes调度、自动化和管理基于容器的架构的任务。Kubernetes部署容器、更新它们、提供服务发现、监控、存储供应、负载平衡等等。如果我们谷歌“Kubernetes”，经常会看到对比Docker和Kubernetes的文章。这就像比较苹果和苹果派。首先要说的是，Kubernetes是设计在集群上运行的，而Docker是在单个节点上运行的。Kubernetes和Docker在创建、部署和扩展容器化应用程序方面是互补的。还有Kubernetes和Docker Swarm之间的比较，Docker Swarm是一个用于集群和调度Docker容器的工具。Kubernetes有几个选项可以提供真正重要的优势，例如高可用性策略、自动扩展功能、管理运行在公共、混合、多云或内部环境上的复杂和数十万个容器的可能性。</p><p id="e40e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以在<a class="ae lr" href="https://github.com/xaviervasques/kubernetes.git" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到本章用到的所有文件</p><h1 id="315d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">库伯内特词汇</h1><p id="f7d9" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">在Kubernetes，我们需要了解不同的概念。我们有Kubernetes主节点，它是在我们的集群的一个节点上运行的一组三个进程，我们称之为主节点:<strong class="kx ir"> kube-apiserver </strong>、<strong class="kx ir"> kube-controller-manager </strong>和<strong class="kx ir"> kube-scheduler </strong>。我们集群中的每个节点(不包括主节点)运行两个进程:<strong class="kx ir"> kubelet </strong>，它与Kubernetes主节点通信，以及<strong class="kx ir"> kube-proxy </strong>，它是一个网络代理，反映了每个节点上的Kubernetes网络服务。API服务器用于组件之间的通信，控制器管理器根据期望的状态检查状态，调度器决定应该在哪些pod上运行。<strong class="kx ir"> kubelet </strong>是在每个节点上运行的主要“节点代理”。<strong class="kx ir"> kube-proxy </strong>是运行在每个节点上的Kubernetes网络代理。</p><p id="2996" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在Kubernetes中，我们有<strong class="kx ir">控制平面</strong>(主节点)，它是协调器，<strong class="kx ir">节点</strong>是机器(物理服务器、虚拟机等)。)来运行您的容器化应用程序。这些节点由主节点控制。然后，我们有<strong class="kx ir"> Pod </strong>，它是Kubernetes的基本构建模块。Pods是我们可以在Kubernetes中创建和管理的最小可部署计算单元。它由一个或多个容器组成。例如，我们可以考虑创建一个Pod来训练我们的机器学习模型(代码在单个容器中)。我们还必须处理创造一个或多个豆荚的<strong class="kx ir">工作</strong>。作业将确保pod的执行是成功的。我们可以创建一个作业来训练我们的模型，执行批量推理，或者将训练元数据等信息存储到外部存储或预测中。Kubernetes可以通过简化向他人展示模型的过程，真正帮助我们将机器和深度学习模型投入生产。我们将看到，我们需要遵循几个步骤，例如创建一个部署，指定要运行哪个容器以及我们要创建多少个副本，使用一个服务来公开部署，该服务允许我们定义将pod相互公开以及向互联网公开的规则。Kubernetes的一个非常重要的特性是负载平衡，以处理副本之间的流量平衡工作，并自动调整资源以满足不断增长的需求。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/0173da2ca50d47536d5a4c73c63f5dea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KeRwhKpr2WzL8z-iThd-rQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">典型的Kubernetes建筑</p></figure><h1 id="1be8" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Kubernetes快速安装</h1><p id="700b" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">我们可以使用不同的方法来安装Kubernetes。所有这些在Kubernetes网站上都有很好的解释:</p><p id="00a6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以在终端上输入:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="5fed" class="mv lt iq mr b gy mw mx l my mz">brew install kubectl</span></pre><p id="a8ee" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">或者，我们可以键入:</p><p id="9edc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> Ubuntu / Debian </strong></p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="c2d7" class="mv lt iq mr b gy mw mx l my mz">sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https</span><span id="7c26" class="mv lt iq mr b gy na mx l my mz">curl -s <a class="ae lr" href="https://packages.cloud.google.com/apt/doc/apt-key.gpg" rel="noopener ugc nofollow" target="_blank">https://packages.cloud.google.com/apt/doc/apt-key.gpg</a> | sudo apt-key add -</span><span id="7258" class="mv lt iq mr b gy na mx l my mz">echo “deb <a class="ae lr" href="https://apt.kubernetes.io/" rel="noopener ugc nofollow" target="_blank">https://apt.kubernetes.io/</a> kubernetes-xenial main” | sudo tee -a /etc/apt/sources.list.d/kubernetes.list</span><span id="97e7" class="mv lt iq mr b gy na mx l my mz">sudo apt-get update</span><span id="2194" class="mv lt iq mr b gy na mx l my mz">sudo apt-get install -y kubectl</span></pre><p id="e5dd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">红帽/ CentOS </strong></p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="51ea" class="mv lt iq mr b gy mw mx l my mz">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo<br/>[kubernetes]<br/>name=Kubernetes<br/>baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch<br/>enabled=1<br/>gpgcheck=1<br/>repo_gpgcheck=1<br/>gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg<br/>exclude=kubelet kubeadm kubectl<br/>EOF<br/><br/><em class="nb"># Mettre SELinux en mode permissif (le désactiver efficacement)</em><br/>sudo setenforce 0<br/>sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config<br/><br/>sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes<br/><br/>sudo systemctl enable --now kubelet</span></pre><p id="708d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用以下命令检查安装:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="3ca1" class="mv lt iq mr b gy mw mx l my mz">kubectl version --client</span></pre><p id="a359" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">安装所有的Kubernetes二进制文件(kubeadm，kubelet，kubectl):</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="97a5" class="mv lt iq mr b gy mw mx l my mz">sudo apt-get install -y kubelet kubeadm kubernetes-cni</span><span id="0b25" class="mv lt iq mr b gy na mx l my mz">systemctl enable kubelet</span></pre><h1 id="51e6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">安装Kubernetes集群</h1><p id="5af7" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">为了熟悉Kubernetes，我们将使用一个工具来构建和管理虚拟机。流浪者通过使用名为<strong class="kx ir">流浪者文件</strong>的配置文件在单个工作流中创建和配置轻量级环境。让我们安装流浪者。</p><p id="285b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> Ubuntu / Debian </strong></p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="41c6" class="mv lt iq mr b gy mw mx l my mz">curl -fsSL <a class="ae lr" href="https://apt.releases.hashicorp.com/gpg" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com/gpg</a> | sudo apt-key add -</span><span id="a5c4" class="mv lt iq mr b gy na mx l my mz">sudo apt-add-repository “deb [arch=amd64] <a class="ae lr" href="https://apt.releases.hashicorp.com" rel="noopener ugc nofollow" target="_blank">https://apt.releases.hashicorp.com</a> $(lsb_release -cs) main”</span><span id="842c" class="mv lt iq mr b gy na mx l my mz">sudo apt-get update &amp;&amp; sudo apt-get install vagrant</span></pre><p id="e0f3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">红帽/ CentOS </strong></p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="15fe" class="mv lt iq mr b gy mw mx l my mz">sudo yum install -y yum-utils</span><span id="b880" class="mv lt iq mr b gy na mx l my mz">sudo yum-config-manager --add-repo <a class="ae lr" href="https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo" rel="noopener ugc nofollow" target="_blank">https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo</a></span><span id="c3ce" class="mv lt iq mr b gy na mx l my mz">sudo yum -y install vagrant</span></pre><p id="2c71" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果我们想把它安装在其他平台上，请不要犹豫检查:<a class="ae lr" href="https://www.vagrantup.com/downloads" rel="noopener ugc nofollow" target="_blank">https://www.vagrantup.com/downloads</a></p><p id="b123" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">vagger依赖于与供应商(如VirtualBox、VMware或Hyper-V)的交互，为vagger提供运行开发环境的资源。需要安装其中的一个。</p><p id="105c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以安装<strong class="kx ir"> virtualbox </strong>:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="4f47" class="mv lt iq mr b gy mw mx l my mz">sudo apt update</span><span id="e562" class="mv lt iq mr b gy na mx l my mz">sudo apt install virtualbox</span><span id="cf8d" class="mv lt iq mr b gy na mx l my mz">sudo apt install virtualbox-dkms</span></pre><p id="c6ac" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">并创建一个“流浪文件”:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="867a" class="mv lt iq mr b gy mw mx l my mz">sudo vagrant init bento/ubuntu-20.04</span></pre><p id="5c93" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于我们的项目，我们将创建或编辑一个特定的流浪文件来构建我们自己的环境，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="0021" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如你在流浪者文件中看到的，我们正在创建一个名为“kubmaster”的主节点，它有一个Ubuntu版本20.04，2Gb内存和2个CPU，一个IP地址(192.168.56.101)和docker。然后，我们创建两个节点(kubnode1和kubnode2 ),它们的配置与主节点相同。</p><p id="88e5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">编辑后，切换到root并在终端中键入(Vagranfile所在的位置):</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="7a00" class="mv lt iq mr b gy mw mx l my mz">vagrant up</span></pre><p id="2272" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该命令将根据我们编辑的Vagrantfile创建和配置来宾机器。完成该过程后，我们可以在您的终端中使用以下命令连接到客户机:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="b2b7" class="mv lt iq mr b gy mw mx l my mz">vagrant ssh kubmaster</span><span id="8015" class="mv lt iq mr b gy na mx l my mz">vagrant ssh kubnode1</span><span id="cbb1" class="mv lt iq mr b gy na mx l my mz">vagrant ssh kubnode2</span></pre><p id="0ae6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们必须在主节点(kubmaster)和每个节点(kubnode1和kubnode2)上禁用交换。我们连接到每台客户机，以执行以下命令:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="6b2e" class="mv lt iq mr b gy mw mx l my mz">swapoff -a</span><span id="18f7" class="mv lt iq mr b gy na mx l my mz">vim /etc/fstab</span></pre><p id="693d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在<em class="nb"> fstab </em>文件中，我们需要注释掉交换行。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/39142e8ccdcfc35a83652073a970fd01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iVpxBdKOHUvVL0IxYc4MeQ.png"/></div></div></figure><p id="d7f6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们也在每台机器(kubmaster，kubnode1，kubnode2)上安装一些包，比如curl和apt-transport-https:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="27c9" class="mv lt iq mr b gy mw mx l my mz">apt-get update &amp;&amp; apt-get install -y apt-transport-https curl</span></pre><p id="b1ee" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，我们执行一个<em class="nb"> curl </em>来获取gpg密钥，这将允许我们使用Kubernetes二进制文件:kubectl、kubeadm、kubelet。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="88a2" class="mv lt iq mr b gy mw mx l my mz">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span></pre><p id="319a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们添加了对Google存储库的访问权限(<a class="ae lr" href="http://apt.kubernetes.io/" rel="noopener ugc nofollow" target="_blank">http://apt . kubernetes . io</a>)，这将允许我们下载并安装二进制文件:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="b342" class="mv lt iq mr b gy mw mx l my mz">add-apt-repository “deb <a class="ae lr" href="http://apt.kubernetes.io/" rel="noopener ugc nofollow" target="_blank">http://apt.kubernetes.io/</a> kubernetes-xenial main”</span></pre><p id="4cb7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要安装二进制文件，我们需要执行以下操作:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="7186" class="mv lt iq mr b gy mw mx l my mz">apt-get install -y kubelet kubeadm kubectl kubernetes-cni</span><span id="fed2" class="mv lt iq mr b gy na mx l my mz">systemctl enable kubelet</span></pre><h1 id="5464" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Kubernetes:初始化和内部网络</h1><p id="2225" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">现在，我们已经在所有节点中安装了必要的包，我们将进行初始化和网络工作，以连接Kubernetes集群的不同部分。</p><p id="3738" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要启动主节点，请连接到主节点并键入:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="85ea" class="mv lt iq mr b gy mw mx l my mz">root@kubmaster:~# kubeadm init --apiserver-advertise-address=192.168.56.101 --node-name $HOSTNAME --pod-network-cidr=10.244.0.0/16</span></pre><p id="5cd4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">192.168.56.101是我们之前定义的主节点的IP地址，10.244.0.0/16是Kubernetes内部网络的IP地址，定义了Kubernetes在其网络内用于分配IP地址的范围。</p><p id="bbd6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们看到以下输出，其中包含一个为加入不同节点而生成的令牌:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/1aa7f379d3f34bce287cbd44ee9761b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uMdI5R2c3v2wommuZg8R2Q.png"/></div></div></figure><p id="187a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如您在输出中看到的，要开始使用我们的集群，我们需要创建配置文件来使用kubectl:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="3e23" class="mv lt iq mr b gy mw mx l my mz">root@kubmaster:~# mkdir -p $HOME/.kube</span><span id="0cad" class="mv lt iq mr b gy na mx l my mz">root@kubmaster:~# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><span id="9ddc" class="mv lt iq mr b gy na mx l my mz">root@kubmaster:~# chown $(id -u):$(id -g) $HOME/.kube/config</span></pre><p id="a1c6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了建立内部网络，我们需要在集群中的节点之间提供一个网络。为此，我们将使用法兰绒，这是配置为Kubernetes设计的第3层网络结构的一种非常简单易行的方法。存在不同的解决方案，如WeaveNet、Contiv、Cilium等。法兰绒在每台主机上运行一个名为<em class="nb"> flanneld </em>的二进制代理。法兰绒还负责从更大的预配置地址空间中为每台主机分配子网租约。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/623b16ba3db0a75ff7d20e6368c34f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A-J0Dbct9-bGw3Yvdj2MFQ.jpeg"/></div></div></figure><p id="ea26" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们添加了pod以提供管理内部网络的可能性(在所有节点中启动命令):</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="fcc4" class="mv lt iq mr b gy mw mx l my mz">sysctl net.bridge.bridge-nf-call-iptables=1</span></pre><p id="66c0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，我们通过在主节点中键入以下命令，在在线配置文件(kube-法兰绒. yml)的帮助下安装法兰绒网络:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="2f55" class="mv lt iq mr b gy mw mx l my mz">kubectl apply -f <a class="ae lr" href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</a></span></pre><p id="a04a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们检查主节点中pod的状态(法兰绒网络、kube-调度程序、kube-apiserver、kube-控制器-管理器、kube-代理、管理内部DNS的pod、存储etcd配置的pod等):</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="f1f3" class="mv lt iq mr b gy mw mx l my mz">kubectl get pods --all-namespaces</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/706110ac8fc35d54694e8546cca68dc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WMxDtqVXjF4-k_NPBYoAdw.png"/></div></div></figure><p id="296f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有时有必要通过编辑网络(从10.244.0.0/16到10 . 10 . 0/16)来修改我们的法兰绒配置。为此，您可以执行以下操作:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="b62d" class="mv lt iq mr b gy mw mx l my mz">kubectl edit cm -n kube-system kube-flannel-cfg</span><span id="9176" class="mv lt iq mr b gy na mx l my mz"># edit network 10.244.0.0/16 to 10.10.0.0/16</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/fbe98c99b14dfbecf956302b83110bba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g-uyNX7I2G7pkIt3T2lKcQ.png"/></div></div></figure><p id="e0a3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您在主节点中键入以下命令，我们可以看到我们的主节点已准备就绪:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="cba4" class="mv lt iq mr b gy mw mx l my mz">kubectl get nodes</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/ef25f94541e10e814a75c0751e1567bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZsA8PuDffHYKpbUxGMLxmg.png"/></div></div></figure><p id="6f70" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在是将节点连接到主节点的时候了。为此，我们复制先前生成的令牌，并在两个节点(kubnode1和kubnode2)中键入以下命令:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="3a08" class="mv lt iq mr b gy mw mx l my mz">kubeadm join 192.168.56.101:6443 --token 0dgzxg.86lj9mirur1ele2f \  --discovery-token-ca-cert-hash sha256:59ca1ef21c1c4304ff1558210cf78528a6750babc3fa69241e925c2d5f7d90c6</span></pre><p id="98ae" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将看到以下输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/218ede7d25a03c1a9eb07d77fd852311.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w9tBilnrHEVPvfE3s8kocA.png"/></div></div></figure><p id="18e9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">回到主节点，键入以下命令检查状态:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="32ff" class="mv lt iq mr b gy mw mx l my mz">kubectl get pods --all-namespaces</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/ea1615d82fd7861db41ad9b7ccbd1ae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lbwmSTYpFiKN_SQPlkj6Wg.png"/></div></div></figure><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="d161" class="mv lt iq mr b gy mw mx l my mz">kubectl get nodes</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/c837a6b8a4441b868dc6c0a0d946242a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MtK0580exqTr7a5W_VZrYw.png"/></div></div></figure><p id="5fcb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们应该看到状态为“就绪”的节点。我们还可以做一个<em class="nb"> docker ps </em>来查看主节点和其他节点中所有已启动的容器(coredns、法兰绒等……)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/4585d31ad6e39ce2b612bca524a9568e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GcsKL94CzcJpLiw6Ux7ZuA.png"/></div></div></figure><p id="995c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后一点是关于集群访问。如果我们键入主节点:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="4eb0" class="mv lt iq mr b gy mw mx l my mz">kubectl get nodes</span></pre><p id="af50" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以看到，我们的kubmaster和节点具有相同的内部IP:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="68b2" class="mv lt iq mr b gy mw mx l my mz">kubectl get nodes -o wide</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/ded1e3abc1dc664e854a81ee0c486879.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1EhQ3eJMLa1tNQpUb1qKtQ.png"/></div></div></figure><p id="70a5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们需要打开并编辑/etc/hosts，并添加我们的主节点IP:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="3d8d" class="mv lt iq mr b gy mw mx l my mz">vim /etc/hosts</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/b2bb7aa9778b2ce3925bc29e1790968d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QIHVASd5C9zc7z86Hj0NNw.png"/></div></div></figure><p id="d25d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">每个节点(kubnode1和kubenode2)中的<em class="nb"> /etc/hosts </em>文件也需要修改:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/9b3449be42ba77e454a508c38f89d0b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tuE1oemwqJ2JFTK8t9Nasw.png"/></div></div></figure><p id="ce3d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，我们可以通过键入主节点来删除每个法兰绒:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="2fa3" class="mv lt iq mr b gy mw mx l my mz">kubectl get pods -n kube-system</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/c429e75e8eb15a78acbd0498fb64451a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7kULuoGEesQMA79kL_ScWA.png"/></div></div></figure><p id="89d3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="0a78" class="mv lt iq mr b gy mw mx l my mz">kubectl delete pods kube-flannel-ds-56f9h -n kube-system</span><span id="b982" class="mv lt iq mr b gy na mx l my mz">kubectl delete pods kube-flannel-ds-dx8tv -n kube-system</span><span id="0c33" class="mv lt iq mr b gy na mx l my mz">kubectl delete pods kube-flannel-ds-kgxvt -n kube-system</span></pre><p id="bd26" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Kubernetes的神奇之处在于，它可以在不失去服务的情况下重新配置，并拥有新的flannels:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/5407dc869df1d025d2e1f44697c6d07e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UjRkBC4YzEblNzSHuBtMZg.png"/></div></div></figure><p id="b0e5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将看到我们拥有正确的IP地址:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="95fd" class="mv lt iq mr b gy mw mx l my mz">kubectl get nodes -o wide</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/a65681bb10c1cdcee39b844f83b53f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xL20NvIaQSOhe8g-xvpcxg.png"/></div></div></figure><p id="36c9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了更加方便，我们还可以通过键入以下内容来添加自动完成功能:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="28cd" class="mv lt iq mr b gy mw mx l my mz">apt-get install bash-completion</span><span id="d9ee" class="mv lt iq mr b gy na mx l my mz">echo “source &lt;(kubectl completion bash)” &gt;&gt; ~/.bashrc</span><span id="8679" class="mv lt iq mr b gy na mx l my mz">source ~/.bashrc</span></pre><h1 id="9c59" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">后续步骤</h1><p id="c345" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">现在我们知道如何安装Kubernetes集群，我们将能够创建Kubernetes作业，这些作业将创建pods(以及容器),例如，允许训练我们的机器学习模型，序列化它们，将模型加载到内存中，并执行批处理或在线推理。我们在这里探讨了这些概念:</p><div class="nj nk gp gr nl nm"><a href="https://xaviervasques.medium.com/machine-learning-with-docker-and-kubernetes-training-models-cbe33a08c999" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd ir gy z fp nr fr fs ns fu fw ip bi translated">Docker和Kubernetes的机器学习:训练模型</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">Kubernetes，Docker，Python和sci kit-机器和深度学习的学习:如何扩大数据科学家的努力</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">xaviervasques.medium.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa kp nm"/></div></div></a></div><div class="nj nk gp gr nl nm"><a href="https://xaviervasques.medium.com/machine-learning-with-docker-and-kubernetes-batch-inference-4a25328f23c7" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd ir gy z fp nr fr fs ns fu fw ip bi translated">使用Docker和Kubernetes的机器学习:批量推理</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">Kubernetes，Docker，Python和sci kit-机器和深度学习的学习:如何扩大数据科学家的努力</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">xaviervasques.medium.com</p></div></div><div class="nv l"><div class="ob l nx ny nz nv oa kp nm"/></div></div></a></div><div class="nj nk gp gr nl nm"><a href="https://xaviervasques.medium.com/machine-learning-prediction-in-real-time-using-docker-python-rest-apis-with-flask-and-kubernetes-fae08cd42e67" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd ir gy z fp nr fr fs ns fu fw ip bi translated">使用Docker、Python Rest APIs和Flask和Kubernetes进行实时机器学习预测…</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">用于机器和深度学习的Kubernetes、Docker、Python、Scikit-Learn和Flask:如何扩展数据科学家的工作</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">xaviervasques.medium.com</p></div></div><div class="nv l"><div class="oc l nx ny nz nv oa kp nm"/></div></div></a></div></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><p id="d93a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">来源</strong></p><p id="e9e5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">https://phoenixnap.com/blog/kubernetes-vs-docker-swarm<a class="ae lr" href="https://phoenixnap.com/blog/kubernetes-vs-docker-swarm" rel="noopener ugc nofollow" target="_blank"/></p><p id="6210" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">【https://kubernetes.io/fr/docs/concepts/ T4】</p><p id="8ab8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="https://kubernetes.io/fr/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/fr/docs/tasks/tools/install-kubectl/</a></p><p id="f0b6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="https://www.vagrantup.com/downloads" rel="noopener ugc nofollow" target="_blank">https://www.vagrantup.com/downloads</a></p><p id="d388" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="https://gitlab.com/xavki/presentations-kubernetes/-/tree/master" rel="noopener ugc nofollow" target="_blank">https://git lab . com/xavki/presentations-kubernetes/-/tree/master</a></p><p id="08ad" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="https://github.com/flannel-io/flannel" rel="noopener ugc nofollow" target="_blank">https://github.com/flannel-io/flannel</a></p></div></div>    
</body>
</html>