<html>
<head>
<title>Speed up your ELT using BigQuery Cloud SQL Federation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery Cloud SQL Federation加速您的ELT</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/speed-up-your-elt-using-bigquery-cloud-sql-federation-90b3ede99472?source=collection_archive---------26-----------------------#2021-09-21">https://towardsdatascience.com/speed-up-your-elt-using-bigquery-cloud-sql-federation-90b3ede99472?source=collection_archive---------26-----------------------#2021-09-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/de68fdf7ba1e75f34966beb1f4ea5310.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vA33SjU29QGeHdxbs9ua-w.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</p></figure><p id="2fbd" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">实时查询云SQL实例中的数据，减少ELT开发时间，避免复制和移动数据，这要归功于BigQuery云SQL联盟。</p><p id="591f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">众所周知,<a class="ae ld" href="https://cloud.google.com/sql" rel="noopener ugc nofollow" target="_blank"> Cloud SQL </a>是一个完全托管的关系数据库服务，适用于MySQL、PostgreSQL和SQL Server。这些类型的数据库面向宿主应用程序或事务性数据。<a class="ae ld" href="https://cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank">另一方面，BigQuery </a>支持分析工作负载。</p><p id="2723" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在传统世界中，您必须开发一个数据管道来从应用程序的数据库中提取数据。让我们看看如何在PostgreSQL数据库中利用表联合。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="4b84" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">循序渐进的案例</h1><p id="3e22" class="pw-post-body-paragraph kf kg it kh b ki mj kk kl km mk ko kp kq ml ks kt ku mm kw kx ky mn la lb lc im bi translated">在这个场景中，我们作为数据工程师负责在分析区域(BigQuery)中启用来自事务数据库(云SQL)的数据。这些数据可以被其他流程或其他角色使用，如数据科学家或机器学习工程师。</p><p id="a19f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">像往常一样，公司希望我们的团队可以立即使用最新生成的交易数据。</p><p id="11b8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">由于BigQuery Cloud SQL Federation，我们能够实时查询Cloud SQL中的数据。这一特性为传统的<a class="ae ld" href="https://cloud.google.com/bigquery/docs/batch-loading-data" rel="noopener ugc nofollow" target="_blank">批量摄取</a>提供了新的替代方案。现在，我们可以使用创建当天或同一小时的数据。例如，Data Studio上的报告可以显示过去一个小时的销售信息，最棒的是，如果您有使用BigQuery的经验，开始使用它并不困难。</p><p id="cb6f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">在你继续之前</strong></p><p id="e0cc" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了执行接下来的步骤，您需要一个谷歌云帐户。要开户，只需在GCP网站注册，自动获得300美元的信用。</p><h1 id="eed8" class="ll lm it bd ln lo mo lq lr ls mp lu lv lw mq ly lz ma mr mc md me ms mg mh mi bi translated">在云SQL中</h1><p id="827f" class="pw-post-body-paragraph kf kg it kh b ki mj kk kl km mk ko kp kq ml ks kt ku mm kw kx ky mn la lb lc im bi translated">为了首先重现这个案例，我们创建了事务性数据库。在这个数据库中，我们将生成一个表来存放一个虚构商店的销售额。</p><p id="a27f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们创建云SQL实例，在本例中是PostgreSQL</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mt"><img src="../Images/20458d7447ad9cf614661340a77734c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9bYnbUMifbKSMyH5ofgrNQ.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</p></figure><p id="e4c5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果是第一次创建云SQL，您需要启用计算引擎API，这允许GCP代表您创建和管理计算引擎。只要看看窗口，点击蓝色按钮。</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi my"><img src="../Images/9714b4822cb9ae7e4198470991990a34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*br1qnkxGcEKV7xwAAJVbYg.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</p></figure><p id="6c9a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在这种情况下，为新实例设置最小值。有了这些价值，我们保证了最便宜的价格。如果你想详细了解价格明细，请点击这里。</p><ul class=""><li id="c881" class="mz na it kh b ki kj km kn kq nb ku nc ky nd lc ne nf ng nh bi translated">区域可用性:单一区域</li><li id="346c" class="mz na it kh b ki ni km nj kq nk ku nl ky nm lc ne nf ng nh bi translated">机器类型:共享核心</li><li id="3a68" class="mz na it kh b ki ni km nj kq nk ku nl ky nm lc ne nf ng nh bi translated">存储:硬盘</li></ul><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nn"><img src="../Images/afe21ef8e3f2384ef075c22feb5a0e3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jPC8zXoFSen8KwsRchMnZg.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</p></figure><p id="9e95" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">创建该实例大约需要10分钟。</p><p id="66b3" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">然后让我们使用云外壳连接到实例。这是最容易连接的形式。记住你之前设置的密码就行了。存在其他选择，比如从本地机器使用<a class="ae ld" href="https://cloud.google.com/sql/docs/mysql/connect-connectors" rel="noopener ugc nofollow" target="_blank">数据库客户机的连接。</a></p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/cef58a1e6583f642e8cb6c2474fa2786.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k6o-W0WL4yuPrm1j_vf3rw.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</p></figure><p id="90f2" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">连接后，创建事务表。带有主键和其他常规字段的简单表。</p><p id="29fb" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">此外，我们向表中插入一些数据。</p><figure class="mu mv mw mx gt ju"><div class="bz fp l di"><div class="np nq l"/></div></figure><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/f91de488ea0d08d8c75df654bba54b41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_8_ANAW6uOH34pA2jX3IjQ.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</p></figure><p id="35d8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因此，我们有了PostgreSQL数据库和事务表，保留插入脚本，并在下一步模拟新事务后随意插入数据。</p><p id="7ce4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们准备转移到我们的分析区域。</p><h1 id="aec4" class="ll lm it bd ln lo mo lq lr ls mp lu lv lw mq ly lz ma mr mc md me ms mg mh mi bi translated">在BigQuery中</h1><p id="4851" class="pw-post-body-paragraph kf kg it kh b ki mj kk kl km mk ko kp kq ml ks kt ku mm kw kx ky mn la lb lc im bi translated">BigQuery是我们的数据工程和数据科学团队花费大量时间来转换公司数据并从中获得洞察力的地方。</p><p id="3ef5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了继续这个案例，BigQuery需要与我们的云SQL实例建立连接。这个连接将允许我们查询刚刚插入的数据。</p><p id="274b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在浏览器中，打开另一个选项卡，进入BigQuery界面。</p><p id="dc40" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们转到“添加数据”，然后单击“外部数据源”</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ns"><img src="../Images/ddf9d28fe1052dd5ca5ddc2247198392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dSPkJ7iG968mqSRsGMHzNQ.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</p></figure><p id="cc96" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果是第一次启用大查询连接API。</p><p id="d510" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在窗口的右边，会出现一个询问外部数据源的表单。添加您的连接id(您需要从云SQL页面复制的字符串)、数据库名称和用户密码。</p><p id="2cb6" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu"/><br/>重要——联邦表只在同一个项目中起作用。这意味着您的云SQL实例和大查询联邦表需要在同一个项目中。<br/> -仅适用于具有公共IP连接的云SQL实例。</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nt"><img src="../Images/7a694eb0d76b19041158b6ac7a72d5fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1VAKRxw_mE-Y7xC0yfEhCA.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</p></figure><p id="f1f0" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">就这么简单。最好的情况是，CloudSQL tabla中的每个更改都将反映在联邦表上，因此不需要运行提取管道。</p><p id="85b4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">最后，只需运行一个简单的查询！就像您观察到的查询表一样，您可以使用相同的BigQuery UI，除了一个<a class="ae ld" href="https://cloud.google.com/bigquery/docs/federated-queries-intro#federated_query_syntax" rel="noopener ugc nofollow" target="_blank">特殊语法</a>,因此所有的特性，如调度查询或保存都是允许的。</p><figure class="mu mv mw mx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/a947b127a3a2f9f2c047771a35579221.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QyZT_x9dsiLjv5av3kzNbg.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作者图片</p></figure><p id="9b96" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">另一个特性是，您不仅限于使用来自云SQL的数据，您可以将一个联邦查询结果与一个BigQuery表连接起来。这意味着您可以构建一个丰富的流程，从PostgreSQL中获取交易数据，并添加其他变量，如客户信息，以根据他们的购买情况发送特殊促销信息。</p><pre class="mu mv mw mx gt nv nw nx ny aw nz bi"><span id="9a38" class="oa lm it nw b gy ob oc l od oe">SELECT a.customer_id, a.name, b.first_order_date<br/>FROM bqdataset.customers AS a<br/>LEFT OUTER JOIN EXTERNAL_QUERY(<br/>  'projects/datapth/databaseconnection',<br/>  '''SELECT * FROM public.transactions''') AS b<br/>ON b.customer_id = a.customer_id<br/>GROUP BY c.customer_id, c.name, rq.first_order_date;</span></pre><h1 id="1fc3" class="ll lm it bd ln lo mo lq lr ls mp lu lv lw mq ly lz ma mr mc md me ms mg mh mi bi translated"><strong class="ak">注意事项</strong></h1><ul class=""><li id="8e65" class="mz na it kh b ki mj km mk kq of ku og ky oh lc ne nf ng nh bi translated"><a class="ae ld" href="https://cloud.google.com/bigquery/pricing#on_demand_pricing" rel="noopener ugc nofollow" target="_blank"> <strong class="kh iu">定价</strong> </a> <strong class="kh iu"> : </strong>根据外部查询返回的字节数向您收费(每TB 5美元)。</li><li id="812d" class="mz na it kh b ki ni km nj kq nk ku nl ky nm lc ne nf ng nh bi translated"><a class="ae ld" href="https://cloud.google.com/bigquery/docs/cloud-sql-federated-queries#limitations" rel="noopener ugc nofollow" target="_blank"> <strong class="kh iu">性能</strong> </a> : BigQuery需要等待源数据库执行外部查询，并将数据从外部数据源临时移动到BigQuery。</li><li id="656c" class="mz na it kh b ki ni km nj kq nk ku nl ky nm lc ne nf ng nh bi translated"><a class="ae ld" href="https://cloud.google.com/bigquery/docs/cloud-sql-federated-queries#data_type_mappings" rel="noopener ugc nofollow" target="_blank"> <strong class="kh iu">限制</strong> </a> : PostgreSQL支持很多BigQuery不支持的非标准数据类型，比如<code class="fe oi oj ok nw b">money</code>、<code class="fe oi oj ok nw b">path</code>、<code class="fe oi oj ok nw b">uuid or boxer.</code></li></ul><h1 id="30df" class="ll lm it bd ln lo mo lq lr ls mp lu lv lw mq ly lz ma mr mc md me ms mg mh mi bi translated">结论</h1><p id="6f4f" class="pw-post-body-paragraph kf kg it kh b ki mj kk kl km mk ko kp kq ml ks kt ku mm kw kx ky mn la lb lc im bi translated">BigQuery Cloud SQL federation是加速ELT开发的一个极好的特性。如果你想更进一步，我推荐你查看这篇关于增量数据接收管道的文章，然后回来重新思考这个小管道，为每日报告仪表板提供数据。</p><p id="5eae" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">PS如果你有任何问题，或者想要澄清什么，请给我发<a class="ae ld" href="http://t.me/adataarchitectguy" rel="noopener ugc nofollow" target="_blank">电报</a>、<a class="ae ld" href="https://www.facebook.com/dataarchitectguy" rel="noopener ugc nofollow" target="_blank">脸书</a>或<a class="ae ld" href="https://www.linkedin.com/in/antoniocachuan/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或者我喜欢讨论数据😊</p><h1 id="31c3" class="ll lm it bd ln lo mo lq lr ls mp lu lv lw mq ly lz ma mr mc md me ms mg mh mi bi translated">参考</h1><ul class=""><li id="ebc9" class="mz na it kh b ki mj km mk kq of ku og ky oh lc ne nf ng nh bi translated"><a class="ae ld" href="https://cloud.google.com/bigquery/docs/cloud-sql-federated-queries" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/cloud-SQL-federated-queries</a></li><li id="cac9" class="mz na it kh b ki ni km nj kq nk ku nl ky nm lc ne nf ng nh bi translated">【https://cloud.google.com/bigquery/docs/batch-loading-data】</li><li id="b149" class="mz na it kh b ki ni km nj kq nk ku nl ky nm lc ne nf ng nh bi translated"><a class="ae ld" href="https://cloud.google.com/blog/products/data-analytics/optimizing-your-bigquery-incremental-data-ingestion-pipelines" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/blog/products/data-analytics/optimizing-your-big query-incremental-data-ingestion-pipelines</a></li><li id="f114" class="mz na it kh b ki ni km nj kq nk ku nl ky nm lc ne nf ng nh bi translated"><a class="ae ld" href="https://cloud.google.com/bigquery/docs/federated-queries-intro#federated_query_syntax" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/federated-queries-intro # federated _ query _ syntax</a></li><li id="0212" class="mz na it kh b ki ni km nj kq nk ku nl ky nm lc ne nf ng nh bi translated"><a class="ae ld" href="https://cloud.google.com/sql/docs/postgres/quotas" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/sql/docs/postgres/quotas</a></li></ul></div></div>    
</body>
</html>