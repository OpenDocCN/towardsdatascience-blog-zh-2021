<html>
<head>
<title>API Interaction with R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">API与R的交互</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/api-interaction-with-r-46bf1d4f4fe6?source=collection_archive---------28-----------------------#2021-10-22">https://towardsdatascience.com/api-interaction-with-r-46bf1d4f4fe6?source=collection_archive---------28-----------------------#2021-10-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="fa93" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="b60d" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">演示与NHL API交互的插图</h2></div><p id="04a7" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这个文档是一个小插图，展示了如何从一个<a class="ae ln" href="https://en.wikipedia.org/wiki/API" rel="noopener ugc nofollow" target="_blank"> API </a>中检索数据。为了演示，我将与NHL API进行交互。我将构建一些函数来与一些端点进行交互，并探索一些我可以检索的数据。</p><p id="c1d3" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">需要注意的是，其中一些函数返回团队级别的数据。一些API使用特许ID号，而一些使用最近的团队ID来选择特定团队的端点。因此，如果您使用我的任何功能，我建议您提供完整的团队名称(例如<code class="fe lo lp lq lr b">"Montréal Canadiens"</code>)。我的函数会把它们解码成合适的ID号。</p><p id="52d3" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这篇文章很长，所以如果需要编写函数与API交互的例子，只需阅读前半部分。</p><p id="1468" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我在文章的底部提供了一个到github pages版本的链接，它提供了一个到github repo的链接。</p><h1 id="2d99" class="ls lt it bd lu lv lw lx ly lz ma mb mc ki md kj me kl mf km mg ko mh kp mi mj bi translated">要求</h1><p id="dbfb" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">为了使用与NHL API交互的函数，我使用了以下包:</p><ul class=""><li id="3b10" class="mp mq it kt b ku kv kx ky la mr le ms li mt lm mu mv mw mx bi translated"><code class="fe lo lp lq lr b"><a class="ae ln" href="https://www.tidyverse.org/" rel="noopener ugc nofollow" target="_blank">tidyverse</a></code>:大量有用的数据操作和可视化特性</li><li id="ff79" class="mp mq it kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated"><code class="fe lo lp lq lr b"><a class="ae ln" href="https://cran.r-project.org/web/packages/jsonlite/" rel="noopener ugc nofollow" target="_blank">jsonlite</a></code> : API交互</li></ul><p id="1d87" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">除了这些包之外，我还在文档的其余部分使用了以下包:</p><ul class=""><li id="b514" class="mp mq it kt b ku kv kx ky la mr le ms li mt lm mu mv mw mx bi translated"><code class="fe lo lp lq lr b"><a class="ae ln" href="https://cran.r-project.org/web/packages/cowplot/index.html" rel="noopener ugc nofollow" target="_blank">cowplot</a></code>:针对<code class="fe lo lp lq lr b">ggplot2</code>的额外功能</li><li id="0d8a" class="mp mq it kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated"><code class="fe lo lp lq lr b"><a class="ae ln" href="https://cran.r-project.org/web/packages/imager/" rel="noopener ugc nofollow" target="_blank">imager</a></code>:载入图像</li><li id="b19b" class="mp mq it kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated"><code class="fe lo lp lq lr b"><a class="ae ln" href="https://cran.r-project.org/web/packages/broom/vignettes/broom.html" rel="noopener ugc nofollow" target="_blank">broom</a></code>:整理回归输出进行显示</li><li id="d59b" class="mp mq it kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated">以友好的方式显示表格</li></ul><h1 id="3333" class="ls lt it bd lu lv lw lx ly lz ma mb mc ki md kj me kl mf km mg ko mh kp mi mj bi translated">API交互功能</h1><p id="2024" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">在这里，我定义了与<a class="ae ln" href="https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md" rel="noopener ugc nofollow" target="_blank"> NHL记录API </a>和<a class="ae ln" href="https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md" rel="noopener ugc nofollow" target="_blank"> NHL统计API </a>交互的函数，以及一些辅助函数。</p><h2 id="b953" class="nd lt it bd lu ne nf dn ly ng nh dp mc la ni nj me le nk nl mg li nm nn mi iz bi translated"><code class="fe lo lp lq lr b">convertToNumeric</code></h2><p id="3d18" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">我创建了这个助手函数来将包含存储为<code class="fe lo lp lq lr b">character</code>值的数字数据的列转换为数字数据类型。我遇到了一个问题，我的API调用将一些数字数据作为<code class="fe lo lp lq lr b">character</code>数据返回，我需要一种方法来处理这个问题，而不只是根据需要调用<code class="fe lo lp lq lr b">as.numeric</code>。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="c2ec" class="nd lt it lr b gy nw nx l ny nz">convertToNumeric <strong class="lr jd">&lt;-</strong> <strong class="lr jd">function</strong>(vec){<br/>  <em class="oa">###</em><br/>  <em class="oa"># This function will convert the input vector to a numeric vector    <br/>  # if it is able to. Otherwise, it just returns the vector.</em><br/>  <em class="oa">###</em><br/>  <br/>  <em class="oa"># If any of the values in vec return NA when trying to convert to <br/>  # numeric, set output to the unchanged input.</em><br/>  <strong class="lr jd">if</strong> (<strong class="lr jd">any</strong>(<strong class="lr jd">is.na</strong>(suppressWarnings(<strong class="lr jd">as.numeric</strong>(vec))) <strong class="lr jd">==</strong> <strong class="lr jd">TRUE</strong>)){<br/>    output <strong class="lr jd">&lt;-</strong> vec<br/>  }<br/>  <em class="oa"># Otherwise, convert vec to a numeric vector.</em><br/>  <strong class="lr jd">else</strong> {<br/>    output <strong class="lr jd">&lt;-</strong> <strong class="lr jd">as.numeric</strong>(vec)<br/>  }<br/>  <em class="oa"># Return output.</em><br/>  <strong class="lr jd">return</strong>(output)<br/>}</span></pre><h2 id="2bbe" class="nd lt it bd lu ne nf dn ly ng nh dp mc la ni nj me le nk nl mg li nm nn mi iz bi translated"><code class="fe lo lp lq lr b">franchise</code></h2><p id="35a2" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">我编写这个函数是为了与NHL Records API的<code class="fe lo lp lq lr b">franchise</code>端点进行交互。它返回一个<code class="fe lo lp lq lr b">data.frame</code>，包含NHL历史上每个<em class="oa">球队的第一个和最后一个赛季的球队和当前球队Id号、球队的名称和缩写。随着地点的改变，一些球队已经改变了球队的名字。它需要一个参数。<code class="fe lo lp lq lr b">team</code>，可以是<code class="fe lo lp lq lr b">"all"</code>，球队全称(如<code class="fe lo lp lq lr b">"New Jersey Devils"</code>)，也可以是<strong class="kt jd">球队Id </strong>(如<code class="fe lo lp lq lr b">23</code>新泽西魔鬼队)。</em></p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="8d7f" class="nd lt it lr b gy nw nx l ny nz">franchise <strong class="lr jd">&lt;-</strong> <strong class="lr jd">function</strong>(team<strong class="lr jd">=</strong>"all"){<br/>  <em class="oa">###</em><br/>  <em class="oa"># This functions returns a data.frame with metadata on NHL teams. <br/>  # It can also return those columns for a single team if a <br/>  # franchise ID or name is passed.</em><br/>  <em class="oa">###</em><br/>  <br/>  <em class="oa"># Get the franchise data from the franchises endpoint.</em><br/>  outputAPI <strong class="lr jd">&lt;-</strong> fromJSON(<br/>      "https://records.nhl.com/site/api/franchise"<br/>      )<br/>  <br/>  <em class="oa"># Select only the data.frame from the JSON output.</em><br/>  output <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>data<br/>  <br/>  <em class="oa"># If team does not equal "all", check if it is a franchise ID or <br/>  # team name.</em><br/>  <strong class="lr jd">if</strong> (team <strong class="lr jd">!=</strong> "all"){<br/>    <br/>    <em class="oa"># If team is in the id column, subset output for just that row.</em><br/>    <strong class="lr jd">if</strong> (team <strong class="lr jd">%in%</strong> output<strong class="lr jd">$</strong>id){<br/>      output <strong class="lr jd">&lt;-</strong> output <strong class="lr jd">%&gt;%</strong><br/>        filter(id <strong class="lr jd">==</strong> team)<br/>    }<br/>    <em class="oa"># If team is in the fullName column, subset output for just that <br/>    # row.</em><br/>    <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> (team <strong class="lr jd">%in%</strong> output<strong class="lr jd">$</strong>fullName){<br/>      output <strong class="lr jd">&lt;-</strong> output <strong class="lr jd">%&gt;%</strong><br/>        filter(fullName <strong class="lr jd">==</strong> team)<br/>    }<br/>    <em class="oa"># Otherwise, throw an informative error.</em><br/>    <strong class="lr jd">else</strong> {<br/>      message <strong class="lr jd">&lt;-</strong> paste("ERROR: Argument for team was not found in ",      <br/>                       "either the fullName or id columns. Try ",  <br/>                       "franchise('all') to find the franchise ", <br/>                       "you're looking for.")<br/>      stop(message)<br/>    }<br/>  }<br/>  <em class="oa"># Do nothing if the team value equals "all".</em><br/>  <strong class="lr jd">else</strong> {<br/>  }<br/>  <br/>  <em class="oa"># Convert any columns that should be numeric to numeric, while <br/>  # suppressing messages.</em><br/>  output <strong class="lr jd">&lt;-</strong> suppressMessages(<br/>                as.data.frame(lapply(output, convertToNumeric)))<br/>  <br/>  <em class="oa"># Return the output data.frame.</em><br/>  <strong class="lr jd">return</strong>(output)<br/>}</span></pre><h2 id="d517" class="nd lt it bd lu ne nf dn ly ng nh dp mc la ni nj me le nk nl mg li nm nn mi iz bi translated"><code class="fe lo lp lq lr b">teamTotals</code></h2><p id="b8b1" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">我编写这个函数是为了与NHL记录API的<code class="fe lo lp lq lr b">franchise-team-totals</code>端点进行交互。它返回了球队整个历史上常规赛和季后赛的大量统计数据。它需要一个参数。<code class="fe lo lp lq lr b">team</code>，可以是<code class="fe lo lp lq lr b">"all"</code>，球队全称(如<code class="fe lo lp lq lr b">"New Jersey Devils"</code>)，也可以是<strong class="kt jd">球队Id </strong>(如<code class="fe lo lp lq lr b">1</code>新泽西魔鬼队)。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="331a" class="nd lt it lr b gy nw nx l ny nz">teamTotals <strong class="lr jd">&lt;-</strong> <strong class="lr jd">function</strong>(team<strong class="lr jd">=</strong>"all"){<br/>  <em class="oa">###</em><br/>  <em class="oa"># This function returns total stats for every franchise (ex <br/>  # roadTies, roadWins, etc) unless a specific team Id or full team <br/>  # name is passed. Then it returns that data for the specific team.    <br/>  # The output is a data.frame.</em><br/>  <em class="oa">###</em><br/>  <br/>  <em class="oa"># Get the franchise data from the franchises endpoint.</em><br/>  outputAPI <strong class="lr jd">&lt;-</strong> fromJSON(<br/>    "https://records.nhl.com/site/api/franchise-team-totals"<br/>    )<br/>  <br/>  <em class="oa"># Select only the data.frame from the JSON output.</em><br/>  output <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>data<br/>  <br/>  <em class="oa"># If team does not equal "all", check if it is a team ID or team <br/>  # name.</em><br/>  <strong class="lr jd">if</strong> (team <strong class="lr jd">!=</strong> "all"){<br/>    <br/>    <em class="oa"># If team is in the teamId column, subset output for just that <br/>    # row.</em><br/>    <strong class="lr jd">if</strong> (team <strong class="lr jd">%in%</strong> output<strong class="lr jd">$</strong>teamId){<br/>      output <strong class="lr jd">&lt;-</strong> output <strong class="lr jd">%&gt;%</strong><br/>        filter(teamId <strong class="lr jd">==</strong> team)<br/>    }<br/>    <em class="oa"># If team is in the teamName column, subset output for just that <br/>    # row.</em><br/>    <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> (team <strong class="lr jd">%in%</strong> output<strong class="lr jd">$</strong>teamName){<br/>      output <strong class="lr jd">&lt;-</strong> output <strong class="lr jd">%&gt;%</strong><br/>        filter(teamName <strong class="lr jd">==</strong> team)<br/>    }<br/>    <em class="oa"># Otherwise, warn the user and return the entire dataframe.</em><br/>    <strong class="lr jd">else</strong> {<br/>      message <strong class="lr jd">&lt;-</strong> paste("WARNING: Argument for team was not found ",<br/>                       "in either the teamName or franchiseId ", <br/>                       "columns. Returning all franchises.")<br/>      warning(message)<br/>    }<br/>  }<br/>  <em class="oa"># Do nothing if the team value equals "all".</em><br/>  <strong class="lr jd">else</strong> {<br/>  }<br/>  <br/>  <em class="oa"># Convert any columns that should be numeric to numeric values.</em><br/>  output <strong class="lr jd">&lt;-</strong> suppressMessages(<br/>                as.data.frame(lapply(output, convertToNumeric)))<br/>  <br/>  <em class="oa"># Return the output data.frame.</em><br/>  <strong class="lr jd">return</strong>(output)<br/>}</span></pre><h2 id="d990" class="nd lt it bd lu ne nf dn ly ng nh dp mc la ni nj me le nk nl mg li nm nn mi iz bi translated"><code class="fe lo lp lq lr b">findId</code></h2><p id="1772" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">这是一个帮助功能，用于查找最新的球队Id或球队Id，以获得完整的球队名称(例如<code class="fe lo lp lq lr b">findId("Boston Bruins", "team")</code>或<code class="fe lo lp lq lr b">findId("Boston Bruins", "franchise")</code>)。它用于为API端点找到合适的Id号。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="5b70" class="nd lt it lr b gy nw nx l ny nz">findId <strong class="lr jd">&lt;-</strong> <strong class="lr jd">function</strong>(teamName, idType){<br/>  <br/>  <em class="oa"># Call the teamTotals function with the team name so we can look <br/>  # up the appropriate Id from it.</em><br/>  outputAPI <strong class="lr jd">&lt;-</strong> teamTotals(teamName)<br/>  <br/>  <em class="oa"># Retrieve the franchise Id if that is what the idType is.</em><br/>  <strong class="lr jd">if</strong> (idType <strong class="lr jd">==</strong> "franchise"){<br/>    output <strong class="lr jd">&lt;-</strong> outputAPI[1,]<strong class="lr jd">$</strong>franchiseId<br/>  }<br/>  <em class="oa"># Retrieve the team Id if that is what the idType is.</em><br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> (idType <strong class="lr jd">==</strong> "team"){<br/>    output <strong class="lr jd">&lt;-</strong> outputAPI[1,]<strong class="lr jd">$</strong>teamId<br/>  }<br/>  <em class="oa"># Any other argument throws an error.</em><br/>  <strong class="lr jd">else</strong> {<br/>    stop(paste("ERROR: Invalid idType argument! Should be ", <br/>               "'franchise' or 'team'!"))<br/>  }<br/>  <em class="oa"># Return the appropriate Id.</em><br/>  <strong class="lr jd">return</strong>(output)<br/>}</span></pre><h2 id="de5d" class="nd lt it bd lu ne nf dn ly ng nh dp mc la ni nj me le nk nl mg li nm nn mi iz bi translated"><code class="fe lo lp lq lr b">seasonRecords</code></h2><p id="0dab" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated"><code class="fe lo lp lq lr b">seasonRecords</code>函数返回单个专营权的记录统计数据。比如一个赛季进球最多的，以及他们进球的赛季。它需要一个参数。<code class="fe lo lp lq lr b">team</code>，可以是球队全称(如<code class="fe lo lp lq lr b">"New Jersey Devils"</code>)，也可以是<strong class="kt jd">球队Id </strong>(如<code class="fe lo lp lq lr b">23</code>新泽西魔鬼队)。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="d308" class="nd lt it lr b gy nw nx l ny nz">seasonRecords <strong class="lr jd">&lt;-</strong> <strong class="lr jd">function</strong>(team){<br/>  <em class="oa">###</em><br/>  <em class="oa"># This functions returns a data.frame with the season records for <br/>  # a variety of stats for a single team.</em><br/>  <em class="oa">###</em><br/>  <br/>  <em class="oa"># If team is a "character" type, try to look up the franchise id.</em><br/>  <strong class="lr jd">if</strong> (typeof(team) <strong class="lr jd">==</strong> "character"){<br/>    teamId <strong class="lr jd">=</strong> findId(team, "franchise")<br/>  }<br/>  <em class="oa"># If team is an integer, set teamId equal to team.</em><br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> ((typeof(team) <strong class="lr jd">==</strong> "double") <strong class="lr jd">&amp;</strong> (team <strong class="lr jd">%%</strong> 1 <strong class="lr jd">==</strong> 0)){<br/>    teamId <strong class="lr jd">=</strong> team<br/>  }<br/>  <em class="oa"># Otherwise, throw an error.</em><br/>  <strong class="lr jd">else</strong> {<br/>    message <strong class="lr jd">&lt;-</strong> paste("ERROR: Please pass a franchise id (integer) ", <br/>                     "or a full team name (e.g. 'Boston Bruins').")<br/>    stop(message)<br/>  }<br/>  <br/>  <em class="oa"># Set the base url, endpoint, and combine them with teamId for the <br/>  # full url.</em><br/>  baseURL <strong class="lr jd">&lt;-</strong> "https://records.nhl.com/site/api/"<br/>  endpoint <strong class="lr jd">&lt;-</strong> "franchise-season-records?cayenneExp=franchiseId="<br/>  fullURL <strong class="lr jd">&lt;-</strong> paste0(baseURL, endpoint, teamId)<br/>  <br/>  <em class="oa"># Get the API output.</em><br/>  outputAPI <strong class="lr jd">&lt;-</strong> fromJSON(fullURL)<br/>  <em class="oa"># Select only the data from the API output.</em><br/>  output <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>data<br/>  <br/>  <em class="oa"># Convert any columns that should be numeric to numeric format.</em><br/>  output <strong class="lr jd">&lt;-</strong> suppressMessages(<br/>                as.data.frame(lapply(output, convertToNumeric)))<br/>  <br/>  <em class="oa"># Return the output from the request.</em><br/>  <strong class="lr jd">return</strong>(output)<br/>}</span></pre><h2 id="3723" class="nd lt it bd lu ne nf dn ly ng nh dp mc la ni nj me le nk nl mg li nm nn mi iz bi translated"><code class="fe lo lp lq lr b">goalieRecords</code></h2><p id="36e5" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated"><code class="fe lo lp lq lr b">goalieRecords</code>函数返回为一个球队效力的所有守门员的统计数据。比如一场比赛最多的扑救，比赛日期。它需要一个参数。<code class="fe lo lp lq lr b">team</code>，可以是球队全称(如<code class="fe lo lp lq lr b">"New Jersey Devils"</code>)，也可以是<strong class="kt jd">球队Id </strong>(如<code class="fe lo lp lq lr b">23</code>新泽西魔鬼队)。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="53ab" class="nd lt it lr b gy nw nx l ny nz">goalieRecords <strong class="lr jd">&lt;-</strong> <strong class="lr jd">function</strong>(team){<br/>  <em class="oa">###</em><br/>  <em class="oa"># This functions returns a data.frame with the goalie records for <br/>  # a team.</em><br/>  <em class="oa">###</em><br/>  <br/>  <em class="oa"># If team is a "character" type, try to look up the franchise id.</em><br/>  <strong class="lr jd">if</strong> (typeof(team) <strong class="lr jd">==</strong> "character"){<br/>    teamId <strong class="lr jd">=</strong> findId(team, "franchise")<br/>  }<br/>  <em class="oa"># If team is an integer, set teamId equal to team.</em><br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> ((typeof(team) <strong class="lr jd">==</strong> "double") <strong class="lr jd">&amp;</strong> (team <strong class="lr jd">%%</strong> 1 <strong class="lr jd">==</strong> 0)){<br/>    teamId <strong class="lr jd">=</strong> team<br/>  }<br/>  <em class="oa"># Otherwise, throw an error.</em><br/>  <strong class="lr jd">else</strong> {<br/>    message <strong class="lr jd">&lt;-</strong> paste("ERROR: Please pass a franchise id (integer) ",         <br/>                     "or a full team name (e.g. 'Boston Bruins').")<br/>    stop(message)<br/>  }<br/>  <br/>  <em class="oa"># Set the base url, endpoint, and combine them with teamId for the <br/>  # full url.</em><br/>  baseURL <strong class="lr jd">&lt;-</strong> "https://records.nhl.com/site/api/"<br/>  endpoint <strong class="lr jd">&lt;-</strong> "franchise-goalie-records?cayenneExp=franchiseId="<br/>  fullURL <strong class="lr jd">&lt;-</strong> paste0(baseURL, endpoint, teamId)<br/>  <br/>  <em class="oa"># Get the API output.</em><br/>  outputAPI <strong class="lr jd">&lt;-</strong> fromJSON(fullURL)<br/>  <em class="oa"># Select only the data from the JSON output.</em><br/>  output <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>data<br/>  <br/>  <em class="oa"># Convert any columns that should be numeric to numeric format.</em><br/>  output <strong class="lr jd">&lt;-</strong> suppressMessages(<br/>                as.data.frame(lapply(output, convertToNumeric)))<br/>  <br/>  <em class="oa"># Return the output from the request.</em><br/>  <strong class="lr jd">return</strong>(output)<br/>}</span></pre><h2 id="5065" class="nd lt it bd lu ne nf dn ly ng nh dp mc la ni nj me le nk nl mg li nm nn mi iz bi translated"><code class="fe lo lp lq lr b">skaterRecords</code></h2><p id="1fe8" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated"><code class="fe lo lp lq lr b">skaterRecords</code>函数返回所有为一个球队效力的非守门员球员的数据。例如，他们在一个赛季中被罚的时间最多，以及这个赛季发生的时间。它需要一个参数。<code class="fe lo lp lq lr b">team</code>，可以是球队全称(如<code class="fe lo lp lq lr b">"New Jersey Devils"</code>)，也可以是<strong class="kt jd">球队Id </strong>(如<code class="fe lo lp lq lr b">23</code>新泽西魔鬼队)。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="18bf" class="nd lt it lr b gy nw nx l ny nz">skaterRecords <strong class="lr jd">&lt;-</strong> <strong class="lr jd">function</strong>(team){<br/>  <em class="oa">###</em><br/>  <em class="oa"># This functions returns a data.frame with the skater records for <br/>  # a team.</em><br/>  <em class="oa">###</em><br/>  <br/>  <em class="oa"># If team is a "character" type, try to look up the franchise id.</em><br/>  <strong class="lr jd">if</strong> (typeof(team) <strong class="lr jd">==</strong> "character"){<br/>    teamId <strong class="lr jd">=</strong> findId(team, "franchise")<br/>  }<br/>  <em class="oa"># If team is an integer, set teamId equal to team.</em><br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> ((typeof(team) <strong class="lr jd">==</strong> "double") <strong class="lr jd">&amp;</strong> (team <strong class="lr jd">%%</strong> 1 <strong class="lr jd">==</strong> 0)){<br/>    teamId <strong class="lr jd">=</strong> team<br/>  }<br/>  <em class="oa"># Otherwise, throw an error.</em><br/>  <strong class="lr jd">else</strong> {<br/>    message <strong class="lr jd">&lt;-</strong> paste("ERROR: Please pass a franchise id (integer) ",     <br/>                     "or a full team name (e.g. 'Boston Bruins').")<br/>    stop(message)<br/>  }<br/>  <br/>  <em class="oa"># Set the base url, endpoint, and combine them with teamId for the <br/>  # full url.</em><br/>  baseURL <strong class="lr jd">&lt;-</strong> "https://records.nhl.com/site/api/"<br/>  endpoint <strong class="lr jd">&lt;-</strong> "franchise-skater-records?cayenneExp=franchiseId="<br/>  fullURL <strong class="lr jd">&lt;-</strong> paste0(baseURL, endpoint, teamId)<br/>  <br/>  <em class="oa"># Get the API output.</em><br/>  outputAPI <strong class="lr jd">&lt;-</strong> fromJSON(fullURL)<br/>  <em class="oa"># Select only the data from the JSON output.</em><br/>  output <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>data<br/>  <br/>  <em class="oa"># Convert any columns that should be numeric to numeric format.</em><br/>  output <strong class="lr jd">&lt;-</strong> suppressMessages(<br/>                as.data.frame(lapply(output, convertToNumeric)))<br/>  <br/>  <em class="oa"># Return the output from the request.</em><br/>  <strong class="lr jd">return</strong>(output)<br/>}</span></pre><h2 id="e0c4" class="nd lt it bd lu ne nf dn ly ng nh dp mc la ni nj me le nk nl mg li nm nn mi iz bi translated"><code class="fe lo lp lq lr b">franchiseDetail</code></h2><p id="0512" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">这个函数获取特许经营权的信息，比如他们的退休号码。它需要一个参数。<code class="fe lo lp lq lr b">team</code>，可以是球队全称(如<code class="fe lo lp lq lr b">"New Jersey Devils"</code>)，也可以是<strong class="kt jd">最近的球队Id </strong>(如<code class="fe lo lp lq lr b">1</code>新泽西魔鬼队)。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="c829" class="nd lt it lr b gy nw nx l ny nz">franchiseDetail <strong class="lr jd">&lt;-</strong> <strong class="lr jd">function</strong>(team){<br/>  <em class="oa">###</em><br/>  <em class="oa"># This functions returns a data.frame with the data for a team.</em><br/>  <em class="oa">###</em><br/>  <br/>  <em class="oa"># If team is a "character" type, try to look up the team id.</em><br/>  <strong class="lr jd">if</strong> (typeof(team) <strong class="lr jd">==</strong> "character"){<br/>    teamId <strong class="lr jd">=</strong> findId(team, "team")<br/>  }<br/>  <em class="oa"># If team is an integer, set teamId equal to team.</em><br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> ((typeof(team) <strong class="lr jd">==</strong> "double") <strong class="lr jd">&amp;</strong> (team <strong class="lr jd">%%</strong> 1 <strong class="lr jd">==</strong> 0)){<br/>    teamId <strong class="lr jd">=</strong> team<br/>  }<br/>  <em class="oa"># Otherwise, throw an error.</em><br/>  <strong class="lr jd">else</strong> {<br/>    message <strong class="lr jd">&lt;-</strong> paste("ERROR: Please pass a team id (integer) or ",<br/>                     "a full team name (e.g. 'Boston Bruins').")<br/>    stop(message)<br/>  }<br/>  <br/>  <em class="oa"># Set the base url, endpoint, and combine them with teamId for the <br/>  # full url.</em><br/>  baseURL <strong class="lr jd">&lt;-</strong> "https://records.nhl.com/site/api/"<br/>  endpoint <strong class="lr jd">&lt;-</strong> "franchise-detail?cayenneExp=mostRecentTeamId="<br/>  fullURL <strong class="lr jd">&lt;-</strong> paste0(baseURL, endpoint, teamId)<br/>  <br/>  <em class="oa"># Get the API output.</em><br/>  outputAPI <strong class="lr jd">&lt;-</strong> fromJSON(fullURL)<br/>  <em class="oa"># Select only the data from the JSON output.</em><br/>  output <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>data<br/>  <br/>  <em class="oa"># If the output has no rows after becoming a data.frame, then the <br/>  # team is now a different team under an active franchise. Then we   <br/>  # need to re-run the query with the appropriate team Id.</em><br/>  <strong class="lr jd">if</strong> (nrow(as.data.frame(output)) <strong class="lr jd">==</strong> 0){<br/>    <br/>    <em class="oa"># Find the most recent team Id for this deprecated team that is <br/>    # in the history of the active franchise.</em><br/>    teamId <strong class="lr jd">&lt;-</strong> franchise(findId(team, "franchise"))<strong class="lr jd">$</strong>mostRecentTeamId<br/>    <br/>    <em class="oa"># Combine the URL components with teamId for the full url.</em><br/>    fullURL <strong class="lr jd">&lt;-</strong> paste0(baseURL, endpoint, teamId)<br/>    <br/>    <em class="oa"># Get the API output.</em><br/>    outputAPI <strong class="lr jd">&lt;-</strong> fromJSON(fullURL)<br/>    <em class="oa"># Select only the data from the JSON output.</em><br/>    output <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>data<br/>    }<br/>  <br/>  <em class="oa"># Convert any columns that should be numeric to numeric format.</em><br/>  output <strong class="lr jd">&lt;-</strong> suppressMessages(<br/>                as.data.frame(lapply(output, convertToNumeric)))<br/>  <br/>  <em class="oa"># Return the output from the request.</em><br/>  <strong class="lr jd">return</strong>(output)<br/>}</span></pre><h2 id="3927" class="nd lt it bd lu ne nf dn ly ng nh dp mc la ni nj me le nk nl mg li nm nn mi iz bi translated"><code class="fe lo lp lq lr b">seasonStats</code></h2><p id="8550" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">这个函数返回一个包含当前赛季统计数据的<code class="fe lo lp lq lr b">data.frame</code>。它需要一个参数。<code class="fe lo lp lq lr b">team</code>，可以是<code class="fe lo lp lq lr b">"all"</code>，现役球队的全称(如<code class="fe lo lp lq lr b">"New Jersey Devils"</code>)，也可以是<strong class="kt jd">最近的球队Id </strong>(如<code class="fe lo lp lq lr b">1</code>新泽西魔鬼队)。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="3cff" class="nd lt it lr b gy nw nx l ny nz">seasonStats <strong class="lr jd">&lt;-</strong> <strong class="lr jd">function</strong>(team<strong class="lr jd">=</strong>"all", raw<strong class="lr jd">=FALSE</strong>){<br/>  <em class="oa">###</em><br/>  <em class="oa"># Returns the current seasons stats for all teams or just one. If <br/>  # raw is FALSE, it returns only the stats. If raw is TRUE, it just <br/>  # returns the API output for the user to parse.</em><br/>  <em class="oa">###</em><br/>  <br/>  <em class="oa"># If raw is not a valid input, throw an error.</em><br/>  <strong class="lr jd">if</strong> ((raw <strong class="lr jd">!=</strong> <strong class="lr jd">TRUE</strong>) <strong class="lr jd">&amp;</strong> (raw <strong class="lr jd">!=</strong> <strong class="lr jd">FALSE</strong>)){<br/>    stop("ERROR: Argument for raw must equal TRUE or FALSE!")<br/>  }<br/>  <em class="oa"># Otherwise do nothing.</em><br/>  <strong class="lr jd">else</strong> {<br/>  }<br/>  <br/>  <em class="oa"># If team equals "all" the spot where ID goes in the URL will be <br/>  # blank.</em><br/>  <strong class="lr jd">if</strong> (team <strong class="lr jd">==</strong> "all"){<br/>    teamId <strong class="lr jd">=</strong> ""<br/>  }<br/>  <em class="oa"># If team is a "character" type, try to look up the team id.</em><br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> (typeof(team) <strong class="lr jd">==</strong> "character"){<br/>    teamId <strong class="lr jd">=</strong> findId(team, "team")<br/>  }<br/>  <em class="oa"># If team is an integer, set teamId equal to team.</em><br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> ((typeof(team) <strong class="lr jd">==</strong> "double") <strong class="lr jd">&amp;</strong> (team <strong class="lr jd">%%</strong> 1 <strong class="lr jd">==</strong> 0)){<br/>    teamId <strong class="lr jd">=</strong> team<br/>  }<br/>  <em class="oa"># Otherwise, throw an error.</em><br/>  <strong class="lr jd">else</strong> {<br/>    message <strong class="lr jd">&lt;-</strong> paste("ERROR: Please pass a team id (integer) or ",<br/>                     "a full team name (e.g. 'Boston Bruins').")<br/>    stop(message)<br/>  }<br/>  <br/>  <em class="oa"># Paste together the endpoint URL from its components.</em><br/>  baseURL <strong class="lr jd">&lt;-</strong> "https://statsapi.web.nhl.com/api/v1/teams/"<br/>  modifier <strong class="lr jd">&lt;-</strong> "?expand=team.stats"<br/>  fullURL <strong class="lr jd">&lt;-</strong> paste0(baseURL, teamId, modifier)<br/>  <em class="oa"># Get the data from the endpoint.</em><br/>  outputAPI <strong class="lr jd">&lt;-</strong> fromJSON(fullURL, flatten<strong class="lr jd">=TRUE</strong>)<br/>  <br/>  <em class="oa"># If the user doesn't want every team's data, execute this chunk.</em><br/>  <strong class="lr jd">if</strong> (team <strong class="lr jd">!=</strong> "all"){<br/>    <br/>    <em class="oa"># If raw is FALSE, give back only the stats.</em><br/>    <strong class="lr jd">if</strong> (raw <strong class="lr jd">==</strong> <strong class="lr jd">FALSE</strong>){<br/>      <em class="oa"># Navigate through the columns and list indices to select the <br/>      # stats only.</em><br/>      teamStats <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>teams<strong class="lr jd">$</strong>teamStats[[1]]<strong class="lr jd">$</strong>splits[[1]][1,]<br/>      <em class="oa"># Convert any columns that should be numeric to numeric.</em><br/>      teamStats <strong class="lr jd">&lt;-</strong> suppressMessages(<br/>                       as.data.frame(lapply(teamStats,                                 <br/>                                            convertToNumeric)))<br/>    }<br/>    <em class="oa"># If the user wants the raw API output, give it to them so they <br/>    # can parse it themselves.</em><br/>    <strong class="lr jd">else</strong> {<br/>      teamStats <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>teams<br/>    }<br/>  }<br/>  <em class="oa"># Otherwise, return them the data for all teams.</em><br/>  <strong class="lr jd">else</strong> {<br/>    <br/>    <em class="oa"># If raw is FALSE, give back only the stats.</em><br/>    <strong class="lr jd">if</strong> (raw <strong class="lr jd">==</strong> <strong class="lr jd">FALSE</strong>){<br/>      <br/>      <em class="oa"># Get the teamStats list where each element is a data.frame.</em><br/>      output <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>teams<strong class="lr jd">$</strong>teamStats<br/>      <em class="oa"># Count the number of teams. The last element is NULL.</em><br/>      num_teams <strong class="lr jd">=</strong> <strong class="lr jd">length</strong>(output) <strong class="lr jd">-</strong> 1<br/>      <em class="oa"># Make a variable to hold just the stats, starting with the <br/>      # first team.</em><br/>      teamStats <strong class="lr jd">&lt;-</strong> output[[1]]<strong class="lr jd">$</strong>splits[[1]][1,]<br/>      <br/>      <em class="oa"># Loop through the 2nd to the last team in the list.</em><br/>      <strong class="lr jd">for</strong> (i <strong class="lr jd">in</strong> seq(2, num_teams)){<br/>        <em class="oa"># Select only the first row of the seasons stats for the <br/>        # team.</em><br/>        stats <strong class="lr jd">&lt;-</strong> output[[i]]<strong class="lr jd">$</strong>splits[[1]][1,]<br/>        <em class="oa"># Add the row to teamStats.</em><br/>        teamStats <strong class="lr jd">&lt;-</strong> rbind(teamStats, stats)<br/>      }<br/>    <em class="oa"># Convert any columns that should be numeric to numeric format.</em><br/>    teamStats <strong class="lr jd">&lt;-</strong> suppressMessages(<br/>                     as.data.frame(lapply(teamStats,                                 <br/>                                          convertToNumeric)))<br/>    }<br/>    <em class="oa"># If the user wants the raw API output, give it to them so they <br/>    # can parse it themselves.</em><br/>    <strong class="lr jd">else</strong> {<br/>      teamStats <strong class="lr jd">&lt;-</strong> outputAPI<strong class="lr jd">$</strong>teams<br/>    }<br/>  }<br/>  <br/>  <em class="oa"># Return teamStats.</em><br/>  <strong class="lr jd">return</strong>(teamStats)<br/>}</span></pre><h2 id="d227" class="nd lt it bd lu ne nf dn ly ng nh dp mc la ni nj me le nk nl mg li nm nn mi iz bi translated"><code class="fe lo lp lq lr b">nhlAPI</code></h2><p id="e33a" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">这个函数是上面所有其他函数的包装函数。您只需传递想要使用的函数名，比如<code class="fe lo lp lq lr b">"seasonStats"</code>，以及该函数的任何附加参数。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="7e04" class="nd lt it lr b gy nw nx l ny nz">nhlAPI <strong class="lr jd">&lt;-</strong> <strong class="lr jd">function</strong>(func, ...){<br/>  <em class="oa">###</em><br/>  <em class="oa"># This function is a wrapper for the other functions. It takes in <br/>  # the name of the function to use as a character and any <br/>  # additional arguments for that function.</em><br/>  <em class="oa">###</em><br/>  <br/>  <em class="oa"># Find and call the appropriate function using conditional logic.</em><br/>  <strong class="lr jd">if</strong> (func <strong class="lr jd">==</strong> "franchise"){<br/>    output <strong class="lr jd">&lt;-</strong> franchise(...)<br/>  }<br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> (func <strong class="lr jd">==</strong> "teamTotals"){<br/>    output <strong class="lr jd">&lt;-</strong> teamTotals(...)<br/>  }<br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> (func <strong class="lr jd">==</strong> "seasonRecords"){<br/>    output <strong class="lr jd">&lt;-</strong> seasonRecords(...)<br/>  }<br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> (func <strong class="lr jd">==</strong> "goalieRecords"){<br/>    output <strong class="lr jd">&lt;-</strong> goalieRecords(...)<br/>  }<br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> (func <strong class="lr jd">==</strong> "skaterRecords"){<br/>    output <strong class="lr jd">&lt;-</strong> skaterRecords(...)<br/>  }<br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> (func <strong class="lr jd">==</strong> "franchiseDetail"){<br/>    output <strong class="lr jd">&lt;-</strong> franchiseDetail(...)<br/>  }<br/>  <strong class="lr jd">else</strong> <strong class="lr jd">if</strong> (func <strong class="lr jd">==</strong> "seasonStats"){<br/>    output <strong class="lr jd">&lt;-</strong> seasonStats(...)<br/>  }<br/>  <strong class="lr jd">else</strong> {<br/>    stop("ERROR: Argument for func is not valid!")<br/>  }<br/>  <br/>  <em class="oa"># Return the output from the appropriate function.</em><br/>  <strong class="lr jd">return</strong>(output)<br/>}</span></pre><h1 id="8732" class="ls lt it bd lu lv lw lx ly lz ma mb mc ki md kj me kl mf km mg ko mh kp mi mj bi translated">数据探索</h1><p id="d42b" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">现在我们可以与NHL API的一些端点进行交互，让我们从它们那里获取一些数据。</p><p id="f159" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">首先，让我们通过调用<code class="fe lo lp lq lr b">nhlAPI("seasonStats")</code>来获取所有球队的当前赛季统计数据。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="ca6e" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Get the current season stats for all of the teams in the NHL.</em><br/>currentSeason <strong class="lr jd">&lt;-</strong> nhlAPI("seasonStats")</span></pre><p id="9886" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我感兴趣的两个变量是场均投篮次数和投篮命中率。我对这两个数据与球队胜率的关系很感兴趣。这个变量不存在，我需要计算一下。我把这个定义为赢的次数除以比赛的总次数。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="2ef8" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Add a column for the win percentage.</em><br/>currentSeason <strong class="lr jd">&lt;-</strong> currentSeason <strong class="lr jd">%&gt;%</strong><br/>  mutate(winPercentage <strong class="lr jd">=</strong> stat.wins <strong class="lr jd">/</strong> stat.gamesPlayed)</span></pre><p id="f461" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我的猜测是，这两者与胜率正相关。高投篮命中率意味着你很有可能在投篮时得分。每场比赛的高投篮次数可能意味着你比其他球队控制球更多，你有更多的得分机会，除非你投篮命中率高。这两个数据似乎都是进攻力量的伟大代表。</p><p id="5e96" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">下面我绘制了每场比赛的胜率和投篮命中率。我还添加了一条回归线。正如所料，两者都与胜率正相关。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="4f40" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Create a scatter plot of win pct vs. shots per game.</em><br/>plot1 <strong class="lr jd">&lt;-</strong> ggplot(currentSeason, aes(stat.shotsPerGame,<br/>                                   winPercentage,<br/>                                   color<strong class="lr jd">=</strong>winPercentage)) <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a scatter plot layer and adjust the size and opaqueness of <br/>  # points.</em><br/>  geom_point(size<strong class="lr jd">=</strong>4, alpha<strong class="lr jd">=</strong>0.75) <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a color gradient for winPercentage.</em><br/>  scale_color_gradient(low<strong class="lr jd">=</strong>"blue", high<strong class="lr jd">=</strong>"red") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Remove the legend because it takes up space.</em><br/>  theme(legend.position<strong class="lr jd">=</strong>"none") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a black regression line.</em><br/>  geom_smooth(method<strong class="lr jd">=</strong>lm, formula<strong class="lr jd">=</strong>y<strong class="lr jd">~</strong>x, color<strong class="lr jd">=</strong>"black") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add labels to the axes.</em><br/>  scale_x_continuous("Shots per Game") <strong class="lr jd">+</strong> <br/>  scale_y_continuous("Win Percentage") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a title.</em><br/>  ggtitle("Win Pct. vs. Shots per Game")</span><span id="7bfe" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Create a scatter plot of win pct vs. shooting pct.</em><br/>plot2 <strong class="lr jd">&lt;-</strong> ggplot(currentSeason, aes(stat.shootingPctg,<br/>                                   winPercentage,<br/>                                   color<strong class="lr jd">=</strong>winPercentage)) <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a scatter plot layer and adjust the size and opaqueness of <br/>  # points.</em><br/>  geom_point(size<strong class="lr jd">=</strong>4, alpha<strong class="lr jd">=</strong>0.75) <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a color gradient for winPercentage.</em><br/>  scale_color_gradient(low<strong class="lr jd">=</strong>"blue", high<strong class="lr jd">=</strong>"red") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Remove the legend because it takes up space.</em><br/>  theme(legend.position<strong class="lr jd">=</strong>"none") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a black regression line.</em><br/>  geom_smooth(method<strong class="lr jd">=</strong>lm, formula<strong class="lr jd">=</strong>y<strong class="lr jd">~</strong>x, color<strong class="lr jd">=</strong>"black") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add labels to the axes.</em><br/>  scale_x_continuous("Shooting Percentage") <strong class="lr jd">+</strong> <br/>  scale_y_continuous("Win Percentage") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a title.</em><br/>  ggtitle("Win Pct. vs. Shooting Pct.")</span><span id="66e8" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Plot them side-by-side.</em><br/>plot_grid(plot1, plot2, ncol<strong class="lr jd">=</strong>2)</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/80c49daff92c9f77a675f1da0966c53a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*qmw4t7Wp4PzmfUD1.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">作者图片</p></figure><p id="2674" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在让我们看看投篮命中率和场均投篮次数。我为获胜百分比添加了一个颜色渐变。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="93ad" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Create a scatter plot of shooting pct vs. shots per game.</em><br/>plot3 <strong class="lr jd">&lt;-</strong> ggplot(currentSeason, aes(stat.shotsPerGame,<br/>                                   stat.shootingPctg,<br/>                                   color<strong class="lr jd">=</strong>winPercentage)) <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a scatter plot layer and adjust the size and opaqueness of <br/>  # points.</em><br/>  geom_point(size<strong class="lr jd">=</strong>4, alpha<strong class="lr jd">=</strong>0.75) <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a color gradient for winPercentage with an improved label.</em><br/>  scale_color_gradient(low<strong class="lr jd">=</strong>"blue", high<strong class="lr jd">=</strong>"red", name<strong class="lr jd">=</strong>"Win Pct.") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add labels to the axes.</em><br/>  scale_x_continuous("Shots per Game") <strong class="lr jd">+</strong> <br/>  scale_y_continuous("Shooting Percentage") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a title.</em><br/>  ggtitle("Shooting Pct. vs. Shots per Game") </span><span id="b041" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Show the plot.</em><br/>plot3</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/be5c5c206211a7a2573eebd5b5971926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*2aGh1kwVZ8swiE7O.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">作者图片</p></figure><p id="c0e9" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">这两个变量之间似乎没有明确的关系，而我认为可能有。让我们看看另一个端点的数据。</p><p id="ee17" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">让我们来看看所有参加过NHL的球队的历史数据。请注意，其中一些球队属于同一支球队。我将属于同一支球队的球队视为独立的球队(例如科罗拉多洛矶队和新泽西魔鬼队)。我调用了<code class="fe lo lp lq lr b">nhlAPI("teamTotals")</code>来获取这个数据。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="bffc" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Get some stats for the total history of a team.</em><br/>teamTotalStats <strong class="lr jd">&lt;-</strong> nhlAPI("teamTotals")</span></pre><p id="9861" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">首先，让我们看看非活动团队与活动团队的数量。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="6e77" class="nd lt it lr b gy nw nx l ny nz">teamStatus <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Filter for regular season stats.</em><br/>  filter(gameTypeId <strong class="lr jd">==</strong> 2) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Create a column that tells whether a team is active or not.</em><br/>  mutate(currentlyActive <strong class="lr jd">=</strong> ifelse(<strong class="lr jd">is.na</strong>(lastSeasonId), <br/>                                  "Active", "Inactive")) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Select the teamName and activity status columns.</em><br/>  select(teamName, currentlyActive)</span><span id="d5a9" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Count the number of active and inactive teams.</em><br/>numActive <strong class="lr jd">&lt;-</strong> <strong class="lr jd">sum</strong>(teamStatus <strong class="lr jd">==</strong>"Active")<br/>numInactive <strong class="lr jd">&lt;-</strong> <strong class="lr jd">sum</strong>(teamStatus <strong class="lr jd">==</strong>"Inactive")</span></pre><p id="904d" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">有26个不活跃的团队和31个活跃的团队(只是提醒一下，我把转移到其他地方的团队视为不活跃的)。</p><p id="2cd6" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">不是所有的球队都有相同的任期，我想调整一些统计数据，以便能够在相同的基础上比较球队。我对各队的点球时间和记录特别感兴趣。</p><p id="4616" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">为了在相同的基础上得到数字，当比赛次数如此不同时，我计算每场比赛的罚分钟数，总罚分钟数除以总比赛次数。我再次计算获胜百分比，即获胜次数除以游戏次数。</p><p id="f190" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我还对季后赛或常规赛如何影响罚球时间感兴趣，因为我认为季后赛的重要性可能会导致罚球行为的变化。</p><p id="6419" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">此外，我还创建了一个列，<code class="fe lo lp lq lr b">recordType</code>,用于指示一个团队是否有输赢记录。如果赢的百分比大于0.5，他们被分类为有赢的记录，否则为输的记录。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="fbe0" class="nd lt it lr b gy nw nx l ny nz">teamTotalStats <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Add columns for penalty minutes per game, win percentage, a text</em><br/>  <em class="oa"># representation of the game type, and whether a team has a losing <br/>  # or winning record for the game type.</em><br/>  mutate(penaltyMinutesPerGame <strong class="lr jd">=</strong> penaltyMinutes <strong class="lr jd">/</strong> gamesPlayed,<br/>         winPercentage <strong class="lr jd">=</strong> wins <strong class="lr jd">/</strong> gamesPlayed,<br/>         gameType <strong class="lr jd">=</strong> ifelse(gameTypeId <strong class="lr jd">==</strong> 2, "Regular Season", <br/>                           "Playoffs"),<br/>         recordType <strong class="lr jd">=</strong> ifelse(wins <strong class="lr jd">&gt;</strong> losses, "Winning Record", <br/>                             "Losing Record"))</span></pre><p id="2bd6" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">下表显示了按游戏类型统计的有输赢记录的活跃队伍的数量。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="170d" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Filter for active teams by looking for missing values in <br/># lastSeasonId.</em><br/>activeTeams <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong><br/>  filter((<strong class="lr jd">is.na</strong>(lastSeasonId) <strong class="lr jd">==</strong> <strong class="lr jd">TRUE</strong>))</span><span id="b082" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Display a table of the game types by record types for active <br/># teams.</em><br/>knitr<strong class="lr jd">::</strong>kable(table(activeTeams<strong class="lr jd">$</strong>gameType, activeTeams<strong class="lr jd">$</strong>recordType),<br/>             caption<strong class="lr jd">=</strong>paste("Counts of Franchise Record Types by ", <br/>                           "Game Type for Active Teams"))</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/2fb70e50014eb3f2a98976ed7efe5b64.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*f3PUyN6sqshE4zniS83Y8A.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">现役球队按游戏类型统计的特许经营记录类型(图片由作者提供)</p></figure><p id="4051" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">下面是不活跃团队的相同表格。从这些表格中可以清楚地看出，不活跃的队伍比活跃的队伍要差得多。他们可能很难吸引观众和销售商品，因为他们太差了。这可能是它们不再存在的原因。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="d4a5" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Filter for only inactive teams by looking for rows where <br/># lastSeasonId is not missing.</em><br/>inactiveTeams <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong><br/>  filter((<strong class="lr jd">is.na</strong>(lastSeasonId) <strong class="lr jd">==</strong> <strong class="lr jd">FALSE</strong>))</span><span id="a32f" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Count the number of inactive teams using the number of teams with <br/># regular season games.</em><br/>numInactiveTeams <strong class="lr jd">&lt;-</strong> <strong class="lr jd">dim</strong>(filter(inactiveTeams, gameTypeId <strong class="lr jd">==</strong> 2))[1]</span><span id="6add" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Count the number of inactive teams that made it to the playoffs, <br/># which is not all of the inactive teams.</em><br/>numInactiveTeamsInPlayoffs <strong class="lr jd">&lt;-</strong> <strong class="lr jd">dim</strong>(<br/>    filter(inactiveTeams, gameTypeId <strong class="lr jd">==</strong> 3))[1]</span><span id="8b61" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Count the number of inactive teams who did not make the playoffs.</em><br/>numDidntMakePlayoffs <strong class="lr jd">&lt;-</strong> numInactiveTeams<strong class="lr jd">-</strong>numInactiveTeamsInPlayoffs</span><span id="d658" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Create an index for the last row in inactive teams.</em><br/>currentEndRow <strong class="lr jd">&lt;-</strong> nrow(inactiveTeams)</span><span id="20ca" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Add as many empty rows to inactiveTeams as teams not making the <br/># playoffs.</em><br/>inactiveTeams[currentEndRow<strong class="lr jd">+</strong>seq(numDidntMakePlayoffs),] <strong class="lr jd">&lt;-</strong> <strong class="lr jd">NA</strong></span><span id="4a39" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Teams without playoff data do not have rows for that game type. <br/># I'm going to add the proper number of losing records to the <br/># dataframe to account for the missing rows for the playoffs.</em><br/>inactiveTeams[currentEndRow<strong class="lr jd">+</strong>seq(numDidntMakePlayoffs), <br/>              "recordType"] <strong class="lr jd">&lt;-</strong> "Losing Record"</span><span id="0443" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># To make the table work, I need to make the gameType of these rows <br/># "Playoffs".</em><br/>inactiveTeams[currentEndRow<strong class="lr jd">+</strong>seq(numDidntMakePlayoffs), <br/>              "gameType"] <strong class="lr jd">&lt;-</strong> "Playoffs"</span><span id="a3b7" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Display a table of the game types by record types for inactive <br/># teams.</em><br/>knitr<strong class="lr jd">::</strong>kable(<br/>    table(inactiveTeams<strong class="lr jd">$</strong>gameType, <br/>          inactiveTeams<strong class="lr jd">$</strong>recordType),<br/>          caption<strong class="lr jd">=</strong>paste("Counts of Franchise Record Types by ", <br/>                        "Game Type for Inactive Teams"))</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/f903e815cd220561c4b1f60e47e419a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*nYkXFawxZXF_k68D1mtOjw.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">非活跃球队按游戏类型统计的特许经营记录类型(图片由作者提供)</p></figure><p id="cf95" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在，我将在数据集中保留非活动的和活动的团队。现在让我们根据游戏类型得到一个胜率的数字总结。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="809a" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Create a table of summary stats for win percentage by game type.</em><br/>winPercSumm <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong> <br/>  <em class="oa"># Select the gameType and winPercentage columns.</em><br/>  select(gameType, winPercentage) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Group by game type.</em><br/>  group_by(gameType) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Get summary statistics for winPercentage.</em><br/>  summarize("Min." <strong class="lr jd">=</strong> <strong class="lr jd">min</strong>(winPercentage),<br/>            "1st Quartile" <strong class="lr jd">=</strong> quantile(winPercentage, 0.25, <br/>                                      na.rm<strong class="lr jd">=TRUE</strong>),<br/>            "Median" <strong class="lr jd">=</strong> quantile(winPercentage, 0.5, na.rm<strong class="lr jd">=TRUE</strong>),<br/>            "Mean" <strong class="lr jd">=</strong> mean(winPercentage, na.rm<strong class="lr jd">=TRUE</strong>),<br/>            "3rd Quartile" <strong class="lr jd">=</strong> quantile(winPercentage, 0.75, <br/>                                      na.rm<strong class="lr jd">=TRUE</strong>),<br/>            "Max" <strong class="lr jd">=</strong> <strong class="lr jd">max</strong>(winPercentage),<br/>            "Std. Dev." <strong class="lr jd">=</strong> sd(winPercentage, na.rm<strong class="lr jd">=TRUE</strong>)<br/>            )</span><span id="f731" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Display a table of the summary stats.</em><br/>knitr<strong class="lr jd">::</strong>kable(winPercSumm, <br/>             caption<strong class="lr jd">=paste(</strong>"Summary Statistics for Win Percentage ", <br/>                           "by Game Type"),<br/>             digits<strong class="lr jd">=</strong>2)</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div role="button" tabindex="0" class="on oo di op bf oq"><div class="gh gi om"><img src="../Images/558520cb34b43b4bafba13d0787838d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mnLgzGbyisB2oDQzBcv6Dg.png"/></div></div><p class="og oh gj gh gi oi oj bd b be z dk translated">按游戏类型统计的获胜百分比摘要(按作者分类的图片)</p></figure><p id="2122" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">根据统计数据，分布看起来没有太大的不同，尽管季后赛的胜率可能会更加多变。至少有一支球队从未赢得过季后赛。让我们用箱线图来形象化这些分布。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="8447" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Make a box plot of franchise win percentage by game type.</em><br/>plot4 <strong class="lr jd">&lt;-</strong> ggplot(teamTotalStats, <br/>               aes(gameType,<br/>                   winPercentage,<br/>                   color<strong class="lr jd">=</strong>gameType)) <strong class="lr jd">+</strong><br/>  <em class="oa"># Add the box plot layer.</em><br/>  geom_boxplot() <strong class="lr jd">+</strong> <br/>  <em class="oa"># Jitter the points to add a little more info to the boxplot.</em><br/>  geom_jitter() <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add labels to the axes.</em><br/>  scale_x_discrete("Game Type") <strong class="lr jd">+</strong> <br/>  scale_y_continuous("Win Percentage") <strong class="lr jd">+</strong><br/>  <em class="oa"># Add a title.</em><br/>  ggtitle("Franchise Win Percentage by Game Type") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Remove the legend because it isn't needed.</em><br/>  theme(legend.position<strong class="lr jd">=</strong>"none")</span><span id="9871" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Display the plot.</em><br/>plot4</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/1b328c30999e19b1d0f29a0c76bb2b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*PrY4cAkipHKbMS7y.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">作者图片</p></figure><p id="0a98" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">季后赛和常规赛的胜率差距肯定是存在的。即使他们的趋势接近，常规赛的胜率分布也更加紧密。这可能是因为常规赛比季后赛多。</p><p id="de17" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">现在让我们来看一个按比赛类型划分的每场比赛罚分钟数的数字总结。季后赛似乎有更高的中心倾向，在每场比赛的罚球时间上更易变。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="ed2e" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Create a table of summary stats for penalty minutes per game by <br/># game type.</em><br/>penMinSumm <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong> <br/>  <em class="oa"># Select the gameType and penaltyMinutesPerGame columns.</em><br/>  select(gameType, penaltyMinutesPerGame) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Group by game type.</em><br/>  group_by(gameType) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Get summary statistics for penaltyMinutesPerGame.</em><br/>  summarize("Min." <strong class="lr jd">=</strong> <strong class="lr jd">min</strong>(penaltyMinutesPerGame),<br/>            "1st Quartile" <strong class="lr jd">=</strong> quantile(penaltyMinutesPerGame, 0.25),<br/>            "Median" <strong class="lr jd">=</strong> quantile(penaltyMinutesPerGame, 0.5),<br/>            "Mean" <strong class="lr jd">=</strong> mean(penaltyMinutesPerGame),<br/>            "3rd Quartile" <strong class="lr jd">=</strong> quantile(penaltyMinutesPerGame, 0.75),<br/>            "Max" <strong class="lr jd">=</strong> <strong class="lr jd">max</strong>(penaltyMinutesPerGame),<br/>            "Std. Dev." <strong class="lr jd">=</strong> sd(penaltyMinutesPerGame)<br/>            )</span><span id="83da" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Display a table of the summary stats.</em><br/>knitr<strong class="lr jd">::</strong>kable(penMinSumm, <br/>             caption<strong class="lr jd">=</strong>paste("Summary Statistics for Penalty ",   <br/>                           "Minutes per Game by Game Type"),<br/>             digits<strong class="lr jd">=</strong>2)</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div role="button" tabindex="0" class="on oo di op bf oq"><div class="gh gi or"><img src="../Images/90c3cb18600f09c0ecceb4515940785b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qkp58BgbI7JKgdOsMgdTyQ.png"/></div></div><p class="og oh gj gh gi oi oj bd b be z dk translated">按比赛类型统计每场比赛的罚分时间(图片由作者提供)</p></figure><p id="eef4" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">下面的柱状图提供了一种替代箱线图的方法，用于可视化每场比赛的罚分钟数分布。很明显，每场季后赛的罚分钟数远远超过了常规赛。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="0d63" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Make a histogram of penalty minutes per game by game type.</em><br/>plot5 <strong class="lr jd">&lt;-</strong> ggplot(teamTotalStats,aes(penaltyMinutesPerGame, <br/>                                   y<strong class="lr jd">=</strong>..density..,<br/>                                   fill<strong class="lr jd">=</strong>gameType)) <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a semi-transparent histogram with 10 bins for regular season <br/>  # games.</em><br/>  geom_histogram(data<strong class="lr jd">=</strong>subset(teamTotalStats,<br/>                             gameType <strong class="lr jd">==</strong> 'Regular Season'),<br/>                 bins<strong class="lr jd">=</strong>10, alpha <strong class="lr jd">=</strong> 0.5) <strong class="lr jd">+</strong><br/>  <em class="oa"># Add a semi-transparent histogram with 10 bins for playoff games.</em><br/>  geom_histogram(data<strong class="lr jd">=</strong>subset(teamTotalStats,gameType <strong class="lr jd">==</strong> 'Playoffs'),<br/>                 bins<strong class="lr jd">=</strong>10, alpha <strong class="lr jd">=</strong> 0.5) <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a better legend label.</em><br/>  guides(fill<strong class="lr jd">=</strong>guide_legend(title<strong class="lr jd">=</strong>"Game Type")) <strong class="lr jd">+</strong><br/>  <em class="oa"># Add labels to the axes.</em><br/>  scale_x_continuous("Penalty Minutes per Game") <strong class="lr jd">+</strong> <br/>  scale_y_continuous("Density") <strong class="lr jd">+</strong><br/>  <em class="oa"># Add a title.</em><br/>  ggtitle("Histogram of Penalty Minutes per Game by Game Type")</span><span id="35be" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Display the plot.</em><br/>plot5</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/5585a496b4c1262449f21e2ea995c8d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*9rWMLF5C3dRM7u_b.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">作者图片</p></figure><p id="4708" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我很好奇哪支球队每场比赛在禁区里呆的时间最长。我筛选了现役球队和常规赛比赛，并为每支球队和他们每场比赛的罚球时间制作了一个条形图。我将条形图中的条形从表现最差到表现最好进行了排序。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="7af7" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Create a column with the triCode for each team ordered by most <br/># penalty time per game to least.</em><br/>mostPenaltyMinsRegSeason <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Filter for active teams and regular season games.</em><br/>  filter(<strong class="lr jd">is.na</strong>(lastSeasonId) <strong class="lr jd">&amp;</strong> (gameTypeId <strong class="lr jd">==</strong> 2)) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Sort from most penalty minutes per game to the least.</em><br/>  arrange(desc(penaltyMinutesPerGame)) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># select the triCode column.</em><br/>  select(triCode)</span><span id="b1e9" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Create a bar chart for the penalty mins per regular season game by <br/># active teams.</em><br/>plot6 <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Filter for active teams and their regular season stats.</em><br/>  filter(<strong class="lr jd">is.na</strong>(lastSeasonId) <strong class="lr jd">&amp;</strong> (gameTypeId <strong class="lr jd">==</strong> 2)) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Create a column that is a sorted factor of triCode.</em><br/>  mutate(sortedTriCode <strong class="lr jd">=</strong> factor(<br/>      triCode, levels<strong class="lr jd">=</strong>mostPenaltyMinsRegSeason[["triCode"]],<br/>      ordered<strong class="lr jd">=TRUE</strong>))  <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Create a bar chart with a fill gradient for <br/>  # penaltyMinutesPerGame.</em><br/>  ggplot(aes(sortedTriCode, penaltyMinutesPerGame, <br/>             fill<strong class="lr jd">=</strong>penaltyMinutesPerGame)) <strong class="lr jd">+</strong><br/>  geom_col() <strong class="lr jd">+</strong> <br/>  <em class="oa"># Rotate the x-axis labls 90 degrees and remove the legend.</em><br/>  theme(axis.text.x<strong class="lr jd">=</strong>element_text(angle<strong class="lr jd">=</strong>90), legend.position<strong class="lr jd">=</strong>"none")<strong class="lr jd">+</strong><br/>  <em class="oa"># Change the fill gradient to go from blue to red.</em><br/>  scale_fill_gradient(low<strong class="lr jd">=</strong>"blue", high<strong class="lr jd">=</strong>"red") <strong class="lr jd">+</strong><br/>  <em class="oa"># Set the axes labels.</em><br/>  scale_x_discrete("Team") <strong class="lr jd">+</strong> <br/>  scale_y_continuous("Penalty Minutes per Game") <strong class="lr jd">+</strong><br/>  <em class="oa"># Add a title.</em><br/>  ggtitle("Penalty Minutes per Regular Season Game by Team")</span><span id="d50e" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Display the plot.</em><br/>plot6</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/40b9371a0e62b3807973696999c177e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*8H6c7Xr__PmzdG9i.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">作者图片</p></figure><p id="1872" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">看起来费城飞人队和费城体育迷一样吵闹。我又制作了同样的柱状图，但这次是为了季后赛。我保留了常规赛最粗暴的顺序。如果常规赛和季后赛的点球有相关性，我们预计顺序不会有太大变化。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="e0e9" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Create a bar chart for the penalty mins per playoff game by active </em><br/><em class="oa"># teams.</em><br/>plot7 <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Filter for active teams and their playoff stats.</em><br/>  filter(<strong class="lr jd">is.na</strong>(lastSeasonId) <strong class="lr jd">&amp;</strong> (gameTypeId <strong class="lr jd">==</strong> 3)) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Create a column that is a sorted factor of triCode.</em><br/>  mutate(sortedTriCode <strong class="lr jd">=</strong> factor(<br/>     triCode,<br/>     levels<strong class="lr jd">=</strong>mostPenaltyMinsRegSeason[["triCode"]], ordered<strong class="lr jd">=TRUE</strong>))<strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Create a bar chart with a fill gradient for <br/>  # penaltyMinutesPerGame.</em><br/>  ggplot(aes(sortedTriCode, penaltyMinutesPerGame, <br/>             fill<strong class="lr jd">=</strong>penaltyMinutesPerGame)) <strong class="lr jd">+</strong><br/>  geom_col() <strong class="lr jd">+</strong> <br/>  <em class="oa"># Rotate the x-axis labls 90 degrees and remove the legend.</em><br/>  theme(axis.text.x<strong class="lr jd">=</strong>element_text(angle<strong class="lr jd">=</strong>90), legend.position<strong class="lr jd">=</strong>"none")<strong class="lr jd">+</strong><br/>  <em class="oa"># Change the fill gradient to go from blue to red.</em><br/>  scale_fill_gradient(low<strong class="lr jd">=</strong>"blue", high<strong class="lr jd">=</strong>"red") <strong class="lr jd">+</strong><br/>  <em class="oa"># Set the axes labels.</em><br/>  scale_x_discrete("Team") <strong class="lr jd">+</strong> <br/>  scale_y_continuous("Penalty Minutes per Game") <strong class="lr jd">+</strong><br/>  <em class="oa"># Add a title.</em><br/>  ggtitle("Penalty Minutes per Playoff Game by Team")</span><span id="d692" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Display the plot.</em><br/>plot7</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/582dbda272afee8e566b1eb0a2be1a68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*WLkYY3osz8QLog-e.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">作者图片</p></figure><p id="e9aa" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">顺序变化不大，所以常规赛点球时间和季后赛点球时间是有关联的。让我们来看看季后赛和常规赛每场比赛的罚球时间的散点图。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="36fc" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Create a scatter plot of playoff penalty time per game vs. regular <br/># season.</em><br/>plot8 <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Filter for active teams.</em><br/>  filter(<strong class="lr jd">is.na</strong>(lastSeasonId)) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Select triCode, gameType, and penaltyMinutesPer Game.</em><br/>  select(triCode, gameType, penaltyMinutesPerGame) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Spread penaltyMinutesPerGame by gameType.</em><br/>  spread(gameType, penaltyMinutesPerGame) <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Create a scatter plot with a regression line.</em><br/>  ggplot(aes(`Regular Season`, Playoffs)) <strong class="lr jd">+</strong><br/>  <em class="oa"># Add a scatter plot layer and adjust the size and opaqueness of <br/>  # points.</em><br/>  geom_point(alpha<strong class="lr jd">=</strong>0.75,  color<strong class="lr jd">=</strong>"blue") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a red regression line.</em><br/>  geom_smooth(method<strong class="lr jd">=</strong>lm, formula<strong class="lr jd">=</strong>y<strong class="lr jd">~</strong>x, color<strong class="lr jd">=</strong>"red") <strong class="lr jd">+</strong><br/>  <em class="oa"># Set the axes labels.</em><br/>  scale_x_continuous("Regular Season Penalty Min. per Game") <strong class="lr jd">+</strong><br/>  scale_y_continuous("Playoffs Penalty Min. per Game") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a title.</em><br/>  ggtitle(paste("Playoff vs. Regular Season Penalty Min. Per ",<br/>                "Game (Active Teams)"))</span><span id="8bc7" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Display the plot.</em><br/>plot8</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/7c456bf92a04e992bdda1328a7d1540c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*KYcyNF-d_FR7wOW2.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">作者图片</p></figure><p id="bb66" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">虽然正相关并不十分令人惊讶，但我没想到相关性会如此紧密。</p><p id="17c4" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我想知道每场比赛的罚分时间和胜率有什么关系。让我们来了解一下！</p><p id="3b8b" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">我创建了一个散点图，根据游戏类型来显示每场比赛的胜率和罚分。我尝试了一下回归线。我首先从一条<a class="ae ln" href="https://en.wikipedia.org/wiki/Local_regression" rel="noopener ugc nofollow" target="_blank">黄土</a>回归线开始，看到了一个倒置的U型线。我决定用一条二次回归线来绘制它们，以使事情更顺利。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="a97b" class="nd lt it lr b gy nw nx l ny nz">plot9 <strong class="lr jd">&lt;-</strong> teamTotalStats <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Select the triCode, gameType, penaltyMinutesPerGame, and <br/>  # winPercentage columns.</em><br/>  select(triCode, gameType, penaltyMinutesPerGame, winPercentage)<strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Create a scatter plot of winPercentage vs. <br/>  # penaltyMinutesPerGame, coloring by game type.</em><br/>  ggplot(aes(penaltyMinutesPerGame, winPercentage, color<strong class="lr jd">=</strong>gameType))<strong class="lr jd">+</strong><br/>  <em class="oa"># Add a scatter plot layer and adjust the size.</em><br/>  geom_point(size<strong class="lr jd">=</strong>2) <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a quadratic regression line.</em><br/>  geom_smooth(method<strong class="lr jd">=</strong>"lm", formula<strong class="lr jd">=</strong>"y~poly(x, 2)") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Set the axes labels.</em><br/>  scale_x_continuous("Penalty Minutes per Game") <strong class="lr jd">+</strong> <br/>  scale_y_continuous("Win Percentage") <strong class="lr jd">+</strong> <br/>  <em class="oa"># The legend isn't needed, so remove it.</em><br/>  theme(legend.position<strong class="lr jd">=</strong>"none") <strong class="lr jd">+</strong> <br/>  <em class="oa"># Add a title</em><br/>  ggtitle(paste("Win Percentage vs. Penalty Minutes per Game by ",   <br/>                "Game Type")) <strong class="lr jd">+</strong> <br/>  <em class="oa"># Break out the plots by game type.</em><br/>  facet_wrap(<strong class="lr jd">~</strong>gameType)</span><span id="5bdd" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Display the plot.</em><br/>plot9</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/fafa20514b6f9058572de83dd79981af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/0*p_vUqhO7kXNi_dl7.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">作者图片</p></figure><p id="bb40" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">正如你所看到的，每场比赛的胜率和罚分钟数之间的关系并不完全清晰，但似乎确实存在二次关系。在常规赛中，就胜率而言，15分钟似乎是最佳的罚球时间。对于季后赛，它似乎在17分钟左右。</p><p id="ab67" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">在这一点上，相关性并不意味着因果关系是不言而喻的。有可能存在一种罚点球的策略，即使这给了对方一个强力进攻的机会，就像篮球一样。或者它可能只是一个最佳侵略性游戏风格的副产品。不管怎样，我想测试这种关系是否有统计学意义。让我们用回归更正式地测试一下二次关系。</p><pre class="no np nq nr gt ns lr nt nu aw nv bi"><span id="5f47" class="nd lt it lr b gy nw nx l ny nz"><em class="oa"># Create a model regressing win percentage on penalty minutes per <br/># game.</em><br/>winPercMod <strong class="lr jd">&lt;-</strong> lm(winPercentage <strong class="lr jd">~</strong> poly(penaltyMinutesPerGame, 2),<br/>                 data<strong class="lr jd">=</strong>teamTotalStats)</span><span id="14f8" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Get the percentage of variance explained.</em><br/>winVarExplainedPerc <strong class="lr jd">&lt;-</strong> <strong class="lr jd">round</strong>(100<strong class="lr jd">*</strong>summary(winPercMod)[[8]],1)</span><span id="dc49" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Create a table of the regression coefficients.</em><br/>tidywinPercModSumm <strong class="lr jd">&lt;-</strong> winPercMod <strong class="lr jd">%&gt;%</strong><br/>  <em class="oa"># Pass the model through the tidy() function.</em><br/>  tidy()</span><span id="36a3" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Rename the variables for improved printing.</em><br/>tidywinPercModSumm[1, "term"] <strong class="lr jd">=</strong> "Intercept"<br/>tidywinPercModSumm[2, "term"] <strong class="lr jd">=</strong> "Penalty Min. per Game"<br/>tidywinPercModSumm[3, "term"] <strong class="lr jd">=</strong> "(Penalty Min. per Game)^2"</span><span id="bcf3" class="nd lt it lr b gy ob nx l ny nz"><em class="oa"># Pass the tidied model output to a table and format it.</em><br/>knitr<strong class="lr jd">::</strong>kable(<br/>  tidywinPercModSumm,<br/>  caption<strong class="lr jd">=</strong>paste("Coefficient summary of Win Perc. Regressed on",<br/>                "Penalty Min. per Game with Quadratic Term"),<br/>  col.names <strong class="lr jd">=</strong> <strong class="lr jd">c</strong>("Variable", "Est. Coef.", "SE", "t", "P(|t| &gt; 0)"),<br/>  digits<strong class="lr jd">=c</strong>(0, 2, 3, 2, 3)<br/>)</span></pre><figure class="no np nq nr gt od gh gi paragraph-image"><div class="gh gi os"><img src="../Images/54cf81d942b734904c110d0048281cbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*uy2uH87xcYCrMHctc_u9Wg.png"/></div><p class="og oh gj gh gi oi oj bd b be z dk translated">Win Perc系数汇总。在罚分上倒退。每场比赛有二次项(图片由作者提供)</p></figure><p id="05cf" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">给定回归中二次项的t统计量，二次关系似乎是合理的。该模型解释了成功百分比中23.8%的差异，因此在预测模型中仍有相当数量的差异需要考虑。尽管如此，这仍然是一个有趣的发现！</p><h1 id="6168" class="ls lt it bd lu lv lw lx ly lz ma mb mc ki md kj me kl mf km mg ko mh kp mi mj bi translated">总结</h1><p id="5fc6" class="pw-post-body-paragraph kr ks it kt b ku mk kd kw kx ml kg kz la mm lc ld le mn lg lh li mo lk ll lm im bi translated">为了总结我在这篇短文中所做的一切，我构建了与NHL API的一些端点进行交互的函数，检索了一些数据，并使用表格、数字摘要和数据可视化对其进行了研究。我发现了一些不足为奇的事情，比如场均投篮次数和投篮命中率与胜率相关。我还发现了一些令人惊讶的事情，即每场比赛的罚球时间与胜率成二次关系。</p><p id="82fc" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">最重要的是，我希望我的代码有助于您与API进行交互！</p><p id="f354" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><a class="ae ln" href="https://jkclem.github.io/nhl-api-vignette/" rel="noopener ugc nofollow" target="_blank"><strong class="kt jd">NHL-API-vignette</strong></a><strong class="kt jd">由</strong><a class="ae ln" href="https://github.com/jkclem" rel="noopener ugc nofollow" target="_blank"><strong class="kt jd">JK clem</strong></a><strong class="kt jd">维护。</strong></p></div></div>    
</body>
</html>