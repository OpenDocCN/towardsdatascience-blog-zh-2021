<html>
<head>
<title>Displaying a gridded dataset on a web-based map</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在基于web的地图上显示网格化数据集</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/displaying-a-gridded-dataset-on-a-web-based-map-ad6bbe90247f?source=collection_archive---------10-----------------------#2021-04-17">https://towardsdatascience.com/displaying-a-gridded-dataset-on-a-web-based-map-ad6bbe90247f?source=collection_archive---------10-----------------------#2021-04-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="de76" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/making-sense-of-big-data" rel="noopener" target="_blank">理解大数据</a></h2><div class=""/><div class=""><h2 id="39d6" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">使用全息视图、散景和数据阴影显示大型地理差异的分步指南</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/7b25d2d57d4fc4937e1b16dcacc6af87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z3odNPOIDgZabYhivnysbQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated"><em class="le">(图片由作者提供，使用</em><a class="ae lf" href="https://www.openstreetmap.org/" rel="noopener ugc nofollow" target="_blank"><em class="le"/></a><em class="le"/><a class="ae lf" href="https://holoviews.org" rel="noopener ugc nofollow" target="_blank"><em class="le">holo views</em></a><em class="le"/><a class="ae lf" href="https://developers.google.com/earth-engine/datasets/catalog/CGIAR_SRTM90_V4" rel="noopener ugc nofollow" target="_blank"><em class="le">SRTM高程数据</em> </a> <em class="le"> ) </em></p></figure><h1 id="3d82" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">问题是</h1><p id="578d" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">你的老板/客户刚刚给你安排了一项新任务。他们在GeoTIFF文件中有一些地理信息，你必须<em class="mu">“把它放在像谷歌地图这样的地图上，你知道，有街道，缩放和滚动”</em>然后在网上提供。可视化应该使数据第一眼看上去是一幅真实的彩色图像。此外，在鼠标悬停时，用户还应该看到该位置的实际数据值和精确坐标。此外，GeoTIFF文件相当大(高达几百或几千兆字节)，因此将其全部加载到浏览器中并不是一个好选择。</p><p id="ae4c" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">你并不担心，尽管你从未尝试过这样的事情。这听起来像是一种很常见的情况，所以网络上应该充满了开箱即用的解决方案和工作示例。但事实并非如此。据我所知，没有一个例子或教程展示过类似的东西。现有的方法有很多种，我们将在本文的最后讨论它们。但是与上述规格相比，它们都有所不足。</p><h1 id="2495" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">解决方案</h1><p id="4ed5" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">我将向您展示如何使用Rioxarray读取数据文件，然后使用Holoviews + Bokeh将结果显示在覆盖在地图上的图像层上，并使用Datashader处理一些自动调整大小的魔术。本文的目标读者是除了Python的一些基本经验之外，不需要任何先验知识就可以从事这项工作的任何人。你们中的一些人可能有广泛的GIS、web开发和数据可视化背景，而其他人没有。如果您只想查找代码，请向下滚动到<strong class="ma ja">“加载和理解数据”</strong>部分。</p><h1 id="8fea" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">基础知识</h1><p id="cfbf" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">任务是将GeoTIFF文件中的数据以某种方式放到基于图块的地图上。首先，我们来看看我们对这些东西本身了解多少。</p><h2 id="9b9e" class="na lh iq bd li nb nc dn lm nd ne dp lq mh nf ng ls ml nh ni lu mp nj nk lw iw bi translated">1.什么是GeoTIFF文件？</h2><p id="429e" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">GeoTIFF文件(如果非常简化的话)就像一个excel表，其中每个单元格(像素)包含一个数字，而行和列的名称是坐标。这些值可以是任何值:慕尼黑的人口密度地图、马来西亚的卫星夜灯地图、德克萨斯州的温度记录，或者出于本文的目的，肯尼亚的高程地图。</p><p id="81ba" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">知道坐标意味着我们可以精确地知道这个数据网格在地图上的位置:不仅仅是角落，还包括其中的每个像素。需要注意的是，该文件仅包含原始数据；它没有任何颜色信息。因此，传统的图像文件(如bmp、jpeg或png)将包含左上角像素的信息，即它是“红色的”，而GeoTIFF文件将包含一个数值(如它具有以米为单位的“123”高程)。由我们来告诉我们的可视化系统每个值对应什么颜色。</p><p id="5166" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">大多数图像查看器应用程序可以使用默认的色阶打开和显示TIFF文件，通常假设最低值应该是黑色，最高值应该是白色，以及介于各种灰色阴影之间的所有内容。但是，重要的是要记住TIFFs本身并不是彩色的，它们只包含数据，我们需要通过使用色彩映射表来给它们着色。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nl"><img src="../Images/28fde8ac2ddcf74cd4b3837215ec563d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zrvOc21PlRxYWh93Bd9sXQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated"><em class="le">一个图像浏览器应用程序如何使用默认灰度色图显示TIFF文件的例子。(图片由作者提供)</em></p></figure><p id="0bf2" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">另一个需要考虑的重要因素是文件的分辨率，也就是一个像素覆盖的区域大小。可以有两个类似的GeoTIFF文件，两者覆盖相同的总面积，一个具有50x50米像素，另一个具有5000x5000米像素。很容易理解，第一个需要比第二个多100 * 100 = 10000倍的像素才能覆盖同样的面积。因此，这将是更大的文件大小，但会给我们更多的细节。第二个文件要小得多，但是每25平方公里只有一个数据点。在本练习中，我们将使用这两种分辨率。我们从一个低分辨率的原型开始，一旦我们学会如何在不冻结一切的情况下使用它，我们就切换到高分辨率的数据集。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/1ee994c70f3e9a0135a5298b9432a858.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1llDoyTUXe6imrFneootoA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated"><em class="le">低分辨率和高分辨率数据的区别。(图片由作者使用</em><a class="ae lf" href="https://www.openstreetmap.org/" rel="noopener ugc nofollow" target="_blank"><em class="le"/></a><em class="le"/><a class="ae lf" href="https://holoviews.org/" rel="noopener ugc nofollow" target="_blank"><em class="le">holo views</em></a><em class="le"/><a class="ae lf" href="https://developers.google.com/earth-engine/datasets/catalog/CGIAR_SRTM90_V4" rel="noopener ugc nofollow" target="_blank"><em class="le">SRTM高程数据</em> </a> <em class="le"> ) </em></p></figure><p id="c85f" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">事实上，在地理标志中会发生更多的奇迹。为了简单起见，我们假设我们的GeoTIFF包含一个“区带”(就像包含一个工作表的excel文件)。此外，我们并不关心它的云优化图像金字塔的内部细节或精确的坐标参考系统。然而，我强烈推荐阅读这些只是为了好玩。</p><h2 id="7a55" class="na lh iq bd li nb nc dn lm nd ne dp lq mh nf ng ls ml nh ni lu mp nj nk lw iw bi translated">2.什么是tilemap？</h2><p id="dc99" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">基于磁贴的地图是我们都熟悉的谷歌地图。用户有一个交互式视口，他们可以四处拖动、放大和缩小，地图提供商服务器向他们发送适当大小的地图切片，以查看该缩放级别的合理详细信息。虽然将谷歌地图集成到您的应用程序中需要开发者密钥和付费订阅，但我们可以使用许多免费的地图提供商。幸运的是，大多数图表库使它们易于导入。</p><p id="8ef6" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">这里重要的是不要将tilemaps与“绘制的地图”(根据上下文和格式，也称为geo maps、geojsons、vector maps、shapefiles)混淆。后者主要是国家或其他地区的静态轮廓，没有这里提到的任何功能。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nm"><img src="../Images/b925b400aa966243751abe5c0d8c788f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NQIA9KtoMwGyqs-Qhkarrw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">显示在平铺地图和矢量地图上的肯尼亚地区。(图片由作者使用<a class="ae lf" href="https://openstreetmap.org/" rel="noopener ugc nofollow" target="_blank"><em class="le"/></a><em class="le">)</em></p></figure><h2 id="4b80" class="na lh iq bd li nb nc dn lm nd ne dp lq mh nf ng ls ml nh ni lu mp nj nk lw iw bi translated">3.使用的工具</h2><p id="9f61" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated"><a class="ae lf" href="https://github.com/corteva/rioxarray" rel="noopener ugc nofollow" target="_blank"> <strong class="ma ja"> Rioxarray </strong> </a>(及其依赖项<a class="ae lf" href="http://xarray.pydata.org/en/stable/" rel="noopener ugc nofollow" target="_blank"> xarray </a>和<a class="ae lf" href="https://rasterio.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> rasterio </a>)是一个相当强大的模块，可以像GeoTIFF一样处理网格地理数据集，因此我们将使用它来打开和转换我们的数据，但没有必要了解太多。</p><p id="30c8" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">然而，Holoviz生态系统(包含Holoviews、Bokeh、Datashader等等)是一个更加令人兴奋的实体。这是一套开源工具，由Nvidia和Anaconda等公司出资。</p><p id="398b" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated"><a class="ae lf" href="https://bokeh.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ma ja"> Bokeh </strong> </a> <strong class="ma ja"> </strong>是一个制图工具:它让你用Python创建交互式web图表，并通过JavaScript中的BokehJS库自动在浏览器中显示它们。如果你熟悉的话，这有点类似于Plotly。一个主要的区别是，Bokeh本身有一个内置的web服务器，所以它可以创建深度交互的图表，其中浏览器中的用户交互(如拖动滑块)被发送到服务器，Bokeh在服务器上修改数据并无缝地发回结果。(Plotly用破折号也是为了同样的效果。)这也是将要在这个笔记本中发生的事情:每次我们创建一个交互式可视化，一个散景网络服务器将在后台旋转并为我们服务，而我们不必担心它。</p><p id="6e1b" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated"><a class="ae lf" href="http://holoviews.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ma ja"> Holoviews </strong> </a>在层级中的位置更高一些。在Bokeh中，你必须手动创建所有的图表(即使有许多合理的默认值和帮助函数)，而Holoviews希望给你一个工具，用你想要的可视化来描述你的数据，然后让绘图模块(如Bokeh)做琐碎的工作。区别有点像烹饪，你必须处理过程中的每个细节，而去餐馆只是描述你想要的食物，让员工制作而不必处理细节。虽然有了Holoviews，如果你想按照你需要的方式做一些步骤，你也可以进入厨房(绘图模块)。</p><p id="895c" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">Holoviews还允许您使用各种绘图库。我们将让它在这里使用散景，因为我们将需要一些特定的功能。在许多其他情况下，只需将一个关键字转换为“plotly”或“matplotlib ”,就可以得到在这些系统中创建的完全相同的图表。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nn"><img src="../Images/551fb8f503568e22cbf64bc20f8ecec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gXThWHy5sMaf5HSN7veTaQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated"><em class="le">相同的代码以默认设置显示在Matplotlib、Bokeh和Plotly中。(图片由作者提供。)</em></p></figure><p id="4685" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">正如我们将要看到的，Holoviews擅长用几行代码创建真正的高级功能。</p><p id="a7b9" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated"><a class="ae lf" href="https://datashader.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ma ja">另一方面，Datashader </strong> </a>只做很少的事情，但是实现得很好。也就是说，它可以根据数据以任何方式创建图像。通常基于大量的数据。比如数十亿个独特的点或数十亿字节的网格数据，否则这些数据是不可能显示的。</p><p id="37e0" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">我与Holoviz生态系统没有任何关系，但我觉得它是一组被严重低估的工具，应该在数据科学社区中获得更大的关注。它没有得到它的一个可能的原因是，对于某些功能，文档落后于它的实际能力，特别是当一个人必须在没有先验知识的情况下理解正在发生的事情时。这就是为什么本教程会遍历可能的陷阱，并试图让一切工作方式变得透明，希望让这些工具更容易被更广泛的受众使用。</p><h1 id="b13f" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">数据源</h1><ul class=""><li id="723e" class="no np iq ma b mb mc me mf mh nq ml nr mp ns mt nt nu nv nw bi translated"><a class="ae lf" href="https://developers.google.com/earth-engine/datasets/catalog/CGIAR_SRTM90_V4" rel="noopener ugc nofollow" target="_blank">NASA/CGIAR地球引擎的SRTM数字高程数据第4版</a></li><li id="efa0" class="no np iq ma b mb nx me ny mh nz ml oa mp ob mt nt nu nv nw bi translated">肯尼亚国家边界从<a class="ae lf" href="http://openstreetmap.org/" rel="noopener ugc nofollow" target="_blank">到</a>OSM边界的公开街道地图</li><li id="73b6" class="no np iq ma b mb nx me ny mh nz ml oa mp ob mt nt nu nv nw bi translated">由作者在<a class="ae lf" href="https://earthengine.google.com/" rel="noopener ugc nofollow" target="_blank">地球引擎</a>中截取到OSM国家边界并导出的数据。</li></ul><h1 id="a066" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">设置</h1><p id="1eed" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">我们将使用Google Colabs，这是一个免费的Jupyter笔记本环境，可以很容易地进行实验和分享结果。<a class="ae lf" href="https://colab.research.google.com/drive/15aG8Abyv6mWRkvk7IsR3J5WLGYOI2tj0?usp=sharing" rel="noopener ugc nofollow" target="_blank">你可以通过Colab笔记本</a>跟随整篇文章，也可以在你看完这个之后用它来做实验。</p><p id="462a" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">它已经预装了许多模块，但我们还需要更多，而且我们想知道我们是否有我们需要的完全相同的版本。</p><p id="1b3c" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">我们可以通过在命令行前添加<code class="fe oc od oe of b">!</code>来运行命令行命令，因此我们将使用它来运行pip并在2021-04-16为这些模块安装最新版本。我们可能会遇到一些底层依赖的不兼容错误，但是它们不会给这个练习带来任何问题。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="28b5" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">接下来，我们用他们的短手导入所有必要的模块。我们会经常用到这些快捷键，所以如果您不确定我们使用的一些函数来自哪里，请随时回来。我们还展示了一些模块的版本，以确保一切正常。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><pre class="kp kq kr ks gt oi of oj ok aw ol bi"><span id="8614" class="na lh iq of b gy om on l oo op">Versions:  {'holoviews': '1.14.3', 'bokeh': '2.3.1', 'rioxarray': '0.3.1'}</span></pre><p id="20e3" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">我们还需要数据本身。我已经将肯尼亚的海拔地图作为云优化的GeoTIFF文件从Earth Engine导出到我的Google Drive。(如果你对如何使用<a class="ae lf" href="https://developers.google.com/earth-engine/datasets/" rel="noopener ugc nofollow" target="_blank">各种可用数据集</a>完成这项工作的教程感兴趣，请在评论中告诉我。)</p><p id="c30c" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">通过预装的<code class="fe oc od oe of b">gdown</code>工具，谷歌可以将公开共享的文件从Drive下载到Colab。</p><blockquote class="oq or os"><p id="19af" class="ly lz mu ma b mb mv ka md me mw kd mg ot mx mj mk ou my mn mo ov mz mr ms mt ij bi translated"><em class="iq">如果你想将自己的数据集导入Google Colab，只需将你的Google Drive文件分享给“任何有链接的人”。你会得到这样一个链接:</em></p><p id="b49c" class="ly lz mu ma b mb mv ka md me mw kd mg ot mx mj mk ou my mn mo ov mz mr ms mt ij bi translated"><a class="ae lf" href="https://drive.google.com/file/d/16dkulaX8RkkuODqualrarIWtG_iBDMSZ/view?usp=sharing" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://drive.google.com/file/d/</em><strong class="ma ja"><em class="iq">16 dkulax 8 rkkuodqualrariwtg _ IBD msz</em></strong><em class="iq">/查看？usp =共享</em> </a></p><p id="a157" class="ly lz mu ma b mb mv ka md me mw kd mg ot mx mj mk ou my mn mo ov mz mr ms mt ij bi translated"><em class="iq">这不是直接下载链接。它会在Google Drive预览窗口中打开文件。要获得一个可以用来下载文件的链接，你需要复制你的原始链接的ID部分(在上面的例子中用粗体标出)并放入这个链接:<br/></em><a class="ae lf" href="https://drive.google.com/u/0/uc?id=IDCOMESHERE&amp;export=download" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://drive.google.com/u/0/uc?id=</em><strong class="ma ja"><em class="iq">idcomesere</em></strong><em class="iq">&amp;export = download</em></a></p><p id="cd31" class="ly lz mu ma b mb mv ka md me mw kd mg ot mx mj mk ou my mn mo ov mz mr ms mt ij bi translated"><em class="iq">你最终的结果会是这样:<br/></em><a class="ae lf" href="https://drive.google.com/u/0/uc?id=16dkulaX8RkkuODqualrarIWtG_iBDMSZ&amp;export=download" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://drive.google.com/u/0/uc?id=</em><strong class="ma ja"><em class="iq">16 dkulax 8 rkkuodqualrariwtg _ IBD msz</em><em class="iq">&amp;export = download</em></strong></a></p><p id="a679" class="ly lz mu ma b mb mv ka md me mw kd mg ot mx mj mk ou my mn mo ov mz mr ms mt ij bi translated"><em class="iq">这是一个你的文件的直接下载链接，所以我们可以用下面的方式把这个作为</em> <code class="fe oc od oe of b"><em class="iq">source_location</em></code> <em class="iq">与</em><code class="fe oc od oe of b"><em class="iq">gdown</em></code><em class="iq">:</em></p><p id="d870" class="ly lz mu ma b mb mv ka md me mw kd mg ot mx mj mk ou my mn mo ov mz mr ms mt ij bi translated"><code class="fe oc od oe of b"><em class="iq">gdown -O local_destination source_location</em></code></p></blockquote><p id="1fb3" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">由于Google Colab的默认工作目录是<code class="fe oc od oe of b">/content</code>，我们首先创建一个名为<code class="fe oc od oe of b">kenya</code>的目录，然后将我共享的两个示例文件下载到该目录中。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/213f2520ebe0a46853c7e6b17929ddf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*z5k-ueGj4Ct3K8XCJsmanA.png"/></div></figure><p id="e491" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">在下载日志中，你可以看到较小的文件是60.3KB，较大的329MB。这是一个巨大的差异，所以首先，我们从较小的一个开始。</p><h1 id="1971" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">加载和理解数据</h1><p id="4186" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">我们将使用rioxarray模块将文件中的数据加载到一个xarray数据结构中。</p><p id="da91" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated"><em class="mu">旁注:如果Google Colab单元格包含的最后一行只有一个变量，它将以一种有意义的方式显示它。从现在开始，我们将使用它来查看每一步的结果。</em></p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ox"><img src="../Images/af786130f054b4a98a56c18deb8276e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8B40Y4JddA7fgfAeoqefeQ.png"/></div></div></figure><p id="7f6d" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">不用深入研究这种数据格式的细节，我们可以看到我们的数据有一个218乘179的维度，只有一个波段:高程数据本身。我们还可以看到，x值大约在30到42之间，而y值大约在-5到5之间，因此它们看起来像是合理的坐标值。</p><p id="edb6" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">为了更熟悉我们的数据，我们可以很容易地将其转换成熊猫数据集并显示出来。我们可以看到它确实是一个网格数据集，坐标是行和列标题，以米为单位的高程数据是值。(当我将数据裁剪成肯尼亚的边界形状时，一个数字值显示缺少的值。)</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oy"><img src="../Images/675f6cf721f73a99503948f537b6290d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MRv_JvQULGA2fynZYvNEOg.png"/></div></div></figure><p id="f016" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">这完全没有必要，甚至毫无意义，但为了强调<em class="mu">“我们正在处理无色的网格数据，而不是实际的图像”</em>这一点，我们甚至可以将数据导出并下载为CSV文件，如果我们愿意，可以在Excel中打开它。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oz"><img src="../Images/0d5b2c069546f11bcc2824b1e33d6a59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EX07G2mW82rqhbfZLanj1g.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated"><em class="le">Excel中显示的同一个数据集。(图片由作者提供。)</em></p></figure><h1 id="638b" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">配置</h1><p id="5a8e" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">在继续之前，我们将设置一些配置值，从我们的色彩映射表开始。通常，我们可以给Holoviews一个颜色列表或一个现有颜色图的名称，但我喜欢为当前数据集使用颜色图的特定子集。我不打算在这里解释细节，因为您自己的数据不需要这个。只要知道我们取了<code class="fe oc od oe of b">terrain</code>色图的25%-100%部分，并得到了一个在该范围内分布有192种颜色的列表就足够了。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pa"><img src="../Images/a5f3d7422d1ecaef8e620b039235c587.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mGV-hs6eLcD46iSOAJ2khw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">产生的颜色列表</p></figure><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="6eb4" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">下一步，我们设置所有Holoviews元素从现在开始将使用的默认选项。在这里和这里<a class="ae lf" href="http://holoviews.org/user_guide/Customizing_Plots.html" rel="noopener ugc nofollow" target="_blank">见它们的文档</a>。我们确保使用我们的颜色图和宽度/高度设置，显示颜色条。我们还打开了悬停工具提示，以及通过鼠标滚轮或触摸板滚动来放大和缩小的功能。</p><p id="212f" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">只有两件事需要多解释一下。</p><ol class=""><li id="6b79" class="no np iq ma b mb mv me mw mh pb ml pc mp pd mt pe nu nv nw bi translated">我将在每个单元格的开头包含<code class="fe oc od oe of b">hv.extension('bokeh', logo=False)</code>行。这让Holoviews知道我希望它显示带有散景的元素(但不是每次在输出中都显示散景标志)。如果你在本地运行你的脚本(不是在Google Colab上)，你只需要这样做一次。据说也有可能让Colab笔记本记住它而不重复，但事实证明这对我来说有点不可靠，所以我更喜欢这样使用它。</li><li id="b81c" class="no np iq ma b mb nx me ny mh nz ml oa mp ob mt pe nu nv nw bi translated">该数据不包含肯尼亚边界以外的数值。默认情况下，它会显示为灰色区域，但我们不希望这样，所以用<code class="fe oc od oe of b">clipping_colors</code>参数，我强制它不可见(<code class="fe oc od oe of b">#00000000</code> RGBA代码的最后两位数字表示0不透明度)。</li></ol><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><h1 id="96ef" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">将数据显示为图像</h1><p id="2cb1" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">现在我们已经做好了一切准备，让我们将数据加载到一个数据集中。变化不大，但Holoviews稍后将需要这种格式的数据。<code class="fe oc od oe of b">dataarray[0]</code>指我们<code class="fe oc od oe of b">dataarray</code>中的第一个波段。我们还让它知道要使用的值(<code class="fe oc od oe of b">'elevation'</code>)和坐标(<code class="fe oc od oe of b">['x', 'y']</code>)，就像我们在上面定义它们一样。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="01d0" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">我们将立即看到为什么这是方便的，因为现在使用我们的默认配置，将这个数据集输入到Holoviews图像并让Holoviews自动显示它是非常容易的:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/1a6f9cf505b5a259853cbec1178a9aa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/1*kIk4mTJOJSljMeSOzxo9dg.gif"/></div></figure><p id="d6dc" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">正如你所看到的，我们有一个很好的显示，有交互图标、缩放、颜色条等。我们可以在坐标轴上看到图像的坐标，y轴以0为中心，肯尼亚在赤道上。我们甚至有一个自动悬停工具提示(上面用<code class="fe oc od oe of b">tools=['hover']</code>配置创建的)，如果鼠标在图像上，它会显示精确的坐标和高度值。</p><p id="c573" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">现在，让我演示一下TIFF只包含原始数据而没有任何颜色信息的好处。</p><p id="ce9c" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">下面你可以看到我们用和上面完全相同的数据创建的完全相同的Holoviews图像。我刚刚给了他们另外两张彩色地图。第一种使用<code class="fe oc od oe of b">inferno</code>连续色彩映射表，将较低值涂成黑色，较高值涂成紫色、橙色和黄色。第二个使用了用于分类可视化的<code class="fe oc od oe of b">Dark2</code>颜色图:仅仅通过使用这个颜色方案，我们立即将我们的数据分类到8个不同的海拔高度，而不改变数据本身。</p><p id="8ab0" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated"><a class="ae lf" href="http://holoviews.org/user_guide/Colormaps.html" rel="noopener ugc nofollow" target="_blank">你可以在这里阅读更多可用的色彩映射表。</a></p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pg"><img src="../Images/dd2eb27f28070a5e37d2147f67c15965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*bpGE5B_AlKB1MKxLMNj-PQ.gif"/></div></div></figure><p id="02c0" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">但是让我们回到手头的任务。这是一件好事，我们有我们的形象，但我们也需要一个tilemap。幸运的是，很容易得到一个。你可以在Holoviews网站上看到所有不同的选项(黑暗、光线和地形)。</p><p id="305c" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">我们现在要选择开放的街道地图。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ph"><img src="../Images/b1902094be4cdf05b603f76517a9ca62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*QhIpfFO0Dz1yyuRQZRvLVA.gif"/></div></div></figure><h1 id="c410" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">将图像放到地图上</h1><p id="3a94" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">好的，那是一张地图，可以缩放，什么都有，但是它是空的。这就是Holoviews的“它只是工作”魔力发挥作用的地方:使用<code class="fe oc od oe of b">*</code>操作符，我们只是将图像放在我们的地图上，并期待最好的结果:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pi"><img src="../Images/17ed5c2ad038263228416ccae5a5196c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mZfp-S20oQPS5fLjoevr6A.png"/></div></div></figure><p id="01d3" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">嗯，这是尴尬的…图像是可见的，但不是在地图上，而是在白色背景上，轴也显示一些奇怪的坐标…</p><p id="902a" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">为了理解这种现象(这导致了StackOverflow上绝大多数<em class="mu">“地图上的图像很奇怪”</em>的问题，不管使用什么工具)，我们需要了解一点关于坐标系的知识，这通常过于简单。</p><p id="75a9" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">我们的图像使用一个平面坐标系，其中的值通常在-180到180度之间。它很棒，因为它让我们可以使用像地球这样的球形物体上的位置。另一方面，每个可用的tilemap引擎都使用Web墨卡托坐标系，该坐标系以米为单位测量所有事物。墨卡托经过优化，可以在平面上显示地图，也就是我们的屏幕。这可能非常令人困惑，因为这些墨卡托地图确实向我们显示了轴上的平面坐标(因为这些数字是每个人都熟悉的)。但那只是一个显示功能；内部都是用米。因此，当你给他们一个平面坐标约为-4.2151或32.14的数据集时，这些值应该被理解为-4.2151度和32.14度。同时，tilemap会将它们解释为距离原点-4.2151米和32.14米。虽然360度足够绕地球一周，但360米是一个非常非常小的距离。</p><p id="d88f" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">结果是，我们的图像确实显示在地图上，就在0，0点周围，向每个方向延伸几米。因为Holoviews元素自动放大地图以显示完整的数百米图像，所以地图被放大到甚至不能显示海洋中部的任何分辨率的地图切片。如果你开始缩小，你就能看到这种情况发生，就像这张g if上看到的那样:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pj"><img src="../Images/73cc0ef5f9a93fa1954886012c04ce68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*6kx3ugfFTe2pyXR3eLcRug.gif"/></div></div></figure><h1 id="ec1e" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">重新投影数据</h1><p id="7a8c" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">现在我们明白了为什么会发生这种情况，让我们做点什么吧。我们需要将数据转换到适当的坐标系。平面坐标和墨卡托坐标之间的转换不是我们应该手动完成的。不仅仅是因为试图找出如何将一个或多或少呈球形的对象转换为2D是一件非常痛苦的事情，而且在现实中，数据集可能会使用许多略有不同的平面坐标系，我们绝对不想处理这些坐标系。<em class="mu">(编程101:永远不要试图重新实现处理日期、时区、翻译或坐标系统细节的功能。)</em></p><p id="7337" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">我们只是碰巧运气好，因为我们用来读取GeoTIFF的<code class="fe oc od oe of b">rioxarray</code>模块有一个处理这种确切情况的函数。我们只需要给它所需投影的代码(在这种情况下，墨卡托的代码是<code class="fe oc od oe of b">'EPSG:3857'</code>)。让我们重新开始，这次用正确的投影。</p><p id="7bef" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated"><em class="mu">注意:重新投影一个巨大的文件会消耗大量资源，所以在生产环境中，我建议将结果保存在一个Parquet文件中，然后在显示数据时用Dask加载，但是这已经超出了我们的范围。</em></p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pk"><img src="../Images/5c8f85274cb67d62819e9e03bb0a081a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dkK02SrC3VjAp3trkEVd8Q.png"/></div></div></figure><p id="ae17" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">这次我们已经可以在x值中看到(使用科学记数法，<code class="fe oc od oe of b">3.775e+06</code>意为<code class="fe oc od oe of b">3.775 * 10^6</code>)它们在3775000到4666000之间。这些数字肯定比以前大得多，正如我们现在用米来计量时所预期的那样。让我们运行与之前完全相同的步骤(没有仍然有效和可用的配置部分):</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pl"><img src="../Images/d9c9678f34352fa3ae8494d4b4f6c30f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Zb71uNeg22Q-t3Ped-il-w.gif"/></div></div></figure><p id="bb38" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">万岁，成功了！有点…</p><p id="5c2b" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">我们有地图，我们在正确的位置上有它上面的图像，我们可以缩放和拖动，我们甚至有一个悬停工具提示…现在坏了:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi pm"><img src="../Images/54f6fcf20c6b80c7f13bf969cff10d41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*OJqFHgq8vlFnXxZW7pBeMA.png"/></div></figure><p id="2b47" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">叹气。这是有道理的:这一次，我们给了系统墨卡托坐标来显示，所以地图也不能在工具提示中显示熟悉的平面坐标。相反，我们得到的所有东西都是以米为单位的，尽管如此，这对于我们的大多数用户来说毫无用处。</p><p id="c703" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">因此，当我们显示悬停工具提示时，我们必须动态地将墨卡托坐标转换回平面坐标。为此，我们需要使用一些JavaScript。如果你不熟悉它，不要害怕，你可以把它作为一个复制粘贴解决方案，然后忘掉它。</p><h1 id="130b" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">创建自定义悬停工具提示</h1><p id="568e" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">如果你还记得，我提到过全息视图可以使用多个绘图库，在这个例子中，我们使用的是散景。它是一个python模块，让你编写Python代码，然后它将代码翻译成JavaScript，并在浏览器中用BokehJS库显示。幸运的是它有一个专门的工具可以将墨卡托坐标转换回平面坐标。虽然到目前为止，我们甚至没有直接使用python Bokeh模块，但是这个设置让我们可以直接向BokehJS提供一些关于如何显示悬停工具提示的信息。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="a695" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">让我们再试一次，这次使用新创建的定制工具。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pn"><img src="../Images/f37896a50b051b343a9b1ecc66b125c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ia5Eu0JnuAQXjYXVyFvcfQ.gif"/></div></div></figure><p id="87c5" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">完美！</p><p id="569c" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">Pfew。那是一次旅行…</p><h1 id="2335" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">但是巨大的像素呢？</h1><p id="3bf4" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">房间里有一头大象:到目前为止，我们只使用了每个像素覆盖5公里* 5公里的小数据集。由于这一点，整个压缩文件的大小是60KB，所以我们可以很容易地在服务器上解压缩数据，并将整个内容发送到浏览器。我们为此付出的代价是，我们的图像非常像素化，尤其是放大后。</p><p id="cb3b" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">这在某些情况下可能行得通，但是我们理论上的老板/客户有他们想要使用的非常详细的地图。该地图上的每个像素覆盖50米* 50米，因此整个数据集约为22，000像素高，18，000像素宽。这将让我们显示更多的详细信息，如果我们的用户需要特定位置的值，这可能是至关重要的。问题是，对于高分辨率数据，即使是压缩的GeoTIFF也超过300MB。如果我们试图一次显示整个数据集，解压缩后的数据将以千兆字节计算，这会导致巨大的下载时间，并保证浏览器中的内存冻结。</p><p id="ae44" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">这样做似乎也有点不必要。想想看，当用户在默认缩放级别下看到整个图像时，他们会看到所有的22k*18k像素。他们的屏幕分辨率低得多，所以分辨率低得多的快照就足够了。更高分辨率的图像只有在越来越放大时才有意义。但是当这种情况发生时，他们只能看到图像越来越小的部分，所以把不可见的部分也发给他们是没有用的。</p><p id="919e" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">这意味着我们需要一个解决方案</p><ol class=""><li id="d640" class="no np iq ma b mb mv me mw mh pb ml pc mp pd mt pe nu nv nw bi translated">它可以捕捉当前的视窗和缩放级别，</li><li id="9e95" class="no np iq ma b mb nx me ny mh nz ml oa mp ob mt pe nu nv nw bi translated">向浏览器发送仅覆盖可见区域的图像</li><li id="8224" class="no np iq ma b mb nx me ny mh nz ml oa mp ob mt pe nu nv nw bi translated">并以合理的分辨率完成。</li></ol><p id="dfff" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">这听起来像是一个企业级的功能，我们将花费余生来开发。除了Holoviews与Datashader模块集成，它们一起可以精确地完成这一点。</p><p id="d8a8" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated"><em class="mu">(快速补充说明:Datashader是一个不可思议的工具，可以从不可显示的大数据集生成可显示的图像。它可以让您显示数十亿个独立的坐标，或者在我们的例子中，显示否则无法使用的网格数据集。如果你打算使用全息视图，你绝对应该</em> <a class="ae lf" href="https://datashader.org/" rel="noopener ugc nofollow" target="_blank"> <em class="mu">查看数据。)</em></a></p><h1 id="3935" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">集成Datashader以动态显示高分辨率图像</h1><p id="8fdf" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">让我们再重复一遍我们上面所做的，但最后是大数据集。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="1ebe" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">请注意，这一次我没有显示结果图像。原因在于，根据具体的数据集，要么Colab内核会完全崩溃，要么整个进程会一直挂起，直到您的浏览器因内存不足而崩溃。</p><p id="77f0" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">我们没有将这个<code class="fe oc od oe of b">hv.Image()</code>直接与地图结合，而是首先基于它创建一个动态图像。我们只需将它放入Holoviews提供的Datashader函数中，并将其导入为hd.regrid。然后，我们将这个新创建的动态图像与地图结合起来。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi po"><img src="../Images/9fb9b1209ed1ce19991cbc24f497ed98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*A2iocMHIVLiUCGftmWpaIw.gif"/></div></div></figure><p id="1887" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">如果我们缩放和平移，我们可以看到令人惊叹的事情正在发生，我们自动获得更高分辨率的图像。但与此同时，图片会被奇怪地重新着色，而且颜色条每次都在变化。这些事情以前没有发生过。</p><p id="8a52" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">对此的解释是，之前，我们的小部件使用了整个低分辨率数据集，因此它知道最低值和最高值。由此，它可以创建一个强大的色标，覆盖从大约0到大约5000米的整个数据光谱。这意味着无论我们在哪里缩放，相同的值总是得到相同的颜色。</p><p id="87fa" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">然而，我们新的动态系统的显示部分只接收数据集的可见部分。每次用户交互时，小部件都必须使用当前可见的最低和最高值来拉伸它们之间的色阶。如果我们放大到最高值只有几百米的平坦区域，该区域现在将被着色为保留给最高值的颜色(白色)，棕色、黄色和绿色覆盖其下的值。相反，如果我们放大到一个山顶，即使是最低的可见点也在2000米以上，那么从这个高度开始，它将被染成绿色、黄色、棕色和白色。这就是为什么图像每次都被重新着色，为什么颜色条显示新的值。这实际上在很多情况下可能是一个有价值的功能，因为它使我们关注的任何小细节突出出来，真正突出了微小的差异，但如果你想有一个一致的图像，这真的很糟糕。</p><h1 id="023a" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">修复彩条</h1><p id="4dff" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">为了解决这个问题，我们将查询数据集并获得整个数据集的实际最小值/最大值。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><pre class="kp kq kr ks gt oi of oj ok aw ol bi"><span id="8cc3" class="na lh iq of b gy om on l oo op">(-20.0, 5035.0)</span></pre><p id="6724" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">接下来，我们将颜色范围限制更新为这些值。我们不更新默认选项，因为此信息与此数据密切相关。如果我们想在它旁边显示一些其他的数据集，使用这些限制也是不合理的。相反，我们将它们直接应用于我们的组合元素。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pp"><img src="../Images/f6476fe0d852612608485ad508981c83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*kyVZnYC7gwRQRm9e6Htvuw.gif"/></div></div></figure><h1 id="ace5" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">从这里去哪里？</h1><p id="e5bf" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">希望你的客户/老板接受Colab笔记本作为最终结果。否则，您将需要一种更专业的方式来发布您的小部件。我们将在未来可能的文章中探讨这个主题。</p><p id="158d" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">现在，让我举一个简单的例子，说明我们已经发现的一些特性是如何在一个交互式小部件中呈现的。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pq"><img src="../Images/ef3aca2a108c636a6d1c0193a8fc8ea7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*OCoktyIVf9UhrVBkQ7dQIg.gif"/></div></div></figure><p id="9e4d" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">您可以查看Colab笔记本中的实例:</p><p id="8162" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated"><a class="ae lf" href="https://colab.research.google.com/drive/15aG8Abyv6mWRkvk7IsR3J5WLGYOI2tj0?usp=sharing" rel="noopener ugc nofollow" target="_blank">https://colab . research . Google . com/drive/15 ag 8 abyv 6 mwrkvk 7 is R3 j 5 wlgyo i2t j 0？usp =共享</a></p><h1 id="270e" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">可能的替代方案</h1><p id="66ad" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">无论你不想或不能使用上述解决方案的原因是什么，我知道有一些替代方案，它们都有一些警告。</p><h2 id="1fe5" class="na lh iq bd li nb nc dn lm nd ne dp lq mh nf ng ls ml nh ni lu mp nj nk lw iw bi translated">地理视图</h2><p id="e545" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">在同一个Holoviz生态系统中，有一个模块专门用于处理这类任务:<a class="ae lf" href="https://geoviews.org/" rel="noopener ugc nofollow" target="_blank"> Geoviews </a>。假设<code class="fe oc od oe of b">hv.element.tiles.OSM() * hd.regrid(gv.util.load_tiff('your/file.tif'))</code>行本身给你的结果与上面的整个代码相同(尽管我没有测试它)，所以选择它看起来是显而易见的。</p><p id="f693" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">然而，它有两个问题。一个是严重缺乏该特性的文档，因为甚至他们自己的网站也只在一个发布说明中提到过一次“load_function”字符串。另一个是Geoviews能够在后台做许多令人惊叹的GIS魔术，因为它严重依赖于许多科学GIS模块。其中一些需要手动安装，这需要花费大量的时间、精力和经验。喜欢，很多。我做过几次，都获得了不同程度的成功，但这真的很痛苦。例如，基于论坛，我甚至不确定是否有可能在Google Colabs上设置它。如果你有一个轻松的Linux服务器，你只需要设置一次，并且你可以长时间使用同一个环境，那么它可能是你最好的解决方案。如果你像我一样，通过本地Windows开发从Colab跳到任何Linux服务器或无服务器产品，你最好不要依赖于你不确定下次还能不能安装的东西。</p><p id="9bf8" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">开发者知道这个问题。希望他们能够重构和重写模块，只需要较少麻烦的依赖，因为它是一个非常天才的工具。但目前来看，事实就是如此。</p><h2 id="fce9" class="na lh iq bd li nb nc dn lm nd ne dp lq mh nf ng ls ml nh ni lu mp nj nk lw iw bi translated">破折号+情节</h2><p id="b309" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated"><a class="ae lf" href="https://dash.plotly.com/" rel="noopener ugc nofollow" target="_blank">破折号</a>和<a class="ae lf" href="https://plotly.com/python/" rel="noopener ugc nofollow" target="_blank">情节上</a>有点类似于商业领域，就像Holoviz生态系统对于科学领域一样。可以说，他们的学习曲线不太陡峭，文档也更全面。</p><p id="55fa" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">然而，他们没有像我们一样将网格数据集放到地图上的方法，至少在写这篇文章的时候没有。这是一个遗憾，因为他们有各种网格表示的图表(如px.imshow，go.image，go.heatmap)，他们对基于图块的地图有很好的支持，但没有办法将它们结合起来。这是可悲的，因为他们甚至有全息视图和数据阴影集成。因此，你可以做的最好的事情是遵循他们的Plotly+Datashader教程之一，这将允许你把一个视觉图像(即使是由Datashader创建的)放到地图上，但你不会访问数据本身，所以没有悬停工具提示。如果您不需要访问数据，而您需要将您的项目集成到Dash应用程序中，这可能是一个合理的折衷方案。</p><p id="0d20" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">顺便说一下:如果在任何时候Plotly将能够在地图上显示网格数据，由于Holoviews-Plotly的集成，我们上面的整个练习只需要一个改变:<code class="fe oc od oe of b">hv.extension('plotly', logo=False)</code>，然后一切都应该显示在Plotly中，准备在Dash中显示。手指交叉。</p><h2 id="f1d8" class="na lh iq bd li nb nc dn lm nd ne dp lq mh nf ng ls ml nh ni lu mp nj nk lw iw bi translated">dash-传单+陶土(或任何其他方式来创建和展示瓷砖)</h2><p id="2fd4" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">你可以做的另一件事是将你的GeoTIFF转换成这些地图已经使用的相似tileset，并将那个tileset放在原始地图的上面。<a class="ae lf" href="https://www.mapbox.com/mts" rel="noopener ugc nofollow" target="_blank">Mapbox.com切片服务</a>是实现这一点的一种方式，但还有一个名为<a class="ae lf" href="https://github.com/DHI-GRAS/terracotta" rel="noopener ugc nofollow" target="_blank"> Terracotta </a>的python模块，它可以获取您的地理信息，创建地图切片，并按需作为服务器提供服务。从那里你只需要一张可以使用它们的地图。</p><p id="8a7f" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">有很多选择，但<a class="ae lf" href="https://dash-leaflet.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">Dash-leaf</a>是最好的选择之一。这是流行的LeafletJS映射库的Python实现，移植它的人甚至有一个<a class="ae lf" href="https://github.com/thedirtyfew/terracotta-dash-example" rel="noopener ugc nofollow" target="_blank">terra cotta-Dash-Leaflet demo</a>来展示完全相同的东西，所以很容易安装和运行。它与Plotly+Dash解决方案具有相同的缺点。由于浏览器只接收来自服务器的可视图像，所以它没有办法在悬停工具提示上显示数据。然而，它有一个聪明的解决办法，在鼠标点击时，它可以向服务器发送请求，并在该位置获得准确的数据。它不像工具提示那样无缝，但是如果您只需要在很少的情况下查看数据，这可能是一个很好的解决方案。此外，如果您有任何问题，Dash传单库的创建者Emil在Dash论坛上提供了一些企业级支持<a class="ae lf" href="https://community.plotly.com/t/show-and-tell-dash-leaflet/34924" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="c201" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">但是正如我提到的，有多种方法可以创建和提供tilesets，如果你有，你可以使用几乎任何图表库，可以显示基于tile的地图，所以你这样做。</p><p id="bf50" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">你知道其他方法吗？请在评论中告诉我！</p><h1 id="e633" class="lg lh iq bd li lj lk ll lm ln lo lp lq kf lr kg ls ki lt kj lu kl lv km lw lx bi translated">承认</h1><p id="f3b8" class="pw-post-body-paragraph ly lz iq ma b mb mc ka md me mf kd mg mh mi mj mk ml mm mn mo mp mq mr ms mt ij bi translated">感谢<a class="ae lf" href="https://github.com/philippjfr" rel="noopener ugc nofollow" target="_blank">菲利普·鲁迪格</a>、<a class="ae lf" href="https://github.com/bryevdv" rel="noopener ugc nofollow" target="_blank">布莱恩·范·德·Ven</a>、<a class="ae lf" href="https://github.com/jbednar" rel="noopener ugc nofollow" target="_blank">詹姆斯·a·贝德纳尔</a>和<a class="ae lf" href="https://github.com/MarcSkovMadsen" rel="noopener ugc nofollow" target="_blank">马克·斯科夫·麦德森</a>，不仅仅是因为他们对Holoviz生态系统的贡献，也因为他们回答了我不断提出的问题。</p><p id="036c" class="pw-post-body-paragraph ly lz iq ma b mb mv ka md me mw kd mg mh mx mj mk ml my mn mo mp mz mr ms mt ij bi translated">还要感谢谷歌的@blois 立即调查了Colab和Holoviews在交互功能方面的一些<a class="ae lf" href="https://github.com/googlecolab/colabtools/issues/623" rel="noopener ugc nofollow" target="_blank">不兼容问题</a>。</p></div></div>    
</body>
</html>