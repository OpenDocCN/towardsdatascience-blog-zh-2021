<html>
<head>
<title>Learn How to Perform Serverless Orchestration with Google Cloud Workflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解如何使用Google Cloud Workflow执行无服务器流程编排</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/learn-how-to-perform-serverless-orchestration-with-google-cloud-workflow-5e20cee72a7c?source=collection_archive---------13-----------------------#2021-08-07">https://towardsdatascience.com/learn-how-to-perform-serverless-orchestration-with-google-cloud-workflow-5e20cee72a7c?source=collection_archive---------13-----------------------#2021-08-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f91b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于创建工作流以连接服务的简单教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5a4483ad7ea44f9b257c83cd9206b0c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TWdPnCzyyXRySuGkTP7Pag.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安德里亚·扎内加拍摄于<a class="ae ky" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><h1 id="a745" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated"><strong class="ak">简介</strong></h1><p id="aa0b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">谷歌工作流于<a class="ae ky" href="https://cloud.google.com/workflows/docs/release-notes#January_25_2021" rel="noopener ugc nofollow" target="_blank">2020年</a>8月25日首次推出。它是一个平台，作为开发人员的无服务器工作流来编排和自动化Google Cloud，并连接一系列基于HTTP的API服务。例如，您可以使用Google Workflow连接云运行微服务、云功能、外部API等。</p><p id="dcf4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">工作流由一系列步骤组成，这些步骤指定了每个步骤要执行的功能，并以YAML或JSON格式编写。完成工作流创建后，您需要<strong class="lt iu">部署</strong>工作流，然后才能<strong class="lt iu">执行</strong>。在<strong class="lt iu">执行</strong>时，它将基于创建的工作流中指定的逻辑运行。</p><p id="f2fe" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本文中，让我们学习如何使用Google Cloud Workflow——我将通过涵盖以下项目，提供如何在Google Workflow上执行特定任务的示例:</p><p id="a8a0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">(1)打印“Hello World”消息</p><p id="6eef" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">(2)调用HTTP端点/ API /微服务</p><p id="5a22" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">(3)用数组和字典进行循环和迭代</p><p id="742b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">(4)向工作流添加日志</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="7b6c" class="kz la it bd lb lc mz le lf lg na li lj jz nb ka ll kc nc kd ln kf nd kg lp lq bi translated"><strong class="ak">我们开始吧:</strong></h1><p id="12eb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果这是您第一次访问Google Workflow，您将需要启用API。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/ebda0d31ee13de2a4a28f5c3cf25640e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tb9oZoirYFDtX1TEUAg7fg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">启用Google工作流API</p></figure><p id="1f8f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">启用工作流API后，您可以创建新的工作流。选择“创建”以创建您的第一个工作流程:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/62e1b351d11b383aad81ee7615c775e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ohkacDbDPD95Jlv0ePo4_Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建Google工作流</p></figure><p id="3c0a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">点击“下一步”按钮，您可以开始定义您的工作流程。</p><h2 id="0e8c" class="ng la it bd lb nh ni dn lf nj nk dp lj ma nl nm ll me nn no ln mi np nq lp nr bi translated">(1)打印“Hello World”消息</h2><p id="9979" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们从基础开始，创建一个要返回的“Hello World”消息。我们需要定义一个返回消息的步骤。下面是我们将如何定义:</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="9e35" class="ng la it nt b gy nx ny l nz oa">- returnHelloWorld:<br/>        return: "Hello World"</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/c999e1a279a50fed51856218f31c7d14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LOPnT8SdcyEBgRH8hGWaBA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">工作流程示例—打印“Hello World”</p></figure><p id="1f54" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">定义完工作流后，单击“部署”按钮部署工作流，然后执行它。您会注意到，如果没有错误，您的工作流已经成功执行，输出消息为“Hello World”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/c4f3897891d1c9b282e4821307b515eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K3tsjs1zlAeF3hZZuqToFA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">工作流示例—打印“Hello World”执行结果</p></figure><p id="fe70" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">恭喜你！您已经创建了第一个工作流。让我们继续，看看如何从Google workflow调用API端点。</p><h2 id="ed95" class="ng la it bd lb nh ni dn lf nj nk dp lj ma nl nm ll me nn no ln mi np nq lp nr bi translated">(2)调用HTTP端点/ API /微服务</h2><p id="9659" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，我们将构建一个调用HTTP端点的步骤。常见的HTTP请求方法有“GET”和“POST”。但是在这个例子中，我们将尝试一个“HTTP。GET”请求使用已部署的云运行微服务。我们可以从部署的服务细节中检索云运行URL。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/f67ba46a77cc3caf38f9fba0e33ca0ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jbx6uYeyfv4ekmyQVIPwig.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">云运行端点</p></figure><p id="89eb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这个云运行微服务使用GET方法，需要传递一个输入。在本例中，输入“AZ”(state-Arizona)将被传递给服务，它将返回一条消息，其中包含该州新冠肺炎病例总数的值。<a class="ae ky" href="https://console.cloud.google.com/marketplace/browse?filter=solution-type:dataset&amp;filter=category:covid19" rel="noopener ugc nofollow" target="_blank"> <em class="oe">(该数据集是Google BigQuery数据集程序下检索的新冠肺炎公共数据集，日期范围为2020年5月至2020年10月)</em> </a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/145885a54975a3ba4565cbe31b22093d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6y54NQ6pse_hdQkkIn1Z8Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">云运行微服务—返回消息</p></figure><p id="acd0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如上图所示，cloud run服务将以JSON格式返回亚利桑那州的全部新冠肺炎病例。现在，要从Google workflow中调用这个服务，我们需要创建一个步骤(<em class="oe"> getMicroservice </em>)，调用属性为“http.get”，URL需要在参数下指定。</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="0a52" class="ng la it nt b gy nx ny l nz oa">- getMicroservice:<br/>       call: http.get<br/>       args:<br/>           url: <a class="ae ky" href="https://microservicesexample1-3wv4vbmeja-as.a.run.app/state/AZ" rel="noopener ugc nofollow" target="_blank">https://microservicesexample1-3wv4vbmeja-as.a.run.app/state/AZ</a><br/>       result: state_result<br/>- returnResult:<br/>       return: ${state_result.body}</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/1e7313743b0d06937d75c0172258a9c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t13rPJ5Sw1az0xlIB5UHYQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">工作流示例—呼叫端点</p></figure><p id="979d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">注意，在最后一步(<em class="oe"> returnResult </em>)，我们从HTTP端点检索返回消息的主体。返回消息将采用JSON格式，说明它是如何被指定的，并从云运行微服务返回。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/3411b11f9193faf665749c1361e06141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uyXotW40NQ4mKk2xohczeQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">工作流示例—调用端点执行结果</p></figure><p id="b10d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">干得好！您现在了解了如何在Google Workflow中调用URL。让我们继续，看看如何通过迭代数组值列表来创建循环和迭代。</p><h2 id="da1a" class="ng la it bd lb nh ni dn lf nj nk dp lj ma nl nm ll me nn no ln mi np nq lp nr bi translated">(3)用数组和字典进行循环和迭代</h2><p id="e6cd" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本例中，我们将创建循环和迭代，这些循环和迭代将遍历定义的数组列表，并将数组值传递给HTTP端点，并使用不同的输入值多次触发HTTP端点。在上一步中，我们只传递了“Arizona(AZ)”的输入值，而数据集中还有其他州。让我们看看如何为多个状态创建一个数组列表，并通过多次迭代传递这个值来调用HTTP端点。我们将创建一个数组列表来调用“亚利桑那(AZ)，加利福尼亚(CA)，佛罗里达(FA)”。</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="1b81" class="ng la it nt b gy nx ny l nz oa">- define:<br/>        assign:<br/>            - array: ['AZ','CA','FL']<br/>            - result: ""<br/>            - i: 0<br/>    - checkCondition:<br/>        switch: <br/>            - condition: ${i&lt;len(array)}<br/>              next: iterate<br/>        next: returnResult <br/>    - iterate:<br/>        steps:<br/>            - getMicroservice:<br/>                call: http.get<br/>                args:<br/>                    url: ${"<a class="ae ky" href="https://microservicesexample1-3wv4vbmeja-as.a.run.app/state/" rel="noopener ugc nofollow" target="_blank">https://microservicesexample1-3wv4vbmeja-as.a.run.app/state/</a>"+array[i]}<br/>                result: state_result<br/>            - assign_loop:<br/>                assign:<br/>                    - i: ${i+1}<br/>        next: checkCondition<br/>    - returnResult:<br/>        return: ${"Result has been Successfully executed"}</span></pre><p id="e936" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">注意，有一个称为(<em class="oe"> checkCondition) </em>的步骤，用于决定循环应该何时结束。如果循环条件为真，它将把数组值传递给步骤(<em class="oe">迭代</em>)。在步骤(<em class="oe"> iterate) </em>下，数组值将作为输入值传递给HTTP端点“<em class="oe"> +array[i]”。</em>在完成数组列表中的值的迭代后，循环将结束并移动到最后一步(<em class="oe"> returnResult </em>)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/be6263288191d6fe654cfa798f932811.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2pYiW7xLsTBqI4TQBAarMQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">工作流示例—使用数组列表进行循环和迭代</p></figure><p id="8b73" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">干得好！您现在已经了解了如何创建一个循环并使用数组列表进行迭代。接下来，我们想添加日志来了解每个循环中发生了什么。</p><h2 id="07cf" class="ng la it bd lb nh ni dn lf nj nk dp lj ma nl nm ll me nn no ln mi np nq lp nr bi translated">(4)向工作流添加日志</h2><p id="18a4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在Google workflow中，有内置的日志记录功能，我们可以将这些功能添加到工作流中，以创建更多关于正在发生的事情的可见性。例如，在我们前面的例子中，我们想知道在每个循环中传递哪个数组值，以及这些值是什么。让我们将这个额外的日志步骤添加到我们的工作流中。</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="1b23" class="ng la it nt b gy nx ny l nz oa">- define:<br/>        assign:<br/>            - array: ['AZ','CA','FL']<br/>            - result: ""<br/>            - i: 0<br/>    - checkCondition:<br/>        switch: <br/>            - condition: ${i&lt;len(array)}<br/>              next: iterate<br/>        next: returnResult <br/>    - iterate:<br/>        steps:<br/>            - logstep-1:<br/>                call: sys.log<br/>                args:<br/>                    text: ${"Job is running for " + array[i]}<br/>                    severity: INFO<br/>            - getMicroservice:<br/>                call: http.get<br/>                args:<br/>                    url: ${"<a class="ae ky" href="https://microservicesexample1-3wv4vbmeja-as.a.run.app/state/" rel="noopener ugc nofollow" target="_blank">https://microservicesexample1-3wv4vbmeja-as.a.run.app/state/</a>"+array[i]}<br/>                result: state_result<br/>            - logstep-2:<br/>                call: sys.log<br/>                args: <br/>                    text: ${"Result for State " + array[i] + " total is " + state_result.body.Total}<br/>                    severity: INFO<br/>            - assign_loop:<br/>                assign:<br/>                    - i: ${i+1}<br/>        next: checkCondition<br/>    - returnResult:<br/>        return: ${"Result has been Successfully executed"}</span></pre><p id="c3dd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要将日志添加到工作流中，只需添加一个新步骤和对函数“sys.log”的调用。在示例create中，有几个关于严重性的选项，如INFO、WARNING、CRITICAL等。请注意，在下面的可视化中，logs步骤被添加为循环迭代的一部分。因此，日志会打印出每次迭代中发生的事情。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/cde6e5750b93ca2ae63bd10b213835ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xKoR8uJ8f9Jl-x1cEretYA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">工作流示例—添加日志</p></figure><p id="c6e7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">可以通过导航到日志选项卡来查看日志。让我们看看我们的日志上打印了什么:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/36a5729d4390959d044a47f4346f03a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GGfPQM758gZgpz0U2uIQpA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">工作流示例-添加日志:日志结果</p></figure><p id="e92e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">从日志中我们可以看到，我们知道第一次运行的迭代是针对Arizona (AZ)的，总案例数是140471。后续的迭代细节也会在日志中打印出来。添加日志确实让工作流中发生的事情更加清晰。</p><h2 id="bebc" class="ng la it bd lb nh ni dn lf nj nk dp lj ma nl nm ll me nn no ln mi np nq lp nr bi translated"><strong class="ak">结论:</strong></h2><p id="66f5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">当您需要管理多个服务时，例如处理一系列事件/API，Google workflow是一个合适的平台。此外，它易于管理，因为不需要基础架构，并且平台可以按需扩展。Google Workflow中还有本文没有涉及的其他特性，比如错误处理、重试步骤、睡眠功能等。尽管如此，我希望这篇文章能让你很好地理解如何在Google Cloud上创建工作流。</p><p id="8c6d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">参考文献&amp;链接:</strong></p><p id="16bb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[1]<a class="ae ky" href="https://cloud.google.com/workflows/docs/http-requests" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/workflows/docs</a></p><p id="d9a2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[2]<a class="ae ky" href="https://cloud.google.com/workflows/docs/reference/stdlib/sys/log" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/workflows/docs/reference/stdlib/sys/log</a></p><p id="488f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[3]<a class="ae ky" href="https://atamel.dev/posts/2020/09-08_first_look_at_workflows/" rel="noopener ugc nofollow" target="_blank">https://atamel . dev/posts/2020/09-08 _ first _ look _ at _ workflows/</a></p></div></div>    
</body>
</html>