<html>
<head>
<title>Preprocessing 3D Volumes for Tumor Segmentation Using Monai and PyTorch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Monai和PyTorch预处理用于肿瘤分割的3D体积</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/preprocessing-3d-volumes-for-tumor-segmentation-using-monai-and-pytorch-eaeb3d718570?source=collection_archive---------37-----------------------#2021-08-09">https://towardsdatascience.com/preprocessing-3d-volumes-for-tumor-segmentation-using-monai-and-pytorch-eaeb3d718570?source=collection_archive---------37-----------------------#2021-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5745" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">为肿瘤或器官分割准备nifti体积</h2></div><p id="5322" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在我的网站<a class="ae lb" href="https://pycad.co/preprocessing-3d-volumes-for-tumor-segmentation-using-monai-and-pytorch/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir"> <em class="lc">这里</em> </strong> </a>找到原文。</p><p id="b718" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是这篇文章的视频版本，其中可能包括一些我忘记在文章中包括的解释。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="li lj l"/></div></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lk"><img src="../Images/b2183dda6ea7b6995865a43f8af235da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MMXQo2HVS7BgvO9Rj89Bug.jpeg"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">图片来自Mart Production的Pexels</p></figure><h1 id="4369" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">介绍</h1><p id="f61e" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">关于我们在使用传统图像处理工具时可能遇到的困难，深度学习已经成为医疗保健领域的主要解决方案。</p><p id="1bce" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于医学图像比标准图像更难处理(密集的对比度，人体的大范围变化…)，深度学习用于分类，对象检测，尤其是分割任务。</p><p id="bdf7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">说到分割，深度学习被用于分割人体器官，如肝脏、肺等，或者分割身体不同部位的肿瘤。</p><p id="8b88" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有许多不同类型的医学图像，如MRI(主要用于脑瘤分割)、CT扫描、PET等。</p><p id="ee0d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文将重点介绍CT扫描，但同样的操作也可以应用于其他类型。</p><p id="28fb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们知道，执行深度学习任务需要许多步骤，其中之一是数据预处理，这是我们在启动培训之前必须做的第一件事。这是本文的主题；我们将讨论可用于执行这一预处理的工具。</p><p id="7a72" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">准备数据因任务而异；例如，分类是最容易的，因为我们只需要准备图像，而对象检测和分割需要我们准备图像以及标签(用于分割的边界框或遮罩)。</p><p id="f6f4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将以分割为例，它可用于肿瘤或器官分割。</p><p id="d432" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在医学成像中，我们可以处理2D图像，这些图像可以是DICOM、jpg或png，也可以是3D体积，它们是切片组，每个切片是一个2D文件(大多数情况下是DICOM)，而这个组是一个nifti文件，它代表整个患者或他身体的一部分。请阅读<a class="ae lb" href="https://pycad.co/what-is-the-difference-between-dicom-and-nifti-images/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir"> <em class="lc">本文</em> </strong> </a>了解dicom和nifti的区别。</p><p id="a0c5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将在本文中使用3D卷，因此如果您有想要转换成卷的2D文件，请参见本文<a class="ae lb" href="https://pycad.co/how-to-convert-a-dicom-series-into-one-nifti-file-python/" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir"><em class="lc"/></strong></a>。</p><h1 id="3515" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">我们将使用的工具</h1><p id="2fa4" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">为了完成这个任务，我们将使用一个名为monai的开源框架，它基于PyTorch，我在实习期间使用过这个框架，发现非常有用。</p><p id="d0bc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">想看它的文档请见<a class="ae lb" href="https://docs.monai.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir"> <em class="lc">这个链接</em> </strong> </a>。</p><h1 id="35dd" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">方法学</h1><p id="5e9e" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">我们现在将开始编写我们的函数来执行CT扫描中肿瘤分割的预处理。第一步是使用pip或conda安装库，这取决于您使用的环境。</p><p id="b93d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mv b"><strong class="kh ir"><em class="lc">pip install monai</em></strong></code></p><p id="f81a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我强烈建议您为您的项目建立一个虚拟环境，因为这个库在直接安装到系统中时并不总是能够工作。</p><p id="81e0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后需要安装PyTorch和monai的一些依赖项。</p><p id="c34a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mv b"><strong class="kh ir"><em class="lc">pip install torch</em></strong></code></p><p id="7fcc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mv b"><strong class="kh ir"><em class="lc">pip install torch-vision</em></strong></code></p><p id="500f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mv b"><strong class="kh ir"><em class="lc">pip install “monai-weekly[gdwon, nibabel,tqdm]”</em></strong></code></p><p id="97ce" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，您需要包含您将需要的库。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mw lj l"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者编写的代码</p></figure><p id="12d9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们来看看如何加载数据。对此有两种方法。</p><p id="5927" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> <em class="lc"> 1- </em> </strong>首先是分别加载图像和蒙版(如果你想进行图像分类，可以使用这种方法，但它也适用于分割)。</p><p id="46bc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> <em class="lc"> 2- </em> </strong>第二种方法是创建一个包含两列的Python字典，一列用于图像路径，一列用于标签路径。然后在每一行中输入带有相应遮罩的图像的路径。</p><p id="d232" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就我个人而言，我更喜欢第二种方法，因为当我们应用转换时，我们将能够只选择图像或标签或两者的关键字，而不是为图像和标签(遮罩)创建转换。</p><p id="3398" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您必须创建一个包含整个数据集路径的变量。在我的例子中，我有四个文件夹:TrainData，用于训练图像和遮罩的TrainLabels，以及ValData，用于验证图像和遮罩的ValLabels。</p><p id="9358" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，要创建一个字典来存储路径，请使用下面几行代码:</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mw lj l"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者编写的代码</p></figure><p id="848b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">之后，你已经创建了字典，如果你不熟悉它，这很简单。如果要引用字典中的第一项，可以像在普通数组中一样使用index 0，但是第一项将有两列，第一列是图像的路径，第二列是标签的路径(关于这一部分的更多信息，可以查看上面的youtube视频)。</p><h1 id="8dc4" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">变换</h1><p id="8446" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">为了对同一个病人应用多个转换，我们将使用monai的“compose”功能，该功能允许您组合任何想要的转换(monai文档中定义的转换)。</p><p id="3a9f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在应用任何转换时，您应该知道一些事情:有些步骤是必需的，而有些是可选的。</p><p id="aa43" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用monai时，主要的转换是“Load image”来加载漂亮的文件，以及“ToTensor”来将转换后的数据转换成torch tensors，以便我们可以使用它进行训练。</p><p id="e497" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们已经讨论了基本的转换，我们将继续讨论其他的。我将讨论在我实习期间特别重要的五个转变。</p><p id="78c6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> <em class="lc"> AddChanneld: </em> </strong>这个函数会给我们的图像加上一个通道，并贴上标签(我说的图像是指多个切片的体积)，因为我们在做肿瘤分割的时候，需要一个通道起到背景或者肿瘤的作用。</p><p id="cf16" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> <em class="lc"> Spacingd: </em> </strong>该功能将帮助我们改变体素尺寸，因为我们不知道医学图像的数据集是通过相同扫描还是不同扫描获得的，所以它们可能具有不同的体素尺寸(宽度、高度、深度)，所以我们需要将它们全部归纳为相同的尺寸。</p><p id="1650" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"/></p><p id="31df" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"><em class="lc">cropforeground:</em></strong>该功能将帮助我们裁剪掉图像中我们不需要的空白区域，只留下感兴趣的区域。</p><p id="020d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> <em class="lc">调整大小:</em> </strong>最后，这个函数是可选的，但在我看来，如果您使用cropforeground函数，则它是必需的，因为执行裁剪的函数将根据每个患者的情况输出随机尺寸，所以如果我们不添加一个操作来为所有患者提供相同的尺寸，我们的模型将无法工作。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mw lj l"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者编写的代码</p></figure><p id="d061" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如你所看到的，在我们使用的每个函数的末尾都有一个<strong class="kh ir">“d”</strong>，这是字典(如果你没有使用字典，那么你需要删除它)。我们还为每个操作添加了参数<strong class="kh ir"><em class="lc">【keys】</em></strong>，以指定我们是否要将该变换应用于图像、标签或两者。您可以看到，几乎所有时间我们都将该函数应用于标签和图像，但在ScaleIntensityRange中，我们仅将其应用于图像，因为我们不需要更改强度或归一化标签的值。</p><h1 id="88af" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">数据加载器</h1><p id="10e2" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">现在，与任何深度学习代码一样，我们必须在开始训练之前加载数据及其转换；为此，必须使用两个基本函数。</p><p id="c5af" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> <em class="lc">数据集:</em> </strong>该函数将定义数据及其转换，因此如果您有训练集和验证集，您将需要创建两个“数据集”函数，一个将训练数据与其转换相结合，另一个将验证数据与其转换相结合。当然，如果对定型集和验证集应用相同的转换，则必须在函数“dataset”的参数“transform”中使用相同的转换</p><p id="036d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> <em class="lc">数据加载器:</em> </strong>这是将数据加载到具有特定批量大小的RAM中的函数(它将创建另一个通道以在训练期间指定批量大小的索引)将有两个数据加载器，一个用于训练，一个用于验证。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mw lj l"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者编写的代码</p></figure><h1 id="5248" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">绘制一个例子</h1><p id="550b" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">应用转换后，您可以绘制一些切片，以查看使用和不使用转换时数据有何不同。</p><p id="04cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以使用monai函数<strong class="kh ir"><em class="lc">【first】</em></strong>从dataloader中获取第一个项目，这将是第一个患者。</p><p id="a528" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有几行代码可以帮助你绘制例子。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mw lj l"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者编写的代码</p></figure><p id="936a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们来看看有和没有转换的输出:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi mx"><img src="../Images/850189fcf066b9e66aca667e7b9dd2e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y5um7uGV5o8E_h-hN4XByQ.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">作者捕获的图像</p></figure><p id="7e9f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">左边是没有转换的切片，中间是我们讨论过的带有转换的同一切片，右边是相应的标签。</p><p id="3388" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是如何使用monai为分割准备3D体积。如果你想看更多的变形金刚，去莫奈的网站。但是，有些转换是为数据扩充而设计的，而不是为预处理而设计的。我也会写一篇关于它的文章。</p><blockquote class="my mz na"><p id="ed0a" class="kf kg lc kh b ki kj jr kk kl km ju kn nb kp kq kr nc kt ku kv nd kx ky kz la ij bi translated">PS:我推荐看视频，因为文中还有我可能忽略的额外解释。</p></blockquote><blockquote class="ne"><p id="e023" class="nf ng iq bd nh ni nj nk nl nm nn la dk translated">你可以从<a class="ae lb" href="https://github.com/amine0110/preporcess-volume-medical-imaging/blob/main/main.ipynb" rel="noopener ugc nofollow" target="_blank">这个链接</a>找到代码。</p></blockquote></div><div class="ab cl no np hu nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ij ik il im in"><h1 id="91b6" class="lv lw iq bd lx ly nv ma mb mc nw me mf jw nx jx mh jz ny ka mj kc nz kd ml mm bi translated">你想学医学影像的深度学习！</h1><p id="5b1e" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">即将推出全面的医学成像课程，涵盖使用Monai和PyTorch的2D和3D分割，并提供额外支持。加入等候名单以接收任何课程更新的通知。</p><div class="oa ob gp gr oc od"><a href="https://pycad.co/monai-and-pytoch-for-medical-imaging/" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">医学成像深度学习登录页面- PYCAD</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">使用Monai和PyTorch的医学成像中的2D和3D分割。</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">pycad.co</p></div></div><div class="om l"><div class="on l oo op oq om or lp od"/></div></div></a></div></div><div class="ab cl no np hu nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="ij ik il im in"><blockquote class="ne"><p id="f848" class="nf ng iq bd nh ni os ot ou ov ow la dk translated">订阅<a class="ae lb" href="https://astounding-teacher-3608.ck.page/136bdb1fbe" rel="noopener ugc nofollow" target="_blank">我的简讯</a>获取我工作的所有更新:)。</p></blockquote></div></div>    
</body>
</html>