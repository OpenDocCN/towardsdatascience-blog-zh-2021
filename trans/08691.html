<html>
<head>
<title>Break Up a Big Airflow DAG into Multiple Files</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将一个大的气流DAG分解成多个文件</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/break-up-a-big-airflow-dag-into-multiple-files-5262accf6713?source=collection_archive---------6-----------------------#2021-08-11">https://towardsdatascience.com/break-up-a-big-airflow-dag-into-multiple-files-5262accf6713?source=collection_archive---------6-----------------------#2021-08-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f51a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">模块化你的大气流DAG的大块，以便于使用和维护</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/07585a88cb4e02b69e52d29b2b66601c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1sreeTsS3aCLko4I"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">丹尼尔·林肯在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="b13e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我正在处理一个长达数百行的气流DAG文件。进行更改需要在文件中来回移动，在便笺簿上做笔记以确保一切正确。一旦我开始在IDE中打开DAG文件的多个视图，我知道这是一个停下来并找到一种方法将DAG分成更小的片段的好时机。</p><p id="f76d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着Airflow 2中<a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow/stable/concepts/dags.html?highlight=taskgroup#taskgroups" rel="noopener ugc nofollow" target="_blank"> TaskGroups </a>的出现，将一个大DAG分成几个部分在概念上和实践上都更容易了。这些部分可以重用，当然，它们更容易更新和维护。</p><p id="7ed9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">TaskGroups只是相关任务的UI分组，但是分组往往是逻辑的。任务组中的任务可以被捆绑和抽象，以便更容易地从比单个任务更大的单元构建DAG。也就是说，任务组并不是将任务分组并将其移出DAG文件的唯一方式。你也可以有一个不在任务组中的逻辑任务块。后一种方法的缺点是，您失去了在DAG运行的web UI图形视图中将任务折叠到单个节点中的好处。</p><p id="f7e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">分解DAG的技巧是将DAG放在一个文件中，例如<code class="fe lw lx ly lz b">modularized_dag.py</code>，将任务或任务组的逻辑块放在单独的文件中，每个文件一个逻辑任务块或任务组。每个文件都包含函数，每个函数都返回一个operator实例或一个TaskGroup实例。</p><p id="75c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了快速说明，下面的<code class="fe lw lx ly lz b">modularized_dag.py</code>从<code class="fe lw lx ly lz b">foo_bar_tasks.py</code>引入了返回操作符的函数，从<code class="fe lw lx ly lz b">xyzzy_taskgroup.py</code>引入了返回任务组的函数。在DAG上下文中，调用这些函数时将DAG对象<code class="fe lw lx ly lz b">dag</code>作为参数传递，它们的返回值被分配给task或TaskGroup变量，这些变量可以被分配上下游依赖关系。</p><h1 id="294b" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">实运算符的简单示例</h1><p id="40c5" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">现在举一个真实的例子。让我们使用虚拟操作符和Python操作符来创建任务。</p><p id="e957" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先是DAG文件:<code class="fe lw lx ly lz b">dags/modularized_dag.py</code>。它只是从<code class="fe lw lx ly lz b">plugins/includes/foo_bar_tasks.py</code>导入分块任务函数，从<code class="fe lw lx ly lz b">plugins/includes/xyzzy_taskgroup.py</code>导入任务组函数。它将使用DAG上下文创建的DAG传递给每个函数。</p><p id="c047" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">dags/modularized_dag.py</code>:</p><pre class="kj kk kl km gt mx lz my mz aw na bi"><span id="5039" class="nb mb it lz b gy nc nd l ne nf">from datetime import datetime, timedelta</span><span id="1e7c" class="nb mb it lz b gy ng nd l ne nf">from airflow import DAG<br/>from includes.foo_bar_tasks import build_foo_task, build_bar_task<br/>from includes.xyzzy_taskgroup import build_xyzzy_taskgroup</span><span id="4c48" class="nb mb it lz b gy ng nd l ne nf"><br/>default_args = {<br/>    'owner': 'airflow',<br/>    'depends_on_past': False,<br/>    'email_on_retry': False,<br/>    'retries': 1,<br/>    'retry_delay': timedelta(minutes=5),<br/>}</span><span id="5b1e" class="nb mb it lz b gy ng nd l ne nf">with DAG(<br/>    dag_id="modularized_dag",<br/>    schedule_interval="<a class="ae ky" href="http://twitter.com/once" rel="noopener ugc nofollow" target="_blank">@once</a>",<br/>    start_date=datetime(2021, 1, 1),<br/>    default_args=default_args,<br/>) as dag:</span><span id="249a" class="nb mb it lz b gy ng nd l ne nf">    # logical chunk of tasks<br/>    foo_task = build_foo_task(dag=dag)<br/>    bar_task = build_bar_task(dag=dag)</span><span id="ea23" class="nb mb it lz b gy ng nd l ne nf">    # taskgroup<br/>    xyzzy_taskgroup = build_xyzzy_taskgroup(dag=dag)</span><span id="0f88" class="nb mb it lz b gy ng nd l ne nf">    foo_task &gt;&gt; bar_task &gt;&gt; xyzzy_taskgroup</span></pre><p id="0ac1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来是<code class="fe lw lx ly lz b">plugins/includes/foo_bar_tasks.py</code>中逻辑分块的任务功能。我们的逻辑块中有几个函数，<code class="fe lw lx ly lz b">build_foo_task</code>和<code class="fe lw lx ly lz b">build_bar_task</code>。第一个返回伪运算符，第二个返回Python运算符。Python操作符使用一个简单的导入日志记录函数<code class="fe lw lx ly lz b">log_info</code>，它在下面的<code class="fe lw lx ly lz b">plugins/includes/log_info.py</code>中定义。</p><p id="f154" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">plugins/includes/foo_bar_tasks.py</code>:</p><pre class="kj kk kl km gt mx lz my mz aw na bi"><span id="2540" class="nb mb it lz b gy nc nd l ne nf">from airflow import DAG<br/>from airflow.operators.dummy import DummyOperator<br/>from airflow.operators.python import PythonOperator</span><span id="8b65" class="nb mb it lz b gy ng nd l ne nf">from includes.log_info import log_info<br/></span><span id="965a" class="nb mb it lz b gy ng nd l ne nf">def build_foo_task(dag: DAG) -&gt; DummyOperator:<br/>    foo_task = DummyOperator(task_id="foo_task", dag=dag)</span><span id="9bef" class="nb mb it lz b gy ng nd l ne nf">    return foo_task</span><span id="d435" class="nb mb it lz b gy ng nd l ne nf"><br/>def build_bar_task(dag: DAG) -&gt; PythonOperator:<br/>    bar_task = PythonOperator(<br/>        task_id="bar_task",<br/>        python_callable=log_info,<br/>        dag=dag,<br/>    )</span><span id="109a" class="nb mb it lz b gy ng nd l ne nf">    return bar_task</span></pre><p id="9656" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在逻辑块任务函数之后，我们在<code class="fe lw lx ly lz b">plugins/includes/xyzzy_taskgroup.py</code>中有一个TaskGroup函数。这个任务组包括一对任务，<code class="fe lw lx ly lz b">baz_task</code>用伪操作符实现，而<code class="fe lw lx ly lz b">qux_task</code>用Python操作符实现。像上面的chunked tasks文件一样，这个文件也导入了日志功能<code class="fe lw lx ly lz b">log_info</code>。</p><p id="3526" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">plugins/includes/xyzzy_taskgroup.py</code>:</p><pre class="kj kk kl km gt mx lz my mz aw na bi"><span id="5e0e" class="nb mb it lz b gy nc nd l ne nf">from airflow import DAG<br/>from airflow.operators.dummy import DummyOperator<br/>from airflow.operators.python import PythonOperator<br/>from airflow.utils.task_group import TaskGroup</span><span id="68a5" class="nb mb it lz b gy ng nd l ne nf">from includes.log_info import log_info</span><span id="e297" class="nb mb it lz b gy ng nd l ne nf"><br/>def build_xyzzy_taskgroup(dag: DAG) -&gt; TaskGroup:<br/>    xyzzy_taskgroup = TaskGroup(group_id="xyzzy_taskgroup")</span><span id="7740" class="nb mb it lz b gy ng nd l ne nf">    baz_task = DummyOperator(<br/>        task_id="baz_task",<br/>        task_group=xyzzy_taskgroup,<br/>        dag=dag,<br/>    )</span><span id="446d" class="nb mb it lz b gy ng nd l ne nf">    qux_task = PythonOperator(<br/>        task_id="qux_task",<br/>        task_group=xyzzy_taskgroup,<br/>        python_callable=log_info,<br/>        dag=dag,<br/>    )</span><span id="59e0" class="nb mb it lz b gy ng nd l ne nf">    baz_task &gt;&gt; qux_task</span><span id="f1a4" class="nb mb it lz b gy ng nd l ne nf">    return xyzzy_taskgroup</span></pre><p id="960b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，这里是由<code class="fe lw lx ly lz b">foo_bar_tasks.py</code>和<code class="fe lw lx ly lz b">xyzzy_taskgroup.py</code>导入的简单日志功能。</p><p id="33ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">plugins/includes/log_info.py</code>:</p><pre class="kj kk kl km gt mx lz my mz aw na bi"><span id="9b7f" class="nb mb it lz b gy nc nd l ne nf">import logging</span><span id="4bce" class="nb mb it lz b gy ng nd l ne nf"><br/>def log_info(**kwargs):<br/>    logging.info(kwargs)</span></pre><p id="bb61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦所有这些文件都准备好了，您就可以使用您的Airflow web UI来解包DAG并确保它正常工作。下面是<code class="fe lw lx ly lz b">modularized_dag.py</code>的图形视图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/b245af731403f4b785c72acce1ae07db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dlKpcNlaflBxGOByUzvHbQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模块化的DAG非常好用！(作者供图)</p></figure><p id="fd3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以检查Python操作符任务的日志(第一个来自逻辑分块的任务，第二个来自xyzzy_taskgroup内部):</p><p id="f61d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">bar_task</code>用<code class="fe lw lx ly lz b">log_info</code>功能输出高亮灰色:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/4b59b763559e42c4406eca91c4e92581.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*duhuL0ugg3q2dIO3gYxNng.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">从酒吧登录任务(作者提供照片)</p></figure><p id="7b6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">xyzzy_taskgroup.qux_task</code>用<code class="fe lw lx ly lz b">log_info</code>功能输出高亮灰色:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/9655204604954c2c7db12b6e2e0f2381.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wbc_IumP5kLHGh93BjpCzw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">xyzzy TaskGroup中qux任务的日志(作者提供图片)</p></figure><h1 id="b303" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">概观</h1><p id="1a3d" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">我们已经介绍了如何通过将任务组或操作符返回函数放在独立的文件中，将一个大的DAG文件分解成模块化的块，现在模块化的DAG将从<code class="fe lw lx ly lz b">plugins/includes</code>目录导入这些文件。使用TaskGroup-returning函数的优势在于:( 1)您可以将逻辑任务组抽象成DAG中的一个组件，以及(2)task group中包含的任务将在DAG运行的web UI图形视图中折叠成单个节点。</p></div></div>    
</body>
</html>