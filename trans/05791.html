<html>
<head>
<title>Automating Text Extraction and Data Preprocessing using AWS Textract, Lambda &amp; DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Textract，Lambda &amp; DynamoDB自动进行文本提取和数据预处理</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automating-text-extraction-and-data-preprocessing-using-aws-textract-lambda-dynamodb-e3de318d9122?source=collection_archive---------7-----------------------#2021-05-24">https://towardsdatascience.com/automating-text-extraction-and-data-preprocessing-using-aws-textract-lambda-dynamodb-e3de318d9122?source=collection_archive---------7-----------------------#2021-05-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b4a7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">自动化是关键。任何时候，只要有一项耗时或手动的任务可以轻松地自动化，您就应该这样做。</h2></div><p id="2721" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">数据科学家工作最重要的部分之一是自动化流程，这可以减轻耗时任务的负担，让您有时间处理更重要的事情。在本教程中，我们将介绍一个用于自动化文档文本提取的端到端AWS解决方案。我们将原始的和非结构化的文档组织起来进行解析。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/f9e74f25d1c67184bd1223a6c9292f84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J8KMBVLMufcCO7wNkNV-tw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">自动文本提取过程的流程图。图片作者。</p></figure><h2 id="9801" class="lu lv it bd lw lx ly dn lz ma mb dp mc kr md me mf kv mg mh mi kz mj mk ml mm bi translated"><strong class="ak">目录:</strong></h2><ol class=""><li id="1c16" class="mn mo it kk b kl mp ko mq kr mr kv ms kz mt ld mu mv mw mx bi translated"><strong class="kk iu">创建两个S3桶</strong></li><li id="a1ab" class="mn mo it kk b kl my ko mz kr na kv nb kz nc ld mu mv mw mx bi translated"><strong class="kk iu">创建一个Textract Lambda函数&amp; IAM角色</strong></li><li id="fe7f" class="mn mo it kk b kl my ko mz kr na kv nb kz nc ld mu mv mw mx bi translated"><strong class="kk iu">创建一个DynamoDB表</strong></li><li id="cb07" class="mn mo it kk b kl my ko mz kr na kv nb kz nc ld mu mv mw mx bi translated"><strong class="kk iu">创建一个DynamoDB Lambda函数&amp; IAM角色</strong></li><li id="54d9" class="mn mo it kk b kl my ko mz kr na kv nb kz nc ld mu mv mw mx bi translated"><strong class="kk iu">结论</strong></li></ol><h2 id="219e" class="lu lv it bd lw lx ly dn lz ma mb dp mc kr md me mf kv mg mh mi kz mj mk ml mm bi translated">1-创建两个S3存储桶:</h2><p id="e9b4" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">您需要创建两个S3存储桶，一个作为输入存储桶，另一个作为输出存储桶。您可以很容易地将这两者合并到一个桶中，但是，递归对于类似这样的lambda过程可能是有问题的——因此，在本教程中，我们将使用两个桶的解决方案。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ng"><img src="../Images/470e47872efdbd5f3860a1a2a7778e0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5G31cKtNZSaK9KoqoB19nw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="dcdf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当您创建此项目所需的资源时，请确保指定的区域保持不变。如果您为S3时段选择“us-east-2 ”,则所有其它资源也需要这样做。导航到S3控制台并单击“创建存储桶”,创建一个新的存储桶。您可以将这个存储桶命名为您想要的任何名称，但是，建议您坚持特定的命名约定——在我们的例子中，它将是“s3-json-input-bucket”。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nh"><img src="../Images/bcbddc3ada689064133b4f89f55ac198.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_f-6pL_nZkMfGMD9NWJ5Ow.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="1411" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦完成，您应该看到您的两个S3桶列在S3 AWS控制台下。</p><h2 id="2e7a" class="lu lv it bd lw lx ly dn lz ma mb dp mc kr md me mf kv mg mh mi kz mj mk ml mm bi translated">2-创建Textract Lambda函数和IAM角色:</h2><p id="6816" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">有了S3桶，让我们继续创建我们的Lambda函数。在AWS中导航到Lambda控制台，然后单击“创建函数”。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ni"><img src="../Images/ca4bbbf81314c610db8d5e0b77bcd7a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wk7s4YHcO6A4DxK9JJDmSg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="933d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择“使用蓝图”选项，搜索“蓝图名称:s3-get-object-python”。单击“配置”,以便我们可以编辑一些设置。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nj"><img src="../Images/7972c4f60155c1e257a8ffb0ed58b448.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BJJePiAF9W-ZCowQ1N_AgQ.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="8d07" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">继续输入一个函数名。最佳实践是根据lambda函数的用途来标记它。在这种情况下，我们将调用函数“textract-s3-to-json-function”。接下来，为名为“textract-s3-to-json-role”的函数创建一个新角色。命名的一致性有助于您在单独工作时记住每个资源的用途，或者有助于其他人在团队工作时轻松完成项目。在页面底部，选择感兴趣的特定S3存储桶——在我们的示例中，这将是我们之前创建的s3-json-input-bucket”。我们将使用此输入区作为新pdf的“放置区”。一旦文件被放入，lambda函数将被触发以触发Textract脚本。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nk"><img src="../Images/f2490d3f1dc3f0326bb0d408a1834d4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kvuBog9K0avcAKgR-6QhYg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="f121" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以通过前缀(即仅查看特定目录中的文件)或后缀(即仅查看以.结尾的文件)来限制将应用此功能的文件。pdf)。这些是可选参数，如果需要，可以在以后添加。接下来，点击“创建函数”。</p><p id="149d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将使用Boto——AWS官方python SDK——将该功能连接到我们的其他AWS资源。为了让这个SDK在我们的Lambda函数中工作，我们需要将它作为一个层上传。在屏幕的左侧，从菜单中选择“创建图层”。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/fa5d14725238f0ffbb1906ffd43b3d65.png" data-original-src="https://miro.medium.com/v2/resize:fit:852/format:webp/1*BAFajQsFuaMi-o0cQm834Q.png"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nm"><img src="../Images/2120e6a2c3b172c531d787c5a60e5bb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wj1U8cMnF2VvYea4aohsTg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="73d3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过上传一个可以从我的<a class="ae nn" href="https://github.com/alkhalifas/automated-aws-textract-dynamodb-using-lambda/blob/main/boto3-layer.zip" rel="noopener ugc nofollow" target="_blank"> Github </a>中获取的zip文件来创建一个层。这将允许该函数使用Boto。上传后，点击“创建”。导航回lambda函数，在屏幕底部，点击“添加层”。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi no"><img src="../Images/d40a0d61234e9bc2d6f51095695a49d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*yu1o_kDCpf7K6qjws-KKsw.png"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nm"><img src="../Images/c101bfa6252cd9ae8f27dbb09557b20e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AnjmPr6z6KPRIuayuQeBCg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="84df" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在代码部分，继续用我的<a class="ae nn" href="https://github.com/alkhalifas/automated-aws-textract-dynamodb-using-lambda/blob/main/s3_pdf_to_json_function.py" rel="noopener ugc nofollow" target="_blank"> GitHub文件</a>中的代码替换代码。这个代码片段将在第一个S3桶中接收任何传入的文档，通过AWS textract运行它们，然后将它们写回到第二个S3桶中。注意，这个Github文件中有两个字段需要替换:</p><ul class=""><li id="8a1a" class="mn mo it kk b kl km ko kp kr np kv nq kz nr ld ns mv mw mx bi translated"><strong class="kk iu"> ARN的角色(见于第27行)。</strong></li><li id="8cac" class="mn mo it kk b kl my ko mz kr na kv nb kz nc ld ns mv mw mx bi translated"><strong class="kk iu">输出桶名(第111行)。</strong></li></ul><p id="0130" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以用在第一步中选择的存储桶名称替换输出存储桶名称。但是，ARN角色需要替换为写在IAM控制台角色页面顶部的ARN角色。这将确保该功能可以使用与角色相关联的适当权限。</p><p id="eedd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一些pdf文件需要比其他文件更长的分析时间。为了确保pdf不会在处理过程中超时，您需要延长超时限制。文档越大，分析时间就越长——该设置高度依赖于提交的文档。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nt"><img src="../Images/26d1c95e8fa2079daff16e44d5c66da7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RItb0Kk9bQkkCyiDsztJhw.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="bac6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成功能设置后，我们现在可以编辑角色，以确保配置了所有必要的权限。在AWS中导航到IAM控制台，搜索我们之前创建的名为“textract-s3-to-json-role”的角色。</p><p id="213d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">ARN角色将在本页顶部注明，这与您之前配置Python代码时需要的ARN角色相同。</p><p id="fc76" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">导航到权限部分，添加我们将需要的其他资源:</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi nu"><img src="../Images/f471945595c7f8c9f732b5738d77cb58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*269ymdbFoQdvrTQR3dqbkQ.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="6f26" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">除了已经指定的两个，我们将需要“AmazonS3FullAccess”和“AmazonDynamoDBFullAccess”。继续并附加那些策略。</p><p id="8228" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下一个名为“信任关系”的选项卡上，确保关系如下:</p><pre class="lf lg lh li gt nv nw nx ny aw nz bi"><span id="9993" class="lu lv it nw b gy oa ob l oc od">{<br/> “Version”: “2012–10–17”,<br/> “Statement”: [<br/> {<br/> “Effect”: “Allow”,<br/> “Principal”: {<br/> “Service”: “lambda.amazonaws.com”<br/> },<br/> “Action”: “sts:AssumeRole”<br/> }<br/> ]<br/>}</span></pre><p id="4c10" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">完成这两个步骤后，您现在可以将pdf文件放入“输入”桶，这将自动提取文件的文本并将它们作为JSON上传到“输出”桶。很漂亮吧？</p><h2 id="f0b6" class="lu lv it bd lw lx ly dn lz ma mb dp mc kr md me mf kv mg mh mi kz mj mk ml mm bi translated">3-创建一个DynamoDB表</h2><p id="e65b" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">完成textract部分后，现在让我们把注意力集中在设置表上。在AWS中导航DynamoDB控制台，并单击“创建表”。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/fda050a41eaa735662397b05ffc026eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*7-wVcJpMMWaGa4xCoJH97A.png"/></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="5cb0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">输入表名和主键。在我们的例子中，我们称主键为“id”。但是，您可以根据自己的需要，使用数据中的任何其他唯一ID来重命名该字段。继续并点击屏幕底部的“创建”。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi of"><img src="../Images/7aa85fcfb0cc5571595512e95670663c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2hnKEPU2PsPgU2FpXLWysg.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">图片是来自AWS的屏幕截图。</p></figure><p id="0c8c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建完成后，您应该会在屏幕右侧看到填充的表格。</p><h2 id="7613" class="lu lv it bd lw lx ly dn lz ma mb dp mc kr md me mf kv mg mh mi kz mj mk ml mm bi translated">4-创建DynamoDB Lambda函数和IAM角色:</h2><p id="afd5" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">与前面的Lambda函数类似，继续重复创建函数、添加boto层和更改相关角色的权限的相同过程。请注意，这个函数和另一个函数之间会有一些细微的差别:</p><ol class=""><li id="3585" class="mn mo it kk b kl km ko kp kr np kv nq kz nr ld mu mv mw mx bi translated">确保相关的触发器指向输出桶。记住，这里的想法是第一个函数的输出将是第二个函数的输入。</li><li id="b35a" class="mn mo it kk b kl my ko mz kr na kv nb kz nc ld mu mv mw mx bi translated">确保与该函数相关的代码不会重新运行textract，而只是获取JSON输出并通过DynamoDB运行它。从下面复制代码片段，或者从我的<a class="ae nn" href="https://github.com/alkhalifas/automated-aws-textract-dynamodb-using-lambda/blob/main/json_to_dynamodb_function.py" rel="noopener ugc nofollow" target="_blank"> GitHub文件</a>复制。</li></ol><pre class="lf lg lh li gt nv nw nx ny aw nz bi"><span id="e947" class="lu lv it nw b gy oa ob l oc od">import json<br/>import boto3<br/>import os<br/>import urllib.parse<br/>import json<br/>import uuid<br/>from decimal import Decimal</span><span id="a582" class="lu lv it nw b gy og ob l oc od">s3_client = boto3.client(‘s3’)<br/>dynamodb = boto3.resource(‘dynamodb’)</span><span id="b47d" class="lu lv it nw b gy og ob l oc od">def lambda_handler(event, context): <br/>    print(“Starting Transfer:”)<br/>    bucket = event[‘Records’][0][‘s3’][‘bucket’][‘name’]<br/>    json_file_name = urllib.parse.unquote_plus(event[‘Records’][0][‘s3’][‘object’][‘key’], encoding=’utf-8')<br/>    json_object = s3_client.get_object(Bucket = bucket, Key = json_file_name)<br/>    jsonFileReader = json_object[‘Body’].read()<br/>    jsonDict = json.loads(jsonFileReader, parse_float=Decimal)<br/>    table = dynamodb.Table(‘s3-json-textract-table’) <br/>    finalObject = jsonDict[0]<br/>    finalObject[“key”] = json_file_name<br/>    finalObject[‘id’] = str(uuid.uuid4())<br/>    table.put_item(Item = jsonDict[0])</span></pre><p id="25b1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">3.最后，确保该函数的IAM角色包括DynamoDB的权限和S3完全访问权限。您可以通过导航到IAM控制台，搜索角色名称，并在权限部分下添加DynamoDB和S3来添加这些角色。</p><h2 id="85ff" class="lu lv it bd lw lx ly dn lz ma mb dp mc kr md me mf kv mg mh mi kz mj mk ml mm bi translated"><strong class="ak"> 5 —结论</strong></h2><p id="f9e2" class="pw-post-body-paragraph ki kj it kk b kl mp ju kn ko mq jx kq kr nd kt ku kv ne kx ky kz nf lb lc ld im bi translated">至此，您应该已经准备好了！当您使用PDF文件填充输入S3存储桶时，这将触发第一个lambda函数对您的文件应用Textract OCR，并将JSON格式的输出发送到输出存储桶。一旦进入输出桶，第二个lambda函数将被触发，并将新创建的JSON文件传输到DynamoDB。虽然本教程主要面向PDF文件，但Textract也能够处理图像。来吧，自己试试这个！</p></div></div>    
</body>
</html>