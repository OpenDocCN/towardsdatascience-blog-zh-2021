<html>
<head>
<title>DAG Factories — A better way to Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DAG工厂——更好的通风方式</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/dag-factories-a-better-way-to-airflow-9aa3cf003169?source=collection_archive---------16-----------------------#2021-05-02">https://towardsdatascience.com/dag-factories-a-better-way-to-airflow-9aa3cf003169?source=collection_archive---------16-----------------------#2021-05-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="f457" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">气流编年史</h2><div class=""/><div class=""><h2 id="6aed" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">使用动态生成的Dag来缩放气流</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/ce6ed693774718345a8b07b74943598a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_0fnm8V2LpQeZMpS3pJ-iw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">信用:由我们自己的团队建立</p></figure><p id="b7d3" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi md translated"><span class="l me mf mg bm mh mi mj mk ml di">如果</span>你一直在寻找一个工作流管理平台，我猜你已经遇到了<a class="ae mm" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Airflow </a>。这个被广泛使用的项目最初来自Airbnb，现在打着Apache的旗号，是许多数据团队的首选工具。Airflow允许您以声明的方式编写复杂的工作流，并提供许多开箱即用的操作员来完成复杂的任务。</p><p id="05be" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在<a class="ae mm" href="https://flywheelsoftware.com?utm_source=article&amp;utm_medium=medium&amp;utm_campaign=tameem" rel="noopener ugc nofollow" target="_blank">飞轮软件</a>，我们大量使用气流进行复杂的ETL管道、机器学习管道和统计分析。此外，我们还管理多个气流部署，并运行运行大量工作负载的大型多租户气流集群。随着我们开始将气流推向极限，我们最近对如何部署到气流集群进行了改造，我敢说找到了更好的利用气流的方法。</p><p id="d567" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们的主要目标是摆脱部署airflow的声明式格式，更多地转向动态生成Dag以实现灵活性和可扩展性——允许我们只需修改一个功能标志，就可以快速更改airflow上运行的内容。这导致了DAG工厂的出现。</p><blockquote class="mn mo mp"><p id="e825" class="lh li mq lj b lk ll kd lm ln lo kg lp mr lr ls lt ms lv lw lx mt lz ma mb mc im bi translated">DAG工厂—使用工厂模式和python类，根据系统的动态输入自动生成DAG。</p></blockquote><p id="20c5" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">背景故事讲够了，是时候进入激动人心的部分了。为了做好准备，在本文中，我们将假设我们想要在airflow中执行两个复杂的任务——process _ message &amp; process _ invoices。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="2ad3" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">图片前</h1><p id="6048" class="pw-post-body-paragraph lh li it lj b lk nt kd lm ln nu kg lp lq nv ls lt lu nw lw lx ly nx ma mb mc im bi translated">在我们开始新的设置之前，重要的是快速了解一下在气流中通常是如何实现的。一种可能的方法是为你的每个项目准备一个单独的文件夹。您可以在每个项目文件夹中复制Dag，或者将所有共享Dag放在一个<strong class="lj jd">shared _ Dag</strong>文件夹中。然后，您的部署管道可以从monorepo中选择正确的Dag，将其推送到每个气流集群。实际上，文件结构可能类似于下面的代码片段。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="5a24" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">随着您的项目开始增长，DAGS和部署过程的复杂性将会迅速增加。在多租户集群中，您需要为气流多次复制相同的DAG，以便为每个租户单独考虑它们。</p><h1 id="75a5" class="nb nc it bd nd ne oa ng nh ni ob nk nl ki oc kj nn kl od km np ko oe kp nr ns bi translated">后图— DAG工厂</h1><p id="ef5b" class="pw-post-body-paragraph lh li it lj b lk nt kd lm ln nu kg lp lq nv ls lt lu nw lw lx ly nx ma mb mc im bi translated">现在，有了DAG工厂，您可以获得一个更好的组织结构，它可以整合跨项目或租户的重复代码。通过将代码抽象成负责生成DAG对象的python类，我们使设置更加可配置。最棒的是，看起来玛丽·近藤对我们的monorepo进行了一次扫描，删除了所有不能引发欢乐的东西。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="5b69" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><strong class="lj jd">快速组件故障</strong> 🕺🏽</p><ul class=""><li id="e244" class="of og it lj b lk ll ln lo lq oh lu oi ly oj mc ok ol om on bi translated"><strong class="lj jd">项目/ &lt;名称&gt; /config.py — </strong>从气流变量或集中配置存储中获取配置的文件</li><li id="4375" class="of og it lj b lk oo ln op lq oq lu or ly os mc ok ol om on bi translated"><strong class="lj jd">项目/ &lt;名称&gt; /main.py — </strong>核心文件，我们将在其中调用工厂方法来生成我们想要为项目运行的Dag</li><li id="603e" class="of og it lj b lk oo ln op lq oq lu or ly os mc ok ol om on bi translated"><strong class="lj jd"> dag_factory — </strong>文件夹，其中包含我们工厂模式中的所有dag，以及一组标准化方法的格式。</li></ul><h2 id="b6ec" class="ot nc it bd nd ou ov dn nh ow ox dp nl lq oy oz nn lu pa pb np ly pc pd nr iz bi translated">动态配置</h2><p id="99a9" class="pw-post-body-paragraph lh li it lj b lk nt kd lm ln nu kg lp lq nv ls lt lu nw lw lx ly nx ma mb mc im bi translated">这种架构的第一步是让我们的气流集群与我们平台上的集中式配置存储进行对话。这允许airflow从平台上的其他服务中动态获取配置，比如我们的web应用、特性标志或其他业务逻辑。我们不会深究商店本身，但这通常是通过使用<a class="ae mm" href="https://etcd.io/" rel="noopener ugc nofollow" target="_blank"> Etcd </a>、<a class="ae mm" href="https://www.consul.io/" rel="noopener ugc nofollow" target="_blank">consult</a>等工具，或者构建自己的瘦配置API来完成的。</p><p id="4d41" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在气流端，与配置存储的通信发生在<strong class="lj jd"> config.py </strong>文件中。我们可以很容易地获取气流变量或使用配置存储的API获取配置。随着这些值的变化，气流将自动重新获取并重新生成Dag。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="6f93" class="ot nc it bd nd ou ov dn nh ow ox dp nl lq oy oz nn lu pa pb np ly pc pd nr iz bi translated">工厂</h2><p id="72e7" class="pw-post-body-paragraph lh li it lj b lk nt kd lm ln nu kg lp lq nv ls lt lu nw lw lx ly nx ma mb mc im bi translated">移动到核心部分，我们所有的繁重工作都在<strong class="lj jd"> dag_factory </strong>文件夹中完成。<strong class="lj jd"> DAGFactory() </strong>类负责在工厂中映射我们支持的Dag，并基于提供的键动态调用正确的模块。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ny nz l"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">dag_factory.py</p></figure><p id="fa35" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">正如您在上面的要点中所看到的，<strong class="lj jd"> create() </strong>函数只是返回一个正确映射的dag构建器类，可以像这样轻松地调用它:</p><pre class="ks kt ku kv gt pe pf pg ph aw pi bi"><span id="0d8d" class="ot nc it pf b gy pj pk l pl pm">factory = DAGFactory(config.environment)<br/>factory.create('ProcessMessages', config.process_messages)</span></pre><p id="11b4" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">为我们的<strong class="lj jd"> process_invoices </strong>和<strong class="lj jd"> process_messages </strong>任务生成Dag的python类遵循特定的格式，以便从DAGFactory触发。每个文件都有以下标准化结构:</p><ul class=""><li id="2634" class="of og it lj b lk ll ln lo lq oh lu oi ly oj mc ok ol om on bi translated"><strong class="lj jd"> init() </strong> —设置全局&amp; dag特定配置参数。</li><li id="a03a" class="of og it lj b lk oo ln op lq oq lu or ly os mc ok ol om on bi translated"><strong class="lj jd"> build() — </strong>构建并返回实际的DAG对象及其下的所有任务。这是定义任务实际功能的地方。</li></ul><p id="6f71" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">作为一个例子，在这个片段中，我们看一下<strong class="lj jd"> process_messages </strong>工厂。它定义了两个任务，使用<strong class="lj jd"> KubernetesPodOperators </strong>来获取和处理消息。这个DAG现在可以通过我们的factory <strong class="lj jd"> create() </strong>方法用不同的变量多次调用——为我们提供同一个DAG的动态变化。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="b1f1" class="ot nc it bd nd ou ov dn nh ow ox dp nl lq oy oz nn lu pa pb np ly pc pd nr iz bi translated">把所有的放在一起</h2><p id="d812" class="pw-post-body-paragraph lh li it lj b lk nt kd lm ln nu kg lp lq nv ls lt lu nw lw lx ly nx ma mb mc im bi translated">一切最终都汇集在<code class="fe pn po pp pf b"><strong class="lj jd">projects/&lt;project_name&gt;/main.py</strong></code>文件中——剩下要做的就是调用我们工厂上的build方法，并在父对象下重新配置那些返回的DAG对象。在这个例子中，我们可以看到调用工厂方法来生成DAG对象是多么容易。然后，我们只需使用可靠的子DAG操作器将它们添加到主DAG中。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ny nz l"/></div><p class="ld le gj gh gi lf lg bd b be z dk translated">打电话给DAG工厂</p></figure><p id="a1a8" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">一旦一切就绪，该设置还允许我们运行具有多租户DAG工作负载的单个集群。让我们假设我们的配置存储返回<code class="fe pn po pp pf b">client_config</code>,这是多个客户端的配置数组。我们可以简单地遍历我们的客户端配置，并调用我们的工厂为每个客户端构建多个Dag的变体，如下一个片段所示。🤯</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ny nz l"/></div></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="b28d" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">底线</h1><p id="5ea8" class="pw-post-body-paragraph lh li it lj b lk nt kd lm ln nu kg lp lq nv ls lt lu nw lw lx ly nx ma mb mc im bi translated">就像任何其他工具一样，一旦你开始扩大规模，就必须停下来，重新思考如何改进或优化。我们需要一种更加动态和配置驱动的方法来处理气流，这使我们建立了dag工厂，希望这将有助于使用气流的更广泛的社区。对于我们来说，我们的气流集群可以自动构建Dag来监听配置变化，从而支持我们扩展多租户气流集群。</p><h1 id="e485" class="nb nc it bd nd ne oa ng nh ni ob nk nl ki oc kj nn kl od km np ko oe kp nr ns bi translated">喜欢谈论技术或数据？</h1><p id="671d" class="pw-post-body-paragraph lh li it lj b lk nt kd lm ln nu kg lp lq nv ls lt lu nw lw lx ly nx ma mb mc im bi translated">你很幸运，我也是！如果你想聊聊前沿技术、企业家精神或创业的风险，可以在推特(Twitter)或LinkedIn上找到我。</p></div></div>    
</body>
</html>