<html>
<head>
<title>Visualize the Crowdedness of Dutch Trains with Open Data and Kepler</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用开放数据和开普勒可视化荷兰火车的拥挤</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/visualization-of-crowdedness-for-dutch-trains-with-kepler-f55057a3ba24?source=collection_archive---------17-----------------------#2021-04-15">https://towardsdatascience.com/visualization-of-crowdedness-for-dutch-trains-with-kepler-f55057a3ba24?source=collection_archive---------17-----------------------#2021-04-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bf79" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">荷兰公共交通提供的公开数据使人们有可能看到一天中的拥挤情况。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3c5cbad264f86254ca35a5e46556de19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B-fNxomWyq9xY5EWPBbvIQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">列车占用的开普勒可视化</p></figure><p id="8f9f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">荷兰公共交通的最大发展之一是公共可用数据的持续增长。时间表已经推出好几年了，包括实时更新和几个月前增加的拥挤信息。所有这些开放数据使得开发者为大众和利基市场开发应用成为可能。在这篇文章中，我将向你展示如何在荷兰创造一个拥挤的火车美景。</p><p id="1f4f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">本产品使用的数据来源为<a class="ae lr" href="http://gtfs.ovapi.nl/nl/" rel="noopener ugc nofollow" target="_blank"> OVInfo </a>时间表信息和<a class="ae lr" href="https://ndovloket.nl/" rel="noopener ugc nofollow" target="_blank"> N </a> DOV拥挤信息。时间表有<a class="ae lr" href="https://gtfs.org/" rel="noopener ugc nofollow" target="_blank"> GTFS格式</a>和专用格式(CSV)的拥挤度。可视化是用<a class="ae lr" href="https://kepler.gl" rel="noopener ugc nofollow" target="_blank">开普勒</a>制作的，基于<a class="ae lr" href="https://geojson.org/" rel="noopener ugc nofollow" target="_blank"> GeoJSON </a>文件。</p><p id="0f67" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">创建这个可视化的原因是我在阅读了由<a class="ae lr" href="https://medium.com/swlh/visualizing-istanbul-bus-traffic-with-python-and-keplergl-a84895788825" rel="noopener">奥赞·卡拉</a>和<a class="ae lr" rel="noopener" target="_blank" href="/visualizing-bus-trajectories-in-denver-85ff02f3a746">阿卜杜拉·库尔库</a>撰写的关于可视化伊斯坦布尔公交和丹弗公交的文章后感受到的灵感。他们在数据工程和可视化方面做了一些出色的工作。</p><p id="d88a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这篇文章的完整代码可以在<a class="ae lr" href="https://github.com/lmeulen/GTFS-Visuals" rel="noopener ugc nofollow" target="_blank"> github </a>上找到。</p><p id="cf2f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将从GTFS规范中指定的时间表开始。也可以使用来自GTFS馈送的已实现时刻表信息，但是现在我们将使用计划时刻表，因为可用的拥挤信息是预测。</p><p id="ecd8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">可视化拥挤时间表所需的数据结构如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/b3cd8a4ed44aba8e28221b50b0e672f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*zkTj5Xc9zJ8_jVEZnvUnFQ.png"/></div></figure><p id="6aae" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这包含以下列:</p><ul class=""><li id="0bc2" class="lt lu iq kx b ky kz lb lc le lv li lw lm lx lq ly lz ma mb bi translated">时间戳— Unix时间戳，记录旅程中的每一分钟(到达第一站和离开最后一站之间的时间)</li><li id="b68a" class="lt lu iq kx b ky mc lb md le me li mf lm mg lq ly lz ma mb bi translated">rit number-trip number，指定从GTFS出发的行程</li><li id="d37f" class="lt lu iq kx b ky mc lb md le me li mf lm mg lq ly lz ma mb bi translated">序列—行程由几个部分组成。路段是行程中两个连续停靠站之间的部分，或者是在一个停靠站停留的时间。</li><li id="3512" class="lt lu iq kx b ky mc lb md le me li mf lm mg lq ly lz ma mb bi translated">lat，lon —在时间<em class="mh">时间戳</em>时，列车完成行程<em class="mh"> ritnumber </em>的位置</li><li id="b56d" class="lt lu iq kx b ky mc lb md le me li mf lm mg lq ly lz ma mb bi translated">分类——列车在最后一站发车时的拥挤分类。是一个介于1和5之间的值。</li><li id="2768" class="lt lu iq kx b ky mc lb md le me li mf lm mg lq ly lz ma mb bi translated">乘客——列车乘客数量的粗略估计</li></ul><p id="b3d5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有了这个数据集，我们能够创建一天中所有火车的动画，其中两个车站之间的拥挤程度可以用来给火车位置着色。</p><p id="cb36" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">获取数据</strong></p><p id="f995" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">第一步是导入所需的库(<em class="mh">熊猫</em>、<em class="mh"> numpy </em>和<em class="mh"> geojson </em>是最重要的非标准库)并设置一些参数。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="5a60" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后我们从NDOV导入拥挤度信息。这些数据以压缩的CSV文件的形式提供。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="8c72" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果文件还没有下载，我们下载压缩的CSV文件。使用<em class="mh"> Panda数据帧</em>的CSV阅读器导入文件。在重命名一些列后，对列车座位数进行了估计。维基百科是寻找火车车厢座位容量的一个很好的来源。由于有不同的亚型，我们可以粗略估计每辆客车的平均座位数。NDOV数据指定了车厢类型和车厢数量，因此我们可以估计列车中的座位总数。</p><p id="f62e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">导入GTFS数据需要更多的工作。首先，如果GTFS文件不存在，我们就下载它(它的大小超过200MB，所以防止不必要的下载可以节省时间和带宽)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="7e59" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，我们从下载的zip文件中一个接一个地导入GTFS文件，并在operator上过滤它们。GTFS文件包含荷兰公共交通所有模式和运营商的时间表。在列车运行人员身上进行过滤大大减少了数据量。在本例中，我们仅使用来自NS的数据，该数据运营该国的大部分列车，但也可以通过更换机构来过滤所有列车运营商或一个地区或城市的运输提供商。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="7126" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从代理处开始，一步一步地，所有东西都是为指定的操作者过滤的数据。首先是代理机构，然后是指定代理机构的路线、这些路线的行程以及这些行程的停留时间。请注意，GTFS的车站是现实生活中的站台，停车区代表车站。到达和离开时间从<em class="mh"> hh:mm </em>转换为自午夜起的分钟数，因此在路上使用更容易。</p><p id="33d5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">数据处理</strong></p><p id="e6ef" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">真正重要的下一步是确定一天中所有行程的火车位置，从到达第一站到离开最后一站。行程的路线被指定为一个GTFS形状，该形状由一系列纬度坐标和从第一站开始的行驶距离组成。以下函数根据行驶距离在两个LatLon位置之间插入位置。在找到前一/最后一站(<em class="mh"> ps </em>和下一站(<em class="mh"> ns </em>)后，我们可以使用简单的直线插值，因为不需要高精度并且距离相对较短。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="d8b8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">参数tripshape是GTFS形状文件中指定旅行路线的点集，而<em class="mh">距离</em>是沿着tripshape行进的距离。找到指定距离的周围两个纬度位置后，根据距离在这两个纬度位置之间进行插值(见下图)。两个台阶之间的行进速度在这里是恒定的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mk"><img src="../Images/300c3ad1580bd40a026df4474f7148e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BbkGcd4yvIHTZc9TtF0yMA.png"/></div></div></figure><p id="f036" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下函数对一天中一次行程的每一分钟的位置进行插值:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ml"><img src="../Images/838f71d14181a014eced421e2f6df81a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OXlamHRnblF1pP4feJ7t8g.png"/></div></div></figure><p id="e611" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在确定这个行程的停靠点之后(<em class="mh"> tripstops </em>)，我们迭代所有这些停靠点并执行两个动作。首先，对从最后一个停车点出发到到达该停车点之间的所有分钟进行插值。然后创建列车位于停车位置的所有分钟。这些由停止位置的到达和离开时间决定。每组插值点被分配给一个序列供以后使用。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="d23b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该函数返回一个数据帧，其中包含该行程每分钟的停靠位置，包括列车最后一次停靠位置的信息。然后，通过迭代我们可视化的当天的所有行程，可以直接获得包含所有行程信息的数据帧:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="16a9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当我们通过将该数据帧与NDOV数据合并来添加所有拥挤信息时，我们就有了一天中所有列车位置的数据集以及拥挤信息:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="b9b1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">乘客数量是根据座位数量和分类来估算的。这也是对乘客数量的一个非常粗略的估计，但是根据现有的数据，不可能得到更好的指示。geoJSON文件需要一个UNIX时间戳，因此需要对其进行计算并添加高程列，因为geoJSON文件需要该列。</p><p id="206c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">数据导出和可视化</strong></p><p id="ec29" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">创建的数据集包含简介中描述的所有信息(以及更多)。有了这个数据集，我们就可以创建GeoJSON文件供开普勒使用。为了显示点跟随路径的动画，开普勒需要以下GeoJSON结构:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5cc1d7046f109771ca0b294d4da12e6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LK4HXeHO9ZPgfT6XV_EPnQ.png"/></div></div></figure><p id="cba6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="mh">线串</em>的坐标包含4个元素<em class="mh">【经度、纬度、海拔、时间戳】</em>。特征的数字属性可用于给形状着色。由于拥挤仅在停止位置发生变化，因此会为两个站点之间的每条路径创建一个要素。这些路径由上一步中添加的序列号指定。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="8e68" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">通过迭代所有行程和行程中的所有序列，构建要素的总位置，这些要素作为要素集合存储在GEOJSON文件中。</p><p id="5941" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了提高地图的可用性，还在网络布局中创建了GeoJSON。只需将每条路线的一个行程添加到GeoJSON文件中，即可创建此布局。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="9ad0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，是开普勒进行可视化的时候了。导航到开普勒网站，并按下开始。在下一页拖放两个创建的文件，开普勒将准备适当的层。一个静态层是网络布局，另一个是火车动画。</p><p id="7767" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">通过调整线宽和颜色，可以很好地展示一天中的列车运行情况。我们在白天看到所有的火车，包括早高峰的爆发。列车根据预计乘客数量进行着色:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3c5cbad264f86254ca35a5e46556de19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B-fNxomWyq9xY5EWPBbvIQ.png"/></div></div></figure><p id="8575" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="https://github.com/lmeulen/GTFS-Visuals/blob/cae374f19469352c1bf60aad2f35e6491df3225f/video_trim3.mp4" rel="noopener ugc nofollow" target="_blank">链接到Github上制作的视频</a>，展示了NS火车旅行的一天。</p><p id="3575" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">最终想法</strong></p><p id="60de" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">给出的代码没有针对速度进行优化。在普通机器上运行它需要30分钟，因此改进是受欢迎的，但对于本演示来说，这不是必需的。</p><p id="3bcf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">开普勒是一个非常强大的可视化地理空间数据的工具，包括随时间推移的动画。添加越来越多的公开可用数据，通过令人惊叹的图表和动画打开了公共交通领域奇妙见解的大门。我希望这个例子能激发你对公共交通产生新的视觉化和洞察力。</p><p id="2d79" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="mh">免责声明:本文包含的观点和看法仅归作者所有。</em></p></div></div>    
</body>
</html>