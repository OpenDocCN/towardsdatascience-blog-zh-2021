<html>
<head>
<title>Stop detection in Blue Whales GPS tracking — Movingpandas 0.6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">蓝鲸GPS追踪中的停止检测—移动熊猫0.6</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/stop-detection-in-blue-whales-gps-tracking-movingpandas-0-6-55a4b893a592?source=collection_archive---------33-----------------------#2021-05-25">https://towardsdatascience.com/stop-detection-in-blue-whales-gps-tracking-movingpandas-0-6-55a4b893a592?source=collection_archive---------33-----------------------#2021-05-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2936" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何用KeplerGL中的海洋巨型动物GPS轨迹创建地图动画</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4844836f9bf203c4eb9455abe868ca83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*-FVmYDMN-VN7gxlkzDHZCQ.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者提供。GPS轨迹的地图动画。</p></figure><p id="ad6c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们又来了移动熊猫。由<a class="ae lu" href="https://anitagraser.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu"> Anita Graser </strong> </a>开发的python库是分析运动数据的有力工具。在后期的帖子里，我发表了<a class="ae lu" rel="noopener" target="_blank" href="/stop-detection-in-gps-tracks-movingpandas-keplergl-point-map-with-stops-duration-in-bird-664064b3ccbc">如何创建<em class="lv">地图动画</em>以及如何用鸟类迁徙数据</a> (GPS追踪)提取<em class="lv">停靠点</em>作为点。Movingpandas 0.6新版本中的<strong class="la iu"> <em class="lv">停靠点检测算法</em> </strong>直接将停靠点作为点返回，这绝对是我想要包含在带有移动数据的工作流中的，因为它大大简化了编码。尤其是带着一个<code class="fe lw lx ly lz b">TrajectoryCollection</code>。</p><p id="d396" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于本教程/工作流，我使用GPS数据在南加州跟踪蓝鲸，以创建一个<a class="ae lu" href="https://bryanvallejo16.github.io/stop-detection-whale-tracking/" rel="noopener ugc nofollow" target="_blank">地图动画与停止的持续时间</a>。收集数据集是为了研究海洋巨型动物的深潜行为对定位误差的影响。为了更好地理解，您可以查看Irvin等人(2020)在动物生物遥测学上发表的<a class="ae lu" href="https://animalbiotelemetry.biomedcentral.com/articles/10.1186/s40317-020-00207-x" rel="noopener ugc nofollow" target="_blank">论文，并在Movebank中查看</a><a class="ae lu" href="https://www.movebank.org/cms/webapp?gwt_fragment=page=studies,path=study943824007" rel="noopener ugc nofollow" target="_blank"> GPS数据集</a>的详细信息。</p><p id="07e5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个demo最后的地图动画是<a class="ae lu" href="https://bryanvallejo16.github.io/stop-detection-whale-tracking/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">这里！</strong> </a> <strong class="la iu"> <br/> </strong>按下播放，探索！<br/>此处储存有分析工作流<a class="ae lu" href="https://github.com/bryanvallejo16/stop-detection-whale-tracking" rel="noopener ugc nofollow" target="_blank">和<strong class="la iu">！</strong> </a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ma"><img src="../Images/23f3462fed1e4d9459c9d256df4f4d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AF7aJIHBr6fzGuSX7Xym2Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者提供。鲸鱼追踪，以分钟为单位的停止持续时间</p></figure><p id="2af0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">鲸鱼运动数据集包含了从2014年8月到2015年8月收集的<em class="lv">鲸豚</em>和<em class="lv">鲸豚</em>的13条鲸鱼轨迹。在这个演示练习中，我将只使用时间范围为2个月的5条轨迹:2015.07到2015.08 <em class="lv">。</em>请记住，在移动熊猫 中使用<strong class="la iu"> <em class="lv">停止检测算法时，您必须参照持续时间和搜索电台指定停止参数。在这种情况下，我将<strong class="la iu"> <em class="lv">指定为最小5分钟，并将搜索无线电指定为30米</em> </strong>。但是，您可以指定您认为适合您的研究的内容。如果你正在研究鲸鱼的进食行为，那么考虑一下它们在同一个地方一跳就能捕捉到食物。我决定在30米的搜索收音机上选择5分钟，因为这足以找到车站。我会考虑关于浮游植物的重叠信息，这样我们就能确认鲸鱼提供午餐的地点。</em></strong></p><p id="a177" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们把手放在。你可以在本帖  的<a class="ae lu" href="https://github.com/bryanvallejo16/stop-detection-whale-tracking" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu"> <em class="lv">库中查看材料，但这里的分析示例将分为三个部分进行说明:<br/> 1)将移动数据集格式化为移动熊猫。写一个函数，在移动熊猫0.6中返回停止点。<br/> 3)开普勒GL中的地图动画。</em></strong></a></p><p id="43a2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="lv"> 1)将运动数据集格式化为运动熊猫</em> </strong></p><p id="1276" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个过程是在Jupyter笔记本中完成的，所以首先，我们导入所有需要的库。请确保您使用的是移动熊猫0.6。</p><pre class="kj kk kl km gt mb lz mc md aw me bi"><span id="0e08" class="mf mg it lz b gy mh mi l mj mk">import pandas as pd<br/>import geopandas as gpd<br/>from datetime import datetime, timedelta<br/>from keplergl import KeplerGl</span><span id="34ee" class="mf mg it lz b gy ml mi l mj mk">import movingpandas as mpd<br/>print(mpd.__version__)</span><span id="bebd" class="mf mg it lz b gy ml mi l mj mk">import warnings<br/>warnings.simplefilter(“ignore”)</span></pre><p id="fb75" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们读取包含在地理数据框架<code class="fe lw lx ly lz b">df</code>的存储库中的鲸鱼运动数据集。在运行过程中，用我们在本演示中使用的5头鲸鱼(标签ID)对表进行分组。</p><pre class="kj kk kl km gt mb lz mc md aw me bi"><span id="e285" class="mf mg it lz b gy mh mi l mj mk"># opening file<br/>cd = r’data/whale-movement.geojson’<br/>file = open(cd)<br/>df= gpd.read_file(file)</span><span id="9532" class="mf mg it lz b gy ml mi l mj mk"># subset of 5 whales<br/>fiveset = ['2015CA-MK10-00838', '2015CA-MK10-00840', '2015CA-MK10-04177', '2015CA-MK10-05650', '2015CA-MK10-05654']<br/>df = df.loc[df['tag_ident'].isin(fiveset)]</span></pre><p id="f09c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了使移动数据集准备好用于移动熊猫，有必要将索引格式化为<em class="lv">日期时间格式。</em>接下来是<em class="lv"> : </em></p><pre class="kj kk kl km gt mb lz mc md aw me bi"><span id="4231" class="mf mg it lz b gy mh mi l mj mk"># preparing the data for movingpandas<br/>df[‘t’] = pd.to_datetime(df[‘timestamp’])<br/>df = df.set_index(‘t’).tz_localize(None)</span></pre><p id="dd7f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">至于建议。确保您的地理数据框架<code class="fe lw lx ly lz b">df</code>具有CRS <code class="fe lw lx ly lz b">WGS84</code>。目前，我们已经用<code class="fe lw lx ly lz b">DateTime index</code>和5只鲸鱼的子集格式化了表格。新子集的时间范围从2015年7月到2015年8月。现在我们打算用它来移动熊猫。</p><p id="90df" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="lv"> 2)在移动熊猫0.6 </em> </strong>中返回停止点的功能</p><p id="b906" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本节中，我将创建一个函数，该函数返回一个以停靠点为点的<strong class="la iu"> <em class="lv">地理数据框</em> </strong>，并包含一个以<strong class="la iu">分钟</strong>为单位的停靠持续时间列和另一个以鲸鱼的<strong class="la iu">标签id </strong>为单位的列。请注意，该函数使用以分钟为单位的参数。你可以在我最近的帖子中找到以小时为单位的<a class="ae lu" rel="noopener" target="_blank" href="/stop-detection-in-gps-tracks-movingpandas-keplergl-point-map-with-stops-duration-in-bird-664064b3ccbc">参数的例子，在</a><a class="ae lu" href="https://mybinder.org/v2/gh/anitagraser/movingpandas/master?filepath=tutorials/3-stop-detection.ipynb" rel="noopener ugc nofollow" target="_blank">安妮塔·格拉泽库</a>中找到以秒为单位的例子。停靠点代表轨迹的一段，而作为点的停靠点是该段轨迹的起点。</p><p id="a3b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该函数的参数有:<strong class="la iu"><em class="lv">moving _ df&lt;geodata frame&gt;</em></strong>，<strong class="la iu"><em class="lv">traject _ id _ column&lt;string&gt;</em></strong>，<strong class="la iu"><em class="lv">minutes&lt;number&gt;</em></strong>，<strong class="la iu"><em class="lv">search radio&lt;number&gt;</em></strong>。笔记本中对它们进行了解释，但这里只是简单地说明如下:</p><pre class="kj kk kl km gt mb lz mc md aw me bi"><span id="8d67" class="mf mg it lz b gy mh mi l mj mk">def get_stop_point_traj_collection(moving_df, traject_id_column, minutes, searchradio):<br/>       <br/>    all_stop_points = gpd.GeoDataFrame()<br/>    <br/>    # create a traj collection with movingpandas<br/>    traj_collection = mpd.TrajectoryCollection(moving_df, traject_id_column)<br/>    <br/>    for i in range(len(traj_collection)):</span><span id="06fa" class="mf mg it lz b gy ml mi l mj mk"># create a stop detector<br/>        detector = mpd.TrajectoryStopDetector(traj_collection.trajectories[i])<br/>        <br/>        # stop points<br/>        stop_points = detector.get_stop_points(min_duration=timedelta(minutes=minutes), max_diameter=searchradio)<br/>        <br/>        # add duration to table<br/>        stop_points['duration_m'] = (stop_points['end_time']-stop_points['start_time']).dt.total_seconds()/60<br/>        <br/>        # add ID<br/>        stop_points['tag_id'] = [tag.split('_')[0] for tag in stop_points.index.to_list()]<br/>        <br/>        all_stop_points= all_stop_points.append(stop_points)<br/>        <br/>    return all_stop_points</span></pre><p id="cc1f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们将它与带有GPS记录的地理数据框架<code class="fe lw lx ly lz b">df</code>一起使用，我们将鲸鱼的标签id包含在列<code class="fe lw lx ly lz b">tag_ident</code>中，将<code class="fe lw lx ly lz b">5</code>分钟用于停止检测，将<code class="fe lw lx ly lz b">30</code>米作为搜索无线电。</p><pre class="kj kk kl km gt mb lz mc md aw me bi"><span id="503c" class="mf mg it lz b gy mh mi l mj mk">%%time<br/>whale_stops = get_stop_point_traj_collection(df, ‘tag_ident’, 5, 30)</span></pre><p id="fd5e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您用行<code class="fe lw lx ly lz b">whale_stops.head()</code>检查最终表格<code class="fe lw lx ly lz b">whale_stops</code>，您将看到一个如下所示的漂亮表格:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mm"><img src="../Images/b511328ceae217541e455eccea868a15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZzEmX8dspfZCZaOhmuC82w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者提供。将鲸鱼停靠点作为移动熊猫分析的点的表</p></figure><p id="f77c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="lv"> 3)开普勒GL </em> </strong>中的地图动画</p><p id="31ff" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在KeplerGL中工作的第一步是避免列中的<strong class="la iu"> <em class="lv">日期时间格式</em> </strong>。我们将移除地理数据框中的<strong class="la iu"> <em class="lv">日期时间格式</em> </strong>以及所有GPS轨迹<code class="fe lw lx ly lz b">df</code>和地理数据框<code class="fe lw lx ly lz b">whale_stops</code>。使用下一个代码:</p><pre class="kj kk kl km gt mb lz mc md aw me bi"><span id="006b" class="mf mg it lz b gy mh mi l mj mk"># remove datetime format for GPS tracks<br/>df = df.reset_index(drop=True)<br/></span><span id="9cb8" class="mf mg it lz b gy ml mi l mj mk"># remove datetime format for whale stops<br/>whale_stops[[‘start_time’, ‘end_time’]] = whale_stops[[‘start_time’, ‘end_time’]].astype(str)<br/>whale_stops= whale_stops.reset_index(drop=True)</span></pre><p id="176a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们创建一个KeplerGL实例，并添加两个地理数据框:<code class="fe lw lx ly lz b">df</code>和<code class="fe lw lx ly lz b">whale_stops</code>，代码如下:</p><pre class="kj kk kl km gt mb lz mc md aw me bi"><span id="1258" class="mf mg it lz b gy mh mi l mj mk"># Create KeplerGl instance<br/>m = KeplerGl(height=600)</span><span id="f93a" class="mf mg it lz b gy ml mi l mj mk"># Add stop durations<br/>m.add_data(whale_stops, ‘stops’)</span><span id="79ac" class="mf mg it lz b gy ml mi l mj mk"># Add gps records<br/>m.add_data(df, ‘trajectories’)</span></pre><p id="c065" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在你可以通过<a class="ae lu" href="https://kepler.gl/" rel="noopener ugc nofollow" target="_blank"> KeplerGL </a>调用实例来格式化贴图动画。</p><pre class="kj kk kl km gt mb lz mc md aw me bi"><span id="3edb" class="mf mg it lz b gy mh mi l mj mk">m</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/7ece316a7086206713f6b6f8e8a66294.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v22CpSb64xujsuZzXkYL6A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者提供。在KeplerGL中格式化地图动画</p></figure><p id="03af" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以观察到鲸鱼是如何偏好停在海峡群岛国家海洋保护区附近的。也许附近有个喂食的好地方。</p><p id="d5e0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，保存用下一行格式化的地图:</p><pre class="kj kk kl km gt mb lz mc md aw me bi"><span id="f8ed" class="mf mg it lz b gy mh mi l mj mk"># Save map as html<br/>m.save_to_html(file_name=’index.html’)</span></pre><p id="353a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这就是全部！现在你可以<a class="ae lu" href="https://bryanvallejo16.github.io/stop-detection-whale-tracking/" rel="noopener ugc nofollow" target="_blank">可视化你的鲸鱼GPS轨迹的移动</a>。<br/>本教程/帖子主要关注移动熊猫0.6的使用和停止检测算法。如果您有任何问题，请随时通过<a class="ae lu" href="https://www.linkedin.com/in/bryanrvallejo/" rel="noopener ugc nofollow" target="_blank">联系我，我在LinkedIn上的个人资料</a>。</p></div></div>    
</body>
</html>