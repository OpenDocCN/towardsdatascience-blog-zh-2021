<html>
<head>
<title>3 Steps to Build and Deploy your NLP model as a Microservice on Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Azure 上构建和部署 NLP 模型作为微服务的 3 个步骤</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/3-steps-to-build-and-deploy-your-nlp-model-as-a-microservice-on-azure-426ca77c66df?source=collection_archive---------25-----------------------#2021-12-29">https://towardsdatascience.com/3-steps-to-build-and-deploy-your-nlp-model-as-a-microservice-on-azure-426ca77c66df?source=collection_archive---------25-----------------------#2021-12-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fd8b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在 Azure 上部署 ML 模型最简单最便宜的方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/dee6d3616a1e15842c665b246653f564.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MoeMmaBg0itaLTcI"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">布鲁斯·马斯在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="2af8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在花费无数时间训练您的模型之后，您现在需要使它可用于其他应用程序或服务。</p><p id="72a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据您部署到云的方式，这个过程可能需要几个小时或几分钟。更重要的是，您的部署选择应该基于您的可伸缩性和预算需求。</p><p id="7c90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我将展示一种直接使用 Python 代码(而不是构建容器)将 NLP 模型作为微服务部署到 Azure 的快速方法。</p><blockquote class="lv lw lx"><p id="9b29" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">本教程适用于任何 ML 模型，而不仅仅是 NLP。</p></blockquote><p id="e3ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将展示的设置可能是现有的最简单的设置之一，并且维护这些设置的<strong class="lb iu">成本最小</strong>。</p><p id="039c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开始之前，请确保做好以下准备:</p><ol class=""><li id="3bbe" class="mc md it lb b lc ld lf lg li me lm mf lq mg lu mh mi mj mk bi translated"><strong class="lb iu">创建一个有效订阅的 Azure 帐户</strong>:如果你还没有一个有效订阅的帐户，你可以为 Azure 创建一个新帐户，并获得两周的试用期。</li><li id="9bc2" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu mh mi mj mk bi translated"><strong class="lb iu">安装 Azure CLI </strong>:我们将使用<em class="ly">命令</em>在 Azure 上创建资源(而不是使用 Azure Portal UI)。这种方法具有最强的可维护性，因为我们为自己创建的每个资源都编写了脚本，这使得进化和复制变得更加容易。<a class="ae ky" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank">点击此处</a>查看如何安装 Azure CLI。</li><li id="1939" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu mh mi mj mk bi translated"><strong class="lb iu">安装 Azure Functions 核心工具</strong>:在将我们的微服务部署到 Azure 之前，我们将<strong class="lb iu">在本地创建和测试一切，而不花一分钱</strong>。Azure Functions 核心工具将为设计、开发、测试、运行和调试 Azure 功能提供本地开发体验。<a class="ae ky" href="https://github.com/Azure/azure-functions-core-tools" rel="noopener ugc nofollow" target="_blank">点击此处</a>查看如何安装。</li></ol><p id="da9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面我们将经历以下三个步骤:</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="9f18" class="mv mw it mr b gy mx my l mz na">1. Create and test an Azure function locally<br/>2. Create the resources on Azure<br/>3. Deploy the function to Azure</span></pre></div><div class="ab cl nb nc hx nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="im in io ip iq"><h1 id="a5c1" class="ni mw it bd nj nk nl nm nn no np nq nr jz ns ka nt kc nu kd nv kf nw kg nx ny bi translated">1.在本地创建并测试 Azure 函数</h1><p id="ddc2" class="pw-post-body-paragraph kz la it lb b lc nz ju le lf oa jx lh li ob lk ll lm oc lo lp lq od ls lt lu im bi translated">理想情况下，我们希望在部署到 Azure 之前在本地测试所有东西。本地测试让我们确保一切正常，不会花不必要的钱在线调试。尽管如此，使用 Azure 上的“应用洞察”等监控工具仍然是值得的，也是必要的，以确保你的应用程序平稳运行。但是这超出了本文的范围。</p><p id="4402" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面，首先，我们使用终端创建并激活 python 环境。然后我们在本地创建一个 FunctionApp 项目，将多个函数组织在一起。最后，我们创建由 HTTP 请求触发的函数<code class="fe oe of og mr b">getSentiment</code>。</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="cadd" class="mv mw it mr b gy mx my l mz na"><em class="ly"># Create and activate an environment</em><br/>python3 -m venv .venv<br/>source .venv/bin/activate</span><span id="19b3" class="mv mw it mr b gy oh my l mz na"><em class="ly"># Create a FunctionApp Project Locally</em><br/>func init --worker-runtime python</span><span id="eff3" class="mv mw it mr b gy oh my l mz na"><em class="ly"># Create a Function</em><br/>func new --name getSentiment --template "HTTP trigger" --authlevel anonymous</span></pre><p id="ec48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以编辑文件<code class="fe oe of og mr b">getSentiment\__init__.py</code>中的函数，添加以下代码(针对您的型号进行修改):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="30e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面创建的函数将接收一个<code class="fe oe of og mr b">text</code>参数，并返回从拥抱脸的模型“<a class="ae ky" href="https://huggingface.co/distilbert-base-uncased-finetuned-sst-2-english" rel="noopener ugc nofollow" target="_blank">DistilBERT base uncase fine tuned SST-2</a>”获得的相应情感分析的输入文本。</p><p id="9bd7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于我们已经为上面的代码添加了几个库，请确保按如下方式更新您的<code class="fe oe of og mr b">requirements.txt</code>文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="9fd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，在我们上面创建的环境中安装库:</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="2931" class="mv mw it mr b gy mx my l mz na">pip install -r requirements.txt</span></pre><p id="d21f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经准备好在本地测试这个功能了。为此，您需要运行:</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="1c31" class="mv mw it mr b gy mx my l mz na">func start</span></pre><p id="8d6d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该在终端中得到类似这样的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/f95c11f23a02eebe3e4f0963f7844831.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/format:webp/1*U8N0cyTaYLwEmVpxJqk_Ig.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">“func start”命令的输出示例。图片由作者提供。</p></figure><p id="dbcd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我们可以访问上面列出的 URL，传递参数<code class="fe oe of og mr b">text</code>来测试模型。例如:</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="24e5" class="mv mw it mr b gy mx my l mz na"><a class="ae ky" href="http://localhost:7071/api/getSentiment" rel="noopener ugc nofollow" target="_blank">http://localhost:7071/api/getSentiment</a>?text=I%20really%20like%20bananas</span></pre><p id="a3bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输出应该是:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/3e50617cbef09ecc3dc142d776c88ed1.png" data-original-src="https://miro.medium.com/v2/resize:fit:646/format:webp/1*1hF30ZKLlfEZMDN-n9PsRA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">本地函数的输出示例。图片由作者提供。</p></figure><p id="d18d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在一切都按预期在本地运行，我们可以在 Azure 上创建所需的资源并部署我们的微服务。</p></div><div class="ab cl nb nc hx nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="im in io ip iq"><h1 id="44d1" class="ni mw it bd nj nk nl nm nn no np nq nr jz ns ka nt kc nu kd nv kf nw kg nx ny bi translated">2.在 Azure 上创建资源</h1><p id="3e12" class="pw-post-body-paragraph kz la it lb b lc nz ju le lf oa jx lh li ob lk ll lm oc lo lp lq od ls lt lu im bi translated">您可以通过 Azure 门户点击每个资源并选择设置来完成以下步骤。但这很难维持。所以，一般来说，建议使用脚本。</p><p id="448f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，下面，我们在终端中运行几个命令来创建以下资源，这是在 Azure 上部署功能所需的最少资源:</p><ul class=""><li id="5226" class="mc md it lb b lc ld lf lg li me lm mf lq mg lu om mi mj mk bi translated"><strong class="lb iu">资源组</strong>:资源组只是为 Azure 解决方案保存多个相关资源的一种方式。</li><li id="0f0a" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu om mi mj mk bi translated">存储帐户:Azure 存储帐户集中了数据对象，比如 blobs、文件共享、队列、表和磁盘。它为存储提供了一个独特的命名空间。我们将使用标准类型(最便宜的)，主要推荐用于文件、blobs 和表。</li><li id="bb84" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu om mi mj mk bi translated"><strong class="lb iu">function app</strong>:function app 是一种资源，它将各种功能组合成一个逻辑单元，便于管理、部署、扩展和资源共享。我们将使用最基本的消费计划来托管功能 app，并指定创建的存储帐户。</li></ul><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="6a91" class="mv mw it mr b gy mx my l mz na"><em class="ly"># Login to your Azure Account from the Command Line</em><br/>az login</span><span id="7923" class="mv mw it mr b gy oh my l mz na"><em class="ly"># Create a Resource Group</em><br/>az group create --name rgSENT --location westus</span><span id="8cfc" class="mv mw it mr b gy oh my l mz na"><em class="ly"># Create a Storage Account</em><br/>az storage account create --name stracc2sent --location westus --resource-group rgSENT --sku Standard_LRS</span><span id="6cd4" class="mv mw it mr b gy oh my l mz na"><em class="ly"># Create a FunctionApp</em><br/>az functionapp create --name <strong class="mr iu">nlpfuncsa</strong> --resource-group rgSENT --os-type linux --consumption-plan-location westus --storage-account stracc2sent --functions-version 3 --runtime python --runtime-version 3.9</span></pre><p id="183c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我使用了<code class="fe oe of og mr b"><strong class="lb iu">nlpfuncsa</strong></code>作为 FunctionApp 的名称。此名称在 Azure 上必须是唯一的，因此请为你的应用使用不同的名称。如果上面的命令返回<code class="fe oe of og mr b">Operation returned an invalid status ‘Conflict’</code>，这可能就是原因。<strong class="lb iu">所以请确保为您的 FunctionApp <strong class="lb iu">使用不同的(且唯一的)名称</strong>。</strong></p></div><div class="ab cl nb nc hx nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="im in io ip iq"><h1 id="0675" class="ni mw it bd nj nk nl nm nn no np nq nr jz ns ka nt kc nu kd nv kf nw kg nx ny bi translated">3.将功能部署到 Azure</h1><p id="a5f9" class="pw-post-body-paragraph kz la it lb b lc nz ju le lf oa jx lh li ob lk ll lm oc lo lp lq od ls lt lu im bi translated">最后，我们可以使用以下命令将本地项目的代码部署到在 Azure 上创建的 FunctionApp:</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="945d" class="mv mw it mr b gy mx my l mz na">func azure functionapp publish <strong class="mr iu">nlpfuncsa</strong></span></pre><p id="78bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于距离较远，此过程需要一段时间。最终，您应该会得到以下结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/db51a6a8b2f78486dae9d26b0383328d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*LcOii_J2xYjS9YCj5EYsOQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将功能部署到 Azure 后的输出示例。图片由作者提供。</p></figure><p id="c15e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你可以访问上面列出的 URL，传递参数<code class="fe oe of og mr b">text</code>来测试你的模型。例如:</p><pre class="kj kk kl km gt mq mr ms mt aw mu bi"><span id="2b12" class="mv mw it mr b gy mx my l mz na"><a class="ae ky" href="https://nlpfuncsa.azurewebsites.net/api/getsentiment" rel="noopener ugc nofollow" target="_blank">https://nlpfuncsa.azurewebsites.net/api/getsentiment</a>?text=I%20really%20like%20bananas</span></pre><p id="7364" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输出应该与我们在本地看到的一样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/3e50617cbef09ecc3dc142d776c88ed1.png" data-original-src="https://miro.medium.com/v2/resize:fit:646/format:webp/1*1hF30ZKLlfEZMDN-n9PsRA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">已经部署在 Azure 上的函数的输出示例。图片由作者提供。</p></figure></div><div class="ab cl nb nc hx nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="im in io ip iq"><p id="9351" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样。现在您已经将 NLP 模型部署到 Azure 上了。这里是<a class="ae ky" href="https://github.com/ricardocarvalhods/azure-app-nlp" rel="noopener ugc nofollow" target="_blank"> Github 仓库</a>，所有代码都提交给 Azure。</p><p id="9f2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想<strong class="lb iu">删除你创建的所有东西</strong>，去 Azure 门户，找到“资源组”，点击创建的资源组(如果你完全按照这个帖子，应该是“rgSENT”)，然后点击“删除资源组”。由于所有创建的资源都在同一个资源组下，执行上述操作将删除所有内容。</p></div><div class="ab cl nb nc hx nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="im in io ip iq"><p id="57bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你喜欢阅读这样的故事，并想支持我成为一名作家，可以考虑<a class="ae ky" href="https://medium.com/@ricardocarvalhods/membership" rel="noopener">注册成为一名媒体会员</a>。每月 5 美元，你可以无限制地阅读媒体上的故事。如果你用我的链接注册，我会赚一点佣金。</p></div></div>    
</body>
</html>