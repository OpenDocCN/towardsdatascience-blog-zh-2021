<html>
<head>
<title>Prefect: How to Write and Schedule Your First ETL Pipeline with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">提督:如何用Python编写和调度你的第一个ETL管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/prefect-how-to-write-and-schedule-your-first-etl-pipeline-with-python-54005a34f10b?source=collection_archive---------2-----------------------#2021-07-22">https://towardsdatascience.com/prefect-how-to-write-and-schedule-your-first-etl-pipeline-with-python-54005a34f10b?source=collection_archive---------2-----------------------#2021-07-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="bf93" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="7031" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">工作流管理系统变得简单——在本地和云中</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/f7a1df4f750f38a5c78e7116bce42b5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AXaygvO4A5DHF4N8fmkFgQ.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">照片由<a class="ae lh" href="https://www.pexels.com/@wildlittlethingsphoto?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> <strong class="bd li">海伦娜从<a class="ae lh" href="https://www.pexels.com/photo/young-man-writing-reminder-on-fridge-and-drinking-coffee-at-home-3867001/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> <strong class="bd li">洛佩斯</strong> </a>删节</strong></a></p></figure><p id="e5bc" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">Prefect是一个基于Python的工作流管理系统，它基于一个简单的前提<em class="mf">——您的代码可能会工作，但有时会不工作</em> ( <a class="ae lh" href="https://docs.prefect.io/core/" rel="noopener ugc nofollow" target="_blank">来源</a>)。当一切都按预期运行时，没有人会考虑工作流系统。但是当事情变糟时，提督会保证你的代码成功失败。</p><p id="8e02" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">作为一个工作流管理系统，Prefect可以轻松地将日志记录、重试、动态映射、缓存、失败通知等添加到您的数据管道中。当你不需要它时，它是看不见的——当一切都按预期运行时，当你需要它时，它是看得见的。类似保险的东西。</p><p id="68c2" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">虽然Prefect不是Python用户唯一可用的工作流管理系统，但它无疑是最熟练的一个。诸如Apache Airflow这样的替代方案通常工作得很好，但是在处理大型项目时会带来很多令人头疼的问题。你可以在这里阅读Prefect和Airflow <a class="ae lh" href="https://docs.prefect.io/core/getting_started/why-not-airflow.html#overview" rel="noopener ugc nofollow" target="_blank">的详细对比。</a></p><p id="4d28" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">本文涵盖了库的基础知识，比如任务、流、参数、失败和时间表，还解释了如何在本地和云中设置环境。我们将使用<a class="ae lh" href="https://www.saturncloud.io/s/?utm_source=dario-radecic" rel="noopener ugc nofollow" target="_blank">土星云</a>作为那部分，因为它使配置毫不费力。它是一个由数据科学家制作的云平台，因此大部分繁重的工作都是为您完成的。</p><p id="a279" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">土星云可以毫不费力地处理完美的工作流程。它也是从仪表板到分布式机器学习、深度学习和GPU培训的前沿解决方案。</p><p id="c502" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">今天，您将学习如何:</p><ul class=""><li id="e78f" class="mg mh it ll b lm ln lp lq ls mi lw mj ma mk me ml mm mn mo bi translated">在本地安装提督</li><li id="e59e" class="mg mh it ll b lm mp lp mq ls mr lw ms ma mt me ml mm mn mo bi translated">用Python写一个简单的ETL管道</li><li id="520d" class="mg mh it ll b lm mp lp mq ls mr lw ms ma mt me ml mm mn mo bi translated">使用提督来声明任务、流程、参数、时间表和处理故障</li><li id="fcb2" class="mg mh it ll b lm mp lp mq ls mr lw ms ma mt me ml mm mn mo bi translated">在土星云中跑完全程</li></ul></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="08ad" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">如何在本地安装提督</h1><p id="fcb8" class="pw-post-body-paragraph lj lk it ll b lm nt kd lo lp nu kg lr ls nv lu lv lw nw ly lz ma nx mc md me im bi translated">我们将在虚拟环境中安装完美的库。基于Python 3.8，以下命令将通过Anaconda创建并激活名为<code class="fe ny nz oa ob b">prefect_env</code>的环境:</p><pre class="ks kt ku kv gt oc ob od oe aw of bi"><span id="3d8b" class="og nc it ob b gy oh oi l oj ok">conda create — name prefect_env python=3.8<br/>conda activate prefect_env</span></pre><p id="32b6" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">您必须输入几次<code class="fe ny nz oa ob b">y</code>来指示Anaconda继续，但是每个安装都是如此。就库而言，我们将需要<em class="mf"> Pandas </em>进行数据操作，<em class="mf">请求</em>下载数据，当然还有<em class="mf">perfect</em>进行工作流管理:</p><pre class="ks kt ku kv gt oc ob od oe aw of bi"><span id="fded" class="og nc it ob b gy oh oi l oj ok">conda install requests pandas<br/>conda install -c conda-forge prefect</span></pre><p id="1fab" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">我们现在已经具备了开始编写Python代码所需的一切。让我们接下来做那件事。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="ade1" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">用Python编写ETL管道</h1><p id="29bd" class="pw-post-body-paragraph lj lk it ll b lm nt kd lo lp nu kg lr ls nv lu lv lw nw ly lz ma nx mc md me im bi translated">今天我们将使用Prefect来完成一个相对简单的任务——运行ETL管道。这个管道将从一个伪API下载数据，对其进行转换，并将其保存为CSV格式。JSON占位符网站将作为我们的虚拟API。其中，它包含了十个用户的虚假数据:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ol"><img src="../Images/47f89ad13c358e3a87541b9794ac9e12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2fMpQa3w0Y4n7AUXRXFULA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片1——伪造的用户数据(来源:</em><a class="ae lh" href="https://jsonplaceholder.typicode.com/users)" rel="noopener ugc nofollow" target="_blank">【https://jsonplaceholder.typicode.com/users T21】)</a><em class="om">(图片作者)</em></p></figure><p id="b59b" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">让我们从创建一个Python文件开始——我已经将我的文件命名为<code class="fe ny nz oa ob b">01_etl_pipeline.py</code>。此外，确保有一个文件夹，用于保存提取和转换的数据。我称之为<code class="fe ny nz oa ob b">data</code>，它位于Python脚本所在的位置。</p><p id="dcaa" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">任何ETL管道都需要实现三个功能——提取、转换和加载数据。在我们的例子中，这些函数的作用如下:</p><ul class=""><li id="ac71" class="mg mh it ll b lm ln lp lq ls mi lw mj ma mk me ml mm mn mo bi translated"><code class="fe ny nz oa ob b">extract(url: str) -&gt; dict</code> —向<code class="fe ny nz oa ob b">url</code>参数发出获取请求。测试以查看是否返回了一些数据—在这种情况下，它作为字典返回。否则，将引发异常。</li><li id="f0c6" class="mg mh it ll b lm mp lp mq ls mr lw ms ma mt me ml mm mn mo bi translated"><code class="fe ny nz oa ob b">transform(data: dict) -&gt; pd.DataFrame </code> —转换数据，以便只保留特定的属性:ID、姓名、用户名、电子邮件、地址、电话号码和公司。以熊猫数据帧的形式返回转换后的数据。</li><li id="2710" class="mg mh it ll b lm mp lp mq ls mr lw ms ma mt me ml mm mn mo bi translated"><code class="fe ny nz oa ob b">load(data: pd.DataFrame, path: str) -&gt; None</code> —在<code class="fe ny nz oa ob b">path</code>将之前转换的<code class="fe ny nz oa ob b">data</code>保存为CSV文件。我们还将在文件名后附加一个时间戳，这样文件就不会被覆盖。</li></ul><p id="a809" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">在函数声明之后，当执行Python脚本时，这三个函数都会被调用。以下是完整的代码片段:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="4359" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">现在，您可以通过从终端执行以下命令来运行该脚本:</p><pre class="ks kt ku kv gt oc ob od oe aw of bi"><span id="adfb" class="og nc it ob b gy oh oi l oj ok">python 01_etl_pipeline.py</span></pre><p id="9e4a" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">如果一切运行正常，您应该看不到任何输出。但是，您应该在<code class="fe ny nz oa ob b">data</code>文件夹中看到CSV文件(我已经运行了该文件两次):</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi op"><img src="../Images/53407cdda38668fcdd608f96ca5a722a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tUU7ziVYnWlOS07Jrn0CPg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图2 —运行两次ETL管道后，数据文件夹中的CSV文件列表(图片由作者提供)</em></p></figure><p id="ec94" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">正如您所看到的，ETL管道运行并完成，没有任何错误。但是，如果您想按计划运行管道，该怎么办呢？这就是提督的用武之地。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="741e" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">探索提督的基础</h1><p id="66d3" class="pw-post-body-paragraph lj lk it ll b lm nt kd lo lp nu kg lr ls nv lu lv lw nw ly lz ma nx mc md me im bi translated">在这一部分中，您将学习<em class="mf">perfect</em>任务、流程、参数、时间表等更多的基础知识。</p><h2 id="5549" class="og nc it bd nd oq or dn nh os ot dp nl ls ou ov nn lw ow ox np ma oy oz nr iz bi translated">完美的任务</h2><p id="4584" class="pw-post-body-paragraph lj lk it ll b lm nt kd lo lp nu kg lr ls nv lu lv lw nw ly lz ma nx mc md me im bi translated">让我们从最简单的开始——任务。这基本上是你工作流程中的一个步骤。接下来，创建一个名为<code class="fe ny nz oa ob b">02_task_conversion.py</code>的新Python文件。从<code class="fe ny nz oa ob b">01_etl_pipeline.py</code>复制一切，你就可以开始了。</p><p id="ada1" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">要将Python函数转换成完美的任务，首先需要进行必要的导入— <code class="fe ny nz oa ob b">from prefect import task</code>，并修饰任何感兴趣的函数。这里有一个例子:</p><pre class="ks kt ku kv gt oc ob od oe aw of bi"><span id="993f" class="og nc it ob b gy oh oi l oj ok">@task<br/>def my_function():<br/>    pass</span></pre><p id="3a02" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">这就是你要做的！下面是我们ETL管道的更新版本:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="56db" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">让我们运行它，看看会发生什么:</p><pre class="ks kt ku kv gt oc ob od oe aw of bi"><span id="dcd5" class="og nc it ob b gy oh oi l oj ok">python 02_task_conversion.py</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pa"><img src="../Images/c95abee386613f6d7c3251a39bc3e6a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rIgkIxv2ioVaWVZ20pZChQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图3 —用提督将功能转换为任务(图片由作者提供)</em></p></figure><p id="096b" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">看起来好像有什么不对劲。那是因为<em class="mf">提督任务</em>离不开<em class="mf">提督流程。</em>接下来就来实现吧。</p><h2 id="0b26" class="og nc it bd nd oq or dn nh os ot dp nl ls ou ov nn lw ow ox np ma oy oz nr iz bi translated">完美流程</h2><p id="2d98" class="pw-post-body-paragraph lj lk it ll b lm nt kd lo lp nu kg lr ls nv lu lv lw nw ly lz ma nx mc md me im bi translated">将<code class="fe ny nz oa ob b">02_task_conversion.py</code>中的所有内容复制到一个新文件——<code class="fe ny nz oa ob b">03_flow.py</code>。在声明之前，您需要从<code class="fe ny nz oa ob b">prefect</code>库中导入<code class="fe ny nz oa ob b">Flow</code>。</p><p id="8963" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">为了声明一个流，我们将编写另一个Python函数— <code class="fe ny nz oa ob b">prefect_flow()</code>。它不会接受任何参数，也不会用任何东西修饰。在函数内部，我们将使用Python的上下文管理器来创建一个流。该流应该包含之前在<code class="fe ny nz oa ob b">if __name__ == ‘__main__”</code>代码块中的三行代码。</p><p id="07a8" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">在上面提到的块中，我们现在必须用相应的<code class="fe ny nz oa ob b">run()</code>函数运行流程。</p><p id="83fb" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">以下是该文件的完整代码:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="7beb" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">让我们运行它，看看会发生什么:</p><pre class="ks kt ku kv gt oc ob od oe aw of bi"><span id="9bea" class="og nc it ob b gy oh oi l oj ok">python 03_flow.py</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pa"><img src="../Images/2cb10da8a55850639fdb7e680bf36e16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y_d-x9Qfqhm2c-bRaIMRXw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片4——第一次运行提督流(图片由作者提供)</em></p></figure><p id="03e8" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">这下好了！不仅执行了ETL管道，而且我们还获得了每个任务开始和结束的详细信息。我已经运行了这个文件两次，所以两个新的CSV文件应该会保存到<code class="fe ny nz oa ob b">data</code>文件夹中。让我们验证一下事实是否如此:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi op"><img src="../Images/6dc1c7c393badafbb011ec7507892917.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hy2l2ZHBM4cT3HCnKC-MqA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片5 —提督流生成的CSV文件(图片由作者提供)</em></p></figure><p id="c555" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">这就是你如何用Prefect运行一个简单的ETL管道。与纯Python实现相比，它还没有太多好处，但我们会很快改变这一点。</p><h2 id="0c8d" class="og nc it bd nd oq or dn nh os ot dp nl ls ou ov nn lw ow ox np ma oy oz nr iz bi translated">完美的参数</h2><p id="4e61" class="pw-post-body-paragraph lj lk it ll b lm nt kd lo lp nu kg lr ls nv lu lv lw nw ly lz ma nx mc md me im bi translated">硬编码参数值从来都不是一个好主意。这就是<em class="mf">完美参数</em>的用武之地。首先，将所有内容从<code class="fe ny nz oa ob b">03_flow.py</code>复制到一个新文件<code class="fe ny nz oa ob b">04_parameters.py</code>。你需要从<code class="fe ny nz oa ob b">prefect</code>包中导入<code class="fe ny nz oa ob b">Parameter</code>类。</p><p id="6616" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">您可以在流上下文管理器中使用这个类。以下是你会发现有用的论点:</p><ul class=""><li id="3615" class="mg mh it ll b lm ln lp lq ls mi lw mj ma mk me ml mm mn mo bi translated"><code class="fe ny nz oa ob b">name</code> —参数的名称，稍后将在运行流程时使用。</li><li id="d74f" class="mg mh it ll b lm mp lp mq ls mr lw ms ma mt me ml mm mn mo bi translated"><code class="fe ny nz oa ob b">required</code> —布尔值，指定该参数是否是流程执行所必需的。</li><li id="0080" class="mg mh it ll b lm mp lp mq ls mr lw ms ma mt me ml mm mn mo bi translated"><code class="fe ny nz oa ob b">default</code>-指定参数的默认值。</li></ul><p id="1ae0" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">我们将为API URL声明一个参数— <code class="fe ny nz oa ob b">param_url = Parameter(name=’p_url’, required=True)</code>。</p><p id="5dbd" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">为了给参数赋值，您需要指定<code class="fe ny nz oa ob b">parameters</code>字典作为<code class="fe ny nz oa ob b">run()</code>函数的参数。参数名和值应该写成键值对。</p><p id="64bb" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">以下是该文件的完整代码:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="4e33" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">让我们运行该文件，看看会发生什么:</p><pre class="ks kt ku kv gt oc ob od oe aw of bi"><span id="1a2b" class="og nc it ob b gy oh oi l oj ok">python 04_parameters.py</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pb"><img src="../Images/f2fd27cb68312cb67ffc0c76825b713d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A7gt5cNMehCS2184YdRdVg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片6 —运行包含参数的完美流程(图片由作者提供)</em></p></figure><p id="8895" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">我已经运行了这个文件两次，所以两个新的CSV文件应该出现在<code class="fe ny nz oa ob b">data</code>文件夹中。让我们验证一下这是不是真的:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pc"><img src="../Images/9d1d56a2de39c54f13d10f38cae2ad5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mHBxygAHeTpRNIy8-YDAxg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图7 —包含参数的提督流生成的CSV文件(图片由作者提供)</em></p></figure><p id="6fdc" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">这就是你要的——一个地方的参数值规范。它使得以后进行更改和管理更复杂的工作流变得容易。</p><p id="0ce2" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">接下来，我们将探索Prefect的一个特别有用的特性——时间表。</p><h2 id="2eb6" class="og nc it bd nd oq or dn nh os ot dp nl ls ou ov nn lw ow ox np ma oy oz nr iz bi translated">完美的时间表</h2><p id="8bad" class="pw-post-body-paragraph lj lk it ll b lm nt kd lo lp nu kg lr ls nv lu lv lw nw ly lz ma nx mc md me im bi translated">今天我们将探讨两种任务调度方式——<em class="mf">间隔调度</em>和<em class="mf"> Cron调度</em>。第二个可能听起来很熟悉，因为Cron是一种众所周知的在Unix上调度任务的方法。</p><p id="1164" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">我们将从<strong class="ll jd">间隔调度器</strong>开始。首先，复制从<code class="fe ny nz oa ob b">04_intervals.py</code>到<code class="fe ny nz oa ob b">05_interval_scheduler.py</code>的所有内容。你必须从<code class="fe ny nz oa ob b">prefect.schedules</code>导入<code class="fe ny nz oa ob b">IntervalScheduler</code>。</p><p id="1ce0" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">然后，我们将在<code class="fe ny nz oa ob b">prefect_flow()</code>函数声明之前创建一个导入类的实例，并指示它每十秒钟运行一次。这可以通过设置<code class="fe ny nz oa ob b">interval</code>参数的值来实现。</p><p id="90fb" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">要将调度程序连接到工作流，您必须在使用上下文管理器初始化<code class="fe ny nz oa ob b">Flow</code>类时指定<code class="fe ny nz oa ob b">schedule</code>参数的值。</p><p id="3690" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">整个脚本文件应该如下所示:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="18bf" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">让我们运行该文件，看看会发生什么:</p><pre class="ks kt ku kv gt oc ob od oe aw of bi"><span id="c23d" class="og nc it ob b gy oh oi l oj ok">python 05_interval_scheduler.py</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pa"><img src="../Images/cc769ac5b5defa3027f763730f213443.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D3ykgY1V2Wz7wG2IThi-1A.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片8 —使用间隔时间表(图片由作者提供)</em></p></figure><p id="8c97" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">如您所见，整个ETL管道运行了两次。提督将向终端报告下一次执行的时间。</p><p id="1f78" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">现在，让我们探索一下<strong class="ll jd"> Cron调度器</strong>。复制从<code class="fe ny nz oa ob b">05_interval_scheduler.py</code>到<code class="fe ny nz oa ob b">06_cron_scheduler.py</code>的所有内容。这次你将导入<code class="fe ny nz oa ob b">CronSchedule</code>而不是<code class="fe ny nz oa ob b">IntervalSchedule</code>。</p><p id="041a" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">在类初始化时，您将为<code class="fe ny nz oa ob b">cron</code>参数指定一个cron模式。五星符号将确保工作流程每分钟都在运行。这是Cron可能的最低间隔。</p><p id="2ba8" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">文件的其余部分保持不变。代码如下:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="25d9" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">让我们运行该文件:</p><pre class="ks kt ku kv gt oc ob od oe aw of bi"><span id="656d" class="og nc it ob b gy oh oi l oj ok">python 06_cron_scheduler.py</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pa"><img src="../Images/ee9cda3ca69d8b53f5359500d38ea87a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9mRjQQBVLfV11y9wsai-ug.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片9 —使用Cron计划(图片由作者提供)</em></p></figure><p id="0f74" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">正如您所看到的，ETL管道每一分钟运行两次，这是由Cron模式指定的。在这一部分的最后，我们将探索如何处理失败——并解释为什么你应该总是为它做准备。</p><h2 id="3677" class="og nc it bd nd oq or dn nh os ot dp nl ls ou ov nn lw ow ox np ma oy oz nr iz bi translated">完美的失败</h2><p id="b898" class="pw-post-body-paragraph lj lk it ll b lm nt kd lo lp nu kg lr ls nv lu lv lw nw ly lz ma nx mc md me im bi translated">迟早，你的工作流程中会发生意外的错误。Prefect提供了一种极其简单的方式来重试任务的执行。首先，将所有内容从<code class="fe ny nz oa ob b">04_parameters.py</code>复制到一个新文件<code class="fe ny nz oa ob b">07_failures.py</code>。</p><p id="c43e" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated"><code class="fe ny nz oa ob b">extract()</code>功能可能因不同的网络原因而失败。例如，也许API现在不可用，但几秒钟后就会可用。这些事情发生在生产环境中，不应该使您的应用程序完全崩溃。</p><p id="0b2e" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">为了避免不必要的崩溃，我们可以扩展一下我们的<code class="fe ny nz oa ob b">task</code>装饰器。它可以接受不同的参数，今天我们将使用<code class="fe ny nz oa ob b">max_retries</code>和<code class="fe ny nz oa ob b">retry_delay</code>。两者都是不言自明的，我就不赘述了。</p><p id="fcb3" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">唯一的问题是——我们的工作流程不会像现在这样失败。但是如果我们将一个不存在的URL作为参数值放在<code class="fe ny nz oa ob b">flow.run()</code>中，它就会。代码如下:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="58cd" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">让我们运行该文件:</p><pre class="ks kt ku kv gt oc ob od oe aw of bi"><span id="bb08" class="og nc it ob b gy oh oi l oj ok">python 07_failures.py</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pa"><img src="../Images/5c8c71200da8e17949ad735bd93242b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UbGB6lGlFADryQ58oZjnkA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片10——与提督一起预防故障(图片由作者提供)</em></p></figure><p id="15fe" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">任务失败，但工作流没有崩溃。当然，它会在十次重试后崩溃，但您可以随时更改参数规范。</p><p id="f399" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">这也是我和地方长官一起工作的原因。接下来，让我们将代码迁移到云中，并探索其中的变化。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="662f" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">在土星云中奔跑</h1><p id="71d8" class="pw-post-body-paragraph lj lk it ll b lm nt kd lo lp nu kg lr ls nv lu lv lw nw ly lz ma nx mc md me im bi translated">让我们马上把手弄脏。首先，注册一个免费版的<a class="ae lh" href="https://www.prefect.io/cloud/" rel="noopener ugc nofollow" target="_blank">提督云</a>账号。注册过程非常简单，无需进一步解释。注册后，创建一个项目。我给我的取名为<code class="fe ny nz oa ob b">SaturnCloudDemo</code>。</p><p id="b2ef" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">在进入<a class="ae lh" href="https://www.saturncloud.io/s/?utm_source=dario-radecic" rel="noopener ugc nofollow" target="_blank">土星云</a>之前，你必须在Prefect中创建一个API键来连接两者。你会在设置下找到<em class="mf"> API键</em>选项。如您所见，我已经将我的命名为<code class="fe ny nz oa ob b">SaturnDemoKey</code>:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pd"><img src="../Images/367cd847ab8704d6b85a97c84e473876.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ufZqlQn9JketkDVmca66QQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片11 —提督云API密钥创建(图片由作者提供)</em></p></figure><p id="559c" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">你现在已经有了所有需要的东西，所以去<a class="ae lh" href="https://www.saturncloud.io/s/?utm_source=dario-radecic" rel="noopener ugc nofollow" target="_blank">土星云</a>创建一个免费账户。在仪表板上，您将看到项目创建的多个选项。选择<em class="mf">提督</em>选项，如下图所示:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pd"><img src="../Images/186c9c418d80884073b18fe3ca9fa62a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cjq1hg2p6ThpMamqXDFkMA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片12——在土星云中创建一个完美的项目(图片由作者提供)</em></p></figure><p id="e81e" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">Saturn Cloud现在将自动为您完成所有繁重的工作，几分钟后，您将能够通过单击按钮打开JupyterLab实例:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pe"><img src="../Images/19aaecaa55c919b14bd5bd236adb3735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Crm3WMDYuXeoKEN4JYYlg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图13——土星云中打开的木星实验室(图片由作者提供)</em></p></figure><p id="b500" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">你可以使用两个笔记本——第二个展示了在土星云中使用Prefect的快速演示。它看起来是这样的:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pf"><img src="../Images/e0c46ff930106099e7ef77de309329fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5r2KmCohAeRjzeXjVC3aYg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片14——土星云中的完美云笔记本(图片由作者提供)</em></p></figure><p id="910b" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">要让笔记本工作，您只需更改两件事情。首先，将项目名称更改为您在Prefect Cloud中的项目名称。其次，用几分钟前生成的API密匙替换<code class="fe ny nz oa ob b">&lt;your_api_key_here&gt;</code>。如果您做的一切都正确，您应该会看到以下消息:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pf"><img src="../Images/092812c20f26e4a89de6c962a66d9867.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z4XSuJhc7tNn3OmmR-_rQg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片15——土星云中登录成功的消息(图片由作者提供)</em></p></figure><p id="00c2" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">要进行测试，请运行笔记本中的每个单元格。然后转到完美云仪表板，打开你的项目。它不会像几分钟前那样空无一人:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pg"><img src="../Images/ca16d311aa586a8254c31ce384b3be98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yxEnns3QkUhEczoA-Bfzlw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><em class="om">图片16 —成功的提督任务调度(图片由作者提供)</em></p></figure><p id="97f1" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">这就是你要做的一切！请随意复制/粘贴我们的ETL管道，并验证它是否工作。这就是Saturn Cloud的亮点——您可以从本地机器上复制/粘贴代码，只需做最小的更改，因为所有繁琐的工作都是自动配置的。</p><p id="a5be" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">让我们在下一部分总结一下。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="d075" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">最后的想法</h1><p id="19a9" class="pw-post-body-paragraph lj lk it ll b lm nt kd lo lp nu kg lr ls nv lu lv lw nw ly lz ma nx mc md me im bi translated">现在你有了它Prefect的基础解释，包括本地和云。我希望您能够看到工作流管理系统对于生产应用程序的价值，即使您在阅读本文之前对这个主题一无所知。</p><p id="7e8a" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">有关更高级的指南，即配置日志记录和空闲通知，请参考<a class="ae lh" href="https://docs.prefect.io/core/" rel="noopener ugc nofollow" target="_blank">官方文档</a>。提供的例子足以让你开始。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><p id="41d8" class="pw-post-body-paragraph lj lk it ll b lm ln kd lo lp lq kg lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated"><em class="mf">喜欢这篇文章吗？成为</em> <a class="ae lh" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="mf">中等会员</em> </a> <em class="mf">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="ph pi gp gr pj pk"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="pl ab fo"><div class="pm ab pn cl cj po"><h2 class="bd jd gy z fp pp fr fs pq fu fw jc bi translated">通过我的推荐链接加入Medium-Dario rade ci</h2><div class="pr l"><h3 class="bd b gy z fp pp fr fs pq fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="ps l"><p class="bd b dl z fp pp fr fs pq fu fw dk translated">medium.com</p></div></div><div class="pt l"><div class="pu l pv pw px pt py lb pk"/></div></div></a></div></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="6ed0" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">保持联系</h1><ul class=""><li id="d1f8" class="mg mh it ll b lm nt lp nu ls pz lw qa ma qb me ml mm mn mo bi translated">在<a class="ae lh" href="https://medium.com/@radecicdario" rel="noopener">媒体</a>上关注我，了解更多类似的故事</li><li id="6e31" class="mg mh it ll b lm mp lp mq ls mr lw ms ma mt me ml mm mn mo bi translated">注册我的<a class="ae lh" href="https://mailchi.mp/46a3d2989d9b/bdssubscribe" rel="noopener ugc nofollow" target="_blank">简讯</a></li><li id="ac4f" class="mg mh it ll b lm mp lp mq ls mr lw ms ma mt me ml mm mn mo bi translated">在<a class="ae lh" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li></ul></div></div>    
</body>
</html>