<html>
<head>
<title>Use git submodules to install a private, custom python package in a docker image</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用git子模块在docker映像中安装一个私有的定制python包</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/use-git-submodules-to-install-a-private-custom-python-package-in-a-docker-image-dd6b89b1ee7a?source=collection_archive---------8-----------------------#2021-07-27">https://towardsdatascience.com/use-git-submodules-to-install-a-private-custom-python-package-in-a-docker-image-dd6b89b1ee7a?source=collection_archive---------8-----------------------#2021-07-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f3bb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">这是一个复杂的题目，但我发誓并不难</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ad146858fcfc62cfe2c978b8b1e8ba04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BcsAgHNk9uzndzNT"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这条蟒蛇已经包装好了，可以装船了！(图片由<a class="ae ky" href="https://www.pexels.com/@worldspectrum" rel="noopener ugc nofollow" target="_blank">世界光谱</a>在<a class="ae ky" href="https://www.pexels.com/photo/beige-python-on-brown-branch-of-tree-1108192/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄)</p></figure><p id="ef2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">哇，这个标题包含了很多术语！简单地说，这篇文章为您提供了最好的方式，让您可以私下轻松地分享您的Python代码，甚至可以在docker容器中运行它！最终，您将能够分发随处运行、易于维护和更新的私有包。我们来编码吧！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9022" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">准备</h1><p id="169d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您已经创建了一个Python脚本，其中包含了您想要与其他人共享的各种方便的函数。对于如何实现这一点，您有两种选择:</p><ol class=""><li id="1164" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">将您的代码打包并在PyPi <a class="ae ky" href="https://mikehuls.medium.com/create-and-publish-your-own-python-package-ea45bee41cdc" rel="noopener"> <strong class="lb iu">上公开发布，详见本文</strong> </a>。这意味着任何人都可以通过调用<code class="fe ni nj nk nl b">pip install <em class="nm">yourpackage</em></code> <em class="nm"> </em>来安装这个包，就像熊猫一样</li><li id="f693" class="mz na it lb b lc nn lf no li np lm nq lq nr lu ne nf ng nh bi translated">将你的代码打包并私下分发<a class="ae ky" href="https://mikehuls.medium.com/create-your-custom-python-package-that-you-can-pip-install-from-your-git-repository-f90465867893" rel="noopener"> <strong class="lb iu">如本文</strong> </a>所述。这意味着只有某些人能够安装这个软件包，比如你公司的同事。</li></ol><p id="3094" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们选择第二个选项，确保我们的代码保持私有。我们将基于第二个选项中的文章，因此请务必先阅读它。阅读完之后，您就有了一个Python包，您可以从您的g it存储库中pip安装它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/4f779f8615a2c9c141622488b362275c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Tln8ik5B0dC3xT9F"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一个专为你准备的私人Python包！(图片由<a class="ae ky" href="https://www.pexels.com/@pixabay" rel="noopener ugc nofollow" target="_blank">像素</a>在<a class="ae ky" href="https://www.pexels.com/photo/brown-jest-for-you-box-264771/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄)</p></figure><h1 id="9d8c" class="mc md it bd me mf nt mh mi mj nu ml mm jz nv ka mo kc nw kd mq kf nx kg ms mt bi translated">问题是</h1><p id="e130" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果你遵循了本文 中的说明，你的git repo中有一个包，你可以像<code class="fe ni nj nk nl b">pip install git+https://github.com/mike-huls/toolbox.git</code>一样安装它。在这个例子中，我们将想象我们正在创建一个Python项目，它使用了本文中的<em class="nm">工具箱</em>包。</p><p id="acd9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们希望在docker容器中运行我们的项目。为了构建Docker映像，我们必须首先将源代码复制到映像中，然后安装我们使用的所有软件包。这是通过提供我们使用的所有包的列表来完成的。您可以使用<code class="fe ni nj nk nl b">pip freeze &gt; requirements.txt</code>生成这个列表。生成的requirements.txt将包含我们所有包的名称和版本。</p><p id="e67a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">问题是即使是我们私装的包也是按名称和版本列出的。这导致pip在PyPi上搜索<em class="nm">工具箱</em>，但是它找不到这个包，因为我们已经从我们的Git repo中私下安装了它。我们也不能提供我们的<code class="fe ni nj nk nl b">git+[GIT_REPO_URL]</code>,因为我们的Docker映像没有登录git的凭证。有一种方法可以使用ssh密钥来解决这个问题，但在我看来这很难管理；有一个简单得多的选项，可以让您的同事更容易地获得代码，而不必麻烦地生成或分发ssh密钥。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/cf5fca77069c43065fe463b3ce984cce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0WMuqaSd1mfrG1Wd"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">pip试图在公共PyPi上找到我们的私有包(图片由Andrea Piacquadio 在<a class="ae ky" href="https://www.pexels.com/photo/thoughtful-man-using-smartphone-on-street-3800149/" rel="noopener ugc nofollow" target="_blank"> Pexels </a>上提供)</p></figure><h1 id="8589" class="mc md it bd me mf nt mh mi mj nu ml mm jz nv ka mo kc nw kd mq kf nx kg ms mt bi translated">解决方案</h1><p id="0f7c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们将使用git子模块将包拉到我们的项目目录中，安装它，然后修改我们的Docker文件，将包安装到我们的Docker映像中。方法如下:</p><h2 id="6c53" class="nz md it bd me oa ob dn mi oc od dp mm li oe of mo lm og oh mq lq oi oj ms ok bi translated">1添加子模块</h2><p id="b84a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">转到您的项目根目录，然后:</p><pre class="kj kk kl km gt ol nl om on aw oo bi"><span id="e82e" class="nz md it nl b gy op oq l or os">git submodule add <a class="ae ky" href="https://github.com/mike-huls/toolbox" rel="noopener ugc nofollow" target="_blank">https://github.com/mike-huls/toolbox</a> _submodules/toolbox</span></pre><p id="c7a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nm">(为了便于说明，我在这里使用了一个公共存储库)<br/> </em>这将在您的根目录下创建一个名为<em class="nm"> _submodules </em>的文件夹，其中包含另一个包含您的Python包的文件夹。</p><h2 id="5da9" class="nz md it bd me oa ob dn mi oc od dp mm li oe of mo lm og oh mq lq oi oj ms ok bi translated">2安装软件包</h2><p id="b83a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">只需执行<br/> <code class="fe ni nj nk nl b">pip install _submodules/toolbox</code>来安装软件包</p><h2 id="5268" class="nz md it bd me oa ob dn mi oc od dp mm li oe of mo lm og oh mq lq oi oj ms ok bi translated">3创建Dockerfile文件</h2><p id="d526" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一旦我们想要创建Docker图像，只需重复前面的两个步骤；将子模块文件夹复制到映像中，然后再次运行安装。</p><pre class="kj kk kl km gt ol nl om on aw oo bi"><span id="6e0d" class="nz md it nl b gy op oq l or os"><strong class="nl iu">FROM</strong> python:3.8<br/>WORKDIR <strong class="nl iu">/</strong>app<br/><br/><strong class="nl iu">#</strong> Install regular packages<br/><strong class="nl iu">COPY</strong> requirements.txt .<br/>RUN pip install <strong class="nl iu">-</strong>r requirements.txt<br/><br/><strong class="nl iu">#</strong> Install submodule packages<br/><strong class="nl iu">COPY</strong> _submodules<strong class="nl iu">/</strong>toolbox _submodules<strong class="nl iu">/</strong>toolbox<br/>RUN pip install _submodules<strong class="nl iu">/</strong>toolbox<em class="nm">--upgrade</em><br/><br/><strong class="nl iu">#</strong> <strong class="nl iu">copy</strong> <strong class="nl iu">source</strong> code<br/><strong class="nl iu">COPY</strong> .<strong class="nl iu">/</strong> .<br/><br/><strong class="nl iu">#</strong> command <strong class="nl iu">to</strong> run <strong class="nl iu">on</strong> container <strong class="nl iu">start</strong><br/>CMD [ "python", "./app.py"]</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="f581" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！现在你有了一个拥有“真相之源”的中央储存库。您可以在这里提交问题、添加功能请求、协作和推送更新，非常简单。其他优势包括:</p><p id="6a82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可用性:<br/>用户可以继续使用<code class="fe ni nj nk nl b">pip install git+REPO_URL</code>；这不足以建立形象。你的程序员可以用一种非常简单的方式继续安装你的包。然后，当代码准备好构建到映像中时，只需拉出子模块并将其包含在docker文件中，就可以非常容易地包含该包。</p><p id="48ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个干净的repo <br/>除此之外，git将为您跟踪您的子模块。调用<code class="fe ni nj nk nl b">pip freeze &gt; requirements.txt</code>`并注意到<em class="nm">工具箱</em>没有列出。这是因为git知道它是一个子模块。它也被忽略了，这样你就不会“污染”你的项目报告。</p><p id="abee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">轻松更新<br/>更新我们项目中使用的软件包非常简单；只需执行:</p><pre class="kj kk kl km gt ol nl om on aw oo bi"><span id="b296" class="nz md it nl b gy op oq l or os">git submodule update --remote --merge<br/>pip install _submodules/toolbox --upgrade</span></pre><p id="b77d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将首先把所有新代码拉到包文件夹中，然后升级包。别忘了用一个<a class="ae ky" href="https://mikehuls.medium.com/virtual-environments-for-absolute-beginners-what-is-it-and-how-to-create-one-examples-a48da8982d4b" rel="noopener">虚拟环境</a>！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/d9eca53cdb670df94677eeafcbcc0b89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1dfjr_ISXt96oFWk"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用定制的、私人的Python包运送那些容器(图片由<a class="ae ky" href="https://unsplash.com/@ventiviews" rel="noopener ugc nofollow" target="_blank"> Cameron Venti </a>在<a class="ae ky" href="https://unsplash.com/photos/1cqIcrWFQBI" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供)</p></figure><h1 id="0a29" class="mc md it bd me mf nt mh mi mj nu ml mm jz nv ka mo kc nw kd mq kf nx kg ms mt bi translated">结论</h1><p id="3b21" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">定制的私有Python包易于安装、维护、更新和分发。使用这个简单的方法将它们构建成Docker图像会使它们更加令人惊叹。</p><p id="2aaa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望我在这篇文章中的解释是清楚的。如果你有建议/澄清，请评论，以便我可以改进这篇文章。同时，查看我的其他关于各种编程相关主题的文章。编码快乐！</p><p id="ac07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="15b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page的缩写）学生:比如我正在做的事情？<a class="ae ky" href="https://github.com/mike-huls" rel="noopener ugc nofollow" target="_blank">跟我来</a>！</p></div></div>    
</body>
</html>