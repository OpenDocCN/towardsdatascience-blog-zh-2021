<html>
<head>
<title>The Shapley Value for ML Models</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ML模型的Shapley值</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-shapley-value-for-ml-models-f1100bff78d1?source=collection_archive---------1-----------------------#2021-10-26">https://towardsdatascience.com/the-shapley-value-for-ml-models-f1100bff78d1?source=collection_archive---------1-----------------------#2021-10-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="6619" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">值得信赖的人工智能</h2><div class=""/><div class=""><h2 id="a914" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">什么是Shapley值，为什么它对许多可解释技术至关重要？</h2></div><p id="6cc7" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><em class="lk">本文由大卫·黑川合著。</em></p><p id="b505" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在我们的<a class="ae ll" rel="noopener" target="_blank" href="/picking-an-explainability-technique-48e807d687b9">上一篇文章</a>中，我们提出了一个案例，说明为什么可解释性是确保你的AI/ML模型质量的关键因素。我们还介绍了解释方法的分类，以帮助比较和对比解释模型的不同技术。</p><p id="1a30" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在这篇文章中，我们将深入探讨沙普利值的概念。许多流行的解释技术——比如<a class="ae ll" href="https://ieeexplore.ieee.org/document/7546525" rel="noopener ugc nofollow" target="_blank"> QII </a>和<a class="ae ll" href="https://arxiv.org/abs/1705.07874" rel="noopener ugc nofollow" target="_blank">SHAP</a>——都在他们的计算中使用了沙普利值。那么什么是Shapley值，为什么它是这么多可解释技术的核心？</p><h1 id="f81d" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">沙普利价值观回答了哪些问题？</h1><p id="721b" class="pw-post-body-paragraph ko kp iq kq b kr me ka kt ku mf kd kw kx mg kz la lb mh ld le lf mi lh li lj ij bi translated">在高层次上，Shapley值方法试图解释为什么ML模型报告它对输入所做的输出。例如，对于识别申请人是否应该获得抵押贷款的模型，我们可能想知道为什么退休人员Jane被拒绝贷款，或者为什么模型认为她的违约概率为70% —这是查询定义。</p><p id="05d8" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在这些问题中隐含的是，为什么Jane被拒绝贷款，而其他人没有，或者为什么她被认为有70%的违约机会，而平均申请人从模型中仅获得20%的机会。将这个问题与Jane和其他人的不同联系起来有助于回答更微妙的问题。例如，当与所有被接受的申请人进行比较时，我们会发现她被拒绝的一般原因——比如她需要大幅增加收入。但通过将她与所有被录取的退休申请人进行比较，她可能会发现她高于平均水平的信用卡债务是她预测的高违约率的关键原因。这样，Shapley值就与比较组联系在一起了。</p><p id="cf20" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">因此，Shapley值方法采用Jane模型的输出以及一些申请人的比较组，并确定Jane和比较组之间的差异有多少是由每个特征造成的。例如，她70%的预计违约率和被接受的退休申请人10%的预计违约率，有60%的差异需要解释。Shapley可能会将40%分配给她的信用卡债务，15%分配给她的低净值，5%分配给她退休后的低收入——测量每个特征对总得分差异的平均边际贡献。稍后，我们将通过精确的Shapley值公式使这一点更加具体。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/75491d991b50fbd04e7d024885d82a64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lIIJRRdCnhgEEC2z"/></div></div><p class="mv mw gj gh gi mx my bd b be z dk translated">图片作者。</p></figure><h1 id="96bc" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">什么是沙普利价值观？</h1><p id="55d4" class="pw-post-body-paragraph ko kp iq kq b kr me ka kt ku mf kd kw kx mg kz la lb mh ld le lf mi lh li lj ij bi translated">Shapley值是从合作博弈论文献中借用的一个概念，可以追溯到20世纪50年代。在它们最初的形式中，Shapley值用于公平地将玩家的贡献归因于游戏的最终结果。假设我们有一个合作游戏，一组玩家每个人都合作创造一些价值。如果我们可以衡量游戏的总收益，Shapley值捕捉每个玩家对最终结果的边际贡献。例如，如果朋友们共用一辆出租车去不同的地点，则总账单可以基于Shapley值来分割。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mz"><img src="../Images/c410f44ce98afa4eeca6fbf140ca6699.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rpByi0XEcfBsHpFS"/></div></div><p class="mv mw gj gh gi mx my bd b be z dk translated">图片作者。</p></figure><p id="f9f3" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果我们认为我们的机器学习模型是一个游戏，其中各个特征“合作”产生一个输出，这是一个模型预测，那么我们可以将预测归因于每个输入特征。正如我们将在后面探讨的，Shapley值在公理上是唯一的，因为它们满足测量每个特征对最终结果的贡献的期望属性。</p><p id="a00b" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在高层次上，Shapley值是通过仔细扰动输入要素并查看输入要素的变化如何与最终模型预测相对应来计算的。然后计算给定特征的Shapley值，作为对整体模型分数的平均边际贡献。Shapley值通常是相对于作为解释的“基线”的比较或背景组来计算的，这消除了问题“与所有批准的申请人相比，Jane为什么被拒绝贷款？”来自“与所有获批的女性相比，为什么简被拒绝贷款？”</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi na"><img src="../Images/ce198041d704498c281b05c82377c298.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dK_KMo8NV2x8GMfR"/></div></div><p class="mv mw gj gh gi mx my bd b be z dk translated">图片作者。单个特征如何影响模型得分的示例。</p></figure><h1 id="115c" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">沙普利值有什么了不起的？</h1><p id="ae46" class="pw-post-body-paragraph ko kp iq kq b kr me ka kt ku mf kd kw kx mg kz la lb mh ld le lf mi lh li lj ij bi translated">Shapley值的特殊之处在于，它是满足一组强大公理的唯一值，这些公理可能是您在归因策略中所期望的。在本帖中，我们不会讨论这个唯一性的<a class="ae ll" href="https://link.springer.com/article/10.1007/BF01769885" rel="noopener ugc nofollow" target="_blank">证明，但是让我们强调其中的一些公理:</a></p><ul class=""><li id="9b65" class="nb nc iq kq b kr ks ku kv kx nd lb ne lf nf lj ng nh ni nj bi translated"><strong class="kq ja">完备性/效率:</strong>每个玩家(特征)的贡献总和必须加起来等于总收益(模型得分)减去比较组的平均收益(模型得分)。</li><li id="18cc" class="nb nc iq kq b kr nk ku nl kx nm lb nn lf no lj ng nh ni nj bi translated"><strong class="kq ja">假人:</strong>对游戏没有贡献的玩家不能获得任何回报。在ML模型的情况下，模型不使用的输入特征必须被分配为零的贡献。</li><li id="4b49" class="nb nc iq kq b kr nk ku nl kx nm lb nn lf no lj ng nh ni nj bi translated"><strong class="kq ja">对称:</strong>对称玩家(特征)对最终收益(模型分数)的贡献相等。</li><li id="9f0e" class="nb nc iq kq b kr nk ku nl kx nm lb nn lf no lj ng nh ni nj bi translated"><strong class="kq ja">单调性:</strong>如果一个玩家(特征)A比一个玩家(特征)B对收益(模型得分)的贡献持续更大，那么玩家(特征)A的Shapley值必须反映这一点，并且高于玩家(特征)B的Shapley值。</li><li id="c80d" class="nb nc iq kq b kr nk ku nl kx nm lb nn lf no lj ng nh ni nj bi translated"><strong class="kq ja">线性</strong>:让我们假设游戏收益(模型分数)是基于两个中间值之和确定的，每个中间值都来自输入特征。然后，分配给每个玩家(特征)的贡献必须是玩家(特征)对中间值的贡献之和。</li></ul><h1 id="533b" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">Shapley值在ML模型中是如何使用的？</h1><p id="f5c5" class="pw-post-body-paragraph ko kp iq kq b kr me ka kt ku mf kd kw kx mg kz la lb mh ld le lf mi lh li lj ij bi translated">我们提到过，Shapley值计算的是功能𝒙对模型分数的<strong class="kq ja">平均边际贡献</strong>。这在实践中是如何计算的？</p><p id="df61" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">让我们首先尝试为一个合作博弈制定这个。假设我们有一个<em class="lk"> n </em>玩家游戏，玩家有<em class="lk"> 1，2，…，n </em>和一些价值函数<strong class="kq ja"> <em class="lk"> v </em> </strong>，它接受玩家的子集，如果只有这些玩家参与，则返回游戏的实值收益。那么形式上，玩家<em class="lk"> i </em>的贡献<strong class="kq ja">φ</strong>定义为</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi np"><img src="../Images/0408b39b7e66381239a31c0c090290f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PtQQZUgLxOTKp2sehb9tBg.png"/></div></div><p class="mv mw gj gh gi mx my bd b be z dk translated">图片作者。Shapley值的数学公式。</p></figure><p id="36a5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">其中<strong class="kq ja"> S </strong>是玩家的联盟或子集。简单地说，Shapley值是通过计算当参与人<em class="lk"> i </em>被包括在排除<em class="lk"> i </em>的所有联盟中时，参与人<em class="lk">I</em>提供的加权平均收益来计算的。</p><p id="d199" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在最简单的ML设置中，这个合作博弈的参与者由ML模型的特征代替，收益由模型输出本身代替。让我们回到之前的抵押贷款例子，让这一点更清楚。假设我们有一个模型，它被训练来预测个人拖欠贷款的可能性。Jane有70%的违约几率，我们想知道她的收入(这恰好是特写<em class="lk"> i </em>)在决定模特的决策时有多重要。我们首先会选择一个随机的特征子集<strong class="kq ja"> S </strong>提供给模型。例如，SCO可以包括Jane的信用卡债务和净资产。然后，我们将测量边际贡献<em class="lk">v(S ∨{ I })-v(S)</em>，这告诉我们，相对于仅使用信用卡债务和净值作为特征的模型的输出，将Jane的收入包括到模型中(特征<em class="lk"> i </em>)会改变模型的输出多少。换句话说，边际贡献捕获了收入对模型输出的增量贡献，同时考虑了它与信用卡债务和净值特征的相互作用。Shapley值是所有这些边际贡献在不同的<strong class="kq ja"> S </strong>上的加权平均值。</p><p id="42cc" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">对于最大似然模型，在确定预测时不可能仅仅“排除”一个特征。因此，ML上下文中Shapley值的公式通过对特征值的经验分布进行采样并对多个样本进行平均来模拟“被排除”的特征。根据采样策略的不同，这可能会很棘手，而且计算成本很高，这就是为什么大多数计算ML模型Shapley值的真实方法都是产生真实Shapley值的估计值。这些算法之间的核心差异，如QII和SHAP，在于各自选择干预和干扰特征的细微方式。</p><p id="b56f" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">计算Shapley值只需要黑盒访问模型作为预测器，只要您知道其输入和输出，就可以在不了解模型内部机制的情况下计算Shapley值。这使得它成为一种与模型无关的技术，也有助于跨不同模型类型直接比较输入要素的Shapley值。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mz"><img src="../Images/cbad192560fbe884e7f2f60d69b496eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zsBCEq4RHLRbmHgg"/></div></div><p class="mv mw gj gh gi mx my bd b be z dk translated">图片作者。</p></figure><p id="7e5c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">此外，因为Shapley值可以相对于单个数据点计算，所以它们提供了局部解释的粒度，同时允许外推。例如，通过分析跨多个数据点的哪些要素具有较高的Shapley值，可以深入了解模型的全局推理。</p><h1 id="878b" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">Shapley值的局限性</h1><p id="9684" class="pw-post-body-paragraph ko kp iq kq b kr me ka kt ku mf kd kw kx mg kz la lb mh ld le lf mi lh li lj ij bi translated">尽管Shapley值的动机是公理化的，但是它们在ML环境中的使用还是有一些明显的局限性。</p><p id="96a2" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">计算Shapley值需要选择特征的组合或子集，这在特征的数量上呈指数级增长。这通过使用近似技术和利用已知的特定模型结构(例如在树或线性模型中)来减轻，但是通常Shapley值计算难以精确计算。</p><p id="c5ed" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">一个更概念性的问题是，Shapley值可能严重依赖于模型如何作用于不切实际的输入。例如，一个将纬度和经度作为独立要素的房价模型可以在湖中央的房地产上进行查询。有一些定义公式试图弥补这一点，但是它们受到其他问题的困扰——通常需要无法获得的大量数据。这种“不切实际的输入”问题甚至已经被证明可以被攻击者利用，因为可以构建与原始模型几乎相同地执行的模型，但是其Shapley值几乎是随机的。</p><h1 id="37be" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">沙普利价值观:一个强有力的解释工具</h1><p id="87e5" class="pw-post-body-paragraph ko kp iq kq b kr me ka kt ku mf kd kw kx mg kz la lb mh ld le lf mi lh li lj ij bi translated">Shapley值借用了合作博弈论的见解，并提供了一种接近机器学习解释的公理化方法。这是为数不多的解释技术之一，它是由一个好的解释看起来像什么的直觉概念支持的，它允许局部和全局推理，并且它是模型类型不可知的。结果，许多流行的解释技术利用Shapley值来解释ML模型。在这篇博文中，我们概述了Shapley值背后的理论直觉，以及为什么它对ML解释能力如此强大。</p></div></div>    
</body>
</html>