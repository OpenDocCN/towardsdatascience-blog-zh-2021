<html>
<head>
<title>Build a News Recommendation App from Python with Vespa</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Vespa从Python构建新闻推荐应用程序</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-a-news-recommendation-app-from-python-with-vespa-f59c0a08c9a3?source=collection_archive---------30-----------------------#2021-04-05">https://towardsdatascience.com/build-a-news-recommendation-app-from-python-with-vespa-f59c0a08c9a3?source=collection_archive---------30-----------------------#2021-04-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9770" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第2部分—从新闻搜索到嵌入的新闻推荐</h2></div><p id="686b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这一部分中，我们将开始使用本教程中创建的嵌入，将<a class="ae lb" rel="noopener" target="_blank" href="/build-a-news-recommendation-app-from-python-with-vespa-7c5b3ce079be">我们的应用程序</a>从新闻搜索转换为新闻推荐。嵌入向量将代表每个用户和新闻文章。我们将提供用于下载的嵌入，以便更容易理解这篇文章。当用户来时，我们检索他的嵌入，并通过近似最近邻(ANN)搜索使用它来检索最近的新闻文章。我们还表明，Vespa可以联合应用一般过滤和人工神经网络搜索，而不像市场上的竞争对手。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/80a954f9c99c7829d5c87b774008f828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WFscYkNShzonQamK8bqtPg.jpeg"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">马特·波波维奇在<a class="ae lb" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="7a16" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们假设你已经阅读了新闻搜索教程。因此，您应该有一个保存新闻搜索应用程序定义的<code class="fe ls lt lu lv b">app_package</code>变量和一个名为<code class="fe ls lt lu lv b">news</code>的Docker容器来运行一个搜索应用程序，该应用程序从MIND数据集的演示版本中获取新闻文章。</p><h2 id="fe72" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">添加用户模式</h2><p id="57ea" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">我们需要添加另一种文档类型来表示用户。我们设置模式来搜索一个<code class="fe ls lt lu lv b">user_id</code>，并检索用户的嵌入向量。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="0a67" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过指定<code class="fe ls lt lu lv b">fast-search</code>属性为属性字段<code class="fe ls lt lu lv b">user_id</code>构建一个索引。请记住，属性字段保存在内存中，默认情况下不进行索引。</p><p id="e36d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嵌入场是张量场。Vespa中的张量是灵活的多维数据结构，作为一等公民，可用于查询、文档字段和排名中的常数。张量可以是稠密的，也可以是稀疏的，或者两者兼有，并且可以包含任意数量的维度。更多信息请参见<a class="ae lb" href="https://docs.vespa.ai/en/tensor-user-guide.html" rel="noopener ugc nofollow" target="_blank">张量用户指南</a>。这里我们定义了一个单维的稠密张量(<code class="fe ls lt lu lv b">d0</code> -维0)，代表一个向量。51是本文中使用的嵌入大小。</p><p id="ea59" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们现在有一个用于<code class="fe ls lt lu lv b">news</code>的模式和一个用于<code class="fe ls lt lu lv b">user</code>的模式。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><pre class="ld le lf lg gt mw lv mx my aw mz bi"><span id="239c" class="lw lx iq lv b gy na nb l nc nd">['news', 'user']</span></pre><h2 id="4d99" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">索引新闻嵌入</h2><p id="1f34" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">类似于用户模式，我们将使用密集张量来表示新闻嵌入。但与用户嵌入字段不同，我们将通过在<code class="fe ls lt lu lv b">indexing</code>参数中包含<code class="fe ls lt lu lv b">index</code>来索引新闻嵌入，并指定我们希望使用HNSW(分层可导航小世界)算法来构建索引。使用的距离度量是欧几里德。阅读<a class="ae lb" href="https://blog.vespa.ai/approximate-nearest-neighbor-search-in-vespa-part-1/" rel="noopener ugc nofollow" target="_blank">这篇博文</a>了解更多关于Vespa实现ANN搜索的历程。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="18fa" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">使用嵌入的推荐</h2><p id="0dc9" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">在这里，我们添加了一个使用紧密度排名特性的排名表达式，它计算欧几里德距离并使用它来对新闻文章进行排名。这个等级配置文件依赖于使用最近邻搜索操作符，我们将在搜索时回到下面。但是现在，这需要查询中的一个张量作为初始搜索点。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="4e54" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">查询配置文件类型</h2><p id="d191" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">上面的推荐等级配置文件要求我们随查询一起发送一个张量。为了让Vespa绑定正确的类型，它需要知道这个查询参数的预期类型。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="703f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当查询参数ranking . features . query(user _ embedding)被传递时，该查询配置文件类型指示Vespa预期一个维数为<code class="fe ls lt lu lv b">d0[51]</code>的浮点张量。我们将在下面看到它是如何与最近邻搜索操作符一起工作的。</p><h2 id="d855" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">重新部署应用程序</h2><p id="ff96" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">我们做了所有必要的改变，将我们的新闻搜索应用变成了新闻推荐应用。我们现在可以将<code class="fe ls lt lu lv b">app_package</code>重新部署到名为<code class="fe ls lt lu lv b">news</code>的运行容器中。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><pre class="ld le lf lg gt mw lv mx my aw mz bi"><span id="5f9e" class="lw lx iq lv b gy na nb l nc nd">Waiting for configuration server.<br/>Waiting for configuration server.<br/>Waiting for configuration server.<br/>Waiting for configuration server.<br/>Waiting for configuration server.<br/>Finished deployment.</span></pre><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><pre class="ld le lf lg gt mw lv mx my aw mz bi"><span id="2bd0" class="lw lx iq lv b gy na nb l nc nd">["Uploading application '/app/application' using http://localhost:19071/application/v2/tenant/default/session",<br/> "Session 7 for tenant 'default' created.",<br/> 'Preparing session 7 using http://localhost:19071/application/v2/tenant/default/session/7/prepared',<br/> "WARNING: Host named 'news' may not receive any config since it is not a canonical hostname. Disregard this warning when testing in a Docker container.",<br/> "Session 7 for tenant 'default' prepared.",<br/> 'Activating session 7 using http://localhost:19071/application/v2/tenant/default/session/7/active',<br/> "Session 7 for tenant 'default' activated.",<br/> 'Checksum:   62d964000c4ff4a5280b342cd8d95c80',<br/> 'Timestamp:  1616671116728',<br/> 'Generation: 7',<br/> '']</span></pre><h2 id="1012" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">喂养和部分更新:新闻和用户嵌入</h2><p id="2c42" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">为了让本教程易于理解，我们提供了已解析的嵌入供下载。要自己构建它们，请遵循<a class="ae lb" href="https://docs.vespa.ai/en/tutorials/news-4-embeddings.html" rel="noopener ugc nofollow" target="_blank">本教程</a>。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="16ff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们刚刚创建了<code class="fe ls lt lu lv b">user</code>模式，所以我们需要第一次输入用户数据。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="22b7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于新闻文档，我们只需要更新添加到<code class="fe ls lt lu lv b">news</code>模式中的<code class="fe ls lt lu lv b">embedding</code>字段。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="9b32" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">获取用户嵌入</h2><p id="d33b" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">接下来，我们创建一个<code class="fe ls lt lu lv b">query_user_embedding</code>函数，通过<code class="fe ls lt lu lv b">user_id</code>检索用户<code class="fe ls lt lu lv b">embedding</code>。当然，您可以使用Vespa搜索器更有效地做到这一点，如这里描述的<a class="ae lb" href="https://docs.vespa.ai/en/tutorials/news-6-recommendation-with-searchers.html" rel="noopener ugc nofollow" target="_blank"/>，但是在这一点上保持python中的所有内容会使学习更容易。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="3c0d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该函数将查询Vespa，检索嵌入内容，并将其解析为一个浮点列表。下面是用户<code class="fe ls lt lu lv b">U63195</code>嵌入的前五个元素。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><pre class="ld le lf lg gt mw lv mx my aw mz bi"><span id="02a2" class="lw lx iq lv b gy na nb l nc nd">[0.0,<br/> -0.1694680005311966,<br/> -0.0703359991312027,<br/> -0.03539799898862839,<br/> 0.14579899609088898]</span></pre><h2 id="0243" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">获取推荐</h2><h2 id="a855" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">人工神经网络搜索</h2><p id="6527" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">下面的<code class="fe ls lt lu lv b">yql</code>指示Vespa从最接近用户嵌入的十个新闻文档中选择<code class="fe ls lt lu lv b">title</code>和<code class="fe ls lt lu lv b">category</code>。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="611f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还指定，我们希望通过我们之前定义的<code class="fe ls lt lu lv b">recommendation</code> rank-profile对这些文档进行排序，并通过我们在<code class="fe ls lt lu lv b">app_package</code>中定义的查询配置文件类型<code class="fe ls lt lu lv b">ranking.features.query(user_embedding)</code>向用户发送嵌入。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="beae" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是十个回复中的前两个。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><pre class="ld le lf lg gt mw lv mx my aw mz bi"><span id="c0c5" class="lw lx iq lv b gy na nb l nc nd">[{'id': 'index:news_content/0/aca03f4ba2274dd95b58db9a',<br/>  'relevance': 0.1460561756063909,<br/>  'source': 'news_content',<br/>  'fields': {'category': 'music',<br/>   'title': 'Broadway Star Laurel Griggs Suffered Asthma Attack Before She Died at Age 13'}},<br/> {'id': 'index:news_content/0/bd02238644c604f3a2d53364',<br/>  'relevance': 0.14591827245062294,<br/>  'source': 'news_content',<br/>  'fields': {'category': 'tv',<br/>   'title': "Rip Taylor's Cause of Death Revealed, Memorial Service Scheduled for Later This Month"}}]</span></pre><h2 id="1a97" class="lw lx iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">将人工神经网络搜索与查询过滤器相结合</h2><p id="1b2a" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">Vespa ANN搜索完全集成到Vespa查询树中。这种集成意味着我们可以包含查询过滤器，人工神经网络搜索将只应用于满足过滤器的文档。无需进行涉及过滤器的预处理或后处理。</p><p id="9287" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下<code class="fe ls lt lu lv b">yql</code>搜索以<code class="fe ls lt lu lv b">sports</code>为类别的新闻文档。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="ecf4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是十个回复中的前两个。注意<code class="fe ls lt lu lv b">category</code>字段。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="mu mv l"/></div></figure><pre class="ld le lf lg gt mw lv mx my aw mz bi"><span id="51a2" class="lw lx iq lv b gy na nb l nc nd">[{'id': 'index:news_content/0/375ea340c21b3138fae1a05c',<br/>  'relevance': 0.14417346200569972,<br/>  'source': 'news_content',<br/>  'fields': {'category': 'sports',<br/>   'title': 'Charles Rogers, former Michigan State football, Detroit Lions star, dead at 38'}},<br/> {'id': 'index:news_content/0/2b892989020ddf7796dae435',<br/>  'relevance': 0.14404365847394848,<br/>  'source': 'news_content',<br/>  'fields': {'category': 'sports',<br/>   'title': "'Monday Night Football' commentator under fire after belittling criticism of 49ers kicker for missed field goal"}}]</span></pre><h1 id="517c" class="ne lx iq bd ly nf ng nh mb ni nj nk me jw nl jx mh jz nm ka mk kc nn kd mn no bi translated">结论和未来工作</h1><p id="45f6" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">我们通过在Vespa中存储用户资料，将我们的新闻搜索应用程序转变为新闻推荐应用程序。在这种情况下，用户简档被选择为由基于关于用户浏览历史的数据训练的ML模型生成的嵌入。然后，我们使用这些用户资料，根据近似最近邻搜索推荐新闻文章。未来的工作将集中在评估新闻推荐应用程序获得的结果是否符合用于生成嵌入的ML模型的预期。</p></div></div>    
</body>
</html>