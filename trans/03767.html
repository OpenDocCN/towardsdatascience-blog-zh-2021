<html>
<head>
<title>The right way of using SMOTE with Cross-validation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">交叉验证SMOTE的正确使用方法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-right-way-of-using-smote-with-cross-validation-92a8d09d00c7?source=collection_archive---------0-----------------------#2021-03-29">https://towardsdatascience.com/the-right-way-of-using-smote-with-cross-validation-92a8d09d00c7?source=collection_archive---------0-----------------------#2021-03-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0a9d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">本文讨论了在使用交叉验证时，使用SMOTE避免不准确的评估指标的正确方法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/86d2749d45a11fd2f1a84960e49c3cab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dKnQtd9IUDqXMHgKNS1qxw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片由<a class="ae kv" href="https://unsplash.com/@mitchel3uo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米切尔罗</a>在<a class="ae kv" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">上挥洒</a></p></figure><p id="9e4d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文假设读者具备SMOTE的工作知识，SMOTE是一种处理不平衡类问题的过采样技术。我们将讨论使用SMOTE的正确方法，以避免在使用交叉验证技术时出现不准确的评估指标。首先，我们将看看可能导致不准确的交叉验证指标的方法。我们将使用来自Scikit的乳腺癌数据集-了解哪些类别略有不平衡。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/5951fca3d2ed4a32a3beaff6a171061a.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/1*nJcp5Q8ZCAcbdxZfYlRsDw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">方法1</p></figure><p id="2291" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的代码片段中，我们将乳腺癌数据分成了训练集和测试集。然后，我们使用SMOTE对训练示例进行了过采样，并使用过采样的数据来训练逻辑回归模型。我们计算了交叉验证分数和测试集上的测试分数。上面的方法并不是使用SMOTE或‘imb learn’包中任何欠采样/过采样技术的正确方法。这种方法可能导致不准确的交叉验证分数，这可能与测试分数或看不见的数据上的分数有很大不同。让我们看看在使用交叉验证时使用SMOTE的正确方法。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/0d18f5f031414976e4237e7a9d88a4d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/1*FC7Xs499IcEW7hL8CfenkA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">方法2</p></figure><p id="4ba8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的代码片段中，我们使用SMOTE作为管道的一部分。此管道不是“Scikit-Learn”管道，而是“imblearn”管道。因为SMOTE没有“fit_transform”方法，所以我们不能将它与“Scikit-Learn”管道一起使用。</p><p id="c8a5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从上述两种方法的结果来看，我们看不出这两种方法的交叉验证分数有什么大的不同。然而，与第一种方法相比，第二种方法产生的交叉验证分数非常接近测试分数。这可能只是偶然发生的，也可能是因为数据集不是高度不平衡的。</p><p id="bed4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们将运行一个实验，使用“Scikit-Learn”包的“make_classification”方法生成500个具有类别不平衡的合成数据集。本实验旨在评估上述观察结果是否纯属偶然。由于我们使用的是逻辑回归，我们将确保生成的数据集中没有多重共线性。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="c6e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的代码片段中，我们定义了一个名为“model”的函数，它将输入要素(X)、类(y)和一个布尔值“smote”(指示SMOTE是否应该是管道的一部分)作为参数。我们首先将数据分为训练集和测试集，然后基于“smote”参数，我们将smote包括在管道中(如果“SMOTE”为真，SMOTE将是管道的一部分)，并计算交叉验证和测试分数。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="f5c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上述代码片段中，我们一次生成一个合成数据集，将其传递给“模型”函数，计算管道中包含和不包含SMOTE的交叉验证和测试分数，并将结果存储在数据帧中。下面，我们可以看到转置输出数据帧的快照。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lw"><img src="../Images/14789d6ed14545c9e40aef83c1f13a1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l98QqYRjfNY8fXAqS02n5A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">转置输出数据帧</p></figure><pre class="kg kh ki kj gt lx ly lz ma aw mb bi"><span id="907f" class="mc md iq ly b gy me mf l mg mh">N_SAMPLES:<br/>Number of examples in the dataset.</span><span id="a824" class="mc md iq ly b gy mi mf l mg mh">N_FEATURES:<br/>Number of input features.</span><span id="dd5a" class="mc md iq ly b gy mi mf l mg mh">N_INFORMATIVE:<br/>Number of features carrying information.</span><span id="ad26" class="mc md iq ly b gy mi mf l mg mh">CLASS_SEP:<br/>Magnitude of class separation. The higher the magnitude, the simpler would be the classification problem.</span><span id="a0f4" class="mc md iq ly b gy mi mf l mg mh">MINORITY_CLASS_WEIGHT:<br/>% of minority class samples. 0.26 means the minority class (1) forms 26% of the dataset.</span><span id="6860" class="mc md iq ly b gy mi mf l mg mh">SMOTE_IN_PIPELINE_CV_SCORE:<br/>CV score when SMOTE is included in the pipeline. This is the right way of using SMOTE.</span><span id="100d" class="mc md iq ly b gy mi mf l mg mh">SMOTE_IN_PIPELINE_TEST_SCORE:<br/>Test score or score on unseen data when SMOTE is included in the pipeline. This is the right way of using SMOTE.</span><span id="04f3" class="mc md iq ly b gy mi mf l mg mh">SMOTE_OUTSIDE_PIPELINE_CV_SCORE:<br/>CV score when SMOTE is not included in the pipeline. This is the wrong way of using SMOTE.</span><span id="f514" class="mc md iq ly b gy mi mf l mg mh">SMOTE_OUTSIDE_PIPELINE_TEST_SCORE:<br/>Test score or score on unseen data when SMOTE is not included in the pipeline. This is the wrong way of using SMOTE.</span><span id="3a0f" class="mc md iq ly b gy mi mf l mg mh">SMOTE_IN_PIPELINE_PERCENT_DIFF:<br/>The difference between the cross-validation and test score when SMOTE is included in the pipeline. This is the right way of using SMOTE.</span><span id="2df8" class="mc md iq ly b gy mi mf l mg mh">SMOTE_OUTSIDE_PIPELINE_PERCENT_DIFF:<br/>The difference between the cross-validation and test score when SMOTE is not included in the pipeline. This is the wrong way of using SMOTE.</span></pre><p id="7478" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从数据帧的上述几个记录可以看出，在大多数情况下，与“SMOTE _ OUTSIDE _ PIPELINE _ PERCENT _ DIFF”相比，“SMOTE_IN_PIPELINE_PERCENT_DIFF”非常低。我们将借助统计学来确保这些观察不是偶然的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mj"><img src="../Images/30064184933fcc5cb9288f4955e6ede8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O5lHpRzQ987KJKaljQgZHg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="8edc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的密度图显示百分比差异是偏斜的。这可能是由于数据集具有高度不平衡的类，并且模型(逻辑回归)无法正确拟合数据。现在让我们在百分比差异列中寻找异常值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mk"><img src="../Images/ecad8de71dc3bde5d350795bf5eb37c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nrARSEIdUJuUbgWVhRv82w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">百分比差异列中的异常值</p></figure><p id="2707" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以看到，当SMOTE被包括在流水线中时(‘SMOTE _ IN _ PIPELINE _ PERCENT _ DIFF’)，与SMOTE在流水线之外时(‘SMOTE _ OUTSIDE _ PIPELINE _ PERCENT _ DIFF’)相比，交叉验证和测试分数的百分比差异较低。现在，我们将删除离群值。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ml"><img src="../Images/0136860be1b7ccfd7bcc20f63db4a26d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9fkjhsD5qjLgqYGxSd7ALA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">剔除异常值后的百分比差异</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/08fbc8a6e12ec8cae5f051fa232ae624.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*s2aqRl53S4PwtnYUkXdD2Q.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">移除异常值后以百分比差异形式保留的记录</p></figure><p id="740d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在四次拟合和变换“离群点去除器”之后，离群点被完全去除。我们可以看到，在剔除异常值的过程中，只有一小部分数据会丢失。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mn"><img src="../Images/c31c3055287030e2586f11151c588256.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kCfoYxmjz0reCxBTbsan_w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">去除异常值后百分比差异的密度图</p></figure><p id="723a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从上面的密度图中，我们可以看到百分比差异柱看起来相当高斯。我们将计算平均百分比差异的置信区间(置信水平为95%)，并确保观察结果不是偶然的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mo"><img src="../Images/582bbc75c11ffffccaa590626a0e31b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*33pKp3sC7ObH0NGx69uGuQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h2 id="637a" class="mc md iq bd mp mq mr dn ms mt mu dp mv lf mw mx my lj mz na nb ln nc nd ne nf bi translated">调查的结果</h2><p id="3e3c" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">进行该实验是为了确保来自乳腺癌数据集的结果不是偶然的。我们可以看到，当SMOTE在管道之外时，交叉验证和测试分数之间的百分比差异很大。这表明在管道中包括SMOTE会导致更准确的交叉验证分数。这个实验表明来自乳腺癌数据集的观察只是偶然的。</p><h2 id="495b" class="mc md iq bd mp mq mr dn ms mt mu dp mv lf mw mx my lj mz na nb ln nc nd ne nf bi translated">限制</h2><p id="991c" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">所进行的实验有一些局限性。由于上述实验是在受控环境中进行的，因此其结果可能无法用于估计总体参数。只有在以下情况下，置信区间中的值才是准确的</p><ol class=""><li id="a9ea" class="nl nm iq ky b kz la lc ld lf nn lj no ln np lr nq nr ns nt bi translated">所选数据集具有用于进行实验的范围内的要素(即样本数量必须介于10，000和50，000之间，依此类推)。例如，你不能仅仅通过调查“20-30岁”年龄段的“女性”来估计整个人口的参数。</li><li id="78f4" class="nl nm iq ky b kz nu lc nv lf nw lj nx ln ny lr nq nr ns nt bi translated">使用的模型是逻辑回归。在这个实验中没有评估其他算法对结果的影响。因此，我们不能将这些观察结果推广到所有的算法。例如，SMOTE在管道中的位置可能不会对随机森林算法产生太大影响(如逻辑回归算法)。实验必须用多种算法进行，以排除一种算法对结果的影响。</li></ol><h2 id="793d" class="mc md iq bd mp mq mr dn ms mt mu dp mv lf mw mx my lj mz na nb ln nc nd ne nf bi translated"><strong class="ak">对未来研究的建议</strong></h2><ol class=""><li id="2655" class="nl nm iq ky b kz ng lc nh lf nz lj oa ln ob lr nq nr ns nt bi translated">通过从当前的500个样本中增加样本量并使用更多样化的数据集，可以进行类似的实验。</li><li id="d570" class="nl nm iq ky b kz nu lc nv lf nw lj nx ln ny lr nq nr ns nt bi translated">可以评估各种算法对结果的影响，以确保不同算法的观察结果不会不同。</li><li id="e7af" class="nl nm iq ky b kz nu lc nv lf nw lj nx ln ny lr nq nr ns nt bi translated">发现“少数_类_权重”和“SMOTE _ OUTSIDE _ PIPELINE _ PERCENT _ DIFF”之间的相关系数为-0.45，而“少数_类_权重”和“SMOTE_IN_PIPELINE_PERCENT_DIFF”之间的相关系数为-0.2。这表明，随着少数类的规模减小，当SMOTE在流水线之外时，交叉验证和测试分数之间的百分比差异增加。可以通过改变“MINORITY_CLASS_WEIGHT”并控制合成数据集的所有其他参数来执行类似的实验。这使我们能够在使用过采样/欠采样技术以及交叉验证技术时，直接找到少数类权重对交叉验证和测试分数之间的百分比差异的影响。</li></ol></div></div>    
</body>
</html>