<html>
<head>
<title>All public transport leads to Utrecht, not Rome</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">所有的公共交通都通向乌得勒支，而不是罗马</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/all-public-transport-leads-to-utrecht-not-rome-bb9674600e81?source=collection_archive---------38-----------------------#2021-05-28">https://towardsdatascience.com/all-public-transport-leads-to-utrecht-not-rome-bb9674600e81?source=collection_archive---------38-----------------------#2021-05-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="16a1" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="8287" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">我们都知道“条条大路通罗马”这句谚语。在这篇文章中，我会告诉你这在定义上不适用于公共交通。事实上，在荷兰，所有的公共交通都通往乌得勒支。</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/30913749859e30db8f03a66c9d2d9c9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8xlCuhcsfj17TZd7i4L-cw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">通往乌得勒支的所有公共交通路线详情(图片由作者提供)</p></figure><p id="2979" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">是的，我们都知道“条条大路通罗马”这句话。在这篇文章中，我将展示在过去的2000年里发生了很多变化。“条条大路通罗马”可能仍然是对的，但在荷兰，公共交通不是这样。都去乌得勒支，乌得勒支中央车站。有几个通往罗马的所有道路的可视化，但我将第一次向你展示公共交通前往乌得勒支。</p><p id="2e8d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">这将基于荷兰的<a class="ae ma" href="http://gtfs.ovapi.nl/nl/" rel="noopener ugc nofollow" target="_blank"> GTFS数据</a>，行程规划器<a class="ae ma" href="https://opentripplanner.org/" rel="noopener ugc nofollow" target="_blank"> OpenTripPlanner </a>和一些带有<a class="ae ma" href="https://geopandas.org/" rel="noopener ugc nofollow" target="_blank"> GeoPandas </a>和Python的魔法。这些将用于计算所有公共交通站和乌得勒支之间的路线，并绘制路线图。</p><p id="5296" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">这篇文章的完整代码可以在G <a class="ae ma" href="https://github.com/lmeulen/GTFS-Visuals" rel="noopener ugc nofollow" target="_blank"> ithub </a>上找到。</p><h2 id="5540" class="mb mc iq bd md me mf dn mg mh mi dp mj ln mk ml mm lr mn mo mp lv mq mr ms iw bi translated">计算所有到乌得勒支的路线</h2><p id="03ca" class="pw-post-body-paragraph le lf iq lg b lh mt ka lj lk mu kd lm ln mv lp lq lr mw lt lu lv mx lx ly lz ij bi translated">第一步是计算从该国所有公共交通站点到乌得勒支的所有路线。所有计划计算都使用OTP执行。OTP需要一个OpenStreetMap PBF文件，其中包含您感兴趣区域的街道和步行时间，以及GTFS的公共交通时刻表。OTP jar是从<a class="ae ma" href="https://repo1.maven.org/maven2/org/opentripplanner/otp/2.0.0/" rel="noopener ugc nofollow" target="_blank"> Maven </a>下载的。阴影部分是为了简单起见，因为它包括了所有的依赖项。OSM PBF从<a class="ae ma" href="https://download.geofabrik.de/europe/netherlands.html" rel="noopener ugc nofollow" target="_blank"> GeoFabrik </a>获得，命名为‘Netherlands-latest-osm . pbf’。GTFS从<a class="ae ma" href="http://gtfs.ovapi.nl/nl/" rel="noopener ugc nofollow" target="_blank"> OVapi </a>下载，并以zip ('gtfs-nl.zip ')格式下载。这三个文件都存储在同一个位置。</p><p id="f737" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">OTP从命令行启动:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="2548" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">它将在当前目录中找到OSM和GTFS文件，并开始构建网络图。由于规模(我们正在创建一个整个国家的地图，而不是一个单一的城市)这将需要一些时间，但最终OTP服务器启动。需要12G的堆大小才能在内存中加载网络图。要测试服务器，请尝试URL<a class="ae ma" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a>。除了web接口之外，还有一个REST API用于使用OTP-server，它将在下面的代码中使用。</p><p id="351c" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">使用所有公共交通站(公共汽车、电车、地铁、火车等)。从这些站点中的每一个计算到乌得勒支中央车站的路线。首先，编译要计算的路线集。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="7e4f" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">数据集包含起点和终点位置，其中终点位置是乌得勒支中央车站前广场的GPS位置。数据集还包含路线计算的日期和时间，这对于所有要计算的路线都是相同的，在本例中为2021年3月17日16:00。停用位置的GTFS数据集可能包含重复条目，因此这些条目将被移除以防止多余的计算。</p><p id="351e" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">荷兰的GTFS数据也包含国外的一些车站，因为这些车站可以通过国际列车到达。通过使用GeoPandas可用的国家边界来移除国家以外的这些站。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="a952" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">国家边界是从GeoPandas分布中可用的世界边界数据集获得的(第4行和第5行)。起止数据集被转换为GeoPanda(第1行和第2行)，并通过<em class="na"> sjoin </em>命令与边界数据集连接，即空间连接。该连接根据地理空间关系连接两个数据集，在这种情况下，它确定每个点是否在<em class="na"> nl </em> GeoPanda的边界内。最后，对数据集进行过滤，使其仅包含荷兰的点。</p><p id="8fb9" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><em class="na">路线</em>数据集现在被用作路线计算的输入。对于数据集中的每个条目，计算公共交通路线并将其添加到包含所有路段的数据集中(计算出的路线包含一条或多条路段):</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="f5f6" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">对于<em class="na">路线</em>数据帧中的每一行，计划请求被发送到OTP。结果是一个带有路线描述的JSON。一条路线由一条或多条线路组成。对于每个非步行(换乘)路段，路线细节被存储并添加到结果数据帧中。根据可用的硬件，此步骤需要几个小时。请耐心等待:-)</p><p id="b89d" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">大多数航段将被多条航线使用。最后两行计算每个航段的出现次数，并删除重复的航段条目。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/b06d07c43a9476de79f42d95b232fd1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*dN1vSAXLXV_xKbGaC2Mcbg.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">包含所有折线的数据框(图片由作者提供)</p></figure><h2 id="62bf" class="mb mc iq bd md me mf dn mg mh mi dp mj ln mk ml mm lr mn mo mp lv mq mr ms iw bi translated">线段的计算</h2><p id="3a6c" class="pw-post-body-paragraph le lf iq lg b lh mt ka lj lk mu kd lm ln mv lp lq lr mw lt lu lv mx lx ly lz ij bi translated">在下一步中，我们可以使用路段的起止位置，并使用GTFS数据集重建旅程。但是很方便的是，OTP返回腿的GPS轨迹作为<a class="ae ma" href="https://developers.google.com/maps/documentation/utilities/polylinealgorithm" rel="noopener ugc nofollow" target="_blank"> Google polyline </a>。解码这个字符串(lat，lon)对比基于GTFS的重建“稍微”简单，但是仍然有些麻烦。幸运的是，可以在网上找到示例实现。</p><p id="f1d6" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">所有分支都被解码成它们的底层段，其中段是(lat，lon)对。这是地图上的一条直线。将该段中的出现次数复制到段中。最后一步是合并所有相等的段，并对其出现次数求和。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="3a3e" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我们现在有一个经纬度格式的(x，y)对的数据集，其中包含该路段在<em class="na">所有</em>计划路线中的出现次数。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nc"><img src="../Images/0f1e0487058d122963867f0070c6a544.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eKjosf4mXtYu3EwRSVK-NQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">所有部分的数据框架(图片由作者提供)</p></figure><p id="3bb7" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><strong class="lg ja">标图片段</strong></p><p id="fad0" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">在我们绘制数据之前，要执行的最后一步是将<em class="na">段</em>数据帧转换为由两个点之间的<em class="na">线段</em>组成的GeoPanda数据帧。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="d547" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">最后一行将出现的<em class="na">计数</em>标准化为0到5之间的行<em class="na">宽度</em>。我们的第一个图只绘制了片段，以检查最终数据集的内容:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nd"><img src="../Images/1ce729df86afce3daa10e1c6f120bead.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nm8ELUdD1UsuKq6WjQ3Dgw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">通往乌得勒支的所有公共交通路线(图片由作者提供)</p></figure><p id="602c" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">这张图片显示了所有的公共交通路线，看起来是正确的。它很好地概述了这个国家所有的公共交通线路。观察Afsluitdijk上的总线如何令人惊讶地成为图表的一部分。从弗里斯兰的一个或多个地点出发，穿过阿夫斯卢伊特街去北荷兰会更快。从西南部(Zeeuws-Vlaanderen)开始，一些路线穿过比利时。如果我们在图像中添加一张地图，就可以清楚地看到这一点:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ne"><img src="../Images/2ea2464192d859a613703cdf76c1e9fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w7miKx8b523vhATmfmZ5QQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">所有带OpenStreetMap背景的路线(图片由作者提供)</p></figure><p id="968b" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">最后一步是使用图中线段的计算宽度。为了提高可见度，[0，5]的范围宽度减小到[0.1，2.9]。如果不采用这种方式，最粗的线条会太粗，使图像混乱，而最细的线条则不可见。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="3481" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">这是最终的结果，显示所有的公共交通确实都去了乌得勒支:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nf"><img src="../Images/c802a19db6cbc666cf224d87ffc6f5fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pZLFDfrkSO5W1Wy2x60LsA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">所有路线都通向乌得勒支(图片由作者提供)</p></figure><p id="f9d3" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">该地图显示了从该国所有公共交通站到乌得勒支中央车站的所有路线。线条的粗细表示线条服务的停靠点数量。它不代表乘客的数量，只代表停靠站的数量。但是这张地图看起来很壮观，它就像是这个国家的心血管系统。</p><p id="ae62" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated">我希望你喜欢这篇文章。要获得更多关于使用公共交通开放数据的灵感，请查看我的其他文章:</p><ul class=""><li id="5eae" class="ng nh iq lg b lh li lk ll ln ni lr nj lv nk lz nl nm nn no bi translated"><a class="ae ma" rel="noopener" target="_blank" href="/visualization-of-crowdedness-for-dutch-trains-with-kepler-f55057a3ba24">用开放数据和开普勒</a>来想象荷兰火车的拥挤</li><li id="30b3" class="ng nh iq lg b lh np lk nq ln nr lr ns lv nt lz nl nm nn no bi translated"><a class="ae ma" rel="noopener" target="_blank" href="/visualization-of-travel-times-with-otp-and-qgis-3947d3698042">使用OTP和QGIS可视化行程时间</a></li></ul><p id="86ad" class="pw-post-body-paragraph le lf iq lg b lh li ka lj lk ll kd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ij bi translated"><em class="na">免责声明:本文包含的观点和意见仅归作者所有。</em></p></div></div>    
</body>
</html>