<html>
<head>
<title>An Extensive Guide to collecting tweets from Twitter API v2 for academic research using Python 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python 3从Twitter API v2收集用于学术研究的推文的广泛指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/an-extensive-guide-to-collecting-tweets-from-twitter-api-v2-for-academic-research-using-python-3-518fcb71df2a?source=collection_archive---------0-----------------------#2021-06-13">https://towardsdatascience.com/an-extensive-guide-to-collecting-tweets-from-twitter-api-v2-for-academic-research-using-python-3-518fcb71df2a?source=collection_archive---------0-----------------------#2021-06-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="c484" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="4ff8" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">从设置、访问端点到保存以CSV格式收集的推文的一步一步的过程。</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/d3e944e8ec63379dc6c7340db7c15c14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rYQJaIzl_SsmOJp1"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@nasa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> NASA </a>在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="efa0" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">目录:</h1><ol class=""><li id="448a" class="me mf iq mg b mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">介绍</li><li id="5648" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">开始的先决条件</li><li id="8efd" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">不记名代币</li><li id="f261" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">创建标题</li><li id="5189" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">创建URL</li><li id="2a78" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">连接到端点</li><li id="87e8" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">把所有的放在一起</li><li id="01d4" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">将结果保存到CSV</li><li id="4e06" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">循环请求</li></ol><h1 id="73c2" class="lm ln iq bd lo lp nb lr ls lt nc lv lw kf nd kg ly ki ne kj ma kl nf km mc md bi translated">1.介绍</h1><p id="a768" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">2020年底，Twitter推出了全新构建的Twitter API。Twitter API v2提供了更多您可以提取和分析的特性和数据、新的端点和许多功能。</p><p id="151b" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">随着新API的引入，Twitter也为学术界引入了一个新的强大的免费产品:<a class="ae le" href="https://developer.twitter.com/en/solutions/academic-research" rel="noopener ugc nofollow" target="_blank">学术研究产品track </a>。</p><p id="dc18" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">该路线允许免费访问完整存档搜索和其他v2端点，每月的推文量上限为10，000，000条！如果你想知道你是否有资格进入赛道，请查看这个<a class="ae le" href="https://developer.twitter.com/en/solutions/academic-research/application-info" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><p id="b879" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">我最近在卡耐基梅隆大学从事一个数据分析研究项目，利用本专题提供的能力，作为一名研究人员，它给你的力量是令人兴奋的！</p><p id="edc5" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">然而，由于API的v2是相当新的，如果您在收集数据进行研究的过程中遇到问题，那么存在的资源会更少。</p><p id="c4f8" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">因此，在本文中，我将一步一步地介绍从设置、访问端点到保存以CSV格式收集的tweets以供将来分析使用的过程。</p><p id="e252" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">本文将使用仅适用于学术研究跟踪的端点(<a class="ae le" href="https://developer.twitter.com/en/docs/twitter-api/tweets/search/api-reference/get-tweets-search-all" rel="noopener ugc nofollow" target="_blank">全存档搜索</a>端点)，但是本指南中的几乎所有内容都可以应用于适用于所有开发人员帐户的任何其他端点。</p><p id="2327" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">如果您没有访问完全存档搜索端点的权限，您仍然可以使用<a class="ae le" href="https://developer.twitter.com/en/docs/twitter-api/tweets/search/api-reference/get-tweets-search-recent" rel="noopener ugc nofollow" target="_blank">最近搜索</a>端点来遵循本教程。</p><p id="1a0b" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">建议您在阅读本文时使用Jupyter笔记本，这样每个代码片段都可以在单独的单元格中运行。</p></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="6888" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">2.启动的先决条件</h1><p id="b96d" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">首先，我们将为本指南导入一些基本的库:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="816c" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">为了能够向Twitter API发送您的第一个请求，您需要有一个开发人员帐户。如果你还没有，可以在这里申请一个<a class="ae le" href="https://developer.twitter.com/en/apply-for-access" rel="noopener ugc nofollow" target="_blank">！<strong class="mg ja"> <em class="oa">(别担心，这是免费的，你只需要提供一些你打算从事的研究的信息)</em> </strong></a></p><p id="bff3" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">获得批准的开发者帐户了吗？<strong class="mg ja">太棒了！</strong></p><p id="d222" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">你所需要做的就是创建一个项目，并通过开发者门户连接一个应用程序，我们就可以开始了！</p><ol class=""><li id="00e5" class="me mf iq mg b mh nt mj nu ml ob mn oc mp od mr ms mt mu mv bi translated">转到<a class="ae le" href="https://developer.twitter.com/en/portal/dashboard" rel="noopener ugc nofollow" target="_blank">开发者门户仪表板</a></li><li id="dc4c" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">使用您的开发者帐户登录</li><li id="fdd0" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">创建一个新项目，给它一个名字，一个基于你想要实现的目标的用例，以及一个描述。</li></ol><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oe"><img src="../Images/9cae313ccc430bdda52e4609a7d1ba67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fp3nE3p7oUlVjk3H_9AySg.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">新项目页面截图</p></figure><p id="92a3" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">4.假设这是你第一次使用，请选择“创建新应用”并为你的应用命名，以便创建新应用。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oe"><img src="../Images/331b3955e0b6c97cadb91f3e63ae6358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4KszDqncuuCoXq3PzNwUkQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">为你的应用程序选择一个名称</p></figure><p id="fc1e" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">如果一切顺利，您应该能够看到包含您的密钥和令牌的页面，我们将使用其中一个来访问API。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oe"><img src="../Images/261014017ac3c5db3e3e48359c2ec2b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y20zm9Vf1k5uRMRTMkHRkQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">图片也取自Twitter开发团队创建的<a class="ae le" href="https://developer.twitter.com/en/docs/tutorials/step-by-step-guide-to-making-your-first-request-to-the-twitter-api-v2" rel="noopener ugc nofollow" target="_blank">这个</a>分步指南。</p></figure></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="55ee" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">3.不记名令牌</h1><p id="8803" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">如果你已经走到这一步，<strong class="mg ja">恭喜你！</strong>您有资格从API发送您的第一个请求:)</p><p id="da58" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">首先，我们将创建一个<strong class="mg ja"> auth() </strong>函数，该函数将具有来自我们刚刚创建的应用程序的“不记名令牌”。</p><p id="34d9" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">由于这个不记名令牌是敏感信息，你不应该与任何人分享它。如果你和一个团队一起工作，你不希望任何人能接触到它。</p><p id="7ffa" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">因此，我们将把令牌保存在一个“环境变量”中。</p><p id="e7f6" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">有很多方法可以做到这一点，你可以看看这两个选项:</p><blockquote class="of og oh"><p id="811a" class="ng nh oa mg b mh nt ka ni mj nu kd nj oi nv nl nm oj nw no np ok nx nr ns mr ij bi translated"><a class="ae le" href="https://www.youtube.com/watch?v=ecshCQU6X2U" rel="noopener ugc nofollow" target="_blank"> <em class="iq">环境变量。env与Python</em></a><em class="iq"><br/></em><a class="ae le" href="https://www.nylas.com/blog/making-use-of-environment-variables-in-python/" rel="noopener ugc nofollow" target="_blank"><em class="iq">利用Python </em> </a>中的环境变量</p></blockquote><p id="1cf0" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">在本文中，我们将在代码中运行这一行来设置一个<strong class="mg ja"> "TOKEN" </strong>变量:</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="294e" class="oq ln iq om b gy or os l ot ou">os.environ['TOKEN'] = '&lt;ADD_BEARER_TOKEN&gt;'</span></pre><p id="57dd" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">只需将Twitter上的<strong class="mg ja"><em class="oa">&lt;ADD _ BEARER _ TOKEN&gt;</em></strong>替换为您的不记名令牌，运行该函数后，删除这两行。如果这种方法有任何错误，请尝试上面列出的任何链接。</p><p id="a160" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">现在，我们将创建我们的<strong class="mg ja"> auth() </strong>函数，它从环境中检索令牌。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="c718" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">4.创建标题</h1><p id="b61b" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">接下来，我们将定义一个函数，它将获取我们的承载令牌，传递它以进行授权，并返回我们将用来访问API的头。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="5cdf" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">5.创建URL</h1><p id="ad34" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">现在我们可以访问API了，我们将为将要使用的端点和要传递的参数构建请求。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="e90a" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">上面定义的函数包含两部分:</p><h2 id="c085" class="oq ln iq bd lo ov ow dn ls ox oy dp lw ml oz pa ly mn pb pc ma mp pd pe mc iw bi translated">A.搜索_url:</h2><p id="da5a" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">这是我们想要访问的端点的链接。</p><p id="6a20" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">Twitter的API有很多不同的端点，下面是在撰写本文时可以提前访问的端点列表:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pf"><img src="../Images/58821d57bd3106e548362f83e83df9c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1oJExGGK151WfQJ6LIikww.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">撰写本文时存在的一些早期访问端点</p></figure><p id="a2b2" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">您还可以在这个<a class="ae le" href="https://developer.twitter.com/en/docs/twitter-api/early-access" rel="noopener ugc nofollow" target="_blank">链接</a>中找到关于每个端点的完整列表和更多信息。</p><p id="d3e2" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">对于这篇文章，因为它是针对可能试图从Twitter的新产品中受益的学术研究人员，我们将使用<strong class="mg ja"> <em class="oa">全存档搜索端点</em> </strong>。</p><h2 id="fb44" class="oq ln iq bd lo ov ow dn ls ox oy dp lw ml oz pa ly mn pb pc ma mp pd pe mc iw bi translated">B.查询参数:</h2><p id="539d" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">端点提供的参数，我们可以使用这些参数来定制我们想要发送的请求。</p><p id="951e" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">每个端点都有不同的参数，我们可以传递给它，当然，Twitter的文档中有每个端点的API引用！</p><p id="96c1" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">例如，对于我们在本文中使用的全存档搜索端点，您可以在这里的<a class="ae le" href="https://developer.twitter.com/en/docs/twitter-api/tweets/search/api-reference/get-tweets-search-all" rel="noopener ugc nofollow" target="_blank"> API参考页面</a>的<strong class="mg ja">“查询参数”</strong>部分下找到查询参数列表。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi pg"><img src="../Images/fa96cb0b70edbfe55012b2ee71ef7661.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ex1pG3yTXHc6b_dXDvnUoQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">完整归档端点API文档中的查询参数示例屏幕截图</p></figure><p id="c0cc" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">我们可以将上面函数中的查询参数分解为三个部分:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ph"><img src="../Images/d65ffca5bf4efc3f3d546ba28bfef406.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QRWYgDoxAZTmRb7gSf1PDw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">该端点参数的简单分解</p></figure><p id="8425" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">1.前4个参数是我们控制的参数</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="b639" class="oq ln iq om b gy or os l ot ou">'query':        keyword,<br/>'start_time':   start_date,<br/>'end_time':     end_date,<br/>'max_results':  max_results,</span></pre><p id="f377" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">2.接下来的4个参数基本上是我们指示端点返回更多信息，这些信息是可选的，默认情况下不会返回。</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="ecdd" class="oq ln iq om b gy or os l ot ou">'expansions':   'author_id,in_reply_to_user_id,geo.place_id',<br/>'tweet.fields': 'id,text,author_id,in_reply_to_user_id,geo,conversation_id,created_at,lang,public_metrics,referenced_tweets,reply_settings,source',<br/>'user.fields':  'id,name,username,created_at,description,public_metrics,verified',<br/>'place.fields': 'full_name,id,country,country_code,geo,name,place_type',</span></pre><p id="ddae" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">3.最后，“next_token”参数用于获取下一页结果。参数中使用的值直接从API提供的响应中提取。如果存在比每个请求的上限更多的结果，我们将在本文中对此进行更多的讨论。</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="cc13" class="oq ln iq om b gy or os l ot ou">'next_token': {}</span></pre><p id="864e" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">现在我们知道了create_url函数的作用，有几个重要的注意事项:</p><ul class=""><li id="6ef8" class="me mf iq mg b mh nt mj nu ml ob mn oc mp od mr pi mt mu mv bi translated"><strong class="mg ja">所需端点:</strong></li></ul><p id="e64d" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">在全存档搜索端点的情况下，*query*参数是发出请求**所需* *的唯一参数。请务必查看您正在使用的端点的文档，以确认哪些参数必须存在，这样您就不会遇到问题。</p><ul class=""><li id="aa5e" class="me mf iq mg b mh nt mj nu ml ob mn oc mp od mr pi mt mu mv bi translated"><strong class="mg ja">查询参数:</strong></li></ul><p id="649d" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated"><strong class="mg ja">查询</strong>参数是您放置想要搜索的关键字的地方。</p><p id="4df2" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">查询可以简单到搜索包含单词“xbox”的tweet，也可以复杂到(xbox europe)或(xbox usa)，返回包含单词xbox AND europe或xbox AND usa的tweet。</p><p id="e627" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">此外，可以使用*搜索运算符*定制*查询*。有很多选项可以帮助你缩小搜索结果的范围。我们有望在另一篇文章中更深入地讨论操作符。现在，你可以在这里找到构建查询操作符的完整列表<a class="ae le" href="https://developer.twitter.com/en/docs/twitter-api/tweets/search/integrate/build-a-query" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="473a" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">带有操作符的简单查询示例:<strong class="mg ja"> <em class="oa"> "xbox lang:en" </em> </strong></p><ul class=""><li id="74e1" class="me mf iq mg b mh nt mj nu ml ob mn oc mp od mr pi mt mu mv bi translated"><strong class="mg ja">时间戳:</strong></li></ul><p id="deff" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">Twitter用于时间戳的<em class="oa">结束时间</em>和<em class="oa">开始时间</em>格式是</p><p id="3f95" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated"><strong class="mg ja">YYYY-MM-DDTHH:MM:ssZ(ISO 8601/RFC 3339)</strong></p><p id="a5ad" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">所以一定要把日期转换成这种格式。如果你不确定如何做，这是一个很好的<a class="ae le" href="https://www.timestamp-converter.com/" rel="noopener ugc nofollow" target="_blank">时间戳转换器</a>一定会有帮助。</p><ul class=""><li id="7ee1" class="me mf iq mg b mh nt mj nu ml ob mn oc mp od mr pi mt mu mv bi translated"><strong class="mg ja">成绩卷:</strong></li></ul><p id="cacc" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">一个请求返回的搜索结果数量目前限制在10到500个结果之间。</p><p id="5384" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">现在你可能会问，我怎么能得到超过500个结果呢？这就是*next_token*和分页发挥作用的地方！</p><blockquote class="of og oh"><p id="bb0c" class="ng nh oa mg b mh nt ka ni mj nu kd nj oi nv nl nm oj nw no np ok nx nr ns mr ij bi translated">答案很简单:如果您的查询存在更多结果，Twitter将返回一个唯一的<strong class="mg ja"> next_token </strong>，您可以在下一次请求中使用它，它将为您提供新的结果。</p><p id="e68c" class="ng nh oa mg b mh nt ka ni mj nu kd nj oi nv nl nm oj nw no np ok nx nr ns mr ij bi translated">如果您想要检索您的查询中存在的所有tweet，您只需使用每次收到的新*next_token*不断发送请求，直到不存在<strong class="mg ja"> next_token </strong>为止，这表明您已经检索了所有tweet！</p></blockquote><p id="359b" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">希望你不会感到太困惑！但是不要担心，当我们运行我们刚刚创建的所有函数时，就会很清楚了！</p></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="5e7e" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">6.连接到端点</h1><p id="a67e" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">现在我们已经有了想要的URL、头和参数，我们将创建一个函数将所有这些放在一起并连接到端点。</p><p id="4eda" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">下面的函数将发送“GET”请求，如果一切都正确(响应代码200)，它将以“JSON”格式返回响应。</p><p id="b22c" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated"><strong class="mg ja">注意:</strong> <strong class="mg ja"> <em class="oa"> next_token </em> </strong>默认设置为<strong class="mg ja">【无】</strong>，因为我们只关心它是否存在。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="7af8" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">7.把所有的放在一起</h1><p id="188d" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">现在我们已经有了所有需要的函数，让我们测试一下把它们放在一起创建我们的第一个请求！</p><p id="b642" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">在下一个单元格中，我们将设置我们的输入:</p><ul class=""><li id="1430" class="me mf iq mg b mh nt mj nu ml ob mn oc mp od mr pi mt mu mv bi translated">来自API的bearer_token和headers。</li><li id="8030" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr pi mt mu mv bi translated">我们将寻找包含单词“xbox”的英语推文。</li><li id="13d6" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr pi mt mu mv bi translated">我们将寻找2021年3月1日至31日之间的推文。</li><li id="4a0f" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr pi mt mu mv bi translated">我们只想最多返回15条推文。</li></ul><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="1e44" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">现在我们将创建URL并从API获得响应。</p><p id="b12e" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">Twitter API返回的响应以JavaScript对象符号“JSON”格式返回。<br/>为了能够处理它并分解我们得到的响应，我们将使用我们之前导入的python的编码器和解码器。你可以在这里找到更多关于库<a class="ae le" href="https://docs.python.org/3/library/json.html" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="feb2" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">如果从以下代码返回的响应是<strong class="mg ja"> <em class="oa"> 200 </em> </strong>，则请求成功。</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="36c9" class="oq ln iq om b gy or os l ot ou">url <strong class="om ja">=</strong> create_url(keyword, start_time,end_time, max_results)</span><span id="976a" class="oq ln iq om b gy pj os l ot ou">json_response <strong class="om ja">=</strong> connect_to_endpoint(url[0], headers, url[1])</span></pre><p id="1e1e" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">让我们使用这个JSON库函数以可读的格式打印响应</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="0803" class="oq ln iq om b gy or os l ot ou">print(json.dumps(json_response, indent=4, sort_keys=True))</span></pre><p id="b9d2" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">现在让我们来分解返回的JSON响应，响应基本上是作为Python字典读取的，键要么包含数据，要么包含更多字典。最上面的两个键是:</p><h2 id="2200" class="oq ln iq bd lo ov ow dn ls ox oy dp lw ml oz pa ly mn pb pc ma mp pd pe mc iw bi translated">A.数据:</h2><p id="3661" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">字典列表，每个字典代表一条推文的数据。如何检索第一条推文创建时间的示例:</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="2f7a" class="oq ln iq om b gy or os l ot ou">json_response['data'][0]['created_at']</span></pre><h2 id="ca3d" class="oq ln iq bd lo ov ow dn ls ox oy dp lw ml oz pa ly mn pb pc ma mp pd pe mc iw bi translated">B.元:</h2><p id="d6c6" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">关于我们发送的请求的属性字典，我们通常只关心字典中的两个键，<strong class="mg ja"> next_token </strong>和<strong class="mg ja"> result_count </strong>。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ph"><img src="../Images/6dde36de51d598a1283be48701baed16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P3Iyp1QBD2FaGs0KHs7EKw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">对两个键中数据的解释</p></figure><p id="5c91" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">例如，要检索next_token，您可以编写:</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="4e3a" class="oq ln iq om b gy or os l ot ou">json_response['meta']['result_count']</span></pre><p id="d3c3" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">现在，我们有两个选项来保存结果，这取决于我们希望如何处理数据，我们可以将结果保存为我们收到的相同的JSON格式，或者保存为CSV格式。<br/>要在JSON中保存结果，我们可以使用这两行代码轻松完成:</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="60f4" class="oq ln iq om b gy or os l ot ou">with open('data.json', 'w') as f:<br/>    json.dump(json_response, f)</span></pre></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="0d62" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">8.将结果保存到CSV</h1><p id="24f3" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">您可能会问自己，为什么我们要将结果保存为CSV格式？简而言之，与JSON对象相比，CSV是一种广泛使用的格式，可以很容易地导入Excel电子表格、数据库或数据可视化软件。</p><p id="a01f" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">现在，要将结果保存为CSV格式的表格，有两种方法，一种简单的方法和一种更加定制的方法。</p><p id="8618" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">嗯… <strong class="mg ja">如果有一个通过Python库的简单方法，为什么我们需要自定义方法呢？</strong></p><p id="40f0" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">答案是:自定义函数将使我们将一些返回结果中嵌入的字典分解并精简到单独的列中，使我们的分析任务更容易。</p><p id="c77c" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">例如，公共指标关键字:</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="e9b8" class="oq ln iq om b gy or os l ot ou">"public_metrics": {<br/>                    "like_count": 0,<br/>                    "quote_count": 0,<br/>                    "reply_count": 0,<br/>                    "retweet_count": 0<br/>                  },</span></pre><p id="8e9c" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">该键返回另一个字典，简单的方法是将该字典保存在一个CSV列下，而在自定义方法中，我们可以在将数据保存到CSV之前将每个字典分成不同的列。</p><h2 id="33d3" class="oq ln iq bd lo ov ow dn ls ox oy dp lw ml oz pa ly mn pb pc ma mp pd pe mc iw bi translated">A.简单的方法是:</h2><p id="910f" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">对于这种方法，我们将使用熊猫包</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="361c" class="oq ln iq om b gy or os l ot ou">df = pd.DataFrame(response['json_response'])<br/>df.to_csv('data.csv')</span></pre><p id="5de0" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">这是基于推特开发团队关于这个主题的博客文章的内容，我尝试了这个方法，它在简单的查询下运行得很好。</p><h2 id="8e1d" class="oq ln iq bd lo ov ow dn ls ox oy dp lw ml oz pa ly mn pb pc ma mp pd pe mc iw bi translated">B.定制方法:</h2><p id="bc06" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">首先，我们将创建一个带有我们想要的列标题的CSV文件，我们将与我们的实际函数分开进行，这样以后它就不会干扰对请求的循环。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="d6ed" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">然后，我们将创建我们的<strong class="mg ja"> append_to_csv </strong>函数，我们将把响应和期望的文件名输入到该函数中，并且该函数将把我们收集的所有数据附加到csv文件中。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="31c4" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">现在，如果我们在最后一次调用中运行append_to_csv()函数，我们应该有一个包含15条推特的文件(或者更少，这取决于您的查询)</p><pre class="kp kq kr ks gt ol om on oo aw op bi"><span id="a0b4" class="oq ln iq om b gy or os l ot ou">append_to_csv(json_response, "data.csv")</span></pre></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="12ff" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated">9.循环请求</h1><p id="ed94" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">干得好！我们已经发送了第一个请求，并保存了第一个回复。</p><p id="0d84" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated"><strong class="mg ja">现在，如果我们想保存更多的回复，该怎么办？</strong>除了推特给我们的前500个结果之外，或者如果我们想在特定时期自动获得推特。为此，我们将使用循环和从Twitter接收的next_token变量。</p><p id="cd55" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">让我们想想这个案例:</p><p id="e2bf" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">我们想收集2020年包含“新冠肺炎”一词的推特，分析人们在推特上谈论病毒时的情绪。可能有数百万条推特，我们每个月只能收集1000万条推特。</p><p id="1d6f" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">如果我们只是在2020年1月1日至2020年12月31日之间发送收集推特的请求，我们将很快达到上限，而不会在12个月内得到很好的分布。</p><p id="e6a6" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">因此，我们可以做的是，我们可以设定我们希望每月收集的推特数量的限制，这样，如果我们在某个月达到了特定的上限，我们就可以进入下一个月。</p><p id="de77" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">下面的代码就是一个例子，它将完全做到这一点！下面的代码块由两个循环组成:</p><ol class=""><li id="0ef0" class="me mf iq mg b mh nt mj nu ml ob mn oc mp od mr ms mt mu mv bi translated">我们希望覆盖的月/周/日内的For循环(取决于设置方式)</li><li id="2979" class="me mf iq mg b mh mw mj mx ml my mn mz mp na mr ms mt mu mv bi translated">一个While-loop，控制每个时间段我们希望收集的最大推特数量。</li></ol><p id="8c4d" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">请注意，在调用之间添加了<strong class="mg ja"> time.sleep() </strong>，以确保您不只是向API发送请求。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ny nz l"/></div></figure></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><h1 id="9456" class="lm ln iq bd lo lp lq lr ls lt lu lv lw kf lx kg ly ki lz kj ma kl mb km mc md bi translated"><strong class="ak">总结</strong></h1><p id="e117" class="pw-post-body-paragraph ng nh iq mg b mh mi ka ni mj mk kd nj ml nk nl nm mn nn no np mp nq nr ns mr ij bi translated">在本文中，我们已经通过了一个广泛的逐步过程，使用Python从用于学术研究的Twitter API v2收集Tweets。</p><p id="46e7" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">我们已经涵盖了所需的先决条件，身份验证，创建请求和向搜索/所有端点发送请求，最后以不同的格式保存响应。</p><p id="cabe" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">如果你喜欢这个，请随时通过Twitter和LinkedIn与你的朋友和同事分享！</p><p id="612b" class="pw-post-body-paragraph ng nh iq mg b mh nt ka ni mj nu kd nj ml nv nl nm mn nw no np mp nx nr ns mr ij bi translated">请随时在LinkedIn上与我联系，或者在T2的Twitter上关注我！</p></div></div>    
</body>
</html>