<html>
<head>
<title>How to Define and Deploy Infrastructure with Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用代码定义和部署基础设施</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-define-and-deploy-infrastructure-with-code-c5af4bddc566?source=collection_archive---------37-----------------------#2021-06-01">https://towardsdatascience.com/how-to-define-and-deploy-infrastructure-with-code-c5af4bddc566?source=collection_archive---------37-----------------------#2021-06-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e176" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Pulumi是Terraform和CloudFormation的替代产品，它允许您使用自己喜欢的编码语言定义AWS(以及其他服务，如Azure和GCP)服务。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a9145396b4bf4d85725f7c363c3617f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*4uHnGcDBHzCUJHci6xIuaw.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">探索Pulumi CLI</p></figure><h1 id="6f8b" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">普鲁米简介</h1><p id="f13b" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">Pulumi允许您通过结合IaaS(基础设施即服务)的<em class="mj">安全性</em>和<em class="mj">可靠性</em>以及您所熟悉的编程语言的能力来构建云应用和基础设施。您可以使用自己选择的编程语言来定义基础设施，使用循环、条件和函数，并在不同的项目中重用这些设计模式，而不是使用JSON、YAML或定制的IaaS语言来定义基础设施。例如，下面是我们如何使用Terraform HashiCorp配置语言创建一个带有已分配安全组的EC2实例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Terraform:使用分配的安全组创建Ubuntu 18.04实例</p></figure><p id="a7b0" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">相比之下，下面是我们如何使用Pulumi JavaScript AWS API完成类似的任务:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Pulumi (AWS JS API):使用分配的安全组创建一个Ubuntu 18.04实例</p></figure><p id="21b9" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">如您所见，使用Terraform和Pulumi创建资源的总体逻辑是相似的。您可以过滤正确的Amazon机器映像，定义符合您的用例的定制安全组，将标记应用到您的资源，并基于这些ami和安全组定义服务器。主要区别在于创建资源的语言，对于您的用例来说，最好的工具可能取决于您对<strong class="lp ir"> HashiCorp配置语言</strong>或<strong class="lp ir"> JSON </strong> (Terraform)以及更多通用编码语言的熟悉程度，如<strong class="lp ir"> Python </strong>、<strong class="lp ir"> JavaScript </strong>、<strong class="lp ir"> Go </strong>和<strong class="lp ir"> C# </strong> (Pulumi)。</p><h1 id="e974" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">问题的介绍</h1><p id="23c8" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">作为一名软件工程顾问，很多时候我需要为公司部署一次性项目(供内部或外部使用)。在这些部署过程中，我通常会重复相同的过程:</p><ol class=""><li id="4599" class="mr ms iq lp b lq mm lt mn lw mt ma mu me mv mi mw mx my mz bi translated">创建一个<strong class="lp ir">临时</strong>服务器，</li><li id="0148" class="mr ms iq lp b lq na lt nb lw nc ma nd me ne mi mw mx my mz bi translated">创建一个<strong class="lp ir">生产</strong>服务器，</li><li id="44f1" class="mr ms iq lp b lq na lt nb lw nc ma nd me ne mi mw mx my mz bi translated">在两台服务器上安装必要的依赖项，</li><li id="5dde" class="mr ms iq lp b lq na lt nb lw nc ma nd me ne mi mw mx my mz bi translated">允许<strong class="lp ir">准备</strong>和<strong class="lp ir">生产</strong>服务器相互连接，</li><li id="8721" class="mr ms iq lp b lq na lt nb lw nc ma nd me ne mi mw mx my mz bi translated">并为部署配置生产环境</li></ol><p id="702b" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">以前，我会用AWS命令行或AWS EC2 web界面逐一完成这些步骤。但是，在我第二次手动完成这些任务后，我决定投入时间学习<em class="mj">云形成</em>、<em class="mj">地形</em>和<em class="mj">普鲁米</em>。在意识到Pulumi提供了最少的入门障碍(因为与JSON和YAML相比，我更熟悉JavaScript和Python)之后，我决定使用它来自动化这些重复的部署过程。</p><h1 id="e340" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">我如何使用Pulumi来解决这些问题</h1><p id="34f5" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在阅读了pulumi的AWS文档和一些教程之后，我安装了Pulumi命令行工具:</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="d283" class="nk kw iq ng b gy nl nm l nn no"><strong class="ng ir">brew install pulumi</strong> # mac</span></pre><p id="5d05" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">然后为这个项目创建了一个目录，换成它，并运行:</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="e244" class="nk kw iq ng b gy nl nm l nn no"><strong class="ng ir">pulumi new aws-javascript </strong><br/># aws tells pulumi we want to use the AWS Pulumi API<br/># javascript tells pulumi we want to use the JS AWS API</span></pre><p id="440d" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">最后，编写代码前的最后一步是确保设置了正确的AWS概要文件。要配置AWS概要文件，请运行:</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="230f" class="nk kw iq ng b gy nl nm l nn no">aws configure --profile "[name for profile]"</span></pre><p id="0604" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">然后，输入正确的<strong class="lp ir">访问密钥ID </strong>和<strong class="lp ir">秘密访问密钥</strong>并运行:</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="6d2b" class="nk kw iq ng b gy nl nm l nn no">aws use [name for profile]</span></pre><p id="e017" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">为项目选择正确的AWS概要文件。从这里，打开<strong class="lp ir"> index.js </strong>并开始定义您的基础设施。对于我的具体用例，我想创建两个服务器，一个用于<em class="mj">试运行</em>，另一个用于<em class="mj">生产</em>。我还希望它们存在于同一个VPC中，具有相同的安全组。为了实现这一愿景，我将代码分成了四个部分:</p><h2 id="9d2d" class="nk kw iq bd kx np nq dn lb nr ns dp lf lw nt nu lh ma nv nw lj me nx ny ll nz bi translated">1.从pulumi访问配置变量</h2><p id="a217" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">类似于为项目创建环境变量，<em class="mj"> pulumi配置变量</em>允许您定义可以在pulumi脚本中访问的特定于项目的值。对于我的具体用例，我想对<strong class="lp ir"> PEM </strong>文件的名称保密，所以我使用以下命令创建了一个<strong class="lp ir"> keyName </strong>配置变量:</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="fc99" class="nk kw iq ng b gy nl nm l nn no"><strong class="ng ir">pulumi config set keyName [name_of_PEM_file]</strong></span></pre><p id="2f42" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">有了这个配置变量集，我就可以在我的pulumi脚本中访问分配给<strong class="lp ir"> keyName </strong>的值，使用:</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="b77f" class="nk kw iq ng b gy nl nm l nn no"><strong class="ng ir">const pulumi = require("@pulumi/pulumi");<br/>const config = new pulumi.Config();<br/>const keyName = config.get("keyName");</strong></span></pre><h2 id="1845" class="nk kw iq bd kx np nq dn lb nr ns dp lf lw nt nu lh ma nv nw lj me nx ny ll nz bi translated">2.过滤并检索正确的AMI ID</h2><p id="867c" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在这之后，我需要过滤Amazon机器映像注册表，找到我想要创建的服务器的<strong class="lp ir"> AMI名称</strong>和<strong class="lp ir">所有者</strong>。对于这个项目，鉴于我想使用Ubuntu 18.04，我采取了以下步骤:</p><ul class=""><li id="a989" class="mr ms iq lp b lq mm lt mn lw mt ma mu me mv mi oa mx my mz bi translated">导航到<a class="ae ob" href="https://console.aws.amazon.com/ec2/v2/" rel="noopener ugc nofollow" target="_blank"> AWS EC2主页</a>，点击<strong class="lp ir">实例</strong>，然后点击<strong class="lp ir">启动实例</strong></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/2288e5c9772156071f1709d8aa6b2f54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lLsQlRZ4HnxzIo0xkG8AfA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">AWS EC2例程页</p></figure><ul class=""><li id="2eea" class="mr ms iq lp b lq mm lt mn lw mt ma mu me mv mi oa mx my mz bi translated">滚动到您想要创建的实例，复制<strong class="lp ir"> AMI ID </strong></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/f29587a70a66e06c8a0f1a723b7a0be0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aXaxqq1YR4Xk0CNOoqwZWA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><strong class="bd od">Ubuntu 18.04的AMI ID </strong></p></figure><ul class=""><li id="7656" class="mr ms iq lp b lq mm lt mn lw mt ma mu me mv mi oa mx my mz bi translated">导航回EC2仪表板主页面，点击左侧边栏<strong class="lp ir">图片</strong>部分下的<strong class="lp ir"> AMIs </strong>。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/b6647d1f01341a291f0d142fdb014ef0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6IkkasWyC3oajY__83LjVw.png"/></div></div></figure><ul class=""><li id="5ae6" class="mr ms iq lp b lq mm lt mn lw mt ma mu me mv mi oa mx my mz bi translated">在搜索栏中，粘贴您复制的<strong class="lp ir"> AMI ID </strong>，并记下<strong class="lp ir"> AMI Name </strong>和<strong class="lp ir"> Owner </strong>的值。您将需要这两个值来过滤pulumi中的正确AMI。</li></ul><p id="5948" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">有了<strong class="lp ir"> AMI名称</strong>和<strong class="lp ir"> AMI所有者</strong>之后，您可以将这两个值输入到您的脚本中，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">过滤正确的AMI: Ubuntu 18.04</p></figure><h2 id="5f20" class="nk kw iq bd kx np nq dn lb nr ns dp lf lw nt nu lh ma nv nw lj me nx ny ll nz bi translated">3.定义服务器的安全组，包括入站和出站规则</h2><p id="bee7" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在正确筛选出正确的AMI ID后，您可以为您的服务器定义安全组。以下脚本提供了一个简单的例子:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="bb06" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">在第一行，我们将我们的安全组命名为<strong class="lp ir"> 3dvation-grp </strong>。然后，我们定义入站(<em class="mj">入口</em>)和出站(<em class="mj">出口</em>)规则。在第3–9行，我们提供了入站规则的描述，定义了其协议，提供了一系列端口，最后定义了允许该入站规则的IP地址。然后，在第12–27行，我们定义了两个出站规则:</p><ol class=""><li id="91e6" class="mr ms iq lp b lq mm lt mn lw mt ma mu me mv mi mw mx my mz bi translated">允许临时服务器ssh到生产服务器的出站规则(通过端口22 ssh)</li><li id="0803" class="mr ms iq lp b lq na lt nb lw nc ma nd me ne mi mw mx my mz bi translated">允许克隆GitHub库的出站规则(端口43上的HTTPS，CIDR块基于来自<a class="ae ob" href="https://api.github.com/meta" rel="noopener ugc nofollow" target="_blank">api.github.com/meta</a>的<strong class="lp ir"> git </strong>结果)。</li></ol><p id="5428" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">总之，这些入站和出站规则为我们的两个实例提供了这个特定用例所需的所有功能。</p><h2 id="4cbe" class="nk kw iq bd kx np nq dn lb nr ns dp lf lw nt nu lh ma nv nw lj me nx ny ll nz bi translated">4.定义和创建试运行和生产EC2实例</h2><p id="8a50" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">最后，在定义了安全组之后，我们使用以下代码创建了临时服务器和生产服务器:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="e51c" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">在第2行和第9行，我们将<strong class="lp ir">serverSize</strong>("<em class="mj">T2 . micro "</em>)常量赋给<strong class="lp ir"> instanceType </strong>键。在第3行和第10行，我们将新创建的安全组的ID分配给两台服务器(确保它们存在于同一个组中)。然后，在第4行和第11行，我们定义了可以用来访问每个服务器的<strong class="lp ir"> PEM </strong>文件的名称，在第5行和第12行，我们分配了应该用来创建每个服务器的AMI的ID。</p><p id="76bf" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">完成这些步骤后，您可以运行:</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="afa5" class="nk kw iq ng b gy nl nm l nn no">pulumi up</span></pre><p id="7817" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">部署更改并创建临时服务器和生产服务器。一旦这个过程成功完成，您就可以登录AWS并看到您的两个新服务器！</p><h1 id="bf78" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">审查和成果</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/7bb015a8c7ef64f8201f16102d9262c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6UITr6S7DwV052ulZ60c4Q.png"/></div></div></figure><p id="c09a" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">在本文中，我们了解了Pulumi及其相对于AWS CloudFormation和Terraform等其他IaaS提供商的一些优势。我们经历了一个实际的用例，在这个用例中，我们为两台服务器创建了一个VPC，定义了安全组的入站和出站规则，然后创建了试运行和生产EC2实例。</p><p id="b8be" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">对于更复杂的基础设施来说，Pulumi变得更加强大，我鼓励您多阅读他们的<a class="ae ob" href="https://www.pulumi.com/docs/" rel="noopener ugc nofollow" target="_blank">文档</a>，如果您有任何问题，请联系我们！</p><p id="d5a0" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">电子邮件:danielmurph8@gmail.com</p><p id="279a" class="pw-post-body-paragraph ln lo iq lp b lq mm jr ls lt mn ju lv lw mo ly lz ma mp mc md me mq mg mh mi ij bi translated">领英:【https://www.linkedin.com/in/dmurphy1217/ T2】</p></div></div>    
</body>
</html>