<html>
<head>
<title>Polynote with Spark 3.1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带Spark 3.1的多项式</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/polynote-with-spark-3-1-301ff6dbb9a2?source=collection_archive---------24-----------------------#2021-04-22">https://towardsdatascience.com/polynote-with-spark-3-1-301ff6dbb9a2?source=collection_archive---------24-----------------------#2021-04-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="82c0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">多语言笔记本应用程序。在同一个笔记本中使用python和scala进行原型制作和试验。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bd00059f930c2775d44bef1e51dd413e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QEadcTTkuNs1kWBjcnP3Ag.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@hope_house_press_leather_diary_studio?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">希望之家出版社——皮革日记工作室</a>在<a class="ae kv" href="https://unsplash.com/s/photos/notebooks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><h1 id="a0a7" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="dc2f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我看过<a class="ae kv" href="https://polynote.org/" rel="noopener ugc nofollow" target="_blank">冰间湖</a>，我想，大概在2019年10月，在这篇<a class="ae kv" href="https://medium.com/netflix-techblog/open-sourcing-polynote-an-ide-inspired-polyglot-notebook-7f929d3f447" rel="noopener">博文</a>中。那一刻我就爱上了它。对我来说，知道python几乎不费吹灰之力就试用了scala，简直是梦想成真。我可以比较Python和Scala的执行时间，尝试Dataset和Dataframe，做一些教程，甚至帮我写一篇博客。但当时，他们说它并不完美，还处于初级阶段。一年半过去了，我回来重新点燃这个火花(一语双关)。</p><p id="b321" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我计划在我的<a class="ae kv" href="https://github.com/tomaspel" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中创建一个互动研讨会，提供示例、跟进和解释+动手实践任务，polynote非常适合这里。有大量的教程，但不知何故，没有一个能引起我的共鸣，直到我开始用spark做更多的事情。通过向每个人提供我的内容，我希望能为社区做更多的贡献。请记住，准备适当内容需要时间；准备好了我可能会再发一篇博文:)</p><h1 id="64ff" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">初步调查结果</h1><p id="f3d4" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">最近(4月2日)，他们发布了<a class="ae kv" href="https://github.com/polynote/polynote/releases/tag/0.4.0" rel="noopener ugc nofollow" target="_blank"> 0.4.0 </a>版本。从上一个版本发布到现在的半年时间里，他们实现并修复了很多东西。此外，我只看到了spark 2.4.5版本，但没有spark 3.1.1(或3.0.1)，这两个版本已经发布了相当长一段时间。试图更新最新的功能，我认为使用最新的版本会很好。</p><p id="46bb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我注意到在他们的<a class="ae kv" href="https://github.com/polynote/polynote" rel="noopener ugc nofollow" target="_blank"> GitHub </a>里，他们有一个Docker文件夹，里面有基础镜像，spark 2.4.5版本等等。我心想——我做了<a class="ae kv" rel="noopener" target="_blank" href="/docker-101-ee3d2b8ace11"> docker 101 </a>，我认为我完全有能力使用基本图像和Docker知识创建自己的Docker图像。</p><h1 id="bae8" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">Docker图像</h1><p id="21a3" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Dockerfile的大部分内容都是从<a class="ae kv" href="https://github.com/polynote/polynote/blob/master/docker/base/Dockerfile" rel="noopener ugc nofollow" target="_blank">基础映像</a>中重新使用的。做了一些调整以使用不同的Scala版本(2.12)和指定的polynote版本:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="3a0f" class="mu kx iq mq b gy mv mw l mx my">ARG <em class="mz">POLYNOTE_VERSION</em>="0.4.0"<br/>ARG <em class="mz">SCALA_VERSION</em>="2.12"<br/>ARG <em class="mz">DIST_TAR</em>="polynote-dist.tar.gz"</span></pre><p id="e288" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我必须添加的另一个调整是处理spark安装:</p><ul class=""><li id="e249" class="na nb iq lq b lr mk lu ml lx nc mb nd mf ne mj nf ng nh ni bi translated">使用不同的工作目录</li><li id="622c" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">下载spark 3.1.1(请记住，我特意选择了这个链接，因为它离我最近，下载速度会更快)</li><li id="e113" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">进行一些重命名并指定ENV变量</li></ul><p id="e954" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所以它看起来像这样:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="8161" class="mu kx iq mq b gy mv mw l mx my">WORKDIR /opt/spark/work-dir</span><span id="0fc2" class="mu kx iq mq b gy no mw l mx my">RUN wget <a class="ae kv" href="https://apache.mirror.serveriai.lt/spark/spark-3.1.1/spark-3.1.1-bin-hadoop3.2.tgz" rel="noopener ugc nofollow" target="_blank">https://apache.mirror.serveriai.lt/spark/spark-3.1.1/spark-3.1.1-bin-hadoop3.2.tgz</a><br/>RUN tar -xvf spark-3.1.1-bin-hadoop3.2.tgz</span><span id="6ed0" class="mu kx iq mq b gy no mw l mx my">RUN mv spark-3.1.1-bin-hadoop3.2/* /opt/spark<br/>WORKDIR /opt/spark<br/>ENV <em class="mz">SPARK_HOME</em>=/opt/spark<br/>ENV <em class="mz">PATH</em>=$<em class="mz">PATH</em>:$<em class="mz">SPARK_HOME</em>/bin:$<em class="mz">SPARK_HOME</em>/sbin<br/>ENV <em class="mz">PYSPARK_PYTHON</em>=python3</span></pre><h1 id="4db0" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">可执行文件和别名</h1><p id="5069" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">也请阅读他们的<a class="ae kv" href="https://github.com/polynote/polynote/tree/master/docker" rel="noopener ugc nofollow" target="_blank">自述</a>以及所有的免责声明和更广泛的解释。</p><p id="0381" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在他们的文档中，他们建议使用创建的<strong class="lq ir"> config.yml </strong>文件运行docker image，如下所示:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="cba2" class="mu kx iq mq b gy mv mw l mx my">listen:<br/>  host: 0.0.0.0</span><span id="f399" class="mu kx iq mq b gy no mw l mx my">storage:<br/>  dir: /opt/notebooks<br/>  mounts:<br/>    examples:<br/>      dir: examples</span></pre><p id="67d7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所以我们让我们的docker映像监听所有端口。出于PoC学习的目的，这很好，但是您不希望在生产中出现这种情况！</p><p id="3879" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果我们在Polynote中创建新的笔记本，它们将出现在笔记本文件夹中。你可以用更多的文件夹来组织它，等等。，合你心意。</p><p id="0ef7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">他们打包了一些例子来理解它是如何工作的，我们把它们放在最后三行。</p><p id="7c14" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">根据这篇<a class="ae kv" rel="noopener" target="_blank" href="/the-ultimate-guide-to-your-terminal-makeover-e11f9b87ac99">博客文章</a>，为了让我的生活更轻松，我改装了我的终端。为了快速访问Polynote，我更喜欢在一些命令上使用别名。为此，我创建了<strong class="lq ir"> run_polynote.sh </strong>，<strong class="lq ir"> </strong>，这非常简单:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="68f8" class="mu kx iq mq b gy mv mw l mx my">docker build -it polynote_local:latest .<br/>docker run --rm -it -p 127.0.0.1:8192:8192 -p 127.0.0.1:4040-4050:4040-4050 -v `pwd`/config.yml:/opt/config/config.yml -v `pwd`/notebooks:/opt/notebooks/ polynote_local:latest --config /opt/config/config.yml</span></pre><p id="8e1e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我正在构建我的docker文件，并将其标记为<strong class="lq ir"> polynote_local:latest </strong>，然后用我之前创建的<strong class="lq ir"> config.yml </strong>运行它。</p><p id="c3c8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在我需要修改我的。zshrc:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi np"><img src="../Images/0cb8aff7df4ed07e7ed723e2bfee92d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*28C9h9vnitA3jWL4WZwovg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="8d57" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">通过执行</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="8084" class="mu kx iq mq b gy mv mw l mx my">run_polynote</span></pre><p id="5c02" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我会让我的冰穴运行。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/881bbed4a7c732d66299de7d44b106e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*RISdKaZEI3jJpoYmQdgBFw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="ddc9" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">确认</h1><p id="4b0c" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">为了确定我们所做的一切是否正确，我们需要打开polynote并运行代码</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="b262" class="mu kx iq mq b gy mv mw l mx my"><strong class="mq ir">spark.version</strong></span></pre><p id="fe73" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">了解我们是否在使用3.1.1。</p><p id="9492" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">打开0.0.0.0:8192我们可以看到:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/fd2d1b1911b363270768366b9a295789.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xcgx4iMwtQJyUjLy-nRAhA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="9ecb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们创建一个新笔记本；在我的例子中，我将其命名为“testing_for_demo”我们首先看到的是配置和依赖关系。在这里，我们可以指定多个不同的依赖项(Scala或Python)，Spark配置等。<br/>我注意到的一件事是，如果我没有通过任何spark配置运行<strong class="lq ir"> spark.version </strong>，我会得到:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/f05db1dc62d7d9312234dee8c5b3d738.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w2lwM-h5E6RlKi0Lnr9k9g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="5f42" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为驱动程序内存添加简单配置使其工作:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/86bd66237bc73f971fa203a9a1d6e063.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1yQvgynj9XDV4-yINjWTXw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者添加了简单的火花配置图片</p></figure><p id="53fd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们看到了什么:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/23cc665efe3ab55b402564c3feae7966.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EvWAlNk_m2XvYPQSiP7oDw.png"/></div></div></figure><p id="5489" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我做了相同代码的两个版本，一个用Python，另一个用Scala。他们两个都很管用。</p><p id="6ab7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我真正喜欢的是与docker图像捆绑在一起的<strong class="lq ir"> Scala Spark to Pandas </strong>示例。在那里，他们在scala中创建了一个数据框，并从python中的另一个节点访问它！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/efc67533c39d3fd73269fffb00ea37e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oU-u_WMqt5qvGMDtGeKNDA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h1 id="d2fa" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="4e89" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">polynote——网飞的开源笔记本允许你运行你的scala spark代码，并从python中的另一个note访问它，允许你利用两个世界的优势。对于这篇博文，你可以在我的<a class="ae kv" href="https://github.com/TomasPel/workshops/tree/main/spark_101" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中查看所有的代码和文档。</p></div></div>    
</body>
</html>