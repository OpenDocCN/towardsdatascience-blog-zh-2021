<html>
<head>
<title>Joining tables without a joining key or common index</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">没有连接键或公共索引的连接表</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/joining-tables-without-a-joining-key-or-common-index-5955dc0a7a3a?source=collection_archive---------23-----------------------#2021-09-04">https://towardsdatascience.com/joining-tables-without-a-joining-key-or-common-index-5955dc0a7a3a?source=collection_archive---------23-----------------------#2021-09-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="af60" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用模糊字符串匹配匹配马来西亚人的2个不同来源的产品评论，并比较Jaccard和Levenshtein算法。</h2></div><p id="f7ce" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我必须匹配几个马来西亚在线购物平台的产品评论时，就出现了这种情况。让我们马来西亚人与众不同的是我们如何拼写和给出产品评论。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/a931b3eed4abe107f6a0f4aca970cf04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U5aVl6HGywDVihshXapqXw.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">亚马逊评论(上)与马来西亚人的评论(下)。作者提供的截图。</p></figure><p id="e669" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我决定分享我遇到的这个挑战，以及一些可能使这个话题与他人相关的场景。</p><p id="b016" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">想象一下，如果今天，您需要连接来自不同来源的两个或多个表，这可能是因为以下情况:</p><ol class=""><li id="87a9" class="lr ls iq kh b ki kj kl km ko lt ks lu kw lv la lw lx ly lz bi translated">2家公司合并，需要合并他们的产品数据来清点库存。</li><li id="22dd" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">您正在比较一系列产品的不同应用的一些评论。</li><li id="3423" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">从一个表格中寻找反馈，并尝试将相似的单词组合成一个。</li></ol><p id="6a74" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中一个问题是您无法控制数据，无法让他们重新索引他们的产品id或密钥，因为企业要求您尽快提供它们，或者这可能只是出于报告目的，企业无意重新索引以避免服务中断。</p><p id="4b7d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">神奇的门户网站，帮助您跳转到本页所需的主题</strong></p><ul class=""><li id="b4fc" class="lr ls iq kh b ki kj kl km ko lt ks lu kw lv la mf lx ly lz bi translated"><a class="ae mg" href="#b85f" rel="noopener ugc nofollow">今天的挑战</a></li><li id="76bb" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la mf lx ly lz bi translated"><a class="ae mg" href="#817d" rel="noopener ugc nofollow">什么是Levenshtein距离和Jaccard指数</a></li><li id="7792" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la mf lx ly lz bi translated"><a class="ae mg" href="#d327" rel="noopener ugc nofollow">每种算法解决和未解决的问题</a></li><li id="9f75" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la mf lx ly lz bi translated"><a class="ae mg" href="#be5b" rel="noopener ugc nofollow"> UDF在大查询中对Jaccard Index和Levenshtein </a></li><li id="bbbe" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la mf lx ly lz bi translated"><a class="ae mg" href="#a2ab" rel="noopener ugc nofollow">今日挑战Jaccard指数用例</a></li><li id="364a" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la mf lx ly lz bi translated"><a class="ae mg" href="#06d8" rel="noopener ugc nofollow">外卖积分</a></li></ul><h1 id="b85f" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">今天的挑战</h1><p id="4bf5" class="pw-post-body-paragraph kf kg iq kh b ki mz jr kk kl na ju kn ko nb kq kr ks nc ku kv kw nd ky kz la ij bi translated">为了让您更深入地了解我们今天的挑战，这里有一个我们今天将尝试加入的两个表的示例。我们想要得到每个评论出现的总数。代替Levenshtein距离，为了这个介绍，我们将集中使用Jaccard指数。虽然这可能看起来很荒谬，但这些都是我从马来西亚几大在线购物平台上收集的合法评论。</p><div class="lc ld le lf gt ab cb"><figure class="ne lg nf ng nh ni nj paragraph-image"><img src="../Images/063e350c6100f68f61b1d237fab53a23.png" data-original-src="https://miro.medium.com/v2/resize:fit:386/format:webp/1*KhqX3FVPRY6aEQmnot2m4Q.png"/></figure><figure class="ne lg nk ng nh ni nj paragraph-image"><img src="../Images/e88c8cdbccb678274878c341845ec7ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:532/format:webp/1*xbqj_RlWjhJBh2aY2iVzPQ.png"/><p class="ln lo gj gh gi lp lq bd b be z dk nl di nm nn translated">没有公共键连接的两个表。作者提供的截图。</p></figure></div><p id="b764" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">做一个快速的谷歌搜索最终会有一个解决这个挑战的常用方法，那就是使用一种叫做Levenshtein Distance的算法。虽然Levenshtein距离在大多数情况下都很有效，但我想介绍另一种算法，称为Jaccard Index/Jaccard similarity。这不是“更好”或“完美”算法的争论，而是另一种方法的介绍。在深入实际应用之前，我们需要知道Levenshtein距离和Jaccard指数算法解决了什么问题。</p><h1 id="817d" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">什么是莱文斯坦距离和雅克卡指数</h1><p id="c0e0" class="pw-post-body-paragraph kf kg iq kh b ki mz jr kk kl na ju kn ko nb kq kr ks nc ku kv kw nd ky kz la ij bi translated">通俗地说，Levenshtein计算将一个字符串更改为另一个字符串需要多少步/编辑，Jaccard计算第一个字符串与第二个字符串相交的程度。我在下面举例说明了这两种算法的不同之处。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi no"><img src="../Images/044438e4f52c104c500d0687518b78f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0tjviAygBvrOisSfnf-vaQ.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者创建的Levenshtein距离和Jaccard指数的插图。</p></figure><p id="2ea3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上图中，Levenshtein不得不从<em class="np"> thaanks </em>中删除多余的“<em class="np"> a </em>，从而导致一次编辑，使第一个字符串与第二个字符串相似。由此Jaccard将比较<strong class="kh ir">每个唯一的</strong>字母是否存在于另一个字符串中。Jaccard不考虑“<em class="np"> a </em>的数量，因此“<em class="np"> thaanks </em>中的2个“<em class="np"> a </em>”被视为一个“<em class="np"> a </em>”。</p><h1 id="d327" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated"><strong class="ak">每种算法解决和未解决的问题</strong></h1><p id="a111" class="pw-post-body-paragraph kf kg iq kh b ki mz jr kk kl na ju kn ko nb kq kr ks nc ku kv kw nd ky kz la ij bi translated">Levenshtein距离是一些自动校正软件使用的许多算法之一。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/7e07739f38027bda127609c135c2c81d.png" data-original-src="https://miro.medium.com/v2/resize:fit:516/format:webp/1*TCq5mMyPsCik3BPySipmfw.png"/></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者Chromium对thaank的自动更正提示截图。</p></figure><p id="7704" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">“<em class="np">感谢</em>”和“<em class="np">thank</em>”的编辑距离为1，因此自动更正软件建议“<em class="np">感谢</em>作为替代。由此，在一些事件中，用户决定输入“<em class="np">thaaaaaaaaaaaanks</em>”，使用Levenshtein距离的自动校正软件可能无法解决该问题，因为编辑距离很大(删除10步<em class="np">“a”</em>以使其成为“<em class="np">感谢</em>”)。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/f7e0f7bfdf6b83a25cfb73f64f12a54d.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/1*F-nWLRL7rMPKohQFNvnXWg.png"/></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者Chromium对<em class="ns">thaaaaaaaaaaaanks的自动更正提示截图。</em></p></figure><p id="f468" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如上面的截图所示，我的浏览器没有建议任何替代词，因为我输入的单词可能与他们字典中的任何单词都有很大的编辑距离。我使用我的基于Chromium的浏览器作为Levenshtein将要展示的例子，但是，我并不是说使用Levenshtein距离作为他们的主要算法，他们可能有更复杂的算法来处理语法和不同的语言。</p><p id="45ab" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么Jaccard会如何处理“<em class="np">thaaaaaaaaaaaanks</em>”对“<em class="np">谢</em>”呢？首先，两个单词将被制成一组唯一字符，两个字符串的唯一字符是“<em class="np">感谢</em>”。将"<em class="np">谢</em>"与"<em class="np">谢"</em>相交导致所有字符相交，即1。但是，当两个不同的单词具有相同的唯一字符时，Jaccard可能不会返回理想的结果。以“<em class="np">好</em>”和“<em class="np">神</em>”为例，这两个字符串都有唯一的字符“<em class="np">神</em>”，所以由于所有字符都相交，所以结果为1。</p><p id="539d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在您已经了解了这两种算法的工作原理，让我们看看如何在今天的挑战中应用Jaccard算法。</p><h1 id="be5b" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">UDF在对Jaccard Index和Levenshtein的大查询中</h1><p id="98c4" class="pw-post-body-paragraph kf kg iq kh b ki mz jr kk kl na ju kn ko nb kq kr ks nc ku kv kw nd ky kz la ij bi translated">或者您可以使用相同的逻辑，并将其应用于其他数据库。</p><p id="8abd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">什么是大查询中的UDF？<a class="ae mg" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions" rel="noopener ugc nofollow" target="_blank">用户自定义函数(UDF) </a>可以是SQL或Javascript的形式，允许你在大查询中创建类似编程语言的函数。</p><p id="30c8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将使用Javascript创建Jaccard索引算法，并将结果与Levenshtein距离进行比较。<code class="fe nt nu nv nw b">bqutil</code>是来自谷歌云平台的一个项目，它托管了几个我们可以使用的预建功能。他们的Github库可以在<a class="ae mg" href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/udfs" rel="noopener ugc nofollow" target="_blank">这里</a>找到。在撰写本文时，我已经创建了<a class="ae mg" href="https://github.com/GoogleCloudPlatform/bigquery-utils/pull/264" rel="noopener ugc nofollow" target="_blank">一个pull请求</a>来添加Jaccard索引作为供公众使用的<code class="fe nt nu nv nw b">bqutil</code> UDF。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="d025" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将创建一个名为<em class="np"> jaccard </em>的临时函数，它接受2个字符串并返回一个范围从0到1的浮点数。如果第一个字符串<em class="np"> sa </em>中的一个字符存在于第二个字符串<em class="np"> sb </em>中，则将交集大小增加1。循环完成后，通过计算两个字符串的长度并减去交集大小来计算索引，然后将结果再次除以交集大小来获得交集字符的百分比。最后，返回一个2小数点的浮点数。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/cf17efc3fb82392a1d83c0f745569ae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*TaN_izXOSCcNQucSDXpUnw.png"/></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">以上查询的结果。作者提供的截图。</p></figure><p id="f1ad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后运行4个测试用例来比较Jaccard指数和Levenshtein距离之间的结果。如图所示，Jaccard将能够校正相似度为1或100%相似的第一个和第二个示例(感谢和最佳产品示例)。由此Levenshtein指出需要10和8个步骤来将第二个字符串校正为第一个字符串。关于doge和dodge的第三个例子，Jaccard指出两者是相似的词，我们知道它不是，Levenshtein指出需要一个步骤来纠正doge的dodge，反之亦然。</p><h1 id="a2ab" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">今天的挑战Jaccard索引使用案例</h1><ol class=""><li id="02fe" class="lr ls iq kh b ki mz kl na ko oa ks ob kw oc la lw lx ly lz bi translated">创造一个UDF</li><li id="c45c" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">创建两张桌子来模拟我们今天的挑战</li><li id="fa14" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la lw lx ly lz bi translated">交叉连接两个表，这样我们可以计算第二个表中的每个评论与第一个表中的每个评论之间的距离</li></ol><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="edb7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于那些仍然对交叉连接感到困惑的人，我已经根据我们当前的挑战在下面举例说明了它。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi no"><img src="../Images/b9b72b4c5c55d0d8550d05f69a631a32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h25LN6OATQAjDO0KAFrm8Q.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">作者创建的t1(左)和t2(右)的交叉连接图。</p></figure><p id="bbbd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">交叉联接将一个表中的每条记录与另一个表中的每条记录相匹配。然后，我们对每条记录运行jaccard函数，只显示Jaccard索引大于0.8或80%相似的记录。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi od"><img src="../Images/9881f5d7219d63fd96541f82c2fcded8.png" data-original-src="https://miro.medium.com/v2/resize:fit:442/format:webp/1*1FpMYKwn-Vm2OaOKx3P64Q.png"/></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">今天挑战的结果</p></figure><p id="6e7b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用Jaccard索引和80%相似度的阈值，它很好地支持了我们的数据集。第二个表中的每条记录都被正确地添加到第一个表中。</p><h1 id="06d8" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">外卖点</h1><ul class=""><li id="3097" class="lr ls iq kh b ki mz kl na ko oa ks ob kw oc la mf lx ly lz bi translated">不存在“最佳”算法的竞争</li><li id="5d52" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la mf lx ly lz bi translated">每种算法都有自己的用例</li><li id="67a8" class="lr ls iq kh b ki ma kl mb ko mc ks md kw me la mf lx ly lz bi translated">Jaccard索引处理非常具体的情况，不应该在不考虑每个模糊匹配项目的情况下将其概括为“goto”算法</li></ul><p id="c581" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用Jaccard Index，我能够根据一个定制的“马来西亚俚语”字典有选择地纠正我的数据集中至少四分之三的评论，我将这个字典定义为我的来自上述挑战的<em class="np"> t1 </em>。读者们，我希望这能向你们介绍另一种选择，如果Levenshtein不像我一样对你们有利的话，你们可以考虑一下。</p></div></div>    
</body>
</html>