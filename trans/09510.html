<html>
<head>
<title>Build a synthetic data pipeline using Gretel.ai and Apache Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Gretel.ai和Apache Airflow构建合成数据管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-a-synthetic-data-pipeline-using-gretel-ai-and-apache-airflow-a99f1773112f?source=collection_archive---------25-----------------------#2021-09-03">https://towardsdatascience.com/build-a-synthetic-data-pipeline-using-gretel-ai-and-apache-airflow-a99f1773112f?source=collection_archive---------25-----------------------#2021-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="b50a" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" rel="noopener" target="_blank" href="https://towardsdatascience.com/data-science-in-the-real-world/home">现实世界中的数据科学</a></h2><div class=""/><div class=""><h2 id="e538" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated"><em class="ko">在这篇博文中，我们使用</em> <a class="ae kp" href="https://gretel.ai/synthetics" rel="noopener ugc nofollow" target="_blank"> <em class="ko"> Gretel的合成数据API</em></a><em class="ko">和</em><a class="ae kp" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"><em class="ko">Apache air flow</em></a>构建了一个从PostgreSQL数据库生成合成数据的ETL管道</h2></div><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/3934e4acf93014972358e63f85a9633b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HyI-bwd70GBmM8b9"/></div></div><p class="lc ld gj gh gi le lf bd b be z dk translated">照片由<a class="ae kp" href="https://unsplash.com/@selimarda?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">seli̇m·阿尔达·埃尔伊尔马兹</a>在<a class="ae kp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="2550" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">嗨，伙计们，我叫德鲁，我是一名软件工程师，在<a class="ae kp" href="https://gretel.ai/" rel="noopener ugc nofollow" target="_blank"> Gretel.ai </a>。我最近一直在思考将Gretel API集成到现有工具中的模式，这样就很容易建立数据管道，安全和客户隐私是第一位的特性，而不仅仅是事后的想法或检查框。</p><p id="81ec" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">数据工程师中流行的一个数据工程工具是Apache Airflow。这也正好与Gretel的工作很好。在这篇博文中，我们将向您展示如何使用Airflow、Gretel和PostgreSQL构建一个合成数据管道。让我们跳进来吧！</p><h1 id="3d98" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">什么是气流？</h1><p id="deb8" class="pw-post-body-paragraph lg lh iq li b lj mu ka ll lm mv kd lo lp mw lr ls lt mx lv lw lx my lz ma mb ij bi translated"><a class="ae kp" href="https://airflow.apache.org/docs/apache-airflow/stable/howto/operator/index.html" rel="noopener ugc nofollow" target="_blank"> Airflow </a>是一个常用于构建数据管道的工作流自动化工具。它使数据工程师或数据科学家能够使用Python和其他熟悉的构造以编程方式定义和部署这些管道。气流的核心是DAG或有向无环图的概念。气流DAG提供了用于定义管道组件、它们的依赖性和执行顺序的模型和一组API。</p><p id="ab2f" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">您可能会发现气流管道将数据从产品数据库复制到数据仓库。其他管道可能会执行查询，将规范化的数据连接到适合分析或建模的单个数据集。另一个管道可能发布汇总关键业务指标的每日报告。这些用例有一个共同的主题:协调跨系统的数据移动。这是气流闪耀的地方。</p><p id="8c2b" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">利用Airflow及其丰富的<a class="ae kp" href="https://registry.astronomer.io/" rel="noopener ugc nofollow" target="_blank">集成生态系统</a>，数据工程师和科学家可以将任意数量的不同工具或服务整合到一个易于维护和操作的统一管道中。了解了这些集成功能后，我们现在将开始讨论如何将Gretel集成到气流管道中，以改善常见的数据操作工作流。</p><h1 id="cb6e" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">格雷特尔是怎样融入的？</h1><p id="260e" class="pw-post-body-paragraph lg lh iq li b lj mu ka ll lm mv kd lo lp mw lr ls lt mx lv lw lx my lz ma mb ij bi translated">在Gretel，我们的使命是让数据更容易、更安全地使用。在与客户交谈时，我们经常听到的一个痛点是让数据科学家访问敏感数据所需的时间和精力。使用<a class="ae kp" href="https://gretel.ai/synthetics" rel="noopener ugc nofollow" target="_blank"> Gretel Synthetics </a>，我们可以通过生成数据集的合成副本来降低使用敏感数据的风险。通过将Gretel与Airflow集成，可以创建自助管道，使数据科学家可以轻松快速地获得他们需要的数据，而不需要数据工程师来处理每个新的数据请求。</p><p id="19d8" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">为了演示这些功能，我们将构建一个ETL管道，从数据库中提取用户活动特征，生成数据集的合成版本，并将数据集保存到S3。随着合成数据集保存在S3，它可以被数据科学家用于下游建模或分析，而不损害客户隐私。</p><p id="a055" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">首先，让我们来鸟瞰一下管道。该图中的每个节点代表一个管道步骤，或气流术语中的“任务”。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi mz"><img src="../Images/3ee7f39823260a8809e50e2e909497d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WUhfkrOvObcgPCvp"/></div></div><p class="lc ld gj gh gi le lf bd b be z dk translated"><em class="ko">气流上的格雷特合成材料管道示例。(图片由作者提供)</em></p></figure><p id="0886" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">我们可以将管道分成3个阶段，类似于ETL管道:</p><ul class=""><li id="c86f" class="na nb iq li b lj lk lm ln lp nc lt nd lx ne mb nf ng nh ni bi translated"><strong class="li ja">提取</strong>—<code class="fe nj nk nl nm b">extract_features</code>任务将查询数据库，并将数据转换为一组数据科学家可以用来构建模型的特征。</li><li id="80e1" class="na nb iq li b lj nn lm no lp np lt nq lx nr mb nf ng nh ni bi translated"><strong class="li ja">合成— </strong> <code class="fe nj nk nl nm b">generate_synthetic_features</code>将提取的特征作为输入，训练一个合成模型，然后使用Gretel APIs和云服务生成一组合成的特征。</li><li id="8f5f" class="na nb iq li b lj nn lm no lp np lt nq lx nr mb nf ng nh ni bi translated"><strong class="li ja">加载</strong>——<code class="fe nj nk nl nm b">upload_synthetic_features</code>将综合特征集保存到S3，在那里它可以被摄取到任何下游模型或分析中。</li></ul><p id="8cca" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">在接下来的几节中，我们将更详细地探讨这三个步骤。如果你想了解每个代码示例，你可以去<a class="ae kp" href="https://github.com/gretelai/gretel-airflow-pipelines" rel="noopener ugc nofollow" target="_blank">grete lai/Gretel-air flow-pipelines</a>下载这篇博文中用到的所有代码。repo还包含启动Airflow实例和端到端运行管道的说明。</p><p id="2520" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">此外，在我们剖析每个组件之前，查看完整的气流管道可能会有所帮助。以下部分中的代码片段摘自链接用户预订管道。</p><h1 id="31bb" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">提取特征</h1><p id="2bca" class="pw-post-body-paragraph lg lh iq li b lj mu ka ll lm mv kd lo lp mw lr ls lt mx lv lw lx my lz ma mb ij bi translated">第一个任务<code class="fe nj nk nl nm b">extract_features</code>负责从源数据库中提取原始数据，并将其转换成一组特征。这是一个常见的<a class="ae kp" href="https://en.wikipedia.org/wiki/Feature_engineering" rel="noopener ugc nofollow" target="_blank">特征工程</a>问题，你可能会在任何机器学习或分析管道中发现。</p><p id="c82b" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">在我们的示例管道中，我们将提供一个PostgreSQL数据库，并加载来自Airbnb Kaggle竞赛的预订数据。</p><p id="3fa7" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">这个数据集包含两个表，<code class="fe nj nk nl nm b">Users</code>和<code class="fe nj nk nl nm b">Sessions</code>。<code class="fe nj nk nl nm b">Sessions</code>包含一个外键引用<code class="fe nj nk nl nm b">user_id</code>。利用这种关系，我们将创建一组包含由用户聚合的各种预订指标的特性。下图显示了用于构建要素的SQL查询。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="47a0" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">然后从我们的气流管道执行SQL查询，并使用以下任务定义将其写入中间S3位置</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="198e" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">任务的输入<code class="fe nj nk nl nm b">sql_file</code>决定了在数据库上运行什么样的查询。该查询将被读入任务，然后对数据库执行。然后，查询结果将被写入S3，远程文件密钥将作为任务的输出返回。</p><p id="cb7e" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">下面的屏幕截图显示了上面提取查询的示例结果集。我们将在下一节描述如何创建该数据集的合成版本。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nu"><img src="../Images/f5e8f02ebe1ebedd6055ea2a44425ecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HU4uxxN7ur3HjFcw"/></div></div><p class="lc ld gj gh gi le lf bd b be z dk translated"><em class="ko">查询结果预览。(图片由作者提供)</em></p></figure><h1 id="2340" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">使用Gretel APIs合成特征</h1><p id="f64e" class="pw-post-body-paragraph lg lh iq li b lj mu ka ll lm mv kd lo lp mw lr ls lt mx lv lw lx my lz ma mb ij bi translated">为了生成每个特征的合成版本，我们必须首先训练一个合成模型，然后运行该模型来生成合成记录。Gretel有一组Python SDKs，可以很容易地集成到Airflow任务中。</p><p id="e512" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">除了Python客户端SDK，我们还创建了一个<a class="ae kp" href="https://github.com/gretelai/gretel-airflow-pipelines/blob/main/plugins/hooks/gretel.py" rel="noopener ugc nofollow" target="_blank"> Gretel Airflow Hook </a>来管理Gretel API连接和秘密。设置好Gretel气流连接后，连接到Gretel API就像</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="8f1d" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">有关如何配置气流连接的更多信息，请参考我们的Github知识库<a class="ae kp" href="https://github.com/gretelai/gretel-airflow-pipelines#2-configure-airflow-connections" rel="noopener ugc nofollow" target="_blank">自述文件</a>。</p><p id="095c" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">上例中的<code class="fe nj nk nl nm b">project</code>变量可以用作使用Gretel的API训练和运行合成模型的主要入口点。更多细节可以查看我们的Python API文档，<a class="ae kp" href="https://python.docs.gretel.ai/en/stable/projects/projects.html" rel="noopener ugc nofollow" target="_blank">https://Python . docs . Gretel . ai/en/stable/projects/projects . html</a>。</p><p id="88c4" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">回到预订管道，我们现在来回顾一下<code class="fe nj nk nl nm b">generate_synthetic_features</code>任务。此步骤负责使用前一任务中提取的特征来训练合成模型。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="4a76" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">查看方法签名，您会看到它需要一个路径，<code class="fe nj nk nl nm b">data_source</code>。该值指向上一步中提取的S3要素。在后面的部分中，我们将介绍所有这些输入和输出是如何连接在一起的。</p><p id="0c7f" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">当使用<code class="fe nj nk nl nm b">project.create_model_obj</code>创建模型时，<code class="fe nj nk nl nm b">model_config</code>参数代表用于生成模型的合成模型配置。在这个管道中，我们使用我们的<a class="ae kp" href="https://github.com/gretelai/gretel-blueprints/blob/main/config_templates/gretel/synthetics/default.yml" rel="noopener ugc nofollow" target="_blank">默认模型配置</a>，但是许多其他的<a class="ae kp" href="https://docs.gretel.ai/synthetics/synthetics-model-configuration" rel="noopener ugc nofollow" target="_blank">配置选项</a>也是可用的。</p><p id="9bf4" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">模型配置好之后，我们调用<code class="fe nj nk nl nm b">model.submit_cloud()</code>。这将使用Gretel Cloud提交用于训练和记录生成的模型。调用<code class="fe nj nk nl nm b">poll(model)</code>将阻塞任务，直到模型完成训练。</p><p id="191f" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">现在模型已经训练好了，我们将使用<code class="fe nj nk nl nm b">get_artifact_link</code>返回一个链接来下载生成的合成特征。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi nu"><img src="../Images/d6bd4faf94394c449193dfe208fcb61d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XQY5KfsuveiYcP7K"/></div></div><p class="lc ld gj gh gi le lf bd b be z dk translated"><em class="ko">合成集特征的数据预览。(图片由作者提供)</em></p></figure><p id="2caa" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">这个工件链接将被用作最终<code class="fe nj nk nl nm b">upload_synthetic_features</code>步骤的输入。</p><h1 id="e5a5" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">加载合成要素</h1><p id="74b7" class="pw-post-body-paragraph lg lh iq li b lj mu ka ll lm mv kd lo lp mw lr ls lt mx lv lw lx my lz ma mb ij bi translated">原始特征已经被提取，并且已经创建了合成版本。现在是上传合成特性的时候了，这样下游消费者就可以访问它们了。在本例中，我们将使用S3桶作为数据集的最终目的地。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="7397" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">这项任务非常简单。<code class="fe nj nk nl nm b">data_set</code>输入值包含一个签名的HTTP链接，用于从Gretel的API下载合成数据集。该任务将把该文件读入Airflow worker，然后使用已经配置好的S3钩子把合成特征文件上传到S3桶，下游消费者或模型可以访问它。</p><h1 id="7e54" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">协调管道</h1><p id="5399" class="pw-post-body-paragraph lg lh iq li b lj mu ka ll lm mv kd lo lp mw lr ls lt mx lv lw lx my lz ma mb ij bi translated">在过去的三个部分中，我们已经浏览了提取、合成和加载数据集所需的所有代码。最后一步是将这些任务捆绑到一个单独的气流管道中。</p><p id="2e3d" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果你还记得这篇文章的开头，我们简要地提到了DAG的概念。使用Airflow的TaskFlow API，我们可以将这三个Python方法组合成一个DAG，该DAG定义了输入、输出以及每个步骤的运行顺序。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="5c4a" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果您遵循这些方法调用的路径，您最终会得到一个看起来像我们的原始特性管道的图。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi mz"><img src="../Images/fc81ea460bbd4cd35c4889cf2896a4a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ebrmy9nCURHVU6P2"/></div></div><p class="lc ld gj gh gi le lf bd b be z dk translated"><em class="ko">气流上的格莱特合成纤维管道。(图片由作者提供)</em></p></figure><p id="2d27" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">如果你想运行这个管道，并看到它的运行，那就去Github仓库的<a class="ae kp" href="https://github.com/gretelai/gretel-airflow-pipelines" rel="noopener ugc nofollow" target="_blank">看看吧。在那里，您可以找到关于如何启动一个Airflow实例并端到端运行管道的说明。</a></p><h1 id="2c4f" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">包装东西</h1><p id="579e" class="pw-post-body-paragraph lg lh iq li b lj mu ka ll lm mv kd lo lp mw lr ls lt mx lv lw lx my lz ma mb ij bi translated">如果您已经做到了这一步，那么您已经看到了如何将Gretel集成到基于气流的数据管道中。通过结合Gretel的开发人员友好的API和Airflow强大的钩子和操作符系统，很容易构建ETL管道，使数据更容易访问，使用起来更安全。</p><p id="18f0" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">我们还讨论了一个常见的特性工程用例，其中敏感数据可能不容易访问。通过生成数据集的合成版本，我们降低了暴露任何敏感数据的风险，但仍然保留了数据集的效用，同时使需要它的人可以快速获得它。</p><p id="503d" class="pw-post-body-paragraph lg lh iq li b lj lk ka ll lm ln kd lo lp lq lr ls lt lu lv lw lx ly lz ma mb ij bi translated">从更抽象的角度来考虑特性管道，我们现在有了一个可以重新用于任何数量的新SQL查询的模式。通过部署新版本的管道，并替换初始SQL查询，我们可以用保护客户隐私的合成数据集来处理任何潜在的敏感查询。唯一需要更改的代码行是sql文件的路径。不需要复杂的数据工程。</p><h1 id="43b0" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">感谢阅读</h1><p id="74c7" class="pw-post-body-paragraph lg lh iq li b lj mu ka ll lm mv kd lo lp mw lr ls lt mx lv lw lx my lz ma mb ij bi translated">如果您有任何问题或意见，请发送电子邮件至<a class="ae kp" href="mailto:hi@gretel.ai" rel="noopener ugc nofollow" target="_blank"> hi@gretel.ai </a>或加入我们的<a class="ae kp" href="https://gretel.ai/slackinvite" rel="noopener ugc nofollow" target="_blank"> Slack </a>。我们希望了解您如何使用Airflow，以及我们如何才能最好地与您现有的数据管道集成。</p></div></div>    
</body>
</html>