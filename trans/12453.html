<html>
<head>
<title>4 Different Ways of Creating a New Column with PySpark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 PySpark 创建新列的 4 种不同方式</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/4-different-ways-of-creating-a-new-column-with-pyspark-1a6782fe764e?source=collection_archive---------17-----------------------#2021-12-20">https://towardsdatascience.com/4-different-ways-of-creating-a-new-column-with-pyspark-1a6782fe764e?source=collection_archive---------17-----------------------#2021-12-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="78d7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何在 Spark 数据框中创建新列</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/461c270d4d722f78254af965177884f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tvOJmGHoli8iUDnqQfiDLQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@sebastiansvenson?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">塞巴斯蒂安·斯文森</a>在<a class="ae ky" href="https://unsplash.com/s/photos/simple?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="f404" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们生活在大数据时代。收集、存储和传输数据变得非常容易。随着数据量的增加，传统工具开始变得不足。</p><p id="3159" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当数据太大而无法用传统的工具和技术处理时，我们应该使用 Spark 等支持分布式计算的工具和技术。</p><p id="cfd8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Spark 是一个用于大规模数据处理的分析引擎。它让我们能够将数据和计算分散到集群上，从而大幅提升性能。</p><p id="a414" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">PySpark 是 Spark 的 Python API。它结合了 Python 的简单性和 Spark 的高效性，这种合作得到了数据科学家和工程师的高度赞赏。</p><p id="d6a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将介绍使用 PySpark SQL 模块创建新列的 4 种方法。</p><p id="f0b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一步是导入库并创建 Spark 会话。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="5409" class="ma mb it lw b gy mc md l me mf">from pyspark.sql import SparkSession<br/>from pyspark.sql import functions as F</span><span id="02c4" class="ma mb it lw b gy mg md l me mf">spark = SparkSession.builder.getOrCreate()</span></pre><p id="6e05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还在模块中导入了函数，因为我们将在创建列时使用其中的一些函数。</p><p id="3f98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是获取一些数据。我们总是可以通过从外部文件读取数据来创建数据框。在本文中，我们将使用<code class="fe mh mi mj lw b">createDataFrame</code>函数创建自己的数据框。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="ff5b" class="ma mb it lw b gy mc md l me mf">data = [<br/>    ("John","Doe",28,45000,1,0,1),<br/>    ("Jane","Doe",26,52000,1,1,1),<br/>    ("Matt","Anderson",34,62000,1,0,0),<br/>    ("Ashley","James",30,58000,1,1,0),<br/>    ("Amber","Murray",24,48000,1,0,0)<br/>]</span><span id="c792" class="ma mb it lw b gy mg md l me mf">schema = StructType([<br/>    StructField("FirstName",StringType(),True),<br/>    StructField("LastName",StringType(),True),<br/>    StructField("Age",IntegerType(),True),<br/>    StructField("Salary", IntegerType(), True),<br/>    StructField("Checking", IntegerType(), True),<br/>    StructField("Savings", IntegerType(), True),<br/>    StructField("CreditCard", IntegerType(), True)<br/>  ])</span><span id="d757" class="ma mb it lw b gy mg md l me mf">df = spark.createDataFrame(data=data, schema=schema)</span><span id="e2ba" class="ma mb it lw b gy mg md l me mf">df.show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/df1b0e3e8c032222461b300ec715fb46.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*1CxrvZhV9Pr-HQ_Wna1Uxg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Spark 数据框(图片由作者提供)</p></figure><p id="fd9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“支票”、“储蓄”和“信用卡”列表明客户是否拥有该产品。</p><p id="ffd6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">schema 参数是可选的，但是最好指定方案以确保数据类型是正确的。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="b5eb" class="ma mb it lw b gy mc md l me mf">df.printSchema()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/aacdec5e80a6c959809089d695f5adf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:524/format:webp/1*nJkrBBPegxNsaVv2LUaMjg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据框的方案(图片由作者提供)</p></figure></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h2 id="c0fd" class="ma mb it bd mt mu mv dn mw mx my dp mz li na nb nc lm nd ne nf lq ng nh ni nj bi translated">1.用常数值创建新列</h2><p id="e9f1" class="pw-post-body-paragraph kz la it lb b lc nk ju le lf nl jx lh li nm lk ll lm nn lo lp lq no ls lt lu im bi translated"><code class="fe mh mi mj lw b">withColumn</code>函数可以用来创建一个新列。为了创建一个常量值，我们需要用<code class="fe mh mi mj lw b">lit</code>函数指定值，而不管数据类型。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="7de1" class="ma mb it lw b gy mc md l me mf">df = df.withColumn("IsCustomer", F.lit(1))</span><span id="3e6c" class="ma mb it lw b gy mg md l me mf">df.show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/5f078ff53a87d9dc4a003e3d8bac3604.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*fOnBmV-LwgZrJulhok2NeQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="9522" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mh mi mj lw b">withColumn</code>函数的第一个参数是新列的名称，第二个参数指定值。</p></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h2 id="20da" class="ma mb it bd mt mu mv dn mw mx my dp mz li na nb nc lm nd ne nf lq ng nh ni nj bi translated">2.基于其他列创建新列</h2><p id="31c7" class="pw-post-body-paragraph kz la it lb b lc nk ju le lf nl jx lh li nm lk ll lm nn lo lp lq no ls lt lu im bi translated">我们可以通过使用另一列中的值来计算新列的值。<code class="fe mh mi mj lw b">withColumn</code>功能也允许进行计算。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="74a3" class="ma mb it lw b gy mc md l me mf">df = df.withColumn(<br/>    "NumberOfProducts", <br/>     F.col("Checking") + F.col("Savings") + F.col("CreditCard")<br/>)</span><span id="541b" class="ma mb it lw b gy mg md l me mf">df.select("Checking","Savings","CreditCard","NumberOfProducts").show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/2060bf96789af61ecc4dbde592e16b27.png" data-original-src="https://miro.medium.com/v2/resize:fit:566/format:webp/1*jqDrZEiOCgMC7xHeJFIluw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="bacc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“产品数量”列是支票、储蓄和信用卡列的总和。我们需要使用<code class="fe mh mi mj lw b">col</code>函数写入列名。</p></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h2 id="c0d5" class="ma mb it bd mt mu mv dn mw mx my dp mz li na nb nc lm nd ne nf lq ng nh ni nj bi translated">3.创建条件列</h2><p id="69af" class="pw-post-body-paragraph kz la it lb b lc nk ju le lf nl jx lh li nm lk ll lm nn lo lp lq no ls lt lu im bi translated">我们可以使用<code class="fe mh mi mj lw b">when</code>函数根据一个或多个条件指定新列的值。</p><p id="d639" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建一个指示客户是否至少有一种产品的列。如果产品数量为一个或多个，新列的值为 1。否则为 0。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="11a4" class="ma mb it lw b gy mc md l me mf">df = df.withColumn(<br/>    "HasProduct",<br/>    F.when(F.col("NumberOfProducts") &gt;= 1, 1).otherwise(0)<br/>)</span><span id="c782" class="ma mb it lw b gy mg md l me mf">df.select("NumberOfProducts", "HasProduct").show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/7355204b93bf423645da88a67a8015e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:364/format:webp/1*tqkKXbP1f3LiW1yhIaXnKg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="f974" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该条件作为<code class="fe mh mi mj lw b">when</code>函数的第一个参数写入。然后，我们为符合给定条件的行指定值。为了给不同的条件指定不同的值，我们可以将<code class="fe mh mi mj lw b">when</code>功能组合成一个链式操作。不符合任何给定条件的行的值被写入<code class="fe mh mi mj lw b">otherwise</code>部分。</p></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h2 id="8d20" class="ma mb it bd mt mu mv dn mw mx my dp mz li na nb nc lm nd ne nf lq ng nh ni nj bi translated">4.在 select 函数中创建列</h2><p id="d05b" class="pw-post-body-paragraph kz la it lb b lc nk ju le lf nl jx lh li nm lk ll lm nn lo lp lq no ls lt lu im bi translated"><code class="fe mh mi mj lw b">select</code>函数可用于从数据框中选择列。它非常类似于 SQL 的 select 语句。</p><p id="e873" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们通常在<code class="fe mh mi mj lw b">select</code>函数中写入列名。我们还可以在<code class="fe mh mi mj lw b">select</code>函数中进行计算来创建新的列。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="239c" class="ma mb it lw b gy mc md l me mf">df_new = df.select(<br/>    "FirstName",<br/>    "LastName",<br/>    "NumberOfProducts",<br/>    F.lit(3 - df.NumberOfProducts).alias("Potential")<br/>)</span><span id="416b" class="ma mb it lw b gy mg md l me mf">df_new.show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/2aff3ebd6d06819b06db12461b7aba48.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/1*S6J7NVdHeSohdIzQqCi3tg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="5aec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“潜在”列显示可以向客户销售多少新产品。因此，它的计算方法是从我们产品组合中的产品总数(3)中减去客户拥有的产品数。</p><p id="73b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mh mi mj lw b">alias</code>方法用于为派生列或计算列指定一个名称。</p></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h2 id="5a8d" class="ma mb it bd mt mu mv dn mw mx my dp mz li na nb nc lm nd ne nf lq ng nh ni nj bi translated">结论</h2><p id="6847" class="pw-post-body-paragraph kz la it lb b lc nk ju le lf nl jx lh li nm lk ll lm nn lo lp lq no ls lt lu im bi translated">我们已经介绍了使用 PySpark SQL 模块创建新列的 4 种不同方法。</p><p id="74fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要注意的是，Spark 针对大规模数据进行了优化。因此，在处理小规模数据时，您可能看不到任何性能提升。事实上，在处理小数据集时，Pandas 可能会比 PySpark 表现得更好。</p><p id="3412" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想在我发表新文章时收到电子邮件，别忘了订阅。</p><p id="8ae5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nt">你可以成为</em> <a class="ae ky" href="https://sonery.medium.com/membership" rel="noopener"> <em class="nt">媒介会员</em> </a> <em class="nt">解锁我的全部写作权限，外加其余媒介。如果您使用以下链接，我将收取您的一部分会员费，无需您支付额外费用。</em></p><div class="nu nv gp gr nw nx"><a href="https://sonery.medium.com/membership" rel="noopener follow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd iu gy z fp oc fr fs od fu fw is bi translated">通过我的推荐链接加入 Medium-Soner yl DRM</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">sonery.medium.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol ks nx"/></div></div></a></div><p id="0efa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读。如果您有任何反馈，请告诉我。</p></div></div>    
</body>
</html>