<html>
<head>
<title>Query folding in Power BI— the devil is in the detail</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Power BI中的查询折叠—细节决定成败</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/query-folding-in-power-bi-devil-is-in-the-detail-d564ab0cb32?source=collection_archive---------13-----------------------#2021-04-01">https://towardsdatascience.com/query-folding-in-power-bi-devil-is-in-the-detail-d564ab0cb32?source=collection_archive---------13-----------------------#2021-04-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c313" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Power BI中查询折叠系列的第2部分中，了解为什么人们说细节决定成败！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ef7ce370012439c2db12df8d542176a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oanc22DwG8IOobrm7acmwA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/photos/fD0pgJCvypk" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/fD0pgJCvypk</a></p></figure><blockquote class="kz la lb"><p id="42bf" class="lc ld le lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">"这会破坏查询折叠吗？"“您的查询会折叠吗？”…也许有人问过你这些问题，但你会说:“问…什么？!"</p><p id="7e54" class="lc ld le lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">或者，您可能听说过Power BI中的查询折叠，但不知道如何在现实生活中利用它。</p><p id="0927" class="lc ld le lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">如果你认识到自己处于(至少)上述两种情况中的一种，那么请继续阅读这篇简短的系列博文！</p></blockquote><ul class=""><li id="36ae" class="lz ma it lf b lg lh lj lk mb mc md me mf mg ly mh mi mj mk bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/what-is-a-query-folding-in-power-bi-and-why-should-i-care-5b89f42f38d7">第1部分——什么是Power BI中的查询折叠，我为什么要关心？</a></li></ul><p id="50aa" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">在本系列的前一部分中，我们解释了什么是查询折叠，哪些数据源支持它，以及数据源本身中的哪些转换。现在，让我们检查一下为什么实现这种行为很重要——或者，更好的说法是——为什么您应该关心查询是否折叠？</p><h2 id="5337" class="ml mm it bd mn mo mp dn mq mr ms dp mt mb mu mv mw md mx my mz mf na nb nc nd bi translated">为什么您应该关心查询折叠？</h2><p id="bb90" class="pw-post-body-paragraph lc ld it lf b lg ne ju li lj nf jx ll mb ng lo lp md nh ls lt mf ni lw lx ly im bi translated">当您在Power BI中使用导入模式时，无论是在刷新速度还是资源消耗方面，当查询折叠时，数据刷新过程的工作效率都会更高。</p><p id="0a60" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">如果您正在使用DirectQuery或双存储模式，因为您直接面向SQL数据库，所以您的所有转换<strong class="lf iu">必须</strong>折叠——否则您的解决方案将无法工作。</p><p id="b3df" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">最后，查询折叠对于增量刷新也非常重要——它非常重要，一旦Power BI确定无法实现查询折叠，它就会向您发出警告。它不会破坏您的增量刷新“本身”,但是如果没有查询折叠，增量刷新就无法实现其主要目的——减少数据模型中需要刷新的数据量——因为没有查询折叠，Mashup engine需要从源中检索所有数据，然后应用后续步骤来过滤数据。</p><p id="8ad7" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">记住所有这些，您应该尽可能地实现查询折叠。</p><h2 id="7efc" class="ml mm it bd mn mo mp dn mq mr ms dp mt mb mu mv mw md mx my mz mf na nb nc nd bi translated">慢速报告—不要责怪查询折叠！</h2><p id="66f3" class="pw-post-body-paragraph lc ld it lf b lg ne ju li lj nf jx ll mb ng lo lp md nh ls lt mf ni lw lx ly im bi translated">这里有一个重要的免责声明，这是这一系列博客文章的关键要点之一:如果你的报告很慢，或者你的<a class="ae ky" rel="noopener" target="_blank" href="/how-i-speed-up-my-power-bi-report-5x-155255415895">视觉效果需要很多时间来渲染</a>，或者你的<a class="ae ky" rel="noopener" target="_blank" href="/how-to-reduce-your-power-bi-model-size-by-90-76d7c4377f2d">数据模型很大</a>，查询折叠与此无关！</p><p id="7474" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">只有当您的数据刷新或增量刷新速度慢且效率低时，您才应该更深入地研究您的超级查询步骤。</p><h2 id="8b1a" class="ml mm it bd mn mo mp dn mq mr ms dp mt mb mu mv mw md mx my mz mf na nb nc nd bi translated">全有还是全无？</h2><p id="a1e9" class="pw-post-body-paragraph lc ld it lf b lg ne ju li lj nf jx ll mb ng lo lp md nh ls lt mf ni lw lx ly im bi translated">关于查询折叠，还有一些事情需要记住。这不是全有或全无的过程。也就是说，如果您在Power Query中有10个转换步骤，并且您的查询折叠到第6个步骤，您仍然可以从部分查询折叠中获得一些好处。但是，查询折叠一旦被打破，就再也无法实现了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/d55b9e350214e14923f8726405e7b62e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_PkMTbRpXtYc0aF-iHGnew.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="75b6" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">简而言之，如果您有10个转换步骤，并且您的查询折叠在第5个步骤中被破坏，那么前面的所有步骤都将被折叠，但是一旦折叠被破坏，就不能再实现了，即使您在步骤6到10中有默认支持查询折叠的转换——就像在我们的示例中过滤应该是一个可折叠的步骤，这些步骤也不会被折叠。请记住这一点，并尽可能地将所有不可折叠的步骤推向流水线。</p><h2 id="2a55" class="ml mm it bd mn mo mp dn mq mr ms dp mt mb mu mv mw md mx my mz mf na nb nc nd bi translated">如何知道查询是否折叠？</h2><p id="6646" class="pw-post-body-paragraph lc ld it lf b lg ne ju li lj nf jx ll mb ng lo lp md nh ls lt mf ni lw lx ly im bi translated">好了，现在我们不再是菜鸟了。我们知道什么是查询折叠，为什么我们应该努力实现它，以及一些可以产生巨大差异的微妙技巧。</p><p id="0c31" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">现在，是时候学习如何检查特定查询是否折叠了。第一种也是最显而易见的方法是右键单击该步骤，并检查<em class="le"> View Native Query </em>选项看起来如何。</p><p id="dce9" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">如果它是灰色的，这一步(可能)不会折叠。另一方面，如果您能够点击这个选项，这意味着您的查询可能会失败。我猜你可能对“可能”这个词感到困惑。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/cb129d15742d15f5eecb8a62cf051607.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*sqW1uxb5kf9WfP3G_uXfxQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="169e" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">但是，这是一个合适的词，因为你不能100%确定如果<em class="le">视图本地查询</em>选项被禁用，你的查询不会折叠。稍后我将向您展示这个选项是如何欺骗我们认为查询折叠被破坏的，尽管实际上折叠确实发生了。</p><p id="6f7e" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">相反，当您想要确定您的查询是否折叠时，您可以使用Power Query Editor中的<em class="le">查询诊断</em>功能，或<em class="le"> SQL Server Profiler </em>，就像一种古老而可靠的方法来检查Power BI引擎发送到数据库的查询。</p><p id="5c76" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">此外，在Power Query Online中有一个很酷的新功能，其中每个步骤都标有图标，显示该步骤是否折叠、未折叠或未知。正如我所说，这个功能目前只在Power Query Online中可用，所以让我们希望Power BI团队很快在桌面版本中实现它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/fc70e251dcf9b2fff71f6b3dba5dc9f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*abAufZmhlAS5y4tw-4EBKg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h2 id="b3b5" class="ml mm it bd mn mo mp dn mq mr ms dp mt mb mu mv mw md mx my mz mf na nb nc nd bi translated">细节决定成败…</h2><p id="4c02" class="pw-post-body-paragraph lc ld it lf b lg ne ju li lj nf jx ll mb ng lo lp md nh ls lt mf ni lw lx ly im bi translated">好吧……你可能听说过这样一句话:“细节决定成败”。现在，是时候了解微小的差异如何在我们的数据转换过程中产生巨大的影响了。</p><p id="b05a" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">让我们从Power查询编辑器中最令人好奇的一个案例开始…</p><h2 id="bbc7" class="ml mm it bd mn mo mp dn mq mr ms dp mt mb mu mv mw md mx my mz mf na nb nc nd bi translated">魔鬼#1 —合并联接</h2><p id="7269" class="pw-post-body-paragraph lc ld it lf b lg ne ju li lj nf jx ll mb ng lo lp md nh ls lt mf ni lw lx ly im bi translated">这一个非常有趣，因为你很难假设背景中正在发生什么。假设我想将两个查询合并成一个。我将使用<em class="le"> Adventure Works </em>示例数据库，并且我需要合并FactInternet Sales和DimCustomer表。</p><p id="d67f" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">我将从事实表中删除一些列，只保留CustomerKey列和Sales Amount列，因为这是DimCustomer表的外键。我将按原样连接DimCustomer表，在合并之前不需要任何额外的步骤。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/afd16b0c56368780a7fa053d02870978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fw16NPI7Y8lH9Z9Qk1PxsA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="b19e" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">合并表相当于SQL中的JOIN操作。本质上，我们选择要对其执行合并操作的列，以及连接的类型(left、outer或inner)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/a79f68bd46194941057314d5dd4cae7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9U_ckzO3rHhKmE8_YYrHhQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="fcc5" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">问题是，默认情况下，当您合并两个查询时，Power Query将生成一个嵌套的join语句，这在SQL中无法正确翻译。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/0d5f7c87bb369f963e3d6d30f09a9f9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tSKNX8mMmUO-8OUN8FU-iQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">超级查询生成的嵌套连接操作</p></figure><p id="3633" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">如果我转到Tools选项卡并单击Diagnose Step，我可以看到Mashup引擎向我的底层SQL Server数据库发出了两个单独的查询——换句话说，这两个查询不能作为单个SQL语句执行，这意味着查询没有折叠！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/a233b53a80bf15ee4ba38db1bb80e1ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2GcHhslMPZkRJJFux2laEQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="bb9b" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">我们如何解决这个问题？让我们选择一个空的查询并手工编写我们的M代码，以达到完全相同的结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/98876a053366de030b9deda7037b829d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CrGMihAs2K0VPHI-D6bbVw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="e61e" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">关键的是，我们将使用一个类似的，但仍然不同的M函数:<strong class="lf iu"> <em class="le">表。加入</em> </strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/003d4fd35aa4dcc5f365d221592812a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gDlEKhD6jYs7tZD2aDWHDg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们现在使用的是表格。连接功能</p></figure><p id="c173" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">所有的函数参数都与之前完全相同，现在让我们来检查结果。</p><p id="02c9" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">你记得我曾经告诉过你，当<em class="le">视图原生查询</em>变灰时，你的查询可能不会折叠，但它不是100%正确。这是一个很好的例子。如果你看一下<em class="le">视图原生查询</em>，它仍然显示我们的查询没有折叠…</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/c817d7fa12283faefc610657ce30dacf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z41AbXMk-CPTAyj7SaDimQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="838f" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">…但是让我们去诊断一下，看看这是不是真的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/8463cd660dfe44a604c852deb3fa231c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*guQ-Qyfkz8uBMWf4UsQwig.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="7e31" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">哦，天哪，我们上当了——这一步确实失败了！如上图所示，我们生成了一个SQL查询，并发送到SQL Server源数据库执行。</p><p id="24ec" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">因此，我们在这个例子中发现了两个难题——第一个是连接类型，我们可以通过调整自动生成的M代码来解决。另一个是<em class="le">视图本地查询</em>选项的不正确行为。在本系列的下一部分中，我将再向您展示一个当<em class="le">视图本地查询</em>存在时的例子。</p><h2 id="b320" class="ml mm it bd mn mo mp dn mq mr ms dp mt mb mu mv mw md mx my mz mf na nb nc nd bi translated">结论</h2><p id="e7ba" class="pw-post-body-paragraph lc ld it lf b lg ne ju li lj nf jx ll mb ng lo lp md nh ls lt mf ni lw lx ly im bi translated">由于我们在本系列的前一部分中打下了关于查询折叠的坚实的理论基础，我们加深了对查询折叠概念的重要性的理解。</p><p id="a87f" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">此外，我们已经看到了一些细微的差异如何对将M代码转换为SQL的过程产生巨大的影响，并了解了如何解决查询(非)折叠时最常见的挑战之一——那就是合并操作！</p><p id="63df" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">在本系列的下一部分，我将向您展示一些与查询折叠相关的更方便的技巧。</p><p id="7a6a" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">如果你迫不及待地想了解更多关于查询折叠的知识，我强烈推荐查看由<strong class="lf iu"> Alex Powers </strong>创建的<a class="ae ky" href="https://www.youtube.com/watch?v=9sV3hIn8VTY&amp;list=PLKW7XPyNDgRCorKNS1bfZoAO3YSIAVz3N" rel="noopener ugc nofollow" target="_blank">“30天查询折叠挑战”</a>，因为这可能是理解这个概念的最全面的资源。</p><p id="d53c" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated"><a class="ae ky" href="https://datamozart.medium.com/membership" rel="noopener">成为会员，阅读媒体上的每一个故事！</a></p><p id="c758" class="pw-post-body-paragraph lc ld it lf b lg lh ju li lj lk jx ll mb ln lo lp md lr ls lt mf lv lw lx ly im bi translated">订阅<a class="ae ky" href="http://eepurl.com/gOH8iP" rel="noopener ugc nofollow" target="_blank">这里</a>获取更多有见地的数据文章！</p></div></div>    
</body>
</html>