<html>
<head>
<title>PostgreSQL — How to UPSERT safely, easily and fast</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PostgreSQL —如何安全、轻松、快速地进行升级</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/postgresql-how-to-upsert-safely-easily-and-fast-246040514933?source=collection_archive---------2-----------------------#2021-10-12">https://towardsdatascience.com/postgresql-how-to-upsert-safely-easily-and-fast-246040514933?source=collection_archive---------2-----------------------#2021-10-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f566" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">防止重复，插入新记录，更新现有记录</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c26e150a7f6d459196a40894a87091aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GDFHY3Gm3Qblfadl"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们将安全地连接数据库中的数据集，而不是连接道路(图片由<a class="ae ky" href="https://unsplash.com/photos/p50L8cR4xf8" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@sigmund" rel="noopener ugc nofollow" target="_blank"> Sigmund </a>提供)</p></figure><p id="a33c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您将数据向上插入到表中时，您会更新或忽略已经存在的记录并插入新记录。阅读完本文后，您将能够在Postgres中执行一个允许您这样做的查询。我们将通过一个实际的例子来演示如何做到这一点。我们来编码吧！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="28c8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">1.设置和准备</h1><p id="e3ec" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">假设我们有一个跟踪最新加密货币价格的应用程序。每10秒钟，我们就会收到一个包含最新价格和交易量的数据集。我们希望在数据库的一个表中记录这些价格变化，以便我们可以在网站上显示最新的信息。</p><p id="8b78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们想更新价格和数量的硬币已经在数据库中，并添加新的硬币。我们可以用一句话来处理这些问题。</p><h2 id="016a" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">数据库准备</h2><p id="95f2" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">让我们首先设置一些表并插入一些虚拟数据，这样我们就有东西可以使用了。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="1967" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">执行这个查询将得到下面的coinprices表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/0cd4e181ce064df1f9ef3ca2871e762f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m_7yIkEGt2G2-tXkXvT50Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的硬币价格表(图片由作者提供)</p></figure><p id="8bda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，我们记录了五枚硬币。管理过去24小时的价格(美元)和交易量。</p><p id="0cf9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">目前，如果我们收到一个新的比特币记录，并将其插入到我们的表中，我们就会遇到麻烦:然后我们有两个记录显示一个比特币的价格。我们不能有这种情况，所以我们将在表上添加一个唯一约束:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="df42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这确保了我们不能插入多个具有相同符号和货币的记录。我们稍后会用到这个独特的约束。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a460976345970daffa616e7249761eb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bCfz_wDsXgu8HQ-B"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们合并吧！(图片由<a class="ae ky" href="https://unsplash.com/@foxfox" rel="noopener ugc nofollow" target="_blank">娜塔莉亚Y </a>在<a class="ae ky" href="https://unsplash.com/photos/f6j5Dol1H_I" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c128" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">2.向上插入</h1><p id="bada" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们准备好接收新数据了。让我们插上！</p><p id="01b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们收到了比特币新的价格和交易量，以及全新的硬币。让我们看看当我们试图将它插入到我们的表中时会发生什么。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="c9c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">执行上述查询会导致:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi no"><img src="../Images/01284e5b9620c35762c785aef498b5d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*ySklNNQZhi85vj8hNYySJw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">比特币已经存在于我们的表中(图片由作者提供)</p></figure><p id="33e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">插入操作遇到了<em class="np">冲突</em>。我们可以检测是否遇到冲突，然后决定如何处理冲突的记录。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="2f40" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">在单个语句中向上插入</h2><p id="3daa" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">使用下面的查询，我们可以一次插入新硬币并更新现有的硬币！</p><pre class="kj kk kl km gt nq nr ns nt aw nu bi"><span id="0c16" class="mz md it nr b gy nv nw l nx ny">INSERT INTO med.coinprices (symbol, currency, price_usd, volume_24h) VALUES<br/>	('BTC', 'Bitcoin', 60000, 40000000000)<br/>	, ('XDG', 'Dogecoin', 0.2181, 1983534547)<br/>ON CONFLICT (symbol, currency)<br/>DO UPDATE SET<br/>	price_usd = EXCLUDED.price_usd<br/>	, volume_24h = EXCLUDED.volume_24h;</span></pre><p id="b82b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们一步一步地完成这个查询。<br/> -第一部分很简单，只是一个普通的两行插页。<br/> -从第4行开始，我们决定如何处理冲突的记录。在这种情况下，发生冲突是因为我们违反了表上的唯一约束。</p><p id="b023" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这正是我们想要的！如果我们的表中已经有了<em class="np">符号</em>和<em class="np">货币</em>列的记录，那么我们想要更新它们。在查询中，EXCLUDED包含最初建议插入的所有记录。这是我们的结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/fa5e5544cb28bf54b90c5ff8048d9164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H56lWF5UZHXYXt83jN7fBg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们新的coinprices表，最后两行是向上插入的值(图片由作者提供)</p></figure><p id="832e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总之:我们执行一个常规的插入，但是捕捉到冲突的记录并指定如何处理它们。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="5043" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">升级选项</h2><p id="2353" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在我们的实际例子之外的其他情况下，您可能不希望对冲突的记录做任何事情。我们可以简单地调整语句，只插入不冲突的记录，忽略冲突的记录:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="88f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的查询将只插入Dogecoin，并忽略比特币的更新:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/2ac360b9eae6911ecb7c0992623bb1c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tvBDnc64v9rzZh3hYXDv6A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">当指定什么都不做时，比特币保持不变(图片由作者提供)</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="b6f5" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">安全的</h2><p id="c7d8" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">执行此查询将插入并更新所有建议的记录，或者不插入并更新任何记录。它们发生在单个交易中。更多交易信息在<a class="ae ky" href="https://mikehuls.medium.com/sql-rolling-back-statements-with-transactions-81937811e7a7" rel="noopener"> <strong class="lb iu">本文</strong> </a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/69e59c3670d38842a86f225e9763839c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*d6iYoRNma_Ngy4h8"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的数据被安全地合并并准备使用(图片由<a class="ae ky" href="https://unsplash.com/@tomthompsonphotography" rel="noopener ugc nofollow" target="_blank">托马斯·汤普森</a>在<a class="ae ky" href="https://unsplash.com/photos/KSm1Fh8wQtc" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure><h1 id="09f7" class="mc md it bd me mf oa mh mi mj ob ml mm jz oc ka mo kc od kd mq kf oe kg ms mt bi translated">结论</h1><p id="e65b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">通过这篇文章，我希望对如何在Postgres中安全、简单、快速地插入数据有所启发。如果你有建议/澄清，请评论，以便我可以改进这篇文章。同时，看看我的其他关于各种编程相关主题的文章，比如:</p><ul class=""><li id="0596" class="of og it lb b lc ld lf lg li oh lm oi lq oj lu ok ol om on bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-delete-into-another-table-b5b946a42299" rel="noopener">删除到另一个表中</a></li><li id="1286" class="of og it lb b lc oo lf op li oq lm or lq os lu ok ol om on bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-into-another-table-bfc3dff79a66" rel="noopener">更新到另一个标签页</a> le</li><li id="c322" class="of og it lb b lc oo lf op li oq lm or lq os lu ok ol om on bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-insert-delete-and-update-in-one-statement-sync-your-tables-with-merge-14814215d32c" rel="noopener">在一条语句中插入、删除和更新</a></li><li id="3202" class="of og it lb b lc oo lf op li oq lm or lq os lu ok ol om on bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-select-in-one-query-b067a7e60136" rel="noopener">更新选择一批记录</a></li><li id="4c18" class="of og it lb b lc oo lf op li oq lm or lq os lu ok ol om on bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-inserting-only-unique-values-in-a-unique-table-af2eb3b9890a" rel="noopener">插入唯一表格</a></li><li id="d5c2" class="of og it lb b lc oo lf op li oq lm or lq os lu ok ol om on bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-understand-how-indices-work-under-the-hood-to-speed-up-your-queries-a7f07eef4080" rel="noopener">了解索引如何加快查询速度</a></li></ul><p id="1a15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><p id="ce5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="5126" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page的缩写）学生:比如我正在做的事情？跟我来！</p></div></div>    
</body>
</html>