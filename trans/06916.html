<html>
<head>
<title>Actually forecasting COVID-19</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">实际预测新冠肺炎</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-actually-forecast-covid-19-778cce27b9d6?source=collection_archive---------4-----------------------#2021-06-23">https://towardsdatascience.com/how-to-actually-forecast-covid-19-778cce27b9d6?source=collection_archive---------4-----------------------#2021-06-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="98c8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个关于预测新冠肺炎的完整教程，包含Python代码</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c1b65c18137c267bcf50c07eb6f55856.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UzKpg4tljp5a7dvAWokZEg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="610e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是一个关于预测新冠肺炎的全面而现实的教程，用Python代码来实现你自己的。</p><p id="a2c3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为什么要听我说的话？嗯，我是这篇论文的作者:<a class="ae lr" href="https://arxiv.org/abs/2106.08048" rel="noopener ugc nofollow" target="_blank">多病毒株的流行病建模:新型冠状病毒B.1.1.7在莫斯科的案例研究</a>。这个任务的复杂性让我头疼了几个月，现在我想帮你省去这个麻烦。</p><p id="3150" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Jupyter <a class="ae lr" href="https://github.com/btseytlin/covid_peak_sir_modelling/blob/main/habr_code.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本</a>附带教程代码。</p><h1 id="71f4" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">另一个新冠肺炎预测教程？</h1><p id="f813" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">有大量预测新冠肺炎的材料。在2021年1月的头几天，我听说了英国的冠状病毒株，以及美国第四波的<a class="ae lr" href="https://thezvi.wordpress.com/2021/01/06/fourth-wave-covid-toy-modeling/" rel="noopener ugc nofollow" target="_blank">预测。我很好奇:这是否会在我的城市莫斯科引发新的浪潮？于是我踏上了新冠肺炎模特之旅。我期望它在两周内完成。新冠肺炎肯定是目前研究最多的东西，肯定有人开发了一个我可以使用的模型，对吗？</a></p><p id="f8ab" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">不对。旅程花了三个月。事实证明，几乎没有任何关于建立流行病学模型的充分信息。大多数教程和论文都忽略了重要的细节，比如:</p><ul class=""><li id="3bd0" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated">为什么要选择特定的型号？</li><li id="2cdc" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">参数究竟是如何优化的？</li><li id="b19b" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">如何测试模型？它的预测效果好吗，还是仅仅符合训练数据？</li><li id="d1b1" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">该模型与基线相比如何？比仅仅预测前一天的情况更好吗？</li><li id="cfb0" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">模型是否推广到多个流行病波？不同地区？</li></ul><p id="35f4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最热门的发现:大多数关于模拟新冠肺炎的顶级出版物的作者没有使用训练测试分割。也就是说，他们从来没有检查模型是否真的预测，他们只是检查产生的曲线看起来很像历史数据。</p><p id="2b78" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我花了好几个星期试图找出有效的方法，并想:“希望有人能写清楚这一点！”。那会节省我几周的时间。这篇教程是我试图成为那个人，并节省你几个星期的修补。</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><p id="21d5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> <em class="nk">注来自《走向数据科学》的编辑:</em> </strong> <em class="nk">虽然我们允许独立作者根据我们的</em> <a class="ae lr" rel="noopener" target="_blank" href="/questions-96667b06af5"> <em class="nk">规则和指导方针</em> </a> <em class="nk">发表文章，但我们不认可每个作者的贡献。你不应该在没有寻求专业建议的情况下依赖一个作者的作品。详见我们的</em> <a class="ae lr" rel="noopener" target="_blank" href="/readers-terms-b5d780a700a4"> <em class="nk">读者术语</em> </a> <em class="nk">。</em></p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><h1 id="19c4" class="ls lt iq bd lu lv nl lx ly lz nm mb mc jw nn jx me jz no ka mg kc np kd mi mj bi translated">在莫斯科为新冠肺炎做模特</h1><p id="043f" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">首先，我们需要关于感染、死亡和康复的历史数据。莫斯科的数据可以在本页免费获得。我使用了2020年3月10日至2021年3月23日的时间框架。</p><p id="781a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">初始数据集覆盖了整个俄罗斯，但流行病模型最适合封闭人群，所以我们只选择莫斯科的数据。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="6cdb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">数据的输入通常有一些滞后，所以让我们添加所有列的移动平均平滑版本，以便以后使用。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="c536" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，我们的数据集包含以下各列及其平滑版本:</p><ul class=""><li id="6c68" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated">每天感染病例数—给定日期的新确诊病例数，</li><li id="07e4" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">recovered_per_day —给定日期的新康复患者，</li><li id="fdb3" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">每天死亡人数—给定日期的死亡人数(因感染),</li><li id="a9b6" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">total_infected —确诊病例总数，每天累计的感染总数。</li><li id="320a" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">total _ dead死亡总数，每天死亡的累计总数。</li><li id="105c" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">total_recovered —已恢复的患者总数，每天已恢复的累计总数。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/0de2a6b7762499e46bf18b5270a07e83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jTPp5rKaodqDMU2r.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">数据集预览，按作者分类的图像</p></figure><h1 id="2204" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">基本模型:SEIR</h1><p id="3835" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">让我们从流行病模型之父开始吧，先生。<a class="ae lr" href="https://en.wikipedia.org/wiki/Compartmental_models_in_epidemiology" rel="noopener ugc nofollow" target="_blank"> SIR </a>是一个模拟疫情在时间上发展的简单模型。它将人群分为三组:易感人群、感染人群和未感染人群。</p><p id="dafa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">爵士的想法解释得很简单:</p><ul class=""><li id="dc9f" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated">有一个封闭的人群和一个初始的感染人数。</li><li id="a8a0" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">每一天，每个感染者都有一定的概率感染易感人群中的某个人。</li><li id="384b" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">感染组中的某个人在疾病期结束后康复，并转移到恢复组。</li><li id="7bb0" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">这种算法会持续很多天。</li></ul><p id="6df1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">SIR没有对潜伏期和死亡进行建模，这意味着我们应该直接跳到扩展部分，SEIRD。塞德的工作方式和爵士一样；但是，它增加了两个组:</p><ul class=""><li id="0fb0" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated">暴露——受感染的人正在经历潜伏期。他们不会传播病毒。</li><li id="c21c" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">死者——死于病毒的人。</li></ul><p id="8b42" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为什么选择SEIRD作为基础型号？不是最强的机器学习模型，其实很简单。应该使用SEIRD的原因有三个。首先，它不是一个黑匣子:SEIRD <strong class="kx ir">的参数仅仅是疾病</strong>的特征。我们可以根据新冠肺炎作为一种疾病的医学研究来估计它们。第二，该模型很容易修改，这就是我们很快将通过增加隔离措施、不完全统计和第二个菌株来做的事情。值得一提的是，尽管SEIRD有缺点，但迄今为止最好的新冠肺炎预测模型是一个<a class="ae lr" href="https://covid19-projections.com/about/#about-the-model" rel="noopener ugc nofollow" target="_blank">改进的SEIR模型</a>。对于一些高中水平的微分方程来说很酷，对吧？</p><p id="02a6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们更深入地了解塞德。以下微分方程定义了人口组每天的变化:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/99e5533bdb7467d39ca9199deb8986f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/0*qeATnSvaNPbfHAJP.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="d948" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">看起来很吓人，但是请原谅我:这是高中的算术。</p><p id="c067" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以第三个等式为例。它描述了<strong class="kx ir"> <em class="nk"> I </em> </strong>组每天的变化。第一项意味着来自组<strong class="kx ir"> <em class="nk"> E </em> </strong>的每个人以概率<strong class="kx ir"> <em class="nk"> δ </em> </strong>完成他们的潜伏期并移动到组<strong class="kx ir"><em class="nk"/></strong><em class="nk">I，因此</em><strong class="kx ir"><em class="nk">【δE(t)</em></strong><em class="nk"/>被添加到<strong class="kx ir"> <em class="nk"> I </em> </strong>。其他术语描述了每天有多少人离开被感染的群体。组<strong class="kx ir"> <em class="nk"> I </em> </strong>的每个人恢复或死亡一个概率<strong class="kx ir"> <em class="nk"> γ </em> </strong>并移动到组<strong class="kx ir"> <em class="nk"> R </em> </strong>或<strong class="kx ir"> <em class="nk"> D </em> </strong>。参数<strong class="kx ir"> <em class="nk"> α、</em> </strong>即<strong class="kx ir"> <em class="nk"> </em> </strong> <a class="ae lr" href="https://en.wikipedia.org/wiki/Case_fatality_rate" rel="noopener ugc nofollow" target="_blank">感染致死率</a> <strong class="kx ir"> <em class="nk">、</em> </strong>决定一个人是否死亡并转到组<strong class="kx ir"> <em class="nk">、</em>、</strong>或恢复并转到组<strong class="kx ir"><em class="nk"/></strong></p><p id="f0af" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">总而言之，随着人们离开潜伏期，受感染的人数每天都在增加，同时，康复的和死亡的个体也离开了受感染的群体。</p><p id="89d4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">模型的参数:</p><p id="c030" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> <em class="nk"> α </em> </strong> —病死率。</p><p id="1303" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> <em class="nk"> β </em> </strong> —每天一个病人感染的人数。</p><p id="dd31" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"><em class="nk">△</em></strong>—1除以潜伏期的平均持续时间。</p><p id="2412" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> <em class="nk"> y </em> </strong> — 1除以平均病程。</p><p id="d66b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> <em class="nk"> R0 = β/y </em> </strong> —基本复制数。在疾病的整个持续时间内被一个病人感染的人数。</p><h1 id="df9f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">经典SEIRD的实现</h1><p id="6a81" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">要实现SEIRD，我们只需将微分方程转换成代码。这是实现，我们马上会详细介绍它的细节:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="9b00" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">代码太多了，让我们看看这里发生了什么。</p><p id="15ca" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">方法<em class="nk"> get_fit_params </em>初始化参数。我们为此使用了优化库lmfit，但是我们还没有优化参数。现在，我们使用结构<em class="nk"> lmfit。参数</em>作为高级字典。我用了一个<a class="ae lr" href="https://www.frontiersin.org/articles/10.3389/fpubh.2020.598547/full" rel="noopener ugc nofollow" target="_blank">新冠肺炎特性的元分析</a>来预定义参数的范围，这对优化帮助很大。</p><p id="002a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">参数<em class="nk">epidemic _ started _ days _ ago</em>允许设置第一个感染者出现的日期。据我推测，这件事发生在2020年3月2日。</p><p id="fad6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">方法<em class="nk">步骤</em>是模型的核心，它包含了模型的微分方程。它实现了一天组的更新。作为输入，它接收天数<em class="nk"> t </em>和所有组的初始大小作为元组<em class="nk"> initial_conditions </em>。它返回所有组中的更改。</p><p id="0e4c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">方法<em class="nk"> predict </em>接收初始值和数组<em class="nk"> t_range </em>作为输入数据。它所做的就是使用我们的方法步骤应用<a class="ae lr" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.integrate.odeint.html" rel="noopener ugc nofollow" target="_blank"> scipy.integrate.odeint </a>。它对<em class="nk"> t_range </em>中的天数的微分方程进行积分，并输出所有天数的组大小。本质上，它是运行我们模型的方法。</p><p id="9bd9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，方法<em class="nk"> get_initial_conditions </em>从第一个感染病例在<em class="nk">epidemic _ started _ days _ ago</em>天出现开始建模，并返回初始组大小。</p><p id="dc0b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们运行我们的模型，并将它的预测与现实进行比较:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/c9e5b96144f73fb2ce066d4b54351ce1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/0*eScuZo5q97cc_vnn.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由经典SEIRD模型预测的累积死亡人数(图片由作者提供)</p></figure><p id="f639" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Woops，模型预测大家都死了或者痊愈了，疫情就已经结束了。结果非常糟糕，但并不出人意料:我们没有优化任何参数，而且这个模型对新冠肺炎来说太简单了。</p><p id="a44a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了验证后一种说法，我们来看看所有赛德尔集团的动态:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/b82ae498f2305c2ac10e730244ba73cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y78Yvz2h6lfdNbtj.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">SEIRD模型的完整输出(图片由作者提供)</p></figure><p id="e9ad" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">模型描述的只是一次感染波，之后几乎所有人都康复，获得群体免疫，疫情告一段落。即使我们选择了最好的参数，这个模型也不是为了描述多重感染波而设计的。我们应该改变方程组以获得更好的结果。</p><h1 id="9b4b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">添加隔离措施</h1><p id="5944" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">出现新浪潮的原因之一是检疫措施。假设措施日<strong class="kx ir"><em class="nk"/></strong>减少<em class="nk">【R0】</em>的病乘<strong class="kx ir"><em class="nk"/></strong>的百分之。因此，可以计算在某种检疫措施作用下的繁殖数:<strong class="kx ir"><em class="nk">Rt = R0—R0 * q(t)</em></strong>每天。从中我们可以计算出<strong class="kx ir"> <em class="nk"> β(t) = Rt * y </em> </strong>并在方程中使用。</p><p id="14d7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后要考虑的是函数<strong class="kx ir"> <em class="nk"> q(t) </em> </strong>。在我的研究中，我使用了一个基本的阶跃函数。我们将整个日期范围分成60天的间隔。对于每个时间间隔，我们都在给定的时间间隔内设置了一定级别的隔离措施。从一个间隔到另一个间隔的过渡应该是平滑的(例如，通过使用sigmoid函数)。否则，函数将不会平滑，我们将无法优化参数。</p><p id="4916" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是一个带有sigmoid转换的逐步函数的实现，带有一个玩具示例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/d109db60ca40a0567a444fcfb76b887b.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*dI1OXtU1UjjVGB12KQXn3w.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">平滑逐步隔离级别函数的玩具示例(图片由作者提供)</p></figure><p id="3a3c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要将此添加到我们的SEIRD模型中，我们应该采取以下步骤:</p><ol class=""><li id="725d" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq nx mv mw mx bi translated">将检疫乘数添加到<em class="nk"> get_fit_params </em>中。最初，隔离级别为零；但是，它在其他区间的级别由优化定义。此外，我们添加了一个新的超参数，它设置了时间间隔的长度:<em class="nk"> stepwise_size </em>，默认值为60天。</li><li id="14cd" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq nx mv mw mx bi translated">添加<a class="ae lr" href="https://github.com/btseytlin/covid_peak_sir_modelling/blob/637ef78331c7f83fc2a43343e0c68b7542d72cff/sir_models/models.py#L70" rel="noopener ugc nofollow" target="_blank">一个新方法</a> <em class="nk"> get_step_rt_beta </em>，该方法使用一个阶跃函数计算<strong class="kx ir"><em class="nk">【t】</em></strong>和<strong class="kx ir"> <em class="nk"> Rt </em> </strong>。</li><li id="2fe3" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq nx mv mw mx bi translated">在方法步骤中使用<em class="nk"> get_step_rt_beta </em>。</li></ol><p id="5a44" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这样，我们的模型就能够考虑隔离措施了。但这就够了吗？不完全是。</p><h1 id="f595" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">不完整的统计数据</h1><p id="0e75" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">众所周知，并非所有的感染病例都记录在官方统计中。许多人没有住院，其他人携带疾病却没有症状。我们必须在我们的模型中考虑这些事实，因为经典的SEIRD模型从表面上看数据集，并不期望它是不完整的。</p><p id="15f9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们改变模型的分组，将案例分为统计数据中记录的案例和我们看不见的案例:</p><ul class=""><li id="48b0" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated"><strong class="kx ir"><em class="nk">【Iv(t)</em></strong>—传播病毒，在统计中有记录。</li><li id="7888" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated"><strong class="kx ir"> <em class="nk"> I(t) </em> </strong> —传播病毒，不在统计记录中。</li><li id="af0c" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated"><strong class="kx ir"><em class="nk"/></strong>—从病毒中恢复，记录在统计中。</li><li id="439b" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated"><strong class="kx ir"><em class="nk">【t】</em></strong>—从病毒中恢复，未记录在统计中。</li><li id="5b08" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated"><strong class="kx ir"><em class="nk">【Dv(t)</em></strong>—死亡，统计中有记录。</li><li id="0453" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated"><strong class="kx ir"> <em class="nk"> D(t) </em> </strong> —死了，统计中没有记载。</li></ul><p id="ee8f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">其他组，<strong class="kx ir"> <em class="nk"> S </em> </strong>和<strong class="kx ir"> <em class="nk"> E </em> </strong>保持不变。</p><p id="b460" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">此外，我们添加了两个新参数:</p><ul class=""><li id="fcfc" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated"><strong class="kx ir"> <em class="nk"> pi </em> </strong> —被感染病例被统计记录的概率。基本上概率能进<strong class="kx ir"> <em class="nk"> Iv </em> </strong>组。</li><li id="2a3a" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated"><strong class="kx ir"> <em class="nk"> pd </em> </strong> —统计中记录死亡的概率，即使感染病例没有被记录。来自组<strong class="kx ir"> <em class="nk"> Iv </em> </strong>的被感染个体总是去组<strong class="kx ir"> <em class="nk"> Dv </em> </strong>。</li></ul><p id="41a1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，我们有下面的模型方案，其中图的顶点是组，箭头决定人们如何在组之间移动:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/bd1bc82494a59facea3753458c81efee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TVDBgjnzZz_pFtN7.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">SEIRD-H原理图。有点像太空船，这很好。(图片由作者提供)</p></figure><p id="6bde" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该模型被命名为SEIRD-H: SEIRD with hidden states。更详细的实现在<a class="ae lr" href="https://github.com/btseytlin/covid_peak_sir_modelling/blob/637ef78331c7f83fc2a43343e0c68b7542d72cff/sir_models/models.py#L143" rel="noopener ugc nofollow" target="_blank">这里</a>给出。</p><h1 id="1079" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">参数优化</h1><p id="e543" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">模型准备好了。剩下的唯一事情是找到参数的最佳值，以便通过使用最小二乘优化的方法，由模型生成的Iv(t)、Rv(t)和Dv(t)对应于真实数据。</p><p id="0339" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们使用<a class="ae lr" href="https://lmfit.github.io/lmfit-py/fitting.html#lmfit.minimizer.minimize" rel="noopener ugc nofollow" target="_blank"> lmfit.minimize </a>。此函数接收一个可调用的作为输入，它返回一个残差列表并选择参数以最小化它们的总和。默认算法Levenberg-Marquardt方法非常适合该任务，但必须知道不能优化离散参数。例如，它不能为我们选择<em class="nk"> stepwise_size </em>。这就是我们必须平滑隔离功能的原因。</p><p id="1302" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们看一下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="390e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">主旨很简单。在间隔<em class="nk"> t_vals </em>中的每一天，我们都会收到预测的感染病例、死亡病例和康复病例。此外，计算并存储预测值与真实值的偏差。</p><p id="04a6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">之后，我们需要一些技巧。首先，新感染病例和新死亡病例的范围不同。在某一天看到一千个新病例，而同一时间只有一个人死亡，这是司空见惯的事。因此，如果我们只使用绝对残差，优化将只由感染病例的残差来定义。让我们使用函数smape_resid_transform将所有残差转换为相对误差，从而将它们重新调整到[0，1]范围。</p><p id="28c6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">其次，有理由认为死亡统计数据比感染和康复病例数据更可信。为了将这个假设添加到优化中，让我们用<em class="nk">自身权重</em>中的值来加权残差。在我们的情况下，死亡残差为0.5，其他为0.25似乎效果最好。</p><h1 id="163b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">模特培训</h1><p id="3404" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">现在有了隔离措施和隐藏状态，我们都准备好了！让我们在平滑的系列上训练SEIRD-H模型。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="2abb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">获得的参数:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/c54dadfa896eb4359c353b6aa5e46b4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1154/format:webp/0*TrdUYExu9c7kk81A.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">获得的模型参数(图片由作者提供)</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/da5a22ea7ed4f0f2363550572535cd1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/0*60tOfvHmwjqXzt23.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">通过第三代H模型对训练数据的累积死亡预测(图片由作者提供)</p></figure><p id="c7fd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">比早先获得的经典SEIR结果好得多！参数表明，根据我们的优化，几乎一半的死亡没有在统计中登记。对于感染病例，只有大约五分之一的病例有记录。</p><p id="ccd0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是学习的隔离功能:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/ecc48bfbe4d1836c4f3d1f89d83632ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*30DKolpLvUO9_RtPp4uiIg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">模型学习的隔离功能，以及它如何影响Rt(图片由作者提供)</p></figure><p id="2a22" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">人们应该小心SIR模型:一个模型可以显示关于死亡的真实预测，同时预测比现实多十倍的恢复病例，或者以其他方式作弊。查看模型的所有预测组件是有帮助的:每天的死亡、康复和感染病例。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/4238961a449573b38b5f996803cd631d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zVplZ9PqaAyQtiK9Tl6uaw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">SEIRD-H在训练数据上的完整输出(图片由作者提供)</p></figure><p id="316b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">完美，一切看起来都很好。模型当然会出错。重要的是，它似乎抓住了主要趋势。</p><h1 id="5e66" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">交叉验证的模型验证</h1><p id="572a" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">训练数据上的好数字没有告诉我们任何关于真实数据上的预测。我们必须验证这个模型的预测能力。在关于模拟新冠肺炎的出版物中，模型质量是通过预测累计死亡人数来评估的，所以我们也使用它。</p><p id="3b8f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将使用时间感知交叉验证。验证过程是这样的。从训练数据中选择几个日期，例如，每20天，对于每个日期:</p><ul class=""><li id="7ebf" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated">使用给定日期之前的所有数据来训练模型。</li><li id="dc77" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">预测未来30天的累计死亡人数。</li><li id="3646" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">计算预测误差。</li></ul><p id="6d39" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，计算模型的平均误差，并与基线持续性模型进行比较，基线持续性模型只是预测最后一个训练日。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/ba87294a8bcb04a7a4d99c8035509095.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y6CULPqykDN2_4Sbo-LwIA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">时间感知交叉验证的例子(图片由作者提供)</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="bce7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">结果:</p><ul class=""><li id="08be" class="mp mq iq kx b ky kz lb lc le mr li ms lm mt lq mu mv mw mx bi translated">基线平均绝对误差:714。</li><li id="687b" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">模型平均绝对误差:550。</li><li id="29ea" class="mp mq iq kx b ky my lb mz le na li nb lm nc lq mu mv mw mx bi translated">模型对称平均绝对百分比误差:4.6%</li></ul><p id="2284" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">模型击败基线，误差在5%左右。</p><h1 id="ebbb" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">最后的话</h1><p id="7bf0" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">这就是了。我们实现了经典的SEIR模型，我们通过添加隔离措施和隐藏组来处理不完整的数据，我们优化了参数。并使用时间感知交叉验证来验证最终模型。准确度没那么令人印象深刻，但是问题真的很难。从这一点出发，我们可以通过改进模型、重新运行评估过程和检查错误来进行迭代。一个很酷的特点是，该模型不是特定于数据集的:它可以用于其他地区和其他疾病。</p><p id="f3ce" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">感谢您的阅读，我希望您发现本教程有用！</p><h1 id="ef46" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">放弃</h1><p id="cbe0" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">这里表达的想法和观点仅是我个人的，不代表任何机构的观点。本出版物具有教育性质，不应被视为医疗建议。</p></div></div>    
</body>
</html>