<html>
<head>
<title>Python to SQL — UPSERT Safely, Easily and Fast</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python到SQL —安全、轻松、快速地向上插入</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/python-to-sql-upsert-safely-easily-and-fast-17a854d4ec5a?source=collection_archive---------2-----------------------#2021-08-08">https://towardsdatascience.com/python-to-sql-upsert-safely-easily-and-fast-17a854d4ec5a?source=collection_archive---------2-----------------------#2021-08-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f3af" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Python进行闪电般的插入和/或更新</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cc9a9264382e18699d0e6427ef30e5cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SWaDcRWjpxYsa_ot"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">是时候更新我们的存储空间并插入一些新东西了(图片由<a class="ae ky" href="https://unsplash.com/@steve_j" rel="noopener ugc nofollow" target="_blank">斯蒂夫·约翰森</a>在<a class="ae ky" href="https://unsplash.com/photos/S0j-5wSN3YQ" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供)</p></figure><p id="79a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您将数据向上插入到表中时，您会更新已存在的记录并插入新的记录。阅读完本文后，您将能够将Python应用程序连接到数据库，并以闪电般的速度更新数据。我们将通过几个实际例子来演示实现这一点的各种方法。它们都适合处理大型数据集；关注高速度和数据有效性。我们来编码吧！</p><p id="3371" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">另外，我们将在本例中使用SQL Server，但所使用的技术适用于各种数据库。</em></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="2a0d" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">1.设置和准备</h1><p id="6f6f" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们有一个出售各种音乐文章的网站。每小时我们都会收到一份来自所有供应商的文件，上面有他们当前的库存；他们出售的所有商品以及股票和价格信息。</p><p id="599a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本例中，我们将关注一个供应商的文件。我们的目标是增加销量；插入所有新文章并更新已经存在的文章。也许他们有新的股票价值或不同的价格。作为奖励，我们将了解如何删除缺货的商品。</p><h2 id="1fd6" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">1.1数据库准备</h2><p id="7142" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">让我们首先在数据库中创建一个可以插入的表。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/8c2a3ff22ac98603115b60215faaa426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8kDkfijOTN2Atb8N0JEGDg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的音乐物品表</p></figure><p id="dd55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，我们的小网店卖不了多少东西。没关系，虽然，它会保持这篇文章漂亮和简洁。最值得注意的是SKU专栏。这是库存单位；每个产品都有一个独一无二的编号。</p><h2 id="0a97" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">1.2 Python加载数据</h2><p id="16ad" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">假设我们的供应商给我们发送了新的CSV文件和他们的文章更新。我们已经编写了一个Python程序，它一检测到新文件就加载该文件。现在的目标是加载CSV，然后将其插入数据库。请记住，不需要从CSV中读取您的数据；任何数据结构都可以。首先，我们将加载CSV:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将新产品从csv加载到字典列表中</p></figure><p id="742f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我选择使用熊猫来阅读我的CSV，但这不是必需的。你可以用任何你喜欢的方法。这会产生以下数据帧:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/9d14ad6f53597d8233e3073e1ee6c675.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzvZeXclmof3KJK5OplCRA.png"/></div></div></figure><h2 id="3d30" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">1.3 Python创建数据库连接</h2><p id="a33c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们将使用SQLAlchemy创建一个数据库连接，连接到在我的本地主机上运行的SQL Server数据库。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="147a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通知<code class="fe nq nr ns nt b">fast_executemany=True</code>。这是一个专门针对SQL Server的功能，它可以确保以闪电般的速度插入数据。更多信息请见本文<a class="ae ky" href="https://mikehuls.medium.com/dramatically-improve-your-database-inserts-with-a-simple-upgrade-6dfa672f1424" rel="noopener"><strong class="lb iu">。</strong></a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/edc0ab5028f52adf067372f55817a877.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TmZcnVtcp340DAv8"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">准备工作做好了，我们来插入一些数据吧！(图片由<a class="ae ky" href="https://www.pexels.com/@elevate" rel="noopener ugc nofollow" target="_blank">将</a>提升到<a class="ae ky" href="https://www.pexels.com/photo/person-using-forklift-1267338/" rel="noopener ugc nofollow" target="_blank">像素</a>上)</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="4713" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">2.向上插入</h1><p id="61f4" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">加载我们的CSV，准备好我们的表，建立数据库连接；让我们插上！</p><h2 id="1cf9" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">这个计划</h2><p id="2180" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们首先将所有数据插入到一个临时表中。然后，如果这成功了，我们将合并我们的表。该操作允许您在一条语句中插入、更新<em class="lv">和</em>删除！有关合并的更多信息，请查看本文<a class="ae ky" href="https://mikehuls.medium.com/sql-insert-delete-and-update-in-one-statement-sync-your-tables-with-merge-14814215d32c" rel="noopener"><strong class="lb iu">。</strong></a></p><h2 id="b6df" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">执行</h2><p id="08ce" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们将遍历下面的代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="6d1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们分4个步骤执行升级:</p><ol class=""><li id="d9c3" class="nv nw it lb b lc ld lf lg li nx lm ny lq nz lu oa ob oc od bi translated">创建一个名为#NewProducts的临时表。这里没什么太令人兴奋的</li><li id="c545" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">将新数据插入临时表。<br/>我们使用一些好的参数将我们的新值批量插入到临时表中。在插入到SQL Server时，此插入操作还使用fast_executemany选项；这是超快的。</li><li id="427f" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">将临时表与目标表合并(MusicArticles) <br/>这就是神奇的地方:合并！我们拿SKU来比较产品。<br/> -如果它们不在目标(我们的音乐物品表)中，那么我们将简单地插入新的乐器。<br/> -两个表中都有SKU的产品得到更新。我们还更新了修改后的列。<br/> -在MusicalArticles中但不在temp表中的产品从MusicalArticles中删除。所以实际上这个语句不仅插入和更新，它还删除！您可以选择删除这一部分，以保持我们的声明是一个纯粹的upsert。</li><li id="e326" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">删除我们的临时表</li></ol><h2 id="156d" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">安全的</h2><p id="1e23" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">还要注意，我们在起始于<code class="fe nq nr ns nt b">with dbEngine.begin() as con</code>的代码块中执行这两个步骤。这将启动一个新的事务，确保块中的所有内容要么成功，要么回滚。这意味着如果合并失败，插入数据和创建临时表的操作将被撤消。更多交易信息请参见<a class="ae ky" href="https://mikehuls.medium.com/sql-rolling-back-statements-with-transactions-81937811e7a7" rel="noopener"> <strong class="lb iu">本文</strong> </a>。</p><p id="5ddb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果有更多的步骤，例如在插入或与许多表格合并后清理数据，这将非常方便。或者，您可以将insert语句放在不同的块中，这样大型插入就不会回滚，而只是将数据存储在临时表中。</p><h2 id="defa" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">结果</h2><p id="09dc" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">当然，这是一些不错的代码，但让我们看看一些结果！这是我们执行这个python脚本前后的MusicalArticles表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/0f8e76dba8466b6aa9e37cdfc9b96995.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bqos_Apn53w0J6zTTq8hQg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在插入之前(红色将被删除，橙色将被修改)</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/26cabbcfe5d45873f95b67c516f6b4fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nENK-yosMNOvSIyM24NlLg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">向上插入后(橙色被修改，绿色被新插入)</p></figure><p id="bdd0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会注意到SKU 123，24，33和34被修改了。不是价格变了就是库存变了。此外，我们还有两款新仪器SKU 35和111。还有，SKU 5577不见了！肯定卖光了。对于SKU 1233，一切都没有改变。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="fc70" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="48a9" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">通过这篇文章，我希望对如何安全、方便、快速地插入数据有所启发。如果你有建议/澄清，请评论，以便我可以改进这篇文章。与此同时，请查看我的其他关于各种编程相关主题的文章，比如:</p><ul class=""><li id="0d1a" class="nv nw it lb b lc ld lf lg li nx lm ny lq nz lu ok ob oc od bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-delete-into-another-table-b5b946a42299" rel="noopener">删除进入另一个表</a></li><li id="0eb6" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu ok ob oc od bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-into-another-table-bfc3dff79a66" rel="noopener">更新进入另一个标签页</a> le</li><li id="55d2" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu ok ob oc od bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-insert-delete-and-update-in-one-statement-sync-your-tables-with-merge-14814215d32c" rel="noopener">在一条语句中插入、删除和更新</a></li><li id="5867" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu ok ob oc od bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-select-in-one-query-b067a7e60136" rel="noopener">更新选择一批记录</a></li></ul><p id="e887" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><p id="961d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="5bc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page的缩写）学生:比如我正在做的事情？<a class="ae ky" href="https://github.com/mike-huls" rel="noopener ugc nofollow" target="_blank">跟我来</a>！</p></div></div>    
</body>
</html>