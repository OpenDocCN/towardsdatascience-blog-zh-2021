<html>
<head>
<title>Data anonymization layer using Snowflake and DBT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用雪花和DBT的数据匿名层</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-anonymization-layer-using-snowflake-and-dbt-c5f84e398358?source=collection_archive---------7-----------------------#2021-05-21">https://towardsdatascience.com/data-anonymization-layer-using-snowflake-and-dbt-c5f84e398358?source=collection_archive---------7-----------------------#2021-05-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/4f9d2f7bd21af39d8ebd7c5bc584aa0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Wxej-AMxwjt0DiSMprdGw.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">图片来自<a class="ae jd" href="https://www.instagram.com/laliceroma" rel="noopener ugc nofollow" target="_blank">爱丽丝·罗玛</a></p></figure><div class=""/><div class=""><h2 id="da27" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">使用DBT匿名化雪花上数据的可扩展方法</h2></div><p id="53df" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh"> HousingAnywhere </strong>是一个面向中长期租赁的在线市场平台。像任何其他数据驱动的业务一样，我们必须处理个人信息和<strong class="kx jh"> GDPR </strong>法规。在这篇简短的文章中，我将向你介绍我们匿名化<strong class="kx jh"> PII </strong>(个人身份信息)的解决方案。我将使用的技术是<a class="ae jd" href="https://www.snowflake.com/" rel="noopener ugc nofollow" target="_blank"><strong class="kx jh"/></a>【1】<strong class="kx jh"/>一个流行的数据仓库云解决方案和<a class="ae jd" href="https://cloud.getdbt.com/" rel="noopener ugc nofollow" target="_blank"><strong class="kx jh">DBT</strong></a>【2】(数据构建工具)一个数据转换工具。</p><p id="7f6f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从一些上下文开始；每天，我们的报告和分析都是由我们从各种来源获取的数据提供的，涵盖了我们业务的各个方面。这就产生了一个问题，<em class="lr">我们如何防止用户和服务不必要地访问暴露HousingAnywhere客户端pii的原始数据？</em></p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="ffe8" class="mb mc jg lx b gy md me l mf mg">from<br/>┌──────────────────┬──────────────────────┬─────────┐<br/>│       NAME       │         EMAIL        │ COUNTRY │<br/>├──────────────────┼──────────────────────┼─────────┤<br/>│ Tommaso Peresson │ <a class="ae jd" href="mailto:tompere96@gmail.com" rel="noopener ugc nofollow" target="_blank">placeholder@mail.com</a> │ IT      │<br/>└──────────────────┴──────────────────────┴─────────┘</span><span id="4b77" class="mb mc jg lx b gy mh me l mf mg">to<br/>┌──────────────────┬──────────────────────┬─────────┐<br/>│       NAME       │         EMAIL        │ COUNTRY │<br/>├──────────────────┼──────────────────────┼─────────┤<br/>│ 87444be...eb6b21 │ 3c33076...e1ceaf     │ IT      │<br/>└──────────────────┴──────────────────────┴─────────┘</span></pre><h1 id="0391" class="mi mc jg bd mj mk ml mm mn mo mp mq mr km ms kn mt kp mu kq mv ks mw kt mx my bi translated"><strong class="ak">简介</strong></h1><h2 id="273c" class="mb mc jg bd mj mz na dn mn nb nc dp mr le nd ne mt li nf ng mv lm nh ni mx nj bi translated">数据仓库配置</h2><p id="40a8" class="pw-post-body-paragraph kv kw jg kx b ky nk kh la lb nl kk ld le nm lg lh li nn lk ll lm no lo lp lq ij bi translated">为了使这个解决方案有效，您的数据仓库中需要两个区域:第一个阶段存储来自外部源的所有原始数据，另一个阶段容纳匿名化转换的结果。为此，我将创建两个数据库，分别命名为<strong class="kx jh"> PRIVATE_SOURCES </strong>和<strong class="kx jh"> SOURCES </strong>。如果你需要一些帮助来达到这个阶段，请遵循这个指南。</p><figure class="ls lt lu lv gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi np"><img src="../Images/0540040a9b70702db71630876b7e0df8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GKfwRaizKm1grXUG"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">图片来自Tommaso Peresson</p></figure><p id="7724" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">另一个关键要素是管理访问控制和权限，以便<strong class="kx jh"> PRIVATE_SOURCES </strong>数据库只能由管理员和数据工程师访问，而<strong class="kx jh"> SOURCES </strong>数据库可以由任何人访问。我不会深入讨论这个话题，但是如果你想了解更多关于特权和访问控制的知识，请阅读本文<a class="ae jd" href="https://trevorscode.com/comprehensive-tutorial-of-snowflake-privileges-and-access-control/" rel="noopener ugc nofollow" target="_blank"/>【4】。</p><p id="fda5" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们还需要一个包含要影响的列名及其各自的匿名方法(<code class="fe nq nr ns lx b">anonymization_mapping</code>)的信息的表，以及一个包含用于安全散列的<a class="ae jd" href="https://en.wikipedia.org/wiki/Salt_(cryptography)" rel="noopener ugc nofollow" target="_blank"><strong class="kx jh"/></a>【5】<strong class="kx jh"/>的表。</p><h1 id="70b2" class="mi mc jg bd mj mk ml mm mn mo mp mq mr km ms kn mt kp mu kq mv ks mw kt mx my bi translated">匿名化层</h1><p id="1dc5" class="pw-post-body-paragraph kv kw jg kx b ky nk kh la lb nl kk ld le nm lg lh li nn lk ll lm no lo lp lq ij bi translated">如果没有匿名化，任何有权访问数据仓库的人都可以窃取和使用个人信息。泄露数据就像输入<code class="fe nq nr ns lx b"><strong class="kx jh">select * from users</strong></code>一样简单。从这个<a class="ae jd" href="https://discourse.getdbt.com/t/pii-anonymization-and-dbt/29" rel="noopener ugc nofollow" target="_blank"> pos </a> t[6】中得到启发，我们决定使用DBT构建一个匿名化层。</p><p id="c43c" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们通过查看一个我们想要匿名的模型中的最终用法的例子来开始揭示我们的解决方案。</p><figure class="ls lt lu lv gt is"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="d187" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如您可能看到的，在select之后有一个宏调用。这是为了取代<code class="fe nq nr ns lx b">*</code>操作符并增加匿名化转换。我们的目标是找到一个可维护和可伸缩的解决方案，它不是文本密集型的，因为我们有数百个表，手动选择每一列当然不是一个很好的解决方案。让我们深入到宏中去理解实现细节。</p><h1 id="6d12" class="mi mc jg bd mj mk ml mm mn mo mp mq mr km ms kn mt kp mu kq mv ks mw kt mx my bi translated">深入研究实现</h1><p id="71cc" class="pw-post-body-paragraph kv kw jg kx b ky nk kh la lb nl kk ld le nm lg lh li nn lk ll lm no lo lp lq ij bi translated">让我们来看看组成这个系统的两个DBT宏。</p><p id="e713" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi nv translated"><span class="l nw nx ny bm nz oa ob oc od di"> 1。</span>从<code class="fe nq nr ns lx b">anonymize_columns()</code>开始，这个宏的目的是替换<code class="fe nq nr ns lx b">*</code>操作符，并向特定列添加匿名化转换。</p></div><div class="ab cl oe of hu og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="ij ik il im in"><figure class="ls lt lu lv gt is"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="6ff2" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以说这个宏执行两种不同的操作:</p><h2 id="8557" class="mb mc jg bd mj mz na dn mn nb nc dp mr le nd ne mt li nf ng mv lm nh ni mx nj bi translated">1.1创建映射</h2><p id="2ec3" class="pw-post-body-paragraph kv kw jg kx b ky nk kh la lb nl kk ld le nm lg lh li nn lk ll lm no lo lp lq ij bi translated">(<code class="fe nq nr ns lx b"><strong class="kx jh">rows 2:13</strong></code>)从<code class="fe nq nr ns lx b"><a class="ae jd" href="https://docs.snowflake.com/en/sql-reference/info-schema.html" rel="noopener ugc nofollow" target="_blank">private_sources.information_schema</a>.columns</code>中获取所有的列名，并用列名上的<code class="fe nq nr ns lx b">anonymization_mapping</code>将它们连接起来。因此，我们将有一个包含object中的表的列的表，并与正确的匿名化函数配对。<em class="lr">例如</em><code class="fe nq nr ns lx b">users</code>表有三列:<code class="fe nq nr ns lx b">name</code>、<code class="fe nq nr ns lx b">email</code>和<code class="fe nq nr ns lx b">country</code>。在我们的具体例子中，我们可能只想匿名化<code class="fe nq nr ns lx b">name</code>和<code class="fe nq nr ns lx b">email</code>列，而不去碰<code class="fe nq nr ns lx b">country</code>。</p><p id="2f4d" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要做到这一点，我们的<code class="fe nq nr ns lx b">anonymization_mapping</code>将必须包含这两行，指示哪些列必须被转换以及使用哪个函数:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="8ee0" class="mb mc jg lx b gy md me l mf mg">ANONYMIZATION_MAPPING (config)<br/>┌───────────────────┬─────────────┬───────────┐<br/>│ TABLE_NAME_FILTER │ COLUMN_NAME │ FUNCTION  │<br/>├───────────────────┼─────────────┼───────────┤<br/>│ production.users  │ name        │ full_hash │<br/>│ production.users  │ email       │ full_hash │<br/>└───────────────────┴─────────────┴───────────┘</span></pre><p id="b41b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在将它与语句中包含的查询中的<code class="fe nq nr ns lx b">information_schema.columns</code>连接之后，映射将如下所示</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="fdef" class="mb mc jg lx b gy md me l mf mg">mapping (sql statement output)<br/>┌───────────────────┬─────────────┬───────────┐<br/>│ TABLE_NAME_FILTER │ COLUMN_NAME │ FUNCTION  │<br/>├───────────────────┼─────────────┼───────────┤<br/>│ production.users  │ name        │ full_hash │<br/>│ production.users  │ email       │ full_hash │<br/>│ NULL              │ country     │ NULL      │<br/>└───────────────────┴─────────────┴───────────┘</span></pre><p id="272d" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh">注意</strong>我们也可以将<code class="fe nq nr ns lx b">anonymization_mapping</code>中的<code class="fe nq nr ns lx b">TABLE_NAME_FILTER</code>留空，这将匿名化<strong class="kx jh">每一列</strong>的匹配名称<strong class="kx jh">，而不通过表</strong>过滤 <strong class="kx jh">。这在我们有多个具有相同列名的表必须匿名的情况下很有用。</strong></p><h2 id="fab9" class="mb mc jg bd mj mz na dn mn nb nc dp mr le nd ne mt li nf ng mv lm nh ni mx nj bi translated">1.2打印字段名及其转换</h2><p id="97bc" class="pw-post-body-paragraph kv kw jg kx b ky nk kh la lb nl kk ld le nm lg lh li nn lk ll lm no lo lp lq ij bi translated">(<code class="fe nq nr ns lx b"><strong class="kx jh">rows 14:27</strong></code>)这部分宏使用上一步(<code class="fe nq nr ns lx b">mapping</code>)的输出，通过将列名映射到正确的匿名函数，打印出要放入<code class="fe nq nr ns lx b">select</code>语句中的正确的<strong class="kx jh">列名</strong>和<strong class="kx jh">函数</strong>。例如，遵循上一个示例时，宏的输出将是:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="e64a" class="mb mc jg lx b gy md me l mf mg">SHA256(name) as name,<br/>SHA256(email) as email,<br/>country</span></pre><p id="8484" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最终编译后的模型如下所示:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="5a27" class="mb mc jg lx b gy md me l mf mg">select<br/><strong class="lx jh"> SHA256(name) as name,<br/> SHA256(email) as email,<br/> country</strong><br/>from <br/> private_sources.production.users</span></pre><p id="dc53" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有效地匿名化了表中的敏感内容。</p><p id="15d6" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi nv translated"><span class="l nw nx ny bm nz oa ob oc od di"> 2。</span>第二个宏用于分组并轻松使用不同的<strong class="kx jh">匿名化转换。</strong>这只是将选择的转换应用到一个列。为了展示它的用法，我包含了两种不同的方法，一种是散列整个单元格的内容，另一种是对单元格的内容应用一个<em class="lr"> REGEX </em>来仅匿名化电子邮件地址的用户部分。</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="6ffc" class="mb mc jg lx b gy md me l mf mg">FROM: <a class="ae jd" href="mailto:tompere@housinganywhere.com" rel="noopener ugc nofollow" target="_blank">tompere@housinganywhere.com</a><br/>TO: SHA256(tompere+salt)@housinganywhere.com</span></pre><figure class="ls lt lu lv gt is"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="c8d0" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">同样重要的是要强调，无论何时使用散列函数，都需要<strong class="kx jh">添加<strong class="kx jh">盐</strong>，否则我们的散列将容易受到<a class="ae jd" href="https://en.wikipedia.org/wiki/Dictionary_attack#:~:text=In%20cryptanalysis%20and%20computer%20security,a%20dictionary%20or%20previously%20used" rel="noopener ugc nofollow" target="_blank"> <strong class="kx jh">字典</strong>攻击</a>。</strong></p><h1 id="8d6c" class="mi mc jg bd mj mk ml mm mn mo mp mq mr km ms kn mt kp mu kq mv ks mw kt mx my bi translated">结论</h1><p id="f81c" class="pw-post-body-paragraph kv kw jg kx b ky nk kh la lb nl kk ld le nm lg lh li nn lk ll lm no lo lp lq ij bi translated"><strong class="kx jh"> GDPR </strong>法规的目的是提高消费者对持有和处理个人数据的组织的信心，以及标准化和简化欧盟范围内的信息自由流动。在<strong class="kx jh"> HousingAnywhere </strong>中，我们始终相信，用户的隐私是建立对我们平台的信任和信心的关键，这也是我们在设计数据基础设施时如此小心的原因。</p><p id="cbd8" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，还应该提到一个事实，即<strong class="kx jh"> Snowflake </strong>提供了一个现成的匿名化解决方案，名为<strong class="kx jh">动态数据屏蔽</strong>，仅适用于企业账户。</p><p id="9499" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">感谢<a class="ol om ep" href="https://medium.com/u/620e80a41755?source=post_page-----c5f84e398358--------------------------------" rel="noopener" target="_blank"> Julian Smidek </a>成为如此伟大的经理人:)</p><p id="b92f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">[1] <em class="lr"> DBT云</em>。2021年5月20日访问。<a class="ae jd" href="https://cloud.getdbt.com/" rel="noopener ugc nofollow" target="_blank">https://cloud.getdbt.com/</a>。</p><p id="e107" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">[2] <em class="lr"> DBT话语</em>。PII匿名化和DBT——建模”，2018年4月26日。<a class="ae jd" href="https://discourse.getdbt.com/t/pii-anonymization-and-dbt/29" rel="noopener ugc nofollow" target="_blank">https://discourse.getdbt.com/t/pii-anonymization-and-dbt/29</a></p><p id="cfdf" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">【3】<em class="lr">第二步。创建雪花对象—雪花文档。</em>2021年5月20日访问。<a class="ae jd" href="https://docs.snowflake.com/en/user-guide/getting-started-tutorial-create-objects.html" rel="noopener ugc nofollow" target="_blank">https://docs . snow flake . com/en/user-guide/getting-started-tutorial-create-objects . html</a>。</p><p id="5e46" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">[4] <em class="lr">《雪花特权与访问控制综合教程——特雷弗的代码》。</em>2021年5月20日访问。https://trevorscode . com/comprehensive-tutorial-of-snow flake-privileges-and-access-control/。</p><p id="0634" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">[5] <em class="lr">盐(密码术)</em>。2021年5月17日，维基百科。<a class="ae jd" href="https://en.wikipedia.org/w/index.php?title=Salt_(cryptography)&amp;oldid=1023634352" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/w/index.php?title=Salt_(密码术)&amp; oldid=1023634352 </a>。</p><p id="905a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="lr">【6】雪花。数据云|雪花|支持最关键的工作负载'</em>。2021年5月20日访问。<a class="ae jd" href="https://www.snowflake.com/" rel="noopener ugc nofollow" target="_blank">https://www.snowflake.com/</a>。</p></div></div>    
</body>
</html>