<html>
<head>
<title>What a TFRecord Is and How to Create It</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">什么是TFRecord以及如何创建它</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/what-a-tfrecord-is-and-how-to-create-it-6be3c92c13cc?source=collection_archive---------18-----------------------#2021-08-24">https://towardsdatascience.com/what-a-tfrecord-is-and-how-to-create-it-6be3c92c13cc?source=collection_archive---------18-----------------------#2021-08-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bc60" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何使用TFRecord格式有效地训练神经网络</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/804967fcc41d241d166e246515b10151.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hcKZe4hkZyfRbDcQlEgogw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">简·安东宁·科拉尔在<a class="ae ky" href="https://unsplash.com/s/photos/files?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="2ee8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">TensorFlow是当今最流行的深度学习框架之一。有些人相信它，有些人认为它是一个伟大但臃肿的工具，一个承载着沉重遗留代码负担的工具。</p><p id="d91c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就个人而言，我更喜欢使用PyTorch，但在我看来，每个机器学习(ML)研究人员或工程师都应该知道如何找到进入TensorFlow知识库的方法。该领域有很多创新，几乎一半是用TensorFlow表达的。</p><p id="1d3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，在很大程度上，TensorFlow是一个固执己见的框架。它最出名的僵硬API之一与数据处理和加载有关。</p><p id="39ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个故事中，我们转向基础，看看TFRecords，它们是什么，如何生成它们，以及如何有效地使用它们来训练神经网络。</p><blockquote class="lv lw lx"><p id="9239" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated"><a class="ae ky" href="https://www.dimpo.me/newsletter?utm_source=medium&amp;utm_medium=article&amp;utm_campaign=tfrecord" rel="noopener ugc nofollow" target="_blank"> Learning Rate </a>是一份时事通讯，面向那些对AI和MLOps世界感到好奇的人。你会在每周五收到我关于最新人工智能新闻和文章的更新和想法。订阅<a class="ae ky" href="https://www.dimpo.me/newsletter?utm_source=medium&amp;utm_medium=article&amp;utm_campaign=tfrecord" rel="noopener ugc nofollow" target="_blank">这里</a>！</p></blockquote></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="e0e6" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">TFRecords:什么和为什么</h1><p id="c340" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">TFRecord格式是Tensorflow自己的二进制存储格式。它使用<a class="ae ky" href="https://developers.google.com/protocol-buffers/" rel="noopener ugc nofollow" target="_blank">协议缓冲区</a>，这是一个跨平台、跨语言的库，用于结构化数据的高效序列化。使用TFRecord格式有许多优点:</p><ul class=""><li id="1197" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated"><strong class="lb iu">效率</strong>:TF record格式的数据可以比原始数据占用更少的空间。</li><li id="32c1" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><strong class="lb iu">快速I/O </strong> : TensorFlow可以通过并行I/O操作读取TFRecord格式的数据。当你使用GPU或TPU设备时，这非常有用。</li><li id="3df0" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><strong class="lb iu">自包含文件</strong> : TFRecords是自包含的，这意味着您可以在一个文件中拥有您需要的一切，数据及其元数据，并且格式允许您使用对您来说重要的任何内容。</li></ul><h1 id="cc8d" class="mj mk it bd ml mm nu mo mp mq nv ms mt jz nw ka mv kc nx kd mx kf ny kg mz na bi translated">TFRecords:如何</h1><p id="02a8" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们看到使用TFRecords代替原始数据格式有几个优点。然而，天下没有免费的午餐。您必须完成这项工作，并将原始数据转换为TFRecords。</p><p id="f493" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了实现这一点，您需要主要使用两个类:</p><ul class=""><li id="8e1f" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated"><code class="fe nz oa ob oc b"><a class="ae ky" href="https://www.tensorflow.org/api_docs/python/tf/train/Example" rel="noopener ugc nofollow" target="_blank">tf.train.Example</a></code>或<code class="fe nz oa ob oc b"><a class="ae ky" href="https://www.tensorflow.org/api_docs/python/tf/train/SequenceExample" rel="noopener ugc nofollow" target="_blank">tf.train.SequenceExample</a></code>取决于您的数据</li><li id="3665" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe nz oa ob oc b"><a class="ae ky" href="https://www.tensorflow.org/api_docs/python/tf/train/Feature" rel="noopener ugc nofollow" target="_blank">tf.train.Feature</a></code></li></ul><p id="b411" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，您需要以下列格式之一来表示数据集的要素:</p><ul class=""><li id="3b9d" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated"><code class="fe nz oa ob oc b"><a class="ae ky" href="https://www.tensorflow.org/api_docs/python/tf/train/BytesList" rel="noopener ugc nofollow" target="_blank">tf.train.BytesList</a></code></li><li id="ccc4" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe nz oa ob oc b"><a class="ae ky" href="https://www.tensorflow.org/api_docs/python/tf/train/FloatList" rel="noopener ugc nofollow" target="_blank">tf.train.FloatList</a></code></li><li id="ad62" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe nz oa ob oc b"><a class="ae ky" href="https://www.tensorflow.org/api_docs/python/tf/train/Int64List" rel="noopener ugc nofollow" target="_blank">tf.train.Int64List</a></code></li></ul><p id="ef98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，让我们看看如何使用一个简单的<a class="ae ky" href="https://keras.io/examples/keras_recipes/creating_tfrecords/" rel="noopener ugc nofollow" target="_blank">示例</a>来实现这一点，由<a class="ae ky" href="https://www.linkedin.com/in/dimitre-oliveira-7a1a0113a/" rel="noopener ugc nofollow" target="_blank"> Dimitre Oliveira </a>提供:我们将把<a class="ae ky" href="https://cocodataset.org/#home" rel="noopener ugc nofollow" target="_blank"> COCO2017 </a>数据集转换成TFRecords。</p><h1 id="5b1f" class="mj mk it bd ml mm nu mo mp mq nv ms mt jz nw ka mv kc nx kd mx kf ny kg mz na bi translated">简单的例子</h1><p id="e292" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">COCO2017数据集有两个子集:图像和注释元数据。它用于为执行对象检测、关键点检测、全景分割或解决密集任务的模型建立基线。</p><p id="6042" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">图像以JPG格式存储，注释数据存储为普通的JSON文件，包含以下属性:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="ab49" class="oh mk it oc b gy oi oj l ok ol">id: int,<br/>image_id: int,<br/>category_id: int,<br/>segmentation: RLE or [polygon], object segmentation mask<br/>bbox: [x,y,width,height], object bounding box coordinates<br/>area: float, area of the bounding box<br/>iscrowd: 0 or 1, is single object or a collection</span></pre><p id="84c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，特定图像的元数据可能是这样的:</p><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="4485" class="oh mk it oc b gy oi oj l ok ol">{<br/>   "area": 367.89710000000014,<br/>   "bbox": [<br/>      265.67,<br/>      222.31,<br/>      26.48,<br/>      14.71<br/>   ],<br/>   "category_id": 72,<br/>   "id": 34096,<br/>   "image_id": 525083,<br/>   "iscrowd": 0,<br/>   "segmentation": [<br/>      [<br/>         267.51,<br/>         222.31,<br/>         292.15,<br/>         222.31,<br/>         291.05,<br/>         237.02,<br/>         265.67,<br/>         237.02<br/>      ]<br/>   ]<br/>}</span></pre><p id="f68c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到，要转换这个数据集，我们需要使用TFRecord API提供的几乎所有类型。我们需要转换整数、浮点数、浮点数列表和图像。让我们把手弄脏吧。</p><h2 id="5d81" class="oh mk it bd ml om on dn mp oo op dp mt li oq or mv lm os ot mx lq ou ov mz ow bi translated">将数据转换为TFRecords</h2><p id="ca74" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">假设我们已经将数据加载到一个名为<code class="fe nz oa ob oc b">annotations</code>的变量中，让我们指定每个TFRecord上的样本数，以及我们将创建多少个这样的文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ox oy l"/></div></figure><p id="0f8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们准备创建我们的助手函数，将每个特性转换成其等效的<code class="fe nz oa ob oc b">tf.train.Feature</code>格式:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ox oy l"/></div></figure><p id="7844" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，让我们再添加两个函数:一个使用上面的实用程序创建一个<code class="fe nz oa ob oc b">tf.train.Example</code>对象，另一个解析它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ox oy l"/></div></figure><p id="874b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，剩下的就是读取数据并将它的点转换成TFRecords:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ox oy l"/></div></figure><p id="2db3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的工作区中，您应该准备好了九个<code class="fe nz oa ob oc b">.tfrec</code>文件。</p><h2 id="1e02" class="oh mk it bd ml om on dn mp oo op dp mt li oq or mv lm os ot mx lq ou ov mz ow bi translated">训练简单的分类器</h2><p id="f36b" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">现在我们被读取来训练任何我们想要的模型，使用我们创建的<code class="fe nz oa ob oc b">.tfrec</code>文件和Keras。</p><p id="3e27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，让我们创建一个助手函数，它将从我们之前创建的TFrecords生成数据集:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ox oy l"/></div></figure><p id="e317" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们准备好享受我们的工作成果，并训练一个简单的Keras分类器:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ox oy l"/></div></figure><p id="bd4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">仅此而已！要端到端地运行整个示例，您可以使用由<a class="ae ky" href="https://www.linkedin.com/in/dimitre-oliveira-7a1a0113a/" rel="noopener ugc nofollow" target="_blank">迪米特里·奥利维拉</a>在colab上的这个优秀的<a class="ae ky" href="https://colab.research.google.com/github/keras-team/keras-io/blob/master/examples/keras_recipes/ipynb/creating_tfrecords.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本</a>。</p><h1 id="41a5" class="mj mk it bd ml mm nu mo mp mq nv ms mt jz nw ka mv kc nx kd mx kf ny kg mz na bi translated">结论</h1><p id="22f3" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">TensorFlow是当今最流行的深度学习框架之一。每个机器学习(ML)研究人员或工程师都应该知道如何在TensorFlow存储库中导航。这个领域有很多创新，很多都是用TensorFlow表达的。</p><p id="435d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个故事中，我们看到了TFRecord格式，为什么应该使用它，以及如何使用。然后，我们使用了Dimitre Oliveira 提供的一个极好的例子来练习我们的知识。</p><p id="cd94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下次使用Keras训练神经网络时，考虑利用TFRecords的能力，尤其是如果您计划使用TPUs的话！</p><h1 id="07fc" class="mj mk it bd ml mm nu mo mp mq nv ms mt jz nw ka mv kc nx kd mx kf ny kg mz na bi translated">关于作者</h1><p id="03f5" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我叫<a class="ae ky" href="https://www.dimpo.me/?utm_source=medium&amp;utm_medium=article&amp;utm_campaign=tfrecord" rel="noopener ugc nofollow" target="_blank"> Dimitris Poulopoulos </a>，我是一名为<a class="ae ky" href="https://www.arrikto.com/" rel="noopener ugc nofollow" target="_blank"> Arrikto </a>工作的机器学习工程师。我曾为欧洲委员会、欧盟统计局、国际货币基金组织、欧洲央行、经合组织和宜家等主要客户设计和实施过人工智能和软件解决方案。</p><p id="6b18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有兴趣阅读更多关于机器学习、深度学习、数据科学和数据操作的帖子，请关注我的<a class="ae ky" href="https://towardsdatascience.com/medium.com/@dpoulopoulos/follow" rel="noopener" target="_blank"> Medium </a>、<a class="ae ky" href="https://www.linkedin.com/in/dpoulopoulos/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或Twitter上的<a class="ae ky" href="https://twitter.com/james2pl" rel="noopener ugc nofollow" target="_blank"> @james2pl </a>。</p><p id="3c99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所表达的观点仅代表我个人，并不代表我的雇主的观点或意见。</p></div></div>    
</body>
</html>