<html>
<head>
<title>How Wish A/B tests percentiles</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">希望A/B如何测试百分点</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-wish-a-b-tests-percentiles-35ee3e4589e7?source=collection_archive---------14-----------------------#2021-08-09">https://towardsdatascience.com/how-wish-a-b-tests-percentiles-35ee3e4589e7?source=collection_archive---------14-----------------------#2021-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9abc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">大规模在线实验中百分点差异的检测方法研究</h2></div><p id="6d48" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">投稿人:<a class="ae lb" href="https://medium.com/@qike_max_li" rel="noopener">戚克(Max)李</a>&amp;<a class="ae lb" href="https://www.linkedin.com/in/bo-gao-374b082b/" rel="noopener ugc nofollow" target="_blank"/></p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/d0cc02d1bc5fc9a0d4a461a6d5bc23a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*u9DK_QZUD5BI4Ee6"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">图片由<a class="ae lb" href="https://pixabay.com/users/geralt-9301/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2422185" rel="noopener ugc nofollow" target="_blank"> Gerd Altmann </a>从<a class="ae lb" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2422185" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>拍摄</p></figure><p id="97d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们分享了我们为百分位数开发A/B测试方法的旅程。您将看到示例用例、为什么A/B测试百分比指标具有挑战性、看似简单的解决方案如何失败、我们最终使用的统计测试以及测试的性能。</p><p id="f11a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<a class="ae lb" href="https://www.wish.com/careers?hide_login_modal=true" rel="noopener ugc nofollow" target="_blank">愿望</a>时，我们<a class="ae lb" href="https://en.wikipedia.org/wiki/A/B_testing" rel="noopener ugc nofollow" target="_blank"> A/B测试</a>几乎所有的新<a class="ae lb" href="https://www.productboard.com/glossary/product-features/" rel="noopener ugc nofollow" target="_blank">产品特性</a>以确保它们增强用户体验。在每个实验中，我们对许多指标进行<a class="ae lb" href="https://en.wikipedia.org/wiki/Statistical_hypothesis_testing" rel="noopener ugc nofollow" target="_blank">假设检验</a>，其中一些指标是<a class="ae lb" href="https://en.wikipedia.org/wiki/Percentile#:~:text=In%20statistics%2C%20a%20percentile%20(or,percentage%20falls%20(inclusive%20definition)." rel="noopener ugc nofollow" target="_blank">百分位</a>，如P50(第五十百分位或中值)或P95(第九十五百分位)。当测试来自两个实验组的两个百分位数的差异时(例如，对照组的P95与治疗组的P95)，典型的假设检验方法，例如<a class="ae lb" href="https://en.wikipedia.org/wiki/Student%27s_t-test" rel="noopener ugc nofollow" target="_blank"> t检验</a>，并不适用，因为这些检验比较的是两个样本的平均值，而不是百分位数。</p><h1 id="7e20" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">示例使用案例</h1><p id="6cf4" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">百分比A/B测试使我们能够衡量新产品功能对网站性能的影响。网站性能极大地影响了用户体验，并产生了实实在在的金钱效应。<a class="ae lb" href="https://www.forbes.com/sites/steveolenski/2016/11/10/why-brands-are-fighting-over-milliseconds/?sh=329501754ad3" rel="noopener ugc nofollow" target="_blank">亚马逊发现</a>仅仅100毫秒的额外加载时间就让他们损失了1%的销售额。<a class="ae lb" href="https://medium.com/pinterest-engineering/driving-user-growth-with-performance-improvements-cfc50dafadd7" rel="noopener"> Pinterest减少了40%的等待时间，这使得搜索引擎流量和注册人数增加了15%。</a></p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi mp"><img src="../Images/9fe562802e9187a330b6f6c5a9fce5d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aiRv5gMcjTlBZjFe"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@chuttersnap?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> CHUTTERSNAP </a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="2d93" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">百分位数，如P50(第五十个百分位数)或P95(第九十五个百分位数)，是比样本均值更好的网站绩效指标。例如，对于所有用户，产品A在0.5秒内加载，对于95%的用户，产品B在0秒内加载，对于5%的用户，在10秒内加载。尽管两种产品的平均加载时间相同，但产品A的用户体验要好得多。产品A在瞬间为所有用户加载。相比之下，5%的用户似乎永远都无法加载产品B，糟糕的体验可能会鼓励这些用户流失。在整篇文章中，我们关注的是百分比测试在性能度量中的应用。</p><p id="d789" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">除了性能指标之外，当我们关心对指标分布的影响时，百分位数测试开启了许多其他的应用。例如，百分比测试对于事务度量也是非常宝贵的。Wish致力于提供一个公平的市场，为各种规模的商家发展业务。因此，当我们改变政策时，我们的目标是提高所有商家的销售额。因此，在A/B测试控制和展示时段之间的平均销售额时，我们还需要比较P10、P50和P90等百分点，以确保该政策不会通过严重偏袒少数顶级商家来提高平台销售额，这可能会使小型商家处于不利地位。</p><h1 id="06d9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">测试百分位数的挑战</h1><p id="6783" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">A/B测试绩效指标的百分比差异具有挑战性，原因如下:</p><ul class=""><li id="8f54" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated"><strong class="kh ir">挑战一:随机化单元</strong>。大多数实验平台随机选择用户，这保证了用户之间的独立性。但是性能指标是在响应级别测量的，来自相同用户的响应时间可能是相关的，这违反了大多数统计测试的独立性假设，并且可能产生很高的误报率。这通常被称为随机化单元<a class="ae lb" href="http://alexdeng.github.io/public/files/WSDM2017draft.pdf" rel="noopener ugc nofollow" target="_blank">和分析单元</a>【1】之间的差异。</li><li id="d1ae" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated"><strong class="kh ir">挑战二:可扩展性。</strong>该方法需要具有足够的可扩展性，以便在可接受的时间框架内从数十亿行输入数据中进行假设检验。</li></ul><h1 id="f68b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">我们首先探索简单的解决方案</h1><h2 id="afb1" class="ne lt iq bd lu nf ng dn ly nh ni dp mc ko nj nk me ks nl nm mg kw nn no mi np bi translated">我们能否设置一个固定的阈值来检测性能变化？</h2><p id="ae22" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">是否足以检查治疗组和对照组之间的差异是否高于固定阈值，例如100毫秒的差异或10%的相对变化？例如，如果处理桶中的P95比控制桶中的P95高100ms，或者处理桶中的P95比控制桶中的P95高10%,则我们得出结论:产品特性引入了延迟。</p><p id="3fcd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了查看使用固定阈值是否合适，我们回顾性地进行了几次<a class="ae lb" href="https://www.optimizely.com/optimization-glossary/aa-testing/" rel="noopener ugc nofollow" target="_blank">模拟/模拟实验</a>，发现固定绝对变化和固定相对变化都不起作用。注:对于这些A/A实验，显示和控制之间的任何差异都不是真正的差异，而是由于自然波动。</p><p id="5168" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们研究了各种原料药在治疗组和对照组之间的P95差异。由于以下原因，使用固定阈值是不可靠的。</p><ul class=""><li id="ce5b" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">一个API可能比另一个慢两个数量级。对于一个API来说，10 ms的差异无疑是性能下降，但对于另一个API来说，这可能是由于自然波动造成的。</li><li id="7a2f" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">当我们观察较少使用的API的延迟时，样本百分比变化可能相当大。例如，样本百分位数中10%的差异可能来自自然变异。然而，对于大量使用的原料药，P95增加10%可能表明性能显著下降。</li></ul><p id="2780" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">与统计测试相反，固定阈值不考虑样本差异(即某些API的响应时间比其他API的响应时间更易变)，因此，不能保证良好控制的<a class="ae lb" href="https://en.wikipedia.org/wiki/Type_I_and_type_II_errors" rel="noopener ugc nofollow" target="_blank">I型错误率</a>(假阳性率)。</p><h2 id="db5c" class="ne lt iq bd lu nf ng dn ly nh ni dp mc ko nj nk me ks nl nm mg kw nn no mi np bi translated">可以应用<a class="ae lb" href="https://stattrek.com/hypothesis-test/difference-in-proportions.aspx" rel="noopener ugc nofollow" target="_blank">比例Z检验</a>吗？</h2><p id="f3b6" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">双样本<a class="ae lb" href="https://stattrek.com/hypothesis-test/difference-in-proportions.aspx" rel="noopener ugc nofollow" target="_blank">比例Z检验</a>允许我们比较两个比例，以查看两个比例之间的差异是否显著。当两个实验组的两个P95之间确实存在显著差异时，合并的P95(来自对照和处理的组合数据的P95)之上的样品比例将存在显著差异。为了说明，假设治疗组、对照组和混合组中的P95潜伏期分别为300毫秒、100毫秒和200毫秒。假设两组大小相等，治疗(控制)组可能包含明显更多(更少)的200ms以上的数据点。为了使用此属性构建一个有意义的测试，我们将比例Z测试修改如下:</p><ul class=""><li id="937c" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">计算合并的P95。</li><li id="6155" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">使用比例Z测试来比较响应时间高于治疗组和对照组的合并P95的请求的比例。</li></ul><p id="8717" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种方法对于比较百分位数似乎是合理的。但是，不幸的是，它没有解决实验单元和分析单元之间的差异(<strong class="kh ir">挑战I </strong>)。因此，我们以如下两种不同的方式模拟<a class="ae lb" href="https://www.optimizely.com/optimization-glossary/aa-testing/" rel="noopener ugc nofollow" target="_blank"> A/A检验</a>，以研究修正的比例Z检验是否适用于百分位数。</p><ul class=""><li id="5f19" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">追溯模拟的<a class="ae lb" href="https://www.optimizely.com/optimization-glossary/aa-testing/" rel="noopener ugc nofollow" target="_blank"> A/A测试</a>使用来自Wish的数据，采用两种不同的随机化:1)随机化用户(<strong class="kh ir">随机化I</strong>)；2)随机化请求(<strong class="kh ir">随机化II </strong>)。请注意，由于这些是模拟的A/A测试，因此随机请求是可能的。</li><li id="7bda" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">应用修改的比例Z检验</li></ul><p id="17e7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果测试工作正常，A/A测试产生的p值分布<a class="ae lb" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6629378/#s2title" rel="noopener ugc nofollow" target="_blank">应该遵循从0到1的均匀分布</a>。并且，如果我们将显著性水平设置为5%，我们应该会看到p值小于0.05的~5% A/A测试。</p><p id="6f91" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们发现，在用户层面进行随机化时(<strong class="kh ir">随机化I </strong>)，超过60%的A/A测试会导致假阳性。假阳性率很高，因为随机化单元不同于分析单元。另一方面，当在请求级别随机化时(随机化单元与分析单元相同)，p值分布相当接近均匀，并且I型误差得到很好的控制。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nq"><img src="../Images/ff7433a879b33761633abb660d77da94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S_7BOpwwCB3pkYKIbt7ubg.png"/></div></div></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nq"><img src="../Images/53dea06fbe02a3a908f4d0b7e5ca14dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q4fVdXS84ZZd8tHTAJq3Uw.png"/></div></div></figure><p id="3851" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总之，如果我们可以随机化请求，这种方法将是合理的。然而，在实践中，我们的随机化是在用户级别，这使得这种方法无效。</p><h1 id="52d3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">集群自举适用吗？</h1><p id="a223" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">为了解决随机化单元和分析单元之间的差异，我们可以应用<a class="ae lb" href="https://en.wikipedia.org/wiki/Bootstrapping_(statistics)#Cluster_data:_block_bootstrap" rel="noopener ugc nofollow" target="_blank">集群引导</a>。然而，自举是不可扩展的(<strong class="kh ir">挑战二</strong>)，它的计算非常昂贵。自举的复杂度本质上是<em class="nr"> O(nB) </em>，其中<em class="nr"> n </em>是样本数<em class="nr"> B </em>是自举迭代次数。考虑到Wish庞大的用户群，运行一个实验的集群引导需要几天时间，而且我们经常同时运行数百个实验。</p><p id="9154" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然集群自举对于Wish的数据规模(或大多数其他科技公司)来说是不可扩展的，但理论上是合理的。我们可以用它作为金标准来评估样本百分位数的<a class="ae lb" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1255808/" rel="noopener ugc nofollow" target="_blank">标准误差</a>估计值。</p><h1 id="5ef7" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Wish溶液</h1><p id="bee7" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">我们对上述方法的探索强调，A/B测试百分位数的方法需要解决随机化单元和分析单元之间的差异(挑战I)并且是可扩展的(挑战II)。</p><p id="6640" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://arxiv.org/pdf/1903.08762.pdf" rel="noopener ugc nofollow" target="_blank">LinkedIn在2019年发布的一种方法</a> [2]提供了一种封闭形式的分析解决方案来估计样本百分位数估计的标准误差，因此是可扩展的。它还专门解决了挑战LinkedIn方法中的一个步骤需要估计百分位的概率密度。对于这一步，我们发现<a class="ae lb" href="https://www.quora.com/q/quoradata/Two-Sample-Hypothesis-Tests-for-Differences-in-Percentiles" rel="noopener ugc nofollow" target="_blank"> Quora的方法</a>在实践中更容易使用，并且产生了令人满意的结果。</p><p id="703b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们采用这两种方法来估计样本百分位数的标准误差。利用样本百分位数及其标准误差，我们对零假设应用<a class="ae lb" href="https://en.wikipedia.org/wiki/Z-test" rel="noopener ugc nofollow" target="_blank"> Z检验</a>——来自两个实验桶(例如，对照和处理)的百分位数之间没有差异。</p><h1 id="5cda" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">记号</h1><p id="7208" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">假设我们用两个变体运行A/B测试，每个变体中的用户在查看产品页面时会得到不同的体验。我们的目标是检测这两种变体之间的产品页面加载时间P95的差异。注意，这里我们使用P95作为例子，我们使用这种方法来测试实践中的各种百分位数。关注一个变体，假设有:</p><ul class=""><li id="812a" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">n个用户，索引为i = 1，2，.。。，N；</li><li id="2c46" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">用户I查看Pᵢ产品，其中Pᵢ's是独立同分布(i.i.d .)随机变量；</li><li id="f1c0" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">Xᵢⱼ是用户I的jᵗʰ页面视图的页面加载时间。Xᵢⱼ's可能是正相关的，因为对于使用快速网络和快速设备的用户来说，页面浏览可能都更快，反之亦然。</li><li id="4e34" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">{Xᵢⱼ的样品P95，i = 1，2，.。。，N；j = 1，2，.。。，Pᵢ}被称为Q̂.</li></ul><h1 id="fb7c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">汇总统计数据</h1><p id="0df7" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">为了进行假设检验，我们的数据管道需要输出以下汇总统计数据:</p><ul class=""><li id="670e" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">用户数量N</li><li id="f805" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">样品P95 Q̂</li><li id="7a71" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">∑ᵢ Jᵢ，哪里</li></ul><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/cb1ecefa3c686aa9d7b3d89bf217f689.png" data-original-src="https://miro.medium.com/v2/resize:fit:574/1*_7xqchcjsLhsT3xz0zsVsA.gif"/></div></figure><p id="3adb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并且Jᵢ是在一个桶中比用户I的样本P95低的页面加载次数。</p><ul class=""><li id="99a6" class="mq mr iq kh b ki kj kl km ko ms ks mt kw mu la mv mw mx my bi translated">∑ᵢPᵢ，其中Pᵢ是用户I的页面访问量</li><li id="4125" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">∑ᵢ Jᵢ</li><li id="2b48" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">∑ᵢPᵢ</li><li id="a65d" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">∑ᵢJᵢPᵢ</li><li id="784b" class="mq mr iq kh b ki mz kl na ko nb ks nc kw nd la mv mw mx my bi translated">P(95-δ)和P(95+δ)。δ是可调窗口大小。假设δ=0.25，我们需要计算P94.75和95.25。</li></ul><p id="bb07" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，所有这些汇总统计数据都是在实验桶级别聚合的，这使得数据管道更加简单。关于调整参数，我们发现= 0.25对于像P50和P95这样的百分位数产生了令人满意的结果。当涉及到像P99或P99.9这样的极端百分位数时，可能需要更仔细的调整。</p><h1 id="a02e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">假设检验</h1><p id="e810" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">根据汇总统计数据，样本P95的方差估计为</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/99e9414dfd3b2f1267586448c86feee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:200/format:webp/1*gGnlDvHJQJ8Pf52P1thCWA.png"/></div></figure><p id="cad7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，我们遵循Quora的方法来估计分母中的密度fₓ(Q</p><p id="2527" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">fₓ(Q)= 2*δ/(P(95+δ) -P(95-δ))</p><p id="6f47" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">分子估计如下</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/d2323df856f914c3b451e41e1983a774.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/1*KjmDqNGFOeSzvMYblePaFw.gif"/></div></figure><p id="5c73" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">利用样本P95的方差估计，我们进行<a class="ae lb" href="https://en.wikipedia.org/wiki/Z-test" rel="noopener ugc nofollow" target="_blank"> Z检验</a>来计算p值。</p><p id="8613" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你好奇为什么我们可以这样估计样本P95的标准差，请参考LinkedIn论文中<a class="ae lb" href="https://arxiv.org/pdf/1903.08762.pdf" rel="noopener ugc nofollow" target="_blank">的等式1-6。本质上，百分位等于F⁻(百分比)，其中f是Xᵢⱼ的</a><a class="ae lb" href="https://en.wikipedia.org/wiki/Cumulative_distribution_function" rel="noopener ugc nofollow" target="_blank">累积密度函数</a> (cdf)，在P95的情况下百分比是0.95。这个百分比是∑ᵢJᵢ和∑ᵢPᵢ.的函数另外(1/n∑ᵢJᵢ和1/n∑ᵢPᵢ)由于<a class="ae lb" href="https://en.wikipedia.org/wiki/Central_limit_theorem" rel="noopener ugc nofollow" target="_blank">中心极限定理</a>遵循二元正态分布。应用<a class="ae lb" href="https://en.wikipedia.org/wiki/Delta_method" rel="noopener ugc nofollow" target="_blank">德尔塔法</a>两次，我们可以得出样本百分位数的分布。</p><h1 id="b0ee" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">数据管道</h1><p id="a4da" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">百分位数测试的数据管道与典型的A/B测试的数据管道有很大的不同，后者通常应用t-test，并且只需要三个汇总统计数据:样本均值、样本方差和样本大小。此外，计算大型数据集的百分位数是缓慢且资源密集型的。因此，我们计算了近似的百分位数，这快了一个数量级，并产生了令人满意的结果。最后，由于一些汇总统计数据是十进制百分位数(例如，P94.75和P95.25)，最小样本量需要至少大于10，000，这远远小于期望的典型样本量。</p><h1 id="8081" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结果</h1><h2 id="88d4" class="ne lt iq bd lu nf ng dn ly nh ni dp mc ko nj nk me ks nl nm mg kw nn no mi np bi translated">解析解产生精确的方差估计</h2><p id="0d22" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">使用聚类自举作为金标准，我们比较了由上述解析解估计的标准误差和由聚类自举估计的标准误差。这两种方法估计的标准误差在不同的客户端平台上非常接近。在超过200个内核和1.5T内存的服务器上，对于中等大小的样本，集群引导需要几个小时。如果我们使用bootstrapping的话，所有的实验都需要几天才能完成。相比之下，解析解的计算时间可以忽略不计。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="03e1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">A/A测试中I类错误率得到了很好的控制</p><p id="cc7f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了评估I型错误率，我们使用来自各种API调用的请求数据为不同的百分位数追溯性地构建了A/A测试。I型错误率(假阳性率)接近5%，p值分布遵循从0到1的均匀范围。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/e5144624ec333ea1923cd6723227ea78.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/0*wM6eADKodq0t_cqh"/></div></figure><h1 id="40a8" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">解析解产生良好的统计功效</h1><p id="00ee" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">我们还评估了<a class="ae lb" href="https://en.wikipedia.org/wiki/Power_of_a_test" rel="noopener ugc nofollow" target="_blank">功效</a>(真阳性率)。我们将历史请求数据随机分为50%对照组和50%治疗组。对于处理时段，我们将请求时间乘以110%或101%。即使响应时间只增加了1%,检测差异的能力仍然相当不错。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h1 id="c1fa" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="49d1" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">可靠的统计测试是可信实验平台的关键组成部分。对于不同的指标和不同类型的业务，没有一个通用的统计测试。我们分享我们在开发百分位数测试方面的努力，这释放了我们的实验平台的更多潜在应用。百分比测试现在应用于所有实验，希望A/B测试它们对API响应时间的延迟影响。我们设置了护栏规则来识别引入高延迟的实验，并通知实验所有者来防止引入缓慢的产品特性。</p><h1 id="31bb" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">感谢</h1><p id="5d41" class="pw-post-body-paragraph kf kg iq kh b ki mk jr kk kl ml ju kn ko mm kq kr ks mn ku kv kw mo ky kz la ij bi translated">感谢高波和齐超对此项目的贡献。我们也非常感谢Pai Liu，Shawn Song，Simla Ceyhan的支持，以及Pavel Kochetkov，Lance Deng，Caroline Davey，Leah Levine对本文草稿的反馈。</p><p id="13e6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Wish的数据科学家热衷于构建一个值得信赖的实验平台。如果你对解决这个领域的挑战性问题感兴趣，我们正在招聘<a class="ae lb" href="https://smrtr.io/6VnPr" rel="noopener ugc nofollow" target="_blank">数据科学团队</a>。</p><p id="aeb5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[1] A. Deng，J. Lu，J. Litz，<a class="ae lb" href="https://dl.acm.org/doi/abs/10.1145/3018661.3018677" rel="noopener ugc nofollow" target="_blank">在线A/B测试的可信性分析:陷阱、挑战与解决方案</a> ( 2017)，:第十届网络搜索与数据挖掘国际会议。英国剑桥。</p><p id="2026" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[2] M. Liu，X. Sun，M. Varshney和Y. Xu，<a class="ae lb" href="https://arxiv.org/abs/1903.08762" rel="noopener ugc nofollow" target="_blank">分位数度量的大规模在线实验</a> (2019)，<em class="nr"> arXiv预印本arXiv:1903.08762 </em></p></div></div>    
</body>
</html>