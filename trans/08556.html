<html>
<head>
<title>Challenging Cython — the Python Module for High-Performance Computing.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">挑战cy thon——高性能计算的Python模块。</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/challenging-cython-the-python-module-for-high-performance-computing-2e0f874311c0?source=collection_archive---------11-----------------------#2021-08-07">https://towardsdatascience.com/challenging-cython-the-python-module-for-high-performance-computing-2e0f874311c0?source=collection_archive---------11-----------------------#2021-08-07</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="b0ab" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">现代的替代方案看起来很有希望，Python可以以闪电般的速度运行。</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/ca58b0f91ac7aa6fd63da0fd5aeb542c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1g5BFAYk1oh9SeMWiKaagA.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">来自<a class="ae kz" href="https://www.pexels.com/photo/strong-sportsmen-ready-for-running-on-stadium-3764011/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的Andrea Piacquadio 的照片</p></figure><p id="6fa3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在<a class="ae kz" rel="noopener" target="_blank" href="/how-to-speed-up-python-data-pipelines-up-to-91x-80d7accfe7ec">最近的一篇文章</a>中，我们讨论了如何运行Python，比通常速度快91倍。在这篇文章中，我的目的是讨论上一篇文章中没有回答的问题。</p><blockquote class="lw lx ly"><p id="be65" class="la lb lz lc b ld le jv lf lg lh jy li ma lk ll lm mb lo lp lq mc ls lt lu lv in bi translated">与Python的传统性能修复技术——cy thon相比，所提供的解决方案性能如何？</p></blockquote><p id="5783" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">虽然Python是一种很棒的编程语言，但是它的性能是它的主要缺点。这种语法简单的优雅语言并不是为更快的计算而设计的。</p><p id="200f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">多年来，Cython一直在通过将Python代码转换为编译后的C程序来弥合这一差距。一系列科学计算包依靠Cython来加速计算。</p><p id="fb60" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们将它的性能与它的现代替代品进行比较。</p><p id="7411" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们将从使用<strong class="lc iv">普通Python </strong>计算质数开始。然后，我们再和它的<strong class="lc iv"> Cython </strong>版本进行对比。我们将使用Python的<strong class="lc iv">多处理</strong>模块重复它们，以找出它的好处。</p><p id="a74d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，我们将比较<strong class="lc iv">现代方法</strong>加速Python程序的性能。</p></div><div class="ab cl md me hy mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="in io ip iq ir"><h1 id="ed3a" class="mk ml iu bd mm mn mo mp mq mr ms mt mu ka mv kb mw kd mx ke my kg mz kh na nb bi translated">Cython。vs Python进行简单计算。</h1><p id="e3da" class="pw-post-body-paragraph la lb iu lc b ld nc jv lf lg nd jy li lj ne ll lm ln nf lp lq lr ng lt lu lv in bi translated">理解Cython优势的最直接方式是在基本计算中使用它。在这里，我们使用我在之前的基准测试中使用的相同的方法——计算一个数以下的质数的数量。</p><p id="6a9a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们使用cProfile模块来测量每个计算的性能。cProfile是众多测量代码运行时间的标准Python模块之一。</p><h2 id="1ed9" class="nh ml iu bd mm ni nj dn mq nk nl dp mu lj nm nn mw ln no np my lr nq nr na ns bi translated">使用Python进行计算。</h2><p id="de5d" class="pw-post-body-paragraph la lb iu lc b ld nc jv lf lg nd jy li lj ne ll lm ln nf lp lq lr ng lt lu lv in bi translated">下面的代码将计算35，000以下的质数，并打印一份详细的性能报告。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nt nu l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">代码片段由<a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>提供。</p></figure><p id="d612" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">运行上面的Python代码片段时，输出可能如下所示。根据您的电脑规格，这些数字可能会有所不同。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nv"><img src="../Images/d7d668f8f7e75432e6e546a88ebe0350.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6AdIHlIlmP9HGME6C0usbQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>截图。</p></figure><p id="e0d2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因为可能有许多因素影响性能，所以明智的做法是多次进行实验，并使用平均值进行比较。在我的个人电脑上执行上述操作的平均时间是<strong class="lc iv"> 18.721秒</strong>。</p><h2 id="30be" class="nh ml iu bd mm ni nj dn mq nk nl dp mu lj nm nn mw ln no np my lr nq nr na ns bi translated">使用Cython进行计算。</h2><p id="af33" class="pw-post-body-paragraph la lb iu lc b ld nc jv lf lg nd jy li lj ne ll lm ln nf lp lq lr ng lt lu lv in bi translated">使用Cython不同于使用Python。首先，我们需要将Python脚本转换成c。</p><ol class=""><li id="cb42" class="nw nx iu lc b ld le lg lh lj ny ln nz lr oa lv ob oc od oe bi translated">如果尚未安装Cython，请安装它。</li></ol><pre class="kk kl km kn gu of og oh oi aw oj bi"><span id="4b97" class="nh ml iu og b gz ok ol l om on">pip3 install --upgrade cython</span></pre><p id="6ddb" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">2.用以下内容创建一个文件<code class="fe oo op oq og b">count_prime.pyx </code>。和以前一样。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nt nu l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">代码片段由<a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>提供。</p></figure><p id="c777" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">3.在同一个目录下创建另一个文件<code class="fe oo op oq og b">setup.py</code>，内容如下。它会把你的代码编译成C程序。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nt nu l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">代码片段由<a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>提供。</p></figure><p id="da71" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">4.现在，在终端窗口中运行下面的命令将创建我们的质数计数器函数的C版本。</p><pre class="kk kl km kn gu of og oh oi aw oj bi"><span id="a76f" class="nh ml iu og b gz ok ol l om on">python setup.py build_ext --inplace</span></pre><p id="52ab" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">5.另外，重命名(或移动)pyx文件，否则可能会导致导入冲突。</p><pre class="kk kl km kn gu of og oh oi aw oj bi"><span id="99a2" class="nh ml iu og b gz ok ol l om on">mv count_prime.pyx count_prime_dep.pyx</span></pre><p id="648b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">6.最后，将函数导入到我们的主应用程序中，并像调用任何其他python函数一样运行它。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nt nu l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">代码片段由<a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>提供。</p></figure><p id="9c89" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">运行这个程序的平均时间是11.210秒。这是我做的十个试验中的一个的样本报告。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj or"><img src="../Images/317c4f83e2b235dfafe5d436d773517c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FpxxJzXOVtpHOn1zMc6zZA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>截图。</p></figure><p id="0a59" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">从18秒减少到11秒是一个显著的进步。Cython按照预期完成了工作。让我们重复多重处理场景的步骤。</p><h1 id="f2f4" class="mk ml iu bd mm mn os mp mq mr ot mt mu ka ou kb mw kd ov ke my kg ow kh na nb bi translated">Cython。多处理vs Python。</h1><p id="2bde" class="pw-post-body-paragraph la lb iu lc b ld nc jv lf lg nd jy li lj ne ll lm ln nf lp lq lr ng lt lu lv in bi translated">Python中的多处理模块是启动许多子流程的一种极好的方式。每个进程将运行您的代码的一个实例。如果处理器有空闲内核，它们也可以并行运行。</p><h2 id="5b43" class="nh ml iu bd mm ni nj dn mq nk nl dp mu lj nm nn mw ln no np my lr nq nr na ns bi translated">Python多重处理。</h2><p id="bdd0" class="pw-post-body-paragraph la lb iu lc b ld nc jv lf lg nd jy li lj ne ll lm ln nf lp lq lr ng lt lu lv in bi translated">下面的代码将在多个进程中计算20K、25K、30K、35K和40K以下的质数(如果可能的话，并行计算。)</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nt nu l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">代码片段由<a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>提供。</p></figure><p id="e384" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">运行上述代码的平均时间为29.7秒。输出可能如下所示。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ox"><img src="../Images/13cb2c4a451073960009a8d28206b002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v5VIKmRV5CxN446Tp03SxA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>截图。</p></figure><h2 id="3d28" class="nh ml iu bd mm ni nj dn mq nk nl dp mu lj nm nn mw ln no np my lr nq nr na ns bi translated">Cython多重处理。</h2><p id="30f6" class="pw-post-body-paragraph la lb iu lc b ld nc jv lf lg nd jy li lj ne ll lm ln nf lp lq lr ng lt lu lv in bi translated">下面的代码将对我们之前编译的C版本重复同样的过程。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nt nu l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">代码片段由<a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>提供。</p></figure><p id="3843" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这一过程的平均时间约为18秒，输出可能如下所示。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oy"><img src="../Images/b41a5aeb2c30d99237e1506675ad5df9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MgIB7BzVIzN1q0SGXhOJJA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>截图。</p></figure><p id="a81c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">事实再次证明，Cython在显著加快python处理时间方面是有效的。它将运行整个循环所需的时间减少了37.9%。</p><h1 id="cdd4" class="mk ml iu bd mm mn os mp mq mr ot mt mu ka ou kb mw kd ov ke my kg ow kh na nb bi translated">使用Tuplex的高性能计算。</h1><p id="3995" class="pw-post-body-paragraph la lb iu lc b ld nc jv lf lg nd jy li lj ne ll lm ln nf lp lq lr ng lt lu lv in bi translated">我们已经看到使用Cython取得了惊人的成功。在简单的质数计数和多重处理应用中，它大大减少了执行时间。</p><p id="5673" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这能更快吗？我们在上一篇文章中讨论的Tuplex库比Cython版本的性能更好吗？</p><p id="91bd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果你在Tuplex上寻找一个详细的帖子，这里有一个。</p><div class="oz pa gq gs pb pc"><a rel="noopener follow" target="_blank" href="/how-to-speed-up-python-data-pipelines-up-to-91x-80d7accfe7ec"><div class="pd ab fp"><div class="pe ab pf cl cj pg"><h2 class="bd iv gz z fq ph fs ft pi fv fx it bi translated">如何将Python数据管道加速到91X？</h2><div class="pj l"><h3 class="bd b gz z fq ph fs ft pi fv fx dk translated">一个5分钟的教程可以为您的大数据项目节省数月时间。</h3></div><div class="pk l"><p class="bd b dl z fq ph fs ft pi fv fx dk translated">towardsdatascience.com</p></div></div><div class="pl l"><div class="pm l pn po pp pl pq kt pc"/></div></div></a></div><h2 id="ca12" class="nh ml iu bd mm ni nj dn mq nk nl dp mu lj nm nn mw ln no np my lr nq nr na ns bi translated">单一进程的多路复用器。</h2><p id="f4f3" class="pw-post-body-paragraph la lb iu lc b ld nc jv lf lg nd jy li lj ne ll lm ln nf lp lq lr ng lt lu lv in bi translated">Tuplex将Python脚本转换成LLVM bitecodes，并并行运行它们。结果是性能显著提高。这个新的库专注于数据管道，但它的应用不仅限于数据科学。</p><p id="8bf6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面的代码将使用Tuplex运行一次计算。因为我们在并行化方法的list参数中只传递一个数字，所以Tuplex将在单线程中运行它。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nt nu l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">由<a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>编写的代码片段。</p></figure><p id="d8e9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">tuplex方法的平均结果为9秒。请注意，我们没有考虑Tuplex设置上下文所需的时间。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj pr"><img src="../Images/0c485b43327f60e9fddad8460505f1ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IzW7yQ_Y6tD1-MrRZn5blA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>截图。</p></figure><p id="fd5d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">与Cython的11秒相比，这令人印象深刻。根据计算机的架构，结果也可能有所不同。但这个数字足够体面，足以表明Cython有一个值得尊敬的对手。</p><h2 id="d2ff" class="nh ml iu bd mm ni nj dn mq nk nl dp mu lj nm nn mw ln no np my lr nq nr na ns bi translated">并行计算中的多路复用器。</h2><p id="8328" class="pw-post-body-paragraph la lb iu lc b ld nc jv lf lg nd jy li lj ne ll lm ln nf lp lq lr ng lt lu lv in bi translated">最后一个比较还没有完成，这可能是Tuplex的核心目的——并行化。让我们用Tuplex计算同样的多重处理练习。调整Tuplex单进程示例的最后一行就可以达到这个目的。它应该是这样的。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nt nu l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">代码片段由<a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>提供。</p></figure><p id="b5e4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">并行运行Tuplex代码的结果是惊人的平均10秒。完成同样的任务，Cython用了18秒，plain Python用了29秒。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ps"><img src="../Images/536e05a2188026387f8eeca20b3f6c6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qnkaCJN67QfrF_qvOugx2A.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://thuwarakesh.medium.com/" rel="noopener">作者</a>截图。</p></figure></div><div class="ab cl md me hy mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="in io ip iq ir"><h1 id="bda4" class="mk ml iu bd mm mn mo mp mq mr ms mt mu ka mv kb mw kd mx ke my kg mz kh na nb bi translated">结论</h1><p id="3b4a" class="pw-post-body-paragraph la lb iu lc b ld nc jv lf lg nd jy li lj ne ll lm ln nf lp lq lr ng lt lu lv in bi translated">Cython一直是Python程序员可用的主要(也是唯一的)性能补丁。图书馆经常做得很好；因此，许多其他科学计算软件包在内部使用Cython。</p><p id="da5d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然而，一个相对较新的图书馆Tuplex表现良好。在本文中，我们做了一个素数计数实验来比较Tuplex和Cython版本。执行时间似乎也大大减少了。</p><p id="c301" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是结果可能会因您的硬件、操作系统和系统状态而异。此外，由于Tuplex还不能用于生产，所以必须小心使用。另一方面，Cython是稳定的，许多生产中的应用程序已经在使用它。</p><p id="08d2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这种比较的全部意义不在于得出一个比另一个更好的结论。图普莱克斯要走到这一步还有很长的路要走。然而，如果Cython不适合你的项目，它不是一个死胡同。不再是了。</p></div><div class="ab cl md me hy mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="in io ip iq ir"><blockquote class="lw lx ly"><p id="1c3e" class="la lb lz lc b ld le jv lf lg lh jy li ma lk ll lm mb lo lp lq mc ls lt lu lv in bi translated">感谢阅读，朋友！看来你和我有许多共同的兴趣。我很乐意通过LinkedIn、T2、Twitter和Medium与你联系。</p></blockquote><p id="04fe" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">还不是中等会员？请使用此链接<a class="ae kz" href="https://thuwarakesh.medium.com/membership" rel="noopener"> <strong class="lc iv">成为</strong> </a>会员。你可以享受成千上万的有见地的文章，并支持我，因为我赚了一点佣金介绍你。</p></div></div>    
</body>
</html>