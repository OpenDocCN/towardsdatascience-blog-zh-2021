<html>
<head>
<title>Build your first Graph Neural Network model to predict traffic speed in 20 minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">建立您的第一个图形神经网络模型来预测20分钟内的交通速度</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-your-first-graph-neural-network-model-to-predict-traffic-speed-in-20-minutes-b593f8f838e5?source=collection_archive---------7-----------------------#2021-09-01">https://towardsdatascience.com/build-your-first-graph-neural-network-model-to-predict-traffic-speed-in-20-minutes-b593f8f838e5?source=collection_archive---------7-----------------------#2021-09-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="2457" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="1504" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">循序渐进的编码实践</h2></div><p id="3417" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">图形神经网络(GNN)是深度学习的一个活跃前沿，有很多应用，例如交通速度/时间预测和推荐系统。在这篇博客中，我们将建立第一个GNN模型来预测旅行速度。我们将使用来自<a class="ae ln" href="https://github.com/dmlc/dgl/tree/master/examples/pytorch/stgcn_wave" rel="noopener ugc nofollow" target="_blank"> dgl库</a>的示例代码运行时空GNN模型。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/9e3787ab7d55fdb7aedf30466f4e4e96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ddDHXQHg11h5_LlH_UX9eA.jpeg"/></div></div><p class="ma mb gj gh gi mc md bd b be z dk translated">图片由<a class="ae ln" href="https://www.pexels.com/@caleboquendo" rel="noopener ugc nofollow" target="_blank"> Caleb Oquendo </a>从<a class="ae ln" href="https://www.pexels.com/photo/cellphone-on-a-stand-with-navigation-map-application-open-7738879/" rel="noopener ugc nofollow" target="_blank"> Pexels </a></p></figure><h2 id="5a78" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated"><strong class="ak">时空GNN模型</strong></h2><p id="cbf1" class="pw-post-body-paragraph kr ks it kt b ku mw kd kw kx mx kg kz la my lc ld le mz lg lh li na lk ll lm im bi translated">我们将训练一个在IJCAI'18发表的论文中提出的GNN模型:<br/> <a class="ae ln" href="https://www.ijcai.org/proceedings/2018/0505.pdf" rel="noopener ugc nofollow" target="_blank"> <strong class="kt jd">时空图卷积网络:流量预测的深度学习框架</strong> </a> <strong class="kt jd">。</strong></p><p id="88a3" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">本文的总体思想是使用历史速度数据来预测未来时间步长的速度。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nb"><img src="../Images/993ba4243064ddfa50a229afc1377fa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cBphOaehHUF1BGPl1zfm3g.png"/></div></div><p class="ma mb gj gh gi mc md bd b be z dk translated">图来源:参考文献[1]</p></figure><p id="4f45" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">参见图1。每个节点代表一个记录交通速度的传感器站。连接两个节点的边意味着这两个传感器站连接在道路上。代表一个地区交通速度的地理图随时间而变化。我们的任务是使用历史数据，例如从<em class="nc"> v_{t-M+1} </em>到<em class="nc"> v_{t} </em>，来预测未来时间步的速度，例如<em class="nc"> v_{t+H} </em>。这里的<em class="nc"> M </em>是指之前的<em class="nc"> M </em>交通观测值(<em class="nc"> v_{t-M+1}，…，v_{t} </em>)，而<em class="nc"> H </em>是指下一个<em class="nc"> H </em>时间步，例如，在接下来的30分钟内。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi nd"><img src="../Images/642ab5b432a0e75bd3ace5999f93a957.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IoSOSR_La-GHqJFxtWx-3Q.png"/></div></div><p class="ma mb gj gh gi mc md bd b be z dk translated">图来源:参考文献[1]</p></figure><p id="30e6" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">该模型由一组圣Conv块和一个输出层组成。每个圣Conv区块由两个时间门控conv图层和位于两者之间的空间图形conv图层组成。输出图层由conv、诺姆、conv和一个完整的conv图层组成。</p><h2 id="2082" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">准备洛杉矶METR数据集</h2><p id="61ae" class="pw-post-body-paragraph kr ks it kt b ku mw kd kw kx mx kg kz la my lc ld le mz lg lh li na lk ll lm im bi translated">我们先准备数据集，接下来我会解释。</p><pre class="lp lq lr ls gt ne nf ng nh aw ni bi"><span id="ca90" class="me mf it nf b gy nj nk l nl nm">mkdir &lt;your working directory&gt;<br/>cd &lt;your working directory&gt;<br/># clone dgl source code<br/>git clone <a class="ae ln" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:dmlc/dgl.git<br/># clone DCRNN_PyTorch repo, because we need the data folder from it<br/>git clone <a class="ae ln" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:chnsh/DCRNN_PyTorch.git<br/># copy the data folder from DCRNN_PyTorch repo to dgl repo <br/>cp -r DCRNN_PyTorch/data dgl/examples/pytorch/stgcn_wave/<br/># go to the stgcn_wave folder<br/>cd dgl/examples/pytorch/stgcn_wave/</span></pre><p id="0b02" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">然后从<a class="ae ln" href="https://drive.google.com/open?id=10FOTa6HXPqX8Pf5WRoRwcFnW9BrNZEIX" rel="noopener ugc nofollow" target="_blank">这个Google drive </a>下载metr-la.h5文件，放在data的文件夹里。最后，您的目录结构应该是这样的:</p><pre class="lp lq lr ls gt ne nf ng nh aw ni bi"><span id="f3bf" class="me mf it nf b gy nj nk l nl nm">.<br/>├── data<br/>│   ├── metr-la.h5<br/>│   └── sensor_graph<br/>│       ├── distances_la_2012.csv<br/>│       ├── graph_sensor_ids.txt<br/>├── load_data.py<br/>├── main.py<br/>├── model.py<br/>├── README.md<br/>├── sensors2graph.py<br/>└── utils.py</span></pre><p id="e34c" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">请注意，在数据文件夹中，我们只需要metr-la.h5、graph_sensor_ids.txt和distances_la_2012.csv文件。数据文件夹中的其他文件无关紧要。</p><p id="2381" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><strong class="kt jd">METR-拉</strong>交通数据集广泛用于交通速度预测。它包含从洛杉矶县高速公路的环形检测器收集的交通信息。选择了207个传感器，数据集包含从2012年3月1日到2012年6月30日收集的4个月的数据。</p><p id="0065" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">文件<strong class="kt jd"> graph_sensor_ids.txt </strong>包含传感器的id。文件<strong class="kt jd"> distances_la_2012.csv </strong>包含传感器之间的距离。这两个文件用于创建一个邻接矩阵，然后使用dgl库创建一个图。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/2f37100859c31c4c5a9ad222f0222ead.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*4Zd8Kx9F_HtWEniOUyN2BQ.png"/></div><p class="ma mb gj gh gi mc md bd b be z dk translated">METR-洛杉矶数据集的传感器分布(图来源:参考文献[2])</p></figure><p id="3c15" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">文件<strong class="kt jd"> metr-la.h5 </strong>包含一个形状为[34272，207]的数组，其中34272是时间步长的总数，207是传感器的数量。该数组仅包含速度数据，这意味着GNN模型使用历史速度来预测未来速度。不涉及其他特征(道路类型、天气、节假日)。用传感器每5分钟记录一次速度。207个传感器分布在区域内的道路上。分布见上图。每5分钟收集一次速度。所以一天应该有24*(60/5)=288条记录。因此，一天的数据只是一个形状数组[288，207]，其中288是总时间步长，207是传感器的数量。由于数据是在4个月内收集的，在可选的数据清理之后，总共有34272个时间步长。下面是前5行。标题是传感器的id，内容的值是速度。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi no"><img src="../Images/424b62921372b93a6c1f295594dc55e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6JWiTUf30aDAXKQy1Tj4Yw.png"/></div></div><p class="ma mb gj gh gi mc md bd b be z dk translated">文件metr-la.h5的标题和前5行</p></figure><p id="8b92" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">为了使数据适应机器学习，我们需要准备特征<em class="nc"> X </em>和目标<em class="nc"> Y </em>。对于每个样本(时间步长<em class="nc"> t </em>)，特征<em class="nc"> X </em>是其从<em class="nc"> t-144 </em>到<em class="nc"> t-1 </em> (12小时)的过去144个时间步长的速度历史。假设我们有<em class="nc"> N个</em>样本，那么<em class="nc"> X </em>的形状就是<em class="nc"> N，144，207 </em>。目标<em class="nc"> Y </em>是未来时间步的速度，比如说<em class="nc"> t+4 </em>，那么<em class="nc"> Y </em>的形状就是<em class="nc"> N，1，207 </em>。现在我们有了(<em class="nc"> X，Y </em>)对，我们可以把它们馈送给ML。</p><h2 id="55a1" class="me mf it bd mg mh mi dn mj mk ml dp mm la mn mo mp le mq mr ms li mt mu mv iz bi translated">培训、验证和测试</h2><p id="2467" class="pw-post-body-paragraph kr ks it kt b ku mw kd kw kx mx kg kz la my lc ld le mz lg lh li na lk ll lm im bi translated">现在我们已经准备好训练、验证和测试了。</p><p id="51fd" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">首先，创建一个虚拟环境并安装软件包。你需要访问<a class="ae ln" href="https://www.dgl.ai/pages/start.html" rel="noopener ugc nofollow" target="_blank">这个链接</a>来选择你合适的dgl包。</p><pre class="lp lq lr ls gt ne nf ng nh aw ni bi"><span id="0057" class="me mf it nf b gy nj nk l nl nm">conda create -n stgcn_wave python=3.6<br/>conda activate stgcn_wave<br/>pip install dgl-cu102 -f <a class="ae ln" href="https://data.dgl.ai/wheels/repo.html" rel="noopener ugc nofollow" target="_blank">https://data.dgl.ai/wheels/repo.html</a><br/>pip install torch<br/>pip install pandas<br/>pip install sklearn<br/>pip install tables</span></pre><p id="e2ce" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">然后我们可以通过以下方式运行main.py</p><pre class="lp lq lr ls gt ne nf ng nh aw ni bi"><span id="4acf" class="me mf it nf b gy nj nk l nl nm"># maybe you need to adapt your batch size to suit your GPU memory<br/>python main.py --batch_size 10</span></pre><p id="3654" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">main.py一次性完成训练、验证和测试。它使用pytorch作为ML框架。总的来说，使用NVIDIA GeForce GTX 1080显卡需要将近一天的时间。</p><p id="40ca" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">作为评估行驶速度预测模型的常用方法，脚本中使用了平均绝对误差(MAE)、平均绝对百分比误差(MAPE)和均方根误差(RMSE)。下面是我日志的结尾:</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi np"><img src="../Images/5f61649d5385e380bb7326418a2fa34c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*73DQnljpfsOl76w8Mt2Rvw.png"/></div></div><p class="ma mb gj gh gi mc md bd b be z dk translated">我的日志截图</p></figure><p id="d185" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">MAE (6.68)接近于dgl库的自述文件中声称的版本(~5.76)。如果我能够使用默认的批处理大小(50)运行，我可能会得到更接近的结果。</p><p id="bab6" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated"><strong class="kt jd">参考文献:</strong></p><p id="42a8" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">[1]冰雨，郝腾银，朱占兴，<a class="ae ln" href="https://www.ijcai.org/proceedings/2018/0505.pdf" rel="noopener ugc nofollow" target="_blank">时空图卷积网络:一个用于流量预测的深度学习框架</a>，2018，IJCAI。</p><p id="967f" class="pw-post-body-paragraph kr ks it kt b ku kv kd kw kx ky kg kz la lb lc ld le lf lg lh li lj lk ll lm im bi translated">[2]，Rose Yu，Cyrus Shahabi，，<a class="ae ln" href="https://arxiv.org/pdf/1707.01926.pdf" rel="noopener ugc nofollow" target="_blank">扩散卷积递归神经网络:数据驱动的交通预测</a>，2018，ICLR。</p></div></div>    
</body>
</html>