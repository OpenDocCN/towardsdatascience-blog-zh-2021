<html>
<head>
<title>NOAA weather data in Snowflake (free)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">雪花中的NOAA天气数据(免费)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/noaa-weather-data-in-snowflake-free-20e90ee916ed?source=collection_archive---------16-----------------------#2021-06-22">https://towardsdatascience.com/noaa-weather-data-in-snowflake-free-20e90ee916ed?source=collection_archive---------16-----------------------#2021-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1001" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">NOAA GSOD的全球天气数据每天都会在雪花中更新，在本帖中，我们会让它变得更加有用。通过MATCH_RECOGNIZE()在内部检查枢轴、地理连接、查找离每个城市最近的车站和模式匹配。</h2></div><figure class="kf kg kh ki gt kj"><div class="bz fp l di"><div class="kk kl l"/></div><p class="km kn gj gh gi ko kp bd b be z dk translated"><a class="ae kq" href="https://www.youtube.com/watch?v=BJhY-CL6zjA" rel="noopener ugc nofollow" target="_blank">Youtube上的视频</a></p></figure><h1 id="65ce" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">源头</h1><p id="8eee" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">要访问NOAA GSOD的每日天气数据，只需去市场<a class="ae kq" href="https://docs.snowflake.com/en/user-guide/data-marketplace-intro.html#label-standard-listing" rel="noopener ugc nofollow" target="_blank">在你的账户中用<a class="ae kq" href="https://www.snowflake.com/datasets/knoema-environment-data-atlas/" rel="noopener ugc nofollow" target="_blank"> Knoema的环境数据图集</a>创建一个数据库</a>。</p><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi mf"><img src="../Images/1c5a32ac08cce8a34b7a2b618eccb70c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BgQlKbRbt0I2gmWKRecv9A.png"/></div></div><p class="km kn gj gh gi ko kp bd b be z dk translated"><a class="ae kq" href="https://www.snowflake.com/datasets/knoema-environment-data-atlas/" rel="noopener ugc nofollow" target="_blank">雪花中的Knoema环境数据图集</a></p></figure><p id="167d" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">通过几个探索性的查询，您会注意到:</p><ul class=""><li id="9fd3" class="mr ms iq ll b lm mm lp mn ls mt lw mu ma mv me mw mx my mz bi translated">让这些数据在你的账户中自动刷新是很酷的！</li><li id="7919" class="mr ms iq ll b lm na lp nb ls nc lw nd ma ne me mw mx my mz bi translated">让这张表变得有用并不容易，因为:</li><li id="ecb1" class="mr ms iq ll b lm na lp nb ls nc lw nd ma ne me mw mx my mz bi translated">车站有一个纬度，经度——但是没有办法告诉他们属于哪个城市或邮政编码。</li><li id="5318" class="mr ms iq ll b lm na lp nb ls nc lw nd ma ne me mw mx my mz bi translated">每天的原始NOAA行已被拆分为多行，每行仅包含一个站点可以产生的每个不同测量值的一个值。</li></ul><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nf"><img src="../Images/68ff95ce61d14715a50487f2362563ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ygaPVZf23OKOiZTd9kfsAQ.png"/></div></div><p class="km kn gj gh gi ko kp bd b be z dk translated">由Knoema转换的NOAA GSOD:每个测量一行</p></figure><p id="49f1" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">因此，让我们在这里转换这些数据，使其更容易纳入您的数据管道。</p><h1 id="88ae" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">将多行旋转成一行</h1><p id="85c7" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">这对于雪花来说很容易。以下查询将获取每个工作站每天的多行数据，并将它们转换为一行数据:</p><pre class="kf kg kh ki gt ng nh ni nj aw nk bi"><span id="6089" class="nl ks iq nh b gy nm nn l no np">--create or replace table noaa_gsod<br/>--cluster by (station_id, date)<br/>--as (<br/>    select *<br/>    from (<br/>        select "Stations", "Date", "Stations Name", "Country", "Indicator Name", "Value"<br/>        from KNOEMA_ENVIRONMENT_DATA_ATLAS.ENVIRONMENT.NOAACD2019R<br/>        where "Date"&gt;='2020-01-01'<br/>        and "Measure"='M1'<br/>        -- and "Country"='US'<br/>    )<br/>    pivot(max("Value") for "Indicator Name" in ('Mean visibility (miles)','Maximum temperature (Fahrenheit)','Mean dew point (Fahrenheit)','Maximum wind gust (Number)','Minimum temperature (Fahrenheit)','Maximum sustained wind speed (knots)','Mean wind speed (knots)','Mean station pressure (millibars)','Precipitation amount (inches)','Mean temperature (Fahrenheit)','Mean sea level pressure (millibars)','Snow depth (inches)'))<br/>    as p(station_id, date, name, country_fips, visibility, max, dew, wind_max, min, wind_sustained_max, wind_mean, pressure, rain, temp, pressure_sea, snow_depth)<br/>--)<br/>;</span></pre><p id="bb94" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">由于雪花支持本地透视，我们能够将多行合并为一行，创建新列并重命名它们以便于使用:</p><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nq"><img src="../Images/002b288935fedaa7d43778d6f3904268.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TelQdgq_KVhIEcexk7Jaqg.png"/></div></div><p class="km kn gj gh gi ko kp bd b be z dk translated">把NOAA GSOD转回到一个有用的宽桌子上</p></figure><h1 id="cddc" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">查找城市</h1><p id="c49d" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">现在，我们如何找到离每个车站最近的城市？还是邮编？</p><p id="7fd6" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">让我们从查找全球城市列表开始。在这种情况下，我使用了来自Wikidata的数据(我们可以在未来的帖子中更多地讨论关于雪花的Wikidata)。</p><h1 id="6aad" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">地理定位站</h1><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/b394ee12d92986a3c3bc83b06c3c21e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/0*JtLo7emVRASGlIU0.png"/></div><p class="km kn gj gh gi ko kp bd b be z dk translated">拥有NOAA气象站的大城市</p></figure><p id="313a" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">有了城市列表和雪花的GIS支持，我们可以找到离每个车站最近的城市:</p><pre class="kf kg kh ki gt ng nh ni nj aw nk bi"><span id="dd67" class="nl ks iq nh b gy nm nn l no np">create or replace table stations_city<br/>as (<br/>    select label city, station, st_distance(st_makepoint(a.lon, a.lat), st_makepoint(b.lon, b.lat)) distance, country_fips, b.country<br/>        , station_id<br/>    from weather_stations a<br/>    join wikimedia.public.cities b<br/>    on a.country=b.country_fips<br/>    and st_distance(st_makepoint(a.lon, a.lat), st_makepoint(b.lon, b.lat)) &lt; 50000<br/>    qualify row_number() over(partition by station order by distance) = 1<br/>    order by views desc<br/>)<br/>;</span></pre><p id="4008" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">在那个SQL查询中，我们限制了半径为50公里的<code class="fe ns nt nu nh b">st_distance</code>的搜索。这种地理连接执行得非常快:一个小仓库只需3秒钟。</p><p id="c824" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">请注意，<code class="fe ns nt nu nh b">qualify row_number() over(partition by station order by distance) = 1</code>为我们带来了离每个车站最近的城市。为了得到离每个城市最近的车站，我们需要把它改成<code class="fe ns nt nu nh b">over(partition by city order by distance)</code>。</p><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nv"><img src="../Images/3215114bd7965fa91fd3d4e9a2158ebc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R6hLAHGzGsRMZqw7soK40A.png"/></div></div><p class="km kn gj gh gi ko kp bd b be z dk translated">离每个车站最近的城市。</p></figure><h1 id="93f6" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">模式匹配:雨水最多的城市</h1><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/9a479b677da36d7faa35edb739d41f07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/0*Bi8sg8fAh6a5KuDN.png"/></div><p class="km kn gj gh gi ko kp bd b be z dk translated">照片由<a class="ae kq" href="https://www.flickr.com/photos/donabelandewen/3908987446" rel="noopener ugc nofollow" target="_blank">埃文·罗伯茨</a>拍摄</p></figure><p id="3d39" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">现在让我们享受一下模式匹配的乐趣，感谢我们的<a class="ae kq" href="https://hoffa.medium.com/funnel-analytics-with-sql-match-recognize-on-snowflake-8bd576d9b7b1" rel="noopener">新的MATCH_RECOGNIZE功能</a>。</p><p id="d2ab" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">例如，让我们找出美国连续下雨天数最多的城市:</p><pre class="kf kg kh ki gt ng nh ni nj aw nk bi"><span id="312c" class="nl ks iq nh b gy nm nn l no np">   select *<br/>    from (select * from noaa_gsod where country_fips='US')<br/>    match_recognize(<br/>        partition by station_id, name<br/>        order by date<br/>        measures avg(temp) avg_temp, sum(rain) total_rain, min(rain) min_rain, count(*) rainy_days, min(date) date<br/>        one row per match<br/>        pattern(rain{5,})<br/>        define<br/>            rain as rain &gt; 0.1<br/>    )</span></pre><p id="c2f2" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">我喜欢用<a class="ae kq" href="https://hoffa.medium.com/funnel-analytics-with-sql-match-recognize-on-snowflake-8bd576d9b7b1" rel="noopener"> MATCH_RECOGNIZE </a>定义行之间的模式是如此简单:</p><ul class=""><li id="3d99" class="mr ms iq ll b lm mm lp mn ls mt lw mu ma mv me mw mx my mz bi translated">首先，我们将<code class="fe ns nt nu nh b">rain</code>(对于模式)定义为任何有<code class="fe ns nt nu nh b">rain &gt; 0.1</code>英寸的行。如果那天的雨没有打到那个最小值，我们就不算雨天了。</li><li id="8fbb" class="mr ms iq ll b lm na lp nb ls nc lw nd ma ne me mw mx my mz bi translated">然后，我们让雪花寻找任何一系列行，这些行至少连续5天使用<code class="fe ns nt nu nh b">pattern(rain{5,})</code>看到雨的定义。</li><li id="29db" class="mr ms iq ll b lm na lp nb ls nc lw nd ma ne me mw mx my mz bi translated">在查询中检查<code class="fe ns nt nu nh b">one row per match</code>、<code class="fe ns nt nu nh b"> partition by station_id, name order by date</code>和<code class="fe ns nt nu nh b">measures min(date) date</code>的组合将如何帮助我们获得期望的结果。</li></ul><p id="db85" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">如果我们将气象站按连续最多的雨天排序，结果如下:</p><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nx"><img src="../Images/8e895b43d13bbc9bca8ad1cd3b9bebe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZjJjbi1st-LYZDbF6QhQPg.png"/></div></div><p class="km kn gj gh gi ko kp bd b be z dk translated">美国连续下雨天数最多的站点</p></figure><p id="b66e" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">正如你所看到的，Quillayute机场在2020年1月连续下雨25天，然后在2020年12月连续下雨16天。那是一场不停的雨。</p><p id="2e22" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">但是机场在哪里？最近的城市是哪里？我们可以结合之前的结果来解决这个问题:</p><pre class="kf kg kh ki gt ng nh ni nj aw nk bi"><span id="1ff0" class="nl ks iq nh b gy nm nn l no np">select *<br/>from (<br/>    select *<br/>    from (select * from noaa_gsod where country_fips='US')<br/>    match_recognize(<br/>        partition by station_id, name<br/>        order by date<br/>        measures avg(temp) avg_temp, sum(rain) total_rain, min(rain) min_rain, count(*) rainy_days, min(date) date<br/>        one row per match<br/>        pattern(rain{5,})<br/>        define<br/>            rain as rain &gt; 0.1<br/>    )<br/>) a<br/>join (<br/>    select *<br/>    from stations_city<br/>) b<br/>using (station_id)<br/>order by rainy_days desc, total_rain desc<br/>;</span></pre><p id="66d0" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">原来这些是美国降雨量最多的城市。看之前能猜到吗？</p><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi ny"><img src="../Images/1a5e26635c7e4cda545352d37d71a7a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ofxUhL67t8oL9m7D-KLFDQ.png"/></div></div><p class="km kn gj gh gi ko kp bd b be z dk translated">美国雨量最多的城市</p></figure><p id="d21e" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">在看之前，我的猜测是西雅图。这是正确的。西雅图紧随其后，是它的姐妹城市塔科马。他们真的配得上“美国连续下雨天数最多的城市”的称号。</p><p id="74ec" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">但是Quillayute机场去哪了？原来它不在我上面的查询中的一个主要城市的50公里半径内。如果我们将半径增加到200公里，结果如下:</p><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi nz"><img src="../Images/5a5ba269e583c413b9319d3624cd10ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nKzqdclTn5KBvdUOUGSxiQ.png"/></div></div><p class="km kn gj gh gi ko kp bd b be z dk translated">美国雨量最多的城市(200公里半径内的气象站)</p></figure><p id="fc09" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">又来了，西雅图和塔科马。华盛顿州周围确实经常下雨。</p><h1 id="c9bb" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">dbt中的所有内容</h1><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="gh gi oa"><img src="../Images/2387571aa733acbc05c1d7dbf9d84ec5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sTnosu7KNjliK-4_l8Dh_w.png"/></div></div><p class="km kn gj gh gi ko kp bd b be z dk translated">此项目中的数据沿袭，按dbt</p></figure><p id="3d55" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">查看我的<a class="ae kq" href="https://github.com/Snowflake-Labs/fhoffa/tree/main/knoema_noaa_dbt" rel="noopener ugc nofollow" target="_blank"> GitHub项目和完整的dbt项目</a>。</p><p id="859b" class="pw-post-body-paragraph lj lk iq ll b lm mm jr lo lp mn ju lr ls mo lu lv lw mp ly lz ma mq mc md me ij bi translated">(感谢Noel Gomez和Mike Weinberg对dbt Slack的评论)</p><h1 id="14e1" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">后续步骤</h1><ul class=""><li id="f1b8" class="mr ms iq ll b lm ln lp lq ls ob lw oc ma od me mw mx my mz bi translated">探索雪花数据市场中的优质气象提供商。</li><li id="cbbb" class="mr ms iq ll b lm na lp nb ls nc lw nd ma ne me mw mx my mz bi translated">用一个<a class="ae kq" href="http://bit.ly/sf-free-trial" rel="noopener ugc nofollow" target="_blank">雪花免费试用账户</a>试试吧——你只需要一个电子邮件地址就可以开始了。</li><li id="5dbf" class="mr ms iq ll b lm na lp nb ls nc lw nd ma ne me mw mx my mz bi translated">在<a class="ae kq" href="https://www.snowflake.com/data-marketplace/" rel="noopener ugc nofollow" target="_blank">雪花数据市场</a>找到更多数据集。</li></ul><h1 id="4631" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">想要更多吗？</h1><p id="0b4e" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我是Felipe Hoffa，雪花的数据云倡导者。谢谢你和我一起冒险。你可以在Twitter 和LinkedIn 上<a class="ae kq" href="https://twitter.com/felipehoffa" rel="noopener ugc nofollow" target="_blank">关注我，查看</a><a class="ae kq" href="https://www.reddit.com/r/snowflake/" rel="noopener ugc nofollow" target="_blank">reddit.com/r/snowflake</a>最有趣的雪花新闻。</p></div></div>    
</body>
</html>