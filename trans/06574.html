<html>
<head>
<title>A Practical Guide To MLOps Using AWS Sagemaker — Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Sagemaker的MLOps实用指南—第二部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-practical-guide-to-mlops-using-aws-sagemaker-part-ii-c5159b4b51aa?source=collection_archive---------16-----------------------#2021-06-13">https://towardsdatascience.com/a-practical-guide-to-mlops-using-aws-sagemaker-part-ii-c5159b4b51aa?source=collection_archive---------16-----------------------#2021-06-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a94d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何使用AWS lambda和REST API部署您的模型供全世界使用。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3c2e842af5c628449d8bfc74d1a7a32e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*x5CS1MnMfcWTT0vP"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">文森特·梵高的《罗讷河上的星夜》(<a class="ae kv" href="https://commons.wikimedia.org/wiki/Category:Starry_Night_Over_the_Rhone_by_Vincent_van_Gogh" rel="noopener ugc nofollow" target="_blank">来源</a>)</p></figure><p id="af09" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们开始之前，我强烈建议你阅读<a class="ae kv" rel="noopener" target="_blank" href="/a-practical-guide-to-mlops-in-aws-sagemaker-part-i-1d28003f565">第一部分</a>，如果你还没有这样做的话。在本指南中，我们将介绍如何部署您的模型，以便前端开发人员可以在他们使用REST API的应用程序中使用它，而不必太担心底层细节。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/d486ebe8488343c14630ecd2a6806a58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*T_72LWHsI31hWYIG_fL51Q.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们需要构建一个管道，将用户的Web浏览器(左)连接到我们的模型端点(右)。(图片由作者提供)</p></figure><p id="dea8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于我们已经在前一部分开发和部署了模型端点，我们将从开发lambda函数开始。</p><h1 id="1f2a" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">AWS函数</h1><blockquote class="ml mm mn"><p id="3ee0" class="kw kx mo ky b kz la jr lb lc ld ju le mp lg lh li mq lk ll lm mr lo lp lq lr ij bi translated">AWS Lambda是一种无服务器计算服务，允许您运行代码，而无需配置或管理服务器、创建工作负载感知集群扩展逻辑、维护事件集成或管理运行时。</p></blockquote><p id="8505" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过使用AWS Lambda函数，我们可以避免设置专用服务器来监控传入的请求和执行代码。这样做有很多好处，比如每次lambda函数被传入的请求触发时，我们只需支付计算费用，而不是专用的服务器。</p><p id="058a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">按照步骤创建一个lambda函数来处理传入的请求。</p><ol class=""><li id="ba8a" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">登录AWS控制台，从服务列表中选择lambda。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/ad3de7b909518aeaf8f9b7a6b986d0fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0Iy3klwUmEyRwU_qoZJ6Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Lambda function dashboard显示您使用了多少存储和其他统计数据。(图片由作者提供)</p></figure><p id="6da4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.创建一个新的lambda函数开始编码。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/2dba17c06b9fd2425e1ec658dbcbdfa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XrpYsG9o2Ohrre46EU6XCg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Lambda函数允许您将简单的代码包部署到无服务器环境中。(图片由作者提供)</p></figure><p id="a4c9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.添加模型端点的名称作为环境变量，方法是单击configuration选项卡并添加一个新变量，使用关键字“ENDPOINT_NAME”和值作为开发的端点的名称。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/417535fe84bc1ee23aab11845a589de4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ygs6WXNYN8CqdkJOSEs-Yg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">添加端点名称作为环境变量将有助于我们将来在开发更好的模型时自动化这个过程。(图片由作者提供)</p></figure><p id="00fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.将下面的代码放入代码编辑器中，确保您将变量“<strong class="ky ir">bucket”</strong>的值替换为您自己的变量，以便它指向您在模型开发期间保存转换的位置。</p><p id="08cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意:您可以在第1部分开始时创建的笔记本中找到s3的位置。</strong></p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="81ba" class="nj lu iq nf b gy nk nl l nm nn">import os<br/>import json<br/>import boto3<br/>import pickle<br/>import sklearn<br/>import warnings<br/>warnings.simplefilter("ignore")</span><span id="d180" class="nj lu iq nf b gy no nl l nm nn"># grab environment variables<br/><strong class="nf ir">ENDPOINT_NAME </strong>= os.environ['ENDPOINT_NAME']<br/><strong class="nf ir">runtime</strong>= boto3.client('runtime.sagemaker')<br/><strong class="nf ir">bucket </strong>= "sagemaker-ap-south-1-573002217864"<br/><strong class="nf ir">key </strong>= "cust-churn-model/transformation/transformation.sav"<br/>s3 = boto3.resource('s3')</span><span id="73ee" class="nj lu iq nf b gy no nl l nm nn">def lambda_handler(event, context):<br/>    <br/>    payload = process_data(event)<br/>    response = runtime.invoke_endpoint(EndpointName=ENDPOINT_NAME,<br/>                                       ContentType='text/csv',<br/>                                       Body=payload)<br/>    result = json.loads(response['Body'].read().decode())<br/>    predicted_label = 'True' if result &gt; 0.39 else 'False'<br/>    <br/>    return predicted_label</span><span id="4e19" class="nj lu iq nf b gy no nl l nm nn">def process_data(event):<br/>    trans = pickle.loads(s3.Object(bucket, key).get()['Body'].read())<br/>    event.pop('Phone')<br/>    event['Area Code'] = int(event['Area Code'])<br/>    obj_data = [[value for key,value in event.items() if key in trans['obj_cols']]]<br/>    num_data = [[value for key,value in event.items() if key in trans['num_cols']]]<br/>    <br/>    obj_data = trans['One_Hot'].transform(obj_data).toarray()<br/>    num_data = trans['scaler'].transform(num_data)<br/>    <br/>    obj_data = [str(i) for i in obj_data[0]]<br/>    num_data = [str(i) for i in num_data[0]]<br/>    <br/>    data = obj_data + num_data<br/>    return ",".join(data)</span></pre><p id="2a33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">5.在我们执行lambda函数之前的最后一步，lambda函数使用vanilla python3来执行，默认情况下没有安装任何库，如Pandas、NumPy或sklearn。因此，我们需要添加一个sklearn层，以便可以加载我们的转换。</p><p id="9fc1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我将不会进入如何创建和添加一个层的细节，因为这是一个单独的主题，你可以在这里找到更多的细节。</p><p id="aed4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦完成，我们就准备好测试我们的lambda函数，选择<strong class="ky ir">测试</strong>下拉菜单来配置一个测试用例，并将下面的输入数据粘贴到其中来运行测试。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="c933" class="nj lu iq nf b gy nk nl l nm nn">{<br/>  "State": "SC",<br/>  "Account Length": "15",<br/>  "Area Code": "836",<br/>  "Phone": "158-8416",<br/>  "Int'l Plan": "yes",<br/>  "VMail Plan": "no",<br/>  "VMail Message": "0",<br/>  "Day Mins": "10.018992664834252",<br/>  "Day Calls": "4",<br/>  "Day Charge": "4.226288822198435",<br/>  "Eve Mins": "2.3250045529370977",<br/>  "Eve Calls": "0",<br/>  "Eve Charge": "9.97259241534841",<br/>  "Night Mins": "7.141039871521733",<br/>  "Night Calls": "200",<br/>  "Night Charge": "6.436187619334115",<br/>  "Intl Mins": "3.2217476231887012",<br/>  "Intl Calls": "6",<br/>  "Intl Charge": "2.559749162329034",<br/>  "CustServ Calls": "8"<br/>}</span></pre><p id="ae50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">6.一旦您运行测试，lambda函数将通过转换将输入数据运行到我们已经部署的端点，以获得对数据的响应。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi np"><img src="../Images/19635cf4b06c2da50c32b90b5a883634.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*_lZTjZqfRES422oKXmPJgQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">如果一切顺利，您将看到模型的响应。(图片由作者提供)</p></figure><h1 id="2987" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">构建REST API</h1><blockquote class="ml mm mn"><p id="4d4e" class="kw kx mo ky b kz la jr lb lc ld ju le mp lg lh li mq lk ll lm mr lo lp lq lr ij bi translated">API是一组用于构建和集成应用软件的定义和协议。它有时被称为信息提供者和信息用户之间的契约—建立消费者所需的内容(调用)和生产者所需的内容(响应)。</p></blockquote><p id="4ea3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的例子中，lambda函数是<em class="mo">生产者</em>，它使用模型端点来预测消费者提供的输入<em class="mo">(调用)</em>的分数，消费者可以是前端开发人员开发的任何web应用程序。</p><ol class=""><li id="40af" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">从AWS服务列表中选择“<strong class="ky ir"><em class="mo">【API Gateway】</em></strong>，选择<strong class="ky ir"><em class="mo"/></strong><strong class="ky ir"><em class="mo">【创建API】</em></strong>选项，创建一个新的REST API。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/521624c95099802307ffe66a73634dd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eXqU6ZqgxDV9kpFnZDQvuQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用REST API，我们可以将模型提供给前端应用程序。(图片由作者提供)</p></figure><p id="fcbc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.从API列表中选择REST API并点击build。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/f3a29e6ca9e761395aeba5da2d0c5d2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1036/format:webp/1*XgbJX6FwrZVWvspOZhNH1Q.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">构建一个新的REST API。(图片由作者提供)</p></figure><p id="7f46" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.选择新的API，给它一个好听的名字，然后创建。确保将端点类型保留为区域。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/116971a70f22f1fd3d80235487bbf89d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*J4fT1OxflF1A92qWJk6yig.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将端点类型保留为区域。(图片由作者提供)</p></figure><p id="eba0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.点击<strong class="ky ir">动作</strong>下拉菜单，选择<strong class="ky ir"> <em class="mo">“创建资源”。</em> </strong>创建新资源。接下来，再次单击Actions并创建一个新的Post方法。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/229dadc5ee62de4da7b0be4bc586a7d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*_aUCtdWkILkYpk6cGeoEuA.png"/></div></figure><p id="da3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">5.一旦你创建了一个<strong class="ky ir"> <em class="mo"> Post方法</em> </strong>你会得到一个选项来将这个方法与你创建的lambda函数集成，输入你的lambda函数的名字继续。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/d3dd9bbe64abcecd3101111fdf025d64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*lARTKt9v1wmpaGcczrYHLA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">确保你所有的项目(lambda，API，Sagemaker studio，s3)都在同一个区域。(图片由作者提供)</p></figure><p id="2415" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦创建了API，就需要部署它。正如你所看到的，仪表板显示了你的API的架构，以及它是如何集成到你的lambda函数中的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/a6f995a3a601d99e7d4ff7b3f3e4e38c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ob_B2mW7lHOxLSjusoeQYQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">与lambda函数一起部署的API结构。(图片由作者提供)</p></figure><p id="65bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">6.您可以通过点击<strong class="ky ir">动作</strong>选项卡并选择<strong class="ky ir">部署API </strong>选项来部署API。这将为您提供一个链接，您可以使用它向您的模型端点发送<strong class="ky ir"> Post </strong>请求。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/87ae86a08989b19c4428ee7ec7e9c78b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sCF-45h7j1GuSDRQ-zkamQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">确保在复制调用URL之前选择post方法。(图片由作者提供)</p></figure><h1 id="ff74" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">将这一切结合在一起</h1><p id="6bde" class="pw-post-body-paragraph kw kx iq ky b kz nx jr lb lc ny ju le lf nz lh li lj oa ll lm ln ob lp lq lr ij bi translated">现在是测试我们的模型结果是否可以通过我们的部署公之于众的时候了。我们可以使用Postman来测试我们的API。</p><p id="0ef2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Postman中创建一个新的测试，粘贴您从REST API中创建的链接，选择<strong class="ky ir"> Body </strong>作为输入类型，选择<strong class="ky ir"> POST </strong>作为请求类型，并提供输入数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/457517f52190f87fbd4173f2ebefdf86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uwLfPxipUdNH2sJkbBD9Ug.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Postman可用于在部署到生产环境之前测试您的API。(图片由作者提供)</p></figure><p id="96d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦你点击发送，它将发送一个请求给你的API，API将把请求传递给lambda函数以获得响应。</p><p id="bb3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">万岁！！您已经构建了一个完整的端到端的模型部署管道。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/5501721f4111725d5cab2ab0caaddada.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nndxpH5y_fIEIhoKfp_D8A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">响应将由Postman连同一些统计数据一起提交。(图片由作者提供)</p></figure><h1 id="5671" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">结论</h1><p id="b35d" class="pw-post-body-paragraph kw kx iq ky b kz nx jr lb lc ny ju le lf nz lh li lj oa ll lm ln ob lp lq lr ij bi translated">总之，我们有。</p><ol class=""><li id="1b5a" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">在AWS上构建了完整的CI/CD兼容模型开发管道。</li><li id="a24d" class="ms mt iq ky b kz oe lc of lf og lj oh ln oi lr mx my mz na bi translated">使用AWS lambda函数执行预处理来访问模型端点。</li><li id="5859" class="ms mt iq ky b kz oe lc of lf og lj oh ln oi lr mx my mz na bi translated">构建了一个REST API来向前端应用程序公开我们的模型。</li><li id="752f" class="ms mt iq ky b kz oe lc of lf og lj oh ln oi lr mx my mz na bi translated">使用Postman测试我们的管道。</li></ol><p id="b13f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个阶段，你应该花点时间回顾一下你做过的所有事情，并试着想出新的很酷的实验来做得更好。</p><h2 id="a4ce" class="nj lu iq bd lv oj ok dn lz ol om dp md lf on oo mf lj op oq mh ln or os mj ot bi translated">如果你觉得我的工作有帮助，这里是你可以做的。</h2><blockquote class="ml mm mn"><p id="30e6" class="kw kx mo ky b kz la jr lb lc ld ju le mp lg lh li mq lk ll lm mr lo lp lq lr ij bi translated">发表评论让我知道你的想法，或者如果你发现任何问题。</p><p id="8dd2" class="kw kx mo ky b kz la jr lb lc ld ju le mp lg lh li mq lk ll lm mr lo lp lq lr ij bi translated">与你的朋友分享这篇文章。</p></blockquote></div></div>    
</body>
</html>