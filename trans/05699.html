<html>
<head>
<title>SQL — Learn how to roll back queries in a transaction</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL —了解如何回滚事务中的查询</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sql-rolling-back-statements-with-transactions-81937811e7a7?source=collection_archive---------16-----------------------#2021-05-21">https://towardsdatascience.com/sql-rolling-back-statements-with-transactions-81937811e7a7?source=collection_archive---------16-----------------------#2021-05-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5d18" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">要么执行所有查询，要么一个都不执行</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f3e3aad26c46459b816596bac3631371.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AflwZPGY_B4tl1vzVSwW9g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这台机器是为处理交易而建造的，就像你这篇文章之后的代码一样(图片由<a class="ae ky" href="https://unsplash.com/@davidcarboni" rel="noopener ugc nofollow" target="_blank">大卫·卡尔波尼</a>在<a class="ae ky" href="https://unsplash.com/photos/xvkSnspiETA" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供)</p></figure><p id="a37c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管有错误，事务负责保证数据的有效性，它们是SQL工具箱中的重要工具。事务中的所有查询要么成功，要么全部失败；如果最后一个失败，那么之前的查询将回滚(撤消)。在本文中，你将学习<em class="lv">如何</em>使用事务，但首先我们将讨论<em class="lv">何时</em>使用事务:</p><h1 id="407e" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">0.何时使用事务</h1><p id="6fe0" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在某些情况下，您需要在数据库中执行两个不能同时完成的操作(比如将<a class="ae ky" href="https://mikehuls.medium.com/sql-insert-delete-and-update-in-one-statement-sync-your-tables-with-merge-14814215d32c" rel="noopener">合并到</a>、<a class="ae ky" href="https://mikehuls.medium.com/sql-update-into-another-table-bfc3dff79a66" rel="noopener">更新到</a>，或者<a class="ae ky" href="https://mikehuls.medium.com/sql-delete-into-another-table-b5b946a42299" rel="noopener">删除到</a>)，但是它们仍然相互依赖。如果他们中的任何一个失败了，他们都不会成功。在SQL中使用事务就可以做到这一点；如果一个事务失败，则回滚以前的事务。</p><h1 id="789b" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">1.设置</h1><p id="7d61" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">让我们用一个例子来说明。在我们的披萨公司，我们有披萨菜单桌和披萨饼桌。每周我们都会收到这两个表格的文件。我们的目标很简单；我们必须将每周文件插入表格中。面临的挑战是，如果数据库中有价格，我们只能在菜单上有比萨饼。让我们创建表格:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><h1 id="d424" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">2.用错误的方法解决它</h1><p id="a427" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">错误的做法是将数据插入到两个表中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="8fb6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会注意到最后一条记录中的错误；我们在只允许浮点数的地方插入一个字符串。如果我们执行上面的代码，我们会注意到第一次插入成功了，第二次插入失败了。这不是我们想要的，因为我们现在菜单上有比萨饼，但没有价格。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/2c64206fdb905554e7ed02615b26f2a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*iDpBpRgX6tXsB_tjY2gEsg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">❌ 我们的披萨已经满了，但是我们的披萨不见了！</p></figure><h1 id="62bc" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">3.拯救交易！</h1><p id="3400" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">当我们使用事务和try-catch-block时，我们将得到我们想要的。让我们检查代码，然后解释。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="d044" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的代码从TRAN开始。这启动了一个<strong class="lb iu">事务</strong>。<strong class="lb iu">事务</strong>有两种可能的执行方式:<strong class="lb iu">提交</strong>和<strong class="lb iu">回滚</strong>。从开始TRAN到提交TRAN或回滚TRAN之间执行的每个命令都被“记住”。一个<strong class="lb iu">提交</strong>确认所有已被记忆的命令。一个<strong class="lb iu">回滚</strong>撤销所有命令。</p><p id="4c6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的代码中，我们将insert语句包装在一个try中。如果他们中的任何一个失败了，我们就会在CATCH块中结束。如果我们在那里结束，我们回滚所有事务。<a class="ae ky" href="https://emojipedia.org/check-mark-button/" rel="noopener ugc nofollow" target="_blank"> ✅ </a>如果我们执行上面的代码，两个表都是空的；<strong class="lb iu">两次插入均未成功</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/0e157c7c20cfcc820c719c821029683f.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*MC_jPn3IT9WM2xOxFfiw0g.jpeg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">回去走另一条路！(图片由<a class="ae ky" href="https://unsplash.com/@roger3010" rel="noopener ugc nofollow" target="_blank">罗杰·布拉德肖</a>在<a class="ae ky" href="https://unsplash.com/photos/1PPoNhMzAmY" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure><h1 id="de32" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">4.抛出一个交易</h1><p id="c7c9" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">您的代码不一定要在事务中利用回滚；你可以自己决定:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="9b5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的代码中，我们将数据插入到PizzaMenu和PizzaPrices中。然后我们检查是否有菜单上所有比萨饼的价格。如果不是这样，我们抛出一个错误，触发回滚。否则我们提交我们的事务。执行上面的代码不会插入任何数据，因为我们已经注释掉了第18行。</p><h1 id="301f" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">5.保持你的桌子快速</h1><p id="2ec7" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">一旦开始一个事务，执行操作的表就会被锁定。锁定的表不可编辑，因此为了保持表的速度，非常重要的一点是，一旦事务开始，它应该<strong class="lb iu">尽快提交</strong>或<strong class="lb iu">回滚</strong>。</p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><h1 id="c7e7" class="lw lx it bd ly lz ne mb mc md nf mf mg jz ng ka mi kc nh kd mk kf ni kg mm mn bi translated">结论</h1><p id="59a8" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">事务是您工具箱中的一个很棒的新工具，就像下面这些一样:</p><ul class=""><li id="3b9b" class="nj nk it lb b lc ld lf lg li nl lm nm lq nn lu no np nq nr bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-delete-into-another-table-b5b946a42299" rel="noopener">删除到另一个表格</a></li><li id="e278" class="nj nk it lb b lc ns lf nt li nu lm nv lq nw lu no np nq nr bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-into-another-table-bfc3dff79a66" rel="noopener">更新到另一个标签页</a> le</li><li id="c5c4" class="nj nk it lb b lc ns lf nt li nu lm nv lq nw lu no np nq nr bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-insert-delete-and-update-in-one-statement-sync-your-tables-with-merge-14814215d32c" rel="noopener">在一条语句中插入、删除和更新</a></li><li id="524f" class="nj nk it lb b lc ns lf nt li nu lm nv lq nw lu no np nq nr bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-select-in-one-query-b067a7e60136" rel="noopener">更新选择一批记录</a></li><li id="6263" class="nj nk it lb b lc ns lf nt li nu lm nv lq nw lu no np nq nr bi translated"><a class="ae ky" href="https://mikehuls.medium.com/version-control-your-database-part-1-creating-migrations-and-seeding-992d86c90170" rel="noopener">版本控制你的数据库</a></li></ul><p id="c0a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><p id="2422" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="8be6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page的缩写）学生:比如我正在做的事情？<a class="ae ky" href="https://mikehuls.medium.com/" rel="noopener">跟着我</a>！</p></div></div>    
</body>
</html>