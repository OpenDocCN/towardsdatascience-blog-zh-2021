<html>
<head>
<title>6 Steps to Make this Pandas Dataframe Operation 100 Times Faster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">6 个步骤使熊猫数据帧操作速度提高 100 倍</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/cython-for-data-science-6-steps-to-make-this-pandas-dataframe-operation-over-100x-faster-1dadd905a00b?source=collection_archive---------13-----------------------#2021-12-13">https://towardsdatascience.com/cython-for-data-science-6-steps-to-make-this-pandas-dataframe-operation-over-100x-faster-1dadd905a00b?source=collection_archive---------13-----------------------#2021-12-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="484a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用于数据科学的 Cython:将 Pandas 与 Cython 结合起来，实现令人难以置信的速度提升</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/dcd67f8c038b30d47361169dd045c807.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*axZ2yBuMM3Ne9hkk"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">看起来没那么快，让我们加速吧！(图片由<a class="ae ky" href="https://unsplash.com/@umbriferous" rel="noopener ugc nofollow" target="_blank">西奥多·伦奎斯特</a>在<a class="ae ky" href="https://unsplash.com/photos/6Ox3fPG-qvo" rel="noopener ugc nofollow" target="_blank"> unsplash </a>上拍摄)</p></figure><p id="ca0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，您将了解如何改进 Panda 的 df.apply()函数，使其速度提高 100 倍以上。本文采用了 Pandas 的标准<code class="fe lv lw lx ly b">dataframe.apply</code>函数，并对其进行了一点升级，将执行速度从 3 分钟提高到 2 秒<em class="lz">。在本文结束时，您将:</em></p><ul class=""><li id="d01d" class="ma mb it lb b lc ld lf lg li mc lm md lq me lu mf mg mh mi bi translated">理解 df.apply()为什么慢</li><li id="1394" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">了解如何通过 Cython 加速应用</li><li id="0aa5" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">知道如何通过将数组传递给 Cython 来替换 apply</li><li id="36a1" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">能够多进程处理你的 Cython-function 来挤出最大的速度</li><li id="d950" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">用你的代码总是比他们的快得多这一事实来烦扰你的同事</li></ul><p id="b8d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们开始之前，我强烈推荐阅读这篇关于 Python 为何如此缓慢的文章。它帮助您理解我们在本文中试图解决的问题类型。也可以查看<a class="ae ky" href="https://mikehuls.medium.com/getting-started-with-cython-how-to-perform-1-7-billion-calculations-per-second-in-python-b83374cfcf77" rel="noopener"> <strong class="lb iu">这篇关于 Cython 入门的文章</strong> </a>。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="7c10" class="mv mw it bd mx my mz dn na nb nc dp nd li ne nf ng lm nh ni nj lq nk nl nm nn bi translated">熊猫不是已经挺快的了吗？</h2><p id="637e" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">没错，它是建立在用 c 写的 Numpy 上的，速度非常快。然而，Df.apply 将 Python 函数应用于数组。<a class="ae ky" href="https://mikehuls.medium.com/why-is-python-so-slow-and-how-to-speed-it-up-485b5a84154e" rel="noopener">慢 Python 函数是<em class="lz">不是</em>快</a>。这是我们试图解决的问题的一部分。另一方面，Python 中也会出现循环。首先，我们将进行设置，然后我们将通过 6 个步骤来解决这些问题。</p><h1 id="2d97" class="nt mw it bd mx nu nv nw na nx ny nz nd jz oa ka ng kc ob kd nj kf oc kg nm od bi translated">设置</h1><p id="9f19" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">这种类型的教程总是与实际的例子一起工作得最好，所以对于这个项目，我们将想象我们有一个网上商店。因为我们已经有 1700 万客户，所以我们决定开一家实体店，这样客户就可以取货了，节省了我们的送货成本。我们已经选好了几个地点，但哪个是最好的呢？我们决定<strong class="lb iu">我们最好定居在离我们所有客户的平均距离最短的地方。</strong></p><p id="ef8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们想要计算每个位置的平均距离，但是我们都很忙，不想花很长时间等待距离计算完成。</p><blockquote class="oe"><p id="9b9d" class="of og it bd oh oi oj ok ol om on lu dk translated">我们的目标是优化计算所有客户到某个位置的平均距离。</p></blockquote><h2 id="3d69" class="mv mw it bd mx my oo dn na nb op dp nd li oq nf ng lm or ni nj lq os nl nm nn bi translated">加载数据</h2><p id="66c5" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">为此，我们从数据库(使用<a class="ae ky" href="https://mikehuls.medium.com/dramatically-improve-your-database-inserts-with-a-simple-upgrade-6dfa672f1424" rel="noopener"> <strong class="lb iu"> this article </strong> </a>)将 1700 万客户全部加载到一个 dataframe 中(隐藏所有不必要的列):</p><pre class="kj kk kl km gt ot ly ou ov aw ow bi"><span id="0ae5" class="mv mw it ly b gy ox oy l oz pa">customer_id          lat        lon<br/>          0    52.131980    5.510361<br/>          1    52.438026    6.815252<br/>          2    51.238809    4.447790<br/>          3    51.163722    3.588959<br/>          4    52.559595    5.483185</span></pre><h2 id="a83e" class="mv mw it bd mx my mz dn na nb nc dp nd li ne nf ng lm nh ni nj lq nk nl nm nn bi translated">距离计算功能</h2><p id="7017" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">以下函数可用于计算地球上两点之间的球面距离。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><h2 id="9324" class="mv mw it bd mx my mz dn na nb nc dp nd li ne nf ng lm nh ni nj lq nk nl nm nn bi translated">安装依赖项</h2><p id="b5b3" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">剧透警告:我们要用 Cython 来解决这个问题。我们使用 CythonBuilder 来负责编译、构建和打包我们的包。安装时使用:</p><pre class="kj kk kl km gt ot ly ou ov aw ow bi"><span id="34d2" class="mv mw it ly b gy ox oy l oz pa">pip install cython<br/>pip install cythonbuilder</span></pre><p id="cad6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装后，调用<code class="fe lv lw lx ly b">cybuilder init</code>。这将在您的根目录下创建一个名为<code class="fe lv lw lx ly b">ext</code>的文件夹。如果您不熟悉使用终端，请查看本文<a class="ae ky" href="https://mikehuls.medium.com/terminals-consoles-command-line-for-absolute-beginners-de7853c7f5e8" rel="noopener"><strong class="lb iu"/></a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/524225e48d0338956f0c44df07690583.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HEmZPRPtYaB1qFvs"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们将通过 6 个步骤从这个到高超音速喷气式飞机(图片由高清<a class="ae ky" href="https://unsplash.com/@historyhd" rel="noopener ugc nofollow" target="_blank">历史</a>在<a class="ae ky" href="https://unsplash.com/photos/2MUqdhKBMzw" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供)</p></figure><h1 id="64ee" class="nt mw it bd mx nu nv nw na nx ny nz nd jz oa ka ng kc ob kd nj kf oc kg nm od bi translated">计算平均距离</h1><p id="fff2" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">我们已经选择了一个我们想要计算平均顾客距离的位置。我们将用<strong class="lb iu"> 6 个步骤</strong>来解决这个问题。在每一步中，我们将改进我们的代码并实现更快的速度。我们将从 Python 开始，逐渐增加更多的 Cython 和其他优化。</p><h2 id="ca74" class="mv mw it bd mx my mz dn na nb nc dp nd li ne nf ng lm nh ni nj lq nk nl nm nn bi translated">第一步。纯 Python</h2><p id="f3bd" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">我们将把距离计算函数<code class="fe lv lw lx ly b">df.apply</code>到我们的数据帧中，将结果赋给一个新列，最后，对该列进行平均。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><p id="c4a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是可行的，但还有很多可以改进的地方。该功能在<strong class="lb iu">大约 3 分钟</strong>后结束。这将是我们的基准:</p><pre class="kj kk kl km gt ot ly ou ov aw ow bi"><span id="6418" class="mv mw it ly b gy ox oy l oz pa">[1_purepy]  17M rows   179037ms</span></pre></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="9996" class="mv mw it bd mx my mz dn na nb nc dp nd li ne nf ng lm nh ni nj lq nk nl nm nn bi translated">第二步。糖化</h2><p id="1286" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">在这一部分，我们将把 Python 代码放在 Cython 文件中。在<code class="fe lv lw lx ly b">ext/pyxfiles</code>中新建一个名为<code class="fe lv lw lx ly b">geopack.pyx</code>的文件。如果这个文件夹还不存在，你可能忘了调用<code class="fe lv lw lx ly b">cybuilder init</code>。只需将您的 Python 函数复制并粘贴到这个新文件中，如下所示(不要忘记导入):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><p id="735a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要编译、构建和打包这个模块。幸运的是，使用 CythonBuilder 非常容易。调用<code class="fe lv lw lx ly b">cybuilder build</code>来做这件事。然后我们可以从 CythonBuilder 创建的<code class="fe lv lw lx ly b">ext</code>文件夹中导入并使用如下功能:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><p id="80af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像这样简单！这段代码在 2.7 分钟内完成，虽然我们还没有优化任何东西，但已经快了一点。让我们看看我们的基准，并开始优化。</p><pre class="kj kk kl km gt ot ly ou ov aw ow bi"><span id="bb83" class="mv mw it ly b gy ox oy l oz pa">[1_purepy]  17M rows   179037ms<br/>[2_pyINcy]  17M rows   163102ms      (x1.098)</span></pre></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="dca4" class="mv mw it bd mx my mz dn na nb nc dp nd li ne nf ng lm nh ni nj lq nk nl nm nn bi translated">第三步。使最佳化</h2><p id="7767" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">在这一步，我们正在优化我们的 Cython 代码。大多数情况下，我们只是添加类型，这样代码就可以被编译，而不必通过<a class="ae ky" href="https://mikehuls.medium.com/why-is-python-so-slow-and-how-to-speed-it-up-485b5a84154e" rel="noopener">解释器</a>。让我们看看下面的新功能，然后经历所有的变化。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><p id="5d1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">第 1 行和第 2 行</strong> <br/>我们现在正在导入 Cython 函数。这些稍微快一点</p><p id="5158" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">第 4–7 行<br/> </strong>这些是编译器指令；它们告诉编译器避免某些检查。当我们使用循环时，我们避免检查无、零除和一些与边界和回绕有关的检查。查看<a class="ae ky" href="https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiler-directives" rel="noopener ugc nofollow" target="_blank">文档</a>了解更多信息。</p><p id="8c09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">第 8 行<br/> </strong>首先，我们不是用<code class="fe lv lw lx ly b">def</code>而是用<code class="fe lv lw lx ly b">cpdef</code>来定义我们的函数。这使得 C 和 Python 都可以访问该函数。然后我们定义我们的返回类型(在<code class="fe lv lw lx ly b">cpdef float</code>中的<code class="fe lv lw lx ly b">float</code>部分)。最后，我们键入我们的输入(比如<code class="fe lv lw lx ly b">double lat1</code>)。</p><p id="1202" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">第 11–13 行<br/> </strong>添加我们在此函数中使用的变量类型。</p><p id="9972" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">结果</strong> <br/>在我们调整了函数之后，我们再次调用<code class="fe lv lw lx ly b">cybuilder build</code>来更新我们的包。当我们运行这个新函数时，我们发现我们的代码变快了，大约 2.4 分钟就完成了:</p><pre class="kj kk kl km gt ot ly ou ov aw ow bi"><span id="8b96" class="mv mw it ly b gy ox oy l oz pa">[1_purepy]  17M rows   179037ms<br/>[2_pyINcy]  17M rows   163102ms      (x1.098)<br/>[3_optiCy]  17M rows   148108ms      (x1.209)</span></pre><p id="58bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经削减了 17%的执行时间，但这还远远不够。<strong class="lb iu">尽管优化了函数，df.apply()仍然很慢的原因是所有的循环都发生在 Python 中。</strong>所以让我们来把这个循环中化吧！</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="1695" class="mv mw it bd mx my mz dn na nb nc dp nd li ne nf ng lm nh ni nj lq nk nl nm nn bi translated">第四步。循环的细胞化</h2><p id="0c17" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">我们将在 Cython 中创建一个新函数，该函数将接收两个数组(所有客户的纬度和经度，以及两个浮点数(store-lat 和 store-long)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><p id="a24d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个函数唯一要做的就是遍历所有的数据，并调用我们之前定义的函数(第 20 行)。执行<code class="fe lv lw lx ly b">cybuilder build</code>并运行该函数，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><p id="febf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们运行这个新函数时，我们在<strong class="lb iu"> <em class="lz"> 2.3 秒</em> </strong>内完成。这是一个相当惊人的速度升级！在下一部分，我们将发现如何挤出更多的速度。</p><pre class="kj kk kl km gt ot ly ou ov aw ow bi"><span id="d297" class="mv mw it ly b gy ox oy l oz pa">[1_purepy]  17M rows   179037ms<br/>[2_pyINcy]  17M rows   163102ms      (x1.098)<br/>[3_optiCy]  17M rows   148108ms      (x1.209)<br/>[4_CyLoop]  17M rows     2346ms     (x76.327)</span></pre></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="3ba6" class="mv mw it bd mx my mz dn na nb nc dp nd li ne nf ng lm nh ni nj lq nk nl nm nn bi translated">第五步。细胞聚集</h2><p id="7764" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">因为我们对平均距离感兴趣，并且我们已经在 Cython 中包含了循环，所以我们不必返回数组。我们可以在上一步创建的 Cython 函数中计算平均值。这也将简化我们的功能:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><p id="7428" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们像这样直接调用我们的函数</p><pre class="kj kk kl km gt ot ly ou ov aw ow bi"><span id="0062" class="mv mw it ly b gy ox oy l oz pa">avgdist = geopack.calculate_mean_distance(<br/>    store_lat,<br/>    store_lon,<br/>    df['lat'].to_numpy(),<br/>    df['lon'].to_numpy()<br/>)</span></pre><p id="6335" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这节省了一点时间:</p><pre class="kj kk kl km gt ot ly ou ov aw ow bi"><span id="9d27" class="mv mw it ly b gy ox oy l oz pa">[1_purepy]  17M rows   179037ms<br/>[2_pyINcy]  17M rows   163102ms      (x1.098)<br/>[3_optiCy]  17M rows   148108ms      (x1.209)<br/>[4_CyLoop]  17M rows     2346ms     (x76.327)<br/>[5_CyAggr]  17M rows     2225ms     (x80.468)</span></pre></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="7be5" class="mv mw it bd mx my mz dn na nb nc dp nd li ne nf ng lm nh ni nj lq nk nl nm nn bi translated">第六步。使用多个 CPU 并行处理</h2><p id="8608" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">我们有多个 CPU，对吗？那么为什么不用一些呢？在下面这段优雅的代码中，我们使用一个进程池将工作分配给多个进程。每个进程同时运行，使用不同的 CPU。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><p id="ecf2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lz">流程需要一些时间来初始化，所以要确保你有足够的工作来让启动成本物有所值。阅读</em> <a class="ae ky" href="https://mikehuls.medium.com/advanced-multi-tasking-in-python-applying-and-benchmarking-threadpools-and-processpools-90452e0f7d40" rel="noopener"> <strong class="lb iu"> <em class="lz">这篇文章</em> </strong> </a> <em class="lz">来学习更多关于 Python 中多任务处理的知识。</em></p><p id="4938" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们执行上面的代码并让所有的 CPU 同时处理手头的任务时，我们得到了最终的结果；我们能从这项任务中挤出的最大速度:</p><pre class="kj kk kl km gt ot ly ou ov aw ow bi"><span id="6b63" class="mv mw it ly b gy ox oy l oz pa">[1_purepy]  17M rows   179037ms<br/>[2_pyINcy]  17M rows   163102ms      (x1.098)<br/>[3_optiCy]  17M rows   148108ms      (x1.209)<br/>[4_CyLoop]  17M rows     2346ms     (x76.327)<br/>[5_CyAggr]  17M rows     2225ms     (x80.468)<br/>[6_CyProc]  17M rows     1640ms    (x109.169)</span></pre><p id="b25b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，我们已经将这项任务的速度提高了近 110 倍；消除了超过 99%的纯 Python 执行时间。请注意，为了实现这一惊人的速度提升，我们需要做的事情有:</p><ul class=""><li id="8bb7" class="ma mb it lb b lc ld lf lg li mc lm md lq me lu mf mg mh mi bi translated">将我们的函数复制到 Python 中</li><li id="2980" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">添加一些类型</li><li id="f506" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">添加一个处理循环的简单函数</li><li id="a30c" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">添加 4 行来处理多重处理。</li></ul><p id="97fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还不错！现在让我们来计算最佳距离。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h2 id="019a" class="mv mw it bd mx my mz dn na nb nc dp nd li ne nf ng lm nh ni nj lq nk nl nm nn bi translated">使用我们的优化函数来计算我们商店的最佳位置。</h2><p id="2a57" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">我们现在可以执行下面的代码来最终得到我们的答案:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pb pc l"/></div></figure><p id="c832" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认的<code class="fe lv lw lx ly b">.apply()</code>方法将在大约<strong class="lb iu"> 9 分钟</strong>内计算到我们 3 个位置的平均距离。由于我们新的、优化的、多处理的功能，我们只需等待大约<strong class="lb iu"> 5 秒</strong>！以下结果表明，格罗宁根是开设我们商店的最佳城市！</p><pre class="kj kk kl km gt ot ly ou ov aw ow bi"><span id="480d" class="mv mw it ly b gy ox oy l oz pa">Amsterdam:  115.93 km avg<br/>Utrecht:    111.56 km avg<br/>Groningen:  102.54 km avg</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/343258bba7d12e189081170194e64eb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Td5arMDFnOXLb49O"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">现在我们的巡航速度比老鼠快了 100 倍，达到了 3.3 马赫(图片由<a class="ae ky" href="https://unsplash.com/@nasa" rel="noopener ugc nofollow" target="_blank"> NASA </a>在<a class="ae ky" href="https://unsplash.com/photos/Tquhp9Kqkzk" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure><h1 id="b250" class="nt mw it bd mx nu nv nw na nx ny nz nd jz oa ka ng kc ob kd nj kf oc kg nm od bi translated">结论</h1><p id="5eb5" class="pw-post-body-paragraph kz la it lb b lc no ju le lf np jx lh li nq lk ll lm nr lo lp lq ns ls lt lu im bi translated">这篇文章建立在<a class="ae ky" href="https://mikehuls.medium.com/getting-started-with-cython-how-to-perform-1-7-billion-calculations-per-second-in-python-b83374cfcf77" rel="noopener"> <strong class="lb iu">这篇</strong> </a>的基础上。我希望已经展示了您可以将 Python 编码的简易性与 C 的高效性结合起来，相对容易地改进某些 pandas 操作，并实现令人难以置信的速度提升。关于为什么 Python 函数如此缓慢的更多信息，请查看<a class="ae ky" href="https://mikehuls.medium.com/why-is-python-so-slow-and-how-to-speed-it-up-485b5a84154e" rel="noopener"> <strong class="lb iu">这篇文章</strong> </a>。</p><p id="c867" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望一切都像我希望的那样清楚，但如果不是这样，请让我知道我能做些什么来进一步澄清。同时，看看我的其他关于各种编程相关主题的文章，比如:</p><ul class=""><li id="e293" class="ma mb it lb b lc ld lf lg li mc lm md lq me lu mf mg mh mi bi translated"><a class="ae ky" href="https://mikehuls.medium.com/why-is-python-so-slow-and-how-to-speed-it-up-485b5a84154e" rel="noopener">Python 为什么这么慢，如何加速</a></li><li id="2087" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">【Cython 入门:如何在 Python 中执行&gt;每秒 17 亿次计算</li><li id="9d01" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated"><a class="ae ky" href="https://mikehuls.medium.com/write-your-own-c-extension-to-speed-up-python-x100-626bb9d166e7" rel="noopener">编写自己的 C 扩展来加速 Python x100 </a></li><li id="c5ed" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated"><a class="ae ky" href="https://mikehuls.medium.com/advanced-multi-tasking-in-python-applying-and-benchmarking-threadpools-and-processpools-90452e0f7d40" rel="noopener">Python 中的高级多任务处理:应用线程池和进程池并进行基准测试</a></li><li id="6947" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated"><a class="ae ky" href="https://mikehuls.medium.com/virtual-environments-for-absolute-beginners-what-is-it-and-how-to-create-one-examples-a48da8982d4b" rel="noopener">绝对初学者的虚拟环境——什么是虚拟环境，如何创建虚拟环境(+示例</a>)</li><li id="67e3" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated">创建并发布你自己的 Python 包</li><li id="bfc7" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated"><a class="ae ky" href="https://mikehuls.medium.com/create-your-custom-python-package-that-you-can-pip-install-from-your-git-repository-f90465867893" rel="noopener">创建您的定制私有 Python 包，您可以从您的 Git 库 PIP 安装该包</a></li><li id="a5b2" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated"><a class="ae ky" href="https://mikehuls.medium.com/create-a-fast-auto-documented-maintainable-and-easy-to-use-python-api-in-5-lines-of-code-with-4e574c00f70e" rel="noopener">使用 FastAPI 用 5 行代码创建一个快速自动记录、可维护且易于使用的 Python API</a></li><li id="31f2" class="ma mb it lb b lc mj lf mk li ml lm mm lq mn lu mf mg mh mi bi translated"><a class="ae ky" href="https://mikehuls.medium.com/dramatically-improve-your-database-inserts-with-a-simple-upgrade-6dfa672f1424" rel="noopener">通过简单的升级大大提高您的数据库插入速度</a></li></ul><p id="cbce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><p id="147a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="74d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lz">又及:喜欢我正在做的事吗？</em> <a class="ae ky" href="https://mikehuls.medium.com/membership" rel="noopener"> <em class="lz">跟我来！</em> </a></p></div></div>    
</body>
</html>