<html>
<head>
<title>Useful Big Query Analytic Functions that you Should Learn</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你应该学习的有用的大查询分析函数</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/useful-big-query-analytic-functions-that-you-should-learn-19270e866a37?source=collection_archive---------17-----------------------#2021-07-04">https://towardsdatascience.com/useful-big-query-analytic-functions-that-you-should-learn-19270e866a37?source=collection_archive---------17-----------------------#2021-07-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="88f8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">熟悉它们，对你的数据探索和准备任务会有很大帮助。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c9c331d50cb1e80d9d4a6cbcff8d6d40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G1zM2Grt5wbCcSzx"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">艾萨克·史密斯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="8f0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将提供BigQuery分析函数，我发现这些函数在日常数据探索和准备工作中非常有用。另外，我会分享在使用它们时可能出现的情况，这样你会有更好的理解。</p><p id="e607" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我假设你在阅读这篇文章之前已经熟悉了SQL和BigQuery。如果没有，下面是基于BigQuery文档的概述:</p><blockquote class="ls"><p id="0c29" class="lt lu iq bd lv lw lx ly lz ma mb lr dk translated">BigQuery是一个企业数据仓库，它通过使用Google基础设施的处理能力实现超快速的SQL查询来解决这个问题。</p></blockquote><p id="2d05" class="pw-post-body-paragraph kw kx iq ky b kz mc jr lb lc md ju le lf me lh li lj mf ll lm ln mg lp lq lr ij bi translated">你可以在这里阅读更多:【https://cloud.google.com/bigquery/docs/introduction】T4</p><p id="5e67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本职位面向(不限于):</p><ol class=""><li id="eb1e" class="mh mi iq ky b kz la lc ld lf mj lj mk ln ml lr mm mn mo mp bi translated">完全初学者，希望为您的数据科学之旅添加更多知识和武器。</li><li id="5901" class="mh mi iq ky b kz mq lc mr lf ms lj mt ln mu lr mm mn mo mp bi translated">已经在使用BigQuery，但想提高使用该工具的技能和效率。</li><li id="12e8" class="mh mi iq ky b kz mq lc mr lf ms lj mt ln mu lr mm mn mo mp bi translated">已经知道这个概念，但仍然不能掌握它在现实生活中如何工作的学生/新兵训练营成员。</li></ol><p id="483d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">享受…</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="c41e" class="nc nd iq bd ne nf ng nh ni nj nk nl nm jw nn jx no jz np ka nq kc nr kd ns nt bi translated">什么是大查询分析函数？</h1><p id="add8" class="pw-post-body-paragraph kw kx iq ky b kz nu jr lb lc nv ju le lf nw lh li lj nx ll lm ln ny lp lq lr ij bi translated">基于大查询标准的SQL <a class="ae kv" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/analytic-function-concepts" rel="noopener ugc nofollow" target="_blank">文档</a>:</p><blockquote class="ls"><p id="ae2a" class="lt lu iq bd lv lw lx ly lz ma mb lr dk translated">分析函数计算一组行的值，并为每一个行的<em class="nz">返回一个结果。这不同于聚合函数，聚合函数为一组</em>行的<em class="nz">返回单个结果。</em></p></blockquote><p id="a024" class="pw-post-body-paragraph kw kx iq ky b kz mc jr lb lc md ju le lf me lh li lj mf ll lm ln mg lp lq lr ij bi translated">简而言之，它不需要<strong class="ky ir"> GROUP BY </strong>子句，并且它为每一行返回一个<strong class="ky ir">单值</strong>。分析函数的其他特征是，它们在子句上使用<strong class="ky ir">，并增加了<strong class="ky ir">窗口</strong>的规格和范围。</strong></p><p id="6fd3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我不会在这里讨论细节，你可以在文档中仔细阅读。另一方面，通过使用我将在下一节中提供的示例，您可以看到这些子句是如何工作的。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="96fb" class="nc nd iq bd ne nf ng nh ni nj nk nl nm jw nn jx no jz np ka nq kc nr kd ns nt bi translated">示例和使用案例</h1><p id="adef" class="pw-post-body-paragraph kw kx iq ky b kz nu jr lb lc nv ju le lf nw lh li lj nx ll lm ln ny lp lq lr ij bi translated">请注意，我会过度简化用例，但我希望我仍然可以反映现实生活中的用例。</p><h2 id="8a6d" class="oa nd iq bd ne ob oc dn ni od oe dp nm lf of og no lj oh oi nq ln oj ok ns ol bi translated">1.行号</h2><p id="42c8" class="pw-post-body-paragraph kw kx iq ky b kz nu jr lb lc nv ju le lf nw lh li lj nx ll lm ln ny lp lq lr ij bi translated"><a class="ae kv" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/numbering_functions#row_number" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/standard-SQL/numbering _ functions # row _ number</a></p><p id="8ef4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用例:</strong></p><blockquote class="om on oo"><p id="2410" class="kw kx op ky b kz la jr lb lc ld ju le oq lg lh li or lk ll lm os lo lp lq lr ij bi translated">您有一个包含从主应用程序数据库(MongoDB、MySQL等)中提取的数据的表。提取每天在<strong class="ky ir">的基础上运行</strong>，并将当前值的<strong class="ky ir">每日快照</strong>存储在数据库中，唯一的标识符是<strong class="ky ir">最后更新</strong>字段，它指示最后摄取时间。</p><p id="76ad" class="kw kx op ky b kz la jr lb lc ld ju le oq lg lh li or lk ll lm os lo lp lq lr ij bi translated">您希望获得只包含每个unique_id的最新状态的数据，并将其包含在您的分析中。那么你会怎么做呢？</p></blockquote><p id="e4f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">示例数据:</strong></p><p id="0d50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于这个用例，让我们以BigQuery公共数据<strong class="ky ir"><em class="op">FCC _ political _ ads</em></strong>中的数据为例。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/3ab741debc2c1631181f26c2a86f39a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WoWAgoXCSP3nEIFGROcSvQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">示例数据(图片由作者提供)</p></figure><p id="9749" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，对于每个唯一标识符，我们都有一些<em class="op"> latest_status </em>值。在我们的分析中，我们只对最近的感兴趣。</p><p id="6fed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">解决方案:</strong></p><p id="b134" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过使用分析函数<strong class="ky ir">行号</strong>，我们可以根据它们的<em class="op"> unique_id给每一行一个基于新近度的排名。</em></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/a10415c298c4d3b1f326d02e8bcf75f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bZxoQ8a5L4N4tvTGIf0P8g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将row_number作为辅助对象的示例数据(图片由作者提供)</p></figure><p id="b7a3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，现在您有了这个新的标识符字段，您可以使用它来只过滤包含最近更新的行。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/ad847d987b1a0e1d1b5a9f358ec7391f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qm5FoylHV4i3K5HTz9SFOA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">最终结果(图片由作者提供)</p></figure><h2 id="8a75" class="oa nd iq bd ne ob oc dn ni od oe dp nm lf of og no lj oh oi nq ln oj ok ns ol bi translated">2.滞后和超前</h2><p id="9350" class="pw-post-body-paragraph kw kx iq ky b kz nu jr lb lc nv ju le lf nw lh li lj nx ll lm ln ny lp lq lr ij bi translated"><a class="ae kv" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/navigation_functions#lag" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/standard-SQL/navigation _ functions # lag</a></p><p id="80ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用例:</strong></p><blockquote class="om on oo"><p id="b2f7" class="kw kx op ky b kz la jr lb lc ld ju le oq lg lh li or lk ll lm os lo lp lq lr ij bi translated">你有一个每日跟踪器，跟踪一定数量的事件。你要计算该数字与昨天的数字的<strong class="ky ir">差。你会怎么做？</strong></p></blockquote><p id="39a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">示例数据:</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/1be367e0e17bc01a8fe53a7c133a2e13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bA6GuP10yuyEKvl17wnOrw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">示例数据(图片由作者提供)</p></figure><p id="3016" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">解决方案:</strong></p><p id="4aef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们可以使用<strong class="ky ir"> LAG </strong>函数来创建一个帮助字段<em class="op">prev _ percent _ congestion</em></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/5734e610bed51ef1ce69e308cf422997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ItPuVKcymHlgMeFUMHxt4g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用滞后函数后的结果(图片由作者提供)</p></figure><p id="f5c9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们可以用昨天的数字来计算今天的数字。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/86064081738668b754eaff54467dd036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G3HbvSheLpVBsxzmjXeGZA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用滞后函数后的最终结果(图片由作者提供)</p></figure><p id="c42f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，每个city_name的第一个数据将具有空值，因为一开始就没有以前的数据。</p><p id="eb27" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你也可以使用一个类似的函数，即<strong class="ky ir"> LEAD </strong>函数。它执行与<strong class="ky ir">滞后</strong>功能相反的操作，不是取前一个值，而是取下一个值。</p><h2 id="4c3c" class="oa nd iq bd ne ob oc dn ni od oe dp nm lf of og no lj oh oi nq ln oj ok ns ol bi translated">3.首值和末值</h2><p id="01ad" class="pw-post-body-paragraph kw kx iq ky b kz nu jr lb lc nv ju le lf nw lh li lj nx ll lm ln ny lp lq lr ij bi translated"><a class="ae kv" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/navigation_functions#last_value" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/standard-SQL/navigation _ functions # last _ value</a></p><p id="2398" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用例:</strong></p><blockquote class="om on oo"><p id="8117" class="kw kx op ky b kz la jr lb lc ld ju le oq lg lh li or lk ll lm os lo lp lq lr ij bi translated">我们将使用一个类似的用例，如上面的例子，关于城市中的拥堵，但现在让我们说<strong class="ky ir">拥堵并不是每次都发生</strong>(为了举例)。</p><p id="0c83" class="kw kx op ky b kz la jr lb lc ld ju le oq lg lh li or lk ll lm os lo lp lq lr ij bi translated">与前面的用例类似，我们想计算每个城市的当前拥堵与<strong class="ky ir">上次记录的拥堵<em class="iq"> </em> </strong> <em class="iq">之间的差异。</em></p></blockquote><p id="3fee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">示例数据:</strong></p><p id="e89b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于这个用例，我们将使用与上一个例子相同的数据，但是我将删除一些值来反映我们的用例。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/87649619a82d0d8a71e1bd6d12c8133f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*bjonK8owr_oeX7gMV7ujRA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">包含一些空值的返工数据(图片由作者提供)</p></figure><p id="aed5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">解决方案:</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/cabe1d5601324668f8f7b1e0de609e5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hO9lO_YJP86rRsF9edmCYA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用最后一个值函数后的结果(图片由作者提供)</p></figure><p id="51aa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们可以像在第二个用例中一样执行简单的减法。如果您对获取第一个值感兴趣，您可以只使用<strong class="ky ir">第一个值</strong>函数。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="d761" class="nc nd iq bd ne nf ng nh ni nj nk nl nm jw nn jx no jz np ka nq kc nr kd ns nt bi translated">结束语</h1><p id="2a7f" class="pw-post-body-paragraph kw kx iq ky b kz nu jr lb lc nv ju le lf nw lh li lj nx ll lm ln ny lp lq lr ij bi translated">您已经学习了Bigquery中的一些有用的分析函数，可以应用到您的特定用例中。让自己适应它们需要一些时间，但是一旦你有了足够的实践，你会发现自己在使用查询准备、探索和分析数据方面做得更有效率。</p><p id="57bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，快乐学习！！🚀</p></div></div>    
</body>
</html>