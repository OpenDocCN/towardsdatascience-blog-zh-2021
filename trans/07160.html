<html>
<head>
<title>3 ways to query BigQuery in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python查询BigQuery的3种方法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/3-ways-to-query-bigquery-in-python-66838f45cb43?source=collection_archive---------5-----------------------#2021-06-29">https://towardsdatascience.com/3-ways-to-query-bigquery-in-python-66838f45cb43?source=collection_archive---------5-----------------------#2021-06-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d3c2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki"> SQLAlchemy，用于Google BigQuery的Python客户端，以及bq命令行工具</em></h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/4204548b0c9e26f873869d4307d9423f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_T_5C40AB6ZX0F-Bl1yqOw.jpeg"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@raimondklavins?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">雷蒙·克拉文斯</a>在<a class="ae kz" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="7f58" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">如何查询BigQuery数据？本文讨论了在Python中查询BigQuery数据的3种方法。希望你觉得有用。</p><h1 id="90f8" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">环境</h1><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="f1a1" class="mt lx it mp b gy mu mv l mw mx">conda install notebook google-cloud-bigquery sqlalchemy pybigquery</span></pre><h1 id="bfa4" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">资格证书</h1><p id="fcf0" class="pw-post-body-paragraph la lb it lc b ld my ju lf lg mz jx li lj na ll lm ln nb lp lq lr nc lt lu lv im bi translated">要在本地认证Google Cloud，您需要安装<a class="ae kz" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank"> Google Cloud SDK </a>并通过以下命令行登录/认证。更多信息可在<a class="ae kz" href="https://googleapis.dev/python/google-api-core/latest/auth.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>中找到。</p><pre class="kk kl km kn gt mo mp mq mr aw ms bi"><span id="db2f" class="mt lx it mp b gy mu mv l mw mx">gcloud auth login</span></pre><p id="673f" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">要通过凭证文件进行认证，您可以创建一个服务帐户，并从服务帐户获取凭证:进入google cloud <a class="ae kz" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">服务帐户页面</a>，点击一个项目，点击“+创建服务帐户”，然后它将生成一个凭证JSON文件。在下面的例子中，我将这个凭证文件重命名为“BIGQUERY_CREDENTIAL”。</p><h1 id="26e5" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">BigQuery的SQLAlchemy</h1><p id="c657" class="pw-post-body-paragraph la lb it lc b ld my ju lf lg mz jx li lj na ll lm ln nb lp lq lr nc lt lu lv im bi translated">项目为bigquery实现了一个SQLAlchemy工具。SQLAlchemy是用Python读取SQL数据的强大工具。以下是来自<a class="ae kz" href="https://www.sqlalchemy.org/" rel="noopener ugc nofollow" target="_blank">文档</a>的SQLAlchemy的描述:</p><p id="be4f" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><em class="nd"> SQLAlchemy是Python SQL工具包和对象关系映射器，为应用程序开发人员提供了SQL的全部功能和灵活性</em>。</p><p id="6efe" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">要使用SQLAlchemy，第一步是使用<code class="fe ne nf ng mp b">create_engine()</code>建立连接。在这个函数的参数中，我们定义了我们试图连接到的数据库<code class="fe ne nf ng mp b">"bigquery://"</code>和凭证文件的路径。如果您在本地运行它并在本地进行身份验证，那么您可以在没有凭据信息的情况下运行以下内容。如果输出数据很大，我们可以增加<code class="fe ne nf ng mp b">arraysize</code>，默认为5000。</p><p id="c656" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在我们建立到BigQuery的连接之后，有多种方法可以查询数据。我的方法是使用Pandas的<code class="fe ne nf ng mp b">pd.read_sql</code>,这样我可以直接得到Pandas的数据帧。在<code class="fe ne nf ng mp b">pd.read_sql</code>函数中，我们需要的只是指定的查询和连接。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nh"><img src="../Images/e3da93cc6d81ce2ab59cda704702ff3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dHX-WGef2TDak8BH.png"/></div></div></figure><p id="4d8c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">参数化我们的查询通常是有用的。SQLAlchemy提供了一个内置函数<code class="fe ne nf ng mp b">text()</code>，它接受查询作为输入，并支持<a class="ae kz" href="https://docs.sqlalchemy.org/en/14/core/tutorial.html#specifying-bound-parameter-behaviors" rel="noopener ugc nofollow" target="_blank">参数化</a>。或者，您可以在查询中将参数写成f字符串。</p><h1 id="b562" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">Google BigQuery的Python客户端</h1><p id="bf1f" class="pw-post-body-paragraph la lb it lc b ld my ju lf lg mz jx li lj na ll lm ln nb lp lq lr nc lt lu lv im bi translated">第二种方法是为BigQuery 使用官方的<a class="ae kz" href="https://googleapis.dev/python/bigquery/latest/index.html" rel="noopener ugc nofollow" target="_blank"> Python客户端。如果您在本地运行它并通过认证，那么您不需要定义凭证，并且<code class="fe ne nf ng mp b">client=bigquery.Client()</code>将会正常工作。</a></p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ni"><img src="../Images/26116d7a179b51c9e14976330deb7c3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*36AwK38sppvxXPC9.png"/></div></div></figure><h1 id="f841" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">bq命令行工具</h1><p id="4333" class="pw-post-body-paragraph la lb it lc b ld my ju lf lg mz jx li lj na ll lm ln nb lp lq lr nc lt lu lv im bi translated">第三种方法是使用subprocess运行bq命令行工具。查询命令是<code class="fe ne nf ng mp b">bq query</code>。我们可以向查询传递标志，将输出格式定义为csv，并指定我们想要运行的查询。然后我们可以使用subprocess来运行Python中的命令行代码。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nj"><img src="../Images/6627f26e483f44261b555becd88ad006.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FpggqcdCRcPqP4Pu.png"/></div></div></figure><p id="1dae" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">bq命令行工具支持查询参数。在下面的例子中，我们传入<code class="fe ne nf ng mp b">--parameter</code>标志来定义参数的名称、类型和值信息。在查询本身中，我们使用<code class="fe ne nf ng mp b">@parameter_name</code>来指定一个参数。另一件需要注意的事情是，如果输出的行数太多，我们可以将<code class="fe ne nf ng mp b">--max_rows</code>标志增加到一个较大的数字。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nk"><img src="../Images/c706b512a744c82844ab1460d37b3022.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IYWSojyc3-2HZG83.png"/></div></div></figure><h1 id="6b74" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">摘要</h1><p id="6ebd" class="pw-post-body-paragraph la lb it lc b ld my ju lf lg mz jx li lj na ll lm ln nb lp lq lr nc lt lu lv im bi translated">总之，我快速地通过三种方式在Python中查询BigQuery。</p><p id="053d" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">第一种方法，SQLAlchemy有许多很好的内置功能，并支持许多不同类型的数据库。对于在其他数据库上使用过SQLAlchemy并喜欢其特性的用户，您可能会喜欢使用SQLAlchemy方法来查询BigQuery。</p><p id="f3a5" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">第二种方法是Google BigQuery的官方Python客户端，我个人认为它不太容易使用，文档可能会更好。我没怎么用过，所以我的印象可能是错误的。</p><p id="b06e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">最后，bq命令行工具非常强大。它提供了广泛的功能，而不仅仅是查询数据。我知道很多人有顾虑，不喜欢使用子流程。所以用哪一个真的取决于你的喜好。</p><p id="e856" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">快乐大查询！</p><h1 id="6fa4" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">参考</h1><p id="96c1" class="pw-post-body-paragraph la lb it lc b ld my ju lf lg mz jx li lj na ll lm ln nb lp lq lr nc lt lu lv im bi translated"><a class="ae kz" href="https://googleapis.dev/python/google-api-core/latest/auth.html" rel="noopener ugc nofollow" target="_blank">https://Google APIs . dev/python/Google API-core/latest/auth . html</a><a class="ae kz" href="https://github.com/googleapis/python-bigquery-sqlalchemy" rel="noopener ugc nofollow" target="_blank">【https://github . com/Google APIs/python-bigquery-sqllcemy</a><a class="ae kz" href="https://www.sqlalchemy.org/" rel="noopener ugc nofollow" target="_blank">【https://www . sqllcemy . org/</a><a class="ae kz" href="https://github.com/googleapis/python-bigquery" rel="noopener ugc nofollow" target="_blank">【https://github . com/Google APIs/python-bigquery】</a></p><p id="a730" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">由Sophia Yang于2021年6月28日</p></div></div>    
</body>
</html>