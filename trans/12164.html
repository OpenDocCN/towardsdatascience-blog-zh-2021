<html>
<head>
<title>Pythonic Way to Perform Statistics Across Multiple Variables with Xarray</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Xarray跨多个变量执行统计的Pythonic方式</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pythonic-way-to-perform-statistics-across-multiple-variables-with-xarray-d0221c78e34a?source=collection_archive---------25-----------------------#2021-12-08">https://towardsdatascience.com/pythonic-way-to-perform-statistics-across-multiple-variables-with-xarray-d0221c78e34a?source=collection_archive---------25-----------------------#2021-12-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="69e7" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">气候数据科学</h2><div class=""/><div class=""><h2 id="f325" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">首先在数据集中创建一个分类维度</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/ec0e80b857eec63d753bade383cb2262.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jK1m74os-JSjFlRV"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">pawel szvmanski 在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="cc44" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">考虑到这一点，您有一个存储在数据集(<code class="fe me mf mg mh b">ds</code>)中的模型集合，每个集合成员存储为一个不同的变量。你觉得总体平均水平如何？如果你有三个成员(<code class="fe me mf mg mh b">ens1</code>、<code class="fe me mf mg mh b">ens2</code>、<code class="fe me mf mg mh b">ens3</code>)，一种方法是这样做:</p><pre class="ks kt ku kv gt mi mh mj mk aw ml bi"><span id="65d2" class="mm mn it mh b gy mo mp l mq mr">ens_mean = (ds['ens1'] + ds['ens2'] + ds['ens3']) / 3</span></pre><p id="0106" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">虽然这对于小型合奏来说没什么问题，但是有一种更Pythonic化的方法可以做到这一点。让我们假设每个成员代表地球上每个位置的月温度，我们真正想要的是这样的代码:</p><pre class="ks kt ku kv gt mi mh mj mk aw ml bi"><span id="ee94" class="mm mn it mh b gy mo mp l mq mr">ens_mean = ds['temperature'].mean('ensemble')</span></pre><p id="81f0" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这是干净的，需要键入的字符更少，代码要完成的任务也很清楚。</p><p id="307f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在这篇文章中，我将演示如何操作一个<code class="fe me mf mg mh b">Xarray</code>数据集，这样你就可以对一个新的分类变量进行平均。我希望任何使用<code class="fe me mf mg mh b">Xarray</code>分析地理空间数据或集合模型的人都能在这篇文章中找到相关性。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="dd54" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated">1.创建一个示例数据集</h1><p id="4e00" class="pw-post-body-paragraph li lj it lk b ll nq kd ln lo nr kg lq lr ns lt lu lv nt lx ly lz nu mb mc md im bi translated">如果你想继续，我将使用一个包含合成数据的数据集来解释这个概念。这个数据集的代码如下。让我们假设这个数据集以1度的空间分辨率表示来自不同模型的月温度输出。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="a76f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">数据集的<code class="fe me mf mg mh b">info()</code>如下所示。请注意，每个系综成员(<code class="fe me mf mg mh b">ens1</code>、<code class="fe me mf mg mh b">ens2</code>、<code class="fe me mf mg mh b">ens3</code>)都是不同的变量。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi nx"><img src="../Images/93b93edd9b8c995c36e291ddf1b59aa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YAJ_j6qYaGb23IMqG8y6Lw@2x.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">将集合成员显示为不同变量的数据集输出。(图片由作者提供)</p></figure></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="3dc3" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated">2.将变量合并到一个新维度</h1><p id="df79" class="pw-post-body-paragraph li lj it lk b ll nq kd ln lo nr kg lq lr ns lt lu lv nt lx ly lz nu mb mc md im bi translated">现在我们有了一个示例数据集，让我们将所有成员合并到一个名为<code class="fe me mf mg mh b">temperature</code>的变量中，该变量具有维度(<code class="fe me mf mg mh b">ensemble</code>、<code class="fe me mf mg mh b">time</code>、<code class="fe me mf mg mh b"> lat</code>、<code class="fe me mf mg mh b">lon</code>)，其中新的<code class="fe me mf mg mh b">ensemble</code>坐标将提供对每个成员的访问。下面的代码完成了这项任务。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="b261" class="mm mn it bd na ny nz dn ne oa ob dp ni lr oc od nk lv oe of nm lz og oh no iz bi translated">2.1每行的含义</h2><p id="9a3c" class="pw-post-body-paragraph li lj it lk b ll nq kd ln lo nr kg lq lr ns lt lu lv nt lx ly lz nu mb mc md im bi translated">这里发生了很多事情，让我们一行一行地来看一下。</p><ul class=""><li id="07f6" class="oi oj it lk b ll lm lo lp lr ok lv ol lz om md on oo op oq bi translated"><code class="fe me mf mg mh b">variables = list(ds)</code> →这将创建数据集中所有变量名的列表。如果您不需要所有的变量，那么您可以简单地硬编码一个变量名列表。</li></ul><p id="8a61" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">第二行做了三件事:</p><ol class=""><li id="531e" class="oi oj it lk b ll lm lo lp lr ok lv ol lz om md or oo op oq bi translated"><code class="fe me mf mg mh b">expand_dims(‘ensemble’, axis=0)</code> →获取每个变量，并在第一个轴位置添加一个新尺寸。</li><li id="ad05" class="oi oj it lk b ll os lo ot lr ou lv ov lz ow md or oo op oq bi translated"><code class="fe me mf mg mh b">assign_coords(ensemble=[var])</code> →创建一个与上一步中的新尺寸同名的新坐标。这也将变量名分配给坐标</li><li id="93ac" class="oi oj it lk b ll os lo ot lr ou lv ov lz ow md or oo op oq bi translated"><code class="fe me mf mg mh b">rename("temperature")</code> →将变量重命名为<code class="fe me mf mg mh b">temperature</code></li></ol><p id="2895" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">注意，这是通过列表理解对每个变量进行的。如果这令人困惑，我鼓励你在单个变量上运行这个程序，看看对象在每一步之后是如何变化的。下面的代码可以对此有所帮助。</p><pre class="ks kt ku kv gt mi mh mj mk aw ml bi"><span id="c045" class="mm mn it mh b gy mo mp l mq mr">var = 'ens1'<br/>expand = ds[var].expand_dims('ensemble',axis=0)<br/>assign = expand.assign_coords(ensemble=[var])<br/>rename = assign.rename('temperature')</span></pre><p id="cb9c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然后，您可以输出<code class="fe me mf mg mh b">expand</code>、<code class="fe me mf mg mh b">assign</code>和<code class="fe me mf mg mh b">rename</code>来查看对象在每一步之后如何变化。</p><p id="ef3f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">一旦我们有了一个数据数组列表，我们需要使用<code class="fe me mf mg mh b">xr.merge()</code>沿着集合维度将它们缝合在一起。</p><ul class=""><li id="2810" class="oi oj it lk b ll lm lo lp lr ok lv ol lz om md on oo op oq bi translated"><code class="fe me mf mg mh b">xr.merge(da_list)</code> →这将所有数据阵列合并成一个数据集。新的数据集只有一个变量(<code class="fe me mf mg mh b">temperature</code>)，所有的数据数组沿着<code class="fe me mf mg mh b">ensemble</code>坐标合并</li></ul><p id="224d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">最后两行可能没有必要。这些行保留了<code class="fe me mf mg mh b">ds</code>中的全局属性。</p><pre class="ks kt ku kv gt mi mh mj mk aw ml bi"><span id="8c0e" class="mm mn it mh b gy mo mp l mq mr">global_attrs = ds.attrs<br/>ds_merged.attrs = global_attrs</span></pre><p id="695a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">最终数据集将如下所示:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ox"><img src="../Images/8f2e5d183f70a367bd8f033f578c21b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CCDhyH6DVTx0btZJn_oJYQ@2x.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">包含一个变量(温度)和存储在新坐标(集合)中的每个集合成员的合并数据集输出。(图片由作者提供)</p></figure><h2 id="610f" class="mm mn it bd na ny nz dn ne oa ob dp ni lr oc od nk lv oe of nm lz og oh no iz bi translated">2.2合并变量的另一种方法</h2><p id="8d53" class="pw-post-body-paragraph li lj it lk b ll nq kd ln lo nr kg lq lr ns lt lu lv nt lx ly lz nu mb mc md im bi translated">有多种方法可以将变量合并到一个新的维度上。这是另一种方法。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="f6c5" class="mm mn it bd na ny nz dn ne oa ob dp ni lr oc od nk lv oe of nm lz og oh no iz bi translated">2.3使用我们的合并数据集</h2><p id="6f62" class="pw-post-body-paragraph li lj it lk b ll nq kd ln lo nr kg lq lr ns lt lu lv nt lx ly lz nu mb mc md im bi translated">现在我们有了合并的数据集，我们可以很容易地跨集合成员进行统计。</p><ul class=""><li id="427e" class="oi oj it lk b ll lm lo lp lr ok lv ol lz om md on oo op oq bi translated"><code class="fe me mf mg mh b">ds_merged[‘temperature’].mean(‘ensemble’)</code></li><li id="6726" class="oi oj it lk b ll os lo ot lr ou lv ov lz ow md on oo op oq bi translated"><code class="fe me mf mg mh b">ds_merged[‘temperature’].var(‘ensemble’)</code></li></ul><p id="036b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果我们只想绘制<code class="fe me mf mg mh b">ens1</code>，我们可以像这样选择它</p><pre class="ks kt ku kv gt mi mh mj mk aw ml bi"><span id="dd20" class="mm mn it mh b gy mo mp l mq mr">ds_merged.sel(ensemble='ens1')</span></pre><p id="aa29" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">虽然访问单个集合成员稍微麻烦一些，但我认为能够在整个集合中执行统计的好处更重要。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="3ccd" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated">3.概括代码</h1><p id="19d1" class="pw-post-body-paragraph li lj it lk b ll nq kd ln lo nr kg lq lr ns lt lu lv nt lx ly lz nu mb mc md im bi translated">在这一节中，我将描述两种方法来推广这种技术。我给出的代码仅仅是为了给你一些如何扩展这篇文章的想法。</p><h2 id="d189" class="mm mn it bd na ny nz dn ne oa ob dp ni lr oc od nk lv oe of nm lz og oh no iz bi translated">3.1选项1-使用管道()</h2><p id="b472" class="pw-post-body-paragraph li lj it lk b ll nq kd ln lo nr kg lq lr ns lt lu lv nt lx ly lz nu mb mc md im bi translated">第一种方法是将函数<code class="fe me mf mg mh b"><a class="ae lh" href="https://xarray.pydata.org/en/stable/generated/xarray.Dataset.pipe.html" rel="noopener ugc nofollow" target="_blank">pipe()</a></code>到数据集。这更适合于将多个功能链接在一起。但是，根据具体情况，您可能想要<code class="fe me mf mg mh b">pipe()</code>单一功能。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="5fed" class="mm mn it bd na ny nz dn ne oa ob dp ni lr oc od nk lv oe of nm lz og oh no iz bi translated">3.2选项2-注册访问者</h2><p id="250d" class="pw-post-body-paragraph li lj it lk b ll nq kd ln lo nr kg lq lr ns lt lu lv nt lx ly lz nu mb mc md im bi translated">另一种选择是<a class="ae lh" href="https://xarray.pydata.org/en/stable/internals/extending-xarray.html" rel="noopener ugc nofollow" target="_blank">通过<a class="ae lh" href="https://xarray.pydata.org/en/stable/generated/xarray.register_dataset_accessor.html" rel="noopener ugc nofollow" target="_blank">注册一个访问器</a>来扩展Xarray </a>。实际上，这是通过简单地添加一个类装饰器来实现的。如果您正在处理一组特殊用途的函数，这种方法是合适的。例如，也许你正在研究一类处理集合模型的方法。下面的代码展示了如何装饰一个具有<code class="fe me mf mg mh b">var_merger()</code>函数的类。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="5b35" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">请记住，一旦注册了访问者，就不能对其进行更改。例如，如果您在笔记本中运行这段代码，然后决定向该类添加另一个函数并重新运行它，则该新函数将不会向访问器注册。您必须首先重启内核才能使它生效。因此，注册访问器放在代码库中更合适。</p><p id="c677" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您可以在数据集(<code class="fe me mf mg mh b">ds</code>)上使用新的访问器，如下所示:</p><pre class="ks kt ku kv gt mi mh mj mk aw ml bi"><span id="7fed" class="mm mn it mh b gy mo mp l mq mr">ds_merged = ds.ensemble.var_merger()</span></pre><p id="0f89" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">注意，类名是不相关的，因为它是我们提供给数据集的访问器名。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="96b4" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated">4.最后的想法</h1><p id="01f5" class="pw-post-body-paragraph li lj it lk b ll nq kd ln lo nr kg lq lr ns lt lu lv nt lx ly lz nu mb mc md im bi translated">希望本教程能帮助你更有效地使用合奏。在撰写本文时，我无法在<a class="ae lh" href="https://xarray.pydata.org/en/stable/index.html" rel="noopener ugc nofollow" target="_blank">文档</a>以及它们的“<a class="ae lh" href="https://xarray.pydata.org/en/stable/howdoi.html" rel="noopener ugc nofollow" target="_blank">How I…</a>”部分中找到像这样合并变量的单行方法。</p><p id="474d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><code class="fe me mf mg mh b">Xarray</code>功能极其强大，许多“我该怎么做”的问题都可以用现有的功能来解决。话虽如此，找到正确的功能并以正确的方式将它们链接在一起以实现期望的目标可能会很棘手。</p><p id="7975" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果你对如何改进这篇文章有任何意见或建议，请告诉我。此外，请让我知道，如果你知道一个更优雅的解决方案，将变量合并到一个共同的坐标。</p><p id="c558" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">一如既往，我很乐意帮助解决您可能遇到的任何问题。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><p id="3574" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><em class="oy">感谢阅读和支持媒体作者</em></p><div class="oz pa gp gr pb pc"><a href="https://lukegloege.medium.com/membership" rel="noopener follow" target="_blank"><div class="pd ab fo"><div class="pe ab pf cl cj pg"><h2 class="bd jd gy z fp ph fr fs pi fu fw jc bi translated">通过我的推荐链接加入Medium-Luke Gloege博士</h2><div class="pj l"><h3 class="bd b gy z fp ph fr fs pi fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pk l"><p class="bd b dl z fp ph fr fs pi fu fw dk translated">lukegloege.medium.com</p></div></div><div class="pl l"><div class="pm l pn po pp pl pq lb pc"/></div></div></a></div></div></div>    
</body>
</html>