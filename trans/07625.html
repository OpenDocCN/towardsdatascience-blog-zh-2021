<html>
<head>
<title>Debug Models And Explain Predictions Using Eli5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Eli5调试模型并解释预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/debug-models-and-explain-predictions-using-eli5-9f856ae74d16?source=collection_archive---------34-----------------------#2021-07-12">https://towardsdatascience.com/debug-models-and-explain-predictions-using-eli5-9f856ae74d16?source=collection_archive---------34-----------------------#2021-07-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="56e1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一种简单而有创意的ML调试方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/da04f03dc0645fd30cf143af274fca85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gzxM3LBQelDUyDK8.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="5d74" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用机器学习模型的一个重要步骤是调试。例如，当我们处理文本时，我们必须检查我们的特征中是否有任何影响预测的噪声，如不需要的符号或数字。我们必须知道什么是预测的原因，并以某种方式解释模型的输出。过去，我们谈论过<a class="ae lu" href="https://predictivehacks.com/feature-importance-in-python/" rel="noopener ugc nofollow" target="_blank">功能重要性</a>，它也可以帮助我们调试机器学习模型，但现在有一种更简单、更实用的方法来做到这一点。</p><p id="1e2a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lu" href="https://eli5.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> Eli5 </a>是一个可以帮助我们调试ML模型并以创造性的方式解释其输出的库。我们将向您展示一些使用它解决简单分类问题、文本分类问题和使用Keras解决图像分类问题的示例。</p><h1 id="9274" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">装置</h1><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="3953" class="ms lw it mo b gy mt mu l mv mw">pip install eli5</span></pre><h1 id="32ba" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Eli5解释虹膜预测</h1><p id="cf7f" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh mz lj lk ll na ln lo lp nb lr ls lt im bi translated">对于这个简单的模型，我们将使用虹膜数据集来预测虹膜的类型(Setosa、Versicolour和Virginica)。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="9d79" class="ms lw it mo b gy mt mu l mv mw">from sklearn import datasets<br/>from sklearn.linear_model import LogisticRegression<br/>import pandas as pd<br/> <br/>import eli5<br/> <br/>iris = datasets.load_iris()<br/>features=pd.DataFrame(iris['data'])<br/>target=iris['target']<br/>model=LogisticRegression(max_iter=1000)<br/>model.fit(features,target)</span></pre><p id="6ceb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们有了一个训练好的模型，我们可以使用Eli5来获得特征重要性，并通过向我们显示什么特征负责模型的输出来解释预测。</p><p id="9b16" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，让我们得到每个类的特性重要性。换句话说，模型的权重。</p><p id="00fa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nc nd ne mo b">eli5.explain_weights(model)</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/43c4912da746df05546059623bed1ce0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9rfKfBZTRw9ObGnD.jpg"/></div></div></figure><p id="a7a1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用机器学习模型的一个重要步骤是调试。例如，当我们处理文本时，我们必须检查我们的特征中是否有任何影响预测的噪声，如不需要的符号或数字。我们必须知道什么是预测的原因，并以某种方式解释模型的输出。在过去，我们谈到了<a class="ae lu" href="https://predictivehacks.com/feature-importance-in-python/" rel="noopener ugc nofollow" target="_blank">功能重要性</a>，它也可以帮助我们调试机器学习模型，但现在有一种更简单、更实用的方法来做到这一点。</p><p id="9b0a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lu" href="https://eli5.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> Eli5 </a>是一个库，可以帮助我们调试ML模型，并以创造性的方式解释它们的输出。我们将向您展示一些使用它解决简单分类问题、文本分类问题和使用Keras解决图像分类问题的示例。</p><h1 id="4dd6" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">装置</h1><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="0f46" class="ms lw it mo b gy mt mu l mv mw">pip install eli5</span></pre><h1 id="f3cc" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Eli5解释虹膜预测</h1><p id="700b" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh mz lj lk ll na ln lo lp nb lr ls lt im bi translated">对于这个简单的模型，我们将使用虹膜数据集来预测虹膜的类型(Setosa、Versicolour和Virginica)。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="8caf" class="ms lw it mo b gy mt mu l mv mw">from sklearn import datasets<br/>from sklearn.linear_model import LogisticRegression<br/>import pandas as pd<br/> <br/>import eli5<br/> <br/>iris = datasets.load_iris()<br/>features=pd.DataFrame(iris['data'])<br/>target=iris['target']<br/>model=LogisticRegression(max_iter=1000)<br/>model.fit(features,target)</span></pre><p id="8c95" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们有了一个训练好的模型，我们可以使用Eli5来获得特征重要性，并通过向我们显示什么特征负责模型的输出来解释预测。</p><p id="38c5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，让我们得到每个类的特性重要性。换句话说，模型的权重。</p><p id="6509" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nc nd ne mo b">eli5.explain_weights(model)</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/5e6567c77b8a52e53a41e2c3f709e367.png" data-original-src="https://miro.medium.com/v2/resize:fit:810/format:webp/0*76mYG26cUt8iEhgD.png"/></div></figure><p id="2754" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以通过输入模型和一个测试输入来解释输出。</p><p id="c7a4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nc nd ne mo b">eli5.explain_prediction(model, features.head(1))</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/8a752c3e53583053d946814dcf9d5e2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SYX4dpEBuyyhXg0C.png"/></div></div></figure><p id="47b8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这个预测中，0类的概率最高。此外，我们可以看到每个特征和偏差的贡献。</p><h1 id="b0fb" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Eli5解释文本分类</h1><p id="c8fc" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh mz lj lk ll na ln lo lp nb lr ls lt im bi translated">我们将使用一些正面和负面的推文样本，我们将训练一个逻辑回归分类器来预测一条<a class="ae lu" href="https://predictivehacks.com/topic-modelling-with-nmf-in-python/" rel="noopener ugc nofollow" target="_blank">推文是正面还是负面。</a></p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="8d04" class="ms lw it mo b gy mt mu l mv mw">import numpy as np<br/>import nltk   # Python library for NLP<br/>from nltk.corpus import twitter_samples    # sample Twitter dataset from NLTK<br/>from collections import Counter<br/>import eli5<br/> <br/>nltk.download('twitter_samples')<br/>  <br/># select the set of positive and negative tweets<br/>all_positive_tweets = twitter_samples.strings('positive_tweets.json')<br/>all_negative_tweets = twitter_samples.strings('negative_tweets.json')<br/> <br/>pos=pd.DataFrame({"tweet":all_positive_tweets,'positive':[1]*len(all_positive_tweets)})<br/>neg=pd.DataFrame({"tweet":all_negative_tweets,'positive':[0]*len(all_negative_tweets)})<br/> <br/>data=pd.concat([pos,neg])<br/> <br/>from sklearn.feature_extraction.text import TfidfVectorizer<br/> <br/> <br/># use tfidf by removing tokens that don't appear in at least 5 documents<br/>vect = TfidfVectorizer(min_df=5,ngram_range=(1, 3), stop_words='english')<br/>  <br/># Fit and transform<br/>X = vect.fit_transform(data.tweet)<br/> <br/>from sklearn.linear_model import LogisticRegression<br/> <br/>model=LogisticRegression()<br/> <br/>model.fit(X,data['positive'])</span></pre><p id="07cd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先让我们得到重量。在这种情况下，我们还需要设置我们使用的矢量器。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="df99" class="ms lw it mo b gy mt mu l mv mw">eli5.show_weights(model, vec=vect)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/f6068ae45327e62edce3835956996fb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:338/format:webp/0*7vHtYAa3R97GvnrC.png"/></div></figure><p id="96b0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来是有趣的部分。让我们得到一个输入句子中每个单词的贡献。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="c217" class="ms lw it mo b gy mt mu l mv mw">test="I'm glad this is not a sad tweet"<br/> <br/>eli5.explain_prediction(model, test, vec=vect)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/470842124504735947111ba2c3f16db8.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/format:webp/0*CTV47GYUEZ5Ufyf9.png"/></div></figure><p id="5682" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">很有用，对吧？通过在句子中突出每个特征，它给了我们每个特征的贡献。</p><h1 id="bc89" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Eli5解释Keras图像模型</h1><p id="5eeb" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh mz lj lk ll na ln lo lp nb lr ls lt im bi translated">Eli5非常强大，可以与<a class="ae lu" href="https://predictivehacks.com/object-detection-with-pre-trained-models-in-keras/" rel="noopener ugc nofollow" target="_blank"> Keras图像分类模型</a>一起工作。我们将使用一个预先训练的模型来获取下面的图片标签，这是我的桌子。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/62a67b08d32825060830e1a806dcb2af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Vll8Lo_WJxinrWE8.jpeg"/></div></div></figure><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="c78d" class="ms lw it mo b gy mt mu l mv mw">from keras.applications.xception import Xception<br/>from keras.preprocessing import image<br/>from keras.applications.xception import preprocess_input, decode_predictions<br/>import numpy as np<br/>import tensorflow as tf<br/> <br/>tf.compat.v1.disable_eager_execution()<br/>import PIL<br/>from PIL import Image<br/>import requests<br/>from io import BytesIO<br/>  <br/># load the model<br/>model = Xception(weights='imagenet', include_top=True)<br/>  <br/>     <br/>     <br/>     <br/># chose the URL image that you want<br/>URL = "<a class="ae lu" href="https://instagram.fath3-3.fna.fbcdn.net/v/t51.2885-15/e35/p1080x1080/120296207_346512619886025_2547830156221124067_n.jpg?_nc_ht=instagram.fath3-3.fna.fbcdn.net&amp;amp;_nc_cat=109&amp;amp;_nc_ohc=eivBrVMAy4oAX8SvZlu&amp;amp;edm=AGenrX8BAAAA&amp;amp;ccb=7-4&amp;amp;oh=9408a18468253ee1cf96dd93e98f132b&amp;amp;oe=60F341EE&amp;amp;_nc_sid=5eceaa" rel="noopener ugc nofollow" target="_blank">https://instagram.fath3-3.fna.fbcdn.net/v/t51.2885-15/e35/p1080x1080/120296207_346512619886025_2547830156221124067_n.jpg?_nc_ht=instagram.fath3-3.fna.fbcdn.net&amp;amp;_nc_cat=109&amp;amp;_nc_ohc=eivBrVMAy4oAX8SvZlu&amp;amp;edm=AGenrX8BAAAA&amp;amp;ccb=7-4&amp;amp;oh=9408a18468253ee1cf96dd93e98f132b&amp;amp;oe=60F341EE&amp;amp;_nc_sid=5eceaa</a>"<br/># get the image<br/>response = requests.get(URL)<br/>img = Image.open(BytesIO(response.content))<br/># resize the image according to each model (see documentation of each model)<br/>img = img.resize((299,299))<br/>  <br/># convert to numpy array<br/>x = image.img_to_array(img)<br/>x = np.expand_dims(x, axis=0)<br/>x = preprocess_input(x)</span></pre><p id="4a2c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们有了处理后的图像(x)和Keras模型，让我们检查模型预测的前20个标签。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="5ead" class="ms lw it mo b gy mt mu l mv mw">features = model.predict(x)<br/>  <br/># return the top 20 detected objects<br/>label = decode_predictions(features, top=20)<br/>label</span><span id="d2db" class="ms lw it mo b gy nk mu l mv mw">[[('n03179701', 'desk', 0.296059),<br/>  ('n03337140', 'file', 0.12352474),<br/>  ('n04590129', 'window_shade', 0.078198865),<br/>  ('n03180011', 'desktop_computer', 0.06828544),<br/>  ('n04239074', 'sliding_door', 0.02761029),<br/>  ('n03782006', 'monitor', 0.022889987),<br/>  ('n02791124', 'barber_chair', 0.018023033),<br/>  ('n02791270', 'barbershop', 0.013427197),<br/>  ('n04344873', 'studio_couch', 0.011167441),<br/>  ('n03201208', 'dining_table', 0.009128182)]]</span></pre><p id="c520" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们可以检查图像的哪个部分负责每个标签。我们还需要标签的类id，可以通过以下方式获得。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="1e22" class="ms lw it mo b gy mt mu l mv mw">np.argsort(features)[0, ::-1][:10]</span><span id="632a" class="ms lw it mo b gy nk mu l mv mw">array([526, 553, 905, 527, 799, 664, 423, 424, 831, 532])</span></pre><p id="7274" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们检查一下id为526的标签台。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="8968" class="ms lw it mo b gy mt mu l mv mw">eli5.show_prediction(model, x, targets=[905])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/4be445e2fdd777a065e57c0f0b8009c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/format:webp/0*dFMrnaYCLIdgx_LN.png"/></div></figure><p id="0265" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如您所见，标签书桌图像最重要的部分是实际书桌的位置。</p><p id="639c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这次我们来查一个理发店这样奇怪的标签。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="4c96" class="ms lw it mo b gy mt mu l mv mw">eli5.show_prediction(model, x, targets=[424])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/3176383b66b3869fa1988d60a1c2e0cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/format:webp/0*RMGd0BBY8UlcoiJY.png"/></div></figure><p id="d2bc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">啊哈！现在我们知道我的办公椅就像理发椅。这就是模型预测理发店标签的原因。</p><h1 id="a4e0" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">总结一下</h1><p id="fd16" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh mz lj lk ll na ln lo lp nb lr ls lt im bi translated">Eli5是一个非常有用的库，可以帮助我们调试分类器并解释它们的预测。它可以处理大多数python ML库，也可以处理更复杂的模型，比如Keras，或者使用文本和矢量器。</p><p id="f074" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="nm">最初发表于</em><a class="ae lu" href="https://predictivehacks.com/debug-models-and-explain-predictions-using-eli5/" rel="noopener ugc nofollow" target="_blank">https://predictivehacks.com。</a></p></div></div>    
</body>
</html>