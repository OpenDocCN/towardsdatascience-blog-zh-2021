<html>
<head>
<title>Hyperparameter Optimization with Grid.ai and No Code Change</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Grid.ai进行超参数优化，无需更改代码</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/hyperparameter-optimization-with-grid-ai-and-no-code-change-b89218d4ff49?source=collection_archive---------28-----------------------#2021-09-13">https://towardsdatascience.com/hyperparameter-optimization-with-grid-ai-and-no-code-change-b89218d4ff49?source=collection_archive---------28-----------------------#2021-09-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/d34d09bb5c3adbfe925a709aecceb638.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EkG5hMevPKZZbeoaAACR2A.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">图片由<a class="ae jd" href="https://www.pexels.com/@mikhail-nilov?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">米哈伊尔·尼洛夫</a>从<a class="ae jd" href="https://www.pexels.com/photo/people-night-dark-laptop-6963944/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">派克斯</a>拍摄</p></figure><div class=""/><div class=""><h2 id="05a2" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">这篇文章介绍了使用Grid.ai平台的超参数扫描搜索，允许在多个spot实例上并行化和实时性能观察。</h2></div><p id="0c5e" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在<a class="ae jd" rel="noopener" target="_blank" href="/converting-kaggle-training-notebooks-to-sharable-code-1cc59fec2414">之前的一篇文章</a>中，我们展示了如何将科学笔记本转换成一个标准的python包，以供分享。然后，我们演示了如何通过命令行界面(CLI)将普通python脚本转换为训练脚本，从而实现更快的超参数交互。</p><div class="ip iq gp gr ir lr"><a rel="noopener follow" target="_blank" href="/converting-kaggle-training-notebooks-to-sharable-code-1cc59fec2414"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd jh gy z fp lw fr fs lx fu fw jf bi translated">将Kaggle培训笔记本转换为可共享代码</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">这篇文章展示了如何轻松地将笔记本转换成标准的Python包，并包含了一个简单的命令行…</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">towardsdatascience.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf ix lr"/></div></div></a></div></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="a8d8" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">配置好CLI后，我们现在可以将不同的超参数(如学习率或模型架构)传递给我们的模型，而无需更改任何代码……但我们如何识别这些参数值的哪些组合会产生性能最佳的模型呢？</p><h1 id="04f3" class="mn mo jg bd mp mq mr ms mt mu mv mw mx km my kn mz kp na kq nb ks nc kt nd ne bi translated">使用Grid.ai进行超参数优化</h1><p id="69f4" class="pw-post-body-paragraph kv kw jg kx b ky nf kh la lb ng kk ld le nh lg lh li ni lk ll lm nj lo lp lq ij bi translated">如何选择最优的超参数集是机器学习中最常见的问题之一。许多Kaggle大师声称，正确的参数值集是在排行榜上排名的模型和不相关的模型之间的差异。具有重要参数的简单模型可以从基本超参数优化中获得5–15%的性能提升。</p><p id="016d" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">另一方面，对于大多数初学者来说，执行参数调整可能是一项费时费力的任务。一种常见但简单的超参数调整方法是顺序运行多个实验，并将配置值和结果写入Excel表格。</p><p id="9eb2" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">更高级的Kagglers可以使用简单的并行化超参数搜索，并使用<a class="ae jd" href="https://mlflow.org/" rel="noopener ugc nofollow" target="_blank"> MLFlow </a>、<a class="ae jd" href="https://wandb.ai/site" rel="noopener ugc nofollow" target="_blank">权重&amp;偏差、</a> <a class="ae jd" href="https://neptune.ai/" rel="noopener ugc nofollow" target="_blank"> Neptune.ai </a>等跟踪结果。然而，如果您采用这种方法，您需要在一台具有多个GPU的强大机器上进行训练，或者用几台机器创建和编排您的云。</p><blockquote class="nk nl nm"><p id="2f65" class="kv kw nn kx b ky kz kh la lb lc kk ld no lf lg lh np lj lk ll nq ln lo lp lq ij bi translated">注意如果你有自己强大的机器，还有几个其他的超参数搜索选项，比如<a class="ae jd" rel="noopener" target="_blank" href="/why-is-everyone-at-kaggle-obsessed-with-optuna-for-hyperparameter-tuning-7608fdca337c"> Optuna </a>、<a class="ae jd" href="https://docs.ray.io/en/latest/tune" rel="noopener ugc nofollow" target="_blank"> Ray tune </a>、<a class="ae jd" href="https://medium.com/pytorch/accelerate-your-hyperparameter-optimization-with-pytorchs-ecosystem-tools-bc17001b9a49" rel="noopener">等。</a></p><p id="30fc" class="kv kw nn kx b ky kz kh la lb lc kk ld no lf lg lh np lj lk ll nq ln lo lp lq ij bi translated">完全公开——我目前在Grid.ai <br/>担任高级研究工程师。注意，您也可以使用其他替代方案来利用这些最佳实践，如Kaggle内核或Colab，但Grid.ai是我的首选平台，因为它使我能够使用云轻松地扩展培训我的模型。</p></blockquote><p id="f36b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">幸运的是，<a class="ae jd" href="https://docs.grid.ai/products/run-run-and-sweep-github-files" rel="noopener ugc nofollow" target="_blank"> Grid Runs </a>支持对我们的代码进行快速超参数调优，而无需担心编排复杂的基础设施或向我们的代码添加外部库。网格运行自动收集日志和管理并行实验…不需要对我们的代码做任何更改！</p><h2 id="34e0" class="nr mo jg bd mp ns nt dn mt nu nv dp mx le nw nx mz li ny nz nb lm oa ob nd oc bi translated">创建数据存储</h2><p id="37b7" class="pw-post-body-paragraph kv kw jg kx b ky nf kh la lb ng kk ld le nh lg lh li ni lk ll lm nj lo lp lq ij bi translated">在大多数大型项目中，共享数据是快速实验的一个重要瓶颈，因为它需要安全的并行计算资源来访问。幸运的是，网格数据存储经过了优化，允许您的模型以最高速度进行训练，而无需承担技术债务或需要处理优化云存储的复杂性。此外，网格数据存储具有集成的数据集版本，可确保我们的超参数实验具有可比性和可再现性的机器学习！</p><p id="486b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae jd" rel="noopener" target="_blank" href="/intuitive-kaggle-task-exploration-and-model-baselining-e5f641943d08">之前，我们在网格交互会话</a>中预处理/缩减了数据集。现在，我们将把这个数据集上传到新创建的数据存储区。从会话上传数据可确保更快的上传速度。稍后，我们将通过网格运行来访问该数据存储，以运行超参数搜索，从而从我们的模型中获得最佳性能。</p><pre class="od oe of og gt oh oi oj ok aw ol bi"><span id="cca1" class="nr mo jg oi b gy om on l oo op">grid datastore create \<br/>    --name kaggle_plant-pathology \<br/>    --source plant-pathology</span></pre><p id="470a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有关数据存储的更多详细信息，请参见<a class="ae jd" href="https://docs.grid.ai/products/add-data-to-grid-datastores" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><figure class="od oe of og gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oq"><img src="../Images/fa843929da8ad7061aa786111c9dc22d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HUDh5gbwBz8TdW-MSNQYbw.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">创建/上传网格数据存储。</p></figure><p id="4d99" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">创建完成后，我们可以从web UI中快速检查所有数据存储库的一些基本信息，如大小或上次更新。</p><figure class="od oe of og gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/404da6f6ed3cb359d329eb9b32985576.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mUZXlcs9prEAM0bHeE6Qeg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">在UI中查看创建的数据存储。</p></figure><h2 id="4933" class="nr mo jg bd mp ns nt dn mt nu nv dp mx le nw nx mz li ny nz nb lm oa ob nd oc bi translated">超参数微调</h2><p id="167f" class="pw-post-body-paragraph kv kw jg kx b ky nf kh la lb ng kk ld le nh lg lh li ni lk ll lm nj lo lp lq ij bi translated">现在，我们可以从上次<a class="ae jd" href="https://github.com/Borda/kaggle_plant-pathology/blob/a642861e8d4d896c15b10c5dfcf071d8436889b5/kaggle_plantpatho/cli_train.py" rel="noopener ugc nofollow" target="_blank">培训脚本</a>的地方开始。我们现在将展示如何使用三种不同的学习速率和三个ResNet模型主干的组合来运行9个实验。此外，您可以在命令行或UI中轻松扩展实验和超参数的数量，而无需更改任何代码。</p><p id="d9e0" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下步骤假设我们已经从data science内核创建了<a class="ae jd" href="https://github.com/Borda/kaggle_plant-pathology" rel="noopener ugc nofollow" target="_blank"> GitHub存储库</a>。现在，我们可以链接我们想要运行超参数搜索的<a class="ae jd" href="https://github.com/Borda/kaggle_plant-pathology/blob/a642861e8d4d896c15b10c5dfcf071d8436889b5/kaggle_plantpatho/cli_train.py" rel="noopener ugc nofollow" target="_blank">训练脚本</a>。如果你还没有创建一个GitHub回购，请查看<a class="ae jd" rel="noopener" target="_blank" href="/converting-kaggle-training-notebooks-to-sharable-code-1cc59fec2414">这篇文章</a>，或者你可以跟随我冒昧为这篇文章准备的回购。</p><div class="ip iq gp gr ir lr"><a href="https://github.com/Borda/kaggle_plant-pathology" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd jh gy z fp lw fr fs lx fu fw jf bi translated">GitHub-Borda/ka ggle _ plant-pathology:识别苹果树叶子上的病害类型</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">叶部病害对苹果园的整体产量和质量构成了重大威胁。当前…</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">github.com</p></div></div><div class="ma l"><div class="os l mc md me ma mf ix lr"/></div></div></a></div><p id="cd36" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，我们选择想要使用的机器类型。在我们的例子中，我们需要一个GPU来训练我们的模型，所以我每次实验都选择了一个<a class="ae jd" href="https://docs.grid.ai/products/run-run-and-sweep-github-files/machines" rel="noopener ugc nofollow" target="_blank">单T4 </a>，使用<a class="ae jd" href="https://spot.io/what-are-ec2-spot-instances" rel="noopener ugc nofollow" target="_blank">点实例</a>来显著降低成本。这9次实验(每次训练大约需要30分钟)花费了不到1美元的免费积分来调整一个可分级的模型。</p><figure class="od oe of og gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ot"><img src="../Images/fb8e8695cfd9807f251ed537ed02b838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*2oc_DobYB2TwjkTTD_KjCg.gif"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">使用网格运行创建网格搜索的过程。</p></figure><p id="7130" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了准备我们的超参数搜索，我们需要做的就是用一个范围(列表、采样等)替换我们的单个CLI的参数值。)的pythonic式的价值观:</p><pre class="od oe of og gt oh oi oj ok aw ol bi"><span id="4118" class="nr mo jg oi b gy om on l oo op">--model.model "['resnet18', 'resnet34', 'resnet50']" \<br/>--model.lr "[0.0001, 0.0005, 0.001]" \<br/>--data.base_path grid:kaggle_plant-pathology:1 \<br/>--trainer.max_epochs 5</span></pre><p id="b09a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于每个实验，我们从上一步中创建的数据存储中装载数据，因此不需要在本地下载数据，大大加快了训练时间。</p><h2 id="7e66" class="nr mo jg bd mp ns nt dn mt nu nv dp mx le nw nx mz li ny nz nb lm oa ob nd oc bi translated">实时监控训练并保存最佳模型</h2><p id="fc0a" class="pw-post-body-paragraph kv kw jg kx b ky nf kh la lb ng kk ld le nh lg lh li ni lk ll lm nj lo lp lq ij bi translated">监控实验使您能够调试和终止不收敛的模型。这有助于降低成本并节省资源，这些资源可以再投资于训练更好的模型。</p><p id="883c" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">PyTorch Lightning默认使用<a class="ae jd" href="https://pytorch-lightning.readthedocs.io/en/latest/common/loggers.html#tensorboard" rel="noopener ugc nofollow" target="_blank"> TensorBoard记录器</a>，与<a class="ae jd" href="https://platform.grid.ai/" rel="noopener ugc nofollow" target="_blank"> Grid.ai平台</a>原生集成。<a class="ae jd" href="https://www.tensorflow.org/tensorboard" rel="noopener ugc nofollow" target="_blank"> TensorBoard </a>让我们可以毫不费力地监控和比较所有实验的结果。</p><figure class="od oe of og gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ou"><img src="../Images/a4aac4ea71b549a65f77e8226ec4d12d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XeyT7SqeM6s0hUGRkOs43g.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">浏览所有实验的汇总结果，以找到F1分数最高的模型。</p></figure><p id="ca23" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">PyTorch Lightning默认提供<a class="ae jd" href="https://pytorch-lightning.readthedocs.io/en/latest/common/weights_loading.html" rel="noopener ugc nofollow" target="_blank">自动检查点</a>。当找到最佳实验时，我们可以打开它的details窗口并导航到artifact选项卡来下载保存的检查点，我们将在推理中使用它。</p><figure class="od oe of og gt is gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/393ce08827f5a2021ba3af365ae9eb9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*nS7uZwyz7vYklwxCcBd0Vw.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">从一个特定的实验中下载艺术品。</p></figure></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="dc83" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这篇文章中，我们讨论了对超参数搜索的需求，并且我们已经运行了walked throw网格，这简化了云中的微调。我们甚至可以在线监控我们的训练，并最终根据我们的选择终止一些默认配置。</p><p id="3a4e" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在未来，我们将使用我们训练有素的模型，并展示如何准备离线运行的Kaggle submission内核，以便在比赛中进行评分。</p><div class="ip iq gp gr ir lr"><a rel="noopener follow" target="_blank" href="/submitting-model-predictions-to-kaggle-competition-ccb64b17132e"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd jh gy z fp lw fr fs lx fu fw jf bi translated">向Kaggle竞赛提交模型预测</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">用PyTorch闪电和网格点实例在Kaggle上排名的最佳实践(第5/5部分)</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">towardsdatascience.com</p></div></div><div class="ma l"><div class="ow l mc md me ma mf ix lr"/></div></div></a></div><p id="b48d" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx jh">敬请关注，关注我了解更多！</strong></p><div class="ip iq gp gr ir lr"><a href="https://devblog.pytorchlightning.ai/best-practices-to-rank-on-kaggle-competition-with-pytorch-lightning-and-grid-ai-spot-instances-54aa5248aa8e" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd jh gy z fp lw fr fs lx fu fw jf bi translated">使用PyTorch Lightning和Grid.ai Spot实例对Kaggle竞争进行排名的最佳实践</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">通过交互式会话、超参数解决图像分类挑战的完整数据科学周期…</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">devblog.pytorchlightning.ai</p></div></div><div class="ma l"><div class="ox l mc md me ma mf ix lr"/></div></div></a></div><h1 id="198c" class="mn mo jg bd mp mq mr ms mt mu mv mw mx km my kn mz kp na kq nb ks nc kt nd ne bi translated">关于作者</h1><p id="48e4" class="pw-post-body-paragraph kv kw jg kx b ky nf kh la lb ng kk ld le nh lg lh li ni lk ll lm nj lo lp lq ij bi translated"><a class="ae jd" href="https://medium.com/@jborovec" rel="noopener"><strong class="kx jh">Jirka boro vec</strong></a><strong class="kx jh"/>已经在几家不同的IT公司从事机器学习和数据科学工作好几年了。特别是，他喜欢探索有趣的世界问题，并用最先进的技术解决它们。此外，他开发了几个开源python包，并积极参与其他知名项目。在<a class="ae jd" href="https://www.grid.ai/" rel="noopener ugc nofollow" target="_blank"> <em class="nn"> Grid.ai </em> </a>工作，担任研究工程师，<a class="ae jd" href="https://pytorchlightning.ai/" rel="noopener ugc nofollow" target="_blank"><em class="nn">pytorchlightning . ai</em></a>主要撰稿人。</p></div></div>    
</body>
</html>