<html>
<head>
<title>Building a microservice with Google Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Cloud Run构建微服务</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-microservice-with-google-cloud-run-90f8df9682da?source=collection_archive---------22-----------------------#2021-07-21">https://towardsdatascience.com/building-a-microservice-with-google-cloud-run-90f8df9682da?source=collection_archive---------22-----------------------#2021-07-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3102" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Cloud Run上设置一个简单的web应用程序来更新Big Query中的表</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/db5236df289bd7c389164fcf63548262.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8_nJzAKHHjTqmKSiZV0g_A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@herrherrmann" rel="noopener ugc nofollow" target="_blank"> Sebastian Herrmann </a>拍摄自<a class="ae ky" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><h1 id="27fd" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated"><strong class="ak">云上运行快速介绍</strong></h1><p id="d655" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Google cloud run是一个完全托管的计算平台，用于在云上运行容器化的应用程序。Cloud run通过基于应用流量的自动扩展功能，消除了管理所有基础架构的复杂性。</p><p id="c43d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本文中，我们将了解使用python和flask创建云运行微服务的方法，我们将把它们部署到Docker容器中。微服务将具有根据用户输入更新谷歌大查询表的功能。以下是将要使用的产品/服务:</p><ul class=""><li id="9a82" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">Python和Flask</li><li id="15b6" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">码头工人</li><li id="850e" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">谷歌云运行</li><li id="2b5b" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">谷歌云容器注册中心</li></ul><p id="347b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最终结果将是一个运行在HTTP上的web应用程序，用户可以提交他们的输入，更新Google Big Query中的一个表。</p><h1 id="5b3a" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">我们开始吧！</h1><p id="cd38" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">本文假设您已经设置了一个Google Cloud帐户。</p><p id="9f4c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">所有的脚本都可以在这里找到:<a class="ae ky" href="https://github.com/iamsuelynn/Cloud-Run-Microservice-Example-1" rel="noopener ugc nofollow" target="_blank"> GitHub </a></p><p id="c71d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> (1)开发微服务所需的文件/脚本</strong></p><p id="8f0f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对于这个例子，我们将创建一个简单的应用程序，用户可以通过将输入传递到微服务链接，将书名和作者的新记录插入到一个大的查询表中。</p><p id="2f3f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">创建云运行服务需要准备3个不同的文件。</p><ul class=""><li id="f87d" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">main.py</li><li id="74d4" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">requirements.txt</li><li id="f9ff" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">Dockerfile文件</li></ul><p id="e01e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">文件号1: main.py </strong></p><p id="df28" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">该文件将启动Flask app，并包含python函数，该函数接收用户输入并更新到Google Big查询表中。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="6849" class="nl la it nh b gy nm nn l no np">from flask import Flask, request, make_response, jsonify<br/>import pandas as pd<br/>import gcsfs<br/>from google.cloud import bigquery<br/>from google.oauth2 import service_account<br/>import pandas_gbq<br/>import os</span><span id="422c" class="nl la it nh b gy nq nn l no np">app = Flask(__name__)</span><span id="97d7" class="nl la it nh b gy nq nn l no np">app.config["DEBUG"] = True #If the code is malformed, there will be an error shown when visit app</span><span id="db24" class="nl la it nh b gy nq nn l no np"><a class="ae ky" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route("/books", methods=["GET"])<br/>def books_table_update():<br/>    <br/>    Title = request.args.get('title', None)<br/>    Author = request.args.get('author', None)</span><span id="f65e" class="nl la it nh b gy nq nn l no np">input_table = {'book_title':[Title],'book_author':[Author]}<br/>    input_table = pd.DataFrame(input_table)<br/>    input_table["book_title"]= input_table["book_title"].map(str)<br/>    input_table["book_author"]= input_table["book_author"].map(str)<br/>    <br/>    #Push table to Google Big Query</span><span id="c72a" class="nl la it nh b gy nq nn l no np">client = bigquery.Client()<br/>    project_id = 'sue-gcp-learning-env'<br/>    table_id = 'Books.books_title_author'<br/>    pandas_gbq.to_gbq(input_table, table_id, project_id=project_id, if_exists='append')<br/>    <br/>    return "Table books_title_author has been Updated"</span></pre><p id="113e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">文件号2: requirements.txt </strong></p><p id="6b75" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要求文件，以指定安装所需的库。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="a14e" class="nl la it nh b gy nm nn l no np">Flask<br/>gunicorn<br/>google-api-core<br/>google-cloud-bigquery<br/>pandas<br/>pandas-gbq<br/>gcsfs</span></pre><p id="e8fc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">3号文件:Dockerfile </strong></p><p id="2308" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">Dockerfile文件指定如何创建容器:</p><ul class=""><li id="0203" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">从官方python 3.9映像构建一个容器</li><li id="127f" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">将本地代码复制到容器映像</li><li id="0522" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">在requirements.txt文件中安装软件包</li><li id="fbb7" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">在容器启动时运行web服务</li></ul><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="821a" class="nl la it nh b gy nm nn l no np"># Use the official lightweight Python image.<br/># <a class="ae ky" href="https://hub.docker.com/_/python" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/_/python</a><br/>FROM python:3.9-slim</span><span id="19b7" class="nl la it nh b gy nq nn l no np"># Allow statements and log messages to immediately appear in the Knative logs<br/>ENV PYTHONUNBUFFERED True</span><span id="0ed0" class="nl la it nh b gy nq nn l no np"># Copy local code to the container image.<br/>ENV APP_HOME /app<br/>WORKDIR $APP_HOME<br/>COPY . ./</span><span id="9cb9" class="nl la it nh b gy nq nn l no np"># Install production dependencies.<br/>RUN pip install  --no-cache-dir -r requirements.txt</span><span id="c660" class="nl la it nh b gy nq nn l no np">ENV PORT 8080</span><span id="1256" class="nl la it nh b gy nq nn l no np">CMD exec gunicorn --bind :$PORT --workers 1 --threads 8 --timeout 0 main:app</span></pre><p id="521b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> (2)将所有3个文件/脚本上传到云壳编辑器</strong></p><p id="5492" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在将文件/脚本上传到云壳编辑器之前，您需要在Google云控制台中激活云壳并创建一个文件夹。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="77e1" class="nl la it nh b gy nm nn l no np">mkdir books_update</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/2f94c3c24d23589525397a7eb94c4a16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hWy-B5VNT23MbY6e-O7Vgw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在云壳中打开编辑器</p></figure><p id="b497" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">右键单击新创建的文件夹或通过文件，将所有需要的文件/脚本上传到books_update文件夹。上传完成后，点击“打开终端”返回外壳编辑器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/ac233f5aa31840905bd60b83eb5ddd1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-5ge0nKJwhzkWodt_UhTyQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将所有3个文件上传到创建的文件夹中</p></figure><p id="e8c2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> (3)构建&amp;部署新的Docker映像</strong></p><p id="fd55" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">太好了！我们现在准备构建一个新的docker映像，它将在我们选择的区域运行。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="2187" class="nl la it nh b gy nm nn l no np">gcloud config set run/region asia-southeast1</span><span id="4db1" class="nl la it nh b gy nq nn l no np">gcloud builds submit --tag gcr.io/sue-gcp-learning-env/books_update</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/b7068ebbc426542393354bd35a329640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RdauVGnlI8RtugKK95L0_w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">构建Docker映像的命令</p></figure><p id="2c57" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">构建完成后，运行下面的命令来部署新构建的映像。您需要提供云运行服务名称。当容器构建完成后，将会提供您的服务URL。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="a571" class="nl la it nh b gy nm nn l no np">gcloud run deploy --image gcr.io/sue-gcp-learning-env/books_update --platform managed</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/99895f3c6b82d95883f3bfd21f2d54a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HFgR-quHrlm5RQAUtagg6w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">部署Docker映像并设置云运行服务名称</p></figure><p id="b172" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> (4)你的服务准备好了！</strong></p><p id="83b2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">容器构建完成后，将提供服务URL。或者，我们可以从云运行中跟踪我们部署的服务。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/03767d7601e6b48e779dc4bd8e3eb9dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MWbAnkYEgXDsw__MAJEhyg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">云运行服务:图书更新</p></figure><p id="6394" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> (5)让我们测试一下我们的服务</strong></p><p id="15e7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在调用服务之前，让我们检查一下调用服务时将要更新的大查询表。在这个表中，books_title_author当前有2条记录，我们将通过调用我们的服务向这个表中添加一条新记录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/43bfc176d233008ea9d1b40fa6f60062.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5ij_VZxGdYMKInLcPIRElw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">大查询表:books_title_author(调用服务前)</p></figure><p id="9ef6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这里，我们调用服务并传递我们想要为新记录添加的输入值。如果服务运行成功，它将返回我们指定的消息:“表books_title_author已更新”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/b96749f64da47c2e945e5175351b47ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*diE9GpUmsEO6loMDVw2erQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">调用云运行服务并传递用户输入</p></figure><p id="1d0d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们在Google Big Query中检查我们更新的表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/523cc116ec530c56762eb3c815b51879.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I6qEiyrJzRoHPVGM7eGlEA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">大查询表:books_title_author(调用服务后)</p></figure><p id="b824" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如我们在刷新后的表中看到的，新记录是根据调用URL时指定的输入插入的。我们已经成功地在Cloud Run上创建了一个简单的web应用程序，它更新了Google Big Query中的一个表。</p><p id="d918" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">结论</strong></p><p id="4dd5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通过Google Cloud Run部署微服务变得更加容易和方便，因为管理服务器的过程已经得到处理。只需要几个步骤，您就可以立即部署无状态微服务。下面是文章中解释的步骤的摘要:</p><ul class=""><li id="e790" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">准备3个主文件/脚本，包括(main.py、requirements.txt和Dockerfile)</li><li id="8f54" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">将您的文件上传到Google Cloud shell编辑器以创建Docker容器。</li><li id="f3b9" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated">部署完全构建的映像以创建完全托管的web应用程序。</li></ul><p id="8011" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这就是在云上创建微服务所需了解的全部内容。我希望这篇文章对那些学习使用Google Cloud Run创建微服务的人有用。</p><p id="22c9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">参考文献</strong></p><p id="ee99" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[1]<a class="ae ky" href="https://cloud.google.com/run/docs/quickstarts/build-and-deploy/python" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/run/docs/quick starts/build-and-deploy/python</a></p><p id="221e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[2]<a class="ae ky" href="https://cloud.google.com/blog/topics/developers-practitioners/cloud-run-story-serverless-containers" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/blog/topics/developers-从业者/cloud-run-story-server less-containers</a></p><p id="1005" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">[3]<a class="ae ky" href="https://www.kdnuggets.com/2021/05/deploy-dockerized-fastapi-app-google-cloud-platform.html" rel="noopener ugc nofollow" target="_blank">https://www . kdnugges . com/2021/05/deploy-dockerized-fastapi-app-Google-cloud-platform . html</a></p></div></div>    
</body>
</html>