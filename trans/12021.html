<html>
<head>
<title>Anomaly Detection in IoT Enabled Smart Battery Management Systems</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">支持物联网的智能电池管理系统中的异常检测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/anomaly-detection-in-iot-enabled-smart-battery-management-systems-4ae2419c6074?source=collection_archive---------12-----------------------#2021-12-03">https://towardsdatascience.com/anomaly-detection-in-iot-enabled-smart-battery-management-systems-4ae2419c6074?source=collection_archive---------12-----------------------#2021-12-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e539" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解电子移动世界中数据工程和机器学习的使用</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/19aac71e93f3e31784458d25bf2cf83f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*afHaa7CTOkaQw0a4OKXPGw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@kumpan_electric?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">库姆潘电气</a>在<a class="ae ky" href="https://unsplash.com/s/photos/electric-scooter-battery?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">un plash</a>上拍摄的照片</p></figure><p id="2f07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们生活在一个电动移动的世界里。从全球范围来看，电动汽车和两轮驱动汽车的使用正在急剧上升。电动移动设备依靠昂贵的可充电锂离子电池供电。这些电池是对抗化石燃料不良影响(如污染和成本上升)的不可或缺的组成部分。但是锂离子技术也有一些缺点，比如:</p><ul class=""><li id="ecee" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">温度升高和短路引起的火灾和爆炸</li><li id="9271" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">充电过度/不足导致的使用寿命缩短</li><li id="c438" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">由于老化，性能随着时间的推移而下降</li></ul><blockquote class="mj"><p id="3611" class="mk ml it bd mm mn mo mp mq mr ms lu dk translated">全球锂离子电池市场规模预计在几年内将翻一番以上——从 2020 年的 440 亿美元到 2025 年的 940 亿美元</p></blockquote><p id="d0de" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">目前，与物理电池的采购及其维护相关的成本是采用该技术的一个主要障碍。几家锂离子电池制造公司现在正在开发<strong class="lb iu">智能电池管理系统</strong>，以帮助监控和跟踪锂离子电池的健康状况。电池管理系统有几个目标:</p><ol class=""><li id="d8e5" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu my mb mc md bi translated"><strong class="lb iu">预防性分析</strong> — <em class="mz">监控层</em> —持续监控与火灾、爆炸相关的威胁</li><li id="a791" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu my mb mc md bi translated"><strong class="lb iu">预测分析</strong> — <em class="mz">分析层</em> —预测故障，防止电池损坏，从而延长电池寿命</li></ol><p id="3ecb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最近，我有机会为一家生产电动代步车电池的公司创建了这样一个智能电池管理系统。以下是该解决方案的高级架构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/4e6bf40793e61800721e6efb09816984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n0WC9lVGcM4nUF49KEVLug.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片 Azure Cloud 上智能电池管理系统的高级架构</p></figure><ul class=""><li id="ddfd" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">每个电池组都配有一个测量电池电压、电流和温度的电子物联网传感器</li><li id="ca87" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用 Wi-Fi 或蓝牙将传感器数据发送到 Azure 云(Azure 事件中枢或 Azure 物联网中枢)</li><li id="699e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">来自 Azure 事件中枢/Azure 物联网中枢的流数据使用 Azure 流分析进行计算</li><li id="5276" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Azure Stream Analytics 作业执行异常检测。如果检测到异常，将生成<strong class="lb iu">警报</strong>并使用 Azure 通知中枢发送给用户</li></ul><p id="bbd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在接下来的部分中，我将向您展示我们如何使用 Azure 提供的基于机器学习的操作符—<strong class="lb iu">anomaly detection _ spike andip</strong>和<strong class="lb iu">anomaly detection _ change point</strong>来执行异常检测。</p><blockquote class="nb nc nd"><p id="80a3" class="kz la mz lb b lc ld ju le lf lg jx lh ne lj lk ll nf ln lo lp ng lr ls lt lu im bi translated">AnomalyDetection _ SpikeAndDip 能够检测时间序列事件中的临时异常。</p><p id="846a" class="kz la mz lb b lc ld ju le lf lg jx lh ne lj lk ll nf ln lo lp ng lr ls lt lu im bi translated">AnomalyDetection_ChangePoint 能够检测时间序列事件流中的持续异常</p></blockquote><p id="610f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这次演示中，我使用了 48V 25Ah 的锂离子电池。以下是电池的技术规格。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/d94c20a8c4a5365dac86e52e0567729c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8GYdlOIK4TPciK1hUuDIYQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片 bu 作者—电池规格</p></figure><p id="dec9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这种电池，以下是推荐的水印。</p><blockquote class="nb nc nd"><p id="aaf6" class="kz la mz lb b lc ld ju le lf lg jx lh ne lj lk ll nf ln lo lp ng lr ls lt lu im bi translated">上限电压— 54.6 V— <strong class="lb iu">任何更高的电压都可能导致爆炸或火灾</strong> <br/>下限电压— 39 V — <strong class="lb iu">任何更低的电压都会影响电池的健康</strong></p></blockquote><p id="d80f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">电池管理系统的一个关键功能是监控这些关键值是否在推荐范围内。出于演示的目的，我将集中在<strong class="lb iu">高点电压</strong>。毕竟谁想要爆炸或火灾。</p><p id="c259" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们开始实现。假设你已经有一个 Azure 帐户，请按照下面的步骤继续操作:</p><ul class=""><li id="5514" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">开云壳<a class="ae ky" href="https://portal.azure.com/#cloudshell/" rel="noopener ugc nofollow" target="_blank">https://portal.azure.com/#cloudshell/</a></li><li id="4d79" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">调用下面的命令来克隆代码库</li></ul><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="eead" class="nn no it nj b gy np nq l nr ns">Azure&gt; git clone <a class="ae ky" href="https://github.com/mkukreja1/blogs" rel="noopener ugc nofollow" target="_blank">https://github.com/mkukreja1/blogs</a><br/>Cloning into ‘blogs’…<br/>remote: Enumerating objects: 149, done.<br/>remote: Counting objects: 100% (149/149), done.<br/>remote: Compressing objects: 100% (90/90), done.<br/>remote: Total 149 (delta 54), reused 135 (delta 40), pack-reused 0<br/>Receiving objects: 100% (149/149), 1.67 MiB | 41.71 MiB/s, done.<br/>Resolving deltas: 100% (54/54), done.</span></pre><ul class=""><li id="9969" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">现在让我们创建一个 Azure 事件中心。您可以根据自己的喜好编辑<strong class="lb iu">资源组名称</strong>和<strong class="lb iu">位置</strong>的名称。</li></ul><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="4898" class="nn no it nj b gy np nq l nr ns">RESOURCEGROUPNAME="training_rg"<br/>LOCATION="eastus"<br/>TOPIC="iotbattery"<br/>EVENTHUB_NAMESPACE="iotbatteryspace"<br/>EVENTHUB_NAME="iotbatteryhub"<br/>EVENT_SUBSCRIPTION="iotbatteryevent"</span><span id="c9c7" class="nn no it nj b gy nt nq l nr ns">az provider register --namespace Microsoft.EventGrid<br/>az provider show --namespace Microsoft.EventGrid --query "registrationState"<br/>az eventgrid topic create --name $TOPIC -l $LOCATION -g $RESOURCEGROUPNAME</span><span id="be17" class="nn no it nj b gy nt nq l nr ns">az eventhubs namespace create --name $EVENTHUB_NAMESPACE --resource-group $RESOURCEGROUPNAME<br/>az eventhubs eventhub create --name $EVENTHUB_NAME --namespace-name $EVENTHUB_NAMESPACE --resource-group $RESOURCEGROUPNAME</span></pre><ul class=""><li id="7bdf" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">要验证新创建的 Azure Event Hub，请导航到<strong class="lb iu">主页</strong> &gt; <strong class="lb iu">所有资源</strong> &gt; <strong class="lb iu"> iotbatteryspace。</strong>在左侧菜单中点击<strong class="lb iu">活动中心</strong>。现在点击新创建的事件中心<strong class="lb iu"> iotbatteryhub。</strong></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/53bb686acca4d525683da32ce0571a30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eXZA8UClf9mgYJOGY6Md-A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片—新创建的 Azure 事件中心</p></figure><ul class=""><li id="4c20" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">点击<strong class="lb iu">过程数据</strong>，然后点击<strong class="lb iu">浏览</strong>。你现在应该在一个<strong class="lb iu">查询编辑器</strong>窗口中。我们需要创建一个共享访问策略来预览 Azure 事件中心中的数据。点击<strong class="lb iu">创建</strong>。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/f7dfc16c4535cb72bf13afe192c3b3f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-InxJsbn1BX5oecHYGwDFQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者分类的图像-查询编辑器窗口</p></figure><ul class=""><li id="7cf9" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">此时，我们已经准备好向新创建的 Azure event hub 发送一些事件。由于您没有实际的物联网传感器，我们可以使用下面的命令来模拟发送到 Azure 事件中心的五节电池的 100 个事件。在云外壳中调用下面的命令。</li></ul><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="bf6c" class="nn no it nj b gy np nq l nr ns">RESOURCEGROUPNAME="training_rg"<br/>TOPIC="iotbattery"<br/>EVENTHUB_NAMESPACE="iotbatteryspace"<br/>EVENTHUB_NAME="iotbatteryhub"<br/>EVENTHUB_CONN_STR=$(az eventhubs namespace authorization-rule keys list --resource-group $RESOURCEGROUPNAME --namespace-name $EVENTHUB_NAMESPACE --name RootManageSharedAccessKey --query "primaryConnectionString" --output tsv)<br/>for VARIABLE in {1..100}<br/>do<br/> echo "Sending event $VARIABLE"<br/> python ~/blogs/eventhubs/iot/send_battery_events_normal_reading.py --EVENTHUB_NAME $EVENTHUB_NAME --EVENTHUB_CONN_STR $EVENTHUB_CONN_STR<br/>done</span></pre><ul class=""><li id="1c1c" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">我们现在可以验证事件数据是否出现在 Azure 事件中心。回到 Azure 门户<strong class="lb iu">查询编辑器</strong>。在<strong class="lb iu">输入预览</strong>页签中，按<strong class="lb iu">刷新</strong>。现在，您应该在查询窗口中看到新发送的事件。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/3f36e3381f7c064ba276d5a968f899a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XznCGyitUWOnQ1UvbS1-YQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者分类的图像-事件数据</p></figure><ul class=""><li id="d123" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">检查从物联网事件收到的读数。在查询编辑器中调用下面的 SQL。</li></ul><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="e768" class="nn no it nj b gy np nq l nr ns">SELECT data.Timestamp, data."Battery Pack", data."Terminal Voltage", data."Charging Current", data."Discharging Current",data."SoC", data."Charge Capacity", data."Charging Power", data."Discharging Power", data."Cycle Count"<br/>FROM [iotbatteryhub]</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/835f9e9f718cf4c16f30a16bb9d94ac9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LwdeECJf4Up6snnVUDhX4w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片-活动阅读</p></figure><ul class=""><li id="cb70" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">我们现在准备实施<strong class="lb iu">异常检测</strong>。记住，我们要监控电池电压的尖峰电压，因为它们可能是危险的。调用下面的 SQL 来检查收到了多少个峰值。</li></ul><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="4f4d" class="nn no it nj b gy np nq l nr ns">WITH batteryAnomalyDetection AS<br/>(<br/>    SELECT<br/>        data.Timestamp AS time,<br/>        CAST(data."Terminal Voltage" AS float) AS Voltage,<br/>        AnomalyDetection_SpikeAndDip(CAST(data."Terminal Voltage" AS   float), 70, 90, 'spikes')<br/>        OVER(LIMIT DURATION(second, 120)) AS Spikes<br/>    FROM <br/>    [iotbatteryhub]<br/>)<br/>SELECT<br/>    time,<br/>    Voltage,<br/>    CAST(GetRecordPropertyValue(Spikes, 'Score') AS float) AS<br/>    SpikeAndDipScore,<br/>    CAST(GetRecordPropertyValue(Spikes, 'IsAnomaly') AS bigint) AS<br/>    IsSpikeAnomaly<br/>INTO battery<br/>FROM batteryAnomalyDetection<br/>WHERE CAST(GetRecordPropertyValue(Spikes, 'IsAnomaly') AS bigint)=1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/3637971268b7da35edfb64630d5b8040.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4PXfUOHKuBY2rQLZLTKtOA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片—70%置信度下模型测试的电压峰值</p></figure><p id="af01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的 SQL 中，我们使用 70%的置信度检查了异常。anomaly detection _ spikeandip(CAST(data。“端电压”为浮动)，<strong class="lb iu"> 70 </strong>，90，“尖峰”)</p><p id="95dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上图向我们展示了机器学习操作员将 17 个事件标记为尖峰。</p><ul class=""><li id="b2ec" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">让我们重新测试这个模型，但是这次要有 90%的置信度。</li></ul><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="ce31" class="nn no it nj b gy np nq l nr ns">WITH batteryAnomalyDetection AS<br/>(<br/>    SELECT<br/>        data.Timestamp AS time,<br/>        CAST(data."Terminal Voltage" AS float) AS Voltage,<br/>        AnomalyDetection_SpikeAndDip(CAST(data."Terminal Voltage" AS   float), 90, 95, 'spikes')<br/>        OVER(LIMIT DURATION(second, 120)) AS Spikes<br/>    FROM <br/>    [iotbatteryhub]<br/>)<br/>SELECT<br/>    time,<br/>    Voltage,<br/>    CAST(GetRecordPropertyValue(Spikes, 'Score') AS float) AS<br/>    SpikeAndDipScore,<br/>    CAST(GetRecordPropertyValue(Spikes, 'IsAnomaly') AS bigint) AS<br/>    IsSpikeAnomaly<br/>INTO battery<br/>FROM batteryAnomalyDetection<br/>WHERE CAST(GetRecordPropertyValue(Spikes, 'IsAnomaly') AS bigint)=1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/ec748ed7daaa2736427c2dea1a3fd1c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8fRamWsBmOQZzItEOwaPbQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片—90%置信度下模型测试的电压峰值</p></figure><p id="50b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上图向我们展示了机器学习操作员将 15 个事件标记为尖峰。</p><p id="367a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于<strong class="lb iu">预防性分析</strong>,我们可以实现为每个接收到的尖峰发送<strong class="lb iu">警报</strong>的代码。使用 Azure 函数可以轻松做到这一点。</p><ul class=""><li id="5844" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">现在让我们做一些更有趣的事情。我们现在将此转换为<strong class="lb iu">流分析工作。</strong>将该查询转换为作业的好处是可以无人值守地收集数据。收集的数据将有助于我们进行进一步的分析，这些分析可用于仪表板和决策制定。</li></ul><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="1826" class="nn no it nj b gy np nq l nr ns">WITH batteryAnomalyDetection AS<br/>(<br/>    SELECT<br/>        data.Timestamp AS time,<br/>        CAST(data."Terminal Voltage" AS float) AS Voltage,<br/>        AnomalyDetection_SpikeAndDip(CAST(data."Terminal Voltage" AS   float), 90, 95, 'spikes')<br/>        OVER(LIMIT DURATION(second, 120)) AS Spikes<br/>    FROM <br/>    [iotbatteryhub]<br/>)<br/>SELECT<br/>    time,<br/>    Voltage,<br/>    CAST(GetRecordPropertyValue(Spikes, 'Score') AS float) AS<br/>    SpikeAndDipScore,<br/>    CAST(GetRecordPropertyValue(Spikes, 'IsAnomaly') AS bigint) AS<br/>    IsSpikeAnomaly<br/>INTO battery<br/>FROM batteryAnomalyDetection</span></pre><p id="f0aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击<strong class="lb iu">创建流分析作业</strong>。填写如下详细信息，并点击<strong class="lb iu">创建</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/a541c8d261223702231e50e08fd14368.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*Jnui3Ay9Q3CTHGYufLh5bw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者分类的图像-新的流分析作业参数</p></figure><ul class=""><li id="ad81" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">你现在会在一个类似这样的窗口中。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/fc369134888bbd38040d7872d62c754a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JhYll5nimYl6J-TxIXD4ZA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者分类的图像-新的流分析作业</p></figure><p id="863c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要一个用于数据收集的输出。点击<strong class="lb iu"> +添加</strong>，选择 Azure Blob 存储/ADLS Gen2。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/fb53315e0c06621f256c60926bb24b98.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*ELmtVTJMy_nYdb-64aH7Zg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者分类的图像-流分析作业输出</p></figure><ul class=""><li id="9f85" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">既然已经创建了作业的输出，我们就可以开始作业了。点击<strong class="lb iu">启动</strong>。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/6bf08016b7b86371566a6289e5e5c80e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WsEibSLJ2ZNJv7C0IImOcg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者分类的图像-启动流分析作业</p></figure><ul class=""><li id="bd22" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">收到“<a class="ae ky" href="https://portal.azure.com/#" rel="noopener ugc nofollow" target="_blank">流式作业成功启动</a>”消息后，向事件中心发送更多事件。在云外壳中调用下面的命令。</li></ul><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="e97c" class="nn no it nj b gy np nq l nr ns">RESOURCEGROUPNAME="training_rg"<br/>TOPIC="iotbattery"<br/>EVENTHUB_NAMESPACE="iotbatteryspace"<br/>EVENTHUB_NAME="iotbatteryhub"<br/>EVENTHUB_CONN_STR=$(az eventhubs namespace authorization-rule keys list --resource-group $RESOURCEGROUPNAME --namespace-name $EVENTHUB_NAMESPACE --name RootManageSharedAccessKey --query "primaryConnectionString" --output tsv)<br/>for VARIABLE in {1..100}<br/>do<br/> echo "Sending event $VARIABLE"<br/> python ~/blogs/eventhubs/iot/send_battery_events_normal_reading.py --EVENTHUB_NAME $EVENTHUB_NAME --EVENTHUB_CONN_STR $EVENTHUB_CONN_STR<br/>done</span></pre><ul class=""><li id="66f4" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">如果一切正常，流分析作业将以 JSON 格式将事件输出到下面的存储中。导航到<strong class="lb iu">主页</strong> &gt; <strong class="lb iu">所有资源</strong> &gt; <strong class="lb iu">培训工作室</strong> &gt; <strong class="lb iu">电池</strong></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/88a56d28c6761b0aa74322276e2b51c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kEKah6_LvZSI1avcivbRQw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者分类的图像—存储上的事件数据</p></figure><ul class=""><li id="e260" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">但是我们如何对事件数据进行分析呢？为此，我们可以使用 Azure Synapse。在 cloud shell 中调用下面的命令来创建一个新的 Synape 工作区。</li></ul><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="018d" class="nn no it nj b gy np nq l nr ns">STORAGEACCOUNTNAME="traininglakehouse"<br/>BATTERYDATALAYER="battery"<br/>SYSNAPSEWORKSPACENAME="batterytracking"<br/>RESOURCEGROUPNAME="training_rg"<br/>LOCATION="eastus"<br/>SQLUSER="sqladminuser"<br/>SQLPASSWORD="*********"</span><span id="ba6a" class="nn no it nj b gy nt nq l nr ns">az synapse workspace create \<br/>  --name $SYSNAPSEWORKSPACENAME \<br/>  --resource-group $RESOURCEGROUPNAME \<br/>  --storage-account $STORAGEACCOUNTNAME \<br/>  --file-system $BATTERYDATALAYER \<br/>  --sql-admin-login-user $SQLUSER \<br/>  --sql-admin-login-password $SQLPASSWORD \<br/>  --location $LOCATION</span><span id="bf9e" class="nn no it nj b gy nt nq l nr ns">az synapse workspace firewall-rule create --name allowAll --workspace-name $SYSNAPSEWORKSPACENAME --resource-group $RESOURCEGROUPNAME --start-ip-address 0.0.0.0 --end-ip-address 255.255.255.255</span></pre><ul class=""><li id="2308" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">现在导航到<strong class="lb iu">主页</strong> &gt; <strong class="lb iu">所有资源</strong> &gt; <strong class="lb iu">电池追踪</strong>，点击<strong class="lb iu">打开 Synapse 工作室</strong>部分的<strong class="lb iu">打开</strong></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/a899a81edcff479e9bd4d847aaa4369b.png" data-original-src="https://miro.medium.com/v2/resize:fit:578/format:webp/1*5fs4eMFk3dPK6wo2elyKng.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片—打开 Synapse studio</p></figure><ul class=""><li id="2af1" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">在 Synapse workspace 窗口中，使用左侧窗格中的菜单点击<strong class="lb iu">数据</strong>。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/fd7b1584484b964157fc1ec14d6c1a32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*9236W9Qm5SfTJYAl-1h4kw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者分类的图像—创建新的 SQL 数据库</p></figure><p id="1283" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输入如下详细信息，点击<strong class="lb iu">创建</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/8435dcdfbb7b2362ae1cc43af84e673c.png" data-original-src="https://miro.medium.com/v2/resize:fit:780/format:webp/1*maCvTxdV68ABNWEGR0xVJA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者排序的图像—在无服务器池中创建新的 SQL 数据库</p></figure><ul class=""><li id="4b4f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">创建数据库后，打开一个新的 SQL 脚本窗口。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/aa5a31f9f35bbeddbaf59e9fb514a545.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WV0hchNU0-14JnmksXnPJA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者排序的图像—打开一个新的 SQL 脚本窗口</p></figure><ul class=""><li id="0b7f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">将下面的 SQL 粘贴到新打开的 SQL 窗口中。该 SQL 将创建电池事件数据的视图。</li></ul><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="89f2" class="nn no it nj b gy np nq l nr ns">CREATE view battery<br/>AS<br/>SELECT JSON_VALUE(doc, '$.time') AS time, JSON_VALUE(doc, '$.BatteryPack') AS BatteryPack, JSON_VALUE(doc, '$.Voltage') AS Voltage, JSON_VALUE(doc, '$.SpikeAndDipScore') AS SpikeAndDipScore, JSON_VALUE(doc, '$.IsSpikeAnomaly') AS IsSpikeAnomaly<br/>FROM openrowset(<br/>   BULK 'https://traininglakehouse.blob.core.windows.net/battery/',<br/>   FORMAT= 'csv',<br/>   FIELDTERMINATOR='0x0b',<br/>   FIELDQUOTE= '0x0b'<br/>) WITH(doc nvarchar(max)) as row<br/>GO<br/>SELECT CONVERT(TIME,DATEADD(s,cast(time as int),'19700101 0:00:00')) as time, BatteryPack, Voltage, IsSpikeAnomaly FROM battery<br/>GO</span></pre><ul class=""><li id="d726" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">如您所见，我们现在可以在事件数据流入存储时对其进行虚拟化。下面的图表向我们展示了一段时间内事件的峰值。该信息对于<strong class="lb iu">预测分析至关重要。</strong></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/13a0384ea7b2ea0353acbdd11619a935.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B8r20x8BpotBvQRC3VimBg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者提供的图片—虚拟化电池事件</p></figure><p id="1247" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这篇文章是有帮助的。这个主题在由<a class="ae ky" href="http://www.datafence.com" rel="noopener ugc nofollow" target="_blank"> Datafence Cloud Academy </a>提供的 Azure 数据分析课程中有更详细的介绍。课程是周末自己在网上教的。</p></div></div>    
</body>
</html>