<html>
<head>
<title>Wrapping numpy’s array</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">包装numpy的数组</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/wrapping-numpys-arrays-971e015e14bb?source=collection_archive---------20-----------------------#2021-06-27">https://towardsdatascience.com/wrapping-numpys-arrays-971e015e14bb?source=collection_archive---------20-----------------------#2021-06-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3415" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">集装箱方法。</h2></div><p id="c0de" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> <em class="lb">记得使用右边的“关注”按钮来关注我→:你会收到新文章的通知，并帮助我达到100个关注者的目标:)</em> </strong></p><p id="c781" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Numpy的数组是功能强大的对象，通常被用作更复杂对象的基础数据结构，如<a class="ae lc" href="https://github.com/pandas-dev/pandas" rel="noopener ugc nofollow" target="_blank"> pandas </a>或<a class="ae lc" href="https://github.com/pydata/xarray" rel="noopener ugc nofollow" target="_blank"> xarray </a>。也就是说，您当然也可以在自己的类中使用numpy的强大数组——为此，您基本上有两种方法:</p><ul class=""><li id="8a1c" class="ld le iq kh b ki kj kl km ko lf ks lg kw lh la li lj lk ll bi translated"><strong class="kh ir">子类方法</strong>:创建从numpy.ndarray继承的类</li><li id="c456" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated"><strong class="kh ir">容器方法</strong>:创建属性为数组的类</li></ul><h2 id="4977" class="lr ls iq bd lt lu lv dn lw lx ly dp lz ko ma mb mc ks md me mf kw mg mh mi mj bi translated">在本文中，我们将看到如何使用容器方法包装numpy的数组来正确地创建自己的自定义类<em class="mk">。</em> </h2><figure class="mm mn mo mp gt mq gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi ml"><img src="../Images/03e5fedec1fec78213522d230253eca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dFL_tmcUfiorRQrK"/></div></div><p class="mx my gj gh gi mz na bd b be z dk translated">照片由<a class="ae lc" href="https://unsplash.com/@guibolduc?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Guillaume Bolduc </a>在<a class="ae lc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="bfbb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们以一个示例项目为例:我们想要创建一个简单的项目来处理物理单位和维度，创建长度类似于<code class="fe nb nc nd ne b">[1, 2, 3] meter </code>或重量类似于<code class="fe nb nc nd ne b">[55 65 8] kilogram</code>的数组，然后使用这些数组来计算平均身高或【身体质量指数】(<a class="ae lc" href="https://en.wikipedia.org/wiki/Body_mass_index" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Body_mass_index</a>)。我们希望依靠numpy来完成繁重的数字计算(如加、减、幂)，但我们也希望能够处理numpy数组之类的实例，如<code class="fe nb nc nd ne b">np.sort(weights)</code>或<code class="fe nb nc nd ne b">np.min(heights)</code>。</p><p id="4b46" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们将创建一个使用容器方法包装numpy数组的新类。数值将存储为普通的numpy数组，物理维度存储为字符串:</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="nf ng l"/></div><p class="mx my gj gh gi mz na bd b be z dk translated">物理阵列的第一种实现</p></figure><p id="875c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将简单地打印:<code class="fe nb nc nd ne b">[55.6 45.7 80.3] kilogram</code>。同样，这个字符串后面的数字列表是存储在<code class="fe nb nc nd ne b">self.value</code>中的实际numpy数组。</p><p id="85e6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在这是完全无用的:我们不能让这个对象与任何其他东西交互，所以我们添加了基本的操作，比如与其他<code class="fe nb nc nd ne b">Physical</code>实例的加法或乘法:</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="nf ng l"/></div><p class="mx my gj gh gi mz na bd b be z dk translated">现在，物理阵列可以与其他物理阵列相加或相乘。</p></figure><p id="f840" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，在增加或减少物理量之前，我们首先检查它们是否有相同的单位:你不能用重量来增加长度(或用胡萝卜增加土豆，或用驴子增加马)。</p><p id="3968" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这太棒了，我们现在可以计算一组体重指数(身体质量指数),给定一组以米为单位的身高和一组以千克为单位的体重。身体质量指数简单地通过将重量除以高度的平方给出，即:</p><p id="e9f0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BMI =weight(kg)/height(m)^2</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="bf3d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">万岁！我们用一个高度数组和一个高度数组计算体重指数数组，用后面的numpy数组进行实际的数值计算。但是numpy的阵列提供了更多的东西，这就是它真正有趣的地方。</p><h1 id="266d" class="nh ls iq bd lt ni nj nk lw nl nm nn lz jw no jx mc jz np ka mf kc nq kd mi nr bi translated"><strong class="ak">实现numpy功能支持</strong></h1><p id="0c9b" class="pw-post-body-paragraph kf kg iq kh b ki ns jr kk kl nt ju kn ko nu kq kr ks nv ku kv kw nw ky kz la ij bi translated">Numpy提供了许多有用的函数用于数组。仅举几个例子:</p><ul class=""><li id="75a1" class="ld le iq kh b ki kj kl km ko lf ks lg kw lh la li lj lk ll bi translated"><code class="fe nb nc nd ne b">np.sin</code>、<code class="fe nb nc nd ne b">np.cos</code>、<code class="fe nb nc nd ne b">np.tan</code>等</li><li id="b34c" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated"><code class="fe nb nc nd ne b">np.exp</code>、<code class="fe nb nc nd ne b">np.log</code>、<code class="fe nb nc nd ne b">np.log10</code>等</li><li id="be49" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated"><code class="fe nb nc nd ne b">np.add</code>、<code class="fe nb nc nd ne b">np.multiply</code>、<code class="fe nb nc nd ne b">np.divide</code>等</li><li id="c95c" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated"><code class="fe nb nc nd ne b">np.min</code>、<code class="fe nb nc nd ne b">np.max</code>、<code class="fe nb nc nd ne b">np.argmin</code>、<code class="fe nb nc nd ne b">np.argmax</code>等</li><li id="a965" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated"><code class="fe nb nc nd ne b">np.floor</code>、<code class="fe nb nc nd ne b">np.ceil</code>、<code class="fe nb nc nd ne b">np.trunc</code>等</li><li id="2e09" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated"><code class="fe nb nc nd ne b">np.concatenate</code>、<code class="fe nb nc nd ne b">np.vstack</code>等</li></ul><p id="092a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">诸如此类。你可以在numpy的网站上找到他们所有的东西:https://numpy.org/doc/stable/reference/routines.html。</p><p id="1fae" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们试着在课堂上使用其中一个:</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="804a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">试图在我们的物理实例<code class="fe nb nc nd ne b">bmi</code>上调用<code class="fe nb nc nd ne b">np.mean</code>会引发一个<code class="fe nb nc nd ne b">AttributeError</code>，因为numpy依赖于整数的加法和除法，而我们的类不能正确地实现这种操作。所以我们必须在某个地方告诉numpy，我们希望<code class="fe nb nc nd ne b">np.mean(bmi)</code>如何表现。</p><p id="1234" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是<code class="fe nb nc nd ne b">__array_function__</code>接口发挥作用的地方。</p><p id="bba8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接口只是一个规范化的过程，用来重载(某些)numpy函数如何处理来自你的类的参数。</p><p id="44cb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看一个简单的例子来处理我们的<code class="fe nb nc nd ne b">np.mean(bmi)</code>呼叫:</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="nf ng l"/></div><p class="mx my gj gh gi mz na bd b be z dk translated">使用__array_function__接口实现np.mean支持</p></figure><p id="c49c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">再次欢呼，<code class="fe nb nc nd ne b">np.mean(bmi)</code>返回我们的物理数组的“平均值”，它确实是一个物理量，单位为“kilogram/meter^2".”</p><p id="3349" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们回顾一下为了实现这一点我们在代码中添加了什么。有4件事需要注意:</p><ol class=""><li id="2e0a" class="ld le iq kh b ki kj kl km ko lf ks lg kw lh la nx lj lk ll bi translated">首先，我们在类定义之上创建一个名为<code class="fe nb nc nd ne b">HANDLED_FUNCTION = {}</code>的空字典。</li><li id="34a2" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la nx lj lk ll bi translated">其次，我们向我们的类中添加了一个名为 <code class="fe nb nc nd ne b"><strong class="kh ir">__array_function__</strong></code>的<strong class="kh ir">方法，该方法带有一个名为<code class="fe nb nc nd ne b">func</code>的参数。我们一会儿将回到这个方法的内容。</strong></li><li id="c067" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la nx lj lk ll bi translated">第三，我们创建一个装饰器构造函数:这是一个返回装饰器的函数(即另一个接受函数作为参数的函数)。我们的<code class="fe nb nc nd ne b">implements</code>装饰器只是在我们的<code class="fe nb nc nd ne b">HANDLED_FUNCTION</code>字典中创建一个numpy函数和一个<code class="fe nb nc nd ne b">func</code>函数之间的对应关系，这是我们的numpy函数版本。</li><li id="4b94" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la nx lj lk ll bi translated">第四，当使用作为物理实例的<code class="fe nb nc nd ne b">x</code>调用<code class="fe nb nc nd ne b">np.mean(x)</code>时，我们实现了numpy的mean来处理物理实例。它具有与<code class="fe nb nc nd ne b">np.mean</code>大致相同的签名，并执行以下操作:</li></ol><ul class=""><li id="e3a4" class="ld le iq kh b ki kj kl km ko lf ks lg kw lh la li lj lk ll bi translated">使用x的值计算数值平均值，<code class="fe nb nc nd ne b">x._value</code>，这是一个简单的数组。</li><li id="2782" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated">然后使用平均值作为值，输入的单位作为单位，创建一个新的物理实例。</li><li id="1a50" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated">最后，我们在那个函数上使用<code class="fe nb nc nd ne b">implements</code>装饰器。</li></ul><p id="3bad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么当我们调用<code class="fe nb nc nd ne b">np.mean(bmi)</code>时会发生什么呢？</p><p id="e17c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嗯，因为numpy无法计算平均值，正如我们在上面看到的，它检查<code class="fe nb nc nd ne b">bmi</code>是否有一个<code class="fe nb nc nd ne b">__array_function__</code>方法，并用在<code class="fe nb nc nd ne b">bmi</code>上使用的函数调用它，即<code class="fe nb nc nd ne b">np.mean</code> : <code class="fe nb nc nd ne b">bmi.__array_function__(np.mean, *args, **kwargs)</code>。</p><p id="59af" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于<code class="fe nb nc nd ne b">np.mean</code>已经在<code class="fe nb nc nd ne b">HANDELED_FUNCTIONS</code>中注册，我们用它来代替<em class="lb">来称呼<code class="fe nb nc nd ne b">np.mean</code>的我们版本</em>:这里<code class="fe nb nc nd ne b">HANDLED_FUNCTIONS[np.mean](*args, **kwargs)</code>相当于<code class="fe nb nc nd ne b">np_mean_for_physical(*args, **kwargs)</code>。</p><p id="ffd6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是如何让numpy的函数与您的自定义类一起工作。</p><p id="f2ed" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不幸的是，这并不完全正确。这个接口只适用于一些numpy函数，而不是所有的函数。</p><p id="866d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">还记得上面的函数列表吗？我们可以将它们分为两个子列表:常规的numpy函数和numpy通用函数——或简称为“ufuncs ”:</p><ul class=""><li id="10a8" class="ld le iq kh b ki kj kl km ko lf ks lg kw lh la li lj lk ll bi translated">数字功能:<code class="fe nb nc nd ne b">np.min</code>、<code class="fe nb nc nd ne b">np.max</code>、<code class="fe nb nc nd ne b">np.argmin</code>、<code class="fe nb nc nd ne b">np.argmax</code>、<code class="fe nb nc nd ne b">np.concatenate</code>、<code class="fe nb nc nd ne b">np.vstack.</code></li><li id="a320" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated">Numpy ufuncs : <code class="fe nb nc nd ne b">np.sin</code>、<code class="fe nb nc nd ne b">np.cos</code>、<code class="fe nb nc nd ne b">np.tan</code>、<code class="fe nb nc nd ne b">np.exp</code>、<code class="fe nb nc nd ne b">np.log</code>、<code class="fe nb nc nd ne b">np.log10</code>、<code class="fe nb nc nd ne b">np.add</code>、<code class="fe nb nc nd ne b">np.multiply</code>、<code class="fe nb nc nd ne b">np.divide</code>、<code class="fe nb nc nd ne b">np.floor</code>、<code class="fe nb nc nd ne b">np.ceil</code>、<code class="fe nb nc nd ne b">np.trunc</code></li></ul><p id="89eb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们看到了如何使用<code class="fe nb nc nd ne b">__array_function__</code>实现numpy函数支持。在下一篇文章中，我们将看到如何使用<code class="fe nb nc nd ne b">__array_ufunc__</code>接口添加对“ufuncs”的支持。</p><h1 id="9a1f" class="nh ls iq bd lt ni nj nk lw nl nm nn lz jw no jx mc jz np ka mf kc nq kd mi nr bi translated">总结一下:</h1><ul class=""><li id="25b2" class="ld le iq kh b ki ns kl nt ko ny ks nz kw oa la li lj lk ll bi translated">使用numpy数组的容器方法在于将数组设置为自定义类实例中的属性(与数组的子类化相反)。</li><li id="482e" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated">要让你的类使用numpy函数调用，比如<code class="fe nb nc nd ne b">np.mean(my_array_like_instance)</code>，你必须在你的类中实现<code class="fe nb nc nd ne b">__array_function__</code>接口。</li><li id="6701" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated">这基本上是通过在你的类中添加一个<code class="fe nb nc nd ne b">__array_function__</code>方法，编写你自己的包装器(就像我们对<code class="fe nb nc nd ne b">np_mean_for_physical</code>所做的那样)，并将它们链接在一起(就像我们对查找字典<code class="fe nb nc nd ne b">HANDLED_FUNCTIONS</code>所做的那样)。</li><li id="598d" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated">请注意，这只适用于“常规”numpy函数。对于numpy的“通用”函数，您也需要实现<code class="fe nb nc nd ne b">__array_ufunc__</code>接口。</li></ul><p id="59fb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个主题非常广泛，因此您应该阅读以下几个链接，以便更好地了解什么是最重要的:</p><ul class=""><li id="7ec6" class="ld le iq kh b ki kj kl km ko lf ks lg kw lh la li lj lk ll bi translated">集装箱进场:<a class="ae lc" href="https://numpy.org/doc/stable/user/basics.dispatch.html" rel="noopener ugc nofollow" target="_blank">https://numpy.org/doc/stable/user/basics.dispatch.html</a></li><li id="d9e8" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated"><code class="fe nb nc nd ne b">__array_function__</code>参考:<a class="ae lc" href="https://numpy.org/doc/stable/reference/arrays.classes.html#numpy.class.__array_function__" rel="noopener ugc nofollow" target="_blank">https://numpy . org/doc/stable/reference/arrays . classes . html # numpy . class . _ _ array _ function _ _</a></li><li id="5363" class="ld le iq kh b ki lm kl ln ko lo ks lp kw lq la li lj lk ll bi translated">ufuncs参考:<a class="ae lc" href="https://numpy.org/doc/stable/reference/ufuncs.html" rel="noopener ugc nofollow" target="_blank">https://numpy.org/doc/stable/reference/ufuncs.html</a></li></ul><p id="1f94" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以下是我们在本文中编写的完整代码:</p><figure class="mm mn mo mp gt mq"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="faf6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">干杯！</p></div></div>    
</body>
</html>