<html>
<head>
<title>Getting Started with Elasticsearch Query DSL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Elasticsearch查询DSL入门</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/getting-started-with-elasticsearch-query-dsl-c862c9d6cf7f?source=collection_archive---------1-----------------------#2021-08-02">https://towardsdatascience.com/getting-started-with-elasticsearch-query-dsl-c862c9d6cf7f?source=collection_archive---------1-----------------------#2021-08-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="77c9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Python Elasticsearch客户端，用特定领域语言编写Elasticsearch查询的实践指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/add53927e8dd5923787932e48b4d3005.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*34zSK9GQCVUEeAwp"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@christopher__burns?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯多佛·伯恩斯</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="058d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi lv translated">在这篇文章中，我将介绍弹性搜索中查询的基础知识。我们将看看如何在<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" rel="noopener ugc nofollow" target="_blank"> Elasticsearch领域特定语言</a> (DSL)中构建查询(例如，过滤器与查询上下文，以及相关性评分)，并在<a class="ae ky" href="https://elasticsearch-py.readthedocs.io/en/6.8.2/" rel="noopener ugc nofollow" target="_blank"> Python Elasticsearch客户端</a>中应用它们。(而且，如果DSL让您头晕目眩，请跳到本文的最后一节，在这里我们将介绍针对es运行SQL查询的基础知识)。这篇博文中使用的所有代码都可以在<a class="ae ky" href="https://github.com/ngoet/es_demo" rel="noopener ugc nofollow" target="_blank"> this GitHub repo </a>中找到。</p><h1 id="b3cf" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">入门指南</h1><p id="eaf1" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">对于这篇文章，我假设你熟悉ES的基础知识。我还假设您已经提供并部署了自己的Elasticsearch集群(要么“从头开始”，要么使用托管服务)，并且您已经将数据写入了索引。</p><p id="d214" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nb">要快速了解ES的基础知识以及如何使用Python提供集群和设置索引的说明，请查看我之前的文章</em> <a class="ae ky" rel="noopener" target="_blank" href="/creating-and-managing-elasticsearch-indices-with-python-f676ff1c8113"> <em class="nb">使用Python创建和管理弹性搜索索引</em> </a>。</p><div class="nc nd gp gr ne nf"><a rel="noopener follow" target="_blank" href="/creating-and-managing-elasticsearch-indices-with-python-f676ff1c8113"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">使用Python创建和管理弹性搜索索引</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">从CSV文件创建ES索引以及使用Python Elasticsearch管理数据的实践指南…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">towardsdatascience.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt ks nf"/></div></div></a></div><p id="7508" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于下面的例子，我将使用我在之前的文章中建立的<code class="fe nu nv nw nx b">neflix_movies</code>索引。这个指数是根据Kaggle 上的7787场网飞演出的数据构建的。原始数据是CSV格式的，包含网飞上可用的电影和电视剧的信息，包括元数据，如上映日期、片名和演员。我们的索引的映射定义如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="5ce1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种映射可以进一步改进，并没有针对磁盘使用进行优化，也没有针对搜索速度进行<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-search-speed.html" rel="noopener ugc nofollow" target="_blank">调整。然而，对于我们将在下面运行的查询来说，这已经足够了。</a></p><p id="d07c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nb">如果你想学习如何创建更好的针对磁盘使用优化的ES索引，请查看我之前关于</em> <a class="ae ky" rel="noopener" target="_blank" href="/optimising-disk-usage-in-elasticsearch-d7b4238808f7"> <em class="nb">优化弹性搜索中的磁盘使用</em> </a> <em class="nb">的帖子。</em></p><div class="nc nd gp gr ne nf"><a rel="noopener follow" target="_blank" href="/optimising-disk-usage-in-elasticsearch-d7b4238808f7"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">优化弹性搜索中的磁盘使用</h2><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">towardsdatascience.com</p></div></div><div class="no l"><div class="oa l nq nr ns no nt ks nf"/></div></div></a></div><h1 id="dd0d" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">DSL快速入门</h1><p id="71b9" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">在我们开始这篇博文的实践部分之前，让我们回顾一下从Elasticsearch查询数据的一些基础知识。ES search API接受使用基于JSON的<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" rel="noopener ugc nofollow" target="_blank"> Elasticsearch领域特定语言(DSL) </a>的查询。ES文档将DSL描述为查询的抽象语法树(AST ),由两种类型的子句组成:</p><ol class=""><li id="d9d5" class="ob oc it lb b lc ld lf lg li od lm oe lq of lu og oh oi oj bi translated"><strong class="lb iu">叶查询子句</strong>，查找特定字段中的特定值(如<code class="fe nu nv nw nx b">match</code>或<code class="fe nu nv nw nx b">range</code>)；和</li><li id="252a" class="ob oc it lb b lc ok lf ol li om lm on lq oo lu og oh oi oj bi translated"><strong class="lb iu">复合查询子句</strong>用于逻辑组合多个查询(如多叶或复合查询)或改变这些查询的行为。</li></ol><p id="e484" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当你运行一个针对你的索引(或多个索引)的查询时，ES <a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-filter-context.html#relevance-scores" rel="noopener ugc nofollow" target="_blank">通过一个代表匹配质量的<strong class="lb iu">相关性分数</strong>(一个浮点值)</a>(<code class="fe nu nv nw nx b">_score</code>字段显示其每次“命中”的值)。一个ES查询<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-filter-context.html" rel="noopener ugc nofollow" target="_blank">有一个查询和一个过滤上下文。</a>过滤器上下文——顾名思义——简单地过滤掉不符合语法条件的文档。然而，与bool上下文中的匹配不同，它不会影响相关性分数。</p><p id="e8e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看一个简单的查询示例，它有一个<strong class="lb iu">查询</strong>和一个<strong class="lb iu">过滤器</strong>上下文。下面的例子过滤发行年份(使用一个<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html" rel="noopener ugc nofollow" target="_blank">范围查询</a>，并在查询上下文中针对电影类型运行一个<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html" rel="noopener ugc nofollow" target="_blank">匹配查询</a>。</p><pre class="kj kk kl km gt op nx oq or aw os bi"><span id="6edb" class="ot mf it nx b gy ou ov l ow ox">{<br/>    "query": {<br/>        "bool": {<br/>            "must": [<br/>                {"match": {"type": "TV Movie"}},<br/>            ],<br/>            "filter": [<br/>                {"range": {"release_year": {"gte": 2021}}}<br/>            ]<br/>        }<br/>    }<br/>}</span></pre><p id="b1db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以直接使用我们的ES控制台(假设您使用的是基于云的平台，如<a class="ae ky" href="https://www.elastic.co" rel="noopener ugc nofollow" target="_blank">Elastic.co</a>、<a class="ae ky" href="https://bonsai.io" rel="noopener ugc nofollow" target="_blank"> Bonsai </a>或<a class="ae ky" href="https://aws.amazon.com/elasticsearch-service/" rel="noopener ugc nofollow" target="_blank">亚马逊Elasticsearch服务</a>)或通过<a class="ae ky" href="https://elasticsearch-py.readthedocs.io/en/6.8.2/" rel="noopener ugc nofollow" target="_blank"> Python Elasticsearch客户端</a>在我们的索引上运行这个查询。无论您使用客户端还是控制台，查询本身看起来都是一样的。在本文的剩余部分，我的例子将使用Python ES客户端和DSL。</p><p id="56bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了开始，我们首先设置ES客户端连接(更多细节，请参见<a class="ae ky" rel="noopener" target="_blank" href="/creating-and-managing-elasticsearch-indices-with-python-f676ff1c8113">我之前的博文</a>和<a class="ae ky" href="https://github.com/ngoet/es_demo" rel="noopener ugc nofollow" target="_blank">这个GitHub repo </a>):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="aff3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二步，我们定义并运行针对<code class="fe nu nv nw nx b">netflix_movies</code>索引的查询:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="85ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">代码末尾的print语句将标题和相关的相关性分数打印为元组。输出如下所示:</p><pre class="kj kk kl km gt op nx oq or aw os bi"><span id="126b" class="ot mf it nx b gy ou ov l ow ox">[<br/> ('Bling Empire', 0.96465576),<br/> ('Carmen Sandiego', 0.96465576),<br/> ('Cobra Kai', 0.96465576),<br/> ('Disenchantment', 0.96465576),<br/> ('Dream Home Makeover', 0.96465576),<br/> ("Gabby's Dollhouse", 0.96465576),<br/> ('Headspace Guide to Meditation', 0.96465576),<br/> ('Hilda', 0.96465576),<br/> ('History of Swear Words', 0.96465576),<br/> ('Inside the World’s Toughest Prisons', 0.96465576)<br/>]</span></pre><p id="8886" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，所有条目的相关性分数都是相同的:这是有意义的，因为所有这些条目对于<code class="fe nu nv nw nx b">type </code>(即“电视电影”)都具有完全相同的值。既然我们知道“TV Movie”是该字段可以取的值，我们也可以使用过滤器上下文，因为我们正在寻找那个<em class="nb">确切的值</em>。</p><p id="dda4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么什么时候应该使用过滤器或查询上下文呢？一般来说，过滤器更便宜，应该尽可能在任何时候使用(<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.12/query-filter-context.html" rel="noopener ugc nofollow" target="_blank"> ES自动缓存经常使用的过滤器以提高性能</a>)。它们用于搜索二进制案例(答案<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" rel="noopener ugc nofollow" target="_blank">明确为“是”或“否”</a>)和精确值(例如在搜索数值、特定范围或关键字时)。反过来，当结果可能不明确或用于全文搜索时(即当<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html" rel="noopener ugc nofollow" target="_blank">搜索已分析的文本字段</a>时)，应使用查询上下文。</p><p id="0019" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们带着何时使用过滤器和查询上下文的信息重新看看上面显示的查询:该查询适用于一系列短字段类型(<code class="fe nu nv nw nx b">release_year</code>)和关键字字段类型(<code class="fe nu nv nw nx b">type</code>)。对于后者，我们知道自己想要的确切价值(“电视剧”)。因此，编写查询的更好方法如下，重用范围过滤器，并对后者应用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.12/query-dsl-term-query.html" rel="noopener ugc nofollow" target="_blank">术语查询</a>(下面将详细介绍这种类型的查询)，并将两者放在“过滤器”上下文中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h1 id="b274" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">常见查询</h1><p id="9de9" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">现在我们已经介绍了搜索和DSL的基础知识，让我们先来看看几个基本的查询。</p><h2 id="4126" class="ot mf it bd mg oy oz dn mk pa pb dp mo li pc pd mq lm pe pf ms lq pg ph mu pi bi translated">比赛</h2><p id="b969" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">首先是“匹配”查询，这是全文搜索的<strong class="lb iu"> </strong> <a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.12/query-dsl-match-query.html" rel="noopener ugc nofollow" target="_blank">默认选项。假设我们正在寻找“纸牌屋”系列的元数据。因为ES在使用匹配查询时分析文本，所以如果我们使用默认值(DSL默认为“or”操作符)，它将返回标题中有“House”或“Cards”的任何节目。因此，我们将使用“and”运算符:</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="07c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该查询产生一个匹配项(一个文档):</p><pre class="kj kk kl km gt op nx oq or aw os bi"><span id="befd" class="ot mf it nx b gy ou ov l ow ox">{<br/>  "total": {<br/>    "value": 1,<br/>    "relation": "eq"<br/>  },<br/>  "max_score": 15.991642,<br/>  "hits": [<br/>    {<br/>      "_index": "netflix_movies",<br/>      "_type": "_doc",<br/>      "_id": "rWHgLHgBIp2yHscf16v-",<br/>      "_score": 15.991642,<br/>      "_source": {<br/>        "show_id": "s2833",<br/>        "type": "TV Show",<br/>        "title": "House of Cards",<br/>        "director": null,<br/>        "cast": "Kevin Spacey, Robin Wright, Kate Mara, Corey Stoll, Sakina Jaffrey, Kristen Connolly, Constance Zimmer, Sebastian Arcelus, Nathan Darrow, Sandrine Holt, Michel Gill, Elizabeth Norment, Mahershala Ali, Reg E. Cathey, Molly Parker, Derek Cecil, Elizabeth Marvel, Kim Dickens, Lars Mikkelsen, Michael Kelly, Joel Kinnaman, Campbell Scott, Patricia Clarkson, Neve Campbell",<br/>        "country": "United States",<br/>        "date_added": "November 2, 2018",<br/>        "release_year": 2018,<br/>        "rating": "TV-MA",<br/>        "duration": "6 Seasons",<br/>        "listed_in": "TV Dramas, TV Thrillers",<br/>        "description": "A ruthless politician will stop at nothing to conquer Washington, D.C., in this Emmy and Golden Globe-winning political drama."<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="daaf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个点击的相关性分数是<code class="fe nu nv nw nx b">15.991642</code>。乍一看，这似乎很奇怪。但是，请记住，相关性分数是没有限制的，它用于评估一个文档相对于匹配查询的所有其他文档的相关性。换句话说:分数表示在相同的搜索中，与相同查询的其他“命中”(文档)相比，文档与查询的相关程度。</p><h2 id="70b9" class="ot mf it bd mg oy oz dn mk pa pb dp mo li pc pd mq lm pe pf ms lq pg ph mu pi bi translated">术语查询</h2><p id="5d0d" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">术语查询用于“查找”字段与精确值匹配的文档<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html" rel="noopener ugc nofollow" target="_blank">。我们的索引中有许多<code class="fe nu nv nw nx b">keyword</code>字段，我们可以对其应用术语查询。下面的例子提取了五个文档，其中<code class="fe nu nv nw nx b">type</code>字段等于<code class="fe nu nv nw nx b">TV Show</code>(注意<code class="fe nu nv nw nx b">size</code>参数控制ES返回多少条记录，默认为10条):</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="5866" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">文本字段应该使用<em class="nb">而不是</em>术语查询。ES在分析过程中改变文本字段，<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html" rel="noopener ugc nofollow" target="_blank">标记文本，去掉标点符号，并将其转换成小写字母</a>。如果<code class="fe nu nv nw nx b">type</code>是一个<code class="fe nu nv nw nx b">text</code>字段而不是一个<code class="fe nu nv nw nx b">keyword</code>字段，上面显示的查询将不会返回结果，因为作为分析的一部分,<code class="fe nu nv nw nx b">“TV Show”</code>的任何实例都将被转换为<code class="fe nu nv nw nx b">["tv", "show"]</code>。</p><h2 id="b580" class="ot mf it bd mg oy oz dn mk pa pb dp mo li pc pd mq lm pe pf ms lq pg ph mu pi bi translated">范围</h2><p id="3539" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">在我们的“常见查询”系列中，最后但同样重要的是“范围查询”。顾名思义，范围查询用于<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html" rel="noopener ugc nofollow" target="_blank">查找特定字段的值落在定义的范围</a>内的任何文档。它可用于<code class="fe nu nv nw nx b">date</code>和数字字段类型。它也可以用于<code class="fe nu nv nw nx b">text</code>和关键字字段，只要您的集群设置<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html#query-dsl-allow-expensive-queries" rel="noopener ugc nofollow" target="_blank">允许昂贵的查询</a>(默认)。下面显示的查询对发行年份运行简单的范围查询，搜索2012年或更早发行的100部电影或电视节目:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h1 id="2036" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">(略多)复杂的查询</h1><p id="a83c" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">我倾向于使用几个更复杂的查询。在这一节中，我们将简要了解正则表达式、度量聚合和定制过滤器。</p><h2 id="8a25" class="ot mf it bd mg oy oz dn mk pa pb dp mo li pc pd mq lm pe pf ms lq pg ph mu pi bi translated">使用正则表达式</h2><p id="7611" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-regexp-query.html" rel="noopener ugc nofollow" target="_blank"> regexp查询</a>设计用于查找特定字段中的术语与正则表达式匹配的文档。下面的示例在我们的<code class="fe nu nv nw nx b">netflix_movies</code>索引中查找任何文档，其中<code class="fe nu nv nw nx b">title</code>字段包含部分由“war”组成的单词(例如war、warror、war、warm等)。):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="950a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Regexp查询可以区分大小写(使用<code class="fe nu nv nw nx b">case_insensitive</code>选项，默认设置为<code class="fe nu nv nw nx b">false</code>)。然而，<code class="fe nu nv nw nx b">title</code>是一个文本字段，其分析<em class="nb">未</em>被禁用。因此，我们可以预期<code class="fe nu nv nw nx b">title</code>字段中的术语已经被小写化了(除了别的以外，请参考前面的章节以获得更多关于“分析”的细节)。因此，考虑到我们当前的映射，启用或禁用区分大小写没有什么区别。</p><h2 id="d02a" class="ot mf it bd mg oy oz dn mk pa pb dp mo li pc pd mq lm pe pf ms lq pg ph mu pi bi translated">使用指标聚合检查数据</h2><p id="7c5d" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">ES聚合是探索数据的一种很好的方式，它们有三种风格<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" rel="noopener ugc nofollow" target="_blank">:度量、桶和管道。在这里，我们将看到一个来自指标，一个来自存储桶类别。</a></p><p id="0f98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们首先来看一下<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-stats-aggregation.html" rel="noopener ugc nofollow" target="_blank"> stats查询</a>(一个<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics.html" rel="noopener ugc nofollow" target="_blank">度量聚合</a>)，当您想要查看数字值的汇总统计信息(min、max、mean、sum)时，这个查询会很方便。例如，如果我们想快速查看<code class="fe nu nv nw nx b">release_year</code>在我们的数据中是如何分布的，我们可以运行以下查询:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="95d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于聚合，我们在查询中将<code class="fe nu nv nw nx b">size</code>参数设置为0。这意味着搜索API不会返回任何文档(如果您忽略这一点，<code class="fe nu nv nw nx b">hits</code>字段将包含文档)。该查询的响应为我们提供了整个文档中<code class="fe nu nv nw nx b">release_year</code>值的简单汇总统计数据(例如，最小值、最大值、平均值):</p><pre class="kj kk kl km gt op nx oq or aw os bi"><span id="9754" class="ot mf it nx b gy ou ov l ow ox">'{<br/>  "release_year_stats": {<br/>    "count": 7787,<br/>    "min": 1925.0,<br/>    "max": 2021.0,<br/>    "avg": 2013.932579940927,<br/>    "sum": 15682493.0<br/>  }<br/>}'</span></pre><p id="1c1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们转向第二个聚合查询，这一次来自<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html" rel="noopener ugc nofollow" target="_blank"> bucket聚合</a>家族。<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html" rel="noopener ugc nofollow" target="_blank">术语聚合</a>有助于快速了解不同类别的观察结果的可用性。例如，在我们的<code class="fe nu nv nw nx b">netflix_movies</code>索引中，您可能想要查看在任何给定年份有多少部电影上映，或者每种类型有多少部电影出现在数据集中。在DSL中，我们对前者的查询(每个发行年份的电影数量)如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="40d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个查询中有两件事值得强调。首先，我们在<code class="fe nu nv nw nx b">terms</code>对象中指定第二个<code class="fe nu nv nw nx b">size</code>参数，它控制返回多少个“术语桶”(在本例中是:5)。第二，我们按关键字(即发行年份)以升序对输出进行排序。该查询的输出应该如下所示:</p><pre class="kj kk kl km gt op nx oq or aw os bi"><span id="a052" class="ot mf it nx b gy ou ov l ow ox">{<br/>  "release_years": {<br/>    "doc_count_error_upper_bound": 0,<br/>    "sum_other_doc_count": 7775,<br/>    "buckets": [<br/>      {<br/>        "key": 1925,<br/>        "doc_count": 1<br/>      },<br/>      {<br/>        "key": 1942,<br/>        "doc_count": 2<br/>      },<br/>      {<br/>        "key": 1943,<br/>        "doc_count": 3<br/>      },<br/>      {<br/>        "key": 1944,<br/>        "doc_count": 3<br/>      },<br/>      {<br/>        "key": 1945,<br/>        "doc_count": 3<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="8ac1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们快速回顾一下这个输出。<code class="fe nu nv nw nx b">buckets</code>字段包括五个术语桶中每一个的文档计数(每个关键字一个对象)。反过来，<code class="fe nu nv nw nx b">sum_other_doc_count</code>是从输出中排除的桶的所有计数的总和。最后，<code class="fe nu nv nw nx b">doc_count_error_upper_bound</code>值反映了<a class="ae ky" href="http://doc_count_error_upper_bound" rel="noopener ugc nofollow" target="_blank">与桶聚集</a>相关联的误差。此时你可能会想:“错误，什么错误？”。ES在响应中报告了一个错误，因为术语聚合与近似。这源于这样一个事实，即文档分布在多个分片中，每个分片都有自己的有序术语列表，这些列表在聚合中组合在一起。</p><p id="f09f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">协调搜索过程的<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#_shard_size_3" rel="noopener ugc nofollow" target="_blank">节点请求等于</a> <code class="fe nu nv nw nx b"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#_shard_size_3" rel="noopener ugc nofollow" target="_blank">size</a></code>的多个术语桶。随后，来自这些碎片的结果被组合以产生最终的响应。因此，如果指定的<code class="fe nu nv nw nx b">size</code>小于唯一项的数量，我们可以预期出现错误的可能性会更大。在上面的例子中，我们有73个不同的<code class="fe nu nv nw nx b">release_year</code>值，所以我们可能想要更改<code class="fe nu nv nw nx b">size</code>参数(对于大量的术语桶，<code class="fe nu nv nw nx b">shard_size</code>也是如此，以解决<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#_shard_size_3" rel="noopener ugc nofollow" target="_blank">因增加</a> <code class="fe nu nv nw nx b"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#_shard_size_3" rel="noopener ugc nofollow" target="_blank">size</a></code>而产生的一些额外开销)。</p><h2 id="4fa0" class="ot mf it bd mg oy oz dn mk pa pb dp mo li pc pd mq lm pe pf ms lq pg ph mu pi bi translated">使用脚本查询自定义过滤器</h2><p id="cb82" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">我们最后的“复杂”查询:“脚本查询”。如果您想对索引中的文档使用自己设计的过滤器，可以使用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-script-query.html" rel="noopener ugc nofollow" target="_blank">脚本查询</a>。过滤器上下文中提供了脚本查询。在下面的例子中，我编写了一个简单的脚本来提取<code class="fe nu nv nw nx b">release_year</code>大于2018的文档(我们可以使用范围查询获得相同的结果，见上文)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="4279" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nu nv nw nx b">source</code>字段包含脚本，<code class="fe nu nv nw nx b">params</code>字段包含脚本使用的<code class="fe nu nv nw nx b">start_year</code>值。脚本查询的默认语言是“<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html" rel="noopener ugc nofollow" target="_blank">无痛</a>”(在<code class="fe nu nv nw nx b">lang</code>字段中指定)，但是其他语言也是可用的，包括<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-expression.html" rel="noopener ugc nofollow" target="_blank"> Lucene的表达式语言</a>和<a class="ae ky" href="https://mustache.github.io/mustache.5.html" rel="noopener ugc nofollow" target="_blank"> Mustache语言</a>。如果您有经常使用的定制脚本，您可以使用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting-using.html" rel="noopener ugc nofollow" target="_blank">端点在集群状态</a>上存储脚本，这样您可以检索它们以备后用。存储脚本<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-using.html" rel="noopener ugc nofollow" target="_blank">加快了搜索速度，因为它通常会减少编译所需的时间</a>。</p><h1 id="2344" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">使用SQL语法查询ES</h1><p id="9b43" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">对于SQL爱好者:您可以使用SQL语法来查询您的ES索引。该功能是<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-xpack.html" rel="noopener ugc nofollow" target="_blank"> X-Pack </a>的一部分，您可以使用它在基于云的es服务(如<a class="ae ky" href="https://aws.amazon.com/about-aws/whats-new/2019/05/amazon-elasticsearch-service-sql-support/" rel="noopener ugc nofollow" target="_blank"> AWS </a>或<a class="ae ky" href="https://www.elastic.co/what-is/elasticsearch-sql" rel="noopener ugc nofollow" target="_blank">Elastic.co</a>)的控制台中直接对您的ES索引执行SQL查询，或者使用Python Elasticsearch客户端。(注意这个<a class="ae ky" href="https://medium.com/r?url=https%3A%2F%2Fdocs.bonsai.io%2Farticle%2F135-plugins-on-bonsai" rel="noopener">不能在Bonsai上运行，因为X-Pack插件不包括在内，因为它需要一个用于商业目的的许可证</a>。因此，我在<a class="ae ky" href="https://www.elastic.co" rel="noopener ugc nofollow" target="_blank">Elastic.co</a>上运行了SQL translate API的以下API调用，它提供了14天的免费试用。</p><h2 id="ce4d" class="ot mf it bd mg oy oz dn mk pa pb dp mo li pc pd mq lm pe pf ms lq pg ph mu pi bi translated">将您的SQL语法转换成DSL</h2><p id="ba6a" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">如果您在Elasticsearch上工作，您可以使用SQL translate API来<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sql-translate.html" rel="noopener ugc nofollow" target="_blank">将SQL语法翻译成本地的Elasticsearch查询</a>。在控制台上，这就像在JSON文档中使用带有SQL语法的POST请求一样简单。例如，获取2015年或以后上映的网飞电影的标题列表的查询如下所示:</p><pre class="kj kk kl km gt op nx oq or aw os bi"><span id="e6e5" class="ot mf it nx b gy ou ov l ow ox">{"query": "SELECT title FROM netflix_movies WHERE release_year &gt;= 2015"}</span></pre><p id="402d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您在API控制台上的翻译端点(<code class="fe nu nv nw nx b">POST _sql/translate</code>)上使用POST请求发送该文档，它将返回本地ES查询(DSL)中的相应查询。对于我们的示例，产生的ES查询是:</p><pre class="kj kk kl km gt op nx oq or aw os bi"><span id="7f35" class="ot mf it nx b gy ou ov l ow ox">{<br/>  "sort": [<br/>    {<br/>      "_doc": {<br/>        "order": "asc"<br/>      }<br/>    }<br/>  ],<br/>  "query": {<br/>    "range": {<br/>      "release_year": {<br/>        "to": null,<br/>        "include_upper": false,<br/>        "boost": 1,<br/>        "from": 2015,<br/>        "include_lower": true<br/>      }<br/>    }<br/>  },<br/>  "_source": false,<br/>  "fields": [<br/>    {<br/>      "field": "title"<br/>    }<br/>  ],<br/>  "size": 1000<br/>}</span></pre><h2 id="a8af" class="ot mf it bd mg oy oz dn mk pa pb dp mo li pc pd mq lm pe pf ms lq pg ph mu pi bi translated">直接运行SQL查询</h2><p id="72ed" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">您也可以直接获得输出，完全跳过“翻译步骤”。如果您使用带有<code class="fe nu nv nw nx b">_sql?format=txt</code>的JSON文档发出POST请求，API会以一种格式良好的文本格式返回响应数据(对于JSON格式，使用<code class="fe nu nv nw nx b">_sql?format=json</code>):</p><pre class="kj kk kl km gt op nx oq or aw os bi"><span id="b550" class="ot mf it nx b gy ou ov l ow ox">title                                <br/>------------------------------------- <br/>Black Crows                                                                     Black Earth Rising                                                              Black Lightning                                                                 Black Man White Skin                                                            Black Mirror                                                                    Black Mirror: Bandersnatch                                                      Black Panther                                                                   Black Sea                                                                       Black Site Delta                                                                Black Snow<br/>...........</span></pre><p id="8b91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">类似地，您可以运行简单的<code class="fe nu nv nw nx b">GROUP BY</code>查询(假设您执行聚合的字段不是<code class="fe nu nv nw nx b">text</code>类型)。例如，以下查询将返回每个发行年份的电影数量(这里我将输出限制为前五年):</p><pre class="kj kk kl km gt op nx oq or aw os bi"><span id="d6fb" class="ot mf it nx b gy ou ov l ow ox">POST _sql?format=txt<br/>{"query": "SELECT release_year, COUNT(*) as n_entries FROM netflix_movies GROUP BY release_year LIMIT 5"}</span></pre><p id="6ec7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，输出的格式也很好:</p><pre class="kj kk kl km gt op nx oq or aw os bi"><span id="533f" class="ot mf it nx b gy ou ov l ow ox">release_year  |   n_entries    <br/>---------------+--------------- <br/>1925           |1               <br/>1942           |2               <br/>1943           |3               <br/>1944           |3               <br/>1945           |3</span></pre></div><div class="ab cl pj pk hx pl" role="separator"><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po"/></div><div class="im in io ip iq"><p id="1ce6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！我们现在已经回顾了DSL的基础知识，并运行了几个基本的和更复杂的查询。</p><p id="587e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读！</p></div><div class="ab cl pj pk hx pl" role="separator"><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po"/></div><div class="im in io ip iq"><div class="kj kk kl km gt nf"><a href="https://medium.com/@ndgoet/membership" rel="noopener follow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">用我的推荐链接加入媒体。</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">medium.com</p></div></div><div class="no l"><div class="pq l nq nr ns no nt ks nf"/></div></div></a></div></div><div class="ab cl pj pk hx pl" role="separator"><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po"/></div><div class="im in io ip iq"><p id="a3cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">如果你喜欢这篇文章，这里还有一些你可能喜欢的文章:</strong></p></div><div class="ab cl pj pk hx pl" role="separator"><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po"/></div><div class="im in io ip iq"><div class="kj kk kl km gt nf"><a rel="noopener follow" target="_blank" href="/four-things-you-need-to-master-to-get-started-with-elasticsearch-c51bed6ae99d"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">开始使用Elasticsearch需要掌握的四件事</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">弹性研究概念和原则的简明概述</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">towardsdatascience.com</p></div></div><div class="no l"><div class="pr l nq nr ns no nt ks nf"/></div></div></a></div><div class="nc nd gp gr ne nf"><a rel="noopener follow" target="_blank" href="/creating-and-managing-elasticsearch-indices-with-python-f676ff1c8113"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">使用Python创建和管理弹性搜索索引</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">从CSV文件创建ES索引以及使用Python Elasticsearch客户端管理数据的实践指南</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">towardsdatascience.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt ks nf"/></div></div></a></div><div class="nc nd gp gr ne nf"><a rel="noopener follow" target="_blank" href="/optimising-disk-usage-in-elasticsearch-d7b4238808f7"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">优化弹性搜索中的磁盘使用</h2><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">towardsdatascience.com</p></div></div><div class="no l"><div class="oa l nq nr ns no nt ks nf"/></div></div></a></div></div><div class="ab cl pj pk hx pl" role="separator"><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po pp"/><span class="pm bw bk pn po"/></div><div class="im in io ip iq"><p id="bba0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="nb">免责声明</em></strong><em class="nb">:“elastic search”是Elasticsearch BV的商标，在美国和其他国家注册。本文中对任何第三方服务和/或商标的描述和/或使用不应被视为对其各自权利持有人的认可。</em></p><p id="6c27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nb">请仔细阅读</em> <a class="ae ky" href="https://medium.com/@ndgoet/disclaimer-5ad928afc841" rel="noopener"> <em class="nb">本免责声明</em> </a> <em class="nb">中的任何内容后再依托</em> <a class="ae ky" href="/@ndgoet" rel="noopener ugc nofollow" target="_blank"> <em class="nb">我的Medium.com文章</em> </a> <em class="nb">。</em></p></div></div>    
</body>
</html>