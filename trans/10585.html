<html>
<head>
<title>Anatomy of a dbt project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">dbt项目剖析</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/anatomy-of-a-dbt-project-50e810abc695?source=collection_archive---------4-----------------------#2021-10-10">https://towardsdatascience.com/anatomy-of-a-dbt-project-50e810abc695?source=collection_archive---------4-----------------------#2021-10-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0125" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一些基本概念和项目结构可以帮助您开始dbt项目。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7818e84e1d90aee8079db7d6dbda7d75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1PfmQnADjrW73iep"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@barnimages?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">谷仓图片</a>拍摄</p></figure><p id="2195" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于非技术背景的分析师来说，一开始使用dbt可能会令人生畏。编写代码来配置一切需要一些时间来适应，尤其是如果您习惯于使用UI来设置一切。</p><p id="c4b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您考虑为您的团队使用dbt，或者刚刚开始使用dbt的团队，这篇文章有望帮助您了解项目结构和一些基本概念。我们将浏览下图中的大多数文件和文件夹。你可以在这里进行回购<a class="ae ky" href="https://github.com/dbt-labs/dbt-init/tree/master/starter-project" rel="noopener ugc nofollow" target="_blank">备案。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/b41d0a68793df2754f8a1a030a7f1e95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bgUI3LTLdY19EFRwSyZh1A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://github.com/dbt-labs/dbt-init/tree/master/starter-project" rel="noopener ugc nofollow" target="_blank"> dbt-init </a>项目。</p></figure><h1 id="8fa1" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">profiles.yml</h1><p id="8763" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">该文件包含dbt将用来连接到数据仓库的数据库连接。如果您在本地设置了dbt，那么您只需要担心这个文件。</p><p id="6813" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于该文件可能包含敏感信息，如项目名称和数据库凭据，因此它不在您的dbt项目中。默认情况下，文件创建在文件夹:<code class="fe mt mu mv mw b">~/.dbt/</code>中。</p><p id="880d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您从头开始您的项目，运行<code class="fe mt mu mv mw b">dbt init</code>将为您生成这个文件。如果没有，你可能需要在本地创建一个<code class="fe mt mu mv mw b">.dbt</code>文件夹和一个<code class="fe mt mu mv mw b">profiles.yml</code>文件。如果您不确定如何设置该文件，请遵循dbt <a class="ae ky" href="https://docs.getdbt.com/dbt-cli/configure-your-profile" rel="noopener ugc nofollow" target="_blank">文档</a>或联系回购所有者。</p><p id="9442" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您在本地处理多个项目，不同的项目名称(在<code class="fe mt mu mv mw b">dbt_project.yml</code>文件中配置)将允许您为其他项目设置不同的概要文件。</p><p id="9a72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了配置数据库连接，您还可以配置目标。目标是如何为不同的环境提供不同的配置。例如，当在本地开发时，您和您的团队可能希望在单独的数据集/数据库上工作。但是当部署到生产环境时，最好将所有表放在一个数据集/数据库中。默认目标是<code class="fe mt mu mv mw b">dev</code>。</p><h1 id="15ce" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">dbt_project.yml</h1><p id="e847" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">该文件是项目的主配置文件。如果您正在创建您的项目，请更改项目名称和概要文件名称(最好是相同的值)。此外，用新的项目名称替换<code class="fe mt mu mv mw b">models</code>部分的<code class="fe mt mu mv mw b">my_new_project</code>。</p><p id="16d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除非在模型级别被覆盖，否则此项目中的所有对象都将继承此处配置的设置。例如，您可以配置在<code class="fe mt mu mv mw b">dbt_project.yml</code>文件中将所有模型创建为表格。但是您可以进入其中一个模型并覆盖该设置来创建一个视图。</p><p id="705b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在哪里配置什么取决于您项目设置，但是遵循一个好的原则是DRY(不要重复)。对于应用于整个项目或特定文件夹的设置，请在此文件中定义。对于仅与一个型号相关的选项，请在那里进行配置。</p><p id="a9e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于设置的完整列表，你可以在这个文件中配置，查看<code class="fe mt mu mv mw b">dbt_project.yml</code> <a class="ae ky" href="https://docs.getdbt.com/reference/dbt_project.yml" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="63ed" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">模型</h1><p id="c674" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated"><code class="fe mt mu mv mw b">models</code>文件夹包含项目中的所有数据模型。在该文件夹中，您可以创建任何想要的文件夹结构。dbt <a class="ae ky" href="https://github.com/dbt-labs/corp/blob/master/dbt_style_guide.md" rel="noopener ugc nofollow" target="_blank">风格指南</a>中给出的推荐结构如下:</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="6d00" class="nb lx it mw b gy nc nd l ne nf">├── dbt_project.yml<br/>└── models<br/>    ├── marts<br/>    |   └── core<br/>    |       ├── intermediate<br/>    |       |   ├── intermediate.yml<br/>    |       |   ├── customers__unioned.sql<br/>    |       |   ├── customers__grouped.sql<br/>    |       └── core.yml<br/>    |       └── core.docs<br/>    |       └── dim_customers.sql<br/>    |       └── fct_orders.sql<br/>    └── staging<br/>        └── stripe<br/>            ├── base<br/>            |   ├── base__stripe_invoices.sql<br/>            ├── src_stripe.yml<br/>            ├── src_stripe.docs<br/>            ├── stg_stripe.yml<br/>            ├── stg_stripe__customers.sql<br/>            └── stg_stripe__invoices.sql</span></pre><p id="f678" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里，<code class="fe mt mu mv mw b">models</code>下面有<code class="fe mt mu mv mw b">marts</code>和<code class="fe mt mu mv mw b">staging</code>文件夹。不同的数据源在<code class="fe mt mu mv mw b">staging</code>下会有单独的文件夹(例如<code class="fe mt mu mv mw b">stripe</code>)。用例或部门在<code class="fe mt mu mv mw b">marts</code>下有不同的文件夹(例如<code class="fe mt mu mv mw b">core</code>或<code class="fe mt mu mv mw b">marketing</code>)。</p><p id="225d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意上面例子中的<code class="fe mt mu mv mw b">.yml</code>和<code class="fe mt mu mv mw b">.doc</code>文件。它们是您为模型定义元数据和文档的地方。您可以在<code class="fe mt mu mv mw b">dbt_project.yml</code>文件中包含所有内容，但是在这里定义它们要干净得多。</p><p id="49b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种结构允许您清晰地组织对象，并轻松地应用批量设置。</p><h1 id="64fa" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">数据</h1><p id="ea73" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">该文件夹包含将由dbt加载到数据库的所有手动数据。要将该文件夹中的<code class="fe mt mu mv mw b">.csv</code>文件加载到数据库，您必须运行<code class="fe mt mu mv mw b">dbt seed</code>命令。</p><p id="c05e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为这是一个受版本控制的存储库，所以不要将大文件或包含敏感信息的文件放在这里。定期更改的文件也不适合这种方法。适合<code class="fe mt mu mv mw b">dbt seed</code>的例子有年度预算、状态映射、类别映射等。</p><h1 id="aae1" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">宏指令</h1><p id="5275" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">dbt中的宏类似于excel中的函数。您可以在<code class="fe mt mu mv mw b">macros</code>文件夹中定义自定义函数，或者覆盖默认宏和宏包。<a class="ae ky" href="https://docs.getdbt.com/docs/building-a-dbt-project/jinja-macros" rel="noopener ugc nofollow" target="_blank">宏和Jinja模板</a>一起，给了你许多SQL所没有的功能。</p><p id="2a5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您可以对不同的目标使用控制结构(if语句和For循环)或不同的行为。您还可以抽象出复杂的SQL逻辑，使您的代码更具可读性。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="c37e" class="nb lx it mw b gy nc nd l ne nf">-- This is hard to read<br/>(amount / 100)::numeric(16, 2) as amount_usd</span><span id="fc48" class="nb lx it mw b gy ng nd l ne nf">-- This is much easier<br/>{{ cents_to_dollars('amount') }} as amount_usd</span></pre><h1 id="3a35" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">packages.yml</h1><p id="b813" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">dbt的一个优点是，您可以轻松地使用其他人制作的包。这样做可以节省你大量的时间，你也不必重新发明轮子。你可以在这里找到大多数dbt包<a class="ae ky" href="https://hub.getdbt.com/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="47ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要使用这些包，你需要在<code class="fe mt mu mv mw b">packages.yml</code>文件中定义它们。只需将如下内容添加到文件中。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="f8f6" class="nb lx it mw b gy nc nd l ne nf">packages:<br/>  - package: dbt-labs/dbt_utils<br/>    version: 0.7.3</span></pre><p id="4d63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在使用这些包之前，您必须运行<code class="fe mt mu mv mw b">dbt deps</code>来安装这些依赖项。之后，您可以使用cod中的包中的任何宏。</p><h1 id="5259" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">快照</h1><p id="335d" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">快照是一个dbt特性，用于捕获表在特定时间的状态。快照文件夹包含项目的所有快照模型，它必须与模型文件夹分开。</p><p id="a7c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其用例是为不支持变更数据捕获(CDC)的源构建渐变维度(SCD)表。例如，每次订单状态改变时，您的系统都会用新信息覆盖它。在这种情况下，我们无法知道这个秩序有什么历史地位。</p><p id="a7c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Snapshot提供了一个解决方案。如果您每天都捕获订单表，您可以保留订单状态随时间变化的历史记录。对于每个记录，dbt将确定它是否是最新的，并更新旧记录的有效期。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/fc9d16c0457874a02cf8260cf9a99aef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*UenQCtO0h2WLAWW5lK67DQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自dbt <a class="ae ky" href="https://docs.getdbt.com/docs/building-a-dbt-project/snapshots" rel="noopener ugc nofollow" target="_blank">文档</a></p></figure><p id="7bf2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击阅读更多关于dbt快照功能<a class="ae ky" href="https://docs.getdbt.com/docs/building-a-dbt-project/snapshots" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h1 id="75ca" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">试验</h1><p id="ad74" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">dbt项目中的大多数测试都是在<code class="fe mt mu mv mw b">models</code>下的<code class="fe mt mu mv mw b">.yml</code>文件中定义的。这些是使用预制或定制宏的测试。这些测试可以应用于模型或列。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/a6d1eef67d4434cd80921dd79e536573.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*65vBHGQB1CXpJMrtRwsY3A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自dbt <a class="ae ky" href="https://docs.getdbt.com/docs/building-a-dbt-project/tests" rel="noopener ugc nofollow" target="_blank">文档</a></p></figure><p id="ce5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的例子中，当你运行<code class="fe mt mu mv mw b">dbt test</code>时，dbt会检查<code class="fe mt mu mv mw b">orer_id</code>是否为<code class="fe mt mu mv mw b">unique</code>和<code class="fe mt mu mv mw b">not_null</code>，状态是否在定义的值内，并且<code class="fe mt mu mv mw b">customer_id</code>的每条记录都可以链接到<code class="fe mt mu mv mw b">customers</code>表中的一条记录。</p><p id="357d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，有时这些测试是不够的，您需要编写自定义的测试。在这种情况下，您可以将那些定制测试存储在<code class="fe mt mu mv mw b">tests</code>文件夹中。dbt将评估SQL语句。如果没有行返回，测试将通过，如果至少有一行或多行返回，测试将失败。</p><h1 id="2ec4" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="728f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在本文中，我们已经介绍了典型dbt项目的一些基本概念和项目结构。我希望这对你来说是一个迷人的新旅程的开始。</p><p id="8d71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">快乐的learning✌️</p></div></div>    
</body>
</html>