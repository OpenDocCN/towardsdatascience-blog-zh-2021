<html>
<head>
<title>Version control your database Part 2: migrations and seeds for table relations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据库的版本控制第2部分:表关系的迁移和种子</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/version-control-your-database-part-2-migrations-and-seeds-for-table-relations-d4fb185d95d8?source=collection_archive---------29-----------------------#2021-05-23">https://towardsdatascience.com/version-control-your-database-part-2-migrations-and-seeds-for-table-relations-d4fb185d95d8?source=collection_archive---------29-----------------------#2021-05-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8202" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如果你喜欢啤酒、效率或建模高性能数据库，请阅读本文</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/277779bb1b534ecff28c0e7bac257bef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gZ-dzexclDxQa1ak"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们数据库中的所有表格都整齐地链接在一起，并植入了数据(图片由<a class="ae ky" href="https://unsplash.com/@clintadair" rel="noopener ugc nofollow" target="_blank">克林特·王茂林</a>在<a class="ae ky" href="https://unsplash.com/photos/BW0vK-FA3eg" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供)</p></figure><p id="e05c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<a class="ae ky" href="https://mikehuls.medium.com/version-control-your-database-part-1-creating-migrations-and-seeding-992d86c90170" rel="noopener">的上一部分</a>中，我们已经设置了迁移工具，对其进行了配置，创建了一些迁移，甚至在新迁移的表中植入了一些数据。如果你不知道我在说什么，请查看这篇文章。在这一部分中，我们将着重于向表中添加更多的功能。您可以在这里找到我们将在本文<a class="ae ky" href="https://github.com/mike-huls/beersnobv2" rel="noopener ugc nofollow" target="_blank">中构建的库。当您阅读完这一部分后，您将能够:</a></p><ul class=""><li id="d404" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">在事务内迁移</li><li id="81a2" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">创建表之间的关联</li><li id="e5ae" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">设置具有类型和约束的列</li><li id="8cab" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在新创建的数据库中植入数据</li><li id="520c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">只需按一下按钮，就能建立一个功能齐全的专业数据库，给别人留下深刻印象</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="0407" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">0.目标和准备</h1><p id="958b" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我们的目标是为一个名为BeerSnob的网站创建一个数据库结构；一个专门为喝优质啤酒的人建立的网站。它允许用户分享关于他们在特定场所喝的啤酒的评论；在提供价格和口味信息的同时，对场地和啤酒进行评级。为了实现我们的目标，我们必须有一个可以存储以下信息的数据库:</p><ul class=""><li id="f81a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">用户(撰写评论的人)</li><li id="6afe" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">啤酒(名称、类型)</li><li id="526f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">国家、城市和比赛场地(出售啤酒的地方)</li><li id="e18a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">报告:一个用户在某个地方写一些关于啤酒的信息(比如价格、评级和评论)</li></ul><p id="dce1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">报告是我们设计中最重要的部分。查看下面的概述，在一个漂亮的数据库模型中捕获这些需求:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/8635caeb9930d16f271d1c3dbb87780e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HQ1zt74iBjPRmNx2u6iSRA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">BeerSnobs数据库模型图</p></figure><p id="7ea4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，我们将国家、城市和地点分别放在不同的表格中，这可能有点过分。目前我们并不真的需要它，但如果说这些年来我学到了什么，那就是需求很少保持不变。在未来，我们希望增加可能需要这样设置的功能。以这种方式构建我们的表，我们保证了未来发展的灵活性。</p><p id="cf7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从这个结构来看，报告似乎是最重要的表；它指定了由用户给出的某个地点的啤酒的价格、等级和评论。这是用户在网站上将寻找的东西！</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="7d3b" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">1.设置</h1><p id="7ed9" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我们将在前面的<a class="ae ky" href="https://mikehuls.medium.com/version-control-your-database-part-1-creating-migrations-and-seeding-992d86c90170" rel="noopener">部分</a>中编写的代码的基础上进一步构建。如您所知，我们已经创建了2个迁移:</p><ol class=""><li id="3b25" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu no mb mc md bi translated">创建一个名为“app”的模式</li><li id="9ad1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">在“app”模式中创建一个名为“countries”的表</li></ol><p id="84ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想继续编码，从<a class="ae ky" href="https://github.com/Muls/beersnob" rel="noopener ugc nofollow" target="_blank">这里</a>拉出代码。</p><h1 id="9990" class="mq mr it bd ms mt np mv mw mx nq mz na jz nr ka nc kc ns kd ne kf nt kg ng nh bi translated">2.添加用户和啤酒表</h1><p id="3875" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我们将以创建国家表的相同方式创建用户和啤酒。为了防止这篇文章变得太长，我将跳过重复。检查这个库中<a class="ae ky" href="https://github.com/mike-huls/BeerSnobV3" rel="noopener ugc nofollow" target="_blank">的代码。</a></p><h1 id="b4cd" class="mq mr it bd ms mt np mv mw mx nq mz na jz nr ka nc kc ns kd ne kf nt kg ng nh bi translated">3.为具有外键的表创建到另一个表的迁移</h1><p id="bb10" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我们已经定义了相当多的表。现在让我们开始将表连接在一起。首先我们将讨论为什么我们应该使用外键，然后我们将创建一个实现外键的迁移。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/01337aaeb3b677b971e8de32bd5fa87d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l1fpGtQSGUfWWa4nOdeWFg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">让我们将这些表格链接在一起(图片由<a class="ae ky" href="https://www.pexels.com/@travis-saylor-271738" rel="noopener ugc nofollow" target="_blank"> Travis Saylor </a>在<a class="ae ky" href="https://www.pexels.com/photo/cyclone-fence-in-shallow-photography-951408/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄)</p></figure><h2 id="82a2" class="nv mr it bd ms nw nx dn mw ny nz dp na li oa ob nc lm oc od ne lq oe of ng og bi translated">为什么要使用外键？</h2><p id="516a" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">外键子表中的列到父表中的主键。在我们的例子中，我们将把城市表中的CountryId列连接到国家表中的Id列。外键对于保持数据库的整洁和快速非常方便。他们通过防止不正确的输入来做到这一点(不能输入不存在countryId的城市)。它还使您能够控制当父表中的引用值被更新或删除时将采取的操作。如果一个国家被删除，外键可以确保属于被删除国家的所有城市也被删除。</p><h2 id="6249" class="nv mr it bd ms nw nx dn mw ny nz dp na li oa ob nc lm oc od ne lq oe of ng og bi translated">创建迁移</h2><p id="45c0" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">现在让我们开始创建一个通过外键将两个表链接在一起的迁移；城市餐桌。首先，我们将使用<code class="fe oh oi oj ok b"> npx sequelize-cli migration:create --name create_city</code>生成一个新的迁移。我们将如下定义迁移:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="da4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这段代码中有几件有趣的事情:</p><ol class=""><li id="ee31" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu no mb mc md bi translated">我们用引用创建CityId。我们将在第1部分中定义的tableModel_countries表中的Id列作为目标。这将创建一个外键。</li><li id="cf09" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">我们设置了一些列默认值(新日期()用于创建和修改)。当你没有传递一个值时，它默认为这里设置的值。</li><li id="0600" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">我们在Id和Name列上创建come索引</li><li id="ea84" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">我们在一个事务中完成所有这些。例如，如果添加索引失败，它也会回滚到创建表。这样我们保证要么一切都失败，要么一切都成功。点击了解更多交易信息<a class="ae ky" href="https://mikehuls.medium.com/sql-rolling-back-statements-with-transactions-81937811e7a7" rel="noopener">。</a></li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/acabb8f447a127b93e2290c94604fe8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*AkeMPSmK3HjDjIarejS6-w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们新做的PK，FK和指数</p></figure><p id="8f91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这次迁移中，我们创建了包含5列的城市表，一个主键(蓝色箭头)，一个外键(绿色箭头)和两个索引(橙色箭头)。记住，迁移是独立于数据库的；这是非常强大的东西！</p><h1 id="ed17" class="mq mr it bd ms mt np mv mw mx nq mz na jz nr ka nc kc ns kd ne kf nt kg ng nh bi translated">4.添加场馆表</h1><p id="625a" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">这与城市表非常相似。查看<a class="ae ky" href="https://github.com/mike-huls/BeerSnobV3" rel="noopener ugc nofollow" target="_blank">库</a>中的代码以了解细节。</p><h1 id="ee78" class="mq mr it bd ms mt np mv mw mx nq mz na jz nr ka nc kc ns kd ne kf nt kg ng nh bi translated">5.添加报告表</h1><p id="e839" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">这是一切汇集的地方；我们必须真正注意这里！我们必须创建一个表，其中的外键指向另外3个表。让我们开始吧:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/f2ec2bfa59e4f9df698a33389bf5e678.png" data-original-src="https://miro.medium.com/v2/resize:fit:618/format:webp/1*zVq-VnSBXGr82etfNVUmaA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">更有PK，FK和指数</p></figure><p id="fca1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们已经成功地创建了带有<strong class="lb iu">绿色</strong>外键、<strong class="lb iu">蓝色</strong>主键和<strong class="lb iu">橙色索引的表。</strong></p><h1 id="299d" class="mq mr it bd ms mt np mv mw mx nq mz na jz nr ka nc kc ns kd ne kf nt kg ng nh bi translated">6.删除/添加列</h1><p id="13e3" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">迁移不仅在设置表时很重要；它们也可以在数据库生产时使用。在BeerSnob中，我们希望进行迁移，从“countries”表中删除“Capital”列。这无关紧要。在下面的迁移中，我们定义了如何进行和撤消:</p><pre class="kj kk kl km gt op ok oq or aw os bi"><span id="c144" class="nv mr it ok b gy ot ou l ov ow">'use strict';<br/>let tableModel = { schema: 'app', tableName: 'countries' };<br/>module.exports = {<br/>  up: async (queryInterface, Sequelize) =&gt; {<br/>    await queryInterface.removeColumn(tableModel, 'Capital')<br/>},<br/>down: async (queryInterface, Sequelize) =&gt; {<br/>    await queryInterface.addColumn(tableModel, 'Capital', {<br/>     allowNull: true, type: Sequelize.STRING });<br/> }<br/>};</span></pre><p id="0a3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在迁移中，您可以看到queryInterface是如何删除和添加列的。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="e933" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">7.使用我们的模型→播种一些数据</h1><p id="4d20" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我们创建了表，设置了外键，完成了索引；我们的数据库模型创建完成了！让我们插入一些数据，这样我们就可以检查是否一切正常。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/55016296eadad9a2706aab0718cb6fbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BqwQP0Sg43pSIbarR2qKIw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">播种会将一些默认数据放入我们的数据库中，如管理帐户(图片由<a class="ae ky" href="https://www.pexels.com/@binyaminmellish" rel="noopener ugc nofollow" target="_blank"> Binyamin Mellish </a>在<a class="ae ky" href="https://www.pexels.com/photo/man-planting-plant-169523/" rel="noopener ugc nofollow" target="_blank"> Pexels </a>上提供)</p></figure><h2 id="63d9" class="nv mr it bd ms nw nx dn mw ny nz dp na li oa ob nc lm oc od ne lq oe of ng og bi translated">处理用户数据</h2><p id="7c5b" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">用户将向我们发送一个包，其中包含一个或多个(或很多，如果他有一个良好的夜晚)报告。每个报告都链接到用户配置文件(用户表)、啤酒表中的特定记录和地点。在网站和数据库之间将有一个API来处理数据包。如果用户报告一种尚不存在的啤酒，那么API应该首先在Beers表中创建一条记录，并在将记录写入报告时使用新创建的啤酒的Id列。在<a class="ae ky" href="https://mikehuls.medium.com/build-a-real-life-professional-api-with-an-orm-part-1-8fce4d480d59" rel="noopener">这篇文章</a>中，我们将研究API是如何做到这一点的。现在我们用种子来模拟它。</p><h2 id="7924" class="nv mr it bd ms nw nx dn mw ny nz dp na li oa ob nc lm oc od ne lq oe of ng og bi translated">插入种子数据</h2><p id="f002" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">首先，我们将为所有的表插入一条记录。我不会在本文中详细讨论每一个种子，但是你可以在这里的库<a class="ae ky" href="https://github.com/mike-huls/beersnobv2/tree/main/seeders" rel="noopener ugc nofollow" target="_blank">中查看它们。我将在下面提供一个例子，说明我是如何植入报表的，这是我们最重要的表。首次运行<code class="fe oh oi oj ok b">npx sequelize-cli seed:create --name seed_reports</code>。迁移编码如下:</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="930a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相当简单！唯一困难的是获得正确的VenueId、BeerId和UserID，但这是API的工作。在这篇文章中我们不要担心它。</p><h2 id="92b9" class="nv mr it bd ms nw nx dn mw ny nz dp na li oa ob nc lm oc od ne lq oe of ng og bi translated">实践中的外键</h2><p id="1ea1" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">查看<code class="fe oh oi oj ok b">app.reports</code>表；您将看到我们在种子文件中定义的三条记录。想象一下当一个场馆关闭时。我们不能对不存在的场馆进行报道！这就是外键的用武之地。请记住，父表中的记录链接到子表中的相关记录。因为我们已经删除了[onDelete: CASCADE]，所以删除Venues表中的记录会导致删除reports表中的相关记录。通过执行<code class="fe oh oi oj ok b">DELETE FROM app.venues WHERE “Id” = 2;</code>来尝试一下，然后再次检查报告表！</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="dd12" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="7898" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在本文中，我们在第一部分的基础上构建。我们对它进行了大量升级，增加了一组完美的链接表，包括索引、主键、默认值和其他约束。我们已经走了很长的路，但更多的升级等待着我们。查看<a class="ae ky" href="https://mikehuls.medium.com/build-a-real-life-professional-api-with-an-orm-part-1-8fce4d480d59" rel="noopener">这篇文章</a>，了解我们如何通过构建一个与数据库通信的API来允许访问数据库数据，而无需编写一行SQL！<a class="ae ky" href="http://mikehuls.medium.com" rel="noopener">关注我</a>了解更多改进。</p><p id="5c62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="bd8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">附注:在https://github.com/mike-huls/beersnobv2查看完整的项目</p><p id="b467" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page的缩写）又及:比如我正在做的事？<a class="ae ky" href="https://mikehuls.medium.com/" rel="noopener">跟我来</a>！</p></div></div>    
</body>
</html>