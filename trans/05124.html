<html>
<head>
<title>Calculating Building Density in R with OSM data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用OSM数据计算建筑密度</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/calculating-building-density-in-r-with-osm-data-e9d85c701e19?source=collection_archive---------23-----------------------#2021-05-05">https://towardsdatascience.com/calculating-building-density-in-r-with-osm-data-e9d85c701e19?source=collection_archive---------23-----------------------#2021-05-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/b8902b1500d382cc253b2da2f5003fd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*hlAKYTy5dAWsh4wIAR7dcQ.png"/></div></figure><div class=""/><h1 id="119a" class="ju jv ix bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">介绍</h1><p id="fe3d" class="pw-post-body-paragraph ks kt ix ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">OpenStreetMaps是一个很好的空间数据源。大多数通用编程语言都有从OSM下载数据的包。</p><p id="b78c" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">在本教程中，我将展示如何使用R的osmdata包下载建筑数据，执行密度分析，并使用ggplot绘制，以及交互使用tmap。</p><p id="c629" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">这需要一些空间数据结构的知识。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div></figure><h1 id="380e" class="ju jv ix bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">获取数据</h1><p id="3edd" class="pw-post-body-paragraph ks kt ix ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">第一步需要使用osmdata从OSM api下载数据。首先，我需要为OSM设置一个边界框来搜索数据。接下来，我将下载用于制作choropleth地图的行政边界。最后，我将为定义的边界框下载建筑数据。</p><h1 id="e4b7" class="ju jv ix bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设置搜索区域</h1><p id="1baa" class="pw-post-body-paragraph ks kt ix ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我将在土耳其的伊兹密尔市搜索数据。为了定义我的搜索，我将使用<code class="fe mb mc md me b">getbb</code>命令。该命令将位置名称作为字符串，并返回由OSM定义的边界框。也可以返回一个多边形的边界框，这很有用，因为我想搜索由行政边界定义的建筑物。</p><p id="f955" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">因为该函数返回一个矩阵，所以您可以使用自己的多边形来定义OSM <code class="fe mb mc md me b">opq</code>查找(如下)，但是确保数据的CRS是EPSG:3857是很重要的。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">获取边界多边形</p></figure><h1 id="86bb" class="ju jv ix bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">检索边界线</h1><p id="886c" class="pw-post-body-paragraph ks kt ix ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在这个项目中，我正在寻找伊兹密尔的街区边界。因为各国的行政级别界限并不统一，所以可能需要进行一些研究来确定需要什么样的行政级别。幸运的是，他有一个有用的工具，可以让你在交互式地图中找到OSM的边界。</p><p id="56d0" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">地区名称旁边的数字表示OSM的行政级别。在我的例子中，我在8级寻找界限。我可以使用<code class="fe mb mc md me b">osmdata</code>请求特性传递这个信息，它是<a class="ae mj" href="https://wiki.openstreetmap.org/wiki/API" rel="noopener ugc nofollow" target="_blank"> OSM API </a>的包装器。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">检索OSM边界线</p></figure><p id="1d0c" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">(注意:OSM有更多可用的地图功能，可以使用右键<a class="ae mj" href="https://wiki.openstreetmap.org/wiki/Map_features" rel="noopener ugc nofollow" target="_blank">键:值对</a>进行查询。)</p><p id="4a20" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">该函数返回一个osmdata对象，这是一个<code class="fe mb mc md me b">sf</code>数据帧的列表。每个数据帧由不同的几何类型组成，这意味着返回的对象可能很大。为了得到正确的数据，你需要知道你在寻找哪种几何图形。</p><p id="734e" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">在这种情况下，我需要的形状是多多边形几何类型。OSM查询最终会返回大型对象。为了保留一些空闲空间，我将删除多余的数据帧。我还会清理一些数据。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">清理边界数据</p></figure><p id="27fd" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">现在我想检查一下我是否有正确的界限。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div></figure><figure class="lv lw lx ly gt is gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mk"><img src="../Images/611551064f9f0b5aac0e75640d3122d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Hk4MrlhpgYbW7Bxp.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">原始边界多边形的OSM边界线</p></figure><p id="02c6" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">看起来不错，但是它也返回了所有外围区域的边界，因为它们可能落在边界多边形线上。这是我以后可以处理的事情。</p><h1 id="7909" class="ju jv ix bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">检索建筑</h1><p id="41f9" class="pw-post-body-paragraph ks kt ix ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">使用与上面相同的过程，查询OSM原始边界多边形:<code class="fe mb mc md me b">iz_bbox</code>内的所有建筑物。建筑物多边形对象将比我的边界对象大100倍，所以我将再次去掉多余的数据。这一次我将保持多边形sf对象。</p><p id="9fd1" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">然后我会画出结果。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div></figure><figure class="lv lw lx ly gt is gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mk"><img src="../Images/75ace6f388d729d9528a1133b0fc1072.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XmPl62RtOD9NQtqH.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">在边界多边形上打印建筑多边形</p></figure><p id="abfc" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">返回的建筑物并不真正遵循任何多边形的边界，所以现在我将做一些空间修剪。</p><h1 id="81b0" class="ju jv ix bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">剪裁点数据</h1><p id="ec1b" class="pw-post-body-paragraph ks kt ix ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">为了过滤掉所有的外围建筑，我需要将它们作为点来计算，这可以通过找到它们的质心来完成。我将使用建筑质心创建一个新的数据框。在此之前，我想计算所有建筑物的面积，这样数据就可以与新创建的数据框一起使用。从现在开始，我不再需要建筑多边形了。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="45d7" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">我还需要创建一个多边形几何图形，以过滤外围建筑。我可以用原来的边界框<code class="fe mb mc md me b">iz_bbox</code>来做这件事。但是，因为这个对象是一个矩阵，我需要把它转换成一个sf对象。这可以通过使用<code class="fe mb mc md me b">sf_headers::sf_polygon</code>来完成。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div></figure><figure class="lv lw lx ly gt is gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mk"><img src="../Images/a41c7e244e4788fcfd977541e058bfe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r6MZfgggXKwSjsco.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">红色的多边形是目标区域，我可以使用这个多边形来裁剪建筑数据</p></figure><p id="6ad7" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">现在我有了一个可以过滤点的多边形。首先，我必须创建一个允许我过滤的数据框架。将<code class="fe mb mc md me b">st_join</code>连接变量设置为<code class="fe mb mc md me b">st_within</code>将给出一个列，指示一个点是否在多边形数据框内。列<code class="fe mb mc md me b">id</code>被创建，1表示一个点落在多边形内。我将策划检查结果。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div></figure><figure class="lv lw lx ly gt is gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mk"><img src="../Images/3d4b388f314d1c862f68731c4adb674d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r57DUO1cxJjfuaAX.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">将质心构建为边界多边形内的点</p></figure><p id="9a2a" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">它工作了，所以现在我将过滤正确的点，然后从<code class="fe mb mc md me b">iz_polys</code>数据帧创建一个新的数据帧，但是使用过滤的点。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="7acb" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">使用更精细的数据框架，我可以对每个地区内所有建筑的总面积进行汇总和求和。我将创建一个最终的数据框，其中包含总建筑面积以及地区多边形的总面积。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="ec63" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">现在我将使用<code class="fe mb mc md me b">tmap</code>创建一个漂亮的交互式地图。</p><figure class="lv lw lx ly gt is"><div class="bz fp l di"><div class="lz ma l"/></div></figure><figure class="lv lw lx ly gt is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/b8902b1500d382cc253b2da2f5003fd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*hlAKYTy5dAWsh4wIAR7dcQ.png"/></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">互动图截图。看这里的实物:<a class="ae mj" href="https://greggsaldutti.netlify.app/post/2021-05-05-calculating-building-density-in-r-with-osm-data/" rel="noopener ugc nofollow" target="_blank">https://greggsaldutti . netlify . app/post/2021-05-05-calculating-building-density-in-r-with-osm-data/</a></p></figure><h1 id="ce22" class="ju jv ix bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论</h1><p id="c97c" class="pw-post-body-paragraph ks kt ix ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这里我们有一张建筑的面积密度图，以占总土地面积的百分比来表示。当你有很多数据要处理，或者需要以编程方式访问数据时，r是一个很好的工具。其他程序，如QGIS，可能对用户更友好，但是R给你更多的控制，也能制作漂亮的地图。</p><p id="e5b8" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">注意:这篇文章基于<a class="ae mj" href="https://mattherman.info/blog/point-in-poly/" rel="noopener ugc nofollow" target="_blank"> Matt Herman关于纽约树木的文章</a>，以及这个<a class="ae mj" href="https://sustainability-gis.readthedocs.io/en/latest/lessons/L1/intro-to-python-geostack.html" rel="noopener ugc nofollow" target="_blank">使用Python的伟大开源GIS课程</a>。</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><p id="027f" class="pw-post-body-paragraph ks kt ix ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated"><em class="mw">原载于2021年5月5日</em><a class="ae mj" href="https://greggsaldutti.netlify.app/post/2021-05-05-calculating-building-density-in-r-with-osm-data/" rel="noopener ugc nofollow" target="_blank"><em class="mw">https://greggsaldutti . net lify . app</em></a><em class="mw">。</em></p></div></div>    
</body>
</html>