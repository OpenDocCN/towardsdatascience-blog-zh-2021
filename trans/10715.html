<html>
<head>
<title>Getting Started with R Shiny</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">R Shiny入门</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/getting-started-with-r-shiny-821eb0328e73?source=collection_archive---------4-----------------------#2021-10-15">https://towardsdatascience.com/getting-started-with-r-shiny-821eb0328e73?source=collection_archive---------4-----------------------#2021-10-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="37af" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">向成为一名闪亮的专家迈出第一步</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/400bf6882d5a6146059be8375a05d185.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mpyrgqwMjfclV2oN1U2VIA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@lukechesser?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">卢克·切瑟</a>在<a class="ae kv" href="https://unsplash.com/s/photos/analysis?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="4264" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">R闪亮简介</h1><p id="14a7" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Shiny是一个R包，它允许程序员在R中构建web应用程序。对于像我这样发现用Java构建GUI应用程序非常困难的人来说，Shiny让它变得容易多了。</p><p id="5b56" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这篇博客文章将让你用工作示例直接构建闪亮的应用程序。首先，确保你安装了闪亮的软件包。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="c69e" class="mu kx iq mq b gy mv mw l mx my">install.packages("shiny")</span></pre><h1 id="5cf8" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">闪亮的应用程序结构</h1><p id="f6a4" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">和R文件一样，闪亮的应用也以<em class="mz">结尾。r分机。</em>app结构由三部分组成，分别是:</p><ol class=""><li id="6d1e" class="na nb iq lq b lr mk lu ml lx nc mb nd mf ne mj nf ng nh ni bi translated">一个用户界面对象<strong class="lq ir"> (ui) </strong></li><li id="7b58" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">服务器功能</li><li id="4829" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">对shinyApp的函数调用</li></ol><p id="4de6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">用户界面(<code class="fe no np nq mq b">ui</code>)对象用于管理应用程序的外观和布局，如单选按钮、面板和选择框。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="16f2" class="mu kx iq mq b gy mv mw l mx my"><em class="mz"># Define UI for app </em><br/>ui &lt;- fluidPage(<br/><br/>  <em class="mz"># App title ----</em><br/>  titlePanel("!"),<br/><br/>  <em class="mz"># Sidebar layout with input and output definitions ----</em><br/>  sidebarLayout(<br/><br/>    <em class="mz"># Sidebar panel for inputs </em><br/>    sidebarPanel(<br/><br/>     <br/><br/>    )</span><span id="90aa" class="mu kx iq mq b gy nr mw l mx my"><em class="mz"># Allow user to select input for a y-axis variable from drop-down</em><br/>       selectInput("y_varb", label="Y-axis variable",choices=names(data)[c(-1,-3,-4)]),</span><span id="1c9b" class="mu kx iq mq b gy nr mw l mx my"><em class="mz"># Output: Plot</em><br/>      <!-- -->("plot", dblclick = "plot_reset")</span><span id="fe76" class="mu kx iq mq b gy nr mw l mx my">)</span></pre><p id="c9d1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe no np nq mq b">server</code>函数包含构建应用程序所需的信息。例如，这包括生成图或表以及对用户点击做出反应的指令。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="9109" class="mu kx iq mq b gy mv mw l mx my"><em class="mz"># Define server logic here ----</em><br/>server &lt;- <strong class="mq ir">function</strong>(input, output) {<br/><br/> <br/>  <em class="mz"># 1. It is "reactive" and therefore updates x-variable based on y-        variable selection</em></span><span id="fb64" class="mu kx iq mq b gy nr mw l mx my">  <em class="mz"># 2. Its output type is a plot</em><br/>  output$distPlot &lt;- renderPlot({<br/><br/>   <!-- --> remaining &lt;- reactive({<br/>    names(data)[c(-1,-3,-4,-match(input$y_varb,names(data)))]<br/>  })<br/>  <br/>  observeEvent(remaining(),{<br/>    choices &lt;- remaining()<br/>    updateSelectInput(session = getDefaultReactiveDomain(),inputId = "x_varb", choices = choices)<br/>  })<br/><br/>}</span><span id="0844" class="mu kx iq mq b gy nr mw l mx my">output$plot &lt;- renderPlot({<br/>    #ADD YOUR GGPLOT CODE HERE<br/>    subset_data&lt;-data[1:input$sample_sz,]<br/>    ggplot(subset_data, aes_string(input$x_varb, input$y_varb))+<br/>      geom_point(aes_string(colour=input$cat_colour))+<br/>      geom_smooth(method="lm",formula=input$formula)</span><span id="7861" class="mu kx iq mq b gy nr mw l mx my">}, res = 96)<br/>}</span></pre><p id="ade2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后，<code class="fe no np nq mq b">shinyApp</code>函数基于UI/服务器对构建闪亮的应用程序对象。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="975f" class="mu kx iq mq b gy mv mw l mx my">library(shiny)<br/><em class="mz"># Build shiny object<br/></em>shinyApp(ui = ui, server = server)<br/><em class="mz"># Call to run the application</em><br/>runApp("my_app")</span></pre><h1 id="8e50" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">什么是反应性？</h1><p id="8fe5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">反应性就是把用户输入和应用输出联系起来；以便Shiny应用程序中的显示可以根据用户的输入或选择进行动态更新。</p><h1 id="3566" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">反应式编程的构建模块</h1><h2 id="e575" class="mu kx iq bd ky ns nt dn lc nu nv dp lg lx nw nx li mb ny nz lk mf oa ob lm oc bi translated"><strong class="ak">输入</strong></h2><p id="82e2" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">传递给<code class="fe no np nq mq b">shinyServer</code>函数的<code class="fe no np nq mq b">input</code>对象允许用户访问应用程序的输入字段。它是一个类似列表的对象，包含从浏览器发送的所有输入数据，根据输入ID命名。</p><p id="8cba" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">与典型的列表不同，输入对象是只读的。如果您试图修改服务器函数内部的输入，您将会得到一个错误。输入只能由用户设置。这是通过创建一个反应表达式来完成的，其中一个普通表达式被传递到<code class="fe no np nq mq b">reactive</code>。要从输入中读取数据，您必须处于由像<code class="fe no np nq mq b">renderText()</code>或<code class="fe no np nq mq b">reactive().</code>这样的函数创建的反应上下文中</p><h2 id="35a4" class="mu kx iq bd ky ns nt dn lc nu nv dp lg lx nw nx li mb ny nz lk mf oa ob lm oc bi translated">输出</h2><p id="7bc9" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">为了允许在应用程序中查看反应值或输入，需要将它们分配给<code class="fe no np nq mq b">output</code>对象。和<code class="fe no np nq mq b">input</code>对象一样，它也是一个类似列表的对象。它通常与类似<code class="fe no np nq mq b">renderTable.</code>的<code class="fe no np nq mq b">render</code>功能一起工作</p><p id="fbe2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe no np nq mq b">render</code>功能执行以下两个操作:</p><ol class=""><li id="8aa0" class="na nb iq lq b lr mk lu ml lx nc mb nd mf ne mj nf ng nh ni bi translated">它设置了一个反应上下文，用于自动将输入与输出关联起来。</li><li id="7688" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">它将R代码输出转换为HTML代码，以便在应用程序上显示。</li></ol><h2 id="01ba" class="mu kx iq bd ky ns nt dn lc nu nv dp lg lx nw nx li mb ny nz lk mf oa ob lm oc bi translated">反应式表达</h2><p id="61cb" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">反应式表达式用于将应用程序中的代码分割成相当大的代码块，这不仅可以减少代码重复，还可以避免重新计算。</p><p id="1603" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在下面的例子中，反应代码接收来自用户的四个输入，然后用于输出独立样本t检验的结果。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="66b2" class="mu kx iq mq b gy mv mw l mx my">server &lt;- function(input, output) {</span><span id="36aa" class="mu kx iq mq b gy nr mw l mx my">x1 &lt;- reactive(rnorm(input$n1, input$mean1, input$sd1))</span><span id="ab44" class="mu kx iq mq b gy nr mw l mx my">x2 &lt;- reactive(rnorm(input$n2, input$mean2, input$sd2))</span><span id="6347" class="mu kx iq mq b gy nr mw l mx my">output$ttest &lt;- renderPrint({</span><span id="e298" class="mu kx iq mq b gy nr mw l mx my">t.test(x1(), x2())</span><span id="2b91" class="mu kx iq mq b gy nr mw l mx my">})</span><span id="f0dd" class="mu kx iq mq b gy nr mw l mx my">}</span></pre><h1 id="d24d" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">闪亮的应用示例</h1><p id="2600" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在，我们知道一些基础知识，让我们建立一些应用程序。</p><h2 id="81d7" class="mu kx iq bd ky ns nt dn lc nu nv dp lg lx nw nx li mb ny nz lk mf oa ob lm oc bi translated">应用一</h2><p id="bdcd" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">该应用程序使用一个虚拟数据集，其中包括三个连续变量。对应用程序的要求如下:</p><ol class=""><li id="24dc" class="na nb iq lq b lr mk lu ml lx nc mb nd mf ne mj nf ng nh ni bi translated">在数据集中三个连续变量中的两个之间生成散点图，其中第一个变量不能相对于自身绘制。</li><li id="d738" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">用户可以选择x和y变量进行绘图</li><li id="7d46" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">用户可以选择绘图公式(“y~x”，“y~poly(x，2)”，“y~log(x)”)。</li><li id="a83b" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">选择的分类变量用于给散点图中的点着色</li><li id="b604" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">用户可以选择行数(样本大小)，范围从1到1，000，用于绘图。</li></ol><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="b853" class="mu kx iq mq b gy mv mw l mx my"><em class="mz">#Load libraries</em><br/>library(shiny)<br/>library(ggplot2)</span><span id="47cd" class="mu kx iq mq b gy nr mw l mx my"><strong class="mq ir"><em class="mz">#Create dummy dataset</em></strong><br/>k&lt;-1000<br/>set.seed(999)<br/>data&lt;-data.frame(id=1:k)<br/>data$gest.age&lt;-round(rnorm(k,34,.5),1)<br/>data$gender&lt;-factor(rbinom(k,1,.5),labels=c("female","male"))<br/>z =  -1.5+((((data$gest.age-mean(data$gest.age)))/sd(data$gest.age))*-1.5)<br/>pr = 1/(1+exp(-z))<br/>data$mat.smoke = factor(rbinom(k,1,pr))<br/>data$bwt&lt;- round(-3+data$gest.age*0.15+<br/>                   ((as.numeric(data$mat.smoke)-1)*-.1)+<br/>                   ((as.numeric(data$mat.smoke)-1))*((data$gest.age*-0.12))+<br/>                   (((as.numeric(data$mat.smoke)-1))*(4))+<br/>                   ((as.numeric(data$gender)-1)*.2)+rnorm(k,0,0.1),3)<br/>data$mat.bmi&lt;-round((122+((data$bwt*10)+((data$bwt^8)*2))/200)+<br/>                      rnorm(k,0,1.5)+(data$gest.age*-3),1)</span><span id="c756" class="mu kx iq mq b gy nr mw l mx my">rm(z, pr, k)</span><span id="51ea" class="mu kx iq mq b gy nr mw l mx my"><strong class="mq ir"><em class="mz">#Define UI</em></strong><br/>ui &lt;- fluidPage(<br/>  <br/>  <br/><strong class="mq ir"><em class="mz">  #1. Select 1 of 3 continuous variables as y-variable and x-variable</em></strong><br/>  selectInput("y_varb", label="Y-axis variable",choices=names(data)[c(-1,-3,-4)]),<br/>  selectInput("x_varb", label="X-axis variable", choices=NULL), </span><span id="1689" class="mu kx iq mq b gy nr mw l mx my">  <strong class="mq ir"><em class="mz">#2. Colour points using categorical variable (1 of 4 options)</em></strong><br/>  selectInput("cat_colour", label="Select Categorical variable", choices=names(data)[c(-1,-2,-5,-6)]), </span><span id="120f" class="mu kx iq mq b gy nr mw l mx my"> <strong class="mq ir"><em class="mz"> #3. Select sample size</em></strong><br/>  selectInput("sample_sz", label = "Select sample size", choices = c(1:1000)),<br/>  #4. Three different types  of linear regression plots<br/>  selectInput("formula", label="Formula", choices=c("y~x", "y~poly(x,2)", "y~log(x)")),<br/>  #5. Reset plot output after each selection<br/>  plotOutput("plot", dblclick = "plot_reset")<br/>  <br/>)<br/>server &lt;- function(input, output) {<br/> <br/>  <strong class="mq ir"><em class="mz">#1. Register the y-variable selected, the remaining variables are now options for x-variable</em></strong><br/>  remaining &lt;- reactive({<br/>    names(data)[c(-1,-3,-4,-match(input$y_varb,names(data)))]<br/>  })<br/>  <br/>  observeEvent(remaining(),{<br/>    choices &lt;- remaining()<br/>    updateSelectInput(session = getDefaultReactiveDomain(),inputId = "x_varb", choices = choices)<br/>  })<br/>  <br/>  <br/>  output$plot &lt;- renderPlot({<br/>    <strong class="mq ir"><em class="mz">#Produce scatter plot</em></strong><br/>    subset_data&lt;-data[1:input$sample_sz,]<br/>    ggplot(subset_data, aes_string(input$x_varb, input$y_varb))+<br/>      geom_point(aes_string(colour=input$cat_colour))+<br/>      geom_smooth(method="lm",formula=input$formula)</span><span id="a471" class="mu kx iq mq b gy nr mw l mx my">}, res = 96)<br/>}</span><span id="fef4" class="mu kx iq mq b gy nr mw l mx my"><strong class="mq ir"><em class="mz"># Run the application </em></strong><br/>shinyApp(ui = ui, server = server)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi od"><img src="../Images/75e5943e24f38654f981a6dde92c93b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:714/format:webp/1*ccpzE1GVG7hgD3hAhTbD2A.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图1:用户必须从5个不同的输入中进行选择</p></figure><p id="2c90" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一旦用户选择了输入，就会生成下面的散点图。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/54c44d9d6c9eea223f1e6156cd0ef572.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pHRroV_tuB8O3EFui1xTdw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图2:应用一的输出图</p></figure><p id="8d1d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这就是你的第一个web应用程序。然而，让我们进一步分解代码。</p><p id="21c6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir"> App一解释</strong></p><p id="caca" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">功能<code class="fe no np nq mq b">selectInput</code>用于显示下拉菜单，供用户选择绘图变量、散点图中各点的着色变量以及样本大小。</p><p id="be25" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在<code class="fe no np nq mq b">server</code>函数中，基于用户对y变量的选择，用户对x变量的选择被更新。<code class="fe no np nq mq b">observeEvent</code>函数用于响应事件执行动作。在这个例子中，它更新了可以为x轴选择的x变量列表；因此不能在y轴和x轴上绘制同一个变量。</p><p id="6799" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后使用函数<code class="fe no np nq mq b">renderPlot</code>获取所有输入，x变量、y变量、分类变量、样本大小和公式，以生成或“呈现”一个图。</p><p id="5555" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这就是你的第一个闪亮的应用程序。</p><p id="6cf9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，如果我们希望下拉菜单是一个滑块。您可以通过在中添加以下代码片段来修改代码。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="97f8" class="mu kx iq mq b gy mv mw l mx my">ui &lt;- fluidPage(<br/>  <br/> <br/>  #3. Select sample size<br/>  # numericInput("sample_sz", "Input sample size", 10000),<br/>  sliderInput(inputId = "sample_sz",<br/>              label = "Select sample size:",<br/>              min = 1,<br/>              max = 10000,<br/>             value = 1)<br/>)</span></pre><p id="3634" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">输出将类似于</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/da19fca4c3e9b4dc2202b32f395fb086.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VE5u4CYah3KlysyQokDZJg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图App One的输出显示了样本大小的滑块</p></figure><p id="e227" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，让我们进入下一个稍微复杂一点的例子。</p><h2 id="fe5e" class="mu kx iq bd ky ns nt dn lc nu nv dp lg lx nw nx li mb ny nz lk mf oa ob lm oc bi translated">应用二</h2><p id="5517" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在这个应用程序中，我们正在查看一个数据集，该数据集显示了新冠肺炎感染导致的五种威胁生命的后果。我们希望该应用程序能够做到以下几点:</p><ol class=""><li id="5f69" class="na nb iq lq b lr mk lu ml lx nc mb nd mf ne mj nf ng nh ni bi translated">允许用户从五个结果中选择一个作为输入</li><li id="2f05" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">通过森林地块中选定的结果比较不同的县</li><li id="df09" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">如果用户在图中选择了一个县，那么应该生成另一个森林图，显示所选国家的所有五个结果。</li><li id="f1bf" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">显示缺少值的错误消息。</li></ol><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="cbb3" class="mu kx iq mq b gy mv mw l mx my">#Load libraries<br/>library(shiny)<br/>library(ggplot2)<br/>library(exactci)</span><span id="07b4" class="mu kx iq mq b gy nr mw l mx my">#import the data and restrict the data to variables and patients of interest<br/><br/>patient.data&lt;-read.csv("Synthea_patient_covid.csv", na.strings = "")<br/>cons.data&lt;-read.csv("Synthea_conditions_covid.csv", na.strings = "")<br/>data&lt;-merge(cons.data, patient.data)<br/>data&lt;-data[which(data$covid_status==1),] <br/>data&lt;-data[,c(12,14,65,96,165,194)]</span><span id="0d3a" class="mu kx iq mq b gy nr mw l mx my">#Get the state average for each outcome<br/>state.average&lt;-apply(data[,-6],MARGIN=2,FUN=mean)</span><span id="1fb3" class="mu kx iq mq b gy nr mw l mx my">#Make better names for the outcomes<br/>names&lt;-c("pulmonary embolism", "respiratory failure", "dyspnea", "hypoxemia", "sepsis")</span><span id="3c34" class="mu kx iq mq b gy nr mw l mx my">#Calculate and aggregate the obs and exp by outcome and county<br/>data$sample.size&lt;-1<br/>list&lt;-list()<br/>for (i in 1:5) {<br/>  list[[i]]&lt;-cbind(outcome=rep(names[i],length(unique(data$COUNTY))),<br/>                   aggregate(data[,i]~COUNTY, sum,data=data),<br/>                   exp=round(aggregate(sample.size~COUNTY, sum,data=data)[,2]<br/>                             *state.average[i],2))<br/>}<br/>plot.data&lt;-do.call(rbind,list)<br/>names(plot.data)[3]&lt;-"obs"</span><span id="643f" class="mu kx iq mq b gy nr mw l mx my">#Lastly, obtain the smr (called est), lci and uci for each row<br/>#Add confidence limits<br/>plot.data$est&lt;-NA<br/>plot.data$lci&lt;-NA<br/>plot.data$uci&lt;-NA<br/>#Calculate the confidence intervals for each row with a for loop and add them to the plot.data<br/>for (i in 1:nrow(plot.data)){<br/>  plot.data[i,5]&lt;-as.numeric(poisson.exact(plot.data[i,3],plot.data[i,4],<br/>                                           tsmethod = "central")$estimate)<br/>  plot.data[i,6]&lt;-as.numeric(poisson.exact(plot.data[i,3],plot.data[i,4],<br/>                                           tsmethod = "central")$conf.int[1])<br/>  plot.data[i,7]&lt;-as.numeric(poisson.exact(plot.data[i,3],plot.data[i,4],<br/>                                           tsmethod = "central")$conf.int[2])<br/>}</span><span id="dd87" class="mu kx iq mq b gy nr mw l mx my"># Define UI for application <br/>ui &lt;- fluidPage(<br/>  selectInput("outcome_var", label="Outcome",unique(plot.data$outcome)),<br/>  plotOutput("plot", click = "plot_click"),<br/>  plotOutput("plot2")<br/>)<br/>server &lt;- function(input, output) {<br/>  <br/>  output$plot &lt;- renderPlot({</span><span id="7694" class="mu kx iq mq b gy nr mw l mx my">#Output error message for missing values<br/>    validate(<br/>      need( nrow(plot.data) &gt; 0, "Data insufficient for plot")<br/>    )<br/>    ggplot(subset(plot.data,outcome==input$outcome_var), aes(x = COUNTY,y = est, ymin = pmax(0.25,lci), <br/>                               ymax = pmin(2.25,uci))) +<br/>      geom_pointrange()+<br/>      geom_hline(yintercept =1, linetype=2)+<br/>      coord_flip() +<br/>      xlab("")+ ylab("SMR (95% Confidence Interval)")+<br/>      theme(legend.position="none")+ ylim(0.25, 2.25)<br/>  }, res = 96)<br/>  <br/>  #Output error message for missing values<br/>  #modify this plot so it's the same forest plot as above but shows all outcomes for the selected county<br/>  <br/>  output$plot2 &lt;- renderPlot({</span><span id="8dc0" class="mu kx iq mq b gy nr mw l mx my">validate(<br/>      need( nrow(plot.data) &gt; 0, "Data insufficient for plot as it contains a missing value")<br/>    )<br/>    #Output error message for trying to round a value when it doesn't exist/missing<br/>    validate(<br/>      need( as.numeric(input$plot_click$y), "Non-numeric y-value selected")<br/>    )<br/>    <br/>    <br/>    forestp_data&lt;-plot.data[which(plot.data$COUNTY==names(table(plot.data$COUNTY))[round(input$plot_click$y,0)]),] <br/>    ggplot(forestp_data, aes(x = outcome,y = est, ymin = pmax(0.25,lci), ymax = pmin(2.25,uci))) +<br/>      geom_pointrange()+<br/>      geom_hline(yintercept =1, linetype=2)+<br/>      coord_flip() +<br/>      xlab("")+ ylab("SMR (95% Confidence Interval)")+<br/>      theme(legend.position="none")+ ylim(0.25, 2.25)<br/>  })  <br/>  <br/>}</span><span id="020d" class="mu kx iq mq b gy nr mw l mx my"># Run the application <br/>shinyApp(ui = ui, server = server)</span></pre><p id="7a4c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir"> App二解说</strong></p><p id="9aa8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在这个应用程序中，像App One一样，用户从下拉框中选择一个结果。这产生了一个森林地块。这个森林图的计算是在闪亮的用户界面之外完成的。这个应用程序中的棘手之处是构建一个反应性的第二个图，以响应用户在第一个图中单击的county。</p><p id="b885" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这种反应发生在使用以下代码行的服务器函数中</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="bc62" class="mu kx iq mq b gy mv mw l mx my">plot.data[which(plot.data$COUNTY==names(table(plot.data$COUNTY))[round(input$plot_click$y,0)]),]</span></pre><p id="fa10" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在这里，我们检查选择了哪个县，以便显示所有五个结果的第二个森林图。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/b7682a797d5a1dadd377491d8112f35a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J11ky4eAr4OPl0xJ7cHJKw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图App 2中的第一个森林图是基于选择的结果生成的</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/341a7fceaf803eecb21a171d6b965af2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*88mQET7MP5GiEY2PTC6Jgg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图5:单击给定县的第一个森林图，生成下面的第二个图，显示所选县的所有五个结果</p></figure><p id="55d8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在应用程序中，使用<code class="fe no np nq mq b">validate</code>功能显示一条错误消息，如果有数据丢失，则会显示一条由以下语法导致的错误:</p><p id="97c1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe no np nq mq b">[round(input$plot_click$y,0)],]</code></p><h2 id="4ee2" class="mu kx iq bd ky ns nt dn lc nu nv dp lg lx nw nx li mb ny nz lk mf oa ob lm oc bi translated">应用三</h2><p id="8c02" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">最终的web应用程序的目标是允许用户绘制数据集中变量之间的关系。一些变量是分类的，而另一些是连续的。当绘制两个连续变量时，用户应该只能在散点图上绘制它们。当选择了一个连续变量和一个分类变量时，用户应该只能绘制箱线图。用户不应该能够用两个分类变量绘图。根据用户的选择，应用程序应该一次只显示一个图。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="768b" class="mu kx iq mq b gy mv mw l mx my">#Load libraries<br/>library(shiny)<br/>library(ggplot2)</span><span id="91ef" class="mu kx iq mq b gy nr mw l mx my">#import data<br/>setwd("C:/Users/User/Desktop/Synthea")<br/>patient.data&lt;-read.csv("Synthea_patient_covid.csv", na.strings = "")<br/>obs.data&lt;-read.csv("Synthea_observations_covid.csv", na.strings = "")</span><span id="80c5" class="mu kx iq mq b gy nr mw l mx my">patient.data$dob&lt;-as.Date(patient.data$BIRTHDATE, tryFormats = "%d/%m/%Y")<br/>patient.data$enc.date&lt;-as.Date(patient.data$DATE, tryFormats = "%d/%m/%Y")<br/>patient.data$age&lt;-as.numeric((patient.data$enc.date-patient.data$dob)/365.25)<br/>data&lt;-merge(obs.data, patient.data)<br/>data&lt;-na.omit(data[,c(4,5,10:12,20,24,32,18,15,23,31,33,48:51,60)])<br/>names(data)&lt;-substr(names(data),1,10)<br/>data$covid_stat&lt;-as.factor(data$covid_stat)<br/>data$dead&lt;-as.factor(data$dead)</span><span id="8aa6" class="mu kx iq mq b gy nr mw l mx my"># Define UI for application <br/>ui &lt;- fluidPage(<br/>  #1. Select 1 of many continuous variables as y-variable <br/>  selectInput("y_varb", label="Y-axis variable",choices=names(data)[c(-1,-2,-14,-15,-16,-17)]),<br/>  <br/>  #2 Select any variable in dataset as x-variable<br/>  selectInput("x_varb", label="X-axis variable", choices=names(data)),<br/>  <br/>  <br/>  #3. Reset plot1 output after each selection<br/>  plotOutput("plot", dblclick = "plot_reset")</span><span id="ad8d" class="mu kx iq mq b gy nr mw l mx my">)<br/>server &lt;- function(input, output) {<br/>  <br/>  remaining &lt;- reactive({<br/>    names(data)[-match(input$y_varb,names(data))]<br/>  })<br/>  <br/>  observeEvent(remaining(),{<br/>    choices &lt;- remaining()<br/>    updateSelectInput(session = getDefaultReactiveDomain(),inputId = "x_varb", choices = choices)<br/>  })<br/>  <br/>  output$plot &lt;- renderPlot({</span><span id="7dcb" class="mu kx iq mq b gy nr mw l mx my">if ( is.numeric(data[[input$x_varb]]) ) {<br/>      ggplot(data, aes_string(input$x_varb, input$y_varb)) + geom_point()  <br/>    } else {<br/>      ggplot(data, aes_string(input$x_varb, input$y_varb)) + stat_boxplot()<br/>    }</span><span id="f955" class="mu kx iq mq b gy nr mw l mx my">})<br/>    <br/>   <br/>}</span><span id="9459" class="mu kx iq mq b gy nr mw l mx my"># Run the application <br/>shinyApp(ui = ui, server = server)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/a73db7f1a665e005daf227b5f9b9056b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yd-IWBgj9GHFL2U1Wi8tkQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图6:选择分类变量和连续变量时显示的箱线图</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/1773245298574383bde3b75e650d46e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BQgI1OzBRk4mC4yUiQ0aJg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图7:如果选择了两个连续变量，则显示散点图</p></figure><p id="874c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir"> App三解说</strong></p><p id="d640" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这个应用程序中的巧妙之处在于使用了<code class="fe no np nq mq b">renderPlot</code>中的if-else条件，因此只能选择两种类型的图(散点图或箱线图)中的一种。此外，当你想检查<code class="fe no np nq mq b">input$x_varb</code>的类时，使用双方括号(list)是必需的，<code class="fe no np nq mq b">data[[input$x_varb]],</code>否则输出将总是字符。</p><h1 id="22f0" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="c10e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在，你有了三个简单的应用程序。让我们快速回顾一下这篇博客文章的内容。</p><ul class=""><li id="f7b8" class="na nb iq lq b lr mk lu ml lx nc mb nd mf ne mj ok ng nh ni bi translated">一个闪亮的应用程序的结构</li><li id="3968" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj ok ng nh ni bi translated">连接输入和输出</li><li id="0cae" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj ok ng nh ni bi translated">使用reactive()和observeEvent创建动态用户界面</li><li id="8239" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj ok ng nh ni bi translated">使用验证显示错误消息</li></ul></div></div>    
</body>
</html>