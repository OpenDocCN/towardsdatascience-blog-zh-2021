<html>
<head>
<title>How to Manipulate a Pandas Dataframe in SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在SQL中操作熊猫数据帧</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-manipulate-a-pandas-dataframe-in-sql-7d1a1503f47?source=collection_archive---------13-----------------------#2021-08-03">https://towardsdatascience.com/how-to-manipulate-a-pandas-dataframe-in-sql-7d1a1503f47?source=collection_archive---------13-----------------------#2021-08-03</a></blockquote><div><div class="fc ik il im in io"/><div class="ip iq ir is it"><h2 id="f62b" class="iu iv iw bd b dl ix iy iz ja jb jc dk jd translated" aria-label="kicker paragraph">数据操作</h2><div class=""/><div class=""><h2 id="6177" class="pw-subtitle-paragraph kc jf iw bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">这是一个现成的代码，包含一些使用SQL查询操作Python Pandas数据框架的技巧。</h2></div><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gi gj ku"><img src="../Images/db1543c817a1d5746130c52e4690ac50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ygcZPN0lnl_melnc"/></div></div><p class="lg lh gk gi gj li lj bd b be z dk translated">迈克尔·泽兹奇在<a class="ae lk" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="acbe" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">在本教程中，我展示了一些使用SQL查询操作Python Pandas数据帧的技巧。具体来说，我涵盖以下主题:</p><ul class=""><li id="3292" class="mh mi iw ln b lo lp lr ls lu mj ly mk mc ml mg mm mn mo mp bi translated">缺失值(移除和替换)</li><li id="ab61" class="mh mi iw ln b lo mq lr mr lu ms ly mt mc mu mg mm mn mo mp bi translated">数据帧排序</li><li id="cc94" class="mh mi iw ln b lo mq lr mr lu ms ly mt mc mu mg mm mn mo mp bi translated">删除重复项</li><li id="eddf" class="mh mi iw ln b lo mq lr mr lu ms ly mt mc mu mg mm mn mo mp bi translated">合并两个数据框架(并集和交集)</li></ul><p id="1b1e" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">为了通过SQL查询来查询Pandas数据帧，我使用了<code class="fe mv mw mx my b">sqldf</code> Python库，可以通过下面的命令安装这个库:<code class="fe mv mw mx my b">pip install sqldf</code>。</p><h1 id="4f30" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">加载数据集</h1><p id="6f22" class="pw-post-body-paragraph ll lm iw ln b lo nr kg lq lr ns kj lt lu nt lw lx ly nu ma mb mc nv me mf mg ip bi translated">我导入了<code class="fe mv mw mx my b">pandas</code>库并读取了一个简单的数据集，其中包含每个国家的首都和一个通用字段，称为Value。</p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="a20c" class="oa na iw my b gz ob oc l od oe">import pandas as pd</span><span id="d576" class="oa na iw my b gz of oc l od oe">df = pd.read_csv('../../Datasets/capitals1.csv')<br/>df.head()</span></pre><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div class="gi gj og"><img src="../Images/5e5af7e61d1fd37db74ab432ab10b8d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*2_BADRE5ni56S7oq5FtrCw.png"/></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><p id="6439" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">现在我导入<code class="fe mv mw mx my b">sqldf</code>库。</p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="f7a0" class="oa na iw my b gz ob oc l od oe">import sqldf</span></pre><h1 id="445f" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">缺少值</h1><p id="f0b6" class="pw-post-body-paragraph ll lm iw ln b lo nr kg lq lr ns kj lt lu nt lw lx ly nu ma mb mc nv me mf mg ip bi translated">缺失值是数据集中不可用的值。例如，丢失的值可以表示为<code class="fe mv mw mx my b">NULL</code>、<code class="fe mv mw mx my b">None</code>或<code class="fe mv mw mx my b">NaN</code>。可以采用不同的策略来处理缺失的价值观。在本教程中，我演示了两种技术:</p><ul class=""><li id="ce02" class="mh mi iw ln b lo lp lr ls lu mj ly mk mc ml mg mm mn mo mp bi translated">删除缺少的值</li><li id="d304" class="mh mi iw ln b lo mq lr mr lu ms ly mt mc mu mg mm mn mo mp bi translated">替换丢失的值。</li></ul><h1 id="886c" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">删除缺少的值</h1><p id="62e6" class="pw-post-body-paragraph ll lm iw ln b lo nr kg lq lr ns kj lt lu nt lw lx ly nu ma mb mc nv me mf mg ip bi translated">删除缺失值包括删除某一列中缺失值的所有行。在我们的示例数据集中，索引为3的行缺少一个值。</p><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div class="gi gj og"><img src="../Images/b29cf9ff43efc7f69eb1bec59b69e88d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*wJqpWgUsbhDOhRCaoqxZWg.png"/></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><p id="ae7a" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">我定义了一个查询，它只选择<code class="fe mv mw mx my b">Value</code>列不为空的行:</p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="5b73" class="oa na iw my b gz ob oc l od oe">query = """<br/>SELECT *<br/>FROM df<br/>WHERE Value IS NOT NULL;<br/>"""</span></pre><p id="5169" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">现在我可以通过<code class="fe mv mw mx my b">run()</code>函数运行查询。</p><p id="de19" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated"><strong class="ln jg">如果查询包含</strong> <code class="fe mv mw mx my b"><strong class="ln jg">SELECT</strong></code> <strong class="ln jg">语句，则</strong> <code class="fe mv mw mx my b"><strong class="ln jg">run()</strong></code> <strong class="ln jg">函数返回新的dataframe。相反，如果查询包含一个</strong> <code class="fe mv mw mx my b"><strong class="ln jg">UPDATE</strong></code> <strong class="ln jg">语句，则更新原始数据帧。</strong></p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="7968" class="oa na iw my b gz ob oc l od oe">sqldf.run(query)</span></pre><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div class="gi gj oh"><img src="../Images/87613d42655b16b0a66f6665d30cabfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*BgbVSrrP9MPJRlERddezug.png"/></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><h1 id="feb7" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">替换丢失的值</h1><p id="c17c" class="pw-post-body-paragraph ll lm iw ln b lo nr kg lq lr ns kj lt lu nt lw lx ly nu ma mb mc nv me mf mg ip bi translated">处理缺失值的另一个策略是用固定值替换它们。例如，固定值可以是平均值。据我所知，<code class="fe mv mw mx my b">sqldf</code>库不支持嵌套查询，因此我必须运行两个独立的查询，一个检索平均值，另一个替换丢失的值。</p><p id="43c4" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">首先，我计算列<code class="fe mv mw mx my b">Value</code>的平均值:</p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="2205" class="oa na iw my b gz ob oc l od oe">query = """<br/>SELECT AVG(Value) as AVG<br/>FROM df<br/>"""</span><span id="8f8e" class="oa na iw my b gz of oc l od oe">avg = sqldf.run(query)['AVG'][0]</span></pre><p id="086c" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">然后我更新数据集:</p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="8b69" class="oa na iw my b gz ob oc l od oe">query = """<br/>UPDATE df<br/>SET Value = {}<br/>WHERE Value IS NULL;<br/>"""</span><span id="a3cb" class="oa na iw my b gz of oc l od oe">sqldf.run(query.format(avg))<br/>df.head()</span></pre><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div class="gi gj oi"><img src="../Images/137ee918d522c468d14faa4be34c558d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1032/format:webp/1*Ie6jBtYDffb67G5BTp8F2w.png"/></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><h1 id="5062" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">订单数据框架</h1><p id="1447" class="pw-post-body-paragraph ll lm iw ln b lo nr kg lq lr ns kj lt lu nt lw lx ly nu ma mb mc nv me mf mg ip bi translated">可能发生的情况是，为了建立一个最终的可视化，必须订购一个数据帧。因此，我可以利用SQL提供的<code class="fe mv mw mx my b">ORDER BY</code>语句:</p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="46b2" class="oa na iw my b gz ob oc l od oe">query = """<br/>SELECT *<br/>FROM df<br/>ORDER BY Value DESC;<br/>"""</span><span id="9b0a" class="oa na iw my b gz of oc l od oe">sqldf.run(query)</span></pre><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div class="gi gj oj"><img src="../Images/fb1cfab269485c4693f2448d7f27c7bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*B_L8Zobl-bn7oGmx0KLstg.png"/></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><h1 id="b357" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">删除重复项</h1><p id="e10b" class="pw-post-body-paragraph ll lm iw ln b lo nr kg lq lr ns kj lt lu nt lw lx ly nu ma mb mc nv me mf mg ip bi translated">SQL的强大功能也可以用来删除重复项。这可以通过构建查询来实现，该查询选择不同的列:</p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="a2c8" class="oa na iw my b gz ob oc l od oe">query = """<br/>SELECT DISTINCT Country, Capital, Value<br/>FROM df;<br/>"""</span><span id="3bf1" class="oa na iw my b gz of oc l od oe">sqldf.run(query)</span></pre><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div class="gi gj ok"><img src="../Images/1340a408599bf9768edb1d26e07569df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*x4j1936fqxwlss4C7oKxMg.png"/></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><h1 id="f523" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">合并两个数据帧</h1><p id="cf6e" class="pw-post-body-paragraph ll lm iw ln b lo nr kg lq lr ns kj lt lu nt lw lx ly nu ma mb mc nv me mf mg ip bi translated">数据集合并包括合并两个数据帧。SQL是一种非常强大的方法，可以毫无困难地合并数据集。</p><h1 id="7fd0" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">联盟</h1><p id="9783" class="pw-post-body-paragraph ll lm iw ln b lo nr kg lq lr ns kj lt lu nt lw lx ly nu ma mb mc nv me mf mg ip bi translated">两个数据帧之间的联合操作的结果包含两个数据集的所有行。为了执行union，我加载了一个额外的数据帧<code class="fe mv mw mx my b">df2</code>，称为<code class="fe mv mw mx my b">capitals2.</code>，它与前面的类似。附加数据帧<code class="fe mv mw mx my b">df2</code>仅包含一个与<code class="fe mv mw mx my b">df</code>重叠的行。</p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="ca69" class="oa na iw my b gz ob oc l od oe">df2 = pd.read_csv('../../Datasets/capitals2.csv')<br/>df2.head(len(df2))</span></pre><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div class="gi gj ol"><img src="../Images/8135dcb66f76bddc77cb2f409c38702d.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*BqwACYugCg3kaox80_-MjQ.png"/></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><p id="d7cd" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">两个数据帧的联合可以通过以下查询实现:</p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="584e" class="oa na iw my b gz ob oc l od oe">query = """<br/>SELECT Country, Capital, Value <br/>FROM df<br/>UNION<br/>SELECT Country, Capital, Value <br/>FROM df2<br/>ORDER BY Value DESC<br/>"""</span><span id="42ae" class="oa na iw my b gz of oc l od oe">sqldf.run(query)</span></pre><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div class="gi gj om"><img src="../Images/7df0bdc5980bb37ac9efb01a2bfe5311.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/format:webp/1*n1gT8AkedhlKrjd1Tw3fCw.png"/></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><p id="8bfd" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">请注意，union操作已经删除了重复项。</p><h1 id="99ff" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">交集</h1><p id="b6ae" class="pw-post-body-paragraph ll lm iw ln b lo nr kg lq lr ns kj lt lu nt lw lx ly nu ma mb mc nv me mf mg ip bi translated">两个数据帧的交集只包含两个数据帧中包含的行。在SQL中，可以通过<code class="fe mv mw mx my b">INNER JOIN</code>操作进行交集:</p><pre class="kv kw kx ky gu nw my nx ny aw nz bi"><span id="a3b5" class="oa na iw my b gz ob oc l od oe">query = """<br/>SELECT *<br/>FROM df<br/>INNER JOIN df2<br/>  ON df.Country = df2.Country AND df.Capital = df2.Capital;<br/>"""</span><span id="5886" class="oa na iw my b gz of oc l od oe">sqldf.run(query)</span></pre><figure class="kv kw kx ky gu kz gi gj paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="gi gj on"><img src="../Images/12cfed85390749a585b9d1c817f53910.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IF7_vMVT8d1ynJ2eSB_rRw.png"/></div></div><p class="lg lh gk gi gj li lj bd b be z dk translated">作者图片</p></figure><h1 id="7edd" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">摘要</h1><p id="b89b" class="pw-post-body-paragraph ll lm iw ln b lo nr kg lq lr ns kj lt lu nt lw lx ly nu ma mb mc nv me mf mg ip bi translated">在本教程中，我展示了一些在Pandas数据帧上运行SQL查询的技巧。我只描述了一些查询的例子，但是你的幻想将比我的更有创造性！</p><p id="c450" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">本教程的完整代码可以从我的<a class="ae lk" href="https://github.com/alod83/data-science/tree/master/Preprocessing/SQLDF" rel="noopener ugc nofollow" target="_blank"> Github库</a>下载。</p><p id="1895" class="pw-post-body-paragraph ll lm iw ln b lo lp kg lq lr ls kj lt lu lv lw lx ly lz ma mb mc md me mf mg ip bi translated">如果你想了解我的研究和其他活动的最新情况，你可以在<a class="ae lk" href="https://twitter.com/alod83" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae lk" href="https://www.youtube.com/channel/UC4O8-FtQqGIsgDW_ytXIWOg?view_as=subscriber" rel="noopener ugc nofollow" target="_blank"> Youtube </a>和<a class="ae lk" href="https://github.com/alod83" rel="noopener ugc nofollow" target="_blank"> Github </a>上关注我。</p><h1 id="5aa4" class="mz na iw bd nb nc nd ne nf ng nh ni nj kl nk km nl ko nm kp nn kr no ks np nq bi translated">相关文章</h1><div class="oo op gq gs oq or"><a rel="noopener follow" target="_blank" href="/how-to-sample-a-dataframe-in-python-pandas-d18a3187139b"><div class="os ab fp"><div class="ot ab ou cl cj ov"><h2 class="bd jg gz z fq ow fs ft ox fv fx jf bi translated">如何在Python Pandas中对数据帧进行采样</h2><div class="oy l"><h3 class="bd b gz z fq ow fs ft ox fv fx dk translated">使用不同的技术对Python Pandas中的数据集进行采样的现成代码</h3></div><div class="oz l"><p class="bd b dl z fq ow fs ft ox fv fx dk translated">towardsdatascience.com</p></div></div><div class="pa l"><div class="pb l pc pd pe pa pf le or"/></div></div></a></div><div class="oo op gq gs oq or"><a rel="noopener follow" target="_blank" href="/how-to-load-huge-csv-datasets-in-python-pandas-d306e75ff276"><div class="os ab fp"><div class="ot ab ou cl cj ov"><h2 class="bd jg gz z fq ow fs ft ox fv fx jf bi translated">如何在Python Pandas中加载巨大的CSV数据集</h2><div class="oy l"><h3 class="bd b gz z fq ow fs ft ox fv fx dk translated">可能会出现这样的情况，您的硬盘中有一个巨大的CSV数据集，占用了4或5gb(甚至更多),而您…</h3></div><div class="oz l"><p class="bd b dl z fq ow fs ft ox fv fx dk translated">towardsdatascience.com</p></div></div><div class="pa l"><div class="pg l pc pd pe pa pf le or"/></div></div></a></div><div class="oo op gq gs oq or"><a href="https://medium.com/geekculture/the-top-25-python-libraries-for-data-science-71c0eb58723d" rel="noopener follow" target="_blank"><div class="os ab fp"><div class="ot ab ou cl cj ov"><h2 class="bd jg gz z fq ow fs ft ox fv fx jf bi translated">面向数据科学的25大Python库</h2><div class="oy l"><h3 class="bd b gz z fq ow fs ft ox fv fx dk translated">你一生中至少应该尝试一次的Python库列表。</h3></div><div class="oz l"><p class="bd b dl z fq ow fs ft ox fv fx dk translated">medium.com</p></div></div><div class="pa l"><div class="ph l pc pd pe pa pf le or"/></div></div></a></div></div></div>    
</body>
</html>