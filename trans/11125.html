<html>
<head>
<title>Fantastic Functions and Where to Use Them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">奇妙的功能以及在哪里使用它们</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/fantastic-functions-and-where-to-use-them-looped-and-grouped-f76ab7bb6b47?source=collection_archive---------13-----------------------#2021-10-30">https://towardsdatascience.com/fantastic-functions-and-where-to-use-them-looped-and-grouped-f76ab7bb6b47?source=collection_archive---------13-----------------------#2021-10-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="849c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">循环分组</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4fdd62804d54c0e62ba7fbd547fb5af6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*miwQYhkMmlL-3Yja"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@rhii?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rhii 摄影</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="6415" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">数据准备过程是每项分析的支柱，因为几乎没有数据准备就绪。借助 python 和 pandas 的魔力，可以简化这个过程，并避免重复代码。</p><p id="63b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我将带您了解一些最不喜欢但非常有效的 applymap、apply、groupby 函数，以及这些函数可以节省您的编码时间并提高代码可读性的潜在用例。</p><p id="0855" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">出于说明和适用性的目的，我将分析一家位于许多城市的 imaginery 连锁店的盈利能力和资本支出需求。然而，代码可以在各种领域和用例中实践。</p><h1 id="2cda" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">内容</h1><p id="2d73" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><a class="ae kv" href="#4dfd" rel="noopener ugc nofollow"> <strong class="ky ir">导入库</strong> </a></p><p id="fdaf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="#b4e4" rel="noopener ugc nofollow"> <strong class="ky ir">创建用于分析的数据框</strong> </a></p><ol class=""><li id="9adb" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated"><a class="ae kv" href="#c6b9" rel="noopener ugc nofollow"> <strong class="ky ir"> Applymap:遍历整个数据帧</strong> </a></li><li id="13b0" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><a class="ae kv" href="#3fed" rel="noopener ugc nofollow"> <strong class="ky ir">嵌套应用:盗梦空间</strong> </a></li><li id="7c08" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><a class="ae kv" href="#7f80" rel="noopener ugc nofollow"> <strong class="ky ir">分组按多个数据帧进行算术运算</strong> </a></li><li id="dbe4" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><a class="ae kv" href="#b382" rel="noopener ugc nofollow"> <strong class="ky ir">分组依据与应用:自定义功能</strong> </a></li><li id="accf" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><a class="ae kv" href="#d484" rel="noopener ugc nofollow"> <strong class="ky ir"> Groupby 对数据帧</strong> </a>进行切片</li></ol><p id="d5a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="#571c" rel="noopener ugc nofollow"> <strong class="ky ir">结论</strong> </a></p><h1 id="4dfd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">导入库</h1><p id="3d22" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们导入以下库来创建带有随机字符串和数字类型数据字段的数据框。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="e176" class="ni lt iq ne b gy nj nk l nl nm">import pandas as pd<br/>import numpy as np<br/>import string</span><span id="0374" class="ni lt iq ne b gy nn nk l nl nm">pd.set_option('display.max_rows', 400)<br/>pd.set_option('display.max_columns', 200)<br/>pd.set_option('display.max_colwidth', 150)</span><span id="db7d" class="ni lt iq ne b gy nn nk l nl nm"># ['A', 'B', ..., 'AA', 'AB', ..., 'ZY', 'ZZ']<br/>ALPHABETICAL_LIST = (list(string.ascii_uppercase) + <br/>                     [letter1+letter2 for letter1 in string.ascii_uppercase <br/>                      for letter2 in string.ascii_uppercase])</span></pre><h1 id="b4e4" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">创建用于分析的数据框</h1><p id="1b39" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">让我们创建一个 40 家商店的列表，这些商店在 1980 年至 2010 年间在 10 个不同的城市开设，有 20 年的收入和成本轨迹。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="324f" class="ni lt iq ne b gy nj nk l nl nm">PERIOD_COLUMNS = [i for i in range(2021,2041)]</span><span id="145a" class="ni lt iq ne b gy nn nk l nl nm">CITIES = np.array(sorted([ALPHABETICAL_LIST[x] for x in np.random.choice(range(10), 40)]))</span><span id="9a19" class="ni lt iq ne b gy nn nk l nl nm">STORES = np.array(sorted(['Street_' + <br/>                          ALPHABETICAL_LIST[x] for x in np.random.choice(range(100), 40, replace=False)]))</span><span id="62ad" class="ni lt iq ne b gy nn nk l nl nm">STORE_OPENING_YEARS = np.array(([x for x in np.random.choice(range(1980, 2010), 40)]))</span><span id="90f3" class="ni lt iq ne b gy nn nk l nl nm">STORE_REVENUS = np.random.uniform(low=500, high=1000, size=(40, 20))</span><span id="d35c" class="ni lt iq ne b gy nn nk l nl nm">STORE_COSTS = np.random.uniform(low=300, high=600, size=(40, 20))</span><span id="7fdd" class="ni lt iq ne b gy nn nk l nl nm">df_Stores = pd.DataFrame(</span><span id="aab4" class="ni lt iq ne b gy nn nk l nl nm">np.column_stack((</span><span id="a88f" class="ni lt iq ne b gy nn nk l nl nm">CITIES,<br/>    <br/>STORES,</span><span id="184c" class="ni lt iq ne b gy nn nk l nl nm">STORE_OPENING_YEARS,</span><span id="fcd2" class="ni lt iq ne b gy nn nk l nl nm">)),</span><span id="681b" class="ni lt iq ne b gy nn nk l nl nm">columns = (['City', 'Store', 'Opened'])</span><span id="7fad" class="ni lt iq ne b gy nn nk l nl nm">).astype({'Opened': np.int64})</span><span id="b338" class="ni lt iq ne b gy nn nk l nl nm">df_Stores</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi no"><img src="../Images/bf89189adea68e548e82d54eee342259.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*4ofhqzW_R9C3tw_tpPYmVg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">商店的虚拟数据框，作者照片</p></figure><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="cf02" class="ni lt iq ne b gy nj nk l nl nm">df_Store_Revenues = df_Stores.drop(['Opened'], axis=1).reset_index(drop=True)</span><span id="2fc5" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Revenues[PERIOD_COLUMNS] = pd.DataFrame(STORE_REVENUS, columns=PERIOD_COLUMNS)</span><span id="335e" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Costs = df_Stores.drop(['Opened'], axis=1).reset_index(drop=True)</span><span id="141a" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Costs[PERIOD_COLUMNS] = pd.DataFrame(STORE_COSTS, columns=PERIOD_COLUMNS)</span></pre><h1 id="c6b9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">1- Applymap:遍历整个数据帧</h1><p id="72aa" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">使用时，applymap 通过数据帧上的每个单元格在内部循环 lambda 函数。</p><div class="kg kh ki kj gt ab cb"><figure class="np kk nq nr ns nt nu paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/884f80dccfb67bf03afb452c6ecd3633.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*IL325pAarBpQNsHe"/></div></figure><figure class="np kk nq nr ns nt nu paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/2feb5ba51a7edbb9394b90f0ce64d7e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*uBlb0hjGZnjud9KL"/></div><p class="kr ks gj gh gi kt ku bd b be z dk nv di nw nx translated">onder rtel 和 Tine Ivani 在 Unsplash 上的照片</p></figure></div><p id="63f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管要处理多个数据类型字段，这个“一行程序”还是非常方便的。</p><p id="86a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，我们有一个商店收入轨迹，如下图所示。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="adcc" class="ni lt iq ne b gy nj nk l nl nm">df_Store_Revenues.head(10)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/659adc8984d363ccc82cf9dad8bf51ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ONjldOof6ruAiTxsZmUJrQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">商店收入，作者照片</p></figure><p id="f002" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们不想看到很多小数点，我们可以简单地对所有非对象类型的单元格执行 applymap 循环。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="8356" class="ni lt iq ne b gy nj nk l nl nm">df_Store_Costs = df_Store_Costs.applymap(lambda x: np.round(x,2) if type(x)!=str else x)</span><span id="7d9c" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Revenues = df_Store_Revenues.applymap(lambda x: np.round(x,2) if type(x)!=str else x)</span><span id="ef56" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Revenues.head(10)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/b1381084e375d61e5d0c06505c501294.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YPjtjJWH5kXCeU10OsVEhA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">商店收入，四舍五入。作者照片</p></figure><p id="c35d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">使用案例:</strong>当我们需要对每个单元格应用一个线性规则时(例如，用对数/乘数缩放、向上/向下舍入、用值替换等),此函数非常有用。)</p><h1 id="3fed" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">2-嵌套应用:开始</h1><p id="d839" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我真的很喜欢这部电影，因为它让我想起了我最喜欢的电影之一:“盗梦空间”。通过在数据帧上双重应用 lambda 函数，我们可以获得该单元格的索引/列名信息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/55e46f982f2885be85df92d26c956869.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cgK6wb_kjCpE0Oig"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@hautier?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Christophe Hautier </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="201b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们考虑这样一个场景，我们的商场在运营后的第 25 年需要经历一个主要设备的更新阶段，并在随后的 3 年中加强房地产(油漆/地板)。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="b0b6" class="ni lt iq ne b gy nj nk l nl nm">RENEWAL_YEAR_AFTER_OPENING = 25 #years</span><span id="d05d" class="ni lt iq ne b gy nn nk l nl nm">ENHANCEMENT_DURATION_AFTER_RENEWAL = 3 #years</span><span id="1290" class="ni lt iq ne b gy nn nk l nl nm">df_Store_CAPEX = df_Stores.copy().reset_index(drop=True)</span><span id="0dd0" class="ni lt iq ne b gy nn nk l nl nm">df_Store_CAPEX[PERIOD_COLUMNS] = pd.DataFrame(np.array([[np.nan ]* 20] * 40), columns=PERIOD_COLUMNS)</span><span id="fe69" class="ni lt iq ne b gy nn nk l nl nm">df_Store_CAPEX.head(5)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/9c2649655cb57e717af9975689060b58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cgFpGg5hZ0iEWEMS1wZzXA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者照片</p></figure><p id="9b03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以计算出该特定年份是典型的维护、更新年还是升级年，如下所示:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="47c8" class="ni lt iq ne b gy nj nk l nl nm">df_Store_CAPEX[PERIOD_COLUMNS] = df_Store_CAPEX[PERIOD_COLUMNS].apply(lambda x: </span><span id="f72a" class="ni lt iq ne b gy nn nk l nl nm">pd.DataFrame(x).apply(lambda y:<br/>                                                                   <br/>                                                                   <br/>'Maintenance' if x.name &lt; (RENEWAL_YEAR_AFTER_OPENING +</span><span id="9f26" class="ni lt iq ne b gy nn nk l nl nm">df_Store_CAPEX.loc[y.name, 'Opened'])<br/>else</span><span id="d7fe" class="ni lt iq ne b gy nn nk l nl nm">('Renewal' if (RENEWAL_YEAR_AFTER_OPENING +</span><span id="202f" class="ni lt iq ne b gy nn nk l nl nm">df_Store_CAPEX.loc[y.name, 'Opened']) == x.name <br/> <br/>else</span><span id="9ed8" class="ni lt iq ne b gy nn nk l nl nm">('Enhancement' if x.name &lt; (RENEWAL_YEAR_AFTER_OPENING + <br/>                   df_Store_CAPEX.loc[y.name, 'Opened'] + 1 + ENHANCEMENT_DURATION_AFTER_RENEWAL<br/>                   )  <br/> <br/>else 'Maintenance')</span><span id="e579" class="ni lt iq ne b gy nn nk l nl nm">)                                                                  <br/>                                                                   <br/>, axis=1))</span></pre><p id="d760" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，Street_AR(建立于 1997 年)在 2022 年之前和 2025 年之后需要维护，2022 年需要更新(1997 + 25)，2023 年至 2025 年需要改进。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/2a378f638e9752dff9edb19da33fcc63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IfcuN0Zy8ApfQLEZfW-uQw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">年度资本支出类型，作者照片</p></figure><p id="2c61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用例:</strong>这种方法非常类似于 Excel 表格的使用，在表格值内的公式中使用标题单元格。</p><p id="77b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">除此之外，当数据框的索引顺序和列名几乎相同时，这种嵌套的应用方法可能更适合在多个数据框之间进行复杂的计算。</p><h1 id="7f80" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">3-用多个数据帧分组进行算术运算</h1><p id="faa7" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">当我们知道索引顺序(某些数据字段的顺序)在数据框中是相同的时，前面的方法是有效的。然而，如果不是我们首先创建了这些表，并且我们不知道这些几乎相似的表是否有任何添加或删除，那该怎么办呢？</p><p id="c95a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果是这样，如果我们需要做 4 个基本的算术运算(加、减、乘、除)，那么有一个更安全、更好的方法。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/bdcc458f21de44fe03f569b0a3d6d45f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IGEEZ9Muhrqvq3SZ"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@rechaoktaviani?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Recha Oktaviani </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="9b5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关键是将对象类型字段设置为索引，这样数字列就可以彼此相加/相乘。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="8a35" class="ni lt iq ne b gy nj nk l nl nm">INDEX_KEYS = ['City', 'Store']</span><span id="c2af" class="ni lt iq ne b gy nn nk l nl nm"># we can put as many dfs as we like inside this list<br/># buy multiplying with -1 and summing at the end,<br/># we're basically substraction negative table from the positive table.</span><span id="07e4" class="ni lt iq ne b gy nn nk l nl nm">LIST_OF_DATAFRAMES_TO_SUM = [</span><span id="77e7" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Revenues.set_index(INDEX_KEYS),</span><span id="0440" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Costs.set_index(INDEX_KEYS) * -1,<br/>                        <br/>                            ]</span><span id="a3fa" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Profit = pd.concat(LIST_OF_DATAFRAMES_TO_SUM, <br/>          <br/>          sort=False, <br/>          <br/>          keys=range(len(LIST_OF_DATAFRAMES_TO_SUM))<br/>          <br/>         ).groupby(<br/>    <br/>    level=[i+1 for i in range(len(INDEX_KEYS))]<br/>                  <br/>                    ).apply(lambda x : (x.sum())<br/>                                 ).reset_index()</span><span id="b4c5" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Profit</span></pre><p id="5313" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Street_A 的收入和成本视图如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/61440a8a4921aec6e4a468bd9364b076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kyJ25N0I1pcTdYPOe0oYWA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Street_A 的收入，作者照片</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/a111ded8b3e6204dd0d41446edc35ee1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7v_Ce5gv6g2rzgeaF1JG6g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Street_A 的成本，作者照片</p></figure><p id="16b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Street_A 的毛利观如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/981d1ad56dbd6cbdbc0f84e89fe70515.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FVBKoZnmuvHvBNs9tzO-fg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">商店的毛利，作者拍摄的照片</p></figure><p id="8160" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">乘法(或除法)也与前面的方法(加法/减法)非常相似，只有几处不同。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="0aab" class="ni lt iq ne b gy nj nk l nl nm">INDEX_KEYS = ['City', 'Store']</span><span id="be8b" class="ni lt iq ne b gy nn nk l nl nm"># we can put as many dfs as we like inside this list<br/># buy taking the power to the -1 and multiplying at the end,<br/># we're basically dividing first table by the second table.</span><span id="9e33" class="ni lt iq ne b gy nn nk l nl nm">LIST_OF_DATAFRAMES_TO_MULTIPLY = [</span><span id="e3ae" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Profit.set_index(INDEX_KEYS),</span><span id="6f02" class="ni lt iq ne b gy nn nk l nl nm">df_Store_Revenues.set_index(INDEX_KEYS) ** -1,<br/>                        <br/>                            ]</span><span id="4009" class="ni lt iq ne b gy nn nk l nl nm">df_Store_ProfitMargin = pd.concat(LIST_OF_DATAFRAMES_TO_MULTIPLY, <br/>          <br/>          sort=False, <br/>          <br/>          keys=range(len(LIST_OF_DATAFRAMES_TO_MULTIPLY))<br/>          <br/>         ).groupby(<br/>    <br/>    level=[i+1 for i in range(len(INDEX_KEYS))]<br/>                  <br/>                    ).apply(lambda x : (x.cumprod(skipna=False).iloc[-1])<br/>                                 ).reset_index()</span><span id="ae47" class="ni lt iq ne b gy nn nk l nl nm">df_Store_ProfitMargin</span></pre><p id="9bb3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Street_A 的毛利率视图如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/d386f557e169f9a6831cdbe5f959a0d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vBsFpAjwxwTxo7AQFEaCrA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">商店的毛利率，图片由作者提供</p></figure><p id="0564" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用例:</strong>当有许多数据帧要对多级数据进行(加/减)或(乘/除)时，这些算术运算是非常可取的。</p><p id="9b0f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="oi">请注意，sum / multiply 不能混合在同一个 dataframe 列表中，必须单独运行。</em> </strong></p><h1 id="b382" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">4-具有应用功能的分组依据:定制功能</h1><p id="aa32" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们可能需要只适合我们需求的定制功能。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/58b73187e9c111c41bc52afc8629a926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IJPFeXwCtHSBQCli"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">萨尔瓦多·戈多伊在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="cc2c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，如果我们想找到每年毛利率为负的商店，该怎么办？</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/d386f557e169f9a6831cdbe5f959a0d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vBsFpAjwxwTxo7AQFEaCrA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">商店的毛利率，图片由作者提供</p></figure><p id="1d71" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关键点是创建一个内部有一个空字典的函数，并将其作为用字典键索引的 pandas series 返回。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="9164" class="ni lt iq ne b gy nj nk l nl nm">def find_stores_that_loses_money(x):<br/>    <br/>    d={}<br/>    <br/>    for COLUMN in PERIOD_COLUMNS:<br/>    <br/>        MONEY_LOSING_STORES = x[x[COLUMN] &lt; 0]<br/>        <br/>        if len(MONEY_LOSING_STORES) &gt; 0:<br/>        <br/>            d['Loss_{}'.format(COLUMN)] = ' , '.join(list(<br/>                <br/>                MONEY_LOSING_STORES['Store'].values<br/>                                    <br/>                                                      )<br/>                                                    )</span><span id="c953" class="ni lt iq ne b gy nn nk l nl nm">else:<br/>            <br/>            d['Loss_{}'.format(COLUMN)] = np.nan<br/>        <br/>    return pd.Series(d, index=d.keys())</span><span id="f49e" class="ni lt iq ne b gy nn nk l nl nm">df_Stores_Losing_Money = df_Store_ProfitMargin.groupby(['City']).apply(find_stores_that_loses_money).reset_index()</span><span id="01e5" class="ni lt iq ne b gy nn nk l nl nm">df_Stores_Losing_Money</span></pre><p id="97ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于每年的每个城市，我们都会发现毛利率为负的商店。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/5d032ca9f36501b0e78ed3aa94fa636b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d8NamMssPfY505WOQsLlIg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">亏损商店，作者照片</p></figure><p id="357d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用例:</strong>天空才是极限。只需创建一个最符合您业务需求的功能，并与 groupby magic 结合即可。</p><h1 id="d484" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">5- Groupby 对数据帧进行切片</h1><p id="0b11" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们有时需要以多层次的方式分割数据帧来处理子集。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/09f4609e34ed3e453daf7211f8312a4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6eBWIutgth5xjggV"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@photo_scientist?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Kabir Kotwal </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="7a57" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于每个城市，我们筛选 2021 年盈利能力最高的商店行。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="0506" class="ni lt iq ne b gy nj nk l nl nm">idx_max = df_Store_ProfitMargin.groupby(['City'])[2021].transform(max)==df_Store_ProfitMargin[2021]</span><span id="77db" class="ni lt iq ne b gy nn nk l nl nm">df_Most_Profitable_Stores_2021 = df_Store_ProfitMargin[ (idx_max) ]</span><span id="a01f" class="ni lt iq ne b gy nn nk l nl nm">df_Most_Profitable_Stores_2021</span></pre><p id="c461" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请查看索引号中的过滤效果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/95012c58c0f28939bb4537eb194e934a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AxEzw5Y0cywph2WyutinPw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">每个城市 2021 年利润最高的商店，作者照片</p></figure><p id="3473" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">用例:</strong>当我们需要保存数据库历史中每个类别的最新行时，这种方法非常有用。(即每个用户和产品的 Updated_At 列的最大值)</p><h1 id="571c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="d8fe" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在这篇文章中，我想带你了解一些最不喜欢但有效的循环和分组函数，它们可以增加代码的可读性，并让你赢得时间和确定性。但是，请注意，在处理数百万行的数据帧时，循环并不是首选，它们需要谨慎处理。</p></div></div>    
</body>
</html>