<html>
<head>
<title>Context Managers; The Best Managers for Python Developers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">上下文管理器；Python开发人员的最佳经理</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/context-managers-the-best-managers-for-python-developers-a5809fb7e428?source=collection_archive---------10-----------------------#2021-11-18">https://towardsdatascience.com/context-managers-the-best-managers-for-python-developers-a5809fb7e428?source=collection_archive---------10-----------------------#2021-11-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="902b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何避免不关灯</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/960ed13f5670e807879f17d6ce02d8d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IReZWlatfuL7zsV1"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@agk42?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">亚历山大·奈特</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><h1 id="a3cf" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="07a7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">你有没有饿着肚子去厨房，打开冰箱，拿出好吃的东西，又因为饿得忘记关冰箱？或者你有没有在晚上回到家，你的一些灯还亮着？我想我们都知道这种情况。</p><p id="d966" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">那么，当标题说我们要讨论Python时，我为什么要告诉你呢？作为一名数据科学家或机器学习从业者，你为什么会关心这个问题？原因是你会经常面临这样的情况。例如，当您连接到一个数据库以获取有价值的数据时，却忘记了关闭连接。或者假设您正在设置一个巨大的计算集群来训练您的模型，当您完成后，您让它继续运行。这些东西可能会变得非常昂贵，让你的经理或公司烦恼。</p><p id="3932" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这让我想起了我们现实生活中忘记关冰箱或忘记开灯的情况。我们忘记做家务了！软件的不同之处在于，我们不会亲自回来，并有第二次机会来收拾残局。因此，后果可能会更加严重，比如系统变慢，甚至完全崩溃。最糟糕的是，这种情况可能发生在程序内部的任何地方，不一定靠近造成混乱的代码。这很难找到和调试。</p><p id="99e7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">那么在Python中我们能做些什么来避免遇到这些情况并且永远不要忘记清理资源呢？</p><blockquote class="ms mt mu"><p id="b349" class="lr ls mv lt b lu mn ju lw lx mo jx lz mw mp mc md mx mq mg mh my mr mk ml mm im bi translated">使用上下文管理器！</p></blockquote><p id="fb63" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本文中，我将向您介绍上下文管理器以及如何用Python编写自己的上下文管理器。一旦你知道并应用它们，你将永远不会忘记做家务，因为它是自动为你做的。这当然只适用于代码，对提到的实际情况没有帮助😃你准备好了吗？我们开始吧！</p><h1 id="ad97" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">上下文管理器</h1><h2 id="0edb" class="mz la it bd lb na nb dn lf nc nd dp lj ma ne nf ll me ng nh ln mi ni nj lp nk bi translated">基本概念</h2><p id="fd3c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">管理资源是编程的一个重要部分，但我们有时容易忘记。<a class="ae ky" href="https://en.wikipedia.org/wiki/Resource_(computing)" rel="noopener ugc nofollow" target="_blank">资源</a>是任何数量有限的可用资源。例子包括文件句柄、<a class="ae ky" href="https://en.wikipedia.org/wiki/network_socket" rel="noopener ugc nofollow" target="_blank">网络套接字</a>或<a class="ae ky" href="https://docs.python.org/3/library/threading.html#lock-objects" rel="noopener ugc nofollow" target="_blank">锁</a>，仅举几例。对于这些资源来说，确保在你<em class="mv">获得</em>它们<em class="mv">之后<em class="mv">释放它们</em>是至关重要的。</em>如果它们没有被释放，您就有一个<a class="ae ky" href="https://en.wikipedia.org/wiki/resource_leak" rel="noopener ugc nofollow" target="_blank">资源泄漏</a>，您的系统可能会变慢或崩溃。</p><p id="a4e0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">除了管理资源之外，在其他情况下，您也应该执行最后的清理操作。例如，关闭与获取数据的数据库的连接，向Kafka提交偏移量，或者在扩大计算资源后缩小计算资源。后一种方法可以真正节省成本，尤其是在讨论用于模型训练的大规模计算集群时。</p><p id="4d5f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">总的来说，有一个我们正在寻找的属于下列行动的一般模式</p><ul class=""><li id="d1d1" class="nl nm it lt b lu mn lx mo ma nn me no mi np mm nq nr ns nt bi translated"><code class="fe nu nv nw nx b">Open</code> - <code class="fe nu nv nw nx b">Close</code></li><li id="0a28" class="nl nm it lt b lu ny lx nz ma oa me ob mi oc mm nq nr ns nt bi translated"><code class="fe nu nv nw nx b">Lock</code> - <code class="fe nu nv nw nx b">Release</code></li><li id="1f42" class="nl nm it lt b lu ny lx nz ma oa me ob mi oc mm nq nr ns nt bi translated"><code class="fe nu nv nw nx b">Change</code> - <code class="fe nu nv nw nx b">Reset</code></li><li id="c302" class="nl nm it lt b lu ny lx nz ma oa me ob mi oc mm nq nr ns nt bi translated"><code class="fe nu nv nw nx b">Enter</code> - <code class="fe nu nv nw nx b">Exit</code></li><li id="e5e9" class="nl nm it lt b lu ny lx nz ma oa me ob mi oc mm nq nr ns nt bi translated"><code class="fe nu nv nw nx b">Start</code> - <code class="fe nu nv nw nx b">Stop</code></li><li id="713a" class="nl nm it lt b lu ny lx nz ma oa me ob mi oc mm nq nr ns nt bi translated"><code class="fe nu nv nw nx b">Setup</code> - <code class="fe nu nv nw nx b">Teardonw</code></li></ul><p id="d104" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">每当你发现自己处于这种情况时，上下文管理器将是你最好的朋友。这有助于你的程序始终处于良好状态。如果你使用它们，你不会忘记做家务，也不会意外地在失败的情况下不做家务。最后，当您应用上下文管理器时，您的代码也处于可读性更强、重复性更低的状态。</p><p id="750e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">说得够多了，让我们在下一节看看如何在代码中使用上下文管理器。</p><h2 id="e175" class="mz la it bd lb na nb dn lf nc nd dp lj ma ne nf ll me ng nh ln mi ni nj lp nk bi translated">如何使用Python上下文管理器</h2><p id="2702" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我的工作中，我做过许多与Python相关的采访。在那里，我几乎总是问人们:“什么是上下文管理器？”。有趣的是，大多数受访者表示他们从未听说过这个术语。然而，如果我给他们看一个例子，他们都会说</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/3167fc391fd4e9634ab48a3d9e0aa7f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GO6CnXVsde4HcRyM"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@javaistan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Afif Kusuma </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="3cda" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">“那是上下文管理器吗？我经常用！”。我也想在这里和你做同样的事。这是一个例子</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="f601" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">你是不是像“啊”一样走了？我想不是因为你已经知道什么是上下文管理器。如果没有，没问题，让我们快速消化我们在这里做的事情。</p><p id="5d9b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本例中，<code class="fe nu nv nw nx b">open</code>是上下文管理器。<code class="fe nu nv nw nx b"><a class="ae ky" href="https://www.python.org/dev/peps/pep-0343/" rel="noopener ugc nofollow" target="_blank"><strong class="lt iu">with</strong></a></code> <a class="ae ky" href="https://www.python.org/dev/peps/pep-0343/" rel="noopener ugc nofollow" target="_blank">语句</a>确保上下文管理器执行其打开和关闭动作。在这里，上下文管理器打开给定的文件<code class="fe nu nv nw nx b">something.json,</code>，并返回相应的文件处理程序。我们可以使用<code class="fe nu nv nw nx b"><strong class="lt iu">as</strong></code>语句将上下文管理器的返回值赋给一个变量。当我们退出<code class="fe nu nv nw nx b"><strong class="lt iu">with</strong></code>块时，上下文管理器确保所有东西都被清理了，即使在失败的情况下。很甜蜜，不是吗？</p><p id="38df" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，如何编写上下文管理器呢？让我们在最后一节检查一下。</p><h2 id="84e2" class="mz la it bd lb na nb dn lf nc nd dp lj ma ne nf ll me ng nh ln mi ni nj lp nk bi translated">如何编写上下文管理器</h2><p id="8d9b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在了解了如何使用上下文管理器之后，让我们更深入一层，看看如何编写上下文管理器。原则上，你要做的就是写一个类，并简单地实现两个magic或dunder函数<code class="fe nu nv nw nx b">__enter__</code>来设置一切，以及<code class="fe nu nv nw nx b">__exit__</code>来清理混乱。我认为最好的做法是<code class="fe nu nv nw nx b">__enter__</code>返回self，这样您就可以将创建的对象赋给<code class="fe nu nv nw nx b">as</code>子句中的一个变量，并在以后使用它。</p><p id="b5dd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果您正在使用现代Python，并且希望在设置或拆除时进行一些异步调用，您必须编写一个异步上下文管理器。幸运的是，这几乎和同步调用一样简单。你只需要实现两个异步函数<code class="fe nu nv nw nx b">__aenter__</code>和<code class="fe nu nv nw nx b">__aexit__</code>。最后一点，要调用异步上下文管理器，只需调用<code class="fe nu nv nw nx b">async with YourManager() as a:</code>。很简单，不是吗？</p><p id="fc02" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，这是编写上下文管理器的正确方式。但是如果Python不能提供更多的语法糖来帮助以同步和异步方式编写上下文管理器，它就不是Python了。你所要做的就是写一个函数并使用一个装饰器。听起来很酷，不是吗？让我们看看这在代码中是怎样的</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="df99" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这里，我以同步和异步方式创建了一个名为<code class="fe nu nv nw nx b">training_cluster</code>的上下文管理器。这个上下文管理器旋转一个假设的训练集群，并确保它在被使用后被关闭。要实现这一点，你只需要在某个时候写一个函数<code class="fe nu nv nw nx b">yield</code>，并用来自令人敬畏的Python内置<a class="ae ky" href="https://docs.python.org/3/library/contextlib.html" rel="noopener ugc nofollow" target="_blank"> contextlib </a>模块的<code class="fe nu nv nw nx b">contextmanager</code>或<code class="fe nu nv nw nx b">acontextmanager</code>来修饰它。现在，您可以将它与两个训练功能中所示的<code class="fe nu nv nw nx b">with</code>和<code class="fe nu nv nw nx b">async with</code>关键字一起使用。完成了。就这么简单。</p><p id="375d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我喜欢这种方法的一点是，发生了什么非常清楚。在<code class="fe nu nv nw nx b">yield</code>之前的一切都是安装部分，之后的一切都是拆卸部分。为了确保拆除总是发生，你必须把它放到一个<code class="fe nu nv nw nx b">finally</code>块中。顺便提一下，如果您希望您的上下文管理器不返回任何内容，只需使用没有任何返回值的<code class="fe nu nv nw nx b">yield</code>。</p><p id="5163" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最后，这种方法的另一个优点是，您可以轻松地为第三方类提供上下文管理器，而不必继承它们。这同样有助于编写清晰漂亮的代码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/a67d77b1e94df39dd2fe085c1337c142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rqXNkaLOvfDwEti8"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@timmossholder?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Tim Mossholder </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="40af" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">包裹</h1><p id="b1b8" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本文中，我已经向您展示了Python中的上下文管理器及其用途。此外，我还为您提供了同步和异步上下文管理器的示例实现和用法。我希望你同意使用这个既超级有用，同时又非常简单。老实说，自动完成家务就像梦想成真一样😃</p><p id="e7d4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">感谢您关注这篇文章。一如既往，如有任何问题、意见或建议，请随时联系我或关注我，无论是在这里还是通过<a class="ae ky" href="https://www.linkedin.com/in/simon-hawe-75832057/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>。</p></div></div>    
</body>
</html>