<html>
<head>
<title>Mastering the OVER Clause in SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">掌握SQL中的OVER子句</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/mastering-the-over-clause-in-sql-ff783fe91914?source=collection_archive---------10-----------------------#2021-11-23">https://towardsdatascience.com/mastering-the-over-clause-in-sql-ff783fe91914?source=collection_archive---------10-----------------------#2021-11-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="97fb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">对数据行的迭代</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/17a389c6b6682e54fffcc3e4e59709d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UiqavpNw7P9pt0ub"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">茱莉亚·萨比尼亚兹在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="4f30" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着对它们需求的增长，更多的数据库集成了<a class="ae ky" href="https://en.wikipedia.org/wiki/Window_function_(SQL)" rel="noopener ugc nofollow" target="_blank">窗口函数</a>来对数据子集进行计算。使用与<a class="ae ky" href="https://www.geeksforgeeks.org/window-sliding-technique/" rel="noopener ugc nofollow" target="_blank">滑动窗口技术</a>相同的原理，窗口函数计算单个数据点与数据集的其余部分或其中的一部分相比如何。</p><p id="4617" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在统计学中，移动窗口最著名的应用之一是<a class="ae ky" href="https://en.wikipedia.org/wiki/Moving_average" rel="noopener ugc nofollow" target="_blank">移动平均</a>，也称为滚动平均。在财务和会计中，一个<a class="ae ky" href="https://en.wikipedia.org/wiki/Running_total" rel="noopener ugc nofollow" target="_blank">运行总数</a>也是窗口函数的一个非常常见的例子。</p><p id="4363" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着使用窗口功能的需求增长，许多数据库开始在子句上集成<a class="ae ky" href="https://docs.microsoft.com/en-us/sql/t-sql/queries/select-over-clause-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">，这允许用户执行这些操作以及其他操作。现在，OVER子句已被微软程序、开源数据库(如MySQL和Google的BigQuery)所采用，并已成为数据专业人员的必备工具。</a></p><h1 id="d5f9" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">对运行总计使用OVER子句</h1><p id="9002" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">财务和会计专业人员在审阅财务信息时喜欢使用累计。在许多情况下，他们可能会使用Excel的内置函数来创建累计，但使用SQL通常可以节省一些时间，尤其是对于较大的数据集。</p><p id="0cbc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了演示如何使用SQL创建一个运行总数，我们将使用一个示例数据库，其中包括一个销售ID、周数、部门和应计收入。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="ff77" class="mx lw it mt b gy my mz l na nb">CREATE TABLE SALES_2021(<br/>sales_id INTEGER PRIMARY KEY AUTOINCREMENT,<br/>week INTEGER,<br/>department VARCHAR(255),<br/>revenue INTEGER);</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/758f47ba2e902057dbd74cd542384f67.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*aml04tFXG_ZyF2S0ovy65w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表格的前五个条目</p></figure><p id="5208" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着时间的推移，利益相关者可能会自然地要求获得总收入。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="cecf" class="mx lw it mt b gy my mz l na nb">SELECT week, department, revenue, SUM(revenue) <br/>OVER(PARTITION BY department ORDER BY week)<br/>FROM SALES_2021;</span></pre><p id="ca90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SELECT子句选择表示为正常的列以及收入的SUM函数。OVER子句表示按部门对结果进行划分，这确保了对每个部门的累计重新开始，而不是对所有部门的总和进行累计。over子句还指定按周对结果进行排序，以便它们保持时间顺序。</p><p id="3cc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了便于阅读，添加了一个别名，将列重命名为“运行总计”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/1fff77f5e220d5e3167f33be08d9e88d.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*wGwwzHwgMLLLzazzzp817g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">法律部前五周的总收入</p></figure><h1 id="ea82" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">对移动平均线使用OVER子句</h1><p id="260f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">数据分析师可能希望查看移动平均线，以粗略预测未来收入。与普通平均值不同的是，移动平均值只考虑子集而不是整个数据集，它通常用于时间序列数据，通常使用一个间隔，如最近几天、几周、几个月、几个季度或几年。根据定义，这提供了一个窗口函数的强大例子。</p><p id="c67a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了说明SQL如何自动生成这个统计数据，可以编写一个最近三周的查询平均值。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="0458" class="mx lw it mt b gy my mz l na nb">SELECT week, department, revenue, AVG(revenue) <br/>OVER(ORDER BY week ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) <br/>AS 'moving average' <br/>FROM SALES_2021 <br/>WHERE department = 'Property';</span></pre><p id="fb37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一行的内容与前面的例子几乎相同，只是现在采用的是收入的平均值而不是总和。OVER子句再次使用ORDER BY语句来按时间顺序保存周。它还详细描述了哪些行要进行移动平均。由于本例说明了过去3周的情况，因此取当前行和前面2行的平均值。</p><p id="98ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再次添加一个别名，将该列标记为“移动平均值”,以提高可读性。</p><p id="3713" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，添加了一个额外的WHERE子句，以确保只使用来自财产部门的收入。如果省略，移动平均数将包括所有部门的数字。为了将它们分开，也可以在OVER子句中使用PARTITION BY子句，与前面的示例非常相似。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/7f6d0fee627ad48bf9ca042bf08391a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*Rv1mnK2D-DyvaFFsqU6Jbg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">物业部首五个星期的流动平均数</p></figure><h1 id="016e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用OVER子句进行排序</h1><p id="bf10" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">最后，让我们假设一个利益相关者要求对每周的收入进行排名。他们可能想回顾自己表现最好和最差的几周，以确定是什么影响了他们的表现。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="232c" class="mx lw it mt b gy my mz l na nb">SELECT week, department, revenue, RANK() <br/>OVER(ORDER BY revenue DESC) AS 'rank' <br/>FROM SALES_2021 <br/>WHERE department = 'Management';</span></pre><p id="13a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SELECT子句包含不带任何参数的RANK函数。OVER子句simple包含一个ORDER BY函数，指示将根据收入对行进行排序。请注意WHERE子句，该子句仅指示来自管理部门的结果。如果没有它，OVER子句中将需要一个额外的PARTITION BY语句。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/b3ef3d495651bdaa302a27778925aa02.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*9njikzEfu3Kn5NXPDQhJEg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表现最好的前五周</p></figure><p id="4130" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，即使两个值相等，RANK函数也会分配一个序列号。例如，如果第20周和第30周都筹集了10，000美元的收入，则第20周为第一，第30周为第二。</p><p id="50d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了允许值之间的联系，DENSE_RANK函数可以在查询中同样使用:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="f6a3" class="mx lw it mt b gy my mz l na nb">SELECT week, department, revenue, DENSE_RANK() <br/>OVER(ORDER BY revenue DESC) AS 'rank' <br/>FROM SALES_2021 <br/>WHERE department = 'Management';</span></pre><p id="f779" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，第20周和第30周都将获得排名为$10，000的第一名；然而，该排名将跳过第二名，授予下一个最高周第三名，类似于奥运会在比赛中处理平局的方式。</p><h1 id="aa5f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="3ea6" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">OVER子句提供了一种对数据实现窗口函数的便捷方式。在普通函数中使用，如运行总计和移动平均，它也可以用于迭代任意数量的数据转换的数据子部分。</p></div></div>    
</body>
</html>