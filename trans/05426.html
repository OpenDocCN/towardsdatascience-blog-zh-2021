<html>
<head>
<title>Log errors in SQL Server that would otherwise go unnoticed (+ examples)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">记录SQL Server中的错误，否则这些错误会被忽略(+示例)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/catch-sql-server-errors-that-would-otherwise-go-unnoticed-examples-85f35d557fff?source=collection_archive---------25-----------------------#2021-05-13">https://towardsdatascience.com/catch-sql-server-errors-that-would-otherwise-go-unnoticed-examples-85f35d557fff?source=collection_archive---------25-----------------------#2021-05-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4293" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">检测、分析和记录我的查询中的错误</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cc4ede48b1018611a513cbb2267000ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DBjx4Z9B1N1sDvhh"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">检测错误..(图片由<a class="ae ky" href="https://www.pexels.com/photo/radio-telescope-under-bright-starry-sky-6325003/" rel="noopener ugc nofollow" target="_blank">像素</a>上的<a class="ae ky" href="https://www.pexels.com/@igor-14869791" rel="noopener ugc nofollow" target="_blank">伊戈尔</a>拍摄)</p></figure><p id="fc5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当查询执行失败时，我可以看到哪里出错并调整我的查询。通常像存储过程这样的数据库对象会被API或其他存储过程调用。当出现问题时，没有人会注意到，通常几个小时、几天或几周后，当客户打电话给你说一些数据丢失时，你会注意到。</p><p id="2ec5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">理想情况下，您希望尽快知道数据库出错的原因、时间和位置，以便可以修复查询。本文向您展示了一种监视数据库进程和检测何时出错的简单方法。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b633" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">准备</h1><p id="715f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">SQL Server Management Studio在捕捉大量语法错误方面做得很好。尽管有时错误是不可预料的。考虑依赖用户输入或使用动态SQL创建查询的情况。我将使用一个简单的查询来说明意外的用户输入；一个完全不必要的存储过程，允许用户指定一个表。然后，SP将检索该表记录计数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="fb01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于不熟悉动态SQL的人:在这个SP中，我们可以确定查询的内容。我们声明一个名为@query的字符串，它包含我们想要执行的查询。用户可以将他们的模式名和表名传递给存储过程。然后，SP将创建查询并执行它。</p><p id="db1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们测试一下我们的SP是否真的工作:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/6a214d65bc6dbb4d380fc4c118389cb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*9fZoFmVObrtUla_rGftxVg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">计算sys.columns表中的记录数</p></figure><p id="d2c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了，成功了！但是当我们传递一个不存在的模式或表时会发生什么呢？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/f8d0b2ef5e29ff9c46cf3809cf2ad4db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/1*KGxvzdUYgfQqWTYcia_pIg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">试图计算一个不存在的模式中的记录数</p></figure><p id="a976" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">问题是我们的剧本失败了，被删掉了。当我坐在笔记本电脑前执行这个脚本时，我看到并理解了错误，因此我可以做些什么。但是想象一下，如果这个SP被一个或多个API调用。这里没有用户参与，所以错误不会被注意到。在我们的脚本中检测这些类型的错误是非常重要的，所以让我们来看看我们将如何准确地做到这一点。</p><h1 id="c423" class="mc md it bd me mf nd mh mi mj ne ml mm jz nf ka mo kc ng kd mq kf nh kg ms mt bi translated">检测和记录错误</h1><p id="27e3" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">使用Try-Catch块很容易检测错误；大多数程序员都很熟悉它们。SQL Server中一个不太为人所知的特性是，如果代码失败，您还可以获得各种信息。在下面的SP中，我们以<code class="fe ni nj nk nl b">ERROR_MESSAGE()</code>为例获取更多信息。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="aecd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再次使用一些错误的参数<code class="fe ni nj nk nl b">EXEC dbo.tablecounter 'sys', 'columns';</code>执行这个SP会产生下面的输出。请注意，我们还获得了发生错误的SP的名称(obj_name)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/2b6b33d154b460cdd0e86c36555b728e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*05Eun5Z48GcN0ub-vWgqHA.png"/></div></div></figure><h1 id="ea5e" class="mc md it bd me mf nd mh mi mj ne ml mm jz nf ka mo kc ng kd mq kf nh kg ms mt bi translated">记录您的错误</h1><p id="9c5d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们有工具来创建一个非常好的函数来记录我们所有的错误。让我们从创建一个存储所有错误信息的表开始。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="21db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们修改前面的存储过程，以便在出现错误时记录错误。它还会打印出一条消息，以便我们进行测试:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="c6a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们有了一个表，我们可以监视该表来查看在我们实现了错误日志记录功能的数据库中发生的所有错误。让我们用下面的查询试几次。第一个查询将会成功；其余的都会失败。</p><pre class="kj kk kl km gt nn nl no np aw nq bi"><span id="5756" class="nr md it nl b gy ns nt l nu nv">EXEC dbo.tablecounter 'sys', 'columns';<br/>EXEC dbo.tablecounter 'sys', 'taaables';<br/>EXEC dbo.tablecounter 'nope', 'columns';<br/>EXEC dbo.tablecounter null, 'columns';</span><span id="d54a" class="nr md it nl b gy nw nt l nu nv">Select * <br/>FROM dbo.ErrorLog;</span></pre><p id="8cc3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">执行这些过程将在我们的ErrorLog表中产生以下记录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/c635724301d5d4b86b6d3b8303081c93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qbqdJ7pgiW9Aez1Oa5BQZQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的误差记录表</p></figure><p id="f72c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，您可以通过ErrorDateTime和my the eminent(userName)来过滤该表。您还可以使用ObjectName回溯代码(我们的错误发生在“tablecounter”存储过程中)。还要注意，在我们的新脚本中，我们有可能引发错误。如果没有设置模式名或表名，我们选择让脚本失败。然后，我们可以指定自己的ErrorMessage(参见ErrorLog表中的记录#3)。</p><p id="ac90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我们实现了这个表，可能性是无限的:</p><ol class=""><li id="2e4f" class="ny nz it lb b lc ld lf lg li oa lm ob lq oc lu od oe of og bi translated">我们可以创建一个监视器，它每分钟刷新一次，并查询这个表中最后一分钟的记录</li><li id="d7ab" class="ny nz it lb b lc oh lf oi li oj lm ok lq ol lu od oe of og bi translated">向跟踪其状态的错误日志中添加新表(0 =新，1 =已解决等)</li><li id="f817" class="ny nz it lb b lc oh lf oi li oj lm ok lq ol lu od oe of og bi translated">我们可以使用触发器来扩展更多的功能，例如将消息推入消息队列。您可以在消息队列上连接多个服务(一旦记录了错误，就会收到一封电子邮件！)</li></ol><h1 id="520b" class="mc md it bd me mf nd mh mi mj ne ml mm jz nf ka mo kc ng kd mq kf nh kg ms mt bi translated">结论</h1><p id="e739" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在代码中需要的地方应用Try-Catch块，但是不要忘记记录错误。这些提供了有价值的信息，有助于找出那些不被注意的bug。狩猎愉快！</p><p id="8a24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="1023" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page的缩写）学生:比如我正在做的事情？<a class="ae ky" href="https://mikehuls.medium.com" rel="noopener">跟着我</a>！</p></div></div>    
</body>
</html>