<html>
<head>
<title>How to Deploy dbt to Production using GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用GitHub操作将dbt部署到生产环境中</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-deploy-dbt-to-production-using-github-action-778bf6a1dff6?source=collection_archive---------2-----------------------#2021-08-21">https://towardsdatascience.com/how-to-deploy-dbt-to-production-using-github-action-778bf6a1dff6?source=collection_archive---------2-----------------------#2021-08-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fe06" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何将dbt部署到生产环境中。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/644fb5a692ab808f0bf4a2a85a1dd91a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G_a45H5A_8tVcNfu"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@samloyd?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">萨姆·劳埃德</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="297b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着现代数据栈的兴起，越来越多的人使用dbt作为数据转换的主要工具，也就是数据建模。Fishtown的员工创造了一个令人惊叹的dbt云产品，能够满足大大小小的数据团队的需求。借助dbt Cloud，任何分析师，无论是经验丰富的还是新手，都可以轻松地开始建模并将数据转换管道部署到生产中。</p><p id="43b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我强烈推荐看看dbt Cloud，因为该产品不仅仅是帮助您部署dbt。首先，让我们看看如何不应该将dbt部署到生产环境中。</p><h1 id="7297" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">不要做什么</h1><p id="5501" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">有许多方法可以将dbt部署到生产环境中。然而，并不是所有的方法都是好的。以下是一些不太好的方法:</p><h2 id="58ef" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">启动一个计算实例？</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/d6bcbcc7b7aec329c3cedcfa58524e9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xoYZkyIRSzmATA2Y"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">洛伦佐·埃雷拉在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="469a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一种常见的方法是启动计算实例并安装所需的包。从这里，人们可以运行一个cron作业来按计划执行<code class="fe nf ng nh ni b">git pull</code>和<code class="fe nf ng nh ni b">dbt run</code>。</p><p id="7fc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一个经典的过度解决方案，因为dbt不需要大量的资源来运行。dbt实际做的是编译查询，并将它们发送到您的数据仓库并等待响应。如果您想要管道故障通知，您通常也必须自己实现。</p><p id="e6fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，大多数时候，您的实例将会闲置浪费您的资金，因为dbt通常一天只运行几分钟到不到一个小时。使用此选项也没有简单的解决方案来实现CI/CD。</p><h2 id="ae6e" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">好的，气流呢？</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/2566502719a3f161c67bdc9af65bd0f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QqmGtUw6jVi4SK3f"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@michalmatlon?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Michal Matlon </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="32dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嗯，看情况。如果生产中还没有气流运行，现在可能就不需要了。还有比这更简单/优雅的解决方案(dbt Cloud，GitHub Actions，GitLab CI)。此外，这种方法与使用计算实例有许多共同的缺点，例如浪费资源，并且没有CI/CD的简单方法。</p><p id="b33c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，如果您的团队使用Airflow或任何其他管道编排器，您可以考虑编写一个dag来触发dbt。特别是当你在不同的时间间隔有不同的摄入，需要触发dbt或随后的任务时。</p><h1 id="4c0f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用dbt云在生产中部署dbt</h1><p id="0332" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在我看来，这是首选。借助dbt Cloud，您拥有一个永远免费的开发人员席位，一个人的数据团队绝对可以利用这个席位。如果您的团队规模较大，您可以每人每月支付少量费用，并获得以下所有功能:</p><ul class=""><li id="e816" class="nk nl it lb b lc ld lf lg li nm lm nn lq no lu np nq nr ns bi translated">基于浏览器的<a class="ae ky" href="https://docs.getdbt.com/docs/the-dbt-ide" rel="noopener ugc nofollow" target="_blank"> IDE </a></li><li id="4c67" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">作业调度</li><li id="d2f3" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">每日不限跑步次数</li><li id="3610" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">记录和警报</li><li id="a030" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">数据文档</li><li id="010b" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">GitHub和GitLab集成</li><li id="8dab" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">源新鲜度报告</li><li id="04d4" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">根据拉取请求构建</li></ul><h1 id="4498" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用GitHub动作在生产中部署dbt</h1><p id="6293" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">因为dbt总是使用git部署，所以利用您选择的git提供者的CI/CD功能是将dbt部署到生产环境的最佳方式。使用这种方法，您将获得很大的灵活性。</p><p id="eaee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看如何使用<a class="ae ky" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Action </a> s来做到这一点。免费配额对您和您的团队来说可能足够了，但是如果您有一个大型团队或者在其他项目中使用GitHub Action，您可能会达到配额并需要升级。</p><h2 id="907d" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">为GitHub操作设置dbt配置文件</h2><p id="451a" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在您的存储库的根目录下创建一个<code class="fe nf ng nh ni b">profiles.yml</code>文件。每次运行时，dbt都会在settings中查找这个文件进行读取。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="a3a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果使用不同于BigQuery的数据仓库，请确保相应地更改参数。按照这里的<a class="ae ky" href="https://docs.github.com/en/actions/reference/encrypted-secrets" rel="noopener ugc nofollow" target="_blank">指令</a>，环境变量可以被定义为GitHub中的存储库机密。</p><p id="c281" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，我们对不同的环境有两个不同的目标:dev和prod。运行dbt run将默认为dev(由target键配置)。如果您想在prod目标上运行，请使用<code class="fe nf ng nh ni b">dbt run --target prod</code>。</p><h2 id="5c42" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">设置凭据</h2><p id="57cf" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在使用GitHub操作运行任何东西之前，您需要一个服务凭证来验证对您的数据仓库的访问。强烈建议您为此创建一个专用凭据，而不是使用您自己的帐户。这样，如果您由于某种原因无法访问您的帐户，该服务仍将运行。</p><p id="b11c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请务必授予您的帐户必要的权限。在上面的例子中，我们使用BigQuery，这意味着创建一个<code class="fe nf ng nh ni b">github-action</code>服务帐户，授予它对数据源的读权限和对数据目的地的写权限。</p><p id="d2b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用文件凭证(服务帐户而不是用户名和密码)，您仍然可以像上面一样使用GitHub secret，并使用<code class="fe nf ng nh ni b">echo</code>命令将其写入文件。</p><h2 id="78e5" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">dbt按计划运行</h2><p id="7db6" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">您可以使用下面的模板来添加在cron时间表上运行的GitHub Actions作业。将此文件添加到您的repo中的<code class="fe nf ng nh ni b">.github/workflows/</code>文件夹。如果文件夹不存在，请创建它们。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="5d4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个脚本将为大多数dbt工作流执行必要的步骤。如果您有另一个特殊命令，如snapshot命令，您可以在中添加另一个步骤。</p><p id="770c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<a class="ae ky" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank"> cron调度</a>触发该工作流。上面配置的计划意味着每天在UTC时间上午5点和下午5点运行工作流。所有时间都采用UTC，因此您可能希望将时间表转换为您的本地时间。</p><p id="4747" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样，作业每天会被触发两次，如果作业失败会通知你。</p><h2 id="7d1f" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">合并时运行dbt</h2><p id="9623" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">许多开发团队的一个常见工作流程是，每当代码库发生变化时，就创建<code class="fe nf ng nh ni b">pull requests</code>。对上面的<code class="fe nf ng nh ni b">yml</code>文件进行简单的修改就可以实现这一点。</p><pre class="kj kk kl km gt oa ni ob oc aw od bi"><span id="3366" class="ms lw it ni b gy oe of l og oh">push:<br/>    branches:<br/>      - main</span></pre><p id="6f36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据所需的行为，您可以为此创建一个新的工作流或将其与上面的工作流合并。将两者分开的一个常见用例是只运行在合并到main时发生变化的模型。这可以通过使用dbt <a class="ae ky" href="https://docs.getdbt.com/docs/dbt-cloud/using-dbt-cloud/cloud-enabling-continuous-integration-with-github" rel="noopener ugc nofollow" target="_blank"> slim CI </a>特性来实现，这是另一篇文章的主题。</p><h2 id="c5b0" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">使用拉取请求进行测试</h2><p id="077d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">此事件的工作流脚本与上面的非常相似。一个主要的区别是，这个工作流将在开发环境而不是生产环境中运行。这确保了任何更改在部署到生产环境之前都经过验证、审查和测试。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="74eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以看到我们不需要指定目标，因为dev是我们的<code class="fe nf ng nh ni b">profiles.yml</code>文件中的默认目标。每次有一个<code class="fe nf ng nh ni b">pull request</code>到main，这个工作流就会运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/cc1f65ec15372084254b45ed7be18463.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X-egE9UuYMojMdDVYBfDfQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一次成功的工作流运行—作者提供的图片</p></figure><p id="412e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在较小的型号上，GitHub Actions只需要1分钟就可以完成所有工作。还不错！如果你有太多的模型或者太多的数据，那么每次都运行是没有意义的。我将在以后的文章中解决这个问题。</p><h2 id="8f64" class="ms lw it bd lx mt mu dn mb mv mw dp mf li mx my mh lm mz na mj lq nb nc ml nd bi translated">林挺与sqlfluff</h2><p id="1578" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在编写SQL模型时，我错过的一件事是一个好的linter。遵循一致同意的约定是很重要的，这样你的代码库就不会随着时间的推移而失去控制。使用dbt的林挺有点复杂，因为它实际上是使用不同方言的Jinja SQL。</p><p id="42ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们最终能够采用的一个好方法是<a class="ae ky" href="https://github.com/sqlfluff/sqlfluff" rel="noopener ugc nofollow" target="_blank"> sqlfluff </a>。然而，它并不是100%没有错误，所以要小心。您只需要运行<code class="fe nf ng nh ni b">pull request</code>到<code class="fe nf ng nh ni b">main</code>工作流的linter。为此，请将以下步骤添加到您的工作流程中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="9f21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我也在这里分享我们的sqlfluff配置<a class="ae ky" href="https://gist.github.com/tuanchris/c0624f63a95ea1e6b18c0092ac1608c7" rel="noopener ugc nofollow" target="_blank">，供你参考。</a></p><h1 id="b66e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="24bd" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这星期就这些了。我们涵盖了:</p><ul class=""><li id="92ca" class="nk nl it lb b lc ld lf lg li nm lm nn lq no lu np nq nr ns bi translated">为GitHub操作设置dbt和凭证</li><li id="f30f" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">在cron调度上运行dbt</li><li id="226c" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">对main的pull请求运行dbt</li><li id="221a" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">使用sqlfluff的林挺dbt代码</li></ul><p id="f50f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi">✌️</p></div></div>    
</body>
</html>