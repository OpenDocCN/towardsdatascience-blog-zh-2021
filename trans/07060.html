<html>
<head>
<title>Convert your Emotion Recognition Notebook into an API without extra code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的情绪识别笔记本转换为API，无需额外代码</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/convert-your-emotion-recognition-notebook-into-an-api-without-extra-code-bc13421d2ed5?source=collection_archive---------22-----------------------#2021-06-26">https://towardsdatascience.com/convert-your-emotion-recognition-notebook-into-an-api-without-extra-code-bc13421d2ed5?source=collection_archive---------22-----------------------#2021-06-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="723f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在Jupyter笔记本中训练情感识别，并使用Cuttle将其转换为Flask API项目，无需额外代码</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5e2393eb450e8609ab885a0ac79b4426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8ZVQa3_Tzpy4cegO"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源:<a class="ae kv" href="http://unsplash.com" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="3cb2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于经常使用Jupyter笔记本进行开发和测试的人来说，您可能已经习惯了一直复制和粘贴代码。</p><blockquote class="ls lt lu"><p id="fad6" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">删除测试代码片段，使用不同的IDE来编译和测试您的代码，以及开发API只是ML开发人员所习惯的一些耗时的任务。</p></blockquote><p id="53e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们能够自动化构建一个API项目所需的样板代码的苦差事，那不是很好吗？<strong class="ky ir"> </strong>这里我们将在Jupyter笔记本中训练一个情绪识别模型，并将其转换为Flask API项目，完全不需要额外的代码！</p><h1 id="36d8" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">属国</h1><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="b180" class="mw ma iq ms b gy mx my l mz na">pip install <br/>tensorflow==2.5.0 Keras==2.4.3 numpy==1.19.5 opencv-python==4.4.0.44</span></pre><p id="3f76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还需要安装<a class="ae kv" href="http://www.cuttle.it" rel="noopener ugc nofollow" target="_blank">卡特尔</a>来将我们的ML笔记本转换成Flask API项目。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="35f4" class="mw ma iq ms b gy mx my l mz na">pip install cuttle</span></pre><h1 id="5ef4" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">资料组</h1><p id="6630" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">你可以在情感识别上使用任何数据集，也可以创建自己的数据集。在本文中，我们使用Kaggle上的情感识别数据集。你应该在这里找到它<a class="ae kv" href="https://www.kaggle.com/jonathanoheix/face-expression-recognition-dataset" rel="noopener ugc nofollow" target="_blank">。该数据集包含7类图像:愤怒、厌恶、恐惧、快乐、中性、悲伤和惊讶。如果您想添加另一个类，只需创建一个新目录并添加属于该类的图像。</a></p><p id="21ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在与您下载的数据集相同的目录中创建笔记本，其中包含“train”和“validation”文件夹。</p><h1 id="9593" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">进口</h1><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><h1 id="be4f" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">数据集扩充</h1><p id="4914" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">ImageDataGenerator允许您在每个训练图像上使用图像增强、变换来拟合模型，还可以传递任何预处理函数(如果可用)。</p><p id="a927" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们重新缩放图像是因为颜色的范围是从[0–255]，重新缩放图像会转换范围为[0–1]的每个像素值。这里，我们将模型的目标大小定义为48x48，将batch_size定义为64。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><h1 id="f5dd" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">模特培训</h1><p id="22d1" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">我们在这里定义一个CNN，但是你可以选择使用任何预先训练好的模型，比如VGG16或者ResNet，或者也可以使用迁移学习。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="2de5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完成训练后，您的模型会保存在给定的路径中。</p><h1 id="477b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">情感识别</h1><p id="15d8" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">我们现在加载模型，给它一个图像并测试它。在这一步，让我们引入cuttle，并将结果函数转换成任何前端应用程序都可以访问的API。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="2892" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们使用一个测试图像“test.jpeg”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/8a5683a025670e9750c8e41361dff77d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9xIPrBdL1JwWIUlO"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源:<a class="ae kv" href="http://unsplash.com" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="d5a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们从模型预测中得到的输出是<strong class="ky ir">‘恐惧’</strong>。继续用更多的图像进行测试，直到你对模型的准确性和结果满意为止。让我们看看如何将它转换成一个API项目。</p><h1 id="c866" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">初始化卡特尔</h1><p id="b032" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">如下用“cuttle init”初始化cuttle，并输入正在使用的笔记本的名称。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/d5d9ab2a36a1131ade4a51009b399a55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bWgPEeZay_g7lQGAykf_JA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源—作者</p></figure><h1 id="305b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">创建卡特尔环境</h1><p id="15b5" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">在这一步中，您命名环境，指定您正在使用的平台，以及您想要使用的转换器。我们想在这个场景中使用<strong class="ky ir">烧瓶</strong>变压器。您可以选择一个方便的环境名称。我用了“<strong class="ky ir">情感记录</strong>”作为例子。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/7fc12d79a8048bc239123b4ed0bfccc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-RL2yKuOMdBuvUvNvqL-DA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源—作者</p></figure><p id="2dec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此时，您的<strong class="ky ir">应该是这样的:</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/c2a14352309fef9e7dc2d93363d5bca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8YAeO54RDofDXt9V7-rJwg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源—作者</p></figure><p id="cfb4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完成配置创建后，就该编辑Jupyter笔记本以包含cuttle配置了。我们只需要编辑代码的最后一部分来定义API路由并设置输出配置。</p><p id="eafa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">向单元格添加配置:</strong></p><p id="df6a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们使用Cuttle config来执行两个主要操作，如这里的<a class="ae kv" href="https://github.com/CuttleLabs/Emotion-Recognition-API/blob/main/Emotion_recogniser.ipynb" rel="noopener ugc nofollow" target="_blank">和</a>所示。</p><ul class=""><li id="0623" class="nm nn iq ky b kz la lc ld lf no lj np ln nq lr nr ns nt nu bi translated">禁用训练步骤并从保存的模型文件中加载，这样就不用每次运行脚本时都重新训练。</li><li id="84d0" class="nm nn iq ky b kz nv lc nw lf nx lj ny ln nz lr nr ns nt nu bi translated">指定每次调用API时要执行的单元以及必需的参数</li></ul><p id="d6ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要禁用单元格，请在单元格的开头添加此配置。</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="fd3d" class="mw ma iq ms b gy mx my l mz na">#cuttle-environment-disable emotion-rec</span></pre><p id="f48d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在添加config将您的脚本转换成API，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="21a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们正在设置两个配置:<strong class="ky ir">切割环境设置配置</strong>和<strong class="ky ir">切割环境分配</strong>配置。它们分别是单元格范围和行范围。单元范围的配置设置了在转换<strong class="ky ir">单元</strong>期间所需的配置。行范围的配置允许我们配置<strong class="ky ir">变量</strong>。</p><p id="4859" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在第一行中，我们设置了单元范围的配置，指定了我们选择的环境名称、方法和路由。我们还配置了变量“file ”,允许我们从请求方法和将作为我们响应的“output”变量中获取-config。</p><h1 id="efdc" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">改变</h1><p id="139d" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">我们的最后一步是使用我们一直使用的环境名进行cuttle-transform。让我们来看看如何:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/a5f2ab586e5b4e59b429c4cbfa7aa9d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lgC-xQFOnINSFhrZ0GV6Hw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源—作者</p></figure><p id="55d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个步骤之后，您应该会看到一个<strong class="ky ir">输出目录</strong>，它由另一个包含环境名称的子目录组成。转到这个目录，找到您转换成API的代码。以下列身份运行该文件:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/e6cc87dff28216f31807adc54ec5aac9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OtSGyfjeAyHI09iruqHqKg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源—作者</p></figure><p id="ea43" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们的代码默认运行在本地主机端口5000上。通过使用Postman发送图像来测试这一点，以获得您的响应。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/c020dd9be09bf6ab834567cd308624e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P8SDk23DMo2NYSTNZehkeA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">test.jpeg通过POST请求发送到我们的flask API。来源—作者</p></figure><p id="8b74" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的API项目现在可以部署了！Cuttle还允许您将笔记本转换为脚本或管道。</p><h1 id="ab3d" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">资源</h1><p id="20ac" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">卡特尔网站:<a class="ae kv" href="https://www.cuttle.it/?utm_source=medium_article" rel="noopener ugc nofollow" target="_blank"> cuttle.it </a> <br/> Github: <a class="ae kv" href="https://github.com/CuttleLabs/Emotion-Recognition-API" rel="noopener ugc nofollow" target="_blank">情感识别API源</a>T5】卡特尔源:<a class="ae kv" href="https://github.com/CuttleLabs/cuttle-cli" rel="noopener ugc nofollow" target="_blank">卡特尔CLI源</a></p><p id="9f78" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你也可以在推特上找到我们@<a class="ae kv" href="https://twitter.com/cuttlehq" rel="noopener ugc nofollow" target="_blank">https://twitter.com/cuttlehq</a></p></div></div>    
</body>
</html>