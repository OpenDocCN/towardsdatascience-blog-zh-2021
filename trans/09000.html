<html>
<head>
<title>Setting up Conda to Run PyData Stack on your Apple M1 Silicon Machine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设置Conda在您的苹果M1硅机器上运行PyData堆栈</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/setting-up-conda-to-run-pydata-stack-on-your-apple-m1-silicon-machine-55e0b8320f65?source=collection_archive---------22-----------------------#2021-08-19">https://towardsdatascience.com/setting-up-conda-to-run-pydata-stack-on-your-apple-m1-silicon-machine-55e0b8320f65?source=collection_archive---------22-----------------------#2021-08-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="67fc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用mambaforge为您的ARM64芯片安装诸如Dask、XGBoost和Coiled等PyData库的分步指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/24401bf6e58d0daae132bf5d43d55852.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wz9GV9dH1XOdyeEdqt661g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Michael Dziedzic通过<a class="ae ky" href="https://unsplash.com/@lazycreekimages" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的图片</p></figure><h1 id="8c7c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">TL；博士；医生</h1><p id="e16c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在苹果M1机器上运行PyData库需要你使用一个ARM64定制版本的conda-forge。本文提供了如何在您的机器上设置它的分步指南。然后讨论了一些特定于运行Dask、Coiled和XGBoost的问题。我希望这能对遇到类似问题的人有所帮助。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="3ba4" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">M1的PyData</h1><p id="4454" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">苹果M1硅芯片是一项了不起的创新:它低功耗、高效率、电池寿命长，而且价格便宜。但是，如果您使用默认版本运行PyData堆栈，您可能会遇到一些奇怪的行为。</p><p id="442f" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">当您安装为英特尔CPU架构编写的库时，代码将通过Rosetta仿真器运行。这通常很有效，但可能会给特定的PyData库带来意想不到的问题。例如，当导入一个&lt;100MB dataset.</p><p id="586f" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">Since the internals of Rosetta is proprietary, there’s no way to know exactly why this is happening.</p><h1 id="d88f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Installing PyData Libraries using Mambaforge</h1><p id="2b31" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">But fear not, there <em class="ne">是</em>的一种前进方式时，我个人遇到了Dask的内存使用爆炸。您可以通过安装ARM64-native版本的PyData库来解决这种奇怪的行为。虽然对于大多数安装，我通常会推荐Anaconda/miniconda，但是目前，<strong class="lt iu"> mambaforge </strong>部署似乎拥有最平滑的ARM安装过程。</p><p id="587a" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">下面是安装这个版本的conda并使用它来安装您最喜欢的PyData库的分步指南。</p><p id="e21e" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><strong class="lt iu"> 1。检查您的conda版本</strong></p><ul class=""><li id="ec77" class="nf ng it lt b lu mz lx na ma nh me ni mi nj mm nk nl nm nn bi translated">要检查您的conda安装，请在您的终端中键入<code class="fe no np nq nr b">conda info</code>并检查<code class="fe no np nq nr b">platform</code>键的值。这个应该说<code class="fe no np nq nr b">osx-arm64.</code></li><li id="4494" class="nf ng it lt b lu ns lx nt ma nu me nv mi nw mm nk nl nm nn bi translated">如果没有，继续删除包含您的conda安装的文件夹。请注意，这将删除您的软件环境，因此请确保将这些环境另存为。yml或者。txt文件。您可以通过在终端中键入<code class="fe no np nq nr b">conda list - export &gt; env-name.txt</code>或<code class="fe no np nq nr b">environment.yml</code>来导出活动软件环境的“配方”。</li></ul><p id="569a" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><strong class="lt iu"> 2。下载曼巴福吉安装程序</strong></p><p id="7198" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><strong class="lt iu"> 3。运行安装程序。</strong></p><ul class=""><li id="0243" class="nf ng it lt b lu mz lx na ma nh me ni mi nj mm nk nl nm nn bi translated">这应该会问你是否希望它为你运行<code class="fe no np nq nr b">conda init</code>。选择“是”。</li><li id="f41c" class="nf ng it lt b lu ns lx nt ma nu me nv mi nw mm nk nl nm nn bi translated">如果由于某种原因它没有这样做(在我的例子中就发生了)，您将不得不使用/path/to/mamba forge/bin/conda init zsh自己运行<code class="fe no np nq nr b">conda init</code>。请注意，<code class="fe no np nq nr b">zsh</code>只有在您使用<code class="fe no np nq nr b"> zsh</code>外壳时才有效。根据需要使用其他shell标志。</li></ul><p id="8cda" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">重启终端后，你现在应该可以像往常一样使用<code class="fe no np nq nr b">conda</code>了。例如，你可以从使用<code class="fe no np nq nr b">conda env create -f &lt;path/to/environment.yml&gt;</code>重建你的软件环境开始。</p><h1 id="05f5" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">运行Dask、Coiled和XGBoost时的具体问题</h1><p id="8195" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">下面是我在Coiled上尝试使用Dask和XGBoost运行工作负载时遇到的一些问题的进一步说明:</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="23ce" class="ob la it nr b gy oc od l oe of">import coiled <br/>from dask import Client <br/>import dask.dataframe as dd </span><span id="35c1" class="ob la it nr b gy og od l oe of">cluster = coiled.Cluster() <br/>client = Client(cluster) <br/>ddf = dd.read_parquet("&lt;path/to/100MB/file/on/s3&gt;") <br/>ddf = ddf.persist()</span></pre><p id="c80c" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">我遇到了三个问题，我想分享我的解决方案，因为我可以想象其他人可能也会遇到这种情况:</p><ol class=""><li id="6ca2" class="nf ng it lt b lu mz lx na ma nh me ni mi nj mm oh nl nm nn bi translated">Dask的内存使用量在导入小(&lt;100MB) dataset with an error like the one below:</li></ol><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="4828" class="ob la it nr b gy oc od l oe of">distributed.nanny - WARNING - Worker exceeded 95% memory budget. Restarting</span></pre><p id="0bbe" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">2. In some software environments, my kernel was crashing when calling <strong class="lt iu">导入盘绕</strong>时爆炸</p><p id="8212" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">3.切换到mambaforge部署后，我无法安装XGBoost。</p><p id="21c9" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">以下是我想出的解决办法。</p><p id="cca6" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><strong class="lt iu"> 1。Dask </strong></p><p id="9f36" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">第一个问题通过切换到mambaforge并从那里安装所有需要的PyData库得到了解决，如上面的分步指南所述。</p><p id="407b" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><strong class="lt iu"> 2。盘绕的</strong></p><p id="c79c" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">第二个问题是由于<strong class="lt iu"> python-blosc </strong>库引起的冲突。由于某种未知的原因，当导入带有分段错误的<strong class="lt iu"> python-blosc </strong>(例如作为<code class="fe no np nq nr b">import coiled</code>的一部分)时，苹果M1机器上的内核崩溃。为了避免这种情况，请确保您当前的软件环境中没有安装python-blosc。如果是，运行<code class="fe no np nq nr b">conda uninstall python-blosc</code>将其移除。</p><p id="ca0e" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><strong class="lt iu"> 3。XGBoost </strong></p><p id="8d10" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">最后，如果你想在你的苹果M1机器上运行XGBoost，你需要跳过一些额外的环节，因为目前conda-forge上没有arm64兼容版本的XGBoost。这不是问题，因为XGBoost本身实际上可以在你的苹果M1机器上运行；问题在于XGBoost安装的依赖项，特别是numpy、scipy和scikit-learn。这些依赖项需要与arm64兼容，我们将通过完成以下步骤来确保这一点:</p><p id="dc99" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">1.创建一个包含Python、numpy、scikit-learn和scipy的新conda环境。在这里使用conda而不是pip来安装这些依赖项是至关重要的。</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="f46f" class="ob la it nr b gy oc od l oe of">conda create -n xgboost</span><span id="b87f" class="ob la it nr b gy og od l oe of">conda activate xgboost</span><span id="0a51" class="ob la it nr b gy og od l oe of">conda install python=3.8.8 numpy scipy scikit-learn</span></pre><p id="3350" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">2.安装必要的库来编译XGBoost</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="9cfc" class="ob la it nr b gy oc od l oe of">conda install cmake llvm-openmp compilers</span></pre><p id="4c8f" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">3.现在我们已经有了正确的依赖项，我们可以从pip安装XGBoost了。这很好，因为我们已经安装了所有合适的arm-64依赖项。</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="dd29" class="ob la it nr b gy oc od l oe of">pip install xgboost</span></pre><p id="7703" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">4.带它去兜一圈！</p><p id="1ff1" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">注意:上面的步骤是由<a class="ae ky" href="https://medium.com/u/926442548db0" rel="noopener"> Fabrice Daniel </a>从<a class="ae ky" rel="noopener" target="_blank" href="/install-xgboost-and-lightgbm-on-apple-m1-macs-cb75180a2dda">这本很棒的教程</a>中总结出来的，并在<a class="ae ky" href="https://twitter.com/isuru_f" rel="noopener ugc nofollow" target="_blank"> Isuru Fernando </a>的帮助下进行了更新。</p><h1 id="b514" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">走向</h1><p id="b605" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">正如任何技术突破一样，随着行业重新校准并适应苹果转向M1芯片所引起的连锁反应，将会有一些阵痛。看到像Anaconda和QuanStack这样的公司以及Conda-Forge社区继续改进对ARM硬件的支持是令人兴奋的，我对PyData的强大未来充满信心！</p><p id="ba48" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">这一次到此为止！我希望这篇文章有助于让你的PyData工作流程在你的苹果M1机器上顺利有效地运行。如果您有任何反馈或问题，或者有更适合您的不同设置，请联系我们！</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><p id="49a0" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><em class="ne">原载于2021年8月19日</em><a class="ae ky" href="https://coiled.io/blog/apple-arm64-mambaforge/" rel="noopener ugc nofollow" target="_blank"><em class="ne">https://coiled . io</em></a><em class="ne">。</em></p></div></div>    
</body>
</html>