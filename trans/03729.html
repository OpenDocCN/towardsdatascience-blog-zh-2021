<html>
<head>
<title>Use and Enhance this Python Class to Download Excel Workbooks and Prepare them for Analytics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用并增强这个Python类来下载Excel工作簿，并为分析做准备</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/use-and-enhance-this-python-class-to-download-excel-workbooks-and-prepare-them-for-analytics-4750ae00d8c2?source=collection_archive---------10-----------------------#2021-03-27">https://towardsdatascience.com/use-and-enhance-this-python-class-to-download-excel-workbooks-and-prepare-them-for-analytics-4750ae00d8c2?source=collection_archive---------10-----------------------#2021-03-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0bca" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Python类c_download_prep_excel从网站上自动下载excel电子表格，并准备用于数据分析项目</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cee74f94256104785df2ecf00c44342e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*feTFHwJcd4s1fhU1SO8-vQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">免费图片，由Pixabay.com提供。</p></figure><h1 id="e654" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">介绍</h1><p id="b811" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">在最近的一篇文章中，我分享了一个从analytics.usa.gov的T2下载报告的Python类。这些文件提供了有关公众如何访问大约5，700个美国政府网站的数据。他们是干净的，同质的设计，并准备在画面中可视化。</p><p id="c866" class="pw-post-body-paragraph lq lr it ls b lt mn ju lv lw mo jx ly lz mp mb mc md mq mf mg mh mr mj mk ml im bi translated">相比之下，美国联邦调查局(FBI)在其网站上公布的一些Excel文件则存在挑战。我需要转换他们的数据，然后才能在数据分析项目中使用它们。本文介绍了一个可重用的Python类，称为c_download_prep_excel，它从网站上下载excel工作簿(如FBI发布的工作簿),并重新构造它们的数据，为数据分析项目做准备。</p><p id="fcf9" class="pw-post-body-paragraph lq lr it ls b lt mn ju lv lw mo jx ly lz mp mb mc md mq mf mg mh mr mj mk ml im bi translated">这种技术和这里介绍的c_download_prep_excel类可以用来从其他站点下载和处理excel文件。任何人也可以修改这个类来处理不同来源的Excel文件和执行其他任务。</p><h1 id="3ccd" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">联邦调查局报告样本</h1><p id="328f" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">我使用了from 2019年<a class="ae mm" href="https://ucr.fbi.gov/crime-in-the-u.s/2019/crime-in-the-u.s.-2019/topic-pages/tables/table-1" rel="noopener ugc nofollow" target="_blank">暴力犯罪统计报告</a>来开发和测试c_download_prep_excel类。单击下载Excel-表1以检索Excel工作簿。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/57b22aea055a51b55f8b6350f23a1cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ByI-WWxg0zpkFcL15TBwPQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">美国联邦调查局2019年美国犯罪报告。图片来自FBI网站。</p></figure><h1 id="143e" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">报告问题</h1><p id="56db" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">下面显示的示例Excel工作表还不能用于数据分析。虽然可以接受在Excel中查看，但应该对其进行清理和转换，以使其适合分析。以下是它的一些问题:</p><ul class=""><li id="011b" class="mt mu it ls b lt mn lw mo lz mv md mw mh mx ml my mz na nb bi translated">第1行到第3行包含元数据的标题信息。</li><li id="849b" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated">第25到31行包含页脚信息，这些信息也是元数据。</li><li id="318f" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated">第1列中的某些年份包含向年份值添加数字的上标。</li><li id="ad04" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated">数据的矩阵格式不适合加载到数据分析工具中。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/aa6e83f0a5ca0a6b55d9bd94c628c3dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SGc51-Fx9TPaeIcK"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">联邦调查局暴力犯罪报告。作者拍摄的图片。</p></figure><h1 id="e4a8" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">解决方案</h1><p id="6a99" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">为了准备用于数据分析的报告，我编写了一个Python类和程序，将数据从原始工作表转录到新工作表中。结果格式如下所示，每行一个数据点(年份、犯罪类型和犯罪率的组合)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/cd92d25a702815edebc34bedca16d52a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/0*2VFEbR8WCHq5OXrv"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将联邦调查局暴力犯罪报告中的数据转换成可供分析的格式。图片由作者提供。</p></figure><p id="b20b" class="pw-post-body-paragraph lq lr it ls b lt mn ju lv lw mo jx ly lz mp mb mc md mq mf mg mh mr mj mk ml im bi translated">可以根据需要使用和增强该类，以便从FBI网站或其他网站下载和准备其他Excel文件。本文后面给出的示例程序执行这些步骤:</p><ol class=""><li id="f54d" class="mt mu it ls b lt mn lw mo lz mv md mw mh mx ml nj mz na nb bi translated">将Excel工作簿从FBI网站下载到本地文件夹。</li><li id="c1d8" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml nj mz na nb bi translated">如果工作簿是xls文件，请以xlsx格式保存一份副本。</li><li id="0867" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml nj mz na nb bi translated">保持xlsx文件的原始工作表不变。相反，创建一个新的工作表，其中包含所需格式的数据。以下步骤描述了将工作表19tbl01中的数据转录到新工作表中。</li><li id="915e" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml nj mz na nb bi translated">创建三个列名:年份、犯罪类型和犯罪率。</li><li id="ec1f" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml nj mz na nb bi translated">对于犯罪类型，在第1列中每年写一行，在第2列中写犯罪类型。</li><li id="0495" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml nj mz na nb bi translated">将包含上标的年份值截断为四位数。</li><li id="f74c" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml nj mz na nb bi translated">将每种犯罪类型的犯罪率数据从原始工作表转录到新工作表中。</li><li id="6f24" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml nj mz na nb bi translated">右对齐第1列和第3列的列名。</li><li id="eea7" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml nj mz na nb bi translated">设置列宽。</li></ol><h1 id="1fff" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">本项目中使用的工具</h1><p id="8664" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">我使用了以下工具来开发程序。</p><ul class=""><li id="bdc5" class="mt mu it ls b lt mn lw mo lz mv md mw mh mx ml my mz na nb bi translated">Python 3.9.2</li><li id="9ee6" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated">微软Excel 365</li><li id="4955" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated">Microsoft Visual Studio社区</li></ul><h1 id="b108" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">程序、c_download_prep_excel类和Python模块</h1><h2 id="9300" class="nk kz it bd la nl nm dn le nn no dp li lz np nq lk md nr ns lm mh nt nu lo nv bi translated">该计划</h2><p id="0e4f" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">下载和准备用于数据分析的Excel工作簿的程序由文件process_fbi_data.py中的控制器模块和文件c_download_prep_excel.py中的c_download_prep_excel类组成。process_fbi_data.py中的代码控制程序。控制器创建c_download_prep_excel的一个实例，并调用它的函数将FBI报告文件的原始工作表中的数据转录并转换到一个新的工作表中。</p><h2 id="684c" class="nk kz it bd la nl nm dn le nn no dp li lz np nq lk md nr ns lm mh nt nu lo nv bi translated">c _下载_准备_excel类</h2><p id="0cbe" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">c_download_prep_excel类执行控制器请求的任务，如上面的解决方案部分所述。它可以根据需要进行修改和增强，以满足特定的要求。</p><p id="2fe6" class="pw-post-body-paragraph lq lr it ls b lt mn ju lv lw mo jx ly lz mp mb mc md mq mf mg mh mr mj mk ml im bi translated">程序控制器和c_download_prep_excel类代码见<strong class="ls iu"> <em class="nw">附录A </em> </strong>。</p><h2 id="1a61" class="nk kz it bd la nl nm dn le nn no dp li lz np nq lk md nr ns lm mh nt nu lo nv bi translated">Python模块</h2><p id="9863" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">程序调用<a class="ae mm" href="https://openpyxl.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> openpyxl </a>模块中的函数来创建新的工作表并格式化数据。该程序还调用<a class="ae mm" href="https://pypi.org/project/pyexcel/" rel="noopener ugc nofollow" target="_blank"> pyexcel </a>函数，这些函数使用pyexcel-xls和pyexcel-xlsx将xls工作簿复制到xlsx工作簿。</p><p id="0e13" class="pw-post-body-paragraph lq lr it ls b lt mn ju lv lw mo jx ly lz mp mb mc md mq mf mg mh mr mj mk ml im bi translated">从命令行运行下面列出的命令，或者如果支持，在您的集成开发环境(IDE)中运行这些命令，以安装这些模块:</p><ul class=""><li id="9a0a" class="mt mu it ls b lt mn lw mo lz mv md mw mh mx ml my mz na nb bi translated">pip安装openpyxl</li><li id="a47d" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated">pip安装pyexcel</li><li id="a84e" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated">pip安装pyexcel-xls</li><li id="0c3f" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated">pip安装pyexcel-xlsx</li></ul><p id="12dd" class="pw-post-body-paragraph lq lr it ls b lt mn ju lv lw mo jx ly lz mp mb mc md mq mf mg mh mr mj mk ml im bi translated">Python包括程序使用的操作系统和请求模块</p><h1 id="aaf2" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">Tableau公共仪表板</h1><p id="3c6f" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">我将支持分析的Excel工作表加载到Tableau Public中，并创建了一个简单的<a class="ae mm" href="https://public.tableau.com/profile/randall.runtsch#!/vizhome/ViolentCrimeintheUnitedStates_16168698396790/ViolentCrime" rel="noopener ugc nofollow" target="_blank">仪表板来显示各种犯罪类型的趋势</a>。</p><h1 id="2926" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">潜在的改进</h1><p id="93a7" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">该程序很好地执行了它的基本任务，从FBI报告电子表格中准备暴力犯罪数据用于数据分析。以下增强功能可以使程序为生产做好准备，并扩展其处理不同格式的各种Excel工作簿的能力。</p><ul class=""><li id="4753" class="mt mu it ls b lt mn lw mo lz mv md mw mh mx ml my mz na nb bi translated">添加<strong class="ls iu">错误处理</strong>来从严重错误中恢复或者优雅地关闭程序。</li><li id="88f8" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated"><strong class="ls iu">将程序活动写入日志文件</strong>，以跟踪程序的启动、完成、错误和动作。</li><li id="dcd8" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated">向类中添加函数以<strong class="ls iu">执行额外的格式化</strong>并应对新电子表格带来的挑战。</li><li id="a7bc" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated"><strong class="ls iu">从其他文件或数据库中查找并替换数据</strong>。</li><li id="959d" class="mt mu it ls b lt nc lw nd lz ne md nf mh ng ml my mz na nb bi translated">执行额外的<strong class="ls iu">数据清理</strong>。</li></ul><h1 id="7627" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">结论</h1><p id="f6cc" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">Excel电子表格可以从网站上手动下载，并手动转换成可供分析的形式。但是程序可以自动完成这项任务。当需要下载多个文件并准备在数据分析项目中使用时，这是非常有益的。另外，如果设计良好，您可以在将来为类似的任务重用Python类和程序。</p><h1 id="967d" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">关于作者</h1><p id="73fa" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">Randy Runtsch是一名数据分析师、软件开发人员、作家、摄影师、自行车手和冒险家。他和妻子住在美国明尼苏达州东南部。</p><p id="2a6e" class="pw-post-body-paragraph lq lr it ls b lt mn ju lv lw mo jx ly lz mp mb mc md mq mf mg mh mr mj mk ml im bi translated">关注Randy即将发表的关于公共数据集的文章，以推动数据分析见解和决策、编程、数据分析、摄影、自行车旅行等。你可以在shootproof.com和shutterstock.com看到他的一些照片。</p><h1 id="e2d6" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">附录A —源代码</h1><p id="0b87" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">程序的Python控制器代码和c_download_prep_excel类代码如下所示。请随意复制代码并根据您的需要进行修改。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure></div></div>    
</body>
</html>