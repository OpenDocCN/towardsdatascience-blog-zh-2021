<html>
<head>
<title>Building an interactive Python dashboard using SQL and Datapane</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SQL和Datapane构建交互式Python仪表板</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-an-interactive-python-dashboard-using-sql-and-datapane-46bd92294fd3?source=collection_archive---------4-----------------------#2021-06-21">https://towardsdatascience.com/building-an-interactive-python-dashboard-using-sql-and-datapane-46bd92294fd3?source=collection_archive---------4-----------------------#2021-06-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="49c6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用开源工具构建商业智能应用原型</h2></div><h1 id="757f" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">介绍</h1><p id="d50a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">数据分析最重要的技能之一是与数据库交互。大多数组织将他们的业务关键数据存储在类似Postgres或MySQL的关系数据库中，你需要知道T2的结构化语言来访问或更新存储在那里的数据。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi lu"><img src="../Images/98f64fd4a02bfe9bcef78c0a8bed127e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5t3gwpjC4ETCjcendzS2SA.jpeg"/></div></div><p class="mg mh gj gh gi mi mj bd b be z dk translated">Stephen Dawson 在<a class="ae lt" href="https://unsplash.com/s/photos/dashboard?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="ec73" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">SQL是一种令人难以置信的语言——它发明于20世纪70年代，大多数新的数据库项目(如Redshift、Snowflake、CockroachDB)仍然选择它作为基础，因为它功能强大且相对简单(至少在开始时是这样)。虽然它擅长检索数据，但您通常需要像Tableau或Looker这样的企业商业智能平台来可视化结果。</p><p id="e08f" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">在本文中，我将向您展示如何结合SQL和开源Python库来构建一个web上的交互式仪表盘——点击这里查看<a class="ae lt" href="https://datapane.com/u/johnmicahreid/reports/sqlite-dashboard/" rel="noopener ugc nofollow" target="_blank">实时版本</a>和Github上的<a class="ae lt" href="https://github.com/johnmicahreid/datascienceexamples/blob/main/SQLite_dashboard.ipynb" rel="noopener ugc nofollow" target="_blank">代码</a>。这是一项使用数据库快速构建应用程序原型的伟大技术。</p><h1 id="8a72" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">数据集</h1><p id="754a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们将使用一个著名的开源数据集，名为<a class="ae lt" href="https://github.com/lerocha/chinook-database" rel="noopener ugc nofollow" target="_blank"> Chinook </a>，它存储了一家小型音乐商店几年来的购买数据。这些数据作为一个SQLite数据库存储在一个文件中，所以我们可以直接从本地Python环境中查询它，而不需要访问凭证。</p><p id="023b" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">下面是显示数据库模式的快速表格:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi mp"><img src="../Images/11e1d364be7cdc1f386b2d27d4397d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mGY2KHP4G48G_Fsaf83Ehg.png"/></div></div><p class="mg mh gj gh gi mi mj bd b be z dk translated">图片由作者提供，灵感来自<a class="ae lt" href="https://github.com/arjunchndr/Analyzing-Chinook-Database-using-SQL-and-Python" rel="noopener ugc nofollow" target="_blank"> arjunchndr </a></p></figure><p id="24ab" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">如果你来自熊猫，不熟悉数据库模式，这里有一些提示:</p><ul class=""><li id="0949" class="mq mr iq kz b la mk ld ml lg ms lk mt lo mu ls mv mw mx my bi translated">数据库被分割成单独的<strong class="kz ir">表</strong>，它们代表不同的逻辑对象。例如，所有客户都在客户数据库中。这与传统的熊猫数据框架不同，后者通常只有一张表。</li><li id="554a" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">每个表都有一组<strong class="kz ir">字段、</strong>定义表的属性，还有<strong class="kz ir">行、</strong>存储实际数据。这些就像Excel中的列和行一样。</li><li id="ed26" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">表之间的关系由称为<strong class="kz ir">外键的特殊字段表示。</strong>例如，每首曲目都有一个album_id，它链接到专辑表，这意味着每首曲目都是专辑的一部分。当我们查询数据库时，我们通常会根据外键将不同的表连接在一起。</li></ul><h1 id="75c6" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">连接到数据库</h1><p id="0a1d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">我们将从定义一些连接到数据库的帮助函数开始:</p><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="2c52" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">如您所见，我们将SQL查询写成字符串，然后在Python函数中执行它。像这样将两种不同的语言混合在一起有点尴尬，但是一旦你掌握了窍门，它会出奇地好！运行上面的代码会给出数据库中所有不同的表名以及每个表中的行数:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/0d54e0adc9a193ca30b68e5a38901d06.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*PW-CVMpeUSuBoBIAZVDY3g.png"/></div><p class="mg mh gj gh gi mi mj bd b be z dk translated">作者图片</p></figure><h1 id="e733" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">构建仪表板</h1><p id="885e" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">假设你刚开始在Chinook做数据科学家，你的老板想知道最畅销的曲目，这样他们就可以在网站上推广它们。要回答这个问题，我们需要编写如下查询:</p><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="bf29" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">我们首先选择希望在输出中看到的列。因为这些来自四个不同的表(track、album、artist、invoice_line)，所以我们需要根据外键关系连接这些表—检查模式，看看有什么可能。接下来，我们按曲目名称分组，按购买次数最多的顺序排序，只选择前10个结果。</p><p id="3430" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">运行查询给我们一个熊猫数据帧，然后我们将它包装在一个<a class="ae lt" href="https://docs.datapane.com/reports/blocks/tables-and-data#datatable" rel="noopener ugc nofollow" target="_blank">数据表</a>块中，并发布给<a class="ae lt" href="http://datapane.com" rel="noopener ugc nofollow" target="_blank">Datapane.com</a>。</p><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="nh nf l"/></div></figure><p id="ede4" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">这将生成一个交互式表格，用户可以对其进行过滤和排序。看起来吉米·亨德里克斯用十大曲目中的五首摇滚起来了！</p><h1 id="4743" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated"><strong class="ak">更复杂的查询</strong></h1><p id="e6c6" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">随着我们最近的成功，老板问了我们一个更复杂的问题——“谁是我们表现最好的销售员工，他们什么时候销售额最高？”</p><p id="9325" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">我们可以使用像Plotly这样的Python可视化库来构建更令人满意的交互式图表，而不是用表格来回答这个问题:</p><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="9560" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">这个查询比前一个查询复杂得多:</p><ul class=""><li id="40cc" class="mq mr iq kz b la mk ld ml lg ms lk mt lo mu ls mv mw mx my bi translated">我们使用strftime来截断时间戳，这样我们就可以按月分组。当我们绘制数据时，这使得数据看起来更好。</li><li id="6060" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">我们使用子查询(也称为公用表表达式)来计算中间表(customer_support_rep_sales)。然后，我们在最终查询中调用这个表。</li><li id="a9d6" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">有些操作既可以在pandas中完成，也可以在SQL中完成——例如，我们在Pandas中做了一个groupby来删除第二个图表中的“月”列。我更喜欢用SQL做最复杂的连接和分组，如果必要的话，只使用Python来格式化结果。</li></ul><p id="9703" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">运行上面的代码会得到以下结果:</p><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="nh nf l"/></div></figure><p id="edc2" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">看起来月度表现相当不稳定，没有明显的季节性影响。简是销售业绩最好的人，领先史蒂夫约20%。</p><h1 id="b1b0" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">完整仪表板</h1><p id="7e14" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">从现在开始，世界就是你的了。您可以编写超级复杂的SQL查询，并用任何Python库可视化它们。在仪表盘的完整版本中，我添加了一些额外的图表和可视化效果:</p><ul class=""><li id="bc11" class="mq mr iq kz b la mk ld ml lg ms lk mt lo mu ls mv mw mx my bi translated">总客户、员工和销售曲目的汇总统计数据</li><li id="31ec" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">按流派销售</li><li id="8629" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">按国家/地区列出的销售和客户</li><li id="2548" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">平均订单百分比差异与国家平均值</li><li id="4a95" class="mq mr iq kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">客户终身价值</li></ul><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="nh nf l"/></div></figure><p id="1dc7" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">你可以在<a class="ae lt" href="https://github.com/johnmicahreid/datascienceexamples" rel="noopener ugc nofollow" target="_blank"> Github </a>上看到这个教程的完整代码。</p><h1 id="aa72" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">最后</h1><p id="06e6" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在本教程中，您已经看到了如何通过在Python中编写SQL语句、用Plotly绘制结果并与Datapane共享它们来构建交互式仪表板。</p><p id="40df" class="pw-post-body-paragraph kx ky iq kz b la mk jr lc ld ml ju lf lg mm li lj lk mn lm ln lo mo lq lr ls ij bi translated">这是一个很好的方法，可以快速建立想法的原型，或者构建标准BI平台中没有的更复杂的可视化。</p></div></div>    
</body>
</html>