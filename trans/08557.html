<html>
<head>
<title>Working with Geospatial Data in Python — PART 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python处理地理空间数据—第1部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/working-with-geospatial-data-in-python-part-1-453c97daebc5?source=collection_archive---------12-----------------------#2021-08-07">https://towardsdatascience.com/working-with-geospatial-data-in-python-part-1-453c97daebc5?source=collection_archive---------12-----------------------#2021-08-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c56f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">常见数据类型和使用栅格从开源数据生成树冠高度模型。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1d1a9e156fba378923f1500de0393407.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SF4jjh-1hZM5j_Uy"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安妮·斯普拉特在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="eab7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实话实说吧；地理空间数据很吓人。除了关于如何使用Python处理地理空间数据的信息不像使用其他类型数据的信息那样容易获取之外，我不认为有什么好的理由。</p><p id="27fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一个系列的第一篇文章，重点关注使用Python处理地理空间数据的各种必须了解的方面。在接下来的几周里，我们将探讨使用地理空间数据的主要主题，包括文件格式、数据类型、坐标系和使用数据的工具。我会尽量保持这些帖子的篇幅。我希望我们在整个系列中对这个话题产生一种安慰，我们的恐惧会逐渐消失。</p><p id="499b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章的前2/3介绍了一些概念。在最后的1/3中，我们将尝试从opentopography.org的<a class="ae ky" href="http://opentopography.org" rel="noopener ugc nofollow" target="_blank">获取两个激光雷达栅格，并从数字表面模型和数字地形模型计算冠层高度模型。</a></p><p id="c8be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经整理了文章，整理如下:</p><ol class=""><li id="a265" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">数据类型</li><li id="cd00" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">[计]元数据</li><li id="c00e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">实践栅格数据。</li></ol><h1 id="f2c6" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">数据类型</h1><p id="90f4" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">地理空间数据中使用两种主要的数据类型:栅格数据和矢量数据。这可能不足为奇。如果你最近在电脑上做过任何视觉方面的工作，你可能会和两者都有过互动。下面我们将简要地看一下每一种数据。</p><h2 id="88eb" class="ng mk it bd ml nh ni dn mp nj nk dp mt li nl nm mv lm nn no mx lq np nq mz nr bi translated">栅格数据</h2><p id="7c10" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">栅格数据是网格中的数据。这和一张照片里的数据很像。在卫星图像的情况下，这些数据就像一张照片。这种地理空间栅格数据和照片栅格数据之间的区别在于，地理空间数据有一种将该数据与地球上特定位置相关联的方式。与只包含整数数据的图像不同，它还可以包含浮点或整数数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/8a577667206489cceca01383c7187109.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YYR9RRcwr09v2bzVyWhImw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="2f98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">栅格数据也可以是分类数据。例如，您可以将地面覆盖分为低、中或高。在这种情况下，我们将整数数据映射到一个类别。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/5f476e6cf05c1898bd8e07c2e9e95516.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/1*LMLpsKEA-wvELyBqo7M_Uw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h2 id="d7ec" class="ng mk it bd ml nh ni dn mp nj nk dp mt li nl nm mv lm nn no mx lq np nq mz nr bi translated">矢量数据</h2><p id="3e8d" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">矢量地理空间数据也非常类似于您可能在Adobe Illustrator中使用过的设计数据。同样，不同之处在于地理空间矢量数据被映射到地球上的特定位置。</p><p id="7935" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">矢量数据有三种类型。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/b486a5f266f1392324ba22d8ce8fb686.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YgzlzWMo-QG3JWIwPPEeJQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="d621" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每种类型的矢量数据可以表示不同种类的信息。</p><ul class=""><li id="3429" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nv mb mc md bi translated">一个<strong class="lb iu">点</strong>可以代表像一棵树或一栋建筑这样的东西的位置。</li><li id="c02d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nv mb mc md bi translated">一条<strong class="lb iu">线</strong>可以代表一条道路或者一条河流。</li><li id="753c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nv mb mc md bi translated">一个<strong class="lb iu">多边形</strong>可以代表地理单元，比如一个国家、州的边界，或者其他区域，比如国家公园。</li></ul><h1 id="b1f0" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">栅格元数据</h1><p id="ba16" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">地理空间栅格使用元数据向我们传达数据的许多重要方面。以下是栅格文件元数据中的一些基本元素。</p><h2 id="ab28" class="ng mk it bd ml nh ni dn mp nj nk dp mt li nl nm mv lm nn no mx lq np nq mz nr bi translated">坐标参考系统</h2><p id="f1b1" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我在上面提到过，地理空间数据的本质特征是它将数据连接到地球上的特定点。建立这种联系的机制是坐标参考系统或CRS。</p><p id="e0dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一个重要的复杂因素。地球是一个球体，我们的数据表示是二维的。像任何纸质地图一样，我们的数据被投影到二维空间。不同的CRS处理这个投影的方式不同。例如，一些CRS只关注地球上的特定区域。其他的更普遍，用于投影地球表面的大部分。有很多很多不同的CRS。一些比另一些更常见，但出于我们的目的，我们需要知道当我们可视化或根据它们进行计算时，具有不同CRS的两个栅格不会对齐。我们需要有一种方法将两个栅格转换成相同的CRS(在以后的文章中会有更多的介绍)。</p><h2 id="dfed" class="ng mk it bd ml nh ni dn mp nj nk dp mt li nl nm mv lm nn no mx lq np nq mz nr bi translated">NoData值</h2><p id="166c" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">元数据的另一个关键部分是NoData值。栅格的格网格式要求每个方格中都有数据。<code class="fe nw nx ny nz b">NoData</code>值告诉我们栅格所使用的数字，以表明它对于栅格的该部分没有值。对于整型和浮点型栅格，常见的NoData数据分别为<code class="fe nw nx ny nz b">-9999</code>和<code class="fe nw nx ny nz b">-3.4e+38</code>，但可以使用任何值。</p><p id="0d99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想更深入地了解地理空间栅格数据中常见的其他元数据，<a class="ae ky" href="https://desktop.arcgis.com/en/arcmap/10.3/main/manage-data/what-is-geodata.htm" rel="noopener ugc nofollow" target="_blank">这个ArcGIS帮助页面</a>很好地展示了各种可能性。</p><h1 id="86c6" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">使用栅格数据</h1><p id="237d" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们都可以承认，我们绝不是地理空间数据方面的专家，但这不应该阻止我们深入研究，看看我们能完成什么。</p><p id="c7ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这个例子，我从加利福尼亚州约塞米蒂山谷的<a class="ae ky" href="https://portal.opentopography.org/raster?jobId=rt1628281995394" rel="noopener ugc nofollow" target="_blank">illioulette Creek Basin LiDAR调查中抓取了一些激光雷达数据，2018年</a>数据集在<a class="ae ky" href="http://opentopography.org" rel="noopener ugc nofollow" target="_blank">opentopography.org</a>上。数据是开源的，界面也很容易使用。如果你愿意，我已经上传了我使用的与本文相关的<a class="ae ky" href="https://github.com/benbogart/geospatial-python" rel="noopener ugc nofollow" target="_blank"> Github库</a>的确切数据。</p><p id="0dd7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来我们需要的是一个工具，它可以让我们读入栅格数据。<code class="fe nw nx ny nz b">xarray</code>是一个python库，允许我们在python中处理多维标签数组。对于多维数据来说有点像熊猫。<code class="fe nw nx ny nz b">rioxarray</code>是构建在<code class="fe nw nx ny nz b">xarray</code>之上的一个包，它提供了读写栅格文件及其元数据的方法。为了加载我们的数据，我们执行以下操作。</p><pre class="kj kk kl km gt oa nz ob oc aw od bi"><span id="da6e" class="ng mk it nz b gy oe of l og oh">import rioxarray</span><span id="0a29" class="ng mk it nz b gy oi of l og oh">terrain_file = 'data/rasters_CA18Thompson/output_be.tif'<br/>terrain = rioxarray.open_rasterio(terrain_file)</span><span id="3526" class="ng mk it nz b gy oi of l og oh">surface_file = 'data/rasters_CA18Thompson/output_hh.tif'<br/>surface = rioxarray.open_rasterio(surface_file)</span></pre><p id="2017" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们看一下<code class="fe nw nx ny nz b">surface</code>，我们可以看到一些关于数据的信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/85b312de18497df01f3086dd3c396264.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pHduIivlZareT9ypg16Vsg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="b4d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到这个栅格文件有一个波段，x轴和y轴上的数据都是浮点64值。我们还可以看到与上面讨论的<code class="fe nw nx ny nz b">NoData</code>值相同的<code class="fe nw nx ny nz b">_FillValue</code>。为了更直接地查看元数据，我们可以检查我们的<code class="fe nw nx ny nz b">xarray</code>的单个属性。特定于栅格的数据位于一个名为<code class="fe nw nx ny nz b">rio</code>的子类中。</p><pre class="kj kk kl km gt oa nz ob oc aw od bi"><span id="a5f1" class="ng mk it nz b gy oe of l og oh"># Get no data value<br/>surface.rio.nodata</span></pre><p id="c1be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">1.70141e+38</p><pre class="kj kk kl km gt oa nz ob oc aw od bi"><span id="678b" class="ng mk it nz b gy oe of l og oh"># Show surface CRS<br/>print(surface.rio.crs)</span></pre><p id="73b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">EPSG:6340</p><p id="3b7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面告诉我们，我们的<code class="fe nw nx ny nz b">NoData</code>值是<code class="fe nw nx ny nz b">1.70141e+38</code>，我们的CRS是EPSG:6340。前往<a class="ae ky" href="https://epsg.io/6340" rel="noopener ugc nofollow" target="_blank">https://epsg.io/6340</a>了解更多关于该CRS的信息。出于我们的目的，我们只需要知道这两个文件的CRS匹配。幸运的是，确实如此。</p><pre class="kj kk kl km gt oa nz ob oc aw od bi"><span id="3bd5" class="ng mk it nz b gy oe of l og oh"># Show terrain CRS<br/>print(terrain.rio.crs)</span></pre><p id="4bd9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">EPSG:6340</p><p id="6baa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看如果绘制其中一个栅格会发生什么。</p><pre class="kj kk kl km gt oa nz ob oc aw od bi"><span id="3a39" class="ng mk it nz b gy oe of l og oh">plt.figure(figsize=(10,8))<br/>surface.plot()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/a687ca42ae3adffd35da7abbdbf11586.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*79fIrFlGVV4Mcs9QbVDaig.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="f87d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嗯。这没有你希望的那么令人印象深刻，不是吗？查看绘图右侧的彩色地图，我们看到max值相当大，与我们的<code class="fe nw nx ny nz b">NoData</code>值非常相似。我们忘记了用<code class="fe nw nx ny nz b">np.nan</code>替换no data值，这是表示缺失值的pythonic方式。最简单的方法是将文件通过<code class="fe nw nx ny nz b">masked=True</code>重新导入到<code class="fe nw nx ny nz b">rasterio</code>方法。</p><pre class="kj kk kl km gt oa nz ob oc aw od bi"><span id="ddd7" class="ng mk it nz b gy oe of l og oh"># reload the surface raster masking nan values<br/>surface = rioxarray.open_rasterio(surface_file, masked=True)</span><span id="0935" class="ng mk it nz b gy oi of l og oh"># plot surface raster<br/>plt.figure(figsize=(10,8))<br/>surface.plot()<br/>plt.title('Digital Surface Model')</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/be0465a4c63e6768d744b29c4a59a730.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*HdCCTA46sqnye7_XyNXQlw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="0bd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那就好多了！现在很清楚，白色区域在数据集之外，不包含测量值。让我们来看看表面模型栅格。</p><pre class="kj kk kl km gt oa nz ob oc aw od bi"><span id="c6dc" class="ng mk it nz b gy oe of l og oh"># reload the terrain raster masking nan values<br/>terrain = rioxarray.open_rasterio(terrain_file, masked=True)</span><span id="22e3" class="ng mk it nz b gy oi of l og oh"># plot terrain raster<br/>plt.figure(figsize=(10,8))<br/>terrain.plot()<br/>plt.title('Digital Terrain Model')</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/dc49e79bb7996d46ef7e60be8c3f4da6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*G9R-XvovIGxPqtRFky-OyA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="5241" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这看起来非常类似于表面模型。</p><p id="de61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们将做一点栅格数学。我们想知道树冠的高度。换句话说，我们希望看到树木和地面植被相对于地面的高度。我们有一个给我们土地上所有物体轮廓的表面模型和一个给我们土地本身轮廓的地形模型。为了得到冠层高度模型，我们从表面模型中减去地形模型。</p><pre class="kj kk kl km gt oa nz ob oc aw od bi"><span id="6ac7" class="ng mk it nz b gy oe of l og oh"># calculate canopy height model<br/>canopy = surface - terrain</span><span id="8fa0" class="ng mk it nz b gy oi of l og oh"># plot surface raster<br/>plt.figure(figsize=(10,8))<br/>canopy.plot()<br/>plt.title('Canopy Height Model')</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi om"><img src="../Images/44ab5e2fc871b7c30539bab35c1a639c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*R2UQDLjaf2quHlqYOrdREw.png"/></div></figure><p id="8692" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们找到了。我们可以看到，这个地区大部分是低或没有地面覆盖，一些稀疏的树木高达60米。</p><h1 id="eabb" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">结论</h1><p id="5703" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我希望这篇文章的最大收获是地理空间数据没有那么可怕。它处理一个我们在平面数据集中通常不必处理的问题:将三维地球投影到二维栅格上。在本系列的后续文章中，我们将学习如何重新投影和处理来自不同来源的数据。不过，今天我们学习了一些基本术语，并使用了一些基本的地理空间python包。</p><p id="02c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这只是本系列的第一篇文章。如果您想在我发布本系列的下一篇文章时得到通知，请在medium上关注我。</p><h1 id="529c" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">资源</h1><ul class=""><li id="216a" class="lv lw it lb b lc nb lf nc li on lm oo lq op lu nv mb mc md bi translated"><a class="ae ky" href="https://carpentries-incubator.github.io/geospatial-python/" rel="noopener ugc nofollow" target="_blank">在由Ryan Avery维护的<a class="ae ky" href="https://github.com/carpentries-incubator/proposals/#the-carpentries-incubator" rel="noopener ugc nofollow" target="_blank"> carpentries孵化器</a>上使用python </a>介绍地理空间栅格和矢量数据</li><li id="ef0d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nv mb mc md bi translated"><a class="ae ky" href="https://desktop.arcgis.com/en/arcmap/10.3/main/manage-data/what-is-geodata.htm" rel="noopener ugc nofollow" target="_blank">什么是地理数据？</a>在ArcGIS帮助页面中。</li><li id="bc36" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nv mb mc md bi translated"><a class="ae ky" href="http://opentopography.org" rel="noopener ugc nofollow" target="_blank">OpenTopography.org</a>—开源高分辨率地形数据和工具。</li></ul></div></div>    
</body>
</html>