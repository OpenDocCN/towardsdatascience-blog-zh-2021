<html>
<head>
<title>Solved! Query folding for native SQL in Power BI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解决了！Power BI中本地SQL的查询折叠</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/solved-query-folding-for-native-sql-in-power-bi-c94ebc604d1d?source=collection_archive---------9-----------------------#2021-06-09">https://towardsdatascience.com/solved-query-folding-for-native-sql-in-power-bi-c94ebc604d1d?source=collection_archive---------9-----------------------#2021-06-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="eb05" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Power BI中编写原生SQL查询会破坏查询折叠，对吗？嗯，不再是了</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0e4d58c214ac9a68abc657f7b60d27d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7lpjDPsVQmjaz0CbTNLJtA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="d978" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">谈到技术(尤其适用于Power BI ),唯一不变的是——变化！而且，当我说Power BI的变化时，我并不仅仅指每个月都会有大量新功能的定期更新。现有的功能也在不断改进和升级，所以很容易发生这样的情况，几个月前不支持的东西，或者您必须执行不同的工作区来找到解决方案，现在默认工作。</p><p id="66ae" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">其中一个很酷的新功能是可以为手写的SQL查询实现查询折叠！正如我之前在这个由三部分组成的系列文章中所写的，经验法则是:一旦您决定编写一个自定义SQL来将数据导入Power BI，您就要对所有后续步骤的查询折叠说“再见”了。</p><h2 id="2c5f" class="lv lw it bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">首先什么是查询折叠？</h2><p id="a164" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">在我们直接开始之前，让我先解释一下什么是查询折叠。</p><p id="0764" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">用最简单的话来说:<strong class="la iu"> <em class="mt">如果Power Query引擎能够收集您的所有转换，并生成一条将在源端(大多数情况下是SQL数据库)执行的SQL语句，我们称之为查询折叠！</em> </strong></p><p id="bd3e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这样，通过将转换和计算推到数据源端，在大多数情况下，您将获得数据刷新过程的性能优势。我不打算通过不同的场景来重申查询折叠何时可行或不可行——我强烈建议您阅读我已经提到的<a class="ae lu" rel="noopener" target="_blank" href="/query-folding-in-power-bi-devil-is-in-the-detail-d564ab0cb32">文章</a>—并参考微软的官方文档。</p><p id="b4d1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，当您决定使用原生SQL查询作为Power BI数据集的源时，我将重点关注一个特定的场景。</p><h2 id="e425" class="lv lw it bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">Power BI中的原生SQL查询是什么？</h2><p id="a2e0" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">当您将数据导入Power BI时，需要做出的第一个决定是:您是否希望从SQL数据库中“按原样”获取数据，然后使用Power Query editor应用必要的转换…或者，您是否希望编写自己的SQL代码来获取数据。</p><p id="cb2f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您选择编写自定义SQL，在Power Query编辑器中应用的所有后续转换步骤都不会折叠，即使您正在应用一些基本转换，如过滤或重命名列，这些步骤在“正常”情况下会折叠。</p><p id="7826" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个说法应该没错吧？嗯，不再是了:)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/d4f5d5e20a48522da39974314a0a9f31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yklTSioZLidJN-O6ah8LTw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="f767" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上图中，我正在从<em class="mt"> Contoso </em>示例数据库中的<em class="mt"> FactOnlineSales </em>表中导入所有行和列。该表包含大约1260万行。</p><h2 id="decd" class="lv lw it bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">打破查询折叠的“传统”方式</h2><p id="a13d" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">其中一列是销售额。现在，假设我只想保留销售额值大于400的那些行。我将打开Power Query编辑器并添加这个转换步骤:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/a9c234cc9619006e6904eac728943372.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M_6xmxyOqwbW6k_u0sHxeQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="12cd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我应用了这个步骤之后，如果我右键单击它，我可以看到View Native Query选项是灰色的，这意味着我的查询可能不会折叠。在这种情况下，这是正确的，所以让我们检查一下这个查询在Power BI中加载需要多长时间。</p><p id="9cda" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">刷新数据花费了大约<strong class="la iu"> 160秒</strong>，但下图显示了后台发生的情况:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/1c9a444edf6954d337f79e7cd0aa6556.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wOCtyMxu0NrGQX6JJO4CHw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="0bce" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">基本上，Power Query引擎必须从底层SQL Server数据库的FactOnlineSales表中提取<strong class="la iu">所有数据</strong>，然后应用我们指定的过滤条件！最后，大约有210万条记录满足我们的销售额标准。因此，无论我们在第一条语句(编写定制SQL)之后应用什么转换步骤，查询都不会折叠！</p><h2 id="37f5" class="lv lw it bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">神奇的M功能来拯救</h2><p id="c063" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">现在让我们尝试另一种方法。灵感来自<a class="ae lu" href="https://blog.crossjoin.co.uk/2021/02/21/query-folding-on-sql-queries-in-power-query-using-value-nativequery-and-enablefoldingtrue/" rel="noopener ugc nofollow" target="_blank">Chris Webb的这篇很棒的博文</a>，我只是在下面的例子中稍微调整了一下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/9ba002a296883fafbc8160d5df9c5ad5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b8SYRXR3SeNDjHEyOC6KMA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="c699" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可能注意到了，我不会在启动窗口中编写SQL语句。我将把它留空，并从Contoso数据库中导入所有数据库对象(所有表、视图和表值函数):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/7835501ff50307a77941b2c74e1819cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XDgh4UyzO32fCWtBr27Hpg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="f118" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">除了使用300多种内置的Power Query转换之一，您还可以编写自己的M代码来应用于数据。因此，如果我右键单击最后一步，我可以选择在后<em class="mt">插入一步:</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/5657d685b147185c8223e3fc862ae65a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wz7QlSHp_PEgyF6sVgVNbw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="a346" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个自定义步骤允许我在公式栏中手动输入M公式，因此我将输入以下M代码:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="b11d" class="lv lw it mw b gy na nb l nc nd">= Value.NativeQuery(Contoso,"SELECT * FROM FactOnlineSales",null,[EnableFolding=true])</span></pre><p id="8549" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">“神奇”发生在<em class="mt">值内。NativeQuery() </em>函数。你可以在这里阅读关于这个函数及其参数<a class="ae lu" href="https://docs.microsoft.com/en-us/powerquery-m/value-nativequery" rel="noopener ugc nofollow" target="_blank">的更多信息。我们可以省略第三和第四个参数，查询仍然可以工作，但是通过提供第四个参数<em class="mt"> EnableFolding </em>，并将其标记为TRUE，我们显式地指示Power Query引擎启用查询折叠！</a></p><p id="8e7d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在让我们应用与上一个案例完全相同的过滤器—只保留销售额值大于400的那些行。如果右键单击最后一步，应该会启用<em class="mt">查看本地查询</em>选项。当我点击它时，我看到我的查询现在折叠了，因为过滤条件被很好地翻译成SQL <strong class="la iu"> <em class="mt"> where </em> </strong>子句！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/2276fd2208e68a16c9c72c0379e5496c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gafB2VySnP_1GjplqYn99A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="b20c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，让我们检查一下这种变通方法是否对数据刷新过程有影响:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/e9f01d63df8cb03934b52746167ac6e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LkZiPq1_QwD4J7pgR8cr5Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="2543" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这一次，通过将过滤器推送到SQL数据库，Power Query只检索我们需要的那些行。这显然影响了数据刷新处理时间，因为它花费了大约<strong class="la iu"> 20秒</strong>！</p><h2 id="4952" class="lv lw it bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">加盟还是不行！</h2><p id="6f0b" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">我尝试对此进行扩展，并在原生查询中组合多个表:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="4bf6" class="lv lw it mw b gy na nb l nc nd">= Value.NativeQuery(Contoso,"SELECT * FROM FactOnlineSales AS fco INNER JOIN DimCustomer AS c ON c.customerKey = fco.customerKey",null,[EnableFolding=true])</span></pre><p id="3488" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是，我收到了以下错误:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/e97dd714f846541d942779ea6c86d58d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AHWH44AM2udM9FdOEEfbnA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h2 id="ed36" class="lv lw it bd lx ly lz dn ma mb mc dp md lh me mf mg ll mh mi mj lp mk ml mm mn bi translated">结论</h2><p id="4091" class="pw-post-body-paragraph ky kz it la b lb mo ju ld le mp jx lg lh mq lj lk ll mr ln lo lp ms lr ls lt im bi translated">默认情况下，编写定制的SQL代码将数据导入Power BI仍然会破坏查询折叠。但是，正如您所看到的，有一种简便的方法可以“强制”Power Query引擎利用查询折叠，即使在您决定使用原生SQL查询选项的情况下也是如此。</p><p id="866c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">老实说，这种技巧的用例数量有限，因为您不能像在开始数据导入窗口中以“传统”方式编写SQL代码那样，在一条SQL语句中组合多个数据库对象。不过，使用定制SQL进行数据转换的首选方式是在源数据库中创建一个视图。视图将包含整个转换逻辑，然后您可以在Power BI中“按原样”导入它。数据库视图是可折叠的对象，这意味着如果对视图应用可折叠的转换步骤，您仍然可以从查询折叠中受益！</p><p id="90f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然而，很高兴看到事情正在向前发展，让我们希望在不久的将来，本地SQL查询的查询折叠将默认启用。</p><p id="2a97" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读！</p></div></div>    
</body>
</html>