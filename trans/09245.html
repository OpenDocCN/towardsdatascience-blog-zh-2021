<html>
<head>
<title>How To Connect To A PostgreSQL Database With Python Using SSH Tunnelling</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用SSH隧道通过Python连接到PostgreSQL数据库</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-connect-to-a-postgresql-database-with-python-using-ssh-tunnelling-d803282f71e7?source=collection_archive---------3-----------------------#2021-08-27">https://towardsdatascience.com/how-to-connect-to-a-postgresql-database-with-python-using-ssh-tunnelling-d803282f71e7?source=collection_archive---------3-----------------------#2021-08-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c4b3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解当需要SSH加密时，如何使用Psycopg2或SQLAlchemy查询PostgreSQL数据库。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c56fccb77444e7bc49d20614767a2895.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3gsvOo32FnTeUDJ9"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">约翰·施诺布里奇在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="f04b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你希望在2022年成为一名数据工程师并推进你的职业发展吗？看看 <a class="ae ky" href="https://imp.i115008.net/jWWEGv" rel="noopener ugc nofollow" target="_blank"> <em class="lv"> Udacity的点播</em> <strong class="lb iu"> <em class="lv">数据工程纳米学位</em> </strong> </a> <em class="lv">并利用以下2022年2月特别折扣代码:</em></p><p id="42d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://imp.i115008.net/zaX10r" rel="noopener ugc nofollow" target="_blank"> <em class="lv"> * </em>在2022年2月<strong class="lb iu">使用代码促销25 </strong> ** </a>在UDACITY球场享受高达<strong class="lb iu"> 25%的折扣</strong></p><h1 id="ec92" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">介绍</h1><p id="0ae8" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Python至少提供了两种与PostgreSQL数据库交互的简单方法:</p><ul class=""><li id="207c" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">使用<code class="fe nc nd ne nf b">pycopg2</code>包创建连接</li><li id="12dd" class="mt mu it lb b lc ng lf nh li ni lm nj lq nk lu my mz na nb bi translated">通过<code class="fe nc nd ne nf b">sqlalchemy</code>包发电和发动机。</li></ul><p id="5cdf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只要您有有效的凭证，就可以用几行代码建立连接。但是如果你的公司已经实现了SSH隧道作为一个额外的加密层呢？</p><blockquote class="nl"><p id="aa19" class="nm nn it bd no np nq nr ns nt nu lu dk translated">“这很烦人…现在我需要编写另一个防弹脚本来替换我使用多年的脚本…”</p></blockquote><p id="2f5b" class="pw-post-body-paragraph kz la it lb b lc nv ju le lf nw jx lh li nx lk ll lm ny lo lp lq nz ls lt lu im bi translated">这是我第一次发现SSH存在时的想法，我花了一段时间来消化每次我希望查询PostGreSQL数据库时必须通过隧道连接的想法，无论是通过DMBS还是通过Python脚本。</p><p id="d4cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将与您分享我为解决该问题而创建的两个代码片段(一个用于<code class="fe nc nd ne nf b">psycopg2</code>，另一个用于<code class="fe nc nd ne nf b">sqlalchemy</code>)。我相信您将能够根据您的具体使用情况修改它们，并在几分钟内连接起来。</p><p id="dc94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是在开始之前，为什么首先需要SSH隧道呢？如何创建SSH公钥和私钥？</p><h1 id="42b1" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated"><strong class="ak">SSH加密背后的要旨</strong></h1><p id="bd75" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">创建SSH隧道是在客户端和服务器之间建立加密连接的一种方式，可用于转发任何TCP ( <em class="lv">传输控制协议</em>)端口。</p><p id="a642" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着使用SSH隧道，您可以将本地机器上的端口链接到远程主机上的端口。一旦端口被链接，就可以通过安全的SSH连接在本地和远程端口之间交换通信。</p><p id="9707" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，SSH加密经常用于从本地机器访问数据库。这是通过使用SSH私有和公共密钥的组合通过SSH隧道连接到数据库主机来实现的。</p><p id="883c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过在终端中运行以下命令来创建SSH密钥对:</p><pre class="kj kk kl km gt oa nf ob oc aw od bi"><span id="b0d5" class="oe lx it nf b gy of og l oh oi">$ ssh-keygen -t rsa -b 4096 -C “your_name@example.com”</span></pre><p id="50ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将创建4096位长的密钥，使用RSA算法来加密和解密消息(或者，您可以使用更高级的<code class="fe nc nd ne nf b">ed25519</code>算法，如<a class="oj ok ep" href="https://medium.com/u/2e461f0600bb?source=post_page-----d803282f71e7--------------------------------" rel="noopener" target="_blank"> Risan Bagja Pradana </a>在<a class="ae ky" href="https://medium.com/risan/upgrade-your-ssh-key-to-ed25519-c6e8d60d3c54" rel="noopener">本文</a>中所述)。</p><p id="c5a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后会提示您输入保存密钥的文件(按enter键接受默认值)和密钥的密码。</p><p id="a2d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，确保您的代理正在运行，并将您的密钥添加到代理中。如果提示输入密码，请输入您刚刚创建的密码:</p><pre class="kj kk kl km gt oa nf ob oc aw od bi"><span id="a7ad" class="oe lx it nf b gy of og l oh oi">$ eval “$(ssh-agent -s)”</span><span id="dad1" class="oe lx it nf b gy ol og l oh oi">$ ssh-add ~/.ssh/id_rsa</span></pre><p id="f860" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该能够使用<code class="fe nc nd ne nf b">cat</code>命令在隐藏的<code class="fe nc nd ne nf b">.ssh</code>文件夹中的两个文件上显示您的私钥和公钥(记住您可以使用<code class="fe nc nd ne nf b">ls -a</code>命令显示隐藏的文件夹):</p><pre class="kj kk kl km gt oa nf ob oc aw od bi"><span id="7256" class="oe lx it nf b gy of og l oh oi">$ cat ~/.ssh/id_rsa.pub </span><span id="d6c1" class="oe lx it nf b gy ol og l oh oi">$ cat ~/.ssh/id_rsa</span></pre><p id="a4a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在已经生成了一对密钥，是时候使用它们连接到PostgreSQL数据库了。</p><h1 id="fe54" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">访问数据库凭据</h1><p id="6437" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">为简单起见，您可以决定将数据库凭证保存在一个JSON文件中，如下所示:</p><pre class="kj kk kl km gt oa nf ob oc aw od bi"><span id="6707" class="oe lx it nf b gy of og l oh oi">{“PG_UN” : “your_db_user_name”,<br/>"PG_DB_NAME": "db_name",<br/>“PG_DB_PW” : “your_pw”,<br/>“SSH_PKEY” : “your_ssh_pkey”,<br/>"SSH_HOST" : "111.11.0.111",<br/>"DB_HOST" : "222.22.0.202",<br/>"LOCALHOST" : "333.0.0.3",<br/>"PORT" : "5432"}</span></pre><p id="bb00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以通过阅读获得它们:</p><pre class="kj kk kl km gt oa nf ob oc aw od bi"><span id="4e5f" class="oe lx it nf b gy of og l oh oi">creds = json.load(open(“/Users/{USER}/path/db_cred.json”, ‘r’))</span></pre><p id="80c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论多么方便，将凭证隐藏在本地文件中并不是最佳实践。我建议将它们存储为环境变量，如下文所述:</p><div class="om on gp gr oo op"><a rel="noopener follow" target="_blank" href="/connect-to-databases-using-python-and-hide-secret-keys-with-env-variables-a-brief-tutorial-4f68e33a6dc6"><div class="oq ab fo"><div class="or ab os cl cj ot"><h2 class="bd iu gy z fp ou fr fs ov fu fw is bi translated">使用环境变量隐藏您的密码</h2><div class="ow l"><h3 class="bd b gy z fp ou fr fs ov fu fw dk translated">关于如何在使用Python连接到数据库时使用环境变量隐藏密钥的教程</h3></div><div class="ox l"><p class="bd b dl z fp ou fr fs ov fu fw dk translated">towardsdatascience.com</p></div></div><div class="oy l"><div class="oz l pa pb pc oy pd ks op"/></div></div></a></div><h1 id="3d87" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated"><strong class="ak">使用Psycopg2连接到PostgreSQL】</strong></h1><p id="e9f1" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">现在您可以访问凭证了，是时候尝试用<code class="fe nc nd ne nf b">psycopg2</code>建立到PostgresSQL的连接了。</p><p id="117c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当涉及到SSH隧道时，您需要导入这两个包:</p><pre class="kj kk kl km gt oa nf ob oc aw od bi"><span id="87f5" class="oe lx it nf b gy of og l oh oi">import psycopg2 as pg<br/>from sshtunnel import SSHTunnelForwarder</span></pre><p id="ce89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后您可以使用<code class="fe nc nd ne nf b">SSHTunnelForwarder</code>生成一个隧道并初始化它:</p><pre class="kj kk kl km gt oa nf ob oc aw od bi"><span id="e325" class="oe lx it nf b gy of og l oh oi">ssh_tunnel = SSHTunnelForwarder(<br/> creds[“SSH_HOST”],<br/> ssh_username=creds[“PG_UN”],<br/> ssh_private_key= ‘/Users/Antonello.Benedetto/.ssh/id_rsa’,<br/> ssh_private_key_password= creds[“SSH_PKEY”],<br/> remote_bind_address=(creds[“DB_HOST”], 5432)<br/> )</span><span id="677e" class="oe lx it nf b gy ol og l oh oi">ssh_tunnel.start()</span></pre><p id="1b33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一步，通过<code class="fe nc nd ne nf b">psycopg2</code>创建一个标准连接:</p><pre class="kj kk kl km gt oa nf ob oc aw od bi"><span id="bd20" class="oe lx it nf b gy of og l oh oi"> conn = pg.connect(<br/>        host=creds[“LOCALHOST”],<br/>        port=ssh_tunnel.local_bind_port,<br/>        user=creds[“PG_UN”],<br/>        password= creds[“PG_DB_PW”],<br/>        database=creds[“PG_DB_NAME”])<br/></span></pre><p id="56f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将所有这些放在一起，您最终应该得到一个类似如下的脚本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pe pf l"/></div></figure><p id="6fc0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要测试您的连接，您可以使用我在下面创建的一个或多个实用函数。特别是:</p><ul class=""><li id="b971" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">使用<code class="fe nc nd ne nf b">execute_sql_ppg2</code>，您可以通过传递首选的<code class="fe nc nd ne nf b">query</code>来执行SQL语句；</li><li id="17e1" class="mt mu it lb b lc ng lf nh li ni lm nj lq nk lu my mz na nb bi translated">通过<code class="fe nc nd ne nf b">query</code>和连接对象，你可以用<code class="fe nc nd ne nf b">create_df_from_ppg2</code>创建一个熊猫数据框架；</li><li id="4ab5" class="mt mu it lb b lc ng lf nh li ni lm nj lq nk lu my mz na nb bi translated">使用<code class="fe nc nd ne nf b">create_table_ppg2</code>，你可以通过传递<code class="fe nc nd ne nf b">df</code>、<code class="fe nc nd ne nf b">conn</code>、<code class="fe nc nd ne nf b">table_name</code>和<code class="fe nc nd ne nf b">schema_name</code>作为参数，在PostgresSQL中非常灵活地从熊猫数据帧创建一个表。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pe pf l"/></div></figure><p id="b006" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，通过将下面的<code class="fe nc nd ne nf b">query</code>传递给前两个函数:</p><p id="bc0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://gist.github.com/anbento0490/21328dd7fd93ec20c714a2ed1df2b5da" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/an bento 0490/21328 DD 7 FD 93 EC 20 c 714 a2 ed 1 df 2 b5 da</a></p><p id="51fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我获得了以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/6039984bcfc874431ecb0d74e68e1de3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q88viZGDXEKw-kXxyeK14A.png"/></div></div></figure><h1 id="00ff" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">使用SqlAlchemy连接到PostgreSQL</h1><p id="c57b" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">通过<code class="fe nc nd ne nf b">sqlalchemy</code>访问PosgreSQL包含与<code class="fe nc nd ne nf b">psycopg2</code>完全相同的步骤。唯一的区别是，您现在需要导入:</p><pre class="kj kk kl km gt oa nf ob oc aw od bi"><span id="f09c" class="oe lx it nf b gy of og l oh oi">from sqlalchemy import create_engine<br/>from sshtunnel import SSHTunnelForwarder</span></pre><p id="5a1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要创建引擎对象，而不是创建连接对象:</p><pre class="kj kk kl km gt oa nf ob oc aw od bi"><span id="6a17" class="oe lx it nf b gy of og l oh oi">engine = create_engine(‘postgresql://{user}:{password}@{host}:{port}/{db}’.format(<br/>                host=creds[“LOCALHOST”],<br/>                port=ssh_tunnel.local_bind_port,<br/>                user=creds[“PG_UN”],<br/>                password=creds[“PG_DB_PW”],<br/>                db=creds[“PG_DB_NAME”]<br/>                   ))</span></pre><p id="b2a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，将所有这些放在一起，您会得到:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pe pf l"/></div></figure><h1 id="7487" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated"><strong class="ak">结论</strong></h1><p id="14ec" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在本文中，我向您展示了当需要通过SSH隧道建立安全连接时，如何通过<code class="fe nc nd ne nf b">psycopg2</code>或<code class="fe nc nd ne nf b">sqlalchemy</code>连接到PostgreSQL数据库。</p><p id="ec7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果这是您第一次被要求在工作场所使用这种方法，我希望这篇文章提供了足够的上下文，以及打破最初的技术障碍所必需的代码。</p><p id="bb0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相反，如果你熟悉SSH转发，我希望你会尝试使用我的代码作为模板，以刷新你的记忆，并完成工作:D</p></div><div class="ab cl ph pi hx pj" role="separator"><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm pn"/><span class="pk bw bk pl pm"/></div><div class="im in io ip iq"><h1 id="3626" class="lw lx it bd ly lz po mb mc md pp mf mg jz pq ka mi kc pr kd mk kf ps kg mm mn bi translated">给我的读者一个提示</h1><p id="3131" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated"><em class="lv">这篇文章包括附属链接，如果你购买的话，我可以免费给你一点佣金。</em></p></div></div>    
</body>
</html>