<html>
<head>
<title>Building a Real Time Twitter Bot that Replies with Media</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建一个实时的Twitter机器人，可以回复媒体</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-a-real-time-twitter-bot-that-replies-with-media-e353fff1c395?source=collection_archive---------13-----------------------#2021-04-18">https://towardsdatascience.com/building-a-real-time-twitter-bot-that-replies-with-media-e353fff1c395?source=collection_archive---------13-----------------------#2021-04-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ec81" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">构建一个实时Twitter bot，使用Node.js上传媒体作为对特定标签的所有tweets的回复。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/51cc7233f83802fb923f9aea8c880f9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_tyM5jm3_eydfKGs"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@alexbemore?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">亚历山大·沙托夫</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="2a8d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">源代码:<a class="ae kv" href="https://github.com/pguduguntla/twitter-bot-reply-media" rel="noopener ugc nofollow" target="_blank">https://github.com/pguduguntla/twitter-bot-reply-media</a></p><p id="14a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Twitter使得构建能够与推文、用户和分析工具交互的机器人变得非常容易，这些工具可以从平台上获取有用的见解。</p><p id="38ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我想开发一个简单的实时Twitter机器人，它可以主动过滤所有包含特定标签的推文，并通过视频/图像直接回复推文。</p><p id="d31e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本教程中，我将介绍如何设置和构建一个简单的Twitter机器人来搜索带有标签<code class="fe ls lt lu lv b">#FilterMe</code>的推文。如果这条推文包含一些媒体，那么我们的机器人将回复一个视频，如果它没有附加任何媒体，我们的机器人将回复一条类似于<code class="fe ls lt lu lv b">Oops, looks like you didn’t provide a media file!</code>的消息。所以，让我们开始吧！</p><h1 id="dda5" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">1.创建Twitter开发者账户</h1><p id="da45" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">为了访问Twitter的API，我们需要首先创建一个开发者帐户。你需要创建一个Twitter账户(如果你还没有的话),这个账户可以用来发帖。如果您不希望您的机器人与您的个人帐户相关联，<a class="ae kv" href="https://twitter.com/i/flow/signup" rel="noopener ugc nofollow" target="_blank">以您的机器人的名字创建一个新的Twitter </a>帐户。</p><p id="f882" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，你需要通过他们的网站<a class="ae kv" href="https://developer.twitter.com/en/apply-for-access" rel="noopener ugc nofollow" target="_blank">这里</a>申请一个开发者账户。该应用程序会要求您提供一系列详细信息，包括您的联系信息、使用Twitter API的原因以及编程经验水平。表单非常标准，但是当被问及您希望使用API构建什么类型的项目时，请确保提供足够的信息。您的回答越全面，审批过程就越快。</p><p id="4b8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦您完成了审批流程(可能需要24小时)，您将可以访问您自己的个人开发者门户，如下所示。如你所见，我已经创建了一个应用程序，但我将向你展示如何创建你自己的应用程序。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/694c2c47f5298871cb816e603f9a2d17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EFpSvjJARgs7tB42zrTnmQ.png"/></div></div></figure><p id="5d7a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">转到左侧导航栏上的项目和应用部分。转到<em class="mu">概述</em>，您应该能够创建一个项目或一个应用程序。项目允许您使用Twitter的最新v2 API，该API仍在生产中，因此对于像这样的简单项目，我建议通过单击“创建应用程序”按钮创建一个独立的应用程序。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ca"><img src="../Images/6ab19feb39090a14eb99fc7a2ade6d5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ghHDGeFzq0Y8_6QqryrPeg.png"/></div></div></figure><p id="832a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">单击创建应用程序后，系统会要求您在收到API密钥之前命名应用程序。</p><p id="13b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请确保将您的API密钥存储在安全的位置，因为这些密钥将用于验证我们的帐户。我们几乎完成了设置！我们只需要再获得一些访问令牌密钥，我们也需要这些密钥来验证我们的帐户。点击左侧导航栏上的应用名称，即可进入应用设置页面。点击<em class="mu">密钥和令牌</em>，并点击<em class="mu">生成</em>访问令牌和访问令牌密码。</p><p id="fcc5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">深呼吸…我们完成了设置。现在到了有趣的部分！让我们用一些代码来弄脏我们的手。</p><h1 id="8cf3" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">2.设置我们的Node.js项目</h1><p id="0719" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">在编写任何代码之前，让我们设置Node.js项目。如果你还没有Node.js，你需要安装它。你可以在这里找到如何操作的说明<a class="ae kv" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="3a62" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦你完成了，开始创建并进入你的项目文件夹。转到存储项目的目录，运行以下命令:</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="bbd3" class="mz lx iq lv b gy na nb l nc nd">mkdir twitter-bot<br/>cd twitter-bot</span></pre><p id="6d7f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了将其初始化为Node.js项目运行</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="ed34" class="mz lx iq lv b gy na nb l nc nd">npm init</span></pre><p id="48d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在初始化项目之前，将要求您命名项目并接受所有提示。这将生成一个package.json文件，该文件跟踪您的项目细节和所使用的包。</p><p id="0f7f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们将创建三个文件。</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="4e0d" class="mz lx iq lv b gy na nb l nc nd">touch bot.js<br/>touch config.js<br/>touch .env</span></pre><p id="195d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，<code class="fe ls lt lu lv b">bot.js</code>它将存储我们的Twitter机器人的主要源代码。文件<code class="fe ls lt lu lv b">config.js</code>将存储几个帮助方法，这些方法将帮助我们与API交互并简化我们在<code class="fe ls lt lu lv b">bot.js</code>中的代码。</p><p id="cb10" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">.env</code>文件将把我们的API键存储为全局变量。在您的<code class="fe ls lt lu lv b">.env</code>文件中添加以下代码。替换上面您自己的API键获得的“X”。</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="dbe0" class="mz lx iq lv b gy na nb l nc nd">API_KEY=XXXXXXXXXXXXXXXX<br/>SECRET_KEY=XXXXXXXXXXXXXXXX<br/>ACCESS_TOKEN=XXXXXXXXXXXXXXXX<br/>ACCESS_TOKEN_SECRET=XXXXXXXXXXXXXXXX</span></pre><p id="a623" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，让我们在项目中安装一些模块，帮助我们导航Twitter API和存储API键。</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="d86f" class="mz lx iq lv b gy na nb l nc nd">npm install twitter dotenv bluebird --save</span></pre><p id="b959" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">twitter包是一个第三方模块，它使得Node.js用户与Twitter API的交互更加容易。Dotenv允许我们加载全局变量(比如我们的API键),将它们与我们的项目代码分开。蓝鸟允许我们处理API请求承诺。</p><h1 id="5043" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">3.通过标签实时过滤推文</h1><p id="a565" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">让我们首先在您最喜欢的文本编辑器中打开我们的<code class="fe ls lt lu lv b">config.js</code>文件。添加以下代码，用Twitter API定义我们的身份验证。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="f2f7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的代码中，我们导入了Twitter和dotenv包。在<em class="mu"> auth </em>方法中，我们从我们的。环境文件。然后，我们用secret对象定义一个新的Twitter客户端，并返回该客户端。最后，我们导出auth方法，以便可以在bot.js中访问它。</p><p id="b321" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的bot.js文件中，我们有以下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="18ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们从导入配置文件中定义的auth函数开始。然后，我们通过调用auth函数来定义我们的Twitter客户端。然后，我们使用客户端的stream()函数来跟踪所有带有文本“#FilterMe”的公共tweets。我们将一个回调函数传递给接受流对象的stream()。当实时流检测到tweet时，它运行另一个包含tweet对象的回调函数。该对象包含关于tweet和发布它的用户的详细信息。</p><p id="6e0b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们已经收到了一条推文，我们需要检查这条推文是否附有媒体，如果有，就用视频回复！</p><h1 id="ee43" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">4.上传媒体至Tweet回复</h1><p id="7888" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">到目前为止，我们能够创建一个Twitter客户端，可以实时传输推文，并识别符合特定标准的推文。现在，我们必须与一些媒体一起发布对这条推文的回复。</p><p id="f5f4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，让我们将一个视频添加到项目文件夹的子目录中。/示例-媒体。确保你的视频是mp4格式的。</p><p id="b91f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用Twitter API，上传和访问媒体有3个步骤:</p><ol class=""><li id="deb4" class="ng nh iq ky b kz la lc ld lf ni lj nj ln nk lr nl nm nn no bi translated"><strong class="ky ir">初始化媒体上传:</strong>在Twitter的后端为我们的视频文件分配空间。为该空间检索一个<code class="fe ls lt lu lv b">mediaId</code>。</li><li id="969c" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr nl nm nn no bi translated"><strong class="ky ir">添加媒体文件:</strong>用<code class="fe ls lt lu lv b">mediaId</code>将我们的文件数据添加到Twitter后端。</li><li id="062d" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr nl nm nn no bi translated"><strong class="ky ir">完成上传</strong>:一旦我们上传到文件，我们需要完成上传以确保上传已经安全完成。</li><li id="fb77" class="ng nh iq ky b kz np lc nq lf nr lj ns ln nt lr nl nm nn no bi translated"><strong class="ky ir">发布媒体对一条推文的回复:</strong>发布对原推文的回复，并附上部分文字和我们上传的视频。</li></ol><p id="22d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将在config.js文件中添加方法来完成上述步骤。将以下代码添加到文件中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="450d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您需要更新您的导入语句以包含这些模块:</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="7931" class="mz lx iq lv b gy na nb l nc nd">const fs = require('fs');<br/>const Promise = require('bluebird')</span></pre><p id="e454" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您还需要更新文件底部的module.exports以包含postReplyWithMedia:</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="3d23" class="mz lx iq lv b gy na nb l nc nd">module.exports = { auth, postReplyWithMedia, postReply };</span></pre><p id="010b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们仔细分析上面的代码，看看每个函数在做什么。</p><p id="d6e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">initializeMediaUpload</code>方法接受一个Twitter客户端和一个文件的文件路径。在这个函数中，我们定义了视频格式和文件的大小。然后，我们调用twitter客户端上的<em class="mu"> media/upload </em>端点来为一个mp4视频文件分配空间，该文件的大小与我们的视频相同。initialize返回一个Promise对象，当它被实现时，包含Twitter数据库中我们的视频的mediaId。</p><p id="c79d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">appendFileChunk</code>方法接受一个客户机、mediaId和一个上传文件的路径。这个方法在完成<code class="fe ls lt lu lv b">initializeMediaUpload</code>时运行，因此，我们得到一个mediaId tho，我们将实际的文件数据附加到Twitter的后端。我们使用<code class="fe ls lt lu lv b">fs.readFileSync(pathToFile)</code>从文件中提取数据，并将其存储在mediaData中。再次，我们用命令“APPEND”调用<em class="mu">媒体/上传</em>端点，并传递我们的文件。返回一个包含我们的mediaId的承诺。</p><p id="ad9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，<code class="fe ls lt lu lv b">finalizeUploadMethod</code>接受一个客户端和mediaId，并再次调用<em class="mu"> media/upload </em>来确保我们的文件上传成功。然后，它返回一个带有mediaId的承诺。</p><p id="1117" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">函数<code class="fe ls lt lu lv b">postReplyWithMedia</code>是将从bot.js中调用的函数。它接受客户端、mediaFilePath和replyTweet，reply Tweet是我们要回复的tweet对象。在这个方法中，我们初始化我们的媒体上传，附加我们的媒体文件，并在发布我们的回复之前完成上传。我们构建了一个<code class="fe ls lt lu lv b">statusObj</code>，它将我们的回复消息存储在<em class="mu">状态</em>中，将tweet Id存储在<em class="mu"> in_reply_to_status_id </em>中，将我们视频的mediaId存储在<em class="mu"> media_ids中。</em>然后，我们使用<em class="mu">status/update</em>端点发布我们的状态，我们在回调中接收我们新发布的tweet。</p><p id="ea86" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">函数<code class="fe ls lt lu lv b">postReply</code>获取客户端、消息和tweet，并以与上述函数类似的方式发布回复。</p><p id="2b31" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">快好了！现在我们只需要导入并调用bot.js中的postReplyWithMedia和postReply方法。</p><p id="2e36" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的bot.js文件中，我们只需要添加一个if语句来检查原始tweet是否包含媒体。我们可以通过检查tweet对象是否有media_url键来做到这一点。最终的bot.js文件应该如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="99b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们走吧！您应该能够通过运行以下命令来运行您的bot:</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="9fe8" class="mz lx iq lv b gy na nb l nc nd">node bot.js</span></pre><p id="6aa9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尝试自己或让朋友用标签“#FilterMe”来发布你的机器人，看看你的帐户是否会发布帖子。这可能需要一秒钟的时间，但是如果你按照这些步骤去做，应该会成功！</p><h1 id="b3db" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">5.后续步骤</h1><p id="f6ab" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">恭喜你。你创建了一个可以实时用视频回复推文的Twitter机器人。然而，我们的应用程序目前在本地运行。如果您希望将应用程序部署到云上，可以考虑将项目托管在Heroku或AWS上。这里有一个很好的免费教程，可以让你在Heroku上快速部署你的机器人。</p><p id="76bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望你学到了新的东西！如果您有任何反馈或问题，请随时告诉我。一如既往的感谢阅读！:))</p><p id="bb30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">源代码:<a class="ae kv" href="https://github.com/pguduguntla/twitter-bot-reply-media" rel="noopener ugc nofollow" target="_blank">https://github.com/pguduguntla/twitter-bot-reply-media</a></p><p id="6582" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">编码快乐！</p></div></div>    
</body>
</html>