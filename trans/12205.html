<html>
<head>
<title>Introducing DataJob — build and deploy a serverless data pipeline on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DataJob 简介—在 AWS 上构建和部署无服务器数据管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/datajob-build-and-deploy-a-serverless-data-pipeline-on-aws-18bcaddb6676?source=collection_archive---------17-----------------------#2021-12-10">https://towardsdatascience.com/datajob-build-and-deploy-a-serverless-data-pipeline-on-aws-18bcaddb6676?source=collection_archive---------17-----------------------#2021-12-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a276" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用几行代码将您的代码部署为一组 Glue/Sagemaker 作业，并用 Step 函数编排它们</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ba1f244956064b71d1e8b27800dab467.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hR1rm36qRjIVGj1DT5596w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/photos/Q1p7bh3SHj8" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/Q1p7bh3SHj8</a></p></figure><h1 id="a7d4" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">动机</h1><p id="743f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">数据工程师的核心活动之一是构建、部署、运行和监控数据管道。当我在数据和 ML 工程领域工作时，我缺少一个工具来简化在 AWS 服务上部署我的数据管道的过程，如<a class="ae ky" href="https://docs.aws.amazon.com/glue/latest/dg/add-job.html" rel="noopener ugc nofollow" target="_blank"> Glue </a>和<a class="ae ky" href="https://aws.amazon.com/sagemaker/" rel="noopener ugc nofollow" target="_blank"> Sagemaker </a>，以及如何用<a class="ae ky" href="https://aws.amazon.com/step-functions" rel="noopener ugc nofollow" target="_blank">步骤函数</a>轻松编排我的数据管道的步骤。这让我开发了<a class="ae ky" href="https://github.com/vincentclaes/datajob" rel="noopener ugc nofollow" target="_blank"> DataJob </a>！🚀</p><p id="324f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本文中，我将向您展示如何安装 DataJob，引导您完成一个简单的示例，并展示 DataJob 的几个特性。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><blockquote class="mz na nb"><p id="bdd1" class="lr ls nc lt b lu mn ju lw lx mo jx lz nd mp mc md ne mq mg mh nf mr mk ml mm im bi translated">为了继续我的开发，我希望<strong class="lt iu">从社区中获得一些反馈</strong>,要么继续并添加额外的服务(lambda、ecs fargate、aws batch 等)，要么改变方向，要么放弃这个开源项目。</p><p id="20e4" class="lr ls nc lt b lu mn ju lw lx mo jx lz nd mp mc md ne mq mg mh nf mr mk ml mm im bi translated">请回复我！🙏</p></blockquote><div class="ng nh gp gr ni nj"><a href="https://github.com/vincentclaes/datajob" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">GitHub - vincentclaes/datajob:毫不费力地在 AWS 上构建和部署一个无服务器的数据管道。</h2><div class="nq l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">毫不费力地在 AWS 上构建和部署无服务器数据管道。我们的目标是让开发人员思考…</h3></div><div class="nr l"><p class="bd b dl z fp no fr fs np fu fw dk translated">github.com</p></div></div><div class="ns l"><div class="nt l nu nv nw ns nx ks nj"/></div></div></a></div></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="adeb" class="kz la it bd lb lc ny le lf lg nz li lj jz oa ka ll kc ob kd ln kf oc kg lp lq bi translated">数据作业安装</h1><p id="e812" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您可以从<a class="ae ky" href="https://pypi.org/project/datajob/" rel="noopener ugc nofollow" target="_blank"> PyPI </a>安装 DataJob。DataJob 使用<a class="ae ky" href="https://github.com/aws/aws-cdk" rel="noopener ugc nofollow" target="_blank"> AWS CDK </a>来提供 AWS 服务，所以请确保也安装它。如果您想学习这个例子，您当然需要一个 AWS 帐户🙂</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="4bc8" class="oi la it oe b gy oj ok l ol om"><strong class="oe iu">pip install --upgrade pip<br/>pip install datajob</strong></span><span id="56da" class="oi la it oe b gy on ok l ol om"># take latest of v1, there is no support for v2 yet<br/><strong class="oe iu">npm install -g aws-cdk@</strong><a class="ae ky" href="https://www.npmjs.com/package/aws-cdk/v/1.134.0" rel="noopener ugc nofollow" target="_blank"><strong class="oe iu">1.134.0</strong></a></span></pre><h1 id="4ebf" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">简单的例子</h1><p id="d490" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们有一个简单的数据管道，由两个打印“Hello World”的任务组成，这些任务需要按顺序编排。任务被部署到 Glue，并由 Step 函数进行编排。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="5966" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们将上述代码添加到项目根目录下名为<code class="fe oq or os oe b">datajob_stack.py</code>的文件中。该文件包含配置 AWS 服务、部署代码和运行数据管道所需的一切。</p><p id="ad9c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要继续，请复制该存储库并导航至示例。</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="bfee" class="oi la it oe b gy oj ok l ol om"><strong class="oe iu">git clone </strong><a class="ae ky" href="https://github.com/vincentclaes/datajob.git" rel="noopener ugc nofollow" target="_blank"><strong class="oe iu">https://github.com/vincentclaes/datajob.git</strong></a><strong class="oe iu"><br/>cd datajob/examples/data_pipeline_simple</strong></span></pre><h2 id="c41f" class="oi la it bd lb ot ou dn lf ov ow dp lj ma ox oy ll me oz pa ln mi pb pc lp pd bi translated">配置 CDK</h2><p id="a360" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">要配置 CDK，您需要 AWS 凭据。如果您不知道如何配置您的 AWS 凭证，请遵循这里的步骤<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html#cli-configure-quickstart-config" rel="noopener ugc nofollow" target="_blank"/>。</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="d7d6" class="oi la it oe b gy oj ok l ol om"><strong class="oe iu">export AWS_PROFILE=default</strong></span><span id="f96e" class="oi la it oe b gy on ok l ol om"># use the aws cli to get your account number<br/><strong class="oe iu">export AWS_ACCOUNT=$(aws sts get-caller-identity --query Account --output text --profile $AWS_PROFILE)</strong></span><span id="5ebf" class="oi la it oe b gy on ok l ol om"><strong class="oe iu">export AWS_DEFAULT_REGION=eu-west-1</strong></span><span id="d91a" class="oi la it oe b gy on ok l ol om"># bootstrap aws account for your region<br/><strong class="oe iu">cdk bootstrap aws://$AWS_ACCOUNT/$AWS_DEFAULT_REGION</strong></span><span id="c0e6" class="oi la it oe b gy on ok l ol om">    ⏳  Bootstrapping environment aws://01234567890/eu-west-1...<br/>    CDKToolkit: creating CloudFormation changeset...<br/>    ✅  Environment aws://01234567890/eu-west-1 bootstrapped.</span></pre><h2 id="0a45" class="oi la it bd lb ot ou dn lf ov ow dp lj ma ox oy ll me oz pa ln mi pb pc lp pd bi translated">部署</h2><p id="a5fc" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">使用包含您的代码的粘合作业和将编排粘合作业的 Step Functions 状态机创建 DataJob 堆栈。</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="7244" class="oi la it oe b gy oj ok l ol om"><strong class="oe iu">cdk deploy --app  "python datajob_stack.py" --require-approval never</strong></span><span id="d8e3" class="oi la it oe b gy on ok l ol om"><strong class="oe iu">     </strong>data-pipeline-simple:<strong class="oe iu"> </strong>deploying...</span><span id="7d98" class="oi la it oe b gy on ok l ol om">     [0%] start: Publishing     <br/>     [50%] success: Published <br/>     [100%] success: Published </span><span id="4474" class="oi la it oe b gy on ok l ol om"><strong class="oe iu">   </strong>  data-pipeline-simple: creating CloudFormation changeset...<br/>     ✅  data-pipeline-simple</span></pre><p id="aacb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">当<code class="fe oq or os oe b">cdk deploy</code>成功完成时，服务被配置并准备好执行。</p><h2 id="7fbf" class="oi la it bd lb ot ou dn lf ov ow dp lj ma ox oy ll me oz pa ln mi pb pc lp pd bi translated">执行</h2><p id="9ce4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">触发将编排数据管道的步骤函数状态机。</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="5acf" class="oi la it oe b gy oj ok l ol om"><strong class="oe iu">datajob execute --state-machine data-pipeline-simple-workflow</strong></span><span id="9a1b" class="oi la it oe b gy on ok l ol om">    executing: data-pipeline-simple-workflow<br/>    status: RUNNING<br/>    view the execution on the AWS console:</span><span id="088b" class="oi la it oe b gy on ok l ol om">       <em class="nc">&lt;here will be a link to see the step functions workflow&gt;</em></span></pre><p id="d73d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">终端将显示一个到 step functions 网页的链接，以跟进您的管道运行。如果您单击该链接，您应该会看到如下内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pe"><img src="../Images/4f892d689d836c985a671d5336c930af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hw9bW3PgTR6yiVa7F-wRLw.png"/></div></div></figure><h2 id="9ed5" class="oi la it bd lb ot ou dn lf ov ow dp lj ma ox oy ll me oz pa ln mi pb pc lp pd bi translated">破坏</h2><p id="7f43" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一旦您的数据管道完成，将其从 AWS 中移除。这将为您留下一个干净的 AWS 帐户。</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="0b81" class="oi la it oe b gy oj ok l ol om"><strong class="oe iu">cdk destroy --app  "python datajob_stack.py"</strong></span><span id="da01" class="oi la it oe b gy on ok l ol om">    data-pipeline-simple: destroying...<br/>    ✅  data-pipeline-simple: destroyed</span></pre></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="7083" class="kz la it bd lb lc ny le lf lg nz li lj jz oa ka ll kc ob kd ln kf oc kg lp lq bi translated">数据作业的一些功能</h1><h2 id="84d4" class="oi la it bd lb ot ou dn lf ov ow dp lj ma ox oy ll me oz pa ln mi pb pc lp pd bi translated"><strong class="ak"> 1。使用 Glue Pyspark 作业处理大数据</strong></h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div></figure><p id="f121" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在<a class="ae ky" href="https://github.com/vincentclaes/datajob/blob/main/examples/data_pipeline_pyspark" rel="noopener ugc nofollow" target="_blank">示例</a>中找到更多信息。</p><h2 id="171b" class="oi la it bd lb ot ou dn lf ov ow dp lj ma ox oy ll me oz pa ln mi pb pc lp pd bi translated">2.部署隔离管道</h2><p id="5fac" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在 CDK 中将阶段指定为上下文参数，以部署隔离管道。典型的例子有<code class="fe oq or os oe b">dev</code>、<code class="fe oq or os oe b">prod</code>、...</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="ef57" class="oi la it oe b gy oj ok l ol om">cdk deploy --app "python datajob_stack.py" --context stage=dev</span></pre><h2 id="4026" class="oi la it bd lb ot ou dn lf ov ow dp lj ma ox oy ll me oz pa ln mi pb pc lp pd bi translated">3.并行编排步骤功能任务</h2><p id="3f92" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了加速数据管道，您可能希望并行运行任务。这可以通过 DataJob 实现！我借用了气流的概念，您可以使用操作符<code class="fe oq or os oe b">&gt;&gt;</code>来协调不同的任务。</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="b939" class="oi la it oe b gy oj ok l ol om">with StepfunctionsWorkflow(datajob_stack=datajob_stack, name="workflow") as sfn:<br/>    task1 &gt;&gt; task2<br/>    task3 &gt;&gt; task4<br/>    task2 &gt;&gt; task5<br/>    task4 &gt;&gt; task5</span></pre><p id="64d8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">DataJob 指出哪些任务可以并行运行，以加快执行速度。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/cb26e5fad0e8705c1d8635e661781324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*knvT172boam1FZgo0sBvBg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一旦我们部署并触发，您将在步骤功能执行中看到并行任务。</p></figure><p id="f579" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在<a class="ae ky" href="https://github.com/vincentclaes/datajob/blob/main/examples/data_pipeline_parallel" rel="noopener ugc nofollow" target="_blank">示例</a>中找到更多信息。</p><h2 id="6475" class="oi la it bd lb ot ou dn lf ov ow dp lj ma ox oy ll me oz pa ln mi pb pc lp pd bi translated">4.出错/成功时通知</h2><p id="491d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在一个<code class="fe oq or os oe b">StepfunctionsWorkflow</code>对象的构造函数中为参数<code class="fe oq or os oe b">notification</code>提供一个电子邮件地址。这将创建一个 SNS 主题，该主题将在失败或成功的情况下触发。该电子邮件将在其收件箱中收到通知。</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="c8c7" class="oi la it oe b gy oj ok l ol om">with StepfunctionsWorkflow(datajob_stack=datajob_stack,<br/>                           name="workflow",<br/>                           notification="email@domain.com") as sfn:<br/>    task1 &gt;&gt; task2</span></pre><h2 id="1b5a" class="oi la it bd lb ot ou dn lf ov ow dp lj ma ox oy ll me oz pa ln mi pb pc lp pd bi translated">5.将您的项目打包成一个轮子，并将其发送到 AWS</h2><p id="f3b0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">传送您的项目及其所有要粘附的依赖项。通过在 DataJobStack 的构造函数中指定<code class="fe oq or os oe b">project_root</code>，DataJob 会寻找一个轮子(。whl 文件)放在 project_root 的<code class="fe oq or os oe b">dist/</code>文件夹中。</p><pre class="kj kk kl km gt od oe of og aw oh bi"><span id="9339" class="oi la it oe b gy oj ok l ol om">current_dir = str(pathlib.Path(__file__).parent.absolute())</span><span id="4675" class="oi la it oe b gy on ok l ol om">with DataJobStack(<br/>    scope=app, id="data-pipeline-pkg", project_root=current_dir<br/>) as datajob_stack:</span></pre><p id="4766" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在<a class="ae ky" href="https://github.com/vincentclaes/datajob/blob/main/examples/data_pipeline_with_packaged_project" rel="noopener ugc nofollow" target="_blank">示例</a>中找到更多信息</p><h2 id="9f5c" class="oi la it bd lb ot ou dn lf ov ow dp lj ma ox oy ll me oz pa ln mi pb pc lp pd bi translated">6.添加 Sagemaker 以创建 ML 管道</h2><p id="1395" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">使用 Glue、Sagemaker 和 Step 函数查看 GitHub repo 上的<a class="ae ky" href="https://github.com/vincentclaes/datajob/tree/main/examples/ml_pipeline_end_to_end" rel="noopener ugc nofollow" target="_blank">端到端机器学习管道</a>的新示例。</p><p id="f853" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> ⚠️ <em class="nc">给我一个回复，告诉我你喜欢什么，不喜欢什么，以及你希望在 DataJob 中看到的其他服务！</em> ⚠️ </strong></p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><div class="kj kk kl km gt nj"><a href="https://github.com/vincentclaes/datajob" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">GitHub - vincentclaes/datajob:毫不费力地在 AWS 上构建和部署一个无服务器的数据管道。</h2><div class="nq l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">毫不费力地在 AWS 上构建和部署无服务器数据管道。我们的目标是让开发人员思考…</h3></div><div class="nr l"><p class="bd b dl z fp no fr fs np fu fw dk translated">github.com</p></div></div><div class="ns l"><div class="pg l nu nv nw ns nx ks nj"/></div></div></a></div></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="4f00" class="kz la it bd lb lc ny le lf lg nz li lj jz oa ka ll kc ob kd ln kf oc kg lp lq bi translated">文森特·克拉斯</h1><p id="ddf1" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">👋如果您想了解更多关于 ML 工程和 ML 管道的信息，请关注我的<a class="ae ky" href="https://medium.com/@vincentclaes_43752" rel="noopener"> Medium </a>、<a class="ae ky" href="https://www.linkedin.com/in/vincent-claes-0b346337/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>和<a class="ae ky" href="https://twitter.com/VincentClaes1" rel="noopener ugc nofollow" target="_blank"> Twitter </a>。</p></div></div>    
</body>
</html>