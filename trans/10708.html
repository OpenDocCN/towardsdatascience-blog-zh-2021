<html>
<head>
<title>Simulating Continuous Learning Models with Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用气流模拟连续学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/simulating-continuous-learning-models-with-airflow-93d852718a78?source=collection_archive---------22-----------------------#2021-10-14">https://towardsdatascience.com/simulating-continuous-learning-models-with-airflow-93d852718a78?source=collection_archive---------22-----------------------#2021-10-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f260" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">配置工作流管理工具，在13分钟内定期重新创建模型</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5704b8484990278059a9f5f60d8bcd84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9FLKT38VrTCKhuj-n4pcKQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由来自<a class="ae ky" href="https://www.pexels.com/photo/scenic-view-of-rainforest-927414/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的<a class="ae ky" href="https://www.pexels.com/@arnie-chou-304906?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">阿尼·周</a>拍摄</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="e420" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi mc translated"><span class="l md me mf bm mg mh mi mj mk di"> C </span>持续学习是系统自适应学习外部世界的过程。在机器学习的背景下，模型通过自主和增量开发不断地学习更多关于它被训练的主题领域的知识。这使模型能够学习更复杂的逻辑、知识和功能，从而有助于做出更好的预测。</p><p id="2f0d" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">持续学习对于更新模型尤其重要。假设你被一家生产哑铃的制造公司聘为数据科学家，比如鹦鹉螺公司。你的目标是预测下个季度的收入和销售额。从2017年3月到2020年3月，您的模型在收入预测上的准确率为95%。但是，从2020年3月到2021年1月，你的模型的准确率是40%。发生了什么事？</p><p id="69ff" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">2020年3月—2021年1月发生的重大事件是冠状病毒。检疫条例迫使人们呆在室内，不要频繁外出。不能再去健身房的健身爱好者不得不建立他们的内部健身房，以跟上他们的锻炼养生。鹦鹉螺公司是哑铃和家用健身设备的领先公司，因此在疫情期间销售额飙升。在这种情况下，你在2017年创建的模型将严重低估2020年的预测销售额。这是一个很好的例子，说明为什么一个模型需要根据最近的和新出现的当前数据进行重新训练。世界的发展速度令人难以置信，3年前的数据见解可能不适用于不断发展的数据。</p><p id="8fdf" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您可能已经意识到需要创建3个独立的模型:一个在疫情之前(2020年3月之前)接受数据培训，一个在疫情期间(2020年3月-2021年5月)接受数据培训，一个在疫情之后(2021年5月至今)接受数据培训。但是，您可能没有足够的时间按照特定的时间段清晰地分割数据集。因为您可以假设疫情的开始和结束日期(例如，假设疫情的结束时间是疫苗推出的时间)，所以您可以准确地知道在哪里分割数据集。</p><p id="e370" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">随着时间的推移，各种数据集可能会发生微妙的变化，您需要应用一种持续学习的方法，以便您的模型能够随着新信息的出现而学习。这些数据既反映了收集数据的动态环境，也反映了提供数据的形式和格式。作为后一种发展的例子，考虑一个图像分类器，它确定1000页pdf中的一页是文本还是表单。随着时间的推移，表单的格式会发生变化，原始图像分类器会将其识别为文本。因为您不知道表单更改的确切时间，所以您需要根据所有当前数据训练一个模型。此外，图像分类器必须在较新的表单数据上重新训练，同时跟踪较旧的表单数据。</p><p id="c27b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">一个模型需要一个持续的学习方法来基于更新的数据进行再训练和更新。也就是说，用数学方法实现深度学习模型和递归神经网络的这种方法可能非常棘手。许多数据科学家不具备在公司期限内构建这种定制模型的知识。但是，有一种方法可以使用工作流管理工具(如<strong class="li iu"> Airflow </strong>)来模拟持续学习。在预定的基础上，Airflow可以获取新的训练数据，并使用以前的和新的数据重建模型。然后，数据科学家可以构建简单的模型(无论是他们自己构建的简单<strong class="li iu"> PyTorch </strong>神经网络，还是他们利用现有的Python机器学习库，如scikit-learn)，并专注于持续更新训练数据。</p><p id="0df3" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">本文将通过一个例子来说明如何对时间序列模型应用连续学习。我们的模型将使用ARIMA分析两只股票的历史股票市场数据:Fastly和Nautilus。</p><p id="793e" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">免责声明:</strong>这不是投资建议。话虽如此，我确实持有这两只股票。所以我倾向于提升他们，这样我就能从中受益。在花你的血汗钱之前做你的研究。</p><p id="85da" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">另外，在你决定用ARIMA预测股市之前，请多读一些时间序列方面的书。当数据集中存在可识别的模式时，时间序列模型是有效的。我没有花时间去分析ARIMA是否适合预测Fastly和Nautilus的股票历史数据。本文从数据工程的角度讨论构建持续学习架构。ARIMA和时间序列被用来表明，这种架构可以用于各种类型的模型(时间序列，分类，神经网络)。分析这种时间序列模型的预测指标超出了本文的范围。</p><h1 id="45a1" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">为什么是气流？</h1><p id="5bed" class="pw-post-body-paragraph lg lh it li b lj nd ju ll lm ne jx lo lp nf lr ls lt ng lv lw lx nh lz ma mb im bi translated">Airflow是一个用Python编写的开源工作流管理工具。它已经成为行业标准，并且很容易建立。在处理复杂和动态的工作流时，气流也有缺点，最好使用不同的工作流工具，如Prefect。对于本教程，我们将创建一个简单的工作流。因此，气流是完美的。</p><p id="3b9f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们将在AWS EC2上设置气流。如果你愿意，你也可以利用AWS MWAA(亚马逊管理的Apache Airflow工作流)。但是，请记住，对于一些开发人员的预算来说，AWS MWAA可能很昂贵。例如，我每天只需支付27美元就可以让它正常运行，其他AWS弹性云服务(例如NAT网关)每月支付80美元。</p><h1 id="45ef" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">术语</h1><ul class=""><li id="4b55" class="ni nj it li b lj nd lm ne lp nk lt nl lx nm mb nn no np nq bi translated">AWS MWAA-亚马逊管理的Apache Airflow工作流。处理气流的所有设置和配置，但维护费用昂贵。</li><li id="4d3f" class="ni nj it li b lj nr lm ns lp nt lt nu lx nv mb nn no np nq bi translated">AWS EC2 —运行应用程序的虚拟服务器。</li><li id="7cd0" class="ni nj it li b lj nr lm ns lp nt lt nu lx nv mb nn no np nq bi translated">AWS S3——存放腌制模型的桶。</li><li id="faae" class="ni nj it li b lj nr lm ns lp nt lt nu lx nv mb nn no np nq bi translated">ARIMA——自回归综合移动平均。它是一类模型，捕捉时间序列数据中一组不同的标准时间结构。</li></ul><h1 id="fd09" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">推荐阅读</h1><p id="6e6d" class="pw-post-body-paragraph lg lh it li b lj nd ju ll lm ne jx lo lp nf lr ls lt ng lv lw lx nh lz ma mb im bi translated">本教程假设您对气流和Dag有基本的了解。如果没有，请阅读<a class="ae ky" rel="noopener" target="_blank" href="/airflow-how-and-when-to-use-it-2e07108ac9f5">气流:如何以及何时使用</a>。</p><p id="82bc" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">要理解气流的架构，请阅读<a class="ae ky" href="https://freecontent.manning.com/an-overview-of-apache-airflow-architecture/" rel="noopener ugc nofollow" target="_blank">Apache气流架构概述</a>。</p><p id="831e" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">本教程使用ARIMA进行时间序列分析。这个主题超出了本文的范围。如果你想更多的了解时间序列和ARIMA，我推荐<a class="ae ky" href="https://people.duke.edu/~rnau/411arim.htm" rel="noopener ugc nofollow" target="_blank">Arima简介:非季节模型</a>。</p><h1 id="04cc" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">体系结构</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/2d18e00dc1e1952c911798aee2f16e4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MogCb6FbY2Eu7gVN55BKAg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我使用<a class="ae ky" href="https://www.cloudcraft.co/" rel="noopener ugc nofollow" target="_blank"> Cloudcraft </a>创建的气流架构图</p></figure><h1 id="c8b3" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">辅导的</h1><p id="c2e5" class="pw-post-body-paragraph lg lh it li b lj nd ju ll lm ne jx lo lp nf lr ls lt ng lv lw lx nh lz ma mb im bi translated">在本教程中，我们将在Linux Ubuntu Server 20.04 LTS上安装Airflow。我们可以使用类型<strong class="li iu"> t2.medium </strong>创建一个AWS EC2映像。要阅读更多关于AWS EC2的内容，我推荐亚马逊的教程<a class="ae ky" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="9ae2" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">Airflow需要运行一个web服务器和一个调度程序，因此它需要比自由层提供的内存更多的内存。t2.medium有足够的资源来安装和运行Airflow。</p><p id="b1cd" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们还使用Ubuntu，因为它是为数不多的适合机器学习的Linux操作系统之一。其他Linux操作系统(包括AWS Linux)将不会有一些机器学习库所需的确切包和依赖项，包括脸书先知。他们有这些包的替代品，但如果脸书先知不能正确编译它们也没关系。脸书预言家需要一个被称为C++14的C++标准来编译它所有的依赖项。Ubuntu(和Mac OS)支持C++14，但CentOS或AWS Linux不支持。Ubuntu和MacOS对于下载未来的机器学习包并正确编译非常有用。</p><h2 id="7ae7" class="nx mm it bd mn ny nz dn mr oa ob dp mv lp oc od mx lt oe of mz lx og oh nb oi bi translated">创建EC2实例</h2><p id="6637" class="pw-post-body-paragraph lg lh it li b lj nd ju ll lm ne jx lo lp nf lr ls lt ng lv lw lx nh lz ma mb im bi translated">登录AWS控制台并导航到EC2 &gt;实例&gt;启动实例。配置您的实例，使其与以下内容匹配。</p><p id="783f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">注意:</strong>我删除了安全组中Source下的IP地址。但是为了保护您的实例以确保没有其他人可以访问它，请确保您选择了我的IP而不是Anywhere)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/820598f7510324ef5f1f40fe69e7222e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vLcjso2pGa4uo2IUL0hhBA.png"/></div></div></figure><p id="de61" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">编辑:</strong>除了这些安全组，还应该添加HTTP，TCP，端口8080。默认情况下，该端口由airflow webserver使用。如果您想使用不同的airflow服务器端口，您应该更改端口。</p><p id="00cc" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">启动实例时，它会询问您从哪里下载. pem文件。将此文件命名为airflow_stock.pem，并将其存储在您选择的文件夹中。</p><p id="20c0" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">等待EC2实例运行，然后在本地终端上调用这个命令。</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="90de" class="nx mm it ol b gy op oq l or os">ssh -i "airflow_stock.pem" ubuntu@ec2-3-131-153-136.us-east-2.compute.amazonaws.com</span></pre><p id="ff82" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">SSH是一个安全的Shell协议，允许您在本地命令行上登录到云实例。它需要一个. pem文件来验证您是否可以登录到服务器。</p><p id="5d77" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">注意:</strong>如果你得到一个<em class="ot">未受保护的私钥</em>错误，这意味着你的。pem是大家看得见的。您只需要调整. pem的权限。在执行之前运行此命令</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="3380" class="nx mm it ol b gy op oq l or os">chmod 400 airflow_stock.pem</span></pre><p id="3887" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">有关此错误的更多信息，请参见本文<a class="ae ky" href="https://99robots.com/how-to-fix-permission-error-ssh-amazon-ec2-instance/" rel="noopener ugc nofollow" target="_blank">这里的</a>。</p><h2 id="da4b" class="nx mm it bd mn ny nz dn mr oa ob dp mv lp oc od mx lt oe of mz lx og oh nb oi bi translated">安装Pip和气流</h2><p id="abcb" class="pw-post-body-paragraph lg lh it li b lj nd ju ll lm ne jx lo lp nf lr ls lt ng lv lw lx nh lz ma mb im bi translated">假设你有一个干净的Ubuntu实例，你需要安装pip和apache-airflow。要安装pip，请运行以下命令</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="7349" class="nx mm it ol b gy op oq l or os">sudo apt update<br/>sudo apt install python3-pip</span></pre><p id="3894" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们将在教程中使用Python 3。要安装apache-airflow，请运行以下命令</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="654c" class="nx mm it ol b gy op oq l or os">pip3 install apache-airflow</span></pre><p id="e5da" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">下一步是创建文件作为气流项目的一部分。</p><h2 id="6aa9" class="nx mm it bd mn ny nz dn mr oa ob dp mv lp oc od mx lt oe of mz lx og oh nb oi bi translated">创建文件夹结构</h2><p id="46fd" class="pw-post-body-paragraph lg lh it li b lj nd ju ll lm ne jx lo lp nf lr ls lt ng lv lw lx nh lz ma mb im bi translated">您可以创建以下文件，或者从<a class="ae ky" href="https://github.com/hd2zm/Data-Science-Projects/tree/master/Medium/Airflow_CL/airflow" rel="noopener ugc nofollow" target="_blank"> git repo </a>中获取。</p><p id="f74f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">该文件夹有4个组件:一个用于添加气流环境变量的bash脚本(add_airflow_env_variables.sh)，一个用于安装pip包的需求文本(requirements.txt)，一个启动气流脚本(start_airflow.sh)，一个停止气流脚本(stop_airflow.sh)，以及一个dags文件夹，该文件夹提取股票数据并从所有数据中重建ARIMA时间序列模型。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/d524e6fd72d088ee70f3fd95709ebe02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*CMWj0BAFcnlVViz822Di9A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Visual Studio代码中气流文件夹结构的屏幕截图</p></figure><p id="301f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">add _ airflow _ env _ variables . sh</strong>包含了我们在运行air flow之前需要设置的所有环境变量。现在，它只列出了AIRFLOW_HOME，我们存储AIRFLOW的日志/输出/数据库的路径。我在ec2实例中克隆了这个repo，所以我使用了github repo 的<a class="ae ky" href="https://github.com/hd2zm/Data-Science-Projects/tree/master/Medium/Airflow_CL/airflow" rel="noopener ugc nofollow" target="_blank">文件路径。</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="c72b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这个<strong class="li iu"> requirements.txt </strong>文件包含了我们需要的所有pip包。</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="7002" class="nx mm it ol b gy op oq l or os">statsmodels<br/>pandas<br/>pandas_datareader<br/>boto3<br/>awscli</span></pre><p id="1e27" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">要安装requirements.txt中的所有包，只需运行</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="cc89" class="nx mm it ol b gy op oq l or os">pip3 install -r requirements.txt</span></pre><p id="a1b3" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu"> start_airflow.sh </strong>包含在EC2服务器上启动airflow的所有命令。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="20fb" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu"> stop_airflow.sh </strong>包含停止当前在EC2服务器上运行的air flow web服务器和调度程序的所有命令。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="f0fa" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu"> stock_data_dag.py </strong>将包含触发工作流的逻辑。工作流分为两个功能:提取和加载。</p><p id="3c47" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">Extract</strong>(<em class="ot">get _ stock _ data</em>)将从TIINGO获取股票从2015年1月1日到触发日的所有历史价格。对于本教程来说，这个平台已经足够了。然而，在生产环境中，平台将要求只获取当天的数据，并追加到存储在S3中的以前的历史数据。</p><p id="9c08" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">Load</strong>(<em class="ot">store _ arima _ model _ in _ s3</em>)从历史股票价格中创建ARIMA模型，并将腌制文件存储在S3桶中。我们可以获取那些根据新的训练数据重新训练过的新模型。</p><p id="ce18" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">注意:</strong>您需要创建一个TIINGO帐户来获取get_stock_data中使用的API键(第25行)。</p><p id="dccf" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">将python函数<em class="ot"> get_stock_data </em>和<em class="ot">store _ ARIMA _ model _ in _ S3</em>视为<strong class="li iu">任务</strong>。为了在DAG上调用这些任务，我们需要使用<strong class="li iu">操作符</strong>。操作符是DAG的主要构件，用于执行某些功能/脚本/API/查询等。在本例中，我们创建了4个不同的Python运算符:</p><ul class=""><li id="a887" class="ni nj it li b lj lk lm ln lp ox lt oy lx oz mb nn no np nq bi translated">获取NLS股票数据</li><li id="3a2b" class="ni nj it li b lj nr lm ns lp nt lt nu lx nv mb nn no np nq bi translated">商店_ NLS _ ARIMA _模型_in_s3</li><li id="714d" class="ni nj it li b lj nr lm ns lp nt lt nu lx nv mb nn no np nq bi translated">获取_ FSLY _股票_数据</li><li id="ffe2" class="ni nj it li b lj nr lm ns lp nt lt nu lx nv mb nn no np nq bi translated">存储_FSLY_arima_model_in_s3</li></ul><p id="337d" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">工作流时间表的格式为crontab:0 17 * * 1–5。这意味着该工作流将在每个工作日的下午5点被触发。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="1eec" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><em class="ot"> stock_data_dag </em>为每只股票列出了两个不同的任务:get_stock_data和<em class="ot"> store_stock_arima_model </em>到s3。<em class="ot"> get_stock_data </em>获取自2015年1月1日以来的TIINGO历史股票数据，并将其存储在JSON中。<em class="ot"> store_stock_arima_model </em>获取股票JSON，获取所有日期的调整后收盘价，根据这些价格构建arima模型，并将ARIMA模型存储在名为<code class="fe pa pb pc ol b">stock-model</code>的S3存储桶中。然后我们可以从S3下载模型，用它们来预测第二天的价格。</p><p id="5ce6" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">注意:</strong>这种架构不仅仅适用于ARIMA车型。各种其他skikit-learn模型和算法，如XGBoost、RandomForest、NaiveBayes、LinearRegression、LogisticRegression和SVM，都可以从这种持续学习方法中受益。您可以简单地重用<strong class="li iu"> stock_data_dag.py </strong>文件的<em class="ot">store _ ARIMA _ model _ in _ S3</em>函数，或者直接编辑python DAG并将第44行更改为您想要的模型。您甚至可以添加自己的神经网络逻辑来代替skikit-learn模型，也就是说，您必须重新考虑您的回归/分类模型是基于哪些数据进行训练的。您可能需要更改<em class="ot"> get_stock_data </em>来为您的模型获取不同的数据集。无论您试图解决什么样的业务问题，这种气流持续学习架构都可以互换，以适用于各种用例。</p><p id="18c9" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们现在有了本教程计算所需的所有文件。下一步是执行某些脚本，并为运行配置气流。</p><h2 id="d788" class="nx mm it bd mn ny nz dn mr oa ob dp mv lp oc od mx lt oe of mz lx og oh nb oi bi translated">创建AWS S3时段</h2><p id="71bf" class="pw-post-body-paragraph lg lh it li b lj nd ju ll lm ne jx lo lp nf lr ls lt ng lv lw lx nh lz ma mb im bi translated">我们想创建一个S3桶来存储我们的模型。导航到S3并创建一个名为<code class="fe pa pb pc ol b">stock-model</code>的新存储桶。然后，我们将配置EC2 aws凭证，以便我们可以使用boto3来存储进入S3的气流的模型。</p><h2 id="6465" class="nx mm it bd mn ny nz dn mr oa ob dp mv lp oc od mx lt oe of mz lx og oh nb oi bi translated">配置AWSCLI</h2><p id="1471" class="pw-post-body-paragraph lg lh it li b lj nd ju ll lm ne jx lo lp nf lr ls lt ng lv lw lx nh lz ma mb im bi translated">我们想把我们的ARIMA模型存放在一个S3桶里。为此，我们需要在EC2实例上配置本地AWS设置，以便它能够识别所需的AWS帐户。</p><p id="9cf2" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">首先，导航到IAM管理控制台的“安全身份证明”页面:<a class="ae ky" href="https://console.aws.amazon.com/iam/home?#/security_credentials" rel="noopener ugc nofollow" target="_blank"> IAM管理控制台(Amazon.com)</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/b11286c9e9c68f306eb956c961bdcaab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xNZXYss-e_QqFabf0wG4wQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">IAM的安全身份证明页</p></figure><p id="c578" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果您还没有这样做，向下滚动访问键，并点击创建新的访问键。这将生成一个excel文件，您可以下载该文件来获得您的访问密钥和秘密访问密钥。不要与任何人共享此文件。如果您这样做，您的AWS帐户将面临黑客攻击和可能的超额收费的风险。</p><p id="6c78" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在EC2上，键入</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="0e38" class="nx mm it ol b gy op oq l or os">aws configure</span></pre><p id="64b1" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">AWS将提示您输入访问密钥和秘密访问密钥。将excel文件中的值放在那里。您可以在默认区域名称和默认输出上按enter键。</p><p id="06f6" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">AWS凭证现在设置在EC2上，因此您可以创建boto3会话。</p><h2 id="6ba0" class="nx mm it bd mn ny nz dn mr oa ob dp mv lp oc od mx lt oe of mz lx og oh nb oi bi translated">配置气流</h2><p id="4393" class="pw-post-body-paragraph lg lh it li b lj nd ju ll lm ne jx lo lp nf lr ls lt ng lv lw lx nh lz ma mb im bi translated">首先，添加环境变量。因为我们有一个脚本，您可以简单地调用以下命令。</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="bbcd" class="nx mm it ol b gy op oq l or os">source add_airflow_env_variables.sh<br/>bash add_airflow_env_variables.sh</span></pre><p id="8098" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果您想检查是否添加了环境变量AIRFLOW_HOME，请在命令行中运行<code class="fe pa pb pc ol b">env</code>。</p><p id="57f6" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">下一步是创建用于存储dag运行的气流数据库。如果这是您第一次创建airflow数据库，请在AIRFLOW_HOME路径中运行下面的命令。</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="9cfa" class="nx mm it ol b gy op oq l or os">airflow db init</span></pre><p id="1d90" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您还需要添加一个用户，因为airflow会提示用户登录。以下命令摘自<a class="ae ky" href="https://airflow.apache.org/docs/apache-airflow/stable/start/local.html" rel="noopener ugc nofollow" target="_blank">本地运行气流文档</a>中的示例。</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="98e1" class="nx mm it ol b gy op oq l or os">airflow users create \<br/>    --username admin \<br/>    --firstname Peter \<br/>    --lastname Parker \<br/>    --role Admin \<br/>    --email spiderman@superhero.org</span></pre><p id="7842" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">它会提示您输入自己选择的密码。</p><p id="e87d" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，使用以下命令安装requirements.txt中的所有包</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="a463" class="nx mm it ol b gy op oq l or os">pip3 install -r requirements.txt</span></pre><p id="a273" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">最后，运行以下命令来启动daemon中的airflow webserver和调度程序。</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="7f37" class="nx mm it ol b gy op oq l or os">bash start_airflow.sh</span></pre><p id="4fc6" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这将运行气流调度和网络服务器没有任何问题。要检查UI是否工作，请导航到此url。</p><p id="8123" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">http://ec2–11–111–111–11 . us-east-1 . compute . Amazon AWS . com:8080</strong></p><p id="b6d7" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">ec2–11–111–111–11.us-east-1.compute.amazonaws.com是一个虚构的Ec2公共IPv4地址。您应该能够在EC2 -&gt; Instances控制台上的Details选项卡中为您的EC2实例获取它。确保您使用<strong class="li iu"> http </strong>(不是https)和端口8080(如果您设置气流使用该端口，否则使用您配置的任何端口)。</p><p id="98e3" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您应该会看到一个登录页面弹出。输入用于在Airflow中创建用户帐户的用户凭据(用户名:admin，密码:您键入的任何内容)。现在，您应该可以看到列出的所有气流DAG，包括我们之前创建的stock_data DAG。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pe"><img src="../Images/11d395d49d8937f94eb020cdb56cde09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cTbCpiYyhQO6Oxf15xkqEQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">气流中所有Dag的列表，启用了stock_data。</p></figure><p id="37d6" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">单击股票数据dag。然后，您可以在图形视图中看到这个dag的UI。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/ec665c790d6dd325ad38ec2d09357856.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hKIQF9n4xsIplPNwZRFgHA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">股票数据的DAG视图</p></figure><p id="4497" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在类型的右上角(在“时间表”下)，您会看到一个“播放”按钮。点击该按钮手动触发DAG。如果一切正常，您应该会看到所有操作员都成功通过绿色认证。如果有错误(失败，等待重试)，单击操作符检查日志。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/690a70d6fb71048e5f209ecda8bfe0cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IYTRFCYvHyYolmbPWc2zPg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">成功的DAG运行</p></figure><p id="a2f9" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，让我们导航到S3桶<code class="fe pa pb pc ol b">stock-model</code>，看看我们的模型是否已经被添加。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/f95439e6407b809cd284f72a8960b838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nLzUQqAXQATmeBY5gcZhhw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">添加了模型的库存模型桶</p></figure><p id="d770" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果让EC2整夜运行，并且气流调度程序和web服务器不中断，您将看到这两个模型最后一次修改是在7月23日下午5:00 UTC-05:00左右。</p><p id="1944" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">注意:确保完成后终止EC2</strong></p><h1 id="c9ca" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">结论</h1><p id="a70f" class="pw-post-body-paragraph lg lh it li b lj nd ju ll lm ne jx lo lp nf lr ls lt ng lv lw lx nh lz ma mb im bi translated">本教程解释了如何使用工作流工具构建持续学习架构，以在当前和新的训练数据上重建ARIMA模型。我们学习了如何利用气流来创建这种持续学习架构，以预测两种不同股票的收盘价:Nautilus和Fastly。我们学习了如何在亚马逊EC2上部署气流，并在S3上存储新建立的模型。</p><p id="a649" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">持续学习不需要从头开始创建循环神经网络。这是通过使用流行的数据工程工具来创建持续学习模型的一种更简单的替代方法。仍在学习错综复杂的神经网络的入门级数据科学家可以依靠这一解决方案来创建一个健壮、可持续的架构，用于模型“学习”更新的数据。此外，这种架构可以在各种不同的算法上复制:时间序列、线性回归和分类算法。虽然读取和训练数据模型的逻辑需要改变，但总体架构应该适应各种业务问题。</p><p id="b1d0" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">Github Repo:</strong>【github.com】Data-Science-Projects/Medium/air flow _ CL/air flow at master hd2zm/Data-Science-Projects(T3】</p><p id="4968" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">参考文献:</strong></p><p id="3fab" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">1.Matthew Kish 鹦鹉螺公司报告称，由于疫情推动了家庭锻炼趋势，销售额增长了94%</p><p id="8ca4" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">2.<a class="ae ky" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Airflow —开源工作流管理工具</a></p><p id="bde0" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">3.<a class="ae ky" href="https://pytorch.org/" rel="noopener ugc nofollow" target="_blank"> PyTorch —开源机器学习框架</a></p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="9949" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">感谢阅读！如果你想阅读更多我的作品，请查看我的目录。</p><p id="7d47" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果你不是一个中等收入的会员，但对订阅《走向数据科学》感兴趣，只是为了阅读类似的教程和文章，<a class="ae ky" href="https://hd2zm.medium.com/membership" rel="noopener">单击此处</a>注册成为会员。注册这个链接意味着我可以通过向你推荐Medium来获得报酬。</p></div></div>    
</body>
</html>