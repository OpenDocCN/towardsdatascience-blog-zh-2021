<html>
<head>
<title>Deploy an Object-Detector Model at the Edge on AWS Panorama</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 AWS Panorama 的边缘部署对象检测器模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploy-an-object-detector-model-at-the-edge-on-aws-panorama-9b80ea1dd03a?source=collection_archive---------6-----------------------#2021-11-26">https://towardsdatascience.com/deploy-an-object-detector-model-at-the-edge-on-aws-panorama-9b80ea1dd03a?source=collection_archive---------6-----------------------#2021-11-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="1432" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/making-sense-of-big-data" rel="noopener" target="_blank">理解大数据</a>，AWS PANORAMA 模型部署分步指南</h2><div class=""/><div class=""><h2 id="f6f8" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">了解如何在 AWS Panorama 上部署最先进的计算机视觉模型，这是一种功能强大的边缘设备，可实现在线和经济高效的对象检测。</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/a15d798ab943b6326e7294b845f34f2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WO3r6HtVpByf2oKk"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@v2osk?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> v2osk </a>在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="6e96" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><em class="mb">本文由</em> <a class="ae le" href="https://medium.com/@janos.tolgyesi" rel="noopener"> <em class="mb">雅诺斯·托尔斯泰</em> </a> <em class="mb">和</em> <a class="ae le" href="https://medium.com/@aletheia" rel="noopener"> <em class="mb">卢卡·比安奇</em> </a> <em class="mb">共同撰写。</em></p><p id="b2aa" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">近年来，计算机视觉已经成为深度学习最令人兴奋的应用领域之一:经过训练的卷积神经网络(CNN)模型可以达到类似人类的精度水平，在图像或视频流中检测对象。这些令人难以置信的进步开辟了广泛的应用领域，从零售客户行为分析到安全和工业质量保证。</p><p id="cd2f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在这个场景中，出现了几个不同的深度学习模型来解决计算机视觉的一个常见用例:对象检测。这本身就是一个理想的结果，也是诸如目标跟踪、姿态估计和环境监控等广泛应用的普遍基础。</p><p id="c0b5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">此外，当摄像机产生输入图像时，现代计算机视觉能力提高了应用于安全和监控的对象检测深度学习模型的可实现性。然而，由于实时应用的短响应时间要求，这样的场景是非常具有挑战性的。警报应该在检测到危险的几秒钟内发出；否则就没用，甚至有害。</p><p id="e806" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">延迟在定义对可用计算类型的限制方面起着重要作用。由于有限的带宽和不可靠的网络，将大量视频流传输到云，通过在云实例上运行的快速准确的深度学习模型来处理视频通常不可行或成本过高。视频分析经常需要高配置计算能力，这种需求削弱了按需或类似无服务器的自动扩展基础设施的优势。此外，带宽从来都不划算，这使得这种解决方案在大多数使用情况下都是负担不起的。</p><p id="27d6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">边缘计算成为实现更好延迟和降低总系统成本的理想解决方案，打开了一个全新的市场。不幸的是，对于大多数数据科学家来说，用 GPU 构建可靠且不昂贵的硬件来运行计算机视觉模型并不是一件容易的事情。考虑到一些用例管理的视频流可能包含人们视频镜头的敏感信息，安全要求使得这项任务更加困难。</p><h1 id="a925" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">进入 AWS 全景</h1><p id="e3f3" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">在亚马逊 re:Invent 的 2020 虚拟版中，亚马逊网络服务的前首席执行官 Andy Jassy <a class="ae le" href="https://aws.amazon.com/about-aws/whats-new/2020/12/introducing-aws-panorama-for-computer-vision-at-the-edge/" rel="noopener ugc nofollow" target="_blank">展示了一款名为 AWS Panorama 的新设备</a>，完全是为边缘计算而设计的。Nvidia Jetson Xavier 图形处理单元采用紧凑设计和 IP5 外壳的小型封装，可以分析多达 16 个并发视频流。该设备的外观和设置在 AWS 机器学习英雄迈克·钱伯斯的<a class="ae le" href="https://www.youtube.com/watch?v=xRxAWClUTZc" rel="noopener ugc nofollow" target="_blank">惊人视频</a>中有更详细的介绍。</p><p id="3264" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">简单的初始配置和配置体验使 Panorama 适合非技术用户安装。</p><h1 id="d9c3" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">发展理念</h1><p id="1511" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">在引擎盖下，AWS Panorama 不仅部署了深度学习模型，还要求开发人员定义一个<em class="mb"> Panorama 应用</em>。一个<em class="mb"> Panorama 应用</em>是打包的深度学习模型、业务逻辑代码和清单结构(应用图)的集合，清单结构定义了这些组件之间的数据管道。</p><p id="9e7d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">应用程序组件被称为<em class="mb">节点</em>。设备上的每个资源都由一个<em class="mb">节点</em>表示:深度学习模型、业务逻辑代码、摄像头流，甚至显示输出和参数。每个<em class="mb">节点</em>有一个或多个<em class="mb">接口</em>，定义其<em class="mb">输入</em>和<em class="mb">输出</em>。在部署之前，模型和代码类型的节点资源被归档到二进制<em class="mb">资产</em>中。<em class="mb">资产</em>连同<em class="mb">清单文件</em> ( <code class="fe mz na nb nc b">package.json</code>)被称为<em class="mb">包</em>。包的<em class="mb">清单文件</em>包含了关于其<em class="mb">资产</em>的所有信息，并定义了在<em class="mb">应用程序图</em>中使用的<em class="mb">接口</em>。可以在<em class="mb">包描述符</em>中提供额外的特定于节点的细节，例如，深度学习模型的输入张量的维度或应用可执行入口点。<em class="mb">包</em>被上传到由 AWS Panorama 服务管理的 S3 接入点，并向该服务注册。</p><p id="5279" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">当开发人员使用 AWS Panorama 服务部署应用程序时，应提供一个<em class="mb">应用程序清单</em>文件(<code class="fe mz na nb nc b">graph.json</code>)，将应用程序定义为由节点和边构建的图形。在部署时，Panorama 服务在<em class="mb">清单文件</em>中找到按名称引用的已注册<em class="mb">包</em>，并将它们下载到 Panorama 设备。</p><p id="9703" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">总而言之:</p><ul class=""><li id="077c" class="nd ne iq lh b li lj ll lm lo nf ls ng lw nh ma ni nj nk nl bi translated">一个<em class="mb">全景应用</em>是连接的<em class="mb">节点</em>的集合。连接由<em class="mb">应用清单</em>(或<em class="mb">应用图</em>)描述。</li><li id="d720" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated"><em class="mb">节点</em>可以有以下<em class="mb">类型</em>:深度学习模型、应用源代码、摄像头输入、显示输出、部署时参数。</li><li id="1a17" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated"><em class="mb">节点</em>也定义了它们的<em class="mb">接口</em>。一个<em class="mb">接口</em>是<em class="mb">输入</em>和<em class="mb">输出端口</em>的列表。<em class="mb">端口</em>是命名和键入的数据字段。支持数字、布尔、字符串和“媒体”类型。</li><li id="f3e5" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">应用代码和 ML 模型被归档到<em class="mb">资产</em>中。<em class="mb">资产、</em>及其清单文件被称为<em class="mb">包</em>。Panorama 服务会上传和注册包。</li><li id="465c" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">在部署时，用户应该指定<em class="mb">应用程序图</em>。Panorama 服务在图中查找与单个<em class="mb">节点</em>相关联的<em class="mb">包</em>，并将所需的包下载到设备。</li></ul><p id="4171" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">有关更多信息，请参考<a class="ae le" href="https://docs.aws.amazon.com/panorama/latest/dev/" rel="noopener ugc nofollow" target="_blank"> AWS Panorama 开发人员指南</a>。</p><h1 id="8152" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">为目标检测选择最先进的计算机视觉模型</h1><p id="36c3" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">你只看一次(YOLO)用于实时物体检测的深度学习模型在 CVPR 2016 上<a class="ae le" href="https://arxiv.org/pdf/1506.02640v5.pdf" rel="noopener ugc nofollow" target="_blank">亮相。从那时起，它就成了这类任务的标准基准。它提供了实时推理性能、通用对象表示理解(提高了以前从未见过的图像的准确性)以及沿模型大小/准确性轴的缩放。与早期基于区域的卷积神经网络(R-CNN)相比，YOLO 模型只需一步就能处理图像。在接下来的几年中，这些模型有了显著的改进，引入了广泛的增强功能，从 YoloV2、YoloV3、YoloV4 到 YoloV5。</a></p><p id="cb99" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">YOLO 模型可以检测对象并识别它们在图像中的位置，绘制包围它们的边界框。在早期的实现中，模型使用一系列预定义的边界框，称为锚点，并预测它们在图像中的偏移。这种方法需要指定在给定图像区域内要检测的锚的数量，这在一些使用情况下是有限制的。</p><p id="bdea" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">2021 年，随着<a class="ae le" href="https://arxiv.org/abs/2107.08430" rel="noopener ugc nofollow" target="_blank"> YOLOX </a>的崛起，该模型得到了进一步改进，采用了无锚方法。YOLOX 在 PyTorch 中实现，COCO 数据集上的预训练模型在 GitHub 上发布<a class="ae le" href="https://github.com/Megvii-BaseDetection/YOLOX" rel="noopener ugc nofollow" target="_blank">。</a><a class="ae le" href="https://cocodataset.org/" rel="noopener ugc nofollow" target="_blank"> COCO 数据集</a>包含<a class="ae le" href="https://tech.amikelive.com/node-718/what-object-categories-labels-are-in-coco-dataset/" rel="noopener ugc nofollow" target="_blank"> 80 个不同的对象类别</a>，包括人、车辆、一些动物、运动设备和日常物品，因此预先训练的模型已经准备好检测这些开箱即用的对象。</p><h1 id="6c0b" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">创建 Panorama 应用程序</h1><h2 id="1fda" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">先决条件</h2><p id="4226" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">要遵循此分步指南，需要一个 AWS 帐户和一个 AWS Panorama 设备。应将 Panorama 设备调配到帐户中(请参考上面 Mike 的教程了解这些步骤)。</p><p id="4bd9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">测试解决方案还需要 RTSP 流，Panorama 设备应该能够从其连接的网络访问它。该流可以由大多数 IP 摄像机或运行 RTSP 服务器的计算机提供。</p><p id="95c1" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">部署步骤将使用 AWS 命令行界面(CLI)和 Panorama (CLI)执行，从<a class="ae le" href="https://docs.aws.amazon.com/panorama/latest/dev/gettingstarted-deploy.html" rel="noopener ugc nofollow" target="_blank"> AWS Panorama 开发人员指南</a>中提供的示例应用程序开始。确保工作站上安装并配置了 AWS CLI、Panorama CLI 和 Docker。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oc"><img src="../Images/cacaf33731e34beeb5da889d168bf8d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xWQSeGGvxU_vTOUfP1zh6g.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">全景示例应用程序。图来自<a class="ae le" href="https://github.com/awsdocs/aws-panorama-developer-guide/blob/main/docs-source/gettingstarted-sample.md" rel="noopener ugc nofollow" target="_blank"> AWS 全景开发者指南</a> (CC BY-SA 4.0)。</p></figure><p id="eb1b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">本教程还附带了一个<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial" rel="noopener ugc nofollow" target="_blank"> GitHub 库</a>，在这里你可以一个提交一个提交地跟踪项目的进展，如果你遇到困难，可以把它作为参考。我们将在每个步骤后提供一个带有书签图标的相关提交的链接:🔖。</p><h2 id="e6d7" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">Panorama 应用程序的包</h2><p id="d135" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">首先，使用 AWS Panorama CLI 的<code class="fe mz na nb nc b">init-project</code>命令初始化一个项目:</p><pre class="kp kq kr ks gt od nc oe of aw og bi"><span id="0c2e" class="nr md iq nc b gy oh oi l oj ok">$ panorama-cli init-project --name yolox-panorama</span></pre><p id="5040" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">该命令将生成一个空的项目模板。它只是一个脚手架，上面有名为<code class="fe mz na nb nc b">assets</code>和<code class="fe mz na nb nc b">packages</code>的空文件夹，以及<code class="fe mz na nb nc b">graphs/yolox-panorama/graph.json</code>中的一个 JSON 文件。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/88ba525" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p><p id="cfa0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">要部署 Panorama 应用程序，必须至少定义以下节点:</p><ul class=""><li id="75da" class="nd ne iq lh b li lj ll lm lo nf ls ng lw nh ma ni nj nk nl bi translated">摄像机输入，</li><li id="8c5a" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">模型(将包裹 YOLOX)，</li><li id="d732" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">应用程序代码(业务逻辑)，以及</li><li id="755d" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">显示输出(HDMI，用于调试)。</li></ul><p id="dbf6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">AWS Panorama 定义了一个特殊的概念，即“抽象节点”，因为在应用程序开发期间，确切的 RTSP URI 是未知的，因为它取决于源摄像机流。</p><p id="ad1c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这种抽象允许相同的应用程序被发布到不同的设备，处理不同的流(使用不同的 RTSP URIs)。Panorama SDK 提供了一个“抽象摄像机”，这是一个摄像机的占位符节点，其连接 URI 将在部署时定义。</p><p id="641d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">抽象摄像机节点是使用</p><pre class="kp kq kr ks gt od nc oe of aw og bi"><span id="f929" class="nr md iq nc b gy oh oi l oj ok">add-panorama-package --type camera</span></pre><p id="6837" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">Panorama CLI 的命令。为相机定义抽象节点不是强制性的:可以使用命令添加特定的 RTPS 相机流</p><pre class="kp kq kr ks gt od nc oe of aw og bi"><span id="c744" class="nr md iq nc b gy oh oi l oj ok">create-package --type camera</span></pre><p id="2dfe" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">然后在生成的文件<code class="fe mz na nb nc b">packages/${AWS_ACCOUNT_ID}-[camera_name]-1.0/package.json</code>的“接口”字段中提供摄像机 RTSP·URI、用户名和密码。</p><p id="c7d4" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">AWS Panorama 还提供了另一种类型的抽象节点来映射 HDMI 显示输出。使用该媒体接收器，可以在连接到 Panorama 设备的 HDMI 监视器上显示带注释的视频。需要考虑的一点是，该显示用于调试目的，一次只有一个应用程序可以使用它，即使用这种资源部署的第一个应用程序。</p><p id="8b3d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">将到目前为止的所有命令包装在一起，通过以下方式实现配置:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">向 Panorama 应用程序添加包。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/415ebae" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点🔖</a></p></figure><h2 id="0435" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">关于 AWS 帐户 id 的说明</h2><p id="331c" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">每个 Panorama 项目都在许多项目工件中使用所有者的 AWS 帐户 ID。它用于文件夹名称以及多个 JSON 配置文件中。帐户 ID 通常被认为是一条不希望公开的敏感信息。在本教程中，在命令行示例中，帐户 ID 被替换为<code class="fe mz na nb nc b">${AWS_ACCOUNT_ID}</code>。这个表达式引用了一个变量，这个变量可以用真正的 AWS 帐户 ID 初始化，这样 shell 就会自动替换它。在 JSON 代码片段中，我们将使用虚拟帐户 ID <code class="fe mz na nb nc b">123456789012</code>,应该总是用实际的 AWS 帐户 ID 手动替换。</p><h2 id="777d" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">定义应用程序的节点</h2><p id="02fd" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">AWS Panorama CLI 不会在<em class="mb">应用程序图</em>中为业务逻辑和深度学习模型创建节点，因此开发人员必须手动添加它们。</p><p id="1100" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这可以通过打开<code class="fe mz na nb nc b">graphs/yolox-panorama/graph.json</code>并在<code class="fe mz na nb nc b">nodeGraph.nodes</code>数组中添加以下对象来完成:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">代码和模型节点。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/20ce1c8" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p></figure><p id="eef9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><em class="mb">参数</em>可以添加到 Panorama 应用程序中，它们的值将在部署时指定。应用程序逻辑可以在运行时访问这些参数的值。参数有一系列用途:定义与模型相关的参数(例如，检测阈值)或应用程序设置(例如，S3 存储桶名称)。AWS Panorama 支持以下参数类型:<code class="fe mz na nb nc b">int32</code>、<code class="fe mz na nb nc b">float32</code>、<code class="fe mz na nb nc b">boolean</code>和<code class="fe mz na nb nc b">string</code>。</p><p id="0374" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在该部署中，单个<code class="fe mz na nb nc b">float32</code>参数代表物体检测器的置信度阈值。低于该阈值的检测置信水平使得相关对象被丢弃。<em class="mb">参数</em>需要手动添加到<em class="mb">应用图</em>中作为参数型<em class="mb">节点</em>。可以指定默认值和覆盖配置，以及在部署时向用户显示的可读文本。将以下对象添加到<code class="fe mz na nb nc b">nodes</code>数组中:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">参数类型节点。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/9890f9d" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p></figure><p id="671a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">关于此处参数的更多信息可在 Panorama 开发者指南的<a class="ae le" href="https://docs.aws.amazon.com/panorama/latest/dev/applications-manifest.html#applications-manifest-parameters" rel="noopener ugc nofollow" target="_blank">相关章节</a>中找到。</p><h2 id="4151" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">建立计算机视觉管道</h2><p id="c782" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">每个<em class="mb">节点</em>在<em class="mb">应用</em>中扮演一个特定的角色:一些节点发出信息(<code class="fe mz na nb nc b">camera_node</code>、<code class="fe mz na nb nc b">detection_threshold</code>，另一些节点消费数据(<code class="fe mz na nb nc b">display_node</code>，还有一些节点发出并消费数据，如<code class="fe mz na nb nc b">code_node</code>和<code class="fe mz na nb nc b">model_node</code>。</p><p id="92c1" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">边缘引导流经应用程序的信息，将一个<em class="mb">节点</em>的<em class="mb">输出端口</em>连接到下一个节点的<em class="mb">输入端口</em>。<em class="mb">输入</em>和<em class="mb">输出端口</em>有特定的类型，只有兼容的类型才能连接。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi on"><img src="../Images/b65694140ae2b9880ca49c2902246eb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oO3ZS8WBzWtJjfIonrdDrw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">正在开发的应用程序的组件图。来源:作者本人作品。</p></figure><p id="b54e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">检测阈值参数和摄像机节点链接到代码节点。然后，代码节点的输出被链接到显示节点。模型节点没有连接到图中的其他节点，因为应用程序逻辑处理去往/来自模型的信息流。我们将在后面看到如何在预处理后将输入数据发送到模型，并从模型中读出推理结果进行后处理。</p><p id="4bfa" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">节点通过<code class="fe mz na nb nc b">graphs/yolox-panorama/graph.json</code>中的边连接:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">应用程序图的边。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/6906b83" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p></figure><h2 id="d624" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">添加机器学习模型神器</h2><p id="d1f4" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">YOLOX 模型必须转换为 TorchScript，这是 AWS Panorama 支持的格式之一。完整的工作流程在<em class="mb">yolox-torch script</em><a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/blob/main/yolox-torchscript.ipynb" rel="noopener ugc nofollow" target="_blank">Jupyter 笔记本</a>中有概述。</p><p id="03f7" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">一个重要的方面是记住导出模型的预期输入形状，这在稍后编写推理代码时是需要的。对于图像处理模型，输入形状的格式为<code class="fe mz na nb nc b">[batch_size, channel_size, width, height]</code>。这里的<code class="fe mz na nb nc b">batch_size</code>是<code class="fe mz na nb nc b">1</code>，<code class="fe mz na nb nc b">channel_size</code>等于<code class="fe mz na nb nc b">3</code>(红、绿、蓝)，型号规格定义<code class="fe mz na nb nc b">width</code>和<code class="fe mz na nb nc b">height</code>。对于<em class="mb"> yolox-s </em>型号，输入形状为<code class="fe mz na nb nc b">[1, 3, 640, 640]</code>。</p><p id="d5a6" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在 Jupyter 笔记本的最后几个步骤中，TorchScript 模型被保存为一个<code class="fe mz na nb nc b">.tar.gz</code>包。这个档案将用于创建模型节点的<em class="mb">包</em>。</p><p id="a613" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">Panorama CLI 将归档添加为项目<em class="mb">资产</em>，采用<code class="fe mz na nb nc b">--model-local-path</code>参数中<code class="fe mz na nb nc b">.tar.gz</code>文件的路径。在发出任何这些命令之前，重要的是导出本地 AWS 帐户 ID，以具有可重复和可移植的步骤。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">向 Panorama 应用程序添加模型。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/6b3c522" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p></figure><p id="67fa" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">结果是一个新的<em class="mb">节点</em>在<code class="fe mz na nb nc b">graph.json</code>中，命名为<code class="fe mz na nb nc b">yolox_s_asset</code>，它应该被合并到已经创建的<code class="fe mz na nb nc b">model_node</code>中。编辑<code class="fe mz na nb nc b">nodes</code>列表，使得只有一个节点保留该内容:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">合并的模型节点</p></figure><p id="a678" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><code class="fe mz na nb nc b">interface</code>字段是指<code class="fe mz na nb nc b">yolox_s</code> <em class="mb">包</em>中的<code class="fe mz na nb nc b">interface</code>属性。Panorama CLI 创建的接口名称可以更改为更合适的名称，只需将<code class="fe mz na nb nc b">name</code>属性编辑为<code class="fe mz na nb nc b">packages/${AWS_ACCOUNT_ID}-yolox_s-1.0/package.json</code>内<code class="fe mz na nb nc b">nodePackage.interfaces</code>数组中的“interface”。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">修正了模型界面。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/761d34c" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p></figure><p id="ba96" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><code class="fe mz na nb nc b">packages/${AWS_ACCOUNT_ID}-yolox_s-1.0/descriptor.json</code>处的模型描述符应该包含关于您的模型的额外的必需元数据。编辑这个文件并添加框架名<code class="fe mz na nb nc b">PYTORCH</code>和输入名称和形状。模型描述符的最终版本应该如下所示:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">模型描述符。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/f380ee4" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p></figure><h2 id="b2cb" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">实现计算机视觉管道</h2><p id="0d40" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">部署在 AWS Panorama 上的计算机视觉应用程序应至少实现以下功能:</p><ul class=""><li id="c7af" class="nd ne iq lh b li lj ll lm lo nf ls ng lw nh ma ni nj nk nl bi translated">连续查询视频流中的最后一帧，</li><li id="6ae4" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">预处理该帧并将其转换成与深度学习模型的输入具有相同形状的 NumPy 数组，</li><li id="1830" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">将预处理后的帧传递给模型(它已经被模型节点初始化了)，</li><li id="1701" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">读取推理结果并最终对其进行后处理，</li><li id="6218" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">用推理结果边界框注释该帧，</li><li id="a02c" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">将带注释的帧发送到下游显示节点。</li></ul><p id="7a69" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">除了这些基本的视频管道处理步骤，一个模型通常实现一些业务逻辑，例如:</p><ul class=""><li id="53fe" class="nd ne iq lh b li lj ll lm lo nf ls ng lw nh ma ni nj nk nl bi translated">计算人数并测量他们之间的距离，</li><li id="f62e" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">如果某些条件得到验证，例如，这些人不遵守社交距离规则，</li><li id="136d" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">使用消息协议(例如 MQTT 或 AWS SNS)将这些警报发送给相关方，</li><li id="9d60" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">生成业务指标并持久化它们(例如，在 CloudWatch 中或通过 Amazon Kinesis Data Firehose 在 S3 桶中),以便以后用于分析目的。</li><li id="6ea8" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">通常，与下游业务应用程序集成，或者</li><li id="6bd7" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated">拍摄一个有趣的帧的“截图”,并将其上传到数据存储服务。</li></ul><p id="5d05" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在本教程中，我们只实现媒体管道，不特别强调业务逻辑。主要重点是在 HDMI 监视器上显示视频流，然后集成 YOLOX 对象检测器模型。</p><h2 id="3019" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">使用开放容器图像格式构建全景应用程序</h2><p id="c92c" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">AWS Panorama 使用开放容器图像(OCI)格式，为在设备上运行的应用程序提供上下文。一个最小的 docker 文件，与 OpenCV 和 NumPy 捆绑在一起，分别处理 Python 中的图像和数组，可以从 Panorama CLI 在<code class="fe mz na nb nc b">packages/${AWS_ACCOUNT_ID}-application_logic-1.0/Dockerfile</code>中创建的存根文件中创建。</p><p id="ba02" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">生成的文件应该类似于:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">应用程序节点的 Dockerfile。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/536eda1" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p></figure><p id="cade" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">上面的 Dockerfile 文件执行以下步骤:</p><ol class=""><li id="e709" class="nd ne iq lh b li lj ll lm lo nf ls ng lw nh ma oo nj nk nl bi translated">建立在<code class="fe mz na nb nc b">panorama-application</code>基础图像之上(这是所有 Panorama 应用程序必须具备的)。这个基础映像包含 Panorama SDK，它是与其他节点通信的基础设施。</li><li id="3b08" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma oo nj nk nl bi translated">更新 pip 并安装 OpenCV 和 NumPy。</li><li id="85a4" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma oo nj nk nl bi translated">将主机的<code class="fe mz na nb nc b">src</code>文件夹中的内容复制到容器的<code class="fe mz na nb nc b">/panorama</code>文件夹中。</li></ol><p id="c325" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">其他所需的依赖项也可以安装在同一个 Other 文件中。</p><h2 id="451a" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">定义应用程序节点的接口</h2><p id="fb85" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">在编写用于推理的应用程序代码之前，要做的第一步是定义代码<em class="mb">节点</em> <em class="mb"> : </em>的<em class="mb">接口</em>一个构造，它列出了<em class="mb">输入</em>和<em class="mb">输出端口</em>，提供了与其他节点通信的方法。接口在<code class="fe mz na nb nc b">packages/${AWS_ACCOUNT_ID}-application_logic-1.0/package.json</code>中定义。将这些对象添加到<code class="fe mz na nb nc b">nodePackage.interfaces</code>数组中:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">应用程序节点的接口。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/cb7fae9" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p></figure><p id="ee64" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">这定义了媒体流的<code class="fe mz na nb nc b">video_in</code>输入，作为<code class="fe mz na nb nc b">float32</code>参数的<code class="fe mz na nb nc b">threshold</code>输入，以及下游媒体消费者的<code class="fe mz na nb nc b">video_out</code>输出。关于这些输入和输出如何与其他节点连接，请参考<code class="fe mz na nb nc b">graph.json</code>的边缘部分。</p><h2 id="47ed" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">日志记录设置</h2><p id="04a9" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">由于无法直接在 Panorama 设备上调试应用程序逻辑，因此需要使用诊断日志消息来实现应用程序的可观察性。对 Panorama 上运行的容器的标准输出的访问被禁用，这意味着将消息打印到 stdout 或使用 Python logger 的简单配置将不起作用。日志需要与 Panorama SDK 的日志基础设施集成。</p><p id="0904" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">Panorama 守护进程监视设备上运行的容器的<code class="fe mz na nb nc b">/opt/aws/panorama/logs</code>文件夹:写入该文件夹的任何文本文件都将被增量发送到 AWS CloudWatch 日志。这意味着向该文件夹中的文件添加日志条目会将新行直接推送到云中。</p><p id="4a65" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">通过以下方式实现此目的的标准 Python 记录器配置:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">配置记录器</p></figure><h2 id="4c54" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">创建应用程序存根</h2><p id="4643" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">可以在一个名为<br/> <code class="fe mz na nb nc b">packages/${AWS_ACCOUNT_ID}-application_logic-1.0/src/application.py</code>的新文件中创建一个应用程序的存根，其内容如下:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">Panorama 应用程序存根</p></figure><p id="2e4d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><code class="fe mz na nb nc b">Application</code>类的初始化器将记录器保存为实例属性，并初始化<code class="fe mz na nb nc b">threshold</code>属性，稍后将使用节点参数值填充该属性。实际上，没有办法从模型节点本身检索模型的名称和预期的输入大小。由于这个原因，在这个例子中它们被硬编码。</p><p id="b05e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">然后，<code class="fe mz na nb nc b">init</code>函数读取节点参数值。代码节点的输入在节点<em class="mb">接口</em>中定义，可通过<code class="fe mz na nb nc b">self.inputs</code>属性访问。输入的名称来自代码节点<em class="mb">接口</em>定义。这里，threshold 参数的值被读取并保存为实例属性。</p><p id="8112" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">每当有一个以上的摄像机连接到应用程序时，<code class="fe mz na nb nc b">process_streams</code>方法就会遍历所有的输入流，并为每一个输入流调用<code class="fe mz na nb nc b">process_media</code>。最后，它将修改后的(带注释的)媒体流发送到<code class="fe mz na nb nc b">video_out</code>输出，由下游节点处理，这里是 HDMI 显示。</p><p id="1401" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><code class="fe mz na nb nc b">process_media</code>方法计算每个流的每一帧。它将帧传递给<code class="fe mz na nb nc b">preprocessor</code>方法，用预处理后的帧调用模型节点，最后对推理结果进行后处理。</p><p id="aca5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><code class="fe mz na nb nc b">preprocess</code>和<code class="fe mz na nb nc b">postprocess</code>核心函数在这里就不赘述了。</p><p id="8d4a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">最后，应该启动主应用程序循环，实现应用程序的入口点。在<code class="fe mz na nb nc b">application.py</code>的末尾增加以下内容:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">主视频处理循环</p></figure><p id="8cf9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">关于应用程序执行的最后一件事是在应用程序的包描述符中指定处理容器的入口点脚本。打开<code class="fe mz na nb nc b">packages/${AWS_ACCOUNT_ID}-application_logic-1.0/descriptor.json</code>并修改如下:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">应用程序描述符。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/e8874f6" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p></figure><h2 id="ca89" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">构建应用程序框架</h2><p id="aa56" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">使用 Panorama CLI 工具可以轻松构建 docker 容器:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">构建应用程序容器。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/a3b7b55" rel="noopener ugc nofollow" target="_blank"> GitHub 检查点:🔖</a></p></figure><p id="475c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">运行此命令后，编辑<code class="fe mz na nb nc b">graphs/yolox-panorama/graph.json</code>的节点部分，删除除以下之外的所有<code class="fe mz na nb nc b">code_node</code>，并将接口名称更改为<code class="fe mz na nb nc b">interface</code>:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">在应用程序图中只留下一个有效的代码节点</p></figure><p id="5078" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">有时，Panorama CI 会在<code class="fe mz na nb nc b">packages/${AWS_ACCOUNT_ID}-application_logic-1.0/package.json</code>中添加第二个界面。应该只有一个，所以在删除多余的一个后，按如下方式更新另一个:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">修复应用程序节点的接口。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/4f51ea0" rel="noopener ugc nofollow" target="_blank"> GitHub 检查站:🔖</a></p></figure><h2 id="69bb" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">打包应用程序</h2><p id="4f32" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">AWS Panorama 设备从由 S3 接入点实施并由 AWS 维护的中央包存储库中下载应用包。必须使用以下命令将编译后的包上传到这个中央存储库:</p><pre class="kp kq kr ks gt od nc oe of aw og bi"><span id="7d50" class="nr md iq nc b gy oh oi l oj ok">panorama-cli package-application</span></pre><p id="4869" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">Panorama CLI 使用罩下的<a class="ae le" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>来部署应用程序的资产，这意味着它将使用默认配置的 AWS 区域。确保默认区域与配置 Panorama 设备的区域相同。</p><h2 id="8125" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">部署基本管道</h2><p id="9853" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">如<a class="ae le" href="https://docs.aws.amazon.com/panorama/latest/dev/gettingstarted-deploy.html" rel="noopener ugc nofollow" target="_blank"> Panorama 开发人员指南</a>中所述，可将应用程序部署到 Panorama 设备。因为应用程序不使用任何 AWS 服务，所以不需要为应用程序提供 IAM 角色。在部署阶段之后，应用控制 HDMI 显示器(只要它是部署到设备的唯一应用)。来自摄像机的 RTSP 视频流随即显示在屏幕上。对于这么多的工作来说，这显然不是一个很大的成就，但是它为进一步的开发设置了基线，并结束了部署的循环。</p><h1 id="5086" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated"><strong class="ak">将 YOLOX 物体探测器模型部署到 AWS 全景图</strong></h1><p id="0be6" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">YOLOX 模型要求输入帧以特定格式发送，并输出原始预测。这意味着必须对图像进行预处理和后处理。预处理包括将输入帧调整到正确的尺寸。后处理是对象检测的基本步骤，因为它将预测数组投影到边界框和检测到的对象类。这些预处理和后处理可以直接从<a class="ae le" href="https://github.com/Megvii-BaseDetection/YOLOX" rel="noopener ugc nofollow" target="_blank"> YOLOX 库</a>中选取，仔细检查 Docker 映像中的所有依赖项。</p><p id="78eb" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">最初的<em class="mb"> yolox-s </em> pytorch 模型有一个动态计算图，允许使用动态大小的输入，但这有一些推理时间性能缺点。AWS Panorama 要求模型采用优化的 TorchScript 格式，使用静态图形。</p><p id="8629" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">预处理就是将输入帧的大小调整为 640 x 640 像素的输入大小。调整大小是使用“适合+填充”策略实现的，该策略不会裁剪图像的任何部分，而是以图像的长边适合 640 x 640 正方形的方式来调整图像的大小。最后剩下的空白空间用灰色填充。该逻辑在 YOLOX 存储库中的<code class="fe mz na nb nc b"><a class="ae le" href="https://github.com/Megvii-BaseDetection/YOLOX/blob/dd5700c24693e1852b55ce0cb170342c19943d8b/yolox/data/data_augment.py" rel="noopener ugc nofollow" target="_blank">yolox/data/data_augment.py</a></code>脚本的<code class="fe mz na nb nc b"><a class="ae le" href="https://github.com/Megvii-BaseDetection/YOLOX/blob/dd5700c24693e1852b55ce0cb170342c19943d8b/yolox/data/data_augment.py#L144" rel="noopener ugc nofollow" target="_blank">preproc</a></code>函数中实现，应该添加到<code class="fe mz na nb nc b">packages/${AWS_ACCOUNT_ID}-application_logic-1.0/src/application.py</code>中:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">为 YOLOX 检测器预处理帧</p></figure><p id="28d8" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">该模型输出 8400 个被检测对象的边界框候选，并且单个检测可以具有多个候选。在后处理方法中使用<a class="ae le" rel="noopener" target="_blank" href="/non-maximum-suppression-nms-93ce178e177c">非最大抑制(NMS)算法</a>，可以找到最大概率包含实际物体的候选。YOLOX 存储库包含这个函数和一些其他的助手，可以添加到一个新创建的<code class="fe mz na nb nc b">packages/${AWS_ACCOUNT_ID}-application_logic-1.0/src/yolox_postprocess.py</code>文件中。将 YOLOX 库中的<code class="fe mz na nb nc b"><a class="ae le" href="https://github.com/Megvii-BaseDetection/YOLOX/blob/2c2dd1397ab090b553c6e6ecfca8184fe83800e1/yolox/utils/demo_utils.py" rel="noopener ugc nofollow" target="_blank">yolox/utils/demo_utils.py</a></code>中的以下函数添加到<code class="fe mz na nb nc b">yolox_postprocess.py </code>文件中:</p><ul class=""><li id="822b" class="nd ne iq lh b li lj ll lm lo nf ls ng lw nh ma ni nj nk nl bi translated"><code class="fe mz na nb nc b">demo_postproces</code></li><li id="0f10" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated"><code class="fe mz na nb nc b">nms</code></li><li id="023b" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated"><code class="fe mz na nb nc b">multiclass_nms</code></li><li id="a8fa" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated"><code class="fe mz na nb nc b">multiclass_nms_class_aware</code></li><li id="2e11" class="nd ne iq lh b li nm ll nn lo no ls np lw nq ma ni nj nk nl bi translated"><code class="fe mz na nb nc b">multiclass_nms_class_agnostic</code></li></ul><p id="f95c" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在导入 NMS 函数并将它们连接到<code class="fe mz na nb nc b">process_results</code>方法后，生成的<code class="fe mz na nb nc b">application.py</code>文件应该包含:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">后处理功能</p></figure><p id="84b9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">process_results 方法迭代模型的输出，并调用后处理器方法来提取检测的边界框。如 Panorama SDK 的<code class="fe mz na nb nc b">stream</code>类所预期的，这些框被缩放到<code class="fe mz na nb nc b">[0; 1]</code>间隔。然后为输出流的每个检测添加一个矩形。后处理方法(取自 YOLOX 库中的<code class="fe mz na nb nc b"><a class="ae le" href="https://github.com/Megvii-BaseDetection/YOLOX/blob/2c2dd1397ab090b553c6e6ecfca8184fe83800e1/demo/ONNXRuntime/onnx_inference.py#L73" rel="noopener ugc nofollow" target="_blank">demo/ONNXRuntime/onnx_inference.py</a></code>)将模型输出转换为非最大值抑制算法的预期格式。</p><p id="cd1e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">将<code class="fe mz na nb nc b">process_media</code>方法改为调用<code class="fe mz na nb nc b">process_results</code>而不是<code class="fe mz na nb nc b">preprocess</code>:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="ol om l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">最终的 process_media 方法。<a class="ae le" href="https://github.com/mrtj/yolox-panorama-tutorial/commit/b987471" rel="noopener ugc nofollow" target="_blank"> GitHub 检查站:🔖</a></p></figure><p id="deb0" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">现在，可以按照前面章节中描述的步骤构建应用程序并将其部署到 Panorama 设备。AWS Panorama 使用上述配置向 CloudWatch 控制台发送应用程序日志。可以发现过滤带有<code class="fe mz na nb nc b">/aws/panorama/devices/</code>日志前缀的日志。</p><h1 id="268b" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated"><strong class="ak">何去何从？</strong></h1><p id="7113" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">这篇文章只是触及了计算机视觉在 edge 上所能实现的表面，AWS Panorama 提供了一个很好的生产环境来实现这一点。本分步指南是关于如何部署最先进的对象检测模型的第一个示例，允许识别 COCO 数据集的 80 个不同对象类，并使用边界框定位它们，在 HDMI 显示器上显示带注释的视频流。</p><p id="bb1d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">从这里，可以使用自定义图像数据集训练自定义 YOLOX 模型，然后将其部署到 Panorama 应用程序以实现非常具体的分类。</p><p id="04c2" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">上述结果是为 Neosperience Cloud Services(以前的 Mikamai)和 Cogen 的联合项目开发的，旨在改进视频监控的 PeopleAnalytics 技术。这些结果可以进一步提高边缘设备的应用门槛。</p><p id="83af" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">在“开发者端”,可以添加许多业务逻辑来围绕模型构建完整的服务，因为有了适当的 IAM 角色，Panorama 设备中运行的应用程序可以直接访问 AWS 资源，如 S3 桶、MQTT 主题、SNS 通知或 CloudWatch 指标。</p></div><div class="ab cl op oq hu or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="ij ik il im in"><h2 id="aaf6" class="nr md iq bd me ns nt dn mi nu nv dp mm lo nw nx mo ls ny nz mq lw oa ob ms iw bi translated">关于作者</h2><p id="2915" class="pw-post-body-paragraph lf lg iq lh b li mu ka lk ll mv kd ln lo mw lq lr ls mx lu lv lw my ly lz ma ij bi translated">Janos Tolgyesi 是 Neosperience 的 AWS 社区构建者和机器学习解决方案架构师。他在 ML technologies 工作了五年，在 AWS infrastructure 工作了八年。他喜欢构建东西，让它成为边缘的<a class="ae le" href="https://www.neosperience.com/solutions/people-analytics/" rel="noopener ugc nofollow" target="_blank">视频分析应用</a>或基于点击流事件的<a class="ae le" href="https://www.neosperience.com/solutions/user-insight/" rel="noopener ugc nofollow" target="_blank">用户分析器</a>。你可以在<a class="ae le" href="https://twitter.com/jtolgyesi" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae le" href="https://medium.com/@janos.tolgyesi" rel="noopener"> Medium </a>和<a class="ae le" href="http://linkedin.com/in/janostolgyesi" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上找到我。</p><p id="8a09" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">卢卡·比安奇博士是 AWS 的英雄，也是 Neosperience 的首席技术官。他热爱无服务器和机器学习，负责 Neosperience 的研发。对技术、ML、计算机视觉有热情，可在<a class="ae le" href="https://twitter.com/bianchiluca" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae le" href="https://medium.com/@aletheia" rel="noopener"> Medium </a>、<a class="ae le" href="https://www.linkedin.com/in/lucabianchipavia/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系。</p><p id="d1f5" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">Neosperience 通过软件解决方案释放同理心的力量，这些解决方案利用人工智能使品牌能够理解、参与和发展他们的客户群。在<a class="ae le" href="http://www.neosperience.com" rel="noopener ugc nofollow" target="_blank">www.neosperience.com</a>伸出手。</p></div></div>    
</body>
</html>