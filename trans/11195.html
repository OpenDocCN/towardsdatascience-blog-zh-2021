<html>
<head>
<title>The Definitive Procedure for Aligning Two Sets of 3D Points with the Kabsch Algorithm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kabsch算法对齐两组3D点的明确过程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-definitive-procedure-for-aligning-two-sets-of-3d-points-with-the-kabsch-algorithm-a7ec2126c87e?source=collection_archive---------12-----------------------#2021-11-02">https://towardsdatascience.com/the-definitive-procedure-for-aligning-two-sets-of-3d-points-with-the-kabsch-algorithm-a7ec2126c87e?source=collection_archive---------12-----------------------#2021-11-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div class="gh gi ir"><img src="../Images/01681b4d78b80baa1da7f83e1211f662.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*KyihCcKEkpjd2Brmvyufjg.png"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">对齐空间中的点集。卢西亚诺·阿布利亚塔。</p></figure><h2 id="b3e1" class="jc jd je bd b dl jf jg jh ji jj jk dk jl translated" aria-label="kicker paragraph">使用JAVASCRIPT代码</h2><div class=""/><div class=""><h2 id="65db" class="pw-subtitle-paragraph kk jn je bd b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb dk translated">上周我纠结于通过低级代码对齐两组原子坐标的问题。最终成功后，我写了这篇简短的教程，其中包含了底层的JavaScript代码，如果你需要的话，可以帮你减轻痛苦。</h2></div><p id="8c38" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><a class="ae ly" href="https://en.wikipedia.org/wiki/Kabsch_algorithm" rel="noopener ugc nofollow" target="_blank"> Kabsch算法</a>是一种计算最佳平移和旋转的方法，可使两对点之间的均方根偏差(<a class="ae ly" href="https://en.wikipedia.org/wiki/Root_mean_square" rel="noopener ugc nofollow" target="_blank"> RMSD </a>)最小化。它在结构生物信息学、分子模拟、分子建模和结构生物学研究中被大量用于叠加分子对。事实上，它被广泛使用，以至于我所知道的所有分子图形程序和库都已经包含了这方面的内置命令，通常具有丰富的特性。</p><p id="2895" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">但是对于我们的moleculARweb的虚拟建模工具包，我们需要从头开始编写代码，在较低的级别，并且最好没有外部数学库。这意味着我们需要在尽可能最基本的层次上执行所有的数学运算，而不是像在其他环境中那样调用“align()”或“kabsch()”函数。网上搜索有很多解释和代码片段；它们看起来都很简单，但是它们都有缺失的部分，或者步骤过于简单，或者干脆跳过一些步骤。</p><p id="1028" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">一旦我们做好了，我认为最好贴一个权威性的教程，你可以在这里找到它和JavaScript代码(我们的web应用程序需要它)。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="4c93" class="mg mh je bd mi mj mk ml mm mn mo mp mq kt mr ku ms kw mt kx mu kz mv la mw mx bi translated">用简单的数学术语来描述这个过程</h1><p id="7a3b" class="pw-post-body-paragraph lc ld je le b lf my ko lh li mz kr lk ll na ln lo lp nb lr ls lt nc lv lw lx im bi translated">给定n个点的n×3矩阵P，其想要在3D空间中对准到参考矩阵Q(相同大小)上:</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi nd"><img src="../Images/d76b5613b7d28b6b82538551aade6bb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*Jk5Cd9h189tThziF3hamcg.png"/></div></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">用简单的方式陈述问题。下面的文本和代码描述了箭头的内容。卢西亚诺·阿布利亚塔。</p></figure><p id="bba4" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">主要步骤是:</p><p id="ee06" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo"> 1。</strong>将P居中于(0，0，0)，本质上是“从每个元素中减去整列的平均值”。那很简单。</p><p id="3a7f" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo"> 2。Q也是一样，保存你减去的三个平均值，因为你在最后会用到它们。</strong></p><p id="990e" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo"> 3。</strong>根据某种度量计算使P(以0为中心)尽可能接近Q(也以0为中心)的最佳旋转矩阵，然后对P进行旋转。在Kabsch的方法中，该度量包括最小化Q和旋转后的P之间的RMSD</p><p id="e2b6" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo"> 4。</strong>将旋转后的P偏移到原始Q所在的空间区域，只需添加第2步中保存的x、y和z的平均值即可。也容易。</p><p id="ab0f" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">因此，最难的部分是第二步:给定两组点P和Q，每组都以(0，0，0)为中心，如何将P旋转到Q上以最小化产生的RMSD？嗯步骤是:</p><p id="4f55" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo"> 1。</strong>把Q的转置乘以p，我们把得到的矩阵叫做H:</p><p id="6108" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><em class="nm"> H =乘法(转置(Q)，P) </em></p><p id="a641" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo"> 2。</strong>计算H的奇异值分解，保留第一个和第三个矩阵，在代数库中可用的大部分例程中常称为U和V。<strong class="le jo">重要提示:</strong>验证您使用的SVD程序是否给出了转置矩阵。大多数程序给你转置的形式，所以我称之为Vt:</p><p id="4d2b" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><em class="nm"> [U，S，Vt]= SVD(H)；→我们将使用U和Vt </em></p><p id="a9a7" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo"> 3。</strong>旋转矩阵R等于这个Vt(或V的转置，如果SVF程序没有给出转置矩阵)乘以U矩阵的转置:</p><p id="826d" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><em class="nm"> var R = multiply(Vt，转置(U))；</em></p><p id="e171" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">实际上，为了正确起见，您需要通过一个单位矩阵来缩放U的转置，如果V x Ut的行列式为负，则该单位矩阵的最后一个1被交换为-1:</p><p id="54a7" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><em class="nm"> var R = multiply(Vt，multiply(eyematrixcorrectedifredentintwasnegypt，transpose(U))；</em></p><p id="8f5c" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">但这很少适用于分子，事实上我们的软件中也不需要它。</p><p id="1b42" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le jo"> 4。</strong>最后，要得到旋转后的P，你需要将P乘以旋转矩阵R:</p><p id="a6c9" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><em class="nm"> var Protated = multiply(P，R)；</em></p><p id="e72b" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">请记住，在程序开始时，在最后将旋转P的所有元素移动到Q的平均x、y和z值。在moleculARweb中，Q通过构造固有地以(0，0，0)为中心，因此旋转的P不需要平移。</p><figure class="ne nf ng nh gt iv gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/722fc01fbbf3395a15227a0e459cff7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*XCo4LYzrAppZhc-xLqIhPw.png"/></div><p class="iy iz gj gh gi ja jb bd b be z dk translated">总结:先平移，然后按描述旋转。卢西亚诺·阿布利亚塔。</p></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="dc6b" class="mg mh je bd mi mj mk ml mm mn mo mp mq kt mr ku ms kw mt kx mu kz mv la mw mx bi translated">JavaScript代码</h1><p id="3021" class="pw-post-body-paragraph lc ld je le b lf my ko lh li mz kr lk ll na ln lo lp nb lr ls lt nc lv lw lx im bi translated">有时候代码比解释更容易理解……让我们看看这一切在JavaScript中是如何进行的。</p><p id="8c2a" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">假设P和Q已经以(0，0，0)为中心，计算和应用旋转的JavaScript代码非常简单:</p><pre class="ne nf ng nh gt no np nq nr aw ns bi"><span id="72d8" class="nt mh je np b gy nu nv l nw nx">var H = multiply(transpose(Q), P);</span><span id="574f" class="nt mh je np b gy ny nv l nw nx">var svdH = SVDJS.SVD(H);</span><span id="7a61" class="nt mh je np b gy ny nv l nw nx">var R = multiply(svdH.v, transpose(svdH.u));</span><span id="bdbe" class="nt mh je np b gy ny nv l nw nx">var Protated = multiply(P, R);</span></pre><p id="f170" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">注意，这里使用了两个硬编码的函数:</p><pre class="ne nf ng nh gt no np nq nr aw ns bi"><span id="d575" class="nt mh je np b gy nu nv l nw nx">function multiply(a, b) {<br/>  var aNumRows = a.length,<br/>    aNumCols = a[0].length,<br/>    bNumRows = b.length,<br/>    bNumCols = b[0].length,<br/>    m = new Array(aNumRows); // initialize array of rows<br/>  for (var r = 0; r &lt; aNumRows; ++r) {<br/>    m[r] = new Array(bNumCols); // initialize the current row<br/>    for (var c = 0; c &lt; bNumCols; ++c) {<br/>      m[r][c] = 0; // initialize the current cell<br/>      for (var i = 0; i &lt; aNumCols; ++i) {<br/>        m[r][c] += a[r][i] * b[i][c];<br/>      }<br/>    }<br/>  }<br/>  return m;<br/>}<br/><br/>function transpose(matrix) {<br/>  return matrix[0].map((col, i) =&gt; matrix.map((row) =&gt; row[i]));<br/>}</span></pre><p id="85bf" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">还有来自SVDJS的SVD例程，来源于svd-js库中的HTML，包含:</p><pre class="ne nf ng nh gt no np nq nr aw ns bi"><span id="54ec" class="nt mh je np b gy nu nv l nw nx">&lt;script src=”<a class="ae ly" href="https://molecularweb.epfl.ch/lib/svd-js.min.js" rel="noopener ugc nofollow" target="_blank">/lib/svd-js.min.js</a>”&gt;&lt;/script&gt;</span></pre><div class="is it gp gr iu nz"><a href="https://www.npmjs.com/package/svd-js" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd jo gy z fp oe fr fs of fu fw jn bi translated">奇异值分解</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">一个计算奇异值分解的简单库，如“奇异值分解和最小平方…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">www.npmjs.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on iw nz"/></div></div></a></div></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="8a51" class="mg mh je bd mi mj mk ml mm mn mo mp mq kt mr ku ms kw mt kx mu kz mv la mw mx bi translated">进一步阅读</h1><ul class=""><li id="464f" class="oo op je le b lf my li mz ll oq lp or lt os lx ot ou ov ow bi translated">解释这一过程的原始参考文献见Kabsch 1976年在《晶体学报:</li></ul><p id="5f08" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><a class="ae ly" href="http://scripts.iucr.org/cgi-bin/paper?S0567739476001873" rel="noopener ugc nofollow" target="_blank">http://scripts.iucr.org/cgi-bin/paper?S0567739476001873</a></p><ul class=""><li id="0f9a" class="oo op je le b lf lg li lj ll ox lp oy lt oz lx ot ou ov ow bi translated">要了解更多关于奇异值分解的知识，奇异值分解是Kabsch算法和许多其他计算(如主成分分析)的核心，请参见Reza Bagheri的文章:</li></ul><div class="is it gp gr iu nz"><a rel="noopener follow" target="_blank" href="/understanding-singular-value-decomposition-and-its-application-in-data-science-388a54be95d"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd jo gy z fp oe fr fs of fu fw jn bi translated">理解奇异值分解及其在数据科学中的应用</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">在线性代数中，矩阵的奇异值分解(SVD)是将矩阵分解成三个部分的分解</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">towardsdatascience.com</p></div></div><div class="oi l"><div class="pc l ok ol om oi on iw nz"/></div></div></a></div><ul class=""><li id="b9b5" class="oo op je le b lf lg li lj ll ox lp oy lt oz lx ot ou ov ow bi translated">要了解moleculARweb的VMK如何使用这些代码(消除扩散并突出内部分子动力学)，请打开该页面并查看其源代码，然后访问main.js并向下滚动，查找类似于<em class="nm"> svd </em>的单词:</li></ul><p id="8c21" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><a class="ae ly" href="https://molecularweb.epfl.ch/modules/virtual-modeling-kit-2/index.html" rel="noopener ugc nofollow" target="_blank">https://molecular web . epfl . ch/modules/virtual-modeling-kit-2/index . html</a></p><ul class=""><li id="81dc" class="oo op je le b lf lg li lj ll ox lp oy lt oz lx ot ou ov ow bi translated">要了解更多关于moleculARweb在浏览器中查看增强现实中的分子的应用程序，请查看:</li></ul><div class="is it gp gr iu nz"><a href="https://lucianosphere.medium.com/how-to-load-any-molecule-for-display-in-augmented-reality-on-molecularweb-5da0af4b64b2" rel="noopener follow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd jo gy z fp oe fr fs of fu fw jn bi translated">如何在moleculARweb上加载*any*分子用于增强现实显示</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">系列之一:如何在增强现实中看到任何分子</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">lucianosphere.medium.com</p></div></div><div class="oi l"><div class="pd l ok ol om oi on iw nz"/></div></div></a></div></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="ad0e" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">我是一个自然、科学、技术、编程和DIY爱好者。生物技术专家和化学家，在潮湿的实验室和电脑前。我写我广泛兴趣范围内的一切。查看我的 <a class="ae ly" href="https://lucianosphere.medium.com/lists" rel="noopener"> <em class="nm">列表</em> </a> <em class="nm">了解更多故事。</em> <a class="ae ly" href="https://lucianosphere.medium.com/membership" rel="noopener"> <strong class="le jo"> <em class="nm">成为中等会员</em> </strong> </a> <em class="nm">访问其所有故事和</em> <a class="ae ly" href="https://lucianosphere.medium.com/subscribe" rel="noopener"> <strong class="le jo"> <em class="nm">订阅获取我的新故事</em> </strong> </a> <strong class="le jo"> <em class="nm">通过电子邮件</em> </strong> <em class="nm">(我为其获得小额收入的平台的原始附属链接，无需向您支付特殊费用)。</em><a class="ae ly" href="https://lucianoabriata.altervista.org/office/donations.html" rel="noopener ugc nofollow" target="_blank"><strong class="le jo"><em class="nm"/></strong></a><strong class="le jo"><em class="nm"/></strong><em class="nm">通过各种方式捐赠到这里。</em> <a class="ae ly" href="https://lucianoabriata.altervista.org/office/contact.html" rel="noopener ugc nofollow" target="_blank"> <strong class="le jo"> <em class="nm">联系我这里的</em> </strong> </a> <em class="nm">进行任何种类的询问。</em></p><p id="7c13" class="pw-post-body-paragraph lc ld je le b lf lg ko lh li lj kr lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><em class="nm">到</em> <strong class="le jo"> <em class="nm">咨询关于小工作</em> </strong> <em class="nm">(关于编程、biotech+bio info项目评估、科学推广+交流、分子数据分析与设计、分子图形学、摄影、私人课程与教程、私人课程、教学与辅导等。)查看我的</em> <a class="ae ly" href="https://lucianoabriata.altervista.org/services/index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="le jo"> <em class="nm">服务页面这里</em> </strong> </a> <em class="nm">。</em></p></div></div>    
</body>
</html>