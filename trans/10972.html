<html>
<head>
<title>Accelerated TensorFlow model training on Intel Mac GPUs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">英特尔Mac GPUs上的加速张量流模型训练</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/accelerated-tensorflow-model-training-on-intel-mac-gpus-aa6ee691f894?source=collection_archive---------4-----------------------#2021-10-26">https://towardsdatascience.com/accelerated-tensorflow-model-training-on-intel-mac-gpus-aa6ee691f894?source=collection_archive---------4-----------------------#2021-10-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="13f5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何通过TensorFlow PluggableDevice在MacBook Pro dGPU上训练TensorFlow模型的迷你指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/52c861f99e9a8ce53c629fbffbd0db3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_1ORmujs17r77yDt"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@beautyoftechnology?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">尼古拉·塔拉先科</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="1eb5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">TensorFlow在2021年年中推出了<a class="ae kv" href="https://blog.tensorflow.org/2021/06/pluggabledevice-device-plugins-for-TensorFlow.html" rel="noopener ugc nofollow" target="_blank"> PluggableDevice </a>，这使得硬件制造商能够将其加速器(例如GPU、TPU、npu)无缝集成到TensorFlow生态系统中。这使得用户可以在非CUDA设备上享受加速培训，只需对代码进行最少的修改。更重要的是，硬件制造商不再需要派生和实现自己版本的TensorFlow(例如<a class="ae kv" href="https://github.com/ROCmSoftwarePlatform/tensorflow-upstream" rel="noopener ugc nofollow" target="_blank"> AMD ROCm port </a>)，可以纯粹专注于TensorFlow和设备级操作之间的通信层。随着最近<a class="ae kv" href="https://www.apple.com/uk/macos/monterey/" rel="noopener ugc nofollow" target="_blank"> macOS Monterey </a>的公开发布，苹果为PluggableDevice架构添加了<a class="ae kv" href="https://developer.apple.com/metal/tensorflow-plugin/" rel="noopener ugc nofollow" target="_blank">金属支持</a>，因此，现在可以在MacBook Pros和iMacs上轻松地使用专用GPU (dGPU)训练TensorFlow模型。</p><p id="c425" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本迷你指南中，我将介绍如何安装<code class="fe ls lt lu lv b">tensorflow-metal</code>以在英特尔MacBook Pro和iMac上启用dGPU培训。此外，我在配备AMD镭龙Pro 560X的MacBook Pro上训练了一个简单的CNN图像分类器，以展示加速后的性能。</p><h2 id="1cf2" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated"><strong class="ak">创建开发环境</strong></h2><p id="3ca9" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">我个人更喜欢<a class="ae kv" href="https://docs.conda.io/en/latest/miniconda.html" rel="noopener ugc nofollow" target="_blank"> miniconda </a>，但是其他环境管理器比如<a class="ae kv" href="https://www.anaconda.com/products/individual" rel="noopener ugc nofollow" target="_blank"> anaconda </a>和<a class="ae kv" href="https://virtualenv.pypa.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> virtualenv </a>也应该以类似的方式工作。</p><p id="4b5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们首先用Python 3.8创建一个名为<code class="fe ls lt lu lv b">tf-metal</code>的新<code class="fe ls lt lu lv b">conda</code>环境</p><pre class="kg kh ki kj gt mu lv mv mw aw mx bi"><span id="a176" class="lw lx iq lv b gy my mz l na nb">conda create -n tf-metal python=3.8</span></pre><p id="65cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后我们激活环境</p><pre class="kg kh ki kj gt mu lv mv mw aw mx bi"><span id="2dee" class="lw lx iq lv b gy my mz l na nb">conda activate tf-metal</span></pre><h2 id="15c1" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">安装金属启动张量流</h2><p id="960d" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">我们必须安装以下pip包:<code class="fe ls lt lu lv b"><a class="ae kv" href="https://pypi.org/project/tensorflow-macos/" rel="noopener ugc nofollow" target="_blank">tensorflow-macos</a></code>和<code class="fe ls lt lu lv b"><a class="ae kv" href="https://pypi.org/project/tensorflow-metal" rel="noopener ugc nofollow" target="_blank">tensorflow-metal</a></code>。通常，你可以简单地做<code class="fe ls lt lu lv b">pip install tensorflow-macos tensorflow-metal</code>,然后就万事大吉了。但是，您可能会收到以下错误，因为这两个包都是针对macOS 11 SDK之后的版本构建的:</p><pre class="kg kh ki kj gt mu lv mv mw aw mx bi"><span id="2cd5" class="lw lx iq lv b gy my mz l na nb">ERROR: Could not find a version that satisfies the requirement tensorflow-macos (from versions: none)<br/>ERROR: No matching distribution found for tensorflow-macos</span></pre><p id="5045" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了绕过版本兼容性问题，我们需要使用下面的标志<code class="fe ls lt lu lv b">SYSTEM_VERSION_COMPAT=0</code>和<code class="fe ls lt lu lv b">pip install</code>:</p><pre class="kg kh ki kj gt mu lv mv mw aw mx bi"><span id="81c9" class="lw lx iq lv b gy my mz l na nb">SYSTEM_VERSION_COMPAT=0 pip install tensorflow-macos tensorflow-metal</span></pre><p id="2590" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在应该已经安装了这两个软件包:</p><pre class="kg kh ki kj gt mu lv mv mw aw mx bi"><span id="5495" class="lw lx iq lv b gy my mz l na nb">(tf-metal) ➜  ~ pip list<br/>Package                 Version<br/>----------------------- ---------<br/>absl-py                 0.15.0<br/>astunparse              1.6.3<br/>cachetools              4.2.4<br/>certifi                 2021.10.8<br/>charset-normalizer      2.0.7<br/>clang                   5.0<br/>flatbuffers             1.12<br/>gast                    0.4.0<br/>google-auth             2.3.1<br/>google-auth-oauthlib    0.4.6<br/>google-pasta            0.2.0<br/>grpcio                  1.41.1<br/>h5py                    3.1.0<br/>idna                    3.3<br/>keras                   2.6.0<br/>Keras-Preprocessing     1.1.2<br/>Markdown                3.3.4<br/>numpy                   1.19.5<br/>oauthlib                3.1.1<br/>opt-einsum              3.3.0<br/>pip                     21.2.4<br/>protobuf                3.19.0<br/>pyasn1                  0.4.8<br/>pyasn1-modules          0.2.8<br/>requests                2.26.0<br/>requests-oauthlib       1.3.0<br/>rsa                     4.7.2<br/>setuptools              58.0.4<br/>six                     1.15.0<br/>tensorboard             2.7.0<br/>tensorboard-data-server 0.6.1<br/>tensorboard-plugin-wit  1.8.0<br/>tensorflow-estimator    2.6.0<br/>tensorflow-macos        2.6.0<br/>tensorflow-metal        0.2.0<br/>termcolor               1.1.0<br/>typing-extensions       3.7.4.3<br/>urllib3                 1.26.7<br/>Werkzeug                2.0.2<br/>wheel                   0.37.0<br/>wrapt                   1.12.1</span></pre><h2 id="584d" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">在TensorFlow中检查物理设备</h2><p id="97cc" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">我们可以使用<code class="fe ls lt lu lv b">tf.config.list_physical_devices()</code>来检查所有可用的物理设备:</p><pre class="kg kh ki kj gt mu lv mv mw aw mx bi"><span id="1830" class="lw lx iq lv b gy my mz l na nb">&gt;&gt;&gt; import tensorflow as tf<br/>&gt;&gt;&gt;<br/>&gt;&gt;&gt; tf.config.list_physical_devices()<br/>[PhysicalDevice(name='/physical_device:CPU:0', device_type='CPU'), PhysicalDevice(name='/physical_device:GPU:0', device_type='GPU')]</span></pre><p id="57e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以看到，在我配备AMD镭龙Pro 560X dGPU的2018 MacBook Pro的情况下，有两个物理设备:一个<code class="fe ls lt lu lv b">CPU</code>和一个<code class="fe ls lt lu lv b">GPU</code>。</p><p id="5724" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">类似于在TensorFlow中使用本地设备或CUDA设备，我们可以使用<code class="fe ls lt lu lv b">with tf.device()</code>语法声明一个变量或定义在特定设备上运行的操作:</p><pre class="kg kh ki kj gt mu lv mv mw aw mx bi"><span id="dc90" class="lw lx iq lv b gy my mz l na nb">&gt;&gt;&gt; with tf.device('/GPU'):<br/>...     a = tf.random.normal(shape=(2,), dtype=tf.float32)<br/>...     b = tf.nn.relu(a)<br/>...<br/>2021-10-26 12:51:24.844280: I tensorflow/core/platform/cpu_feature_guard.cc:142] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  SSE4.2 AVX AVX2 FMA<br/>To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.<br/>Metal device set to: AMD Radeon Pro 560X</span><span id="b278" class="lw lx iq lv b gy nc mz l na nb">systemMemory: 16.00 GB<br/>maxCacheSize: 2.00 GB</span><span id="a26e" class="lw lx iq lv b gy nc mz l na nb">2021-10-26 12:51:24.845013: I tensorflow/core/common_runtime/pluggable_device/pluggable_device_factory.cc:305] Could not identify NUMA node of platform GPU ID 0, defaulting to 0. Your kernel may not have been built with NUMA support.<br/>2021-10-26 12:51:24.845519: I tensorflow/core/common_runtime/pluggable_device/pluggable_device_factory.cc:271] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 0 MB memory) -&gt; physical PluggableDevice (device: 0, name: METAL, pci bus id: &lt;undefined&gt;)<br/>&gt;&gt;&gt;<br/>&gt;&gt;&gt; a<br/>&lt;tf.Tensor: shape=(2,), dtype=float32, numpy=array([-1.6457689, -0.2130392], dtype=float32)&gt;<br/>&gt;&gt;&gt; b<br/>&lt;tf.Tensor: shape=(2,), dtype=float32, numpy=array([0., 0.], dtype=float32)&gt;</span></pre><p id="cebd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在初始化期间看到金属装置<code class="fe ls lt lu lv b">AMD Radeon Pro 560X</code>被设置的打印输出。</p><h2 id="8793" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">训练CNN分类器</h2><p id="bec8" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">为了演示使用<code class="fe ls lt lu lv b">tensorflow-metal</code>对普通<code class="fe ls lt lu lv b">tensorflow</code>(即在<code class="fe ls lt lu lv b">CPU</code>上)的训练性能，我编写了一个脚本，使用<code class="fe ls lt lu lv b">RMSProp</code>在<code class="fe ls lt lu lv b">MNIST</code>上训练一个简单的CNN模型50个时期。请注意，我使用<a class="ae kv" href="https://www.tensorflow.org/datasets" rel="noopener ugc nofollow" target="_blank"> TensorFlow数据集</a>来下载<code class="fe ls lt lu lv b">MNIST</code>，所以如果您想运行完全相同的代码，请使用<code class="fe ls lt lu lv b">pip install tensorflow_datasets</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="ed0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是用<code class="fe ls lt lu lv b">tensorflow</code> (CPU)和<code class="fe ls lt lu lv b">tensorflow-metal</code> (GPU)训练的CNN模型的训练结果和活动监视器截图。</p><div class="kg kh ki kj gt ab cb"><figure class="nf kk ng nh ni nj nk paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/154f36518659044769a43afc4a360d60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/1*ERxj7E6yhVRYxmjqTP1NHA.png"/></div></figure><figure class="nf kk nl nh ni nj nk paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/bed9ef3c14a362bd7fb7152e0605ec5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*IjC95nGQ-Tq1teP9lPH2cw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk nm di nn no translated">活动监视器截图和CNN在CPU上的训练表现[图片由作者提供]</p></figure></div><div class="ab cb"><figure class="nf kk np nh ni nj nk paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/9f333610566beda321b9235b2c355178.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/1*kICiIn_GHayCcmM5aE8f0w.png"/></div></figure><figure class="nf kk nq nh ni nj nk paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/6bbd37d84e07a998e8f416b3490e9349.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*SgLrIy1oJWspcI6HhHKPtA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk nr di ns no translated">活动监视器截图和CNN在GPU上的训练表现[图片由作者提供]</p></figure></div><p id="4183" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以看到在<code class="fe ls lt lu lv b">tensorflow</code>和<code class="fe ls lt lu lv b">tensorflow-metal</code>上的训练达到了相似的训练和验证精度。此外，CNN模型在CPU上平均耗时40毫秒/步，而在GPU上平均耗时19毫秒/步，加速约52%。从活动监视器截图中，我们也可以看到AMD镭龙Pro 560X dGPU确实正在被python3.8使用，GPU使用率约为56%。</p><p id="87c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于TensorFlow PluggableDevice架构，硬件开发人员现在可以支持非CUDA加速器与TensorFlow一起工作，而无需分叉或移植现有的TensorFlow代码库。根据我们有限的实验，<code class="fe ls lt lu lv b">tensorflow-metal</code>似乎在采用dGPU的英特尔MAC电脑上运行得相对良好且无缝。尽管如此，Metal插件仍处于早期开发阶段，还有一些已知的错误(如<a class="ae kv" href="https://developer.apple.com/forums/thread/691917" rel="noopener ugc nofollow" target="_blank"> Adam optimizer目前</a>不工作)阻止ML开发者切换到<code class="fe ls lt lu lv b">tensorflow-metal</code>工作流。希望随着越来越多的硬件制造商开始将他们的产品与PluggableDevice API集成，我们将在AI硬件加速器中看到更好的支持和更多的选择。</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><h2 id="67f9" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">关于TensorFlow可插拔设备和Apple Metal的其他参考资料</h2><ul class=""><li id="1948" class="oa ob iq ky b kz mp lc mq lf oc lj od ln oe lr of og oh oi bi translated">tensor flow-<a class="ae kv" href="https://blog.tensorflow.org/2021/06/pluggabledevice-device-plugins-for-TensorFlow.html" rel="noopener ugc nofollow" target="_blank">pluggable Device:tensor flow的设备插件</a></li><li id="6826" class="oa ob iq ky b kz oj lc ok lf ol lj om ln on lr of og oh oi bi translated">TensorFlow - <a class="ae kv" href="https://www.tensorflow.org/install/gpu_plugins" rel="noopener ugc nofollow" target="_blank"> GPU设备插件</a></li><li id="0ace" class="oa ob iq ky b kz oj lc ok lf ol lj om ln on lr of og oh oi bi translated">苹果- <a class="ae kv" href="https://developer.apple.com/metal/tensorflow-plugin/" rel="noopener ugc nofollow" target="_blank"> Tensorflow插件- Metal -苹果开发者</a></li></ul></div></div>    
</body>
</html>