<html>
<head>
<title>How to run Python ML algorithms easily in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在R中轻松运行Python ML算法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-run-python-ml-algorithms-easily-in-r-7e3b0f7c7aee?source=collection_archive---------37-----------------------#2021-04-12">https://towardsdatascience.com/how-to-run-python-ml-algorithms-easily-in-r-7e3b0f7c7aee?source=collection_archive---------37-----------------------#2021-04-12</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><div class=""><h2 id="5569" class="pw-subtitle-paragraph js iu iv bd b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj dk translated">如何让Python的XGBoost在R中轻松工作的例子</h2></div><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi kk"><img src="../Images/346f334b77dbc4601022a9236dbb242b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7AiionP1EZoUi3PegMd_mw.jpeg"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">图片由来自Pixabay的Arek Socha提供</p></figure><p id="2e04" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">毫无疑问，Python拥有所有编程语言中最广泛的ML算法，如果我打算进行任何形式的预测建模，Python通常是我的第一选择。也就是说，我更喜欢用R来整理和准备数据，并且希望能够将Python算法导入R，这样我就可以两全其美了。所以我最近决定看看是否可以在r中轻松运行Python ML算法。我选择尝试k倍交叉验证的XGBoost模型。</p><p id="f412" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">我认为在RStudio中做这件事很容易，所以我在这里写了“如何做”。我还用这个例子组合了一个<a class="ae lw" href="https://github.com/keithmcnulty/r_and_py_models" rel="noopener ugc nofollow" target="_blank"> Github repo </a>。</p><p id="9e94" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">要让这些方法工作，您需要在R项目中工作，并指向Conda环境或Virtualenv中包含您需要的所有Python包的Python可执行文件。您可以通过使用R项目目录中的一个<code class="fe lx ly lz ma b">.Rprofile</code>文件来做到这一点。每当您在R中启动一个项目时，这个文件都会在启动时执行它的内容。我的<code class="fe lx ly lz ma b">.Rprofile</code>有两行代码。第一行告诉R在Conda环境中哪里可以找到正确的Python可执行文件，我已经安装了所有需要的包(即<code class="fe lx ly lz ma b">pandas</code>、<code class="fe lx ly lz ma b">scipy</code>、<code class="fe lx ly lz ma b">scikit-learn</code>和<code class="fe lx ly lz ma b">XGBoost</code>)。这需要进行编辑，以指向您机器上的正确路径。</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="084a" class="mf mg iv ma b gy mh mi l mj mk">Sys.setenv(RETICULATE_PYTHON = "/home/rstudio/.local/share/r-miniconda/envs/r_and_py_models/bin/python3")</span></pre><p id="47c3" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">第二行是为了我方便。它打印出正在使用的Conda环境的确认。这是为了在启动时让我放心，R知道我希望它在哪里执行Python代码。</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="1882" class="mf mg iv ma b gy mh mi l mj mk">print(paste("Python environment forced to", Sys.getenv("RETICULATE_PYTHON")))</span></pre><p id="801b" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">当我开始我的项目时，我收到这条消息来确认正在使用预期的Conda环境。</p><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi ml"><img src="../Images/e044f3ec6cbf520f885c127f25fe257b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XalhJEyP94_sQwVQwykY7w.png"/></div></div></figure><h1 id="5dc4" class="mm mg iv bd mn mo mp mq mr ms mt mu mv kb mw kc mx ke my kf mz kh na ki nb nc bi translated">用R编写Python函数在数据集上运行</h1><p id="3f58" class="pw-post-body-paragraph la lb iv lc b ld nd jw lf lg ne jz li lj nf ll lm ln ng lp lq lr nh lt lu lv io bi translated">我创建了一个名为<code class="fe lx ly lz ma b">python_functions.py</code>的Python文件，在其中我用Python编写了所需的函数，以便在任意Pandas数据帧上执行XGBoost模型。我这样做是为了让这些函数的所有参数都在一个名为<code class="fe lx ly lz ma b">parameters</code>的字典中。我需要编写四个Python函数——一个将我的数据分成训练和测试数据，一个缩放我的要素，一个运行XGBoost，最后一个创建分类报告作为数据帧。以下是包含四个必需函数的文件内容:</p><figure class="kl km kn ko gt kp"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="fff0" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">现在在我的R项目中，我可以使用<code class="fe lx ly lz ma b">reticulate</code>包在R中获得这四个函数，使它们成为R函数。</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="6b58" class="mf mg iv ma b gy mh mi l mj mk">library(reticulate)<br/>source_python("python_functions.py")</span></pre><h1 id="3e0c" class="mm mg iv bd mn mo mp mq mr ms mt mu mv kb mw kc mx ke my kf mz kh na ki nb nc bi translated">示例:在R中使用Python XGBoost</h1><p id="5189" class="pw-post-body-paragraph la lb iv lc b ld nd jw lf lg ne jz li lj nf ll lm ln ng lp lq lr nh lt lu lv io bi translated">我们现在在R中使用这些函数来尝试学习预测一款高质量的葡萄酒。首先，我们下载白葡萄酒和红葡萄酒的数据集。</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="3a1e" class="mf mg iv ma b gy mh mi l mj mk">white_wines &lt;- read.csv("https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-white.csv",<br/>                        sep = ";")</span><span id="edf3" class="mf mg iv ma b gy nk mi l mj mk">red_wines &lt;- read.csv("https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv", <br/>                      sep = ";")</span></pre><p id="a7f4" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">我们将创建“白色对红色”作为一个新功能，我们将“高质量”定义为7分或以上的质量分数。</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="7896" class="mf mg iv ma b gy mh mi l mj mk">library(dplyr)</span><span id="d804" class="mf mg iv ma b gy nk mi l mj mk">white_wines$red &lt;- 0<br/>red_wines$red &lt;- 1</span><span id="184b" class="mf mg iv ma b gy nk mi l mj mk">wine_data &lt;- white_wines %&gt;% <br/>  bind_rows(red_wines) %&gt;% <br/>  mutate(high_quality = ifelse(quality &gt;= 7, 1, 0)) %&gt;% <br/>  select(-quality)</span><span id="faeb" class="mf mg iv ma b gy nk mi l mj mk">head(wine_data)</span></pre><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi nl"><img src="../Images/fbbc9b4890ca79d18d1223123555cf88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WlOZsQz0q-aTQQAeX07Msg.png"/></div></div></figure><p id="a426" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">现在我们的数据已经为建模设置好了，是时候将我们的Python函数付诸实践了。</p><p id="fa07" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">现在我们设置我们的参数列表(R中的列表相当于Python中的dict):</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="a091" class="mf mg iv ma b gy mh mi l mj mk">params &lt;- list(<br/>  input_cols = colnames(wine_data)[colnames(wine_data) != 'high_quality'],<br/>  target_col = 'high_quality',<br/>  test_size = 0.3,<br/>  random_state = 123,<br/>  subsample = (3:9)/10, <br/>  xgb_max_depth = 3:9,<br/>  colsample_bytree = (3:9)/10,<br/>  xgb_min_child_weight = 1:4,<br/>  k = 3,<br/>  k_shuffle = TRUE,<br/>  n_iter = 10,<br/>  scoring = 'f1',<br/>  error_score = 0,<br/>  verbose = 1,<br/>  n_jobs = -1<br/>)</span></pre><p id="9c14" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">现在我们已经准备好运行XGBoost模型，比如说，三重交叉验证。首先，我们使用我们的Python函数<code class="fe lx ly lz ma b">split_data</code>分割数据——注意<code class="fe lx ly lz ma b">reticulate</code>将在幕后把输入翻译成它们的Python等价物，因此<code class="fe lx ly lz ma b">wine_data</code>将成为熊猫数据帧而<code class="fe lx ly lz ma b">params</code>将成为字典。</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="e7a8" class="mf mg iv ma b gy mh mi l mj mk">split &lt;- split_data(df = wine_data,  parameters = params)</span></pre><p id="f404" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">我们的Python函数返回一个dict，R中的输出将是一个列表，我们可以将它输入到缩放函数中:</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="3b99" class="mf mg iv ma b gy mh mi l mj mk">scaled &lt;- scale_data(split$X_train, split$X_test)</span></pre><p id="b6c8" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">同样，输出将是一个列表。现在，我们可以使用训练集上定义的参数运行XGBoost算法:</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="defb" class="mf mg iv ma b gy mh mi l mj mk">trained &lt;- train_xgb_crossvalidated(<br/>  scaled$X_train_scaled,<br/>  split$y_train,<br/>  parameters = params<br/>)</span></pre><p id="5921" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">最后，我们可以为我们的测试集生成一个分类报告:</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="4c57" class="mf mg iv ma b gy mh mi l mj mk">generate_classification_report(trained, scaled$X_test_scaled, split$y_test)</span></pre><figure class="kl km kn ko gt kp gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/25fd144261618eeb5a772d2e1bb4041d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*jLppCExtx0AZXyUykpB2JA.png"/></div></figure><p id="3538" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">现在我们有了。你也可以使用训练过的对象<code class="fe lx ly lz ma b">trained</code>来生成新的预测，就像你在Python中做的那样。例如，我们可以看到测试集的第一行被归类为高质量。</p><pre class="kl km kn ko gt mb ma mc md aw me bi"><span id="988d" class="mf mg iv ma b gy mh mi l mj mk">test_data &lt;- py_to_r(scaled$X_test_scaled)<br/>trained$predict(test_data[1, ])</span><span id="463b" class="mf mg iv ma b gy nk mi l mj mk">[1] 1</span></pre><p id="1f7c" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">本文展示了一个更通用的编写Python函数的过程，这些函数将处理任意输入，然后可以很容易地在r中执行。它应该很容易推广到任何其他类型的过程，无论是另一个ML算法还是像<a class="ae lw" rel="noopener" target="_blank" href="/generating-parameterized-powerpoint-documents-in-python-and-r-333368479038">编写Powerpoint文档</a>这样的过程。我希望它对你正在做的其他工作是一个有用的基础。</p></div><div class="ab cl nn no hz np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="io ip iq ir is"><p id="89f5" class="pw-post-body-paragraph la lb iv lc b ld le jw lf lg lh jz li lj lk ll lm ln lo lp lq lr ls lt lu lv io bi translated">最初我是一名纯粹的数学家，后来我成为了一名心理计量学家和数据科学家。我热衷于将所有这些学科的严谨性应用到复杂的人的问题上。我也是一个编码极客和日本RPG的超级粉丝。在<a class="ae lw" href="https://www.linkedin.com/in/keith-mcnulty/" rel="noopener ugc nofollow" target="_blank"><em class="nu">LinkedIn</em></a><em class="nu">或</em><a class="ae lw" href="https://twitter.com/dr_keithmcnulty" rel="noopener ugc nofollow" target="_blank"><em class="nu">Twitter</em></a><em class="nu">上找我。也可以看看我在drkeithmcnulty.com的</em><em class="nu"/><em class="nu">上的博客。</em></p></div></div>    
</body>
</html>