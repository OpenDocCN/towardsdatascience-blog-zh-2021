<html>
<head>
<title>Winning the Kaggle Google Brain — Ventilator Pressure Prediction</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">赢得Kaggle谷歌大脑——呼吸机压力预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/winning-the-kaggle-google-brain-ventilator-pressure-prediction-2d4c90d831ec?source=collection_archive---------4-----------------------#2021-11-12">https://towardsdatascience.com/winning-the-kaggle-google-brain-ventilator-pressure-prediction-2d4c90d831ec?source=collection_archive---------4-----------------------#2021-11-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="95ba" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="ab32" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">在LSTMs、变压器和PID控制器上…</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/80844c89770eb629185b04bdadcb02f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*LdPma1aBeMRRe6I4Ldpbmg.png"/></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">一个人工机械肺(<a class="ae la" href="https://commons.wikimedia.org/wiki/File:Q-vent.jpg" rel="noopener ugc nofollow" target="_blank">来自维基媒体</a></p></figure><p id="5d14" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">11月4日，在Kaggle上组织的谷歌大脑——呼吸机压力预测中，我们成功地从2650个团队中脱颖而出。在这篇博文中，我想带你经历一次让我们赢得胜利的旅程。在<a class="ae la" href="https://www.kaggle.com/c/ventilator-pressure-prediction/discussion/285256" rel="noopener ugc nofollow" target="_blank"> Kaggle论坛</a>上可以找到这篇文章的更概括的版本，我们已经公布了我们的<a class="ae la" href="https://www.kaggle.com/shujun717/1-solution-lstm-cnn-transformer-1-fold" rel="noopener ugc nofollow" target="_blank"> LSTM + CNN变压器模型</a>和<a class="ae la" href="https://www.kaggle.com/group16/1-solution-pid-controller-matching-v1" rel="noopener ugc nofollow" target="_blank"> PID匹配</a>的代码。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi lx"><img src="../Images/bde187550a3f6f7ae094f0705fabb834.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*baWsDYHgZ9L1PNaQOF2XWw.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">赢得永恒的荣耀和2500美元！作者截图</p></figure><h1 id="0cef" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">来自Kha的邮件…</h1><p id="fa2c" class="pw-post-body-paragraph lb lc iq ld b le mu ka lg lh mv kd lj lk mw lm ln lo mx lq lr ls my lu lv lw ij bi translated">在完成我的博士学位和一段不愉快但短暂的工作经历后，我有一点被烧毁了。结果，我在2021年离开了Kaggle一段时间，你可以从我的活动日志中看到。我参加了一点“石头、剪子、布大赛”，并尝试了“室内定位和导航挑战”。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mz"><img src="../Images/05004a8967bb28edb0cbd2d1ca9cb202.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iUZcSQiVBuK4t43m4SksCQ.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者截图</p></figure><p id="6c67" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">9月23日，<a class="ae la" href="https://www.kaggle.com/zidmie" rel="noopener ugc nofollow" target="_blank"> Yves </a>和我收到了<a class="ae la" href="https://www.kaggle.com/khahuras" rel="noopener ugc nofollow" target="_blank"> Kha </a>发来的邮件。他在Kaggle上发现了一个有趣的时间序列比赛，这个比赛只持续了1个月。这个比赛吸引了我，因为我非常熟悉时间序列数据，也是短期比赛的忠实粉丝。此外，我知道当Kha、Yves和我合作时，好事往往随之而来！我回复Kha说我会有兴趣加入，但是在我真正投入之前，先要处理一些现实生活中的事情。<a class="ae la" href="https://github.com/GillesVandewiele/Liverpool-Ion-Switching/blob/master/DS_Ghent_Meetup_Liverpool_final.pdf" rel="noopener ugc nofollow" target="_blank">其中一件必须做的事情是准备&amp;介绍Kha、Yves和我在2020年“利物浦离子交换”竞赛中获得的第三名解决方案。Kha和Yves开始着手解决这个问题，并取得了一些进展。过了一段时间，10月6日，我加入了他们。</a></p><h1 id="53f7" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">简要问题陈述</h1><p id="cf2b" class="pw-post-body-paragraph lb lc iq ld b le mu ka lg lh mv kd lj lk mw lm ln lo mx lq lr ls my lu lv lw ij bi translated">该竞赛的目标是根据吸气电磁阀打开的程度，预测任何给定时间步长的机械肺内的压力(<code class="fe na nb nc nd b">u_in</code>；0到100之间的值)。我们接受了大约75000次训练呼吸和50000次测试呼吸。每次呼吸由吸气阶段和呼气阶段组成，由提供的<code class="fe na nb nc nd b">u_out</code>指示。我们的提交仅在吸气阶段评分(因此<code class="fe na nb nc nd b">u_out</code>等于0)。此外，呼吸被记录在具有不同阻力和容量属性的机械肺中，这些属性被编码在提供的<code class="fe na nb nc nd b">R</code>和<code class="fe na nb nc nd b">C</code>变量中。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ne"><img src="../Images/1ef2e77acfbdc1b30a98622aacd53c6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kOsI7cCrPw9E2vj9cukbtA.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">1训练呼吸的例子。我们被提供u_in，u_out，R &amp; C，并被要求预测压力。作者图片</p></figure><h1 id="40fe" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">深度学习斗争</h1><p id="9424" class="pw-post-body-paragraph lb lc iq ld b le mu ka lg lh mv kd lj lk mw lm ln lo mx lq lr ls my lu lv lw ij bi translated">从本次比赛中公布的公共笔记本来看，很明显LSTMs或任何类型的时间深度学习模型都将占据主导地位。我们三个人都很快增加了功能或对这些管道进行了小的修改，但都无济于事……很明显，深度学习不是我们的强项。然后，我们的思维方式发生了转变:<strong class="ld ja">“与其试图创建一个适合所有训练数据的模型，然后用于对所有测试数据进行预测，我们难道不能专注于单独的呼吸，看看我们是否可以对其建模以找到模式？”</strong></p><p id="eafb" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">拥有物理学背景的Yves研究了PID控制器，并很快发现了一个很好的简单的后处理技巧，它能够给我们的LB<strong class="ld ja">+0.004的提升，这是非常显著的。由于这种后处理技巧，我们能够通过稍微修改的公共笔记本爬上排行榜，使我们在黄金区之外获得一席之地。Yves的后处理技巧解释起来相当简单(但不容易找到)，并且是基于PID控制器的理论。</strong></p><p id="25d4" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">我们可以想出一个非常简单的公式:<code class="fe na nb nc nd b">pressure = kt — (u_in/kp)</code>。有了必须调整的算法的<code class="fe na nb nc nd b">kt</code>和<code class="fe na nb nc nd b">kp</code>参数，<code class="fe na nb nc nd b">u_in</code>是输入数据，<code class="fe na nb nc nd b">pressure</code>是我们想要预测的输出数据。<a class="ae la" href="https://arxiv.org/abs/2102.06779" rel="noopener ugc nofollow" target="_blank">在组织者写的一篇论文中提到了搜索这些参数的网格。</a>但是，在没有纸张的情况下，仅通过对训练数据中的每一次呼吸应用线性回归，就可以容易地发现这个网格(其中我们有u_in和压力)。</p><p id="2d8a" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">现在的问题是，我们如何知道某一组参数对测试呼吸有多好，因为我们没有计算误差的压力。为此，我们可以利用压力的离散性。只有950个唯一的压力值，它们之间的距离相等。因此，如果我们填入两个候选参数<code class="fe na nb nc nd b">kt</code>和<code class="fe na nb nc nd b">kp</code>，并且计算出的压力值与这950个独特的压力值完全一致，我们就有了匹配。这种匹配适用于大约2.5%的数据。</p><pre class="kp kq kr ks gt nf nd ng nh aw ni bi"><span id="3fe5" class="nj md iq nd b gy nk nl l nm nn">KP_GRID = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, <br/>           2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]<br/>KT_GRID = [10, 15, 20, 25, 30, 35]</span><span id="3a0e" class="nj md iq nd b gy no nl l nm nn">def match_breath(breath):<br/>    u_in = breath['u_in'].values<br/>    inspiratory_len = np.sum(1 - breath['u_out'])<br/>    <br/>    u_in = u_in[1:inspiratory_len]<br/>    breath_mask = (u_in &gt; 0) &amp; (u_in &lt; 100)<br/>    <br/>    if np.sum(breath_mask) &lt; 2:<br/>        return None, None, None, None<br/>        <br/>    for kt in KT_GRID:<br/>        for kp in KP_GRID:<br/>            preds = (kt - u_in / kp)<br/>            preds_round = (preds-MIN_PRESSURE)/DIFF_PRESSURE<br/>            tune_error = np.round(preds_round[breath_mask]) - preds_round[breath_mask]<br/>            if np.sum(np.abs(tune_error)) &lt; 1e-6:<br/>                return preds, kt, kp, breath_mask<br/>            <br/>    return None, None, None, None</span></pre><h1 id="9cd2" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">派援军来！</h1><p id="6fd9" class="pw-post-body-paragraph lb lc iq ld b le mu ka lg lh mv kd lj lk mw lm ln lo mx lq lr ls my lu lv lw ij bi translated">在发现后处理技巧后，我们无法做出任何更大的改进。我们慢慢地看到我们在LB的排名下降，很明显，为了在这次比赛中取得好成绩，我们需要有更深层次学习经验的人。我们给当时正好在黄金地带下方的<a class="ae la" href="https://www.kaggle.com/shujun717" rel="noopener ugc nofollow" target="_blank">舒军</a>发了消息。我知道Shujun在深度学习方面非常强，因为他在我也参加的<a class="ae la" href="https://www.kaggle.com/c/stanford-covid-vaccine" rel="noopener ugc nofollow" target="_blank">“open vaccine—Covid mRNA”比赛</a>中获得了一个具有独特和强大架构的单人金牌。男孩没有让他<strong class="ld ja">或</strong>失望。</p><p id="67cd" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">舒骏的深度学习架构是LSTM细胞、1D卷积和变形金刚的组合。LSTMs是必要的，因为目标压力严重依赖于以前的时间点。卷积结合转换器是一个很好的组合，可以模拟全局依赖关系，同时弥补转换器无法捕捉局部交互的不足。网络相当深，我们遇到了一些梯度问题。因此，一个名为<code class="fe na nb nc nd b">ResidualLSTM</code>的新模块被创建，它增加了一个前馈网络(FFN)，并用一个剩余连接将输入连接到LSTM，输出连接到FFN。该模型对原始数据进行处理，此外还有一些滞后和差异特征、u_in的累积和以及一个热编码的R &amp; C特征。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi np"><img src="../Images/3f6f5973998a3cc0f5c45090744d7eb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RJgpR5iffYzmZBLY.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">LSTM + CNN变压器架构。合著者Shujun的图片。</p></figure><p id="9e74" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">我们将我们当前的混合物与舒军的不同运行模型混合，并应用我们的PP技巧。<strong class="ld ja">轰</strong>，我们中了黄金！</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/8613951503c82db45662f19e43ac8284.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*mjDnTgYTlCAZ6_-ovaqJ3g.png"/></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><p id="e2aa" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">我们尝试向Shujun建议一些想法，以便在他的管道中实施，还尝试添加一些功能，以便管道(因为他的管道利用了功能)。但是，我们还是没有成功。</p><p id="07c9" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">几天后，我们觉得我们的混合需要另一个独特的深度学习管道。这就是里卡多进入故事的地方！当我们给他发信息的时候，里卡尔多只比我们低几个点。他建立并运行了一个LSTM架构，只集中于原始数据。没有特征工程，没有花哨的东西，只有原始数据和许多时代。诀窍是有一个好的学习进度计划。我们选择了30个历元的ReduceLROnPlateau。这与公共笔记本中通常使用的快速退火调度器形成了对比，后者容易过度适应。当我们将我们的验证损失曲线与公共笔记本的验证损失曲线进行比较时，可以看出这一点，如下所示。这里的红色(赌注)曲线对应于公共笔记本，并很快超拟合。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nr"><img src="../Images/377083d37a0fa9ae1841a625172aec34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Lk77QWkqTICbOZ9KyYsWg.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><p id="c257" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">这种方法甚至比LSTM + 1D CNN变压器编码器得分更高。这些渠道的结合让我们在排行榜上名列第四。<strong class="ld ja">我们决定将我们的目标从金牌转变为赢得金钱。</strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/177398156c775e704764690c97aa450a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*RMryr7Z9aMV_xVxiMcE8nA.png"/></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><p id="d9cd" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">同样，我们所有人都专注于改善我们已经启动并运行的两条管道。对两个管道进行轻微的修改，或者向transformer管道添加特性。只做了极其微小的改进，与我们前面的竞争对手差距太大。<strong class="ld ja">当然，他们发现的数据中隐藏着一些我们还没有发现的东西……</strong></p><h1 id="ae3a" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">史上最好的生日礼物</h1><p id="f0b2" class="pw-post-body-paragraph lb lc iq ld b le mu ka lg lh mv kd lj lk mw lm ln lo mx lq lr ls my lu lv lw ij bi translated">10月26日是我的生日，我决定学习更多关于PID ( <strong class="ld ja"> P </strong>比例- <strong class="ld ja"> I </strong>积分- <strong class="ld ja"> D </strong>导数)控制器的知识，因为这些也是组织者论文中的核心概念。此外，我们的后处理技巧来自Yves对这些PID控制器的研究。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/6cdc947fc0985b9dc3f9cece0d6fa0ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:514/format:webp/1*MYtVcyWcdRcMs7zzTMduGw.png"/></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">来戳这个兔子洞吧…图片作者</p></figure><p id="d7c9" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">我在Python中摆弄了一下<a class="ae la" href="https://github.com/m-lundberg/simple-pid" rel="noopener ugc nofollow" target="_blank"> simple-pid </a>包，因为这个包已经实现了pid公式。我也能够用这个软件包重现我们的后处理技巧。然而，对于大多数呼吸，我无法找到匹配。直到我决定专门研究代码和积分项。有多种方法来计算PID控制器的积分项，该软件包只包括普通的实现。我决定插入一些其他的替代品，突然，我有了一个突破……<strong class="ld ja">多好的生日礼物啊！</strong>下面的代码片段(基于simple-pid包)能够为某些呼吸完美地模拟压力- &gt; u_in:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nu"><img src="../Images/d89b84d2fbebfeaed11c7aa02640e83c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xlvDMpYanM7EpBG-jl7DrQ.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">接近了，但还没有…仍然是一个巨大的突破！作者图片</p></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nv"><img src="../Images/c676e6dfa38e8721271090cf7578ccff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_7kWHJxBhsB2iy0Akexg7A.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">几个小时后，修复一些细节…图片由作者</p></figure><p id="e02c" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">以下是能够完美模拟某些呼吸的u_in压力的代码片段:</p><pre class="kp kq kr ks gt nf nd ng nh aw ni bi"><span id="e282" class="nj md iq nd b gy nk nl l nm nn">def generate_u_in(pressure, time_step, kp, ki, kt, integral=0):<br/>    dt = np.diff(time_step, prepend=[0])<br/>    preds = []<br/>    for j in range(32):<br/>        error = kt - pressure[j]<br/>        integral += (error - integral) * (dt[j] / (dt[j] + 0.5))<br/>        preds.append(kp * error + ki * integral)<br/>    return preds</span></pre><p id="60a4" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">我想我们有了一个新的不错的后处理技巧，并把这个信息发给了Yves。伊夫做了一些更大的事情。他想出了一些能够完美匹配压力的代码。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nw"><img src="../Images/ab20a66e988f00a2dc1d1bcaa14b8683.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OO_Iqh9S4GvgX5KYApgGSg.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">你能感受到兴奋吗？作者图片</p></figure><h1 id="b172" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">完美的搭配</h1><p id="14ec" class="pw-post-body-paragraph lb lc iq ld b le mu ka lg lh mv kd lj lk mw lm ln lo mx lq lr ls my lu lv lw ij bi translated">我们可以编写PID控制器的“普通”方程(对应于我提供的<code class="fe na nb nc nd b">generate_u_in</code>片段):</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nx"><img src="../Images/d89f1c599e338eb42c74335857d70b25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Dx6KYbo0W1ydQsoG.png"/></div></div></figure><p id="2dc3" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">其中<code class="fe na nb nc nd b">epsilon</code>等于<code class="fe na nb nc nd b">target — pressure</code>，其中目标代表由用户设置的理想压力。现在<code class="fe na nb nc nd b">gamma</code>，也就是衍生项的权重，总是被组织者设置为零。所以我们只需要关注第一项(比例)和第二项(积分)。我们之前讨论的后处理技术实际上对应于这个等式，其中<code class="fe na nb nc nd b">beta</code>设置为0。为了便于记记，让我们重写第二个积分项。此外，积分项通过如下重量衰减实现:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ny"><img src="../Images/b69ba1df957b77b39a53a9a349257f70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_emMEbtmkIGJs9bq.png"/></div></div></figure><p id="65ba" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">时间步长t和t-1之间的时间差τ为常数，对于该数据等于0.5。我们可以从PID方程中分离出积分项，以便计算任意时间点的积分项。这避免了必须在整个信号中传播:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi nz"><img src="../Images/0b6f4c62e8a914807ee2c50e87f4cd90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OoBG2tv_aCN_su9J.png"/></div></div></figure><p id="54cf" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">有了这些等式，我们就可以开始匹配算法了。对于给定的参数配置(target、alpha和beta或在本文的剩余部分分别称为<strong class="ld ja"> kt、kp和ki </strong>),我们的匹配算法在时间步长<code class="fe na nb nc nd b">t</code>填充给定呼吸的压力如下:</p><ol class=""><li id="879d" class="oa ob iq ld b le lf lh li lk oc lo od ls oe lw of og oh oi bi translated">取两个随机压力值<code class="fe na nb nc nd b">P0</code>和<code class="fe na nb nc nd b">P1</code>。有950种可能的压力值，因此有950*950种可能的组合。</li><li id="2307" class="oa ob iq ld b le oj lh ok lk ol lo om ls on lw of og oh oi bi translated">计算<code class="fe na nb nc nd b">I0 = (u_in[t - 1] - kp * (kt - P0))/ki</code></li><li id="b436" class="oa ob iq ld b le oj lh ok lk ol lo om ls on lw of og oh oi bi translated">计算<code class="fe na nb nc nd b">I1 = I0 + (kt - P1 - I0) * (dt / (dt + 0.5))</code></li><li id="f09f" class="oa ob iq ld b le oj lh ok lk ol lo om ls on lw of og oh oi bi translated">如果<code class="fe na nb nc nd b">kp * (kt - P1) + ki * I1 == u_in[t]</code>我们有一个匹配，我们可以填写P1压力[t]</li></ol><p id="1e62" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">在代码中:</p><pre class="kp kq kr ks gt nf nd ng nh aw ni bi"><span id="facb" class="nj md iq nd b gy nk nl l nm nn">P_RANGE = np.arange(<br/>  MIN_PRESSURE, <br/>  MAX_PRESSURE + DIFF_PRESSURE, <br/>  DIFF_PRESSURE<br/>)<br/>for P0 in P_RANGE:<br/>    for P1 in P_RANGE:<br/>        I0 = (u_in[t - 1] - kp * (kt - P0))/ki<br/>        I1 = I0 + (kt - P1 - I0) * (dt / (dt + 0.5))<br/>        u_in_hat = kp * (kt - P1) + ki * I1<br/>        if abs(u_in_hat - u_in[t]) &lt; 1e-8:<br/>            print(P0, P1, pressure[t-1:t+1])</span></pre><p id="0824" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">然而，这个代码<strong class="ld ja">相当慢</strong>。这是因为对于每个可能的参数组合，需要尝试950*950个组合。kp和ki有20个可能的值，kt有6个可能的值，因此总共有950*950*20*20*6个可能的组合。然而，对于固定的<code class="fe na nb nc nd b">P0</code>,我们注意到<code class="fe na nb nc nd b">abs(u_in_hat — u_in[t])</code>在for循环中线性增长。因此，我们可以通过两次测量来推断。如果这个外推函数与x轴的交集出现在一个整数处(或接近于一个整数)，那么我们的If条件在内部for循环的迭代中将被评估为True。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi oo"><img src="../Images/6695c16fe871cb3293f1f9c7a3462275.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-V1U4NZFkOimZ--6.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><p id="0e7a" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">这种观察使我们可以将代码加速950倍。</p><pre class="kp kq kr ks gt nf nd ng nh aw ni bi"><span id="9a9a" class="nj md iq nd b gy nk nl l nm nn">for P0 in P_RANGE:<br/>    I0 = (u_in[t - 1] - kp * (kt - P0))/ki<br/>    <br/>    # Calculate 2 points for P1 so we can get the slope<br/>    I11 = I0 + (kt - MIN_PRESSURE - I0) * (dt / (dt + 0.5))<br/>    u_in_hat1 = kp * (kt - MIN_PRESSURE) + ki * I11<br/>    <br/>    I12 = I0 + (kt - MIN_PRESSURE2 - I0) * (dt / (dt + 0.5))<br/>    u_in_hat2 = kp * (kt - MIN_PRESSURE2) + ki * I12<br/>    <br/>    slope = u_in_hat2 - u_in_hat1<br/>    x_intersect = (u_in[t] - u_in_hat2) / slope<br/>    if abs(np.round(x_intersect) - x_intersect) &lt; 1e-8:<br/>        print(P0, MIN_PRESSURE + (x_intersect + 1) * DIFF_PRESSURE)</span></pre><h1 id="a7ec" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">开大声点！带来噪音！</h1><p id="18a3" class="pw-post-body-paragraph lb lc iq ld b le mu ka lg lh mv kd lj lk mw lm ln lo mx lq lr ls my lu lv lw ij bi translated">有了上面的代码，我们能够匹配很多压力。但他们中的许多人仍然无法匹敌。在组织者的论文中，有人解释说u_in数据中加入了人为噪声。我们开始努力消除这种噪音。让我们首先看看当前版本的匹配算法对特定呼吸(训练呼吸id 17)的输出</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ne"><img src="../Images/365754d8d847d51b46c72b6dc88fff6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rWXXkz3yMlwqQgen.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><p id="f659" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">注意，u_in的第一个值和中间的一些值并不完全匹配。所有呼吸的第一个值都有噪声，不可匹配，但中间的点应该是可匹配的…让我们从索引5开始，根据提供的压力调用我们的generate_u_in代码，以生成“理想u_in值”,并从提供给我们的u_in中减去这个值。</p><pre class="kp kq kr ks gt nf nd ng nh aw ni bi"><span id="8637" class="nj md iq nd b gy nk nl l nm nn">kp, ki, kt = 1., 3., 30<br/>I5 = (u_in[4] - kp * (kt - pressure[4]))/ki<br/>u_in_hat = generate_u_in(pressure[5:], timestep[4:], kp, ki, kt, integral=I5)<br/>noise = u_in[5:32] - u_in_hat[:-5]<br/>plt.plot(timestep[5:32], noise, '-o')<br/>plt.title('noise')<br/>plt.show()</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi op"><img src="../Images/9a5ebb4675ff4b62fd5bcb9d77fa0b6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:754/format:webp/0*lIpncrwMIBCM0fWr.png"/></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><p id="cec8" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">理想u_in值和提供的u_in值之间的差值形成一个漂亮的三角形，除了在三角形的转折点/峰值上。关键是这个噪声的斜率(<code class="fe na nb nc nd b">(np.diff(noise) / np.diff(timestep[5:32]))</code>)对于这个三角形上的连续点是相等的。我们也可以重新编写积分计算向后工作。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi oq"><img src="../Images/16ae16d2041957f3b6d1e2156b4670f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6UlkIcbZ5zhp89iA.png"/></div></div></figure><p id="9739" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">有了这两种见解，我们能够匹配更多的数据:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ne"><img src="../Images/6c014837471e48d8f9b584d4fa87597f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eeMa_Ux9vFiXcIVk.png"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated">作者图片</p></figure><h1 id="a079" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">把它放在一起</h1><p id="de19" class="pw-post-body-paragraph lb lc iq ld b le mu ka lg lh mv kd lj lk mw lm ln lo mx lq lr ls my lu lv lw ij bi translated">给定我们的DL模型和匹配算法，我们的方法相当简单:</p><ol class=""><li id="512a" class="oa ob iq ld b le lf lh li lk oc lo od ls oe lw of og oh oi bi translated">用我们的两个DL模型生成预测。训练他们在多个种子进行10重交叉验证。这为我们提供了多个略有不同的模型。将这些模型的(加权)中值作为一种集成技术，因为当MAE是度量标准时，这通常优于平均值。</li><li id="af5f" class="oa ob iq ld b le oj lh ok lk ol lo om ls on lw of og oh oi bi translated">根据这些预测，应用我们的匹配算法。如果我们找到匹配，用匹配器替换DL算法的预测。如果不匹配，则保留DL预测。</li></ol><p id="81cf" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">总的来说，我们能够大致匹配66%的数据，这给了我们<strong class="ld ja">在排行榜上巨大的</strong>提升。</p><h1 id="6a54" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">结束营业的时间</h1><p id="b07d" class="pw-post-body-paragraph lb lc iq ld b le mu ka lg lh mv kd lj lk mw lm ln lo mx lq lr ls my lu lv lw ij bi translated">这是我在卡格尔的第一次胜利。虽然我承认PID控制器匹配有点厚脸皮，但我仍然对我们的结果感到非常自豪，因为2650个团队中只有2个能够找到这个漏洞。此外，我们是唯一能够在u_in数据中匹配噪声的团队。我要感谢我的队友们<a class="ae la" href="https://www.kaggle.com/zidmie" rel="noopener ugc nofollow" target="_blank">兹德米</a>、<a class="ae la" href="https://www.kaggle.com/khahuras" rel="noopener ugc nofollow" target="_blank">卡</a>、<a class="ae la" href="https://www.kaggle.com/shujun717" rel="noopener ugc nofollow" target="_blank">舒军</a>和<a class="ae la" href="https://www.kaggle.com/callmeb" rel="noopener ugc nofollow" target="_blank"> B </a>，没有他们，这个结果是不可能的！</p><p id="dfc9" class="pw-post-body-paragraph lb lc iq ld b le lf ka lg lh li kd lj lk ll lm ln lo lp lq lr ls lt lu lv lw ij bi translated">如果你有任何问题或不清楚的地方，随时留下一些评论或通过其他媒介与我联系(双关语)。</p><h1 id="c17f" class="mc md iq bd me mf mg mh mi mj mk ml mm kf mn kg mo ki mp kj mq kl mr km ms mt bi translated">参考</h1><ol class=""><li id="a1cc" class="oa ob iq ld b le mu lh mv lk or lo os ls ot lw of og oh oi bi translated"><a class="ae la" href="https://arxiv.org/abs/2102.06779" rel="noopener ugc nofollow" target="_blank">主办方论文</a></li><li id="8af7" class="oa ob iq ld b le oj lh ok lk ol lo om ls on lw of og oh oi bi translated"><a class="ae la" href="https://www.kaggle.com/c/ventilator-pressure-prediction/discussion/285256" rel="noopener ugc nofollow" target="_blank"> Kaggle论坛报道</a></li><li id="b6ee" class="oa ob iq ld b le oj lh ok lk ol lo om ls on lw of og oh oi bi translated"><a class="ae la" href="https://www.kaggle.com/group16/1-solution-pid-controller-matching-v1" rel="noopener ugc nofollow" target="_blank"> PID匹配代码+解释</a> (Kaggle)</li><li id="14cf" class="oa ob iq ld b le oj lh ok lk ol lo om ls on lw of og oh oi bi translated"><a class="ae la" href="https://github.com/GillesVandewiele/google-brain-ventilator" rel="noopener ugc nofollow" target="_blank"> PID匹配代码+解释(Github) </a></li><li id="0aa8" class="oa ob iq ld b le oj lh ok lk ol lo om ls on lw of og oh oi bi translated"><a class="ae la" href="https://www.kaggle.com/shujun717/1-solution-lstm-cnn-transformer-1-fold" rel="noopener ugc nofollow" target="_blank"> LSTM + CNN变压器代码(Kaggle) </a></li><li id="e88c" class="oa ob iq ld b le oj lh ok lk ol lo om ls on lw of og oh oi bi translated"><a class="ae la" href="https://github.com/Shujun-He/Google-Brain-Ventilator" rel="noopener ugc nofollow" target="_blank"> LSTM + CNN变压器代码(Github) </a></li><li id="e80a" class="oa ob iq ld b le oj lh ok lk ol lo om ls on lw of og oh oi bi translated"><a class="ae la" href="https://github.com/whoknowsB/google-brain-ventilator-pressure-prediction" rel="noopener ugc nofollow" target="_blank"> LSTM原始数据代码(Github) </a></li></ol></div></div>    
</body>
</html>