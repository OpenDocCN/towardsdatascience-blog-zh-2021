<html>
<head>
<title>Handling chatbot failure gracefully</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">优雅地处理聊天机器人故障</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/handling-chatbot-failure-gracefully-466f0fb1dcc5?source=collection_archive---------3-----------------------#2021-12-22">https://towardsdatascience.com/handling-chatbot-failure-gracefully-466f0fb1dcc5?source=collection_archive---------3-----------------------#2021-12-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9ec5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">用 Rasa 构建聊天机器人——第三部分</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c2b65b30da3b939e0a6be18941b5b993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4sUdjaqjBkpwHSxFJNaLpQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="2d54" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">不管你训练 Rasa 聊天机器人有多好，总会有机器人不知道如何处理的情况。我们的目标不是制造一个完美的防故障聊天机器人，因为这甚至是不可能的。事实上，作为人类，我们自己也经常要求澄清。更确切地说，我们的目标是在事情变糟时让系统就位。</p><p id="2ab4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">比起被误解，人们更喜欢被要求澄清。当然，要求用户重复五次并不理想，这也是为什么要有后备系统的原因。</p><p id="f690" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在本帖中，我们将讨论如何处理你的机器人不太明白用户想说什么的情况。在 Rasa 术语中，这被称为回退。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="8638" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">快速注释</strong></p><p id="9d68" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是我关于 Rasa 系列的下一篇文章。您可以查看以下系列的前几篇文章:</p><div class="ly lz gp gr ma mb"><a rel="noopener follow" target="_blank" href="/building-a-chatbot-with-rasa-3f03ecc5b324"><div class="mc ab fo"><div class="md ab me cl cj mf"><h2 class="bd ir gy z fp mg fr fs mh fu fw ip bi translated">用 Rasa 构建聊天机器人</h2><div class="mi l"><h3 class="bd b gy z fp mg fr fs mh fu fw dk translated">开始—第一部分</h3></div><div class="mj l"><p class="bd b dl z fp mg fr fs mh fu fw dk translated">towardsdatascience.com</p></div></div><div class="mk l"><div class="ml l mm mn mo mk mp kp mb"/></div></div></a></div><div class="ly lz gp gr ma mb"><a rel="noopener follow" target="_blank" href="/are-slots-and-entities-the-same-f98a38ac328d"><div class="mc ab fo"><div class="md ab me cl cj mf"><h2 class="bd ir gy z fp mg fr fs mh fu fw ip bi translated">插槽和实体是一样的吗？</h2><div class="mi l"><h3 class="bd b gy z fp mg fr fs mh fu fw dk translated">用 Rasa 构建聊天机器人—第二部分</h3></div><div class="mj l"><p class="bd b dl z fp mg fr fs mh fu fw dk translated">towardsdatascience.com</p></div></div><div class="mk l"><div class="mq l mm mn mo mk mp kp mb"/></div></div></a></div><p id="527c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在那里，我们讨论了 Rasa 和聊天机器人的基本组成部分，如果你是 Rasa 新手，通读前两篇文章肯定会有所帮助。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="2d38" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">目录</h2><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="50d2" class="mr ms iq nl b gy np nq l nr ns">- An example<br/>- The Fallback Classifier<br/>- Simple Fallback<br/>- Single-stage Fallback<br/>- Two-stage Fallback<br/>- Handling Human Handoff</span></pre></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="3d40" class="nt ms iq bd mt nu nv nw mw nx ny nz mz jw oa jx nc jz ob ka nf kc oc kd ni od bi translated">一个例子</h1><p id="ae3b" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">我们将看一个没有后备机制的简单例子，然后我们将从那里开始。</p><p id="a443" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们继续使用本系列中使用的聊天机器人——它要求用户提供联系信息。我们将通过减少我们的<code class="fe oj ok ol nl b">DIETClassifier</code>的训练次数来模拟回退场景，它试图理解用户在说什么。</p><p id="3600" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">缺省情况下，缺省配置文件(运行 rasa init 时获得)有一个<code class="fe oj ok ol nl b">FallbackClassifier</code>组件。我们将在这里做两处更改:</p><ul class=""><li id="8adf" class="om on iq kx b ky kz lb lc le oo li op lm oq lq or os ot ou bi translated">我们将删除<code class="fe oj ok ol nl b">FallbackClassifier</code>组件，看看会发生什么。</li><li id="7d0f" class="om on iq kx b ky ov lb ow le ox li oy lm oz lq or os ot ou bi translated">我们也将减少<code class="fe oj ok ol nl b">DIETClassifier</code>到<code class="fe oj ok ol nl b">2</code>的训练周期，所以模拟一个难以察觉的短语。</li></ul><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="beb5" class="mr ms iq nl b gy np nq l nr ns">language: en</span><span id="77eb" class="mr ms iq nl b gy pa nq l nr ns">pipeline:<br/>- name: WhitespaceTokenizer<br/>- name: RegexFeaturizer<br/>- name: LexicalSyntacticFeaturizer<br/>- name: CountVectorsFeaturizer<br/>- name: CountVectorsFeaturizer<br/>  analyzer: char_wb<br/>  min_ngram: 1<br/>  max_ngram: 4<br/>- name: DIETClassifier<br/>  <strong class="nl ir">epochs: 2 # reduced epochs</strong><br/>  constrain_similarities: true<br/>- name: EntitySynonymMapper<br/>- name: ResponseSelector<br/>  epochs: 100<br/>  constrain_similarities: true<br/><strong class="nl ir"># removed the FallbackClassifier from here</strong></span><span id="2731" class="mr ms iq nl b gy pa nq l nr ns">policies:<br/>- name: MemoizationPolicy<br/>- name: TEDPolicy<br/>  max_history: 5<br/>  epochs: 100<br/>  constrain_similarities: true<br/>- name: RulePolicy</span></pre><p id="3a3d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">训练完机器人后，我们将使用</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="170f" class="mr ms iq nl b gy np nq l nr ns">rasa shell --debug</span></pre><p id="ee31" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对话大概是这样的:</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="0b32" class="mr ms iq nl b gy np nq l nr ns">user: Hi<br/>bot: Sorry, you'll have to provide your information to proceed.</span></pre><p id="ae79" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这完全没有意义。仔细查看调试日志，我们看到了以下内容:</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="ae00" class="mr ms iq nl b gy np nq l nr ns">Received user message 'hi' with intent '{'id': -4215159201959237708, 'name': 'deny', 'confidence': 0.37452369928359985}' and entities '[]'</span></pre><p id="9a3e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">机器人预测用户的消息“嗨”是一个<code class="fe oj ok ol nl b">deny</code>意图，而不是<code class="fe oj ok ol nl b">greet</code>意图。机器人的响应可能会让用户感到困惑，这在实际项目中会更加明显，在实际项目中，您通常会有许多意图和大量数据，在某些情况下，这些数据可能会有点相似。</p><p id="6909" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，让我们看看当我们只在配置中包含<code class="fe oj ok ol nl b">FallbackClassifier</code>而没有实际设置整个机制时会发生什么。</p><p id="5c3a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">添加到管道末端:</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="1bd8" class="mr ms iq nl b gy np nq l nr ns">- name: FallbackClassifier<br/>  threshold: 0.5<br/>  ambiguity_threshold: 0.1</span></pre><p id="8a2c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">和重新训练，当用户说“嗨”时，我们看到日志中的变化:</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="5523" class="mr ms iq nl b gy np nq l nr ns">Received user message 'hi' with intent '{'name': 'nlu_fallback', 'confidence': 0.5}' and entities '[]'</span></pre><p id="4cfa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它不再预测具有最高置信度的意图，即使它真的很低。现在，<code class="fe oj ok ol nl b">FallbackClassifier</code>用<code class="fe oj ok ol nl b">nlu_fallback</code>覆盖了这个意图。在我们继续回退机制之前，我们将讨论回退分类器。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="0b94" class="nt ms iq bd mt nu nv nw mw nx ny nz mz jw oa jx nc jz ob ka nf kc oc kd ni od bi translated">回退分类器</h1><p id="89e8" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">回退分类器实现两个阈值:</p><ul class=""><li id="f513" class="om on iq kx b ky kz lb lc le oo li op lm oq lq or os ot ou bi translated">民盟的退路<code class="fe oj ok ol nl b">threshold</code></li><li id="2045" class="om on iq kx b ky ov lb ow le ox li oy lm oz lq or os ot ou bi translated">而<code class="fe oj ok ol nl b">ambiguity_threshold</code></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/42188f55554f5b11589d379cd4944bb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dJxnCszasKsz2oN-fRmSQg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">后退分类器阈值-按作者分类的图像</p></figure><p id="5338" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在您的配置文件中，它是在意图分类器之后定义的，如下所示:</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="d398" class="mr ms iq nl b gy np nq l nr ns">language: en<br/>pipeline:<br/>   ..<br/>   ..<br/>   # intent classifier like DIETClassifier defined here<br/>   - name: FallbackClassifier<br/>         threshold: 0.7<br/>         ambiguity_threshold: 0.1</span></pre><h2 id="ba11" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">(NLU 回退)阈值</h2><p id="4945" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated"><code class="fe oj ok ol nl b">threshold</code>键用于指定<code class="fe oj ok ol nl b">config.yml</code>中 NLU 回退的阈值。如果 top intent 的置信度低于这个值，则回退分类器忽略它并继续进行<code class="fe oj ok ol nl b">nlu_fallback</code>。</p><h2 id="806b" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">模糊阈值</h2><p id="34b2" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">该键指定了前两个意图的置信度应该是多少，以继续常规对话流。如果置信度得分的差值比这里指定的值少<strong class="kx ir">或</strong>，则不管是否满足<code class="fe oj ok ol nl b">threshold</code>条件，回退分类器都使用<code class="fe oj ok ol nl b">nlu_fallback</code>。</p><h1 id="06bf" class="nt ms iq bd mt nu pc nw mw nx pd nz mz jw pe jx nc jz pf ka nf kc pg kd ni od bi translated">简单的退路</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/33f02cfd263a128b4a6ba3d154b26965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ia42UyRd4HkcCmJqojIr3w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">简单的退路——作者图片</p></figure><p id="19d4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这种回退是最基本的:当你的机器人预测用户的意图低于某个阈值(<code class="fe oj ok ol nl b">nlu_fallback_threshold</code>)时，我们将简单地将聊天转移到一个人类代理。</p><p id="2249" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，将聊天转移到人工代理的实际机制，称为“人工移交”，取决于您的聊天机器人部署的方式和位置。为了让这适用于每个人，我们将创建一个占位符自定义动作，该动作将返回一个<code class="fe oj ok ol nl b">transferred_to_human</code>标志，只是为了让我们知道它正在工作。</p><p id="0d78" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们来实施吧。</p><h2 id="9d6d" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">添加规则</h2><p id="4a32" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">我们首先需要定义一个<code class="fe oj ok ol nl b">rule</code>，每当<code class="fe oj ok ol nl b">nlu_fallback</code>被预测时，运行<code class="fe oj ok ol nl b">action_default_fallback</code>。将此添加到<code class="fe oj ok ol nl b">rules.yml</code>:</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="087b" class="mr ms iq nl b gy np nq l nr ns"># simple fallback:<br/>- rule: Implementation of the simple-Fallback<br/>  steps:<br/>  - intent: nlu_fallback<br/>  - action: action_default_fallback</span></pre><h2 id="d085" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">履行</h2><p id="cf42" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">接下来，我们将覆盖<code class="fe oj ok ol nl b">action_default_fallback</code>。简单地将这个类添加到<code class="fe oj ok ol nl b">actions.py</code>:</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="7942" class="mr ms iq nl b gy np nq l nr ns">class ActionDefaultFallback(Action):</span><span id="b461" class="mr ms iq nl b gy pa nq l nr ns">def name(self) -&gt; Text:<br/>        return "action_default_fallback"</span><span id="2d13" class="mr ms iq nl b gy pa nq l nr ns">def run(self, dispatcher, tracker, domain):<br/>        # output a message saying that the conversation will now be<br/>        # continued by a human.<br/> <br/><strong class="nl ir">        message = "Sorry! Let me connect you to a human..."<br/>        dispatcher.utter_message(text=message)</strong></span><span id="829c" class="mr ms iq nl b gy pa nq l nr ns"># pause tracker<br/>        # undo last user interaction<br/>        return [ConversationPaused(), UserUtteranceReverted()]</span></pre><p id="b4f8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们还将在<code class="fe oj ok ol nl b">actions</code>字段下的域中定义它。</p><h2 id="3a70" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">测试</h2><p id="83b3" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">我们现在有了更好的体验。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="7816" class="mr ms iq nl b gy np nq l nr ns">user: Hi<br/>bot: Sorry, couldn't understand that! Let me connect you to a    <br/>     human...</span></pre><p id="9dd0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请记住，经过适当训练的机器人几乎肯定能够对“嗨”做出反应。在这里，我们只是模拟一个机器人无法理解的用户消息。</p><p id="df38" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您查看日志，可以看到 Rasa 正确地应用了我们定义的规则。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="ac85" class="mr ms iq nl b gy np nq l nr ns"><strong class="nl ir">rasa.core.policies.rule_policy -</strong> There is a rule for the next action 'action_default_fallback'.</span></pre><h1 id="f682" class="nt ms iq bd mt nu pc nw mw nx pd nz mz jw pe jx nc jz pf ka nf kc pg kd ni od bi translated">单阶段回退</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/655d57706e8b44592806b18da3c37420.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J5wlHrxce0lnnpxq9V3EGQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">单阶段回退机制—图片由作者提供</p></figure><p id="dbd3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">简单的退路比继续进行几乎肯定会失败的对话要好。</p><p id="fa7c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">但是我们可以做得更好。如果你的机器人不太确定用户想说什么，我们可以让机器人通过提供建议来澄清用户的意思，而不是仅仅执行移交。</p><p id="9624" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当然，即使在这之后，如果机器人仍然没有得到用户想要说的话，我们可以进行切换。</p><p id="41fe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这将更加有用，因为</p><ul class=""><li id="b076" class="om on iq kx b ky kz lb lc le oo li op lm oq lq or os ot ou bi translated">它减轻了人类的负担</li><li id="54cc" class="om on iq kx b ky ov lb ow le ox li oy lm oz lq or os ot ou bi translated">它让用户参与的时间更长，因为如果目前没有人可用，他们很可能没有耐心等待。</li></ul><p id="747c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">默认情况下，当请求澄清时，机器人会以最高的可信度暗示意图。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ph pi l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">The utter_ask_rephrase response —图片作者使用 carbon.now.sh</p></figure><p id="e8f4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可能会注意到这里有两件事:</p><ul class=""><li id="eb92" class="om on iq kx b ky kz lb lc le oo li op lm oq lq or os ot ou bi translated">仅建议最高意图，而不是提供，比如说，前 3 个预测</li><li id="ef5a" class="om on iq kx b ky ov lb ow le ox li oy lm oz lq or os ot ou bi translated">使用 NLU 定义的意向名称。对用户来说不是一个很好的体验，特别是对于那些有更多隐晦措辞的意图。</li></ul><p id="c9a6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以通过覆盖一个叫做<code class="fe oj ok ol nl b">action_default_ask_affirmation</code>的方法来解决这两个问题。</p><p id="b3ac" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们实现这一点。</p><h2 id="2989" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">添加相关规则</h2><p id="54fe" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">这比前一个案子要复杂一点。我们将在这里定义两条规则。</p><p id="a09a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> nlu_fallback →向用户提供建议</strong></p><p id="790a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦机器人无法理解用户，它将提供用户可能想要表达的意思的相关建议。这里，我们将执行被覆盖的<code class="fe oj ok ol nl b">action_default_ask_affirmation</code>自定义动作，稍后我们将实现它。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="e445" class="mr ms iq nl b gy np nq l nr ns">- rule: Single stage fallback | ask user to choose what they meant<br/>  steps:<br/>  - intent: nlu_fallback<br/>  - action: action_default_ask_affirmation</span></pre><p id="e710" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">用户不喜欢建议→人工交接</strong></p><p id="dcb0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">第二个规则是当用户不想继续任何提供的建议并点击一个类似“这些都不要”的选项时(我们也将实现这个选项)。它被映射到默认的<code class="fe oj ok ol nl b">out_of_scope</code>意图。</p><p id="c4c2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当这种情况发生时，我们希望将用户直接连接到人，所以我们将调用<code class="fe oj ok ol nl b">action_default_fallback</code>。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="94d4" class="mr ms iq nl b gy np nq l nr ns">- rule: Single stage fallback | call default fallback if user is not ok<br/>  steps:<br/>  - action: action_default_ask_affirmation<br/>  - intent: out_of_scope<br/>  - action: action_default_fallback</span></pre><h2 id="a68a" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">覆盖默认确认自定义操作</h2><p id="7868" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">我们将做两件事来解决上面提到的问题:</p><ul class=""><li id="fdb0" class="om on iq kx b ky kz lb lc le oo li op lm oq lq or os ot ou bi translated">在意图和易读的措辞之间建立一个映射。类似于:<code class="fe oj ok ol nl b">supply_contact_info --&gt; "Supply Contact Information"</code></li><li id="3b39" class="om on iq kx b ky ov lb ow le ox li oy lm oz lq or os ot ou bi translated">向用户提供前三个意向预测作为建议，而不仅仅是前一个，这样用户更有可能找到他们想要的。</li></ul><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="edb4" class="mr ms iq nl b gy np nq l nr ns">class ActionDefaultAskAffirmation(Action):</span><span id="a529" class="mr ms iq nl b gy pa nq l nr ns">def name(self):<br/>        return "action_default_ask_affirmation"</span><span id="e595" class="mr ms iq nl b gy pa nq l nr ns">async def run(self, dispatcher, tracker, domain):<br/><strong class="nl ir">        # select the top three intents from the tracker</strong>        <br/>        <strong class="nl ir"># ignore the first one -- nlu fallback</strong><br/>        predicted_intents = tracker.latest_message["intent_ranking"][1:4]</span><span id="ec5a" class="mr ms iq nl b gy pa nq l nr ns"><strong class="nl ir"># A prompt asking the user to select an option</strong><br/>        message = "Sorry! What do you want to do?"</span><span id="0fb9" class="mr ms iq nl b gy pa nq l nr ns"><strong class="nl ir"># a mapping between intents and user friendly wordings<br/></strong>        intent_mappings = {<br/>            "supply_contact_info": "Supply Contact Information",<br/>            "affirm": "Agree",<br/>            "deny": "Disagree",<br/>            "goodbye": "End conversation"<br/>        }</span><span id="1ce5" class="mr ms iq nl b gy pa nq l nr ns"><strong class="nl ir"># show the top three intents as buttons to the user</strong><br/>        buttons = [<br/>            {<br/>                "title": intent_mappings[intent['name']],<br/>                "payload": "/{}".format(intent['name'])<br/>            }<br/>            for intent in predicted_intents<br/>        ]</span><span id="c98a" class="mr ms iq nl b gy pa nq l nr ns"><strong class="nl ir"># add a "none of these button", if the user doesn't<br/>        # agree when any suggestion</strong><br/>        buttons.append({<br/>            "title": "None of These",<br/>            "payload": "/out_of_scope"<br/>        })</span><span id="4c74" class="mr ms iq nl b gy pa nq l nr ns">dispatcher.utter_message(text=message, buttons=buttons)</span><span id="a1fc" class="mr ms iq nl b gy pa nq l nr ns">return []</span></pre><blockquote class="pj pk pl"><p id="123e" class="kv kw pm kx b ky kz jr la lb lc ju ld pn lf lg lh po lj lk ll pp ln lo lp lq ij bi translated"><strong class="kx ir">注意</strong>对于某些意图，您可能不希望它们作为建议出现。“你想问候我吗？”听起来不错。如果这样的意图是前三个中的一个，可以添加一个简单的检查来确保用户不会把它看作是一个建议。</p></blockquote><p id="e01e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">记得将<code class="fe oj ok ol nl b">action_default_ask_affirmation</code>作为注册动作添加到您的域中。</p><h2 id="4bfd" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">测试</h2><p id="3945" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">我们将尝试与之前相同的对话流程。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ph pi l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">测试单级回退机制—图片由作者使用 carbon.now.sh 提供</p></figure><p id="6874" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这比以前好多了。现在让我们尝试第三种策略。</p><h1 id="661a" class="nt ms iq bd mt nu pc nw mw nx pd nz mz jw pe jx nc jz pf ka nf kc pg kd ni od bi translated">两阶段回退</h1><p id="26c6" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">两阶段回退是最近才引入的。它让用户两次阐明自己(通过向他们建议可能的行动),然后开始最终的后退。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/2bbdd28a3f6242c861e5d7cbe5d8f20c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z7BdpGOBrH_yiJluSqqbDA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">两阶段回退机制—作者图片</p></figure><p id="efbc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">虽然看起来很复杂，但是 Rasa 已经实现了，所以设置起来要容易得多，特别是因为我们已经用前两种方法完成了一半的工作。</p><h2 id="a67f" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">添加要求用户重新措辞的响应</h2><p id="9bdc" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">Rasa 提供了名为<code class="fe oj ok ol nl b">utter_ask_rephrase</code>的默认响应。当然，还有一个名为<code class="fe oj ok ol nl b">action_default_ask_rephrase</code>的默认自定义动作，您可以覆盖它来实现自定义行为，就像我们之前对<code class="fe oj ok ol nl b">action_default_fallback</code>和<code class="fe oj ok ol nl b">action_default_ask_affirmation</code>所做的那样。</p><p id="29d6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，我们将只使用响应。我们将在<code class="fe oj ok ol nl b">domain.yml</code>的<code class="fe oj ok ol nl b">responses</code>字段下定义它。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="2fcd" class="mr ms iq nl b gy np nq l nr ns">utter_ask_rephrase:<br/>  - text: I'm sorry, I didn't quite understand that. Could you rephrase?</span></pre><h2 id="12be" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">添加两阶段回退规则</h2><p id="c855" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">我们将用这个替换以前的单阶段回退方法的规则。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="2548" class="mr ms iq nl b gy np nq l nr ns"># two stage fallback:<br/>- rule: Implementation of the Two-Stage-Fallback<br/>  steps:<br/>  - intent: nlu_fallback<br/>  - action: action_two_stage_fallback<br/>  - active_loop: action_two_stage_fallback</span></pre><p id="ae1f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">没有必要进行其他更改。</p><h2 id="b9be" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">测试</h2><p id="a171" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">流程是这样的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ph pi l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">测试两阶段回退策略—图片由作者使用 carbon.now.sh 提供</p></figure><h1 id="fddc" class="nt ms iq bd mt nu pc nw mw nx pd nz mz jw pe jx nc jz pf ka nf kc pg kd ni od bi translated">当人工交接不成功时你会怎么做？</h1><p id="0fbb" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">有时，即使在用户多次澄清后，你的机器人可能不明白他们想说什么。在这种情况下，明智的做法是让用户知道他们现在将连接到一个人，然后将对话转移到一个人可以访问的地方。</p><p id="c7bf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">发送跟踪器和帮助，因为人类现在已经有了对话的上下文，这意味着用户不必从头开始他们的请求。</p><p id="0032" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">即使在这之后，也可能没有人来照顾这个用户。可能用户处于不同的时区，或者所有客户服务代理都被占用。有时，将用户连接到代理的机制可能会中断。在这种情况下，与其让用户等待不知道如何继续，不如通知他们这个问题是有意义的。</p><p id="af9c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">除了一条简单的消息，说明人工代理目前不可用，以及一些功能，让用户留下消息或提供他们的联系方式，以便以后可以联系到他们。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="2e86" class="nt ms iq bd mt nu nv nw mw nx ny nz mz jw oa jx nc jz ob ka nf kc oc kd ni od bi translated">示例代码</h1><div class="ly lz gp gr ma mb"><a href="https://github.com/Polaris000/BlogCode/tree/main/FallbackExample" rel="noopener  ugc nofollow" target="_blank"><div class="mc ab fo"><div class="md ab me cl cj mf"><h2 class="bd ir gy z fp mg fr fs mh fu fw ip bi translated">blog code/fallback 示例 Polaris000/BlogCode</h2><div class="mi l"><h3 class="bd b gy z fp mg fr fs mh fu fw dk translated">示例代码来自我在 Medium 和我的个人网站上的博客文章。-blog code/fallback main 上的示例…</h3></div><div class="mj l"><p class="bd b dl z fp mg fr fs mh fu fw dk translated">github.com</p></div></div><div class="mk l"><div class="pq l mm mn mo mk mp kp mb"/></div></div></a></div><h2 id="5877" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">该系列的其他文章(这是第三篇)</h2><blockquote class="pj pk pl"><p id="664f" class="kv kw pm kx b ky kz jr la lb lc ju ld pn lf lg lh po lj lk ll pp ln lo lp lq ij bi translated">第一部分:<a class="ae pr" rel="noopener" target="_blank" href="/building-a-chatbot-with-rasa-3f03ecc5b324">用 Rasa 构建聊天机器人</a></p><p id="6804" class="kv kw pm kx b ky kz jr la lb lc ju ld pn lf lg lh po lj lk ll pp ln lo lp lq ij bi translated">第二部分:<a class="ae pr" rel="noopener" target="_blank" href="/are-slots-and-entities-the-same-f98a38ac328d">槽和实体一样吗？</a></p><p id="817d" class="kv kw pm kx b ky kz jr la lb lc ju ld pn lf lg lh po lj lk ll pp ln lo lp lq ij bi translated">第四部分:<a class="ae pr" rel="noopener" target="_blank" href="/how-do-chatbots-understand-87227f9f96a7">聊天机器人是如何理解的？</a></p></blockquote></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="e421" class="nt ms iq bd mt nu nv nw mw nx ny nz mz jw oa jx nc jz ob ka nf kc oc kd ni od bi translated">结论</h1><p id="0724" class="pw-post-body-paragraph kv kw iq kx b ky oe jr la lb of ju ld le og lg lh li oh lk ll lm oi lo lp lq ij bi translated">不管你的机器人有多好，总会有机器人不理解用户想说什么的情况，尤其是在开发的早期。你可能有很好的数据来训练你的机器人，但它可能不代表真实用户会如何交谈。</p><p id="9ed9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在构建聊天机器人时，学习如何优雅地失败是很重要的。毕竟，即使作为人类，由于从语言到糟糕的网络质量等过多的沟通问题，我们也可能经常不得不这样做。</p><p id="c1a5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最终，我写这篇文章的目的是让你知道在为你的机器人设计后备策略时可能会发生什么。</p><p id="7713" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">希望有帮助！</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h2 id="35ef" class="mr ms iq bd mt mu mv dn mw mx my dp mz le na nb nc li nd ne nf lm ng nh ni nj bi translated">更新</h2><blockquote class="pj pk pl"><p id="3f83" class="kv kw pm kx b ky kz jr la lb lc ju ld pn lf lg lh po lj lk ll pp ln lo lp lq ij bi">20.3.2022</p></blockquote><p id="f014" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">添加到系列中其他帖子的链接</p></div></div>    
</body>
</html>