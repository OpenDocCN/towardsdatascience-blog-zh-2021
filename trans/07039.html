<html>
<head>
<title>Tips And Tricks: How To Fill Null Values in SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">提示和技巧:如何在SQL中填充空值</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tips-and-tricks-how-to-fill-null-values-in-sql-4fccb249df6f?source=collection_archive---------1-----------------------#2021-06-26">https://towardsdatascience.com/tips-and-tricks-how-to-fill-null-values-in-sql-4fccb249df6f?source=collection_archive---------1-----------------------#2021-06-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="4c55" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">SQL提示和技巧</h2><div class=""/><div class=""><h2 id="8f32" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">如何利用嵌套表和窗口函数来填充空值</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/9ac716fae253dd5b5b70e4bea3be4773.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PNh7hHPK2dYv6mfT"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">格伦·卡斯滕斯-彼得斯在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="8e50" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">当谈到数据分析时，你常常意识不到你错过了什么，直到你把它可视化。可视化中的巨大差距或向下的尖峰会向您显示数据缺失的确切位置，但这不是您想要向利益相关者传达的故事。</p><p id="910d" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">虽然一些可视化工具可以轻松地解决这些问题，但通常最好在数据源处处理，如果您需要在工具之外做进一步的分析，依靠viz工具来完成这项工作将不会派上用场。那么，我们如何在源代码中填充空值或缺失值呢？</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h2 id="9128" class="mi mj iq bd mk ml mm dn mn mo mp dp mq lo mr ms mt ls mu mv mw lw mx my mz iw bi translated">向下填充:简要说明和示例</h2><p id="08ba" class="pw-post-body-paragraph lf lg iq lh b li na ka lk ll nb kd ln lo nc lq lr ls nd lu lv lw ne ly lz ma ij bi translated">假设我们有一个类似于下面的表，名为<code class="fe nf ng nh ni b">inventory_log</code>,它记录了贵公司在每个年末的库存中有多少小部件:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/cfc7df75a08311c4de4b3da436602377.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*K3aG44nDa351cZRJWd-zng.png"/></div></figure><p id="9ffe" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">因为你的商店周末不营业，所以从周五到周一不会有库存变化，但这也意味着没有人计算库存并将该值输入到表中。</p><p id="e87e" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">假设从周五到周一库存数量没有变化是安全的，因此周六和周日的正确值应该是周五的值。为了做到这一点，我们应用一个叫做<strong class="lh ja"> <em class="nk">的工具向下填充</em> </strong>。向下填充就像它听起来的那样:只要有空值，我们就从它上面抓取最近的非空值来替换空值。</p><p id="2c44" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">Python中有许多特性(包括<code class="fe nf ng nh ni b">pandas.DataFrame.ffill()</code>函数)可以实现这一点，但是它们几乎总是比直接在数据库服务器上执行操作要慢。</p><p id="d6f9" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">既然我们已经全面研究了这个问题，让我们来理解如何在SQL中实现它。</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h2 id="076b" class="mi mj iq bd mk ml mm dn mn mo mp dp mq lo mr ms mt ls mu mv mw lw mx my mz iw bi translated">在SQL中向下填充</h2><p id="0a40" class="pw-post-body-paragraph lf lg iq lh b li na ka lk ll nb kd ln lo nc lq lr ls nd lu lv lw ne ly lz ma ij bi translated">使用上面的表作为样本数据，我们可以利用嵌套查询和窗口函数来替换空值。</p><p id="6d67" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">我们要做的第一件事是将具有null值的行分组，第一个非null值在它上面。我们可以利用一个窗口函数来计算日期中的<code class="fe nf ng nh ni b">inventory</code>列:</p><pre class="kp kq kr ks gt nl ni nm nn aw no bi"><span id="90ed" class="mi mj iq ni b gy np nq l nr ns">select date,<br/>       day_of_week,<br/>       inventory,<br/>       count(inventory) over (order by date) as _grp<br/>from inventory_log</span></pre><p id="9199" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">该查询将返回如下所示的表格:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nt"><img src="../Images/616161e8f5bf4185505edee6b32ecdb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i1RDuVrtqZUw9B6hCLScBw.png"/></div></div></figure><p id="b39b" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">好吧！这为我们提供了一个新的列，允许我们将null值与它们前面的第一个非null值组合在一起。现在下一步是为共享一个分组的每一行返回第一个值。幸运的是，<code class="fe nf ng nh ni b">first_value</code>窗口函数允许我们这样做。</p><p id="50ca" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">将这个函数应用到我们已经拥有的数据中，我们得到了这个查询:</p><pre class="kp kq kr ks gt nl ni nm nn aw no bi"><span id="2b01" class="mi mj iq ni b gy np nq l nr ns">with grouped_table as (<br/>   select date,<br/>          day_of_week,<br/>          inventory,<br/>          count(inventory) over (order by date) as _grp<br/>   from inventory_log<br/>)<br/>select date,<br/>       day_of_week,<br/>       inventory,<br/>       _grp,<br/>       first_value() over (partition by _grp order by date) as filled_inventory<br/>from grouped_table</span></pre><p id="436a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如果你想深入研究<code class="fe nf ng nh ni b">first_value</code>函数，你可以<a class="ae le" href="https://docs.microsoft.com/en-us/sql/t-sql/functions/first-value-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">查看这里的文档</a>，但是这个函数只是根据顺序返回分区的第一个值。</p><p id="16da" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">上面的查询给出了下表:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nu"><img src="../Images/d95c9cf4644a2188bfd8ccffa3c5ad7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_8BEeyZtEKbkaIp3rf1U8w.png"/></div></div></figure><p id="1e40" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">就是这样！我们现在有一个空值被前面的值替换的列。</p><p id="4826" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">因此，让我们将我们的查询放在一起:</p><pre class="kp kq kr ks gt nl ni nm nn aw no bi"><span id="e794" class="mi mj iq ni b gy np nq l nr ns">with grouped_table as (<br/>   select date,<br/>          day_of_week,<br/>          inventory,<br/>          count(inventory) over (order by date) as _grp<br/>   from inventory_log<br/>), final_table as(<br/>   select date,<br/>          day_of_week,<br/>          inventory,<br/>          _grp,<br/>          first_value() over (partition by _grp order by date) as<br/>              new_inventory<br/>    from grouped_table<br/>)<br/>select date,<br/>       day_of_week,<br/>       new_inventory<br/>from final_table</span></pre><p id="9f94" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">输出:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nv"><img src="../Images/d4368f640f271aee1bc4d41496262119.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2b_h_D8NpXz6TJdkEZv39w.png"/></div></div></figure><p id="ff38" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">注意:如果您有一个需要考虑多个维度/列的查询(在本例中可能是不同的商店位置)，只需将它们添加到<code class="fe nf ng nh ni b">grouped_table</code>子查询的<code class="fe nf ng nh ni b">count()</code>窗口函数的partition子句中。</p><p id="7e87" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">编码快乐！</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><p id="7623" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">如果你想看其他数据科学的技巧和诀窍，请查看我的文章<a class="ae le" rel="noopener" target="_blank" href="/upload-your-pandas-dataframe-to-your-database-10x-faster-eb6dc6609ddf">如何将你的熊猫数据帧加载到你的数据库快10倍</a>。请在下面的评论中让我知道你在做什么！</p></div></div>    
</body>
</html>