<html>
<head>
<title>Ingesting Historical Feature Data into SageMaker Feature Store</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将历史要素数据纳入SageMaker要素库</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ingesting-historical-feature-data-into-sagemaker-feature-store-5618e41a11e6?source=collection_archive---------13-----------------------#2021-04-23">https://towardsdatascience.com/ingesting-historical-feature-data-into-sagemaker-feature-store-5618e41a11e6?source=collection_archive---------13-----------------------#2021-04-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="521b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何通过直接写入S3来回填SageMaker离线功能库</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6e66db9b5d2ae12ff6c556e01ea89a79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oELPcvUsgjcOiskB"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">简·安东宁·科拉尔在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="13cb" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">这是怎么回事？</h1><p id="9b33" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><a class="ae kv" href="https://aws.amazon.com/sagemaker/feature-store/" rel="noopener ugc nofollow" target="_blank">亚马逊SageMaker功能商店</a>是一个完全托管的、专门构建的存储库，用于存储、更新、检索和共享机器学习(ML)功能。它于2020年12月在AWS re:Invent上推出，并迅速成为SageMaker家族中最受欢迎的服务之一。自从re:Invent以来，我交谈过的许多AWS客户都对SageMaker功能商店(SMFS)表示了兴趣。</p><p id="2d95" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">其中一些客户拥有历史特征数据，他们希望将其迁移到SMFS离线商店，该商店可以存储大量的特征数据，这些数据用于跟踪历史特征值，并为模型开发或批量应用创建训练/测试数据。</p><p id="f8fd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">将历史数据摄取到SMFS线下商店的一个主要挑战是，用户在使用摄取API时将被收费，即使他们只想回填历史数据。如果客户想要将数TB的数据迁移到SMFS，这些费用可能会快速增长。</p><p id="fa31" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在这篇博文中，我展示了如何将历史特征数据直接写入S3，它是SMFS线下商店的支柱。使用这种方法绕过了摄取API，大大节省了成本。</p><blockquote class="mp mq mr"><p id="32be" class="lo lp ms lq b lr mk jr lt lu ml ju lw mt mm lz ma mu mn md me mv mo mh mi mj ij bi translated">问:我来这里只是为了代码，在哪里可以找到它？</p><p id="b158" class="lo lp ms lq b lr mk jr lt lu ml ju lw mt mm lz ma mu mn md me mv mo mh mi mj ij bi translated">甲:<a class="ae kv" href="https://github.com/marshmellow77/sm-feature-store-backfill/" rel="noopener ugc nofollow" target="_blank">这里</a>你去:)</p></blockquote></div><div class="ab cl mw mx hu my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ij ik il im in"><h1 id="3418" class="kw kx iq bd ky kz nd lb lc ld ne lf lg jw nf jx li jz ng ka lk kc nh kd lm ln bi translated">快速估算成本</h1><p id="6cce" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><a class="ae kv" href="https://github.com/aws/amazon-sagemaker-examples/blob/master/sagemaker-featurestore/feature_store_introduction.ipynb" rel="noopener ugc nofollow" target="_blank">这款笔记本</a>是一个很好的例子，展示了如何使用专用摄取<a class="ae kv" href="https://sagemaker.readthedocs.io/en/stable/api/prep_data/feature_store.html#sagemaker.feature_store.feature_group.FeatureGroup.ingest" rel="noopener ugc nofollow" target="_blank"> API </a>将数据摄取到SMFS。根据<a class="ae kv" href="https://aws.amazon.com/sagemaker/pricing/" rel="noopener ugc nofollow" target="_blank">亚马逊SageMaker定价网站</a>，用户将被收取每百万写请求单位1.25美元的费用(这是针对地区<em class="ms">美国东弗吉尼亚州</em>——不同地区可能适用不同的费用)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/97c0607c907eb3b4b67e3d58884f159c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*jl4zVw89bQchuHuod1Lvaw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Sagemaker功能商店的定价</p></figure><p id="f54b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一个写入请求相当于1KB的数据，因此每1gb(= 100万KB)写入SMFS的成本为1.25美元。我曾与拥有数兆字节历史特征数据的客户交谈过，他们只想填充SMFS的线下商店。如果他们使用API回填这些数据，他们将被收取数千美元的费用。相比之下，<a class="ae kv" href="https://aws.amazon.com/s3/pricing/" rel="noopener ugc nofollow" target="_blank">将文件直接放入S3<strong class="lq ir">要比</strong>便宜</a>(在<em class="ms">美国东弗吉尼亚州</em>每1000个文件0.005美元)。</p></div><div class="ab cl mw mx hu my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ij ik il im in"><h1 id="962e" class="kw kx iq bd ky kz nd lb lc ld ne lf lg jw nf jx li jz ng ka lk kc nh kd lm ln bi translated">如何将要素数据直接写入S3</h1><p id="4f7b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">游戏计划很简单:我们将创建一个<a class="ae kv" href="https://docs.aws.amazon.com/sagemaker/latest/dg/feature-store-create-feature-group.html" rel="noopener ugc nofollow" target="_blank">特征组</a>，修改相应的数据集，并按照<a class="ae kv" href="https://docs.aws.amazon.com/sagemaker/latest/dg/feature-store-offline.html" rel="noopener ugc nofollow" target="_blank"> SMFS线下商店数据格式</a>直接保存在S3。因此，该数据集将在SMFS线下商店中提供。</p><h2 id="4f77" class="nj kx iq bd ky nk nl dn lc nm nn dp lg lx no np li mb nq nr lk mf ns nt lm nu bi translated">准备数据</h2><p id="58b1" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在这个练习中，我将使用一个代表信用卡交易的合成数据集。该数据集在SageMaker样本S3桶中公开提供:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="d4f6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一些列是类型为<em class="ms"> object </em>的，我们需要将它们转换为<em class="ms">字符串</em>，以便SMFS接受数据(参见<a class="ae kv" href="https://docs.aws.amazon.com/sagemaker/latest/dg/feature-store-quotas.html#feature-store-data-types" rel="noopener ugc nofollow" target="_blank">本页</a>了解SMFS支持的数据类型):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="f801" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">SMFS的每个数据集都需要每个数据点的时间戳。由于我们的数据集没有时间戳，我们需要手动添加它:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="9a85" class="nj kx iq bd ky nk nl dn lc nm nn dp lg lx no np li mb nq nr lk mf ns nt lm nu bi translated">创建功能组</h2><p id="e4ea" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">数据集现已准备就绪，我们可以创建相应的要素组了。为此，我们首先像这样定义特性组:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="02e4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在我们已经准备好创建特性组了。请注意，创建要素组不同于获取数据，并且不会产生费用。该功能组将被注册到SMFS，但它将保持为空，直到我们用数据填充它。我们还需要提供唯一标识记录的列名，即主键和包含每条记录时间戳的列名:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="2d97" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">到目前为止，我们遵循的步骤与您通过API将数据导入SMFS时遵循的步骤相同。现在，我们将把数据直接输入S3。</p><h2 id="b7c1" class="nj kx iq bd ky nk nl dn lc nm nn dp lg lx no np li mb nq nr lk mf ns nt lm nu bi translated">将数据写入S3</h2><p id="d97d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">将数据写入S3以便在SMFS可用的关键是这个<a class="ae kv" href="https://docs.aws.amazon.com/sagemaker/latest/dg/feature-store-offline.html" rel="noopener ugc nofollow" target="_blank">文档</a>。我们对用于组织离线商店中的文件的命名约定特别感兴趣:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/a16e2d3761da1846f9b4f6fb5eee984f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DapOzaoIrAx2nmZzhRlc-w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">S3线下商店的命名惯例</p></figure><p id="3a43" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">要重建这个对应的S3文件路径，我们只需要表名，以及我们之前创建的事件时间戳的年、月、日和小时:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="eeef" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">需要注意的是，在使用摄取API时，SMFS将创建额外的字段:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/ad93f0def2d6fc1cc96c0a2c760798fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nxnKspCIJavkiy7fo4dSSg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">数据集的附加字段</p></figure><p id="0618" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">因为我们没有使用API，所以我们需要手动添加这些额外的字段。这两个时间戳(<em class="ms"> api_invocation_time </em>和<em class="ms"> write_time </em>)与我们之前创建的事件时间戳不同。但是，出于演示目的，可以重用相同的时间戳:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="0c5e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">要为数据创建有效的文件名，我们可以将事件时间和一个随机的16位字母数字代码连接起来。最后一步，我们现在可以将数据保存为S3的拼花文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="82a3" class="nj kx iq bd ky nk nl dn lc nm nn dp lg lx no np li mb nq nr lk mf ns nt lm nu bi translated">检查摄取是否成功</h2><p id="67c1" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">SMFS离线存储通过Athena查询进行访问，因此检查数据获取是否成功的最快方法是编写一个Athena SQL查询，从要素存储中检索数据:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="c928" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果摄取成功，从功能存储中检索的数据集将与我们上传的数据集相同。</p></div><div class="ab cl mw mx hu my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ij ik il im in"><h1 id="fe60" class="kw kx iq bd ky kz nd lb lc ld ne lf lg jw nf jx li jz ng ka lk kc nh kd lm ln bi translated">结论</h1><p id="ef58" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们已经成功地用历史数据回填了SageMaker离线特性存储，而没有使用摄取API。为此，我们修改了数据集，设置了适当的S3文件夹结构，并将数据集直接上传到S3。</p><p id="eb36" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这种方法允许用户节省摄取API的费用，这对于大量的历史数据来说是相当大的。</p><p id="62fb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><em class="ms">【2021年4月29日编辑:讨论更高级场景的后续博文可在此处找到</em><a class="ae kv" rel="noopener" target="_blank" href="/q-a-for-ingesting-historical-data-into-sagemaker-feature-store-239e918ec594"><em class="ms"/></a><em class="ms">】</em></p></div></div>    
</body>
</html>