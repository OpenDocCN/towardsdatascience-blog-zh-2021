<html>
<head>
<title>Setting Up a GCP Pub/Sub Integration with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python设置GCP发布/订阅集成</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/setting-up-a-gcp-pub-sub-integration-with-python-6bf3fab111f8?source=collection_archive---------38-----------------------#2021-04-25">https://towardsdatascience.com/setting-up-a-gcp-pub-sub-integration-with-python-6bf3fab111f8?source=collection_archive---------38-----------------------#2021-04-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e5f9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用谷歌云平台解锁Python应用程序数据流的指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9dffac8e7427c53b089f6483bb35029e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ae0i0xcHxkhOd6CGzcNaQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">戴维·克洛德在<a class="ae kv" href="https://unsplash.com/s/photos/python?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="832c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://en.wikipedia.org/wiki/Python_%28programming_language%29" rel="noopener ugc nofollow" target="_blank"> Python </a>是当今各种数据处理的流行语言。用例范围从web应用和机器学习应用一直到像<a class="ae kv" href="https://en.wikipedia.org/wiki/Raspberry_Pi" rel="noopener ugc nofollow" target="_blank"> RaspberryPi </a>这样的设备上的硬件控制。当涉及到这些事件系统和实时数据处理时，利用发布/订阅平台可以为您的解决方案增加模块化和可扩展性— <a class="ae kv" rel="noopener" target="_blank" href="/dont-miss-out-on-pub-sub-5dbfa15cf3d0">您可以在此处了解更多信息</a>。</p><p id="4ebf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里阅读我为什么在我的爱好项目中使用谷歌云平台工具<a class="ae kv" rel="noopener" target="_blank" href="/dont-miss-out-on-pub-sub-5dbfa15cf3d0">。</a></p><h1 id="a052" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">目标</h1><p id="319c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在本文中，我将介绍如何设置一个Python应用程序来发布和使用来自Google的Pub/Sub的数据。</p><p id="59c8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">所需时间:</strong> 15分钟。</p><h1 id="3c4d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">先决条件</h1><p id="5a45" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">要跟进，您应该具备以下条件:</p><ol class=""><li id="6886" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated"><a class="ae kv" href="https://wiki.python.org/moin/BeginnersGuide" rel="noopener ugc nofollow" target="_blank">对Python工作原理的基本理解</a></li><li id="8d8e" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated"><a class="ae kv" href="https://www.python.org/downloads/" rel="noopener ugc nofollow" target="_blank">你机器上安装的Python 3.x】</a></li><li id="30ab" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">一个谷歌云平台<a class="ae kv" href="https://cloud.google.com/apigee/docs/hybrid/v1.1/precog-gcpaccount" rel="noopener ugc nofollow" target="_blank">账户</a>和一个<a class="ae kv" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">项目</a></li></ol><h1 id="46c0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">来做点编码吧！</h1><h2 id="8c0d" class="nd lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">GCP-服务帐户设置</h2><p id="b056" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，让我们在GCP完成所有的配置。从Python应用程序访问发布/订阅服务需要GCP服务帐户和私钥。</p><p id="15e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的服务帐户的完整列表可在此处<a class="ae kv" href="https://console.cloud.google.com/iam-admin/serviceaccounts" rel="noopener ugc nofollow" target="_blank">访问</a>，并可使用<a class="ae kv" href="https://console.cloud.google.com/iam-admin/serviceaccounts/create" rel="noopener ugc nofollow" target="_blank">此链接</a>添加新的服务帐户。给你的账户一个名字和id——两者可以相同，但是id必须是唯一的——我把我的命名为<code class="fe np nq nr ns b">python-tester</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/d5c761cb6943c33ce36ca5074c45c8a2.png" data-original-src="https://miro.medium.com/v2/format:webp/1*_zsAZYcyPi4larXRgcFyhg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图表</p></figure><p id="007d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击<strong class="ky ir">创建</strong>并添加<code class="fe np nq nr ns b">Pub/Sub Publisher</code>和<code class="fe np nq nr ns b">Pub/Sub Subscriber</code>角色，以确保该帐户可以从您的发布/订阅主题消费数据和向其发布数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/6fdf9b527624b01428b762810c2af630.png" data-original-src="https://miro.medium.com/v2/format:webp/1*jq9aAfnGPwme-t96F4mYYQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图表</p></figure><p id="2ed4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从这里你可以点击<strong class="ky ir">完成</strong>。</p><p id="4fa1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们需要生成一个私钥，Python应用程序将在与GCP通信时使用这个私钥。找到您刚刚创建的服务帐户，并选择<strong class="ky ir">管理密钥</strong>选项。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/6b6d69c0d77aaa43b7dd71eb2e9a964f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*halvexjfQitMciVoEo5bpg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图表</p></figure><p id="31b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用<strong class="ky ir">添加密钥</strong>按钮添加新的<strong class="ky ir"> JSON </strong>密钥。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/54b75373e5e39a2b9f0c24e02e2e4c85.png" data-original-src="https://miro.medium.com/v2/format:webp/1*6rPliSsoknE5aFO9uRzJPg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图表</p></figure><p id="2287" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击<strong class="ky ir">创建</strong>会将私钥文件下载到您的默认下载目录。如果您打开该文件，您应该会看到类似这样的内容:</p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="ab6f" class="nd lt iq ns b gy ny nz l oa ob">{<br/> <em class="oc">“type”</em>: “service_account”,<br/> <em class="oc">“project_id”</em>: “…”,<br/> <em class="oc">“private_key_id”</em>: “…”,<br/> <em class="oc">“private_key”</em>: “ — — -BEGIN PRIVATE KEY — — -…”,<br/> <em class="oc">“client_email”</em>: “python-tester@…”,<br/> <em class="oc">“client_id”</em>: “…”,<br/> <em class="oc">“auth_uri”</em>: “https://accounts.google.com/o/oauth2/auth",<br/> <em class="oc">“token_uri”</em>: “https://oauth2.googleapis.com/token",<br/> <em class="oc">“auth_provider_x509_cert_url”</em>: “…”,<br/> <em class="oc">“client_x509_cert_url”</em>: “…”<br/>}</span></pre><p id="59e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确保跟踪这个文件，因为我们的Python应用程序将需要它。</p><h2 id="d910" class="nd lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">GCP —发布/订阅主题设置</h2><p id="5d2f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在我们可以从发布/订阅推送/拉取数据之前，我们需要创建一个主题。你可以在这里看到你所有的活跃话题。创建一个新主题，给它一个名称，并选中默认订阅选项——我将我的主题命名为<code class="fe np nq nr ns b">my-python-topic</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi od"><img src="../Images/fb3fd10d59b0bc321e5d57f1960aca01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*FMxOwN5O5YynP0UCrkG3TA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图表</p></figure><p id="17b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确保选中<strong class="ky ir">添加默认订阅选项</strong>，然后单击<strong class="ky ir">创建主题</strong> —您应该会看到新主题出现在您的主题列表中。你的默认订阅将有一个带有<code class="fe np nq nr ns b">-sub</code>后缀的主题名称，在我的例子中，它被命名为<code class="fe np nq nr ns b">my-python-topic-sub</code>。</p><h2 id="1fbd" class="nd lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">python——编写生产者和消费者</h2><p id="1585" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在编写代码之前，你必须安装<a class="ae kv" href="https://www.python.org/downloads/" rel="noopener ugc nofollow" target="_blank">Python 3 . x</a>以及<code class="fe np nq nr ns b">google-api-python-client</code>和<code class="fe np nq nr ns b">google-cloud-pubsub</code> GCP库。您可以使用以下命令在pip/pip3中安装它们:</p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="f8bd" class="nd lt iq ns b gy ny nz l oa ob">pip3 install --upgrade google-api-python-client<br/>pip3 install --upgrade google-cloud-pubsub</span></pre><p id="0781" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在机器上的某个地方为Python代码创建一个文件夹。</p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="a6e9" class="nd lt iq ns b gy ny nz l oa ob">mkdir pub-sub-test<br/>cd pub-sub-test</span></pre><p id="5b0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将您在<strong class="ky ir"> GCP —服务账户设置</strong>部分生成的私钥移到这个新文件夹中。如果您丢失了您的密钥，您可以使用相同的说明生成一个新的。</p><p id="1fce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个目录中创建您的主要可执行Python文件——我调用我的<code class="fe np nq nr ns b">code.py</code>,并添加以下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="16d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">GCP库期望一个名为<code class="fe np nq nr ns b">GOOGLE_APPLICATION_CREDENTIALS</code>的环境变量指向私钥。我们在第2 行<strong class="ky ir">上设置该值:</strong></p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="127b" class="nd lt iq ns b gy ny nz l oa ob">os.environ["GOOGLE_APPLICATION_CREDENTIALS"]="YYYY.json"</span></pre><p id="7a05" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确保将<code class="fe np nq nr ns b">YYYY.json</code>替换为您的私钥文件的路径/名称。</p><p id="a1ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第<strong class="ky ir">行</strong>上的PUB_SUB_PROJECT </strong>应该更新为您的GCP项目的id，您可以在Pub/Sub <a class="ae kv" href="https://console.cloud.google.com/cloudpubsub/topic/list" rel="noopener ugc nofollow" target="_blank">列表页面</a>上找到该id。它将是<strong class="ky ir">项目</strong>和<strong class="ky ir">主题之间的值— </strong>项目/<strong class="ky ir">YYY</strong>/主题/my-python-topic。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/f1838ec47d5a78fff2e928f54cf64399.png" data-original-src="https://miro.medium.com/v2/format:webp/1*2KHvJA5MsLRFXax9ntHSJA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图表</p></figure><p id="bfc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的项目现在应该如下所示:</p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="29a4" class="nd lt iq ns b gy ny nz l oa ob">├── pub-sub-test<br/>│ ├── code.py<br/>│ ├── YYYY.json</span></pre><p id="87ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我尽了最大努力让代码尽可能不言自明，但本质上:</p><p id="610a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> process_payload: </strong>一个<strong class="ky ir"> </strong>回调函数，处理从发布/订阅消费的事件，任何你想应用到有效负载的逻辑都应该在这里添加。</p><p id="645f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> push_payload: </strong>获取一个有效负载(JSON)并将其推送到提供的发布/子主题/项目id组合。</p><p id="aca8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> consume_payload: </strong>检查所提供的订阅/项目组合中的新事件，如果数据存在，将调用回调函数进行处理。超时周期作为一个中断。</p><p id="4d5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">剩下的代码继续推送和消耗数据，直到程序终止。您可以用<code class="fe np nq nr ns b">python3 code.py</code>运行代码，应该会在终端中看到类似这样的内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/2821e33a25f2ffd19d8fe86f4abad37c.png" data-original-src="https://miro.medium.com/v2/format:webp/1*4QtvyXruniEsRfEGQ9tOlg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图表</p></figure><p id="0b97" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在你有了它，一个基本的实现，但是这应该足够让你开始使用Python来利用GCP的Pub/Sub。</p><h1 id="a06d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="f1a2" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Google的Pub/Sub平台非常适合处理大量的数据和分离你的架构的各个组件。在本文中，我向您介绍了如何在Python应用程序中利用Pub/Sub。我希望你能从这篇文章中学到一些东西。</p><p id="0fc3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">祝好运，编码快乐！</strong></p></div><div class="ab cl og oh hu oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="ij ik il im in"><p id="0e21" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="oc">原载于2021年4月25日http://www.theappliedarchitect.com</em><a class="ae kv" href="http://www.theappliedarchitect.com/setting-up-gcp-pub-sub-integration-with-python/" rel="noopener ugc nofollow" target="_blank"><em class="oc"/></a><em class="oc">。</em></p></div></div>    
</body>
</html>