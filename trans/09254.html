<html>
<head>
<title>Running Timeseries Anomaly Detection at Scale on SQL Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">对SQL数据大规模运行时间序列异常检测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/running-timeseries-anomaly-detection-at-scale-on-sql-data-4407eb3d3bd3?source=collection_archive---------12-----------------------#2021-08-27">https://towardsdatascience.com/running-timeseries-anomaly-detection-at-scale-on-sql-data-4407eb3d3bd3?source=collection_archive---------12-----------------------#2021-08-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ecbc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">多维数据、SQL、熊猫和先知</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c65f4eecfc4a791ec344dc5613903646.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ssr2vHpNUQcbm9dSsbYLkw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">从<a class="ae kv" href="https://undraw.co/" rel="noopener ugc nofollow" target="_blank">展开的插图</a></p></figure><p id="1656" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">时间可能是衡量标准最重要的维度。</p><p id="9af8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在商业世界中，业务主管、分析师和产品经理会随着时间的推移跟踪指标。</p><p id="ab06" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在创业领域，风投希望指标周环比增长5%。</p><p id="9efa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在公开股票市场，长期投资者按季度评估指标，以做出买入/卖出决定。短线交易者以小得多的时间粒度——几分钟或几小时——监控股价，以做出同样的决定。</p><p id="7b7f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在系统监控领域，团队以秒或分钟为基础跟踪指标。</p><p id="a3e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在数据科学领域，时间序列分析是工作的重要组成部分。</p><p id="4482" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管时间可能是数据中最重要的维度，但数据确实有许多其他维度。这些维度具有不同的基数。一些高基数维度可能有数千个唯一的维度值。</p><p id="56cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">手动监控数千个维度值及其组合的指标几乎是不可能的。这就是时间序列分析，尤其是时间序列异常检测派上用场的地方。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="c13c" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">对业务数据运行异常检测的挑战</h1><ol class=""><li id="4f59" class="mr ms iq ky b kz mt lc mu lf mv lj mw ln mx lr my mz na nb bi translated"><strong class="ky ir">大多数业务数据都在SQL数据库中</strong></li></ol><p id="e3cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">时间序列分析需要时间序列数据作为输入。但是大多数业务数据是表格形式的，存放在关系数据仓库和数据库中。分析师通常使用SQL来查询这些数据库。我们如何使用SQL来生成时间序列数据？</p><p id="bc34" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 2。如何按维度拆分指标？</strong></p><p id="4a70" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一些尺寸可以有数千个唯一的尺寸值。对所有维度值运行异常检测将是昂贵且嘈杂的。我们如何只为我们的分析选择重要的维度值？</p><p id="ed78" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 3。大规模异常检测成本高昂</strong></p><p id="2c58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设你为一家在线零售商工作。你的商店销售1000种产品。您希望对这1000种产品中的每一种产品的每日订单运行异常检测。这意味着:</p><p id="90a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nc">指标数= 1(订单)<br/>维值数= 1000 (1000件产品)<br/>指标组合数= 1000 (1个指标* 1000个维值)</em></p><p id="28c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这意味着异常检测过程每天必须运行1000次，每个指标组合一次。</p><p id="dec3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设您想要通过另一个维度—州(50个唯一值)来监控订单。您还希望通过这两个维度的组合来监控指标。这意味着异常检测过程现在每天必须运行51，050次。</p><p id="8466" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nc"> 51，050 = (1个指标* 1000个产品)+ (1个指标* 50个州)+ (1个指标* 1000个产品* 50个州)</em></p><p id="cfb5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了了解基础设施的定价，我们来看看<a class="ae kv" href="https://aws.amazon.com/quicksight/pricing/" rel="noopener ugc nofollow" target="_blank"> AWS异常检测</a>服务的定价。AWS将向您收取每月638美元的费用，用于每天跟踪51K个指标组合。</p><p id="ec3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是你运行异常检测程序所要支付的费用。在流程每次运行之前，您需要运行一个查询来从数据仓库中提取数据。51K指标组合意味着每天对您的数据仓库进行51K次查询，这是额外的成本。</p><p id="5063" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这还只是云基础设施的成本。</p><p id="e5b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 4。大规模异常检测有噪音</strong></p><p id="0db6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这51K个度量组合中的每一个都有可能成为异常。即使这些组合中有0.1%被证明是异常，对于一个指标，您每天都会看到51个异常。</p><p id="31ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您或您的团队每天有足够的带宽对如此多的异常情况采取行动吗？大概不会。</p><p id="6192" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你不对这些异常采取行动，这些异常不会增加任何商业价值。相反，它们只会增加你的成本。</p><p id="97e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> 5。当检测到异常时，如何深入挖掘并进行根本原因分析？</strong></p><p id="e1d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设您有以下异常情况:</p><blockquote class="nd ne nf"><p id="0646" class="kw kx nc ky b kz la jr lb lc ld ju le ng lg lh li nh lk ll lm ni lo lp lq lr ij bi translated"><strong class="ky ir">昨天<strong class="ky ir">状态= CA </strong>的订单</strong>减少了15%</p></blockquote><p id="ac03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这可能会引发如下问题:</p><ul class=""><li id="61d3" class="mr ms iq ky b kz la lc ld lf nj lj nk ln nl lr nm mz na nb bi translated">该州所有城市的订单都减少了吗？如果不是，是哪些城市？</li><li id="a2f8" class="mr ms iq ky b kz nn lc no lf np lj nq ln nr lr nm mz na nb bi translated">所有产品的订单减少了，还是特定的几个产品的订单减少了？</li></ul><p id="c13f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">怎样才能快速回答这些问题？</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="cb32" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">面对这些挑战，我们开始构建<a class="ae kv" href="https://github.com/cuebook/CueObserve" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">cue observe</strong></a><strong class="ky ir">。下面是我们如何解决这些问题。</strong></p><h2 id="b2c2" class="ns ma iq bd mb nt nu dn mf nv nw dp mj lf nx ny ml lj nz oa mn ln ob oc mp od bi translated">1.创建虚拟数据集</h2><p id="cfbb" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf oe lh li lj of ll lm ln og lp lq lr ij bi translated">数据集类似于数据的聚合SQL视图。我们使用聚合函数编写SQL GROUP BY query来汇总数据，将其列映射为维度和指标，并将其保存为虚拟数据集。</p><p id="cbc3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是BigQuery的GROUP BY查询示例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oh oi l"/></div></figure><h2 id="b4a4" class="ns ma iq bd mb nt nu dn mf nv nw dp mj lf nx ny ml lj nz oa mn ln ob oc mp od bi translated">2.定义异常</h2><p id="4cf0" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf oe lh li lj of ll lm ln og lp lq lr ij bi translated">我们现在可以在数据集上定义一个或多个异常检测作业。异常检测作业可以在聚合级别监控指标，也可以按维度拆分指标。</p><p id="2866" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们按维度分割指标时，我们限制了唯一维度值的数量。我们使用三种方法之一来限制:</p><ol class=""><li id="f32f" class="mr ms iq ky b kz la lc ld lf nj lj nk ln nl lr my mz na nb bi translated"><strong class="ky ir">前N名</strong>:基于尺寸值对度量的贡献的限制。</li><li id="645f" class="mr ms iq ky b kz nn lc no lf np lj nq ln nr lr my mz na nb bi translated"><strong class="ky ir">最小百分比贡献</strong>:基于尺寸值对度量贡献的限制。</li><li id="4624" class="mr ms iq ky b kz nn lc no lf np lj nq ln nr lr my mz na nb bi translated"><strong class="ky ir">最小平均值</strong>:基于指标平均值的限制。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/a2a6e56bcfdb045a8f256c110ef72da1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9aFO137Ht1XaQchk"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h2 id="2d41" class="ns ma iq bd mb nt nu dn mf nv nw dp mj lf nx ny ml lj nz oa mn ln ob oc mp od bi translated">3.执行数据集SQL</h2><p id="a74d" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf oe lh li lj of ll lm ln og lp lq lr ij bi translated">作为异常检测过程的第一步，我们执行数据集的SQL查询，并以Pandas数据帧的形式获取结果。该数据帧充当识别维度值和异常检测过程的源数据。</p><h2 id="081d" class="ns ma iq bd mb nt nu dn mf nv nw dp mj lf nx ny ml lj nz oa mn ln ob oc mp od bi translated">4.生成子数据帧</h2><p id="b8d8" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf oe lh li lj of ll lm ln og lp lq lr ij bi translated">接下来，我们创建新的数据帧，实际的异常检测过程将在这些数据帧上运行。在此过程中，我们通过对维度进行过滤来查找维度值并创建子数据框架。需要创建子数据框的维度值由上述3个维度分割规则之一决定。例如，如果维拆分规则是Top N，则内部方法会确定前N个维值并返回一个字典列表，每个字典都包含维值字符串、其百分比贡献和子数据框架。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="6d1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">提到的子数据帧只是在过滤了特定的维值并删除了除时间戳列和度量列之外的所有其他列之后的数据帧。</p><pre class="kg kh ki kj gt ok ol om on aw oo bi"><span id="6d7b" class="ns ma iq ol b gy op oq l or os">datasetDf[datasetDf[dimensionCol] == dimVal][[timestampCol, metricCol]]</span></pre><h2 id="0140" class="ns ma iq bd mb nt nu dn mf nv nw dp mj lf nx ny ml lj nz oa mn ln ob oc mp od bi translated">5.聚集子数据帧</h2><p id="eef8" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf oe lh li lj of ll lm ln og lp lq lr ij bi translated">准备子数据帧的一个重要步骤是聚合时间戳，这可以在前面的代码片段中看到。</p><pre class="kg kh ki kj gt ok ol om on aw oo bi"><span id="3e77" class="ns ma iq ol b gy op oq l or os">"df": aggregateDf(tempDf, timestampCol)</span></pre><p id="f216" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种聚合包括在时间戳列上对过滤后的子数据帧进行分组，并在度量列上对其求和。我们还将时间戳列重命名为“ds ”,将指标列重命名为“y ”,因为Prophet要求dataframe列也这样命名。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oh oi l"/></div></figure><h2 id="b48e" class="ns ma iq bd mb nt nu dn mf nv nw dp mj lf nx ny ml lj nz oa mn ln ob oc mp od bi translated">6.生成时间序列预测</h2><p id="b3eb" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf oe lh li lj of ll lm ln og lp lq lr ij bi translated">我们现在将时间序列数据帧输入到Prophet中。每个数据框架都在Prophet上单独训练，并生成预测。在聚集之后，每个数据帧必须具有至少20个数据点，因为少于20个数据点将是太少的训练数据，不能获得合理的好结果。关于数据帧的粒度，还需要考虑其他一些因素，如Prophet做出的预测数量以及训练数据间隔。对于每小时的粒度，我们只在最近7天的数据上训练Prophet。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="a6ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们用预定的参数和区间宽度初始化Prophet，以获得合理的宽置信区间。稍后，我们计划让这些设置也可以配置。在获得未来的置信区间和预测值后，我们将所有大于零的预测值裁剪掉，并从Prophet的输出中删除所有多余的列。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oh oi l"/></div></figure><h2 id="3725" class="ns ma iq bd mb nt nu dn mf nv nw dp mj lf nx ny ml lj nz oa mn ln ob oc mp od bi translated">7.检测异常</h2><p id="ecdf" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf oe lh li lj of ll lm ln og lp lq lr ij bi translated">接下来，我们将实际数据与Prophet的预测数据以及不确定性区间带结合起来。这些波段估计数据的趋势，并将用作确定数据点异常的阈值。对于原始数据帧中的每个数据点，我们检查它是否位于预测带内，并相应地将其分类为异常。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="ad90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们将流程的所有单个结果与元数据一起存储在一种易于可视化表示的格式中。下面是一个异常可视化的例子。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/77707e5c20a3cb150013b6f8b0a14831.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VrQsxncLgpTr_Q2Pw_lqzg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="98c5" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="946e" class="pw-post-body-paragraph kw kx iq ky b kz mt jr lb lc mu ju le lf oe lh li lj of ll lm ln og lp lq lr ij bi translated">为了对多维业务数据运行异常检测，我们通过查询编写一个SQL组，将其列映射为维度和度量，并将其保存为虚拟数据集。然后，我们在数据集上定义一个或多个异常检测作业。我们限制尺寸值的数量，以最大限度地减少噪音并降低基础设施成本。</p><p id="4bc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当异常检测作业运行时，我们执行数据集SQL并将结果存储为Pandas数据帧。我们从数据帧中生成一个或多个时间序列。然后，我们使用Prophet为每个时间序列生成一个预测。最后，我们为每个时间序列创建一个可视卡片。</p></div></div>    
</body>
</html>