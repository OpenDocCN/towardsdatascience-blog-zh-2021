<html>
<head>
<title>A simple DAG using Airflow 2.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Airflow 2.0的简单DAG</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-simple-dag-using-airflow-2-0-b4c218b2ccd9?source=collection_archive---------28-----------------------#2021-08-08">https://towardsdatascience.com/a-simple-dag-using-airflow-2-0-b4c218b2ccd9?source=collection_archive---------28-----------------------#2021-08-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="961a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Airflow 2.x是一个游戏改变者，尤其是它使用新的任务流API简化了语法。在本教程中，我们正在构建一个只有两个任务的<strong class="ak"> DAG。DAG的任务包括生成随机数(任务1)和打印该数字(任务2)。</strong></h2></div></div><div class="ab cl kf kg hu kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="ij ik il im in"><h1 id="1903" class="km kn iq bd ko kp kq kr ks kt ku kv kw jw kx jx ky jz kz ka la kc lb kd lc ld bi translated">介绍</h1><h1 id="29fa" class="km kn iq bd ko kp le kr ks kt lf kv kw jw lg jx ky jz lh ka la kc li kd lc ld bi translated">背景</h1><p id="4e3d" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">这篇博客文章是使用Airflow 2.0的最新语法和Raspberry Pis构建整个ETL管道的系列文章的一部分。这需要一些术语的知识，所以<a class="ae mf" href="https://www.astronomer.io/guides/intro-to-airflow" rel="noopener ugc nofollow" target="_blank">这里是</a>一个刷新记忆的好地方。此外，查看我之前关于如何在树莓派上安装<a class="ae mf" href="https://pedromadruga.com/posts/airflow-install/" rel="noopener ugc nofollow" target="_blank">气流2的帖子。</a></p><p id="be68" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">完整的代码在<a class="ae mf" href="https://github.com/pmadruga/airflow-dags/blob/main/simplest.py" rel="noopener ugc nofollow" target="_blank"> Github </a>上。</p><h1 id="903b" class="km kn iq bd ko kp le kr ks kt lf kv kw jw lg jx ky jz lh ka la kc li kd lc ld bi translated">创建DAG定义文件</h1><p id="1b51" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我们将从在<code class="fe ml mm mn mo b">airflow/dags</code>文件夹中创建DAG定义文件开始:</p><figure class="mp mq mr ms gt mt"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="4b25" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">让我们通过添加DAG来填充它。</p><h1 id="e6d3" class="km kn iq bd ko kp le kr ks kt lf kv kw jw lg jx ky jz lh ka la kc li kd lc ld bi translated">DAG分解</h1><h1 id="0028" class="km kn iq bd ko kp le kr ks kt lf kv kw jw lg jx ky jz lh ka la kc li kd lc ld bi translated"><code class="fe ml mm mn mo b">@dag</code>装饰工</h1><p id="2a30" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">DAG有任务。在这个例子中，它有两个任务，其中一个依赖于另一个的结果。为此，我们将使用最新的气流装饰:<code class="fe ml mm mn mo b">@dag</code>和<code class="fe ml mm mn mo b">@task</code>。</p><p id="0f27" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">我们首先定义DAG及其参数。我们将确定任务集运行的时间间隔(<code class="fe ml mm mn mo b">schedule_interval</code>)和开始日期(<code class="fe ml mm mn mo b">start_date</code>)。当然，还有其他参数可供选择，但是我们将把范围保持在最小。</p><figure class="mp mq mr ms gt mt"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="020f" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">注意函数<code class="fe ml mm mn mo b">EXAMPLE_simple</code>顶部的<code class="fe ml mm mn mo b">@dag</code>装饰器。函数名也将是DAG id。最后，我们只是运行DAG的功能。</p><h1 id="e5a0" class="km kn iq bd ko kp le kr ks kt lf kv kw jw lg jx ky jz lh ka la kc li kd lc ld bi translated"><code class="fe ml mm mn mo b">@task</code>装潢师</h1><p id="b304" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">既然<code class="fe ml mm mn mo b">@dag</code>包装器已经解决了，我们需要定义里面的两个任务。记住，这个DAG有两个任务:<code class="fe ml mm mn mo b">task_1</code>生成一个随机数，<code class="fe ml mm mn mo b">task_2</code>接收第一个任务的结果并打印出来，如下所示:</p><figure class="mp mq mr ms gt mt"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="01c7" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">从视觉上看，DAG图形视图如下所示:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/bc043f507a15ce655fa1c441d5b7c7be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/0*zvKadaSfnZ0Md2OF"/></div></figure><p id="557a" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">前后的代码指的是<code class="fe ml mm mn mo b">@dag</code>运算符及其依赖关系。接下来，我们将把所有东西放在一起:</p><figure class="mp mq mr ms gt mt"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="f036" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">就是这样。让我们运行这个。</p><h1 id="3197" class="km kn iq bd ko kp le kr ks kt lf kv kw jw lg jx ky jz lh ka la kc li kd lc ld bi translated">运行DAG</h1><p id="e8bf" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">创建DAG定义文件后，在<code class="fe ml mm mn mo b">airflow/dags</code>文件夹中，它应该会出现在列表中。现在，如果我们想立即运行DAG，我们需要解除其暂停并触发它。有两个选项来解除暂停和触发DAG:我们可以使用Airflow web服务器的UI或终端。让我们两个都处理。</p><h1 id="e645" class="km kn iq bd ko kp le kr ks kt lf kv kw jw lg jx ky jz lh ka la kc li kd lc ld bi translated">通过用户界面运行</h1><p id="be43" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">首先，您应该在列表中看到DAG:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/c9c94517bae1fb1bd5af66123074d1ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U47RNrrsa7OnHz6s"/></div></div></figure><p id="0b33" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">在这个例子中，我以前运行过DAG(因此一些列已经有了值)，但是您应该有一个干净的石板。</p><p id="f5c4" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">现在，我们启用DAG (1)并触发它(2)，因此它可以立即运行:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/58f0580d258f5908bc89e6b52f736101.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HIJGKSTqZbHidSf0"/></div></div></figure><p id="2b35" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">单击DAG ID(在本例中称为<code class="fe ml mm mn mo b">EXAMPLE_simple</code>)，您将看到树形视图。触发新的运行后，您将看到DAG正在运行:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/198c1dc1a8c8decbedd3ba91bbafdd2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z6gpXivn_8BFKXPe"/></div></div></figure><p id="96c7" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">转到<strong class="ll ir">图表视图</strong>，我们可以看到两个任务都成功运行了🎉：</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/7e4fbcb4ecf14680b814e425f2cc433e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SxUfGPhHNA1LphGN"/></div></div></figure><p id="6509" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">但是显示一个随机生成的数字的<code class="fe ml mm mn mo b">task_2</code>的打印输出呢？我们可以查看日志。</p><h2 id="9a12" class="ne kn iq bd ko nf ng dn ks nh ni dp kw ls nj nk ky lw nl nm la ma nn no lc np bi translated">通过用户界面检查日志</h2><p id="a376" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在<strong class="ll ir">图形视图</strong>内，点击<code class="fe ml mm mn mo b">task_2</code>，点击<code class="fe ml mm mn mo b">Log</code>。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nq"><img src="../Images/5538c045930f974bcac5686550735d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*egIhOrq-89Kl0cqw"/></div></div></figure><p id="8089" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">可以看到任务的输出:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/4dedf8ce42efa70599188441e3ce742f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mE-ptZ-7Kzi3eOA-"/></div></div></figure><p id="5166" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">再次成功🎉！</p><h1 id="bfda" class="km kn iq bd ko kp le kr ks kt lf kv kw jw lg jx ky jz lh ka la kc li kd lc ld bi translated">通过终端运行</h1><p id="2bbb" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">对于取消暂停、触发和DAG，UI的替代方法非常简单。知道了DAG的ID，我们只需要:</p><figure class="mp mq mr ms gt mt"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="3dad" class="ne kn iq bd ko nf ng dn ks nh ni dp kw ls nj nk ky lw nl nm la ma nn no lc np bi translated">通过终端检查日志</h2><p id="044a" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">假设您的airflow安装在<code class="fe ml mm mn mo b">$HOME</code>目录中，可以通过执行以下操作来检查日志:</p><figure class="mp mq mr ms gt mt"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="bf7b" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">并选择正确的时间戳:</p><figure class="mp mq mr ms gt mt"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="d0ea" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">其中输出应包括:</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nr"><img src="../Images/4217ee16a7ec45ed441dc7b0d65d9cfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VdF4s88ge5wU4HG-IYoXOQ.png"/></div></div></figure><p id="5103" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated">后面是我们在这次运行中生成的实际数字。</p><h1 id="c6d0" class="km kn iq bd ko kp le kr ks kt lf kv kw jw lg jx ky jz lh ka la kc li kd lc ld bi translated">结论</h1><p id="109e" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">这是一个初学者友好的DAG，使用了Airflow 2.0中新的Taskflow API。不需要太多代码就可以创建一个简单的DAG。在本系列的下一篇文章中，我们将使用<code class="fe ml mm mn mo b">@task_group</code>装饰器创建并行任务。</p></div><div class="ab cl kf kg hu kh" role="separator"><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk kl"/><span class="ki bw bk kj kk"/></div><div class="ij ik il im in"><p id="eb4b" class="pw-post-body-paragraph lj lk iq ll b lm mg jr lo lp mh ju lr ls mi lu lv lw mj ly lz ma mk mc md me ij bi translated"><em class="ns">原载于</em><a class="ae mf" href="https://pedromadruga.com/posts/airflow2-simple-dag/" rel="noopener ugc nofollow" target="_blank"><em class="ns">pedromadruga.com</em></a><em class="ns">。</em></p></div></div>    
</body>
</html>