<html>
<head>
<title>Compared to Native Spark 3.0, We Have Achieved Significant Optimization Effects in the AI Application Field</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">相比原生Spark 3.0，我们在AI应用领域取得了显著的优化效果</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/we-have-achieved-significant-optimization-effects-in-the-ai-application-field-compared-to-native-2a055e47250f?source=collection_archive---------36-----------------------#2021-08-04">https://towardsdatascience.com/we-have-achieved-significant-optimization-effects-in-the-ai-application-field-compared-to-native-2a055e47250f?source=collection_archive---------36-----------------------#2021-08-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a50a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">介绍OpenMLDB及其相对于原生Spark的优势</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6bb000179deb88f5334bb542415742af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3-lvVejbMS8qTpH-"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">SpaceX 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的<a class="ae kv" href="https://unsplash.com/@spacex?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"/></p></figure><h1 id="afe9" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">背景</strong></h1><p id="36c8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Spark已经迅速成为大数据处理事实上的标准，无需介绍，但Spark在AI场景下仍有很多不足。</p><ol class=""><li id="4a8b" class="mk ml iq lq b lr mm lu mn lx mo mb mp mf mq mj mr ms mt mu bi translated">好:原生Spark擅长Hadoop集群中的大数据处理</li><li id="9498" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj mr ms mt mu bi translated">不足:SparkSQL的缺点在特征提取领域逐渐暴露出来</li><li id="a1bd" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj mr ms mt mu bi translated">不足:考拉，阿帕奇Spark上的熊猫API</li></ol><p id="6dbc" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">即使SparkSQL和Koalas项目可以提供一些重要的数据处理功能，但特征提取所需的功能支持仍然非常有限。所支持的时序特征计算的性能不令人满意。只能支持离线分析，但对于AI制作，还需要在线计算。而且因为这个过程要反复使用UDF/UDAF，所以开源的Spark和AI的融合还有很大的提升空间。</p><p id="e1b7" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">目前，业界已经涌现出越来越多的原生执行引擎解决方案，如Databricks的光子模块、Intel的OAP项目、Nvidia的Spark-rapids项目、阿里巴巴的EMR服务等。这些项目都有其亮点。它们可以通过底层原生代码生成，充分利用CPU矢量化和GPU并行计算特性，显著提升Spark在特定场景下的性能。但还是有一些不足。首先，它只能支持离线计算和在线特征计算，以及AI场景落地所需的在线模型估计服务。其次，对于常用的时间序列计算功能(SQL Over Window)没有进一步优化，最后，对于AI场景，特征提取功能也缺乏支持。</p><h2 id="de02" class="nd kx iq bd ky ne nf dn lc ng nh dp lg lx ni nj li mb nk nl lk mf nm nn lm no bi translated">几种火花发动机的比较</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/abcc2d0c58e14092723cd5645aed3761.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fQtDhYp_5pWqTH_X40Dr1w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="331a" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">所以我们发布了我们的项目<a class="ae kv" href="https://github.com/4paradigm/OpenMLDB/" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a> (SparkFE是OpenMLDB的引擎)。它可以弥补上述项目的不足，在人工智能应用中取得更好的性能。基于LLVM优化，性能比原来的Spark提高了6倍以上。</p><h1 id="4dc2" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">优势</h1><ul class=""><li id="5aeb" class="mk ml iq lq b lr ls lu lv lx nq mb nr mf ns mj nt ms mt mu bi translated">基于LLVM优化，高性能性能比原来的Spark提升6倍以上。</li><li id="70b7" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">对于AI，扩展SQL语法，支持更多的FE函数和时序特征计算。</li><li id="5331" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">线上线下一致，通过时间序列数据库的窗口特征聚合计算，实现SQL一键上线。</li><li id="2a21" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">无迁移成本，兼容SparkSQL应用，Scala、Java、Python、R应用无需修改代码即可享受性能提升。</li><li id="8632" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">所以，最后，无论是时间序列特征计算场景，还是机器学习的特定表组成场景，最终的性能测试结果都表明<a class="ae kv" href="https://github.com/4paradigm/OpenMLDB/" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>在不增加硬件成本的情况下，可以实现6倍到上百倍的性能提升。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/ec42433598ce55b75fdfa36e5e5b47f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MI2DVVagF4JGrthCHdJTqw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">时间序列特征提取。作者图片</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/95555009307422d3fffc01dffeb07ed4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i54oyhYPkI5xC5Lz8fMl2A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用于机器学习的自定义表连接。作者图片</p></figure><h1 id="4a48" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">与原生Spark3.0相比的性能优化</h1><p id="c46e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这里我们介绍一下<a class="ae kv" href="https://github.com/4paradigm/OpenMLDB/" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>的一些应用场景，重点是性能优化的方法。</p><h2 id="f7eb" class="nd kx iq bd ky ne nf dn lc ng nh dp lg lx ni nj li mb nk nl lk mf nm nn lm no bi translated">第一个优化是<strong class="ak">原生窗口计算</strong>。</h2><p id="0f78" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">底层基于C++双向队列数据接口，高效实现标准窗口和子窗口功能。扩展SQL实现的ROWS_RANGE边界也可以更好的解决相同毫秒数据的计算顺序问题。本机窗口计算</p><ul class=""><li id="0e84" class="mk ml iq lq b lr mm lu mn lx mo mb mp mf mq mj nt ms mt mu bi translated">本机窗口计算</li><li id="e6f1" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">➡Performance改进</li><li id="4196" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">➡行_范围界限</li><li id="02d1" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">带有联合表的➡窗口</li><li id="b098" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">➡处理微秒级冲突</li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="ba1d" class="nd kx iq nx b gy ob oc l od oe">select trip_duration, passenger_count,<br/>sum(pickup_latitude) over w as vendor_sum_pl,<br/>max(pickup_latitude) over w as vendor_max_pl,<br/>min(pickup_latitude) over w as vendor_min_pl,<br/>avg(pickup_latitude) over w as vendor_avg_pl,<br/>sum(pickup_latitude) over w2 as pc_sum_pl,<br/>max(pickup_latitude) over w2 as pc_max_pl,<br/>min(pickup_latitude) over w2 as pc_min_pl,<br/>avg(pickup_latitude) over w2 as pc_avg_pl ,<br/>count(vendor_id) over w2 as pc_cnt,<br/>count(vendor_id) over w as vendor_cnt<br/>from t1<br/>window w as (partition by vendor_id order by pickup_datetime ROWS_RANGE BETWEEN 1d PRECEDING AND CURRENT ROW),<br/>w2 as (partition by passenger_count order by pickup_datetime ROWS_RANGE BETWEEN 1d PRECEDING AND CURRENT ROW);</span></pre><h2 id="2de8" class="nd kx iq bd ky ne nf dn lc ng nh dp lg lx ni nj li mb nk nl lk mf nm nn lm no bi translated">优化的第二点是本机LastJoin实现。</h2><p id="def5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这种扩展连接类型可以确保表组装后的结果与拼接前的结果相同。Spark源代码级别的原生实现比基于Spark 3.0的实现快100多倍，并且节省更多内存。</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="56be" class="nd kx iq nx b gy ob oc l od oe">SELECT t1.name FROM t1 LAST JOIN t2 WHERE t1.id == t1.id</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/bc9fd83695afd0b090f7179156aab01b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ncmRj6asxj393wQ6VaES4g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">LastJoin性能。作者图片</p></figure><h2 id="139f" class="nd kx iq bd ky ne nf dn lc ng nh dp lg lx ni nj li mb nk nl lk mf nm nn lm no bi translated">优化的第三点是多窗口并行计算的优化。</h2><p id="6676" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Spark默认的串行执行被优化为并行计算，充分利用了集群计算资源，SparkSQL整体任务时间也可以大大减少。</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="5cb5" class="nd kx iq nx b gy ob oc l od oe">SELECT<br/> min(age) OVER w1 as w1-min-age,<br/> min(age) OVER w2 as w2-min-age<br/>FROM t1<br/>WINDOW<br/> w1 as (PARTITION BY name ORDER by age ROWS BETWEEN 10 PERCEDING AND CURRENT ROW),<br/> W2 as (PARTITION BY age ORDER by age ROWS BETWEEN 10 PERCEDING AND CURRENT ROW)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/bf3e3346ea2970c6a1b65ca2f00ffbdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sa5SouJ2cqnBMElYu1Y3Wg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h2 id="d6d4" class="nd kx iq bd ky ne nf dn lc ng nh dp lg lx ni nj li mb nk nl lk mf nm nn lm no bi translated">优化的第四点是时间窗口数据偏差计算</h2><p id="de67" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">与表格不对称优化类似，该窗口对不对称数据进行了两次分区，从而显著提高了任务的计算并行性，并充分利用集群资源来降低总体TCO(总拥有成本)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/9e07cf0e4161e65c19ebcb28bdf35b14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SJvK_terrPGUIgZ531C7mg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">opt之前，并行度:2。作者图片</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/a282afbde4407c8974b6fb95f6d9a6dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rgeW7OXkXYtFwyf3OFu5dQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">opt之后，并行度:4。作者图片</p></figure><p id="0dc7" class="pw-post-body-paragraph lo lp iq lq b lr mm jr lt lu mn ju lw lx na lz ma mb nb md me mf nc mh mi mj ij bi translated">SparkFE(现在合并到<a class="ae kv" href="https://github.com/4paradigm/OpenMLDB/" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>)有很多不能重复的优化。由于兼容SparkSQL API，应用场景与Spark类似，尤其是在AI相关的时序特征计算、数据表拼接方面。</p><ul class=""><li id="a032" class="mk ml iq lq b lr mm lu mn lx mo mb mp mf mq mj nt ms mt mu bi translated">时间序列特征提取</li><li id="2b66" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">多窗口并发</li><li id="b34e" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">自定义表连接</li><li id="7c03" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">自定义特征提取功能</li><li id="42fb" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">偏斜优化</li><li id="1ff5" class="mk ml iq lq b lr mv lu mw lx mx mb my mf mz mj nt ms mt mu bi translated">本机聚合函数</li></ul><h2 id="c7f7" class="nd kx iq bd ky ne nf dn lc ng nh dp lg lx ni nj li mb nk nl lk mf nm nn lm no bi translated">这里是<a class="ae kv" href="https://github.com/4paradigm/OpenMLDB/" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>的架构，欢迎来到社区。</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/40c9f18e13094e4ebb07f8057151a0a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5lo_6Qi983ykdkDr3u-9uQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure></div></div>    
</body>
</html>