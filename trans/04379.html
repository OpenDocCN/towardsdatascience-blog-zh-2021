<html>
<head>
<title>Putting Your Models Into Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的模型投入生产</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/putting-your-models-into-production-5ae3191722b9?source=collection_archive---------38-----------------------#2021-04-13">https://towardsdatascience.com/putting-your-models-into-production-5ae3191722b9?source=collection_archive---------38-----------------------#2021-04-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="33ee" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用TensorFlow服务将深度学习模型投入生产的指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/85864978d2bc617a30cb5a758bd044a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q0SQTHMQGVHSIYJ7Kl6W5A.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源(<a class="ae kv" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>)</p></figure><p id="3a15" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你已经辛苦工作了无数个小时，试图让你的模型恰到好处。您已经努力清理了数据，精心设计了特性，并尽最大能力调整了超参数。一切终于就绪，现在您可以向全世界展示您的模型了。只有一个问题:您的模型被困在您的本地机器中，无法访问外部世界。</p><p id="2940" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是大多数机器学习模型的命运。事实上，大约87%的产品从未投入生产。大量的资源(更不用说宣传了)投入到实际的模型构建过程中，但实际上，这仅占用数据科学家大约14%的时间。一个经常被忽视的步骤是将这些模型实际部署到生产中。本文将关注服务于的<a class="ae kv" href="https://github.com/tensorflow/serving" rel="noopener ugc nofollow" target="_blank"> Tensorflow，这是一个用于将Tensorflow模型部署到生产中的系统。</a></p><p id="c575" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">张量流发球</strong></p><p id="a5e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用TensorFlow服务的最简单方法是使用Docker图像。Docker是一个开发、运输和运行应用程序的平台；使得用很少的设置快速传递内容成为可能。如果您在本地机器上安装了Docker，您可以通过在终端上运行以下命令来下载映像:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="c7be" class="lx ly iq lt b gy lz ma l mb mc">docker pull tensorflow/serving</span></pre><p id="3bbe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">否则可以去<a class="ae kv" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank"> Docker网站</a>获取。</p><p id="755b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于我们不会关注模型构建过程，因此我们将使用Keras创建一个简单的序列模型，并在MNIST数据集上进行训练。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">带有一个隐藏层的简单模型。</p></figure><p id="1339" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">模特培训</strong></p><p id="695a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">定义模型后，让我们使用<code class="fe mf mg mh lt b">sparse_categorical_crossentropy</code>作为我们的损失、<code class="fe mf mg mh lt b">adam</code>作为我们的优化器、<code class="fe mf mg mh lt b">accuracy</code>作为我们的度量来编译它。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">编译模型。</p></figure><p id="6747" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，让我们在模型上调用<code class="fe mf mg mh lt b">fit</code>方法来拟合我们的数据，对它进行5个时期的训练，并传入测试图像作为验证数据。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使模型符合数据。</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/854fb9adc267eeb2fa09150aeed4c88d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n8mSdo_bRzxhldxgie5RSw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">模型训练输出。</p></figure><p id="53b0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">训练完模型后，我们将把它保存到机器上指定的导出路径中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">保存训练好的模型。</p></figure><p id="bae1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面我们创建了一个<code class="fe mf mg mh lt b">MODEL_DIR</code>变量和一个版本号来跟踪我们的模型版本。如果我们想要在将来更新我们模型的版本，我们可以在保存它的时候改变版本号。在这种情况下，我们的模型将保存在名为<code class="fe mf mg mh lt b">mnist_model/1</code>的目录中。如果我们检查这个目录，我们会看到一个<code class="fe mf mg mh lt b">saved_model.pb</code>文件和一个<code class="fe mf mg mh lt b">variables</code>文件夹。</p><p id="2aab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mf mg mh lt b">saved_model.pb</code>文件是一个protobuf文件，存储实际的Tensorflow模型。<code class="fe mf mg mh lt b">variables</code>目录包含一个<a class="ae kv" href="https://www.tensorflow.org/guide/checkpoint" rel="noopener ugc nofollow" target="_blank">训练检查点</a>，用于重新加载保存的模型。</p><p id="42c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">运行我们的Docker容器</strong></p><p id="7fac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">之后，我们将在机器上运行docker命令来服务模型。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用docker服务模型。</p></figure><p id="12d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里发生了很多事情，所以让我们进一步分解这个命令。</p><ul class=""><li id="bdfc" class="mj mk iq ky b kz la lc ld lf ml lj mm ln mn lr mo mp mq mr bi translated"><strong class="ky ir"> docker </strong> -运行docker的命令。</li><li id="ac8c" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><strong class="ky ir">运行</strong> -在新容器中运行命令。</li><li id="a531" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><strong class="ky ir"> -p 8501:8501 </strong> -在特定端口上运行docker命令(在我们的例子中，容器上的端口8501将被映射到主机上的端口8501)。</li><li id="16cd" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><strong class="ky ir"> - mount type=bind，source=…，target=… </strong> - <strong class="ky ir"> </strong>这将模型从我们的本地机器挂载到容器中。我们指定了一个<code class="fe mf mg mh lt b">source</code>和一个<code class="fe mf mg mh lt b">target</code>，前者是模型在本地机器上的绝对路径，后者是我们希望模型放在容器中的位置。</li><li id="d975" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><strong class="ky ir">-e MODEL _ NAME</strong>-<strong class="ky ir"/>这里我们设置一个环境变量，当我们执行<a class="ae kv" href="https://en.wikipedia.org/wiki/Representational_state_transfer" rel="noopener ugc nofollow" target="_blank"> REST </a>请求时，我们将使用它来调用我们的模型。模型名称可以是您想要的任何名称。</li><li id="51a9" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><strong class="ky ir">-t tensor flow/serving</strong>-<strong class="ky ir"/>这是我们指定想要使用的图像的地方。这里我们使用之前下载的<code class="fe mf mg mh lt b">tensorflow/serving</code>图片。</li></ul><p id="c450" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行该命令后，请务必等待，直到您在终端上看到如下消息:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="38a2" class="lx ly iq lt b gy lz ma l mb mc">2021-04-13 02:25:32.041325: I tensorflow_serving/model_servers/server.cc:391] Exporting HTTP/REST API at:localhost:8501 ...</span></pre><p id="b8ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">做出推理请求</strong></p><p id="0176" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，带有我们模型的容器将在我们机器的端口8501上运行。此时，我们已经准备好发送对新数据进行预测的请求。我们可以编写一个简单的python脚本来发送POST请求并进行预测。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">发送进行新预测的请求。</p></figure><p id="9733" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们创建一个JSON变量，包含测试数据中的前10幅图像。在此之后，我们使用<code class="fe mf mg mh lt b">requests</code>库发送post请求并获得数据预测。然后，我们将模型预测与地面实况标签进行比较，并查看模型是否按预期执行。我们已经使用TensorFlow服务成功部署了我们的模型！</p><p id="b090" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">结论</strong></p><p id="eadd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们讨论了使用TensorFlow服务的模型部署。通过使用Docker映像，我们可以轻松地在容器中部署我们的模型，而不是在本地安装TensorFlow服务。一旦我们训练了我们的模型，让我们的容器启动并运行，我们就使用python脚本对新数据的预测进行post请求。</p><p id="7e40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢您的阅读！</p></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><p id="41d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以通过以下渠道与我联系:</p><ul class=""><li id="d99b" class="mj mk iq ky b kz la lc ld lf ml lj mm ln mn lr mo mp mq mr bi translated"><a class="ae kv" href="https://zito-relova.medium.com/" rel="noopener">中等</a></li><li id="6296" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><a class="ae kv" href="https://www.linkedin.com/in/zrelova/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>。</li><li id="9ce5" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><a class="ae kv" href="https://github.com/zitorelova" rel="noopener ugc nofollow" target="_blank"> Github </a></li><li id="082f" class="mj mk iq ky b kz ms lc mt lf mu lj mv ln mw lr mo mp mq mr bi translated"><a class="ae kv" href="https://www.kaggle.com/zitorelova" rel="noopener ugc nofollow" target="_blank">卡格尔</a></li></ul></div></div>    
</body>
</html>