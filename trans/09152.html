<html>
<head>
<title>Deploying Prefect Server with AWS ECS and Docker Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS ECS和Docker存储部署完美服务器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-prefect-server-with-aws-ecs-fargate-and-docker-storage-36f633226c5f?source=collection_archive---------10-----------------------#2021-08-24">https://towardsdatascience.com/deploying-prefect-server-with-aws-ecs-fargate-and-docker-storage-36f633226c5f?source=collection_archive---------10-----------------------#2021-08-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="549f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何使用在ECS Fargate上运行的带有私有Docker注册表的Prefect来编排和自动化工作流</h2></div><p id="7f3e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章一步一步地介绍了我如何使用私有注册中心上的Docker存储来部署带有Fargate ECS集群的完美服务器。有几篇文章介绍了使用完美的云以及不同的运行器和存储组合进行部署。当我在部署这个特定的架构时遇到一些问题，我决定在本文中详述这些步骤。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/24db7cbc188c6a42a6dd43c6666370d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*otE92KqF3Pu833tr"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">约书亚·阿拉贡在<a class="ae lr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="565f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本教程结束时，我们将拥有:</p><ul class=""><li id="54d5" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated">运行在EC2上的完美服务器</li><li id="c323" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">EC2上运行的ECSAgent</li><li id="d7e7" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">将我们的流打包到私有注册中心的docker映像中</li><li id="847a" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">通过UI和GraphQL API在ECS集群中运行流</li></ul><p id="096c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以选择使用不同的<a class="ae lr" href="https://docs.prefect.io/orchestration/agents/overview.html" rel="noopener ugc nofollow" target="_blank">代理</a>和<a class="ae lr" href="https://docs.prefect.io/orchestration/flow_config/overview.html#storage" rel="noopener ugc nofollow" target="_blank">存储</a>选项，这篇文章只是对许多提督选项的基本指导。虽然我不会详细介绍Prefect和AWS的概念，但是您可以找到相关文档的参考资料来帮助您。</p><p id="3ba7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">先决条件:</p><ul class=""><li id="664f" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated">AWS帐户</li><li id="3253" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">码头工人登记处</li><li id="24fe" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">基本的Python技能</li></ul><p id="096f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果这是您第一次使用Prefect，我建议您首先尝试在本地部署它，以便更容易掌握Prefect的概念。</p><h1 id="5676" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">部署完美服务器</h1><p id="22ca" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">第一步是在EC2实例上部署完美服务器。创建并启动EC2实例。当我在其上部署多个服务时，我使用了一个<em class="nd"> g4dn.2xlarge </em>实例，但是如果您计划在其上只使用Prefect，那么一个小实例就足够了。您需要更新安全规则，以允许端口<strong class="kh ir"> 8080 </strong>上的TCP连接访问UI，并允许端口<strong class="kh ir"> 4200 </strong>访问后端。</p><p id="2255" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您的实例上还没有docker-compose 的话，您可能需要安装它。</p><p id="e489" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，在您的实例上安装SSH并运行:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="ed64" class="nj mh iq nf b gy nk nl l nm nn">pip install “prefect[aws]”</span></pre><p id="7a03" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在此查看完美安装<a class="ae lr" href="https://docs.prefect.io/core/getting_started/installation.html#optional-dependencies" rel="noopener ugc nofollow" target="_blank">的其他选项。</a></p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="8efc" class="nj mh iq nf b gy nk nl l nm nn">prefect backend server</span></pre><p id="343c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建文件<strong class="kh ir"> ~/。提督/配置. toml </strong>包含以下信息:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="401b" class="nj mh iq nf b gy nk nl l nm nn">[server]<br/>[server.ui]<br/>apollo_url = “http://X.X.X.X:4200/graphql"</span></pre><p id="9e36" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用您的实例公共地址替换<em class="nd"> X.X.X.X </em>,因为它允许将UI连接到后端。</p><p id="5010" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，您可以从以下内容开始:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="cdef" class="nj mh iq nf b gy nk nl l nm nn">prefect server start</span></pre><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi no"><img src="../Images/1bc485ce59e55fdd8fbf41e98a591e78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FeZvakltZiGmh53mxJJwvw.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">完美服务器已启动</p></figure><p id="b502" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从现在开始，你可以通过<a class="ae lr" href="http://x.x.x.x:8080" rel="noopener ugc nofollow" target="_blank"> http://X.X.X.X:8080 </a>从任何机器(由你的安全规则授权)连接到UI</p><h1 id="f8b4" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">部署AWS代理</h1><p id="4d34" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">代理负责启动和监控您的运行。这里，我们将它部署在与Prefect Server相同的EC2实例上。您可以选择在第二个实例上部署它，方法是<a class="ae lr" href="https://docs.prefect.io/orchestration/agents/overview.html#prefect-api-address" rel="noopener ugc nofollow" target="_blank">在config.toml文件中或通过命令行提供</a>完美服务器的实例IP地址。</p><p id="674c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这两种情况下，您都需要添加:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="45ce" class="nj mh iq nf b gy nk nl l nm nn">[cloud]<br/>api = “<a class="ae lr" href="http://x.x.x.x:4200" rel="noopener ugc nofollow" target="_blank">http://X.X.X.X:4200</a>"</span></pre><p id="49f3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">到config.toml文件，用<em class="nd"> X.X.X.X </em>把公共IP地址传给提督主机。</p><p id="f647" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">AWS任务需要这个变量来连接到后端(即使我们运行的是Prefect Server而不是Cloud)。您可以关注这个<a class="ae lr" href="https://github.com/PrefectHQ/prefect/issues/4662" rel="noopener ugc nofollow" target="_blank">问题</a>以获得关于这个端点配置的更多信息。</p><p id="46cb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您还没有ECS fargate集群，那么您应该现在就创建它。使用Prefect不需要特殊的配置，所以根据您的任务需求进行选择。请将ARN集群放在身边，因为您很快就会用到它。</p><p id="e7af" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，创建一个拥有权限<a class="ae lr" href="https://console.aws.amazon.com/iam/home#/policies/arn:aws:iam::aws:policy/AmazonECS_FullAccess" rel="noopener ugc nofollow" target="_blank"> AmazonECS_FullAccess </a>的AWS用户，这是为代理提供权限以代表您在ECS集群中启动任务所必需的。将<em class="nd">访问密钥id </em>和<em class="nd">秘密访问密钥</em>存储在将托管代理的实例上的配置文件中:</p><p id="8ff8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建一个文件<strong class="kh ir"> ~/。aws/config </strong>包含:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="ac6b" class="nj mh iq nf b gy nk nl l nm nn">[default]<br/>aws_access_key_id=SECRET_KEY_ID<br/>aws_secret_access_key=SECRET_ACCESS_KEY<br/>region=REGION</span></pre><p id="de1b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，部署代理:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="6a8f" class="nj mh iq nf b gy nk nl l nm nn">prefect agent ecs start -cluster arn:your-cluster-arn -label your-label</span></pre><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi np"><img src="../Images/bfcd27682da8ece459224bf6b904d05d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fz4TrWdJa1nfxM7_34OXOQ.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">提督代理已启动</p></figure><p id="9fd9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">“群集”选项允许您指定将使用哪个群集来运行您的任务。“标签”选项允许您为代理提供标签。请注意，只有当代理的标签完全匹配时，代理才能拾取流，这有助于控制哪个代理将运行您的流。点击了解有关代理配置<a class="ae lr" href="https://docs.prefect.io/orchestration/agents/ecs.html#requirements" rel="noopener ugc nofollow" target="_blank">的更多信息。</a></p><p id="b78b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">检查用户界面，你可以看到你的代理正在运行。现在提督准备运行你的流量！</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nq"><img src="../Images/f1e0278757d2a4add48eed772fe70d9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vmH2sZoZw-sZTKg7Cyuang.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">代理在完美用户界面上注册</p></figure><h1 id="a77b" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">创建一个流程</h1><p id="f42c" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">让我们创建一个流程。以下是Hello world job的一个示例:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="bc99" class="nj mh iq nf b gy nk nl l nm nn">import prefect<br/>from prefect.run_configs import ECSRun<br/>from prefect.storage import Docker<br/>from prefect import task, Flow, Parameter</span><span id="b6c7" class="nj mh iq nf b gy nr nl l nm nn">@task<br/>def hello_world(name):<br/>  logger = prefect.context.get(“logger”)<br/>  logger.info(“Hello “+name)</span><span id="3d8a" class="nj mh iq nf b gy nr nl l nm nn">with Flow(“Hello”) as flow:<br/>  name = Parameter(‘name’, default = ‘Bob’)<br/>  hello_world(name)</span><span id="f6b4" class="nj mh iq nf b gy nr nl l nm nn">flow.storage = Docker(<br/>    registry_url=’your-registry-url’,<br/>    image_name=”hello_container”,<br/>    base_image=”python:3.8"<br/>  )</span><span id="40e5" class="nj mh iq nf b gy nr nl l nm nn">flow.run_config = ECSRun(<br/>  task_definition={<br/>    ‘containerDefinitions’:[<br/>      {<br/>        ‘name’: ‘flow’,<br/>        ‘image’: ‘your-registry-url/hello_container:latest’,<br/>        ‘repositoryCredentials’: {<br/>          ‘credentialsParameter’: ‘arn:aws:secretsmanager:your-secret-arn’<br/>      }<br/>    }<br/>  ],<br/>  ‘networkMode’ : ‘awsvpc’,<br/>  ‘memory’:’2 GB’,<br/>  ‘cpu’:’1024'<br/>  },<br/>execution_role_arn=’arn:aws:iam::your-arn-role’,<br/>labels=[‘your-label’]<br/>)</span><span id="3c34" class="nj mh iq nf b gy nr nl l nm nn">flow.register(project_name=”Hello_Project”)</span></pre><p id="6860" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个脚本定义了一个执行一个任务并接受一个输入参数“name”的流。</p><p id="682b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> flow.storage </strong>定义存储策略。当您想要控制流中包含哪些文件时，Docker存储非常有用，因为其他存储选项仅存储流文件。您可以使用公共存储库，在这种情况下，您只需指定注册地址。在这里，我详细描述了私有注册中心所需的配置:</p><p id="4ef0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了允许提督推送映像，在代理的实例上运行<em class="nd"> SSH </em></p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="75e7" class="nj mh iq nf b gy nk nl l nm nn">docker login &lt;registry_address&gt;</span></pre><p id="ac43" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并遵循身份验证步骤。然后，我们需要允许ECS集群提取图像:在AWS上创建一个秘密来存储您的注册表登录，这个ARN在<em class="nd"> credentialsParameter </em>参数中给出。</p><p id="7ea3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，转到角色管理部分，创建一个对这个秘密具有读权限的新角色，然后在<em class="nd"> execution_role_arn </em>中给出这个角色的ARN。</p><p id="7c46" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ECS代理允许两种类型的角色:执行和任务角色。根据您的流程，您可能需要更多的角色。有关角色的信息，请参见提督的<a class="ae lr" href="https://docs.prefect.io/orchestration/agents/ecs.html#task-role-arn" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="8804" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里需要<em class="nd"> task_definition </em>参数，这是为私有注册中心提供凭证的唯一方式。<em class="nd">网络模式</em>、<em class="nd">内存</em>和<em class="nd"> cpu </em>字段为必填字段，阅读本<a class="ae lr" href="https://docs.amazonaws.cn/en_us/AmazonECS/latest/userguide/fargate-task-defs.html" rel="noopener ugc nofollow" target="_blank">文档</a>了解更多信息</p><p id="855b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您使用公共注册表，您可以简单地提供注册表和映像名称。</p><blockquote class="ns nt nu"><p id="04a9" class="kf kg nd kh b ki kj jr kk kl km ju kn nv kp kq kr nw kt ku kv nx kx ky kz la ij bi translated">当我将图像推送到注册表时，我遇到了超时，因为我的图像太大了(在我的例子中是2GB，这是由于机器学习的依赖性)。一个快速的解决方法是手动推送第一个图像，这样具有较大依赖性的公共层已经在我的注册表中可用，下一次推送可以重用它们。</p></blockquote><p id="a0f1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，根据您的代理的标签添加标签，您的流就可以注册了。</p><p id="02ac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要在您的本地机器上执行Prefect命令，您可以安装Prefect并创建<strong class="kh ir"> ~/。比如EC2实例上的文件。每个提督命令现在将连接到您的提督服务器实例。</strong></p><p id="5631" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以运行:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="0d4a" class="nj mh iq nf b gy nk nl l nm nn">prefect create project ‘Hello_Project’</span></pre><p id="e3d8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者通过用户界面创建项目。然后，执行python脚本:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="e4f8" class="nj mh iq nf b gy nk nl l nm nn">python flow.py</span></pre><p id="de72" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将看到映像正在构建并被推送到您的注册表中。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ny"><img src="../Images/093b27f9728dc62b98b931cc05a84b11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OH_rU85FlPSjCkLfkVcEOw.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">注册流程</p></figure><h1 id="29d5" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">运行流程</h1><p id="0ebe" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">然后，您可以直接从UI启动您的流程，快速运行允许您使用默认参数运行流程。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nz"><img src="../Images/1b32a1f7af5b2794aff830310d3388bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z63nhuxEqsCTp2ur52gk3g.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">任务概述</p></figure><p id="f064" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以通过命令行触发它:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="168f" class="nj mh iq nf b gy nk nl l nm nn">prefect run flow -name “Hello” -project “Hello_Project”</span></pre><p id="9de2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以通过GraphQL API启动这个流。这个方法允许您从任何地方触发一个流(这是您的Prefect Server EC2实例上的安全规则所允许的！)只需要一个HTTP请求。下面是一个使用流ID的示例脚本:</p><pre class="lc ld le lf gt ne nf ng nh aw ni bi"><span id="2bdf" class="nj mh iq nf b gy nk nl l nm nn">import json<br/>import urllib.parse<br/>import urllib.request</span><span id="c191" class="nj mh iq nf b gy nr nl l nm nn">PREFECT__FLOW_ID = 'your-flow-id'<br/>PREFECT__CLOUD__API='http://X.X.X.X:4200/graphql'</span><span id="ba00" class="nj mh iq nf b gy nr nl l nm nn">def trigger_flow(flow_id, host):<br/>  create_mutation = """<br/>    mutation {<br/>      create_flow_run(input: { flow_id: "%s" }) {<br/>        id<br/>      }<br/>    }<br/>  """ % (flow_id)</span><span id="d9e9" class="nj mh iq nf b gy nr nl l nm nn">  inputs = dict(flowId=flow_id)<br/>  variables = dict(input=inputs)<br/>  data = json.dumps(<br/>    dict(query=create_mutation, variables=json.dumps(variables))<br/>  ).encode("utf-8")</span><span id="27b1" class="nj mh iq nf b gy nr nl l nm nn">  req = urllib.request.Request(host, data=data)<br/>  req.add_header("Content-Type", "application/json")</span><span id="8bb7" class="nj mh iq nf b gy nr nl l nm nn">  resp = urllib.request.urlopen(req)</span><span id="f12f" class="nj mh iq nf b gy nr nl l nm nn">  return json.loads(resp.read().decode())</span><span id="d524" class="nj mh iq nf b gy nr nl l nm nn">if __name__ == "__main__":<br/>print(trigger_flow(PREFECT__FLOW_ID, PREFECT__CLOUD__API))</span></pre><p id="587b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">更多选项<a class="ae lr" href="https://docs.prefect.io/orchestration/concepts/flow_runs.html#creating-a-flow-run" rel="noopener ugc nofollow" target="_blank">此处</a>。以下是运行该脚本后产生的日志:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi oa"><img src="../Images/eea7bd2ec45bfd7da1e71667df881aad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cmT-wuehGn5eTs1Q7HE1hA.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">流量日志</p></figure><h1 id="1f63" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">结论</h1><p id="a081" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated">我们在本文中详细介绍了如何在EC2上部署一个完美的服务器，以及如何使用带有私有注册中心的Docker存储在ECS集群上运行任务。现在，您已经准备好创建自己的任务了！</p><p id="630c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">资源:</p><ul class=""><li id="0090" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated"><a class="ae lr" rel="noopener" target="_blank" href="/serverless-data-pipelines-made-easy-with-prefect-and-aws-ecs-fargate-7e25bacb450c#4a07">https://towards data science . com/server less-data-pipelines-made-easy-with-prefect-and-aws-ECS-fargate-7 e 25 BAC b450 c # 4a 07</a>和<a class="ae lr" href="https://www.lejimmy.com/distributed-data-pipelines-with-aws-ecs-fargate-and-prefect-cloud/" rel="noopener ugc nofollow" target="_blank">https://www . le Jimmy . com/distributed-data-pipelines-with-AWS-ECS-fargate-and-prefect-cloud/</a>提供了关于AWS配置的更多细节</li><li id="5067" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated"><a class="ae lr" href="https://docs.prefect.io/" rel="noopener ugc nofollow" target="_blank">https://docs.prefect.io/</a>提督文档</li><li id="6c5a" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated"><a class="ae lr" href="https://prefect-slackin.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">https://prefect-slackin.herokuapp.com/</a>提督社区懈怠</li></ul></div></div>    
</body>
</html>