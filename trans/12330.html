<html>
<head>
<title>Perspective versus Affine Transformation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">透视与仿射变换</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/perspective-versus-affine-transformation-25033cef5766?source=collection_archive---------5-----------------------#2021-12-15">https://towardsdatascience.com/perspective-versus-affine-transformation-25033cef5766?source=collection_archive---------5-----------------------#2021-12-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4803" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">图像保持线平行吗？</h2></div><p id="6fe4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你有没有注意到，当你拍摄一个矩形平面物体的图像时，角很少是90度？</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/9c3defe6e5e441ad975d7e05cbd3959b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*waUQNP7o27vd6sa-O12-1A.jpeg"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">图1:透视投影扭曲的矩形。在<a class="ae lr" href="https://unsplash.com/s/photos/street-sign?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上M<a class="ae lr" href="https://unsplash.com/@matt__feeney?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">at the Feeney</a>拍摄的照片</p></figure><p id="0054" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这种现象是<a class="ae lr" href="https://en.wikipedia.org/wiki/3D_projection#Perspective_projection" rel="noopener ugc nofollow" target="_blank">透视投影</a>的一个特征，3D场景中的点(例如，矩形的角)通过一个针孔被投影到一个平面(相机图像传感器)上。靠近摄像机的线段看起来比距离摄像机较远的相同长度的线段长。直角可能变成锐角或钝角，平行线可能看起来会向消失点会聚。</p><p id="2c2e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在自动检查平面物体的情况下，透视变形可能是一个问题。因为我们想要检查对象特征是否具有正确的形状和大小，所以我们想要“反转”透视变形。如果我们能做到这一点，我们就能得到一幅图像，使物体看起来好像照相机的轴垂直于物体的表面。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ls"><img src="../Images/6cb5598f31d56b98756172140d0a3a3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vMfNoazIW6V-co7oCg35tQ.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">图2:左:从两个不同的角度看一本书的图像。右图:透视变形得到补偿后的对应图像。图片由作者提供。</p></figure><p id="3416" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">图2显示了反转透视扭曲的效果(代码<a class="ae lr" href="https://github.com/sebastiengilbert73/tutorial_affine_perspective/blob/main/book_compute_transforms.py" rel="noopener ugc nofollow" target="_blank">此处为</a>)。在这种情况下，书的角被映射到一个正方形的任意点上，用红色圆圈标记。右侧的图像更适合自动检测，因为可以轻松定位特征并与模板进行比较。</p><h1 id="7240" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">翘曲，对，但是哪一个？</h1><p id="ece5" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我们希望<em class="mq">扭曲</em>受透视失真影响的图像，使其恢复感兴趣平面的特征:角度失真最小，3D中的平行线看起来平行。</p><p id="854a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">OpenCV提供了两个函数来做到这一点:<a class="ae lr" href="https://docs.opencv.org/2.4/modules/imgproc/doc/geometric_transformations.html?highlight=resize#warpaffine" rel="noopener ugc nofollow" target="_blank"> warpAffine() </a>和<a class="ae lr" href="https://docs.opencv.org/2.4/modules/imgproc/doc/geometric_transformations.html?highlight=resize#warpperspective" rel="noopener ugc nofollow" target="_blank"> warpPerspective() </a>。它们具有相同的签名，除了warpAffine()需要2×3的变换矩阵，而warpPerspective()需要3×3的变换矩阵。这些矩阵分别由函数<a class="ae lr" href="https://docs.opencv.org/2.4/modules/imgproc/doc/geometric_transformations.html?highlight=resize#getaffinetransform" rel="noopener ugc nofollow" target="_blank"> getAffineTransform() </a>和<a class="ae lr" href="https://docs.opencv.org/2.4/modules/imgproc/doc/geometric_transformations.html?highlight=resize#getperspectivetransform" rel="noopener ugc nofollow" target="_blank">getperspective transform()</a>计算。前者期望三对匹配坐标，后者期望四对匹配坐标。直观地说，得到三对比得到四对更容易，所以问题出现了:在什么情况下我们可以摆脱三对坐标，使用仿射变换而不是透视变换？</p><p id="6f5f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了回答这个问题，让我们考虑图3中的两幅图像。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mr"><img src="../Images/26a6997bf63a4c45209b458213c2f066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCOWOLd2MTIKtMCirc7OLw.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">图3:左图:棋盘格图像，相机在大约1米处。右图:棋盘格图像，相机在大约7米处。图片由作者提供。</p></figure><p id="9c9a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然棋盘在两次图像捕捉之间没有移动，但图案看起来不同。在右侧图像中，相机距离物体约7米，线平行度比左侧图像保持得更好。如果我们计算仿射和透视变换，然后相应地扭曲这些图像(代码<a class="ae lr" href="https://github.com/sebastiengilbert73/tutorial_affine_perspective/blob/main/compute_transforms.py" rel="noopener ugc nofollow" target="_blank">这里是</a>)，我们将获得如图4和图5所示的图像。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ls"><img src="../Images/6ad46791564fb037c952f636f1250c03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CSltPNEngjo4lNWq7CD1xA.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">图4:图3图像的仿射变换。棋盘上的点A、B和C被映射到相应的用红圈标记的任意点。图片由作者提供。</p></figure><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ls"><img src="../Images/0dc0a905206b1ef04b1a8ba663d52202.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q0jigDZbpuL0_mbLWGo19w.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">图5:图3中图像的透视变换。棋盘上的点A、B、C和D被映射到相应的用红色圆圈标记的任意点上。图片由作者提供。</p></figure><p id="7ee9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">图4显示了使用点A、B和c的仿射变换的效果。右侧图像(在约7m处拍摄)得到了相当好的补偿，尽管并不完美(见图6)。左侧图像仍然严重失真，因为点D(在图像中甚至不可见)没有投影到靠近其对应的红色圆圈的任何地方。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/d947d154e689dc35b06596345789cfc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:360/format:webp/1*fkE2fUm_3pCfMPhv66_8bw.png"/></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">图6:图4的细节。D点(蓝色圆盘)被投影得很近，但不完全在红色圆圈的中心。图片由作者提供。</p></figure><p id="d921" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">图5显示了透视变换的效果。因为四个共面点A、B、C和D用于计算变换矩阵，所以透视变形在两种情况下都得到了很好的补偿，并且图像看起来相同。</p><p id="e28b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们应该使用的标准是<strong class="kh ir">保持线平行度</strong>。<a class="ae lr" href="https://en.wikipedia.org/wiki/Affine_transformation" rel="noopener ugc nofollow" target="_blank">仿射变换保持线平行</a>。如果要检查的物体在3D世界中具有平行线，并且图像中的对应线是平行的(例如图3的情况，右侧)，仿射变换就足够了。相反，如果3D世界中的平行线在图像中发散(例如图3左侧的情况)，仿射变换是不够的:我们需要透视变换。</p><h1 id="5098" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">透视变换的推导</h1><p id="b6ee" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">将平面场景与像素坐标联系起来的透视变换来自于通过针孔的3D到2D投影的一般情况:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/31cc1c9d07a5da2fedb0f28bc3802fc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*6WYDih9GnyOYVywzuMgP8w.png"/></div></figure><p id="4e77" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">…其中f是焦距，(lx，ly)是像素的物理尺寸，(cx，cy)是相机的光学中心，以像素为单位。</p><p id="4408" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">等式(1)明确示出了针孔相机模型如何将3D点(X，Y，Z)投影到图像坐标(u，v ),直到缩放因子λ。从右到左阅读，它会说:</p><blockquote class="mu mv mw"><p id="754d" class="kf kg mq kh b ki kj jr kk kl km ju kn mx kp kq kr my kt ku kv mz kx ky kz la ij bi translated">通过旋转和平移将世界坐标中的点转换为相机坐标中的坐标，然后将这些坐标投影到传感器平面中。</p></blockquote><p id="eb90" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">投影矩阵P具有3×4的形状。</p><p id="f32a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">与透视变换的联系来自于场景(点(X，Y，Z)所在的地方)是平面的假设。</strong>因此，Z = αX + βY + γ:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi na"><img src="../Images/75f81ab7b3019c85762fdfce350d4d8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:696/format:webp/1*DpWf2WHLI7dlNktOG-gpjA.png"/></div></figure><p id="eded" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将等式(2)中的P项与α、β和γ混合，给出了新的3×3未知矩阵M，<strong class="kh ir">透视变换矩阵</strong>:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/d603784fbabf351d69b5821b1a84259b.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/format:webp/1*yoxFyYIqNiaw2imdrh41FQ.png"/></div></figure><p id="99b1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了求解m的项，我们必须首先在方程(3)中代入λ=m₂₀ X + m₂₁ Y +m₂₂，这给了我们两个含有九个未知数的齐次线性方程:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/e3a050f0957d098d5b902e1b6a807e8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*KYQ_K55lc8Xt3YlXeZ7qVw.png"/></div></figure><p id="c011" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用物平面中的坐标(X，Y)和它们的像素值(u，v)之间的四个对应关系来求解透视变换矩阵M的九个元素(达到一个比例因子)。</p><blockquote class="mu mv mw"><p id="8f98" class="kf kg mq kh b ki kj jr kk kl km ju kn mx kp kq kr my kt ku kv mz kx ky kz la ij bi translated">我们有九个未知数。既然每封信都为我们提供了两个含有九个未知数的线性方程，为什么四封信(以及八个线性方程)就足够了呢？</p></blockquote><p id="71c7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为我们处理的是<a class="ae lr" href="https://en.wikipedia.org/wiki/System_of_linear_equations#Homogeneous_systems" rel="noopener ugc nofollow" target="_blank">齐次线性方程组</a>，即方程(4)的右边是一个零向量。如果我们添加第九个独立的线性方程，我们将会陷入平凡解m₀₀ = m₀₁ = … = m₂₂ = 0。我们通过求解四对方程(4)获得的解可以通过任意非零因子来缩放。我们通常用这个自由度来设定m₂₂=1.</p><h1 id="660b" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">仿射变换</h1><p id="4c61" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">如前所述，仿射变换保持线平行。这意味着一个平行四边形总是映射到另一个平行四边形。当我们计算具有来自两个平行四边形的四个对应的透视变换矩阵时(例如图5的情况，右侧)，我们观察到m₂₀和m₂₁项非常接近于零。你可以用<a class="ae lr" href="https://github.com/sebastiengilbert73/tutorial_affine_perspective/blob/main/parallelogram_mapping.py" rel="noopener ugc nofollow" target="_blank">这个脚本</a>来验证这个观察结果，这个脚本比较了普通四边形和平行四边形之间的透视变换矩阵。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nd"><img src="../Images/72327f4a8b565937fb12d0a71c3ce175.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4rJUpMtw60hIEtoAH9kOdA.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">图7:映射两个平行四边形的角的透视变换矩阵的第三行约为[0 0 1]。图片由作者提供。</p></figure><p id="7a72" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你对经验观察不满意，这里有一个更有说服力的论点:</p><blockquote class="mu mv mw"><p id="4d37" class="kf kg mq kh b ki kj jr kk kl km ju kn mx kp kq kr my kt ku kv mz kx ky kz la ij bi translated">平行四边形到另一个平行四边形的映射可以分解为平移、旋转、剪切、轴缩放、剪切、旋转和平移(加上可选的反射)。这些变换中的每一个都可以由第三行是[0 0 1]的矩阵来表示，因此它们的乘积的第三行也是[0 0 1]。</p></blockquote><p id="a6ea" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">仿射变换的特殊情况的等式(3)可以写成:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi ne"><img src="../Images/d99ad27c5ab8aa02c317294b8f17addd.png" data-original-src="https://miro.medium.com/v2/resize:fit:816/format:webp/1*mHP6Bn4xD0tAD30Q1_FlCw.png"/></div></div></figure><p id="ecaa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">…我们使用透视变换矩阵的自由度来任意设置a₂₂=1，通过这样做，我们摆脱了(烦人的)λ乘数。我们可以重新排列这些项，以展平未知向量中的仿射变换项:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/4998e6a58af7662f47d1b7090d93b5fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:822/format:webp/1*A6kAQPVVvMfpG94xkUUe8w.png"/></div></figure><p id="498e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过(6)，每封信为我们提供了两个6个未知数的线性方程。这就是为什么三个对应足以定义一个仿射变换矩阵。</p><h1 id="f46f" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">结论</h1><p id="bf57" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我们从一组对应关系中解决了在平面场景中用像素坐标映射坐标的问题。哪种类型的变换，透视变换还是仿射变换，这个问题占据了本文的中心部分。</p><p id="a8b9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我必须承认，直到最近我才注意到这个问题。我面临的情况是，除了三个对应点之外，转换没有将对象特征映射到它们的理论位置。在深入挖掘透视变换矩阵的起源后，我对仿射变换矩阵的特殊情况有了更好的理解。我希望现在已经很清楚，我们必须注意保持平行，以便决定转变的类型。</p><p id="e1b0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢您的宝贵时间！</p><p id="fbf4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[1]在真正的相机中，镜头取代了针孔。镜头允许更多的光到达传感器，代价是减少了景深。</p><p id="dea3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[2]图书参考:<em class="mq">从A到Z，动物和字母的惊人冒险</em>，索菲·罗森恩·鲍彻，马克索&amp;毕索，2021</p></div></div>    
</body>
</html>