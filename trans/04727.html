<html>
<head>
<title>Solve a real-world churn problem with machine learning (including a detailed case study)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用机器学习解决现实世界的客户流失问题(包括详细的案例研究)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/solve-a-real-world-churn-problem-with-machine-learning-including-a-detailed-case-study-a41dac0150b9?source=collection_archive---------15-----------------------#2021-04-24">https://towardsdatascience.com/solve-a-real-world-churn-problem-with-machine-learning-including-a-detailed-case-study-a41dac0150b9?source=collection_archive---------15-----------------------#2021-04-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/9a6721db1328c8bda33ba66e73b81519.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9fSdLJZXtF7ZAGYIgMOsfg.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">照片由<a class="ae jd" href="https://burst.shopify.com/@matthew_henry?utm_campaign=photo_credit&amp;utm_content=Free+Money+Hides+Face+Photo+%E2%80%94+High+Res+Pictures&amp;utm_medium=referral&amp;utm_source=credit" rel="noopener ugc nofollow" target="_blank">马太·亨利</a>发自<a class="ae jd" href="https://burst.shopify.com/bank?utm_campaign=photo_credit&amp;utm_content=Free+Money+Hides+Face+Photo+%E2%80%94+High+Res+Pictures&amp;utm_medium=referral&amp;utm_source=credit" rel="noopener ugc nofollow" target="_blank">突发</a></p></figure><div class=""/><div class=""><h2 id="7002" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">使用R &amp; Tidyverse</h2></div></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="0cfe" class="lc ld jg bd le lf lg lh li lj lk ll lm km ln kn lo kp lp kq lq ks lr kt ls lt bi translated">流失定义</h1><p id="031d" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">客户流失是大多数公司面临的主要问题。失去客户需要获得新的客户来替代他们。根据领域的不同，这可能比留住现有客户要贵10倍左右。</p><p id="7545" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">当客户停止使用你公司的产品或服务时，他/她被认为是流失。这对于合同设置来说很容易定义，因为当客户未能续签合同时，就被认为是流失客户。但在非合同环境中，没有明确的规则来定义客户流失。在大多数情况下，具有扩展领域知识的业务用户与数据科学家/数据分析师一起工作，来定义在特定问题中什么被认为是变动。例如，在一个零售组织中，当一个客户在过去4个月中没有购买任何东西时，团队可以将他定义为流失客户。</p><h1 id="b8f8" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">客户流失管理的好处</h1><p id="2635" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">主要好处是通过获得更高的保留率和客户满意度来增加收入。另一个好处是通过有针对性的营销活动优化营销支出&amp;重新分配营销预算。</p><h1 id="c2a2" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">流失率</h1><p id="d8b7" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">您可以通过将我们在特定时期(比如一个季度或一年)失去的客户数量除以该时期开始时我们拥有的客户数量来计算流失率。</p><p id="9141" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">例如，如果我们这个季度开始时有400个客户，结束时有380个，我们的流失率是5%，因为我们失去了5%或20个客户。</p><h1 id="2596" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">我们的流失问题</h1><p id="8c6b" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">我们的案例研究是一家银行，该银行希望开发一个客户流失模型来预测客户流失的可能性。银行业已经成为发达国家的主要产业之一。技术进步和银行数量的增加提高了竞争水平。银行依靠多种策略努力在这个竞争激烈的市场中生存。</p><p id="1e84" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">提出了三个主要战略来增加收入:</p><ul class=""><li id="c368" class="na nb jg lw b lx mq ma mr md nc mh nd ml ne mp nf ng nh ni bi translated"><strong class="lw jh">获取新客户</strong></li><li id="e05e" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated">向现有客户追加销售(说服客户购买额外的或更贵的东西)</li><li id="e001" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh">增加客户保持期</strong></li></ul><p id="ac3a" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">在我们的案例中，我们专注于最后一个策略，即增加客户的保留期。原始数据集是公共的，可以在<a class="ae jd" href="https://www.kaggle.com/shrutimechlearn/churn-modelling" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>找到</p><h1 id="b8a0" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">导入库</h1><p id="a229" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">首先，我们加载所有的库。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="5b71" class="nx ld jg nt b gy ny nz l oa ob">library(tidyverse) <br/>library(ggthemes) <br/>library(correlationfunnel) <br/>library(knitr) <br/>library(caret) <br/>library(recipes) <br/>library(yardstick)<br/>library(DT) </span><span id="9f2a" class="nx ld jg nt b gy oc nz l oa ob"># Set the black &amp; white theme for all plots <br/>theme_set(theme_bw())</span></pre><h1 id="51d6" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">加载数据集</h1><p id="a6a2" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">我们使用read_csv()函数(来自readr库)来读取r中的csv文件。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="5718" class="nx ld jg nt b gy ny nz l oa ob">bank &lt;- read_csv(file = "/Users/manos/OneDrive/Projects/R/All_Projects/Churn/data/Churn_Modelling.csv") </span><span id="e8ff" class="nx ld jg nt b gy oc nz l oa ob">bank &lt;- <br/>bank %&gt;% mutate(Churn = if_else(Exited == 0, "No", "Yes"), <br/>                HasCrCard = if_else(HasCrCard == 0, "No", "Yes"), <br/>                IsActiveMember = if_else(IsActiveMember == 0, "No", "Yes")) %&gt;% <br/>select(- RowNumber, -CustomerId, - Surname, -Exited)</span></pre><h1 id="eb50" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">检查数据集</h1><p id="965b" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">使用glimpse()函数检查数据集。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="b223" class="nx ld jg nt b gy ny nz l oa ob">bank %&gt;% glimpse()</span><span id="e628" class="nx ld jg nt b gy oc nz l oa ob">## Rows: 10,000 <br/>## Columns: 11 <br/>## $ CreditScore &lt;dbl&gt; 619, 608, 502, 699, 850, 645, 822, 376, 501, 684, 528... <br/>## $ Geography &lt;chr&gt; "France", "Spain", "France", "France", "Spain", "Spai... <br/>## $ Gender &lt;chr&gt; "Female", "Female", "Female", "Female", "Female", "Ma... <br/>## $ Age &lt;dbl&gt; 42, 41, 42, 39, 43, 44, 50, 29, 44, 27, 31, 24, 34, 2... <br/>## $ Tenure &lt;dbl&gt; 2, 1, 8, 1, 2, 8, 7, 4, 4, 2, 6, 3, 10, 5, 7, 3, 1, 9... <br/>## $ Balance &lt;dbl&gt; 0.00, 83807.86, 159660.80, 0.00, 125510.82, 113755.78... <br/>## $ NumOfProducts &lt;dbl&gt; 1, 1, 3, 2, 1, 2, 2, 4, 2, 1, 2, 2, 2, 2, 2, 2, 1, 2,... <br/>## $ HasCrCard &lt;chr&gt; "Yes", "No", "Yes", "No", "Yes", "Yes", "Yes", "Yes",... <br/>## $ IsActiveMember &lt;chr&gt; "Yes", "Yes", "No", "No", "Yes", "No", "Yes", "No", "... <br/>## $ EstimatedSalary &lt;dbl&gt; 101348.88, 112542.58, 113931.57, 93826.63, 79084.10, ... <br/>## $ Churn &lt;chr&gt; "Yes", "No", "Yes", "No", "No", "Yes", "No", "Yes", "...</span></pre><p id="c310" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">下面是数据集所有变量的详细描述</p><ul class=""><li id="84d8" class="na nb jg lw b lx mq ma mr md nc mh nd ml ne mp nf ng nh ni bi translated"><strong class="lw jh">信用评分</strong> |信用评分是一个介于300-850之间的数字，用来描述消费者的信誉。分数越高，借款人对潜在的贷款人来说就越好</li><li id="70b1" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh">地理位置</strong> |客户所在国家</li><li id="49b8" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh">性别</strong> |客户性别</li><li id="63ba" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh">年龄</strong> |客户年龄</li><li id="660b" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh">任期</strong> |客户在银行工作的年数</li><li id="444a" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh">余额</strong> |客户当前余额</li><li id="2b1d" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh"> NumOfProducts </strong> |客户正在使用的银行产品数量</li><li id="110d" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh"> HasCrCard </strong> |是否有信用卡</li><li id="e0b9" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh"> IsActiveMember </strong> |客户是否为活跃会员</li><li id="06e1" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh">预计工资</strong> |客户的预计工资</li><li id="6ae3" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated"><strong class="lw jh">搅动</strong> |客户是否搅动</li></ul><h1 id="10a1" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">检查缺少的值</h1><p id="e221" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">任何数据分析中最常见的问题之一是发现和处理缺失数据。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="88af" class="nx ld jg nt b gy ny nz l oa ob">bank %&gt;% <br/>map_df(~ sum(is.na(.))) %&gt;% <br/>gather() %&gt;% <br/>arrange(desc(value))</span><span id="5ab0" class="nx ld jg nt b gy oc nz l oa ob">## <br/># A tibble: 11 x 2 <br/>## key value <br/>## &lt;chr&gt; &lt;int&gt; <br/>## 1 CreditScore 0 <br/>## 2 Geography 0 <br/>## 3 Gender 0 <br/>## 4 Age 0 <br/>## 5 Tenure 0 <br/>## 6 Balance 0 <br/>## 7 NumOfProducts 0 <br/>## 8 HasCrCard 0 <br/>## 9 IsActiveMember 0 <br/>## 10 EstimatedSalary 0 <br/>## 11 Churn 0</span></pre><p id="e374" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">没有任何丢失的值。</p><h1 id="034e" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">检查分类/文本变量的级别</h1><p id="348e" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">现在我们要检查所有分类变量的级别。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="6296" class="nx ld jg nt b gy ny nz l oa ob">bank %&gt;% summarise_if(is.character, n_distinct) %&gt;% t()</span><span id="87dc" class="nx ld jg nt b gy oc nz l oa ob">## [,1] <br/>## Geography 3 <br/>## Gender 2 <br/>## HasCrCard 2 <br/>## IsActiveMember 2 <br/>## Churn 2</span></pre><p id="335c" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">看起来所有的字符变量都是具有几个级别(2-3)的分类变量。</p><h1 id="510e" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">分类变量分布</h1><p id="38eb" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">现在我们要检查有关流失的分类变量的分布。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="69ba" class="nx ld jg nt b gy ny nz l oa ob">bank %&gt;% <br/>select_if(is.character) %&gt;% <br/>gather(key = key, value = value, - Churn, factor_key = T) %&gt;% ggplot(aes( x = value, fill = Churn)) + geom_bar() + facet_wrap(~key, scales = 'free') + <br/>scale_x_discrete(labels = abbreviate) + <br/>labs( title = 'Distribution of categorical variables in relation to churn', x = '') + <br/>scale_fill_economist()</span></pre><figure class="no np nq nr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi od"><img src="../Images/b084dc27501d7585dac3609779a2645b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BIgYpvK14kCGdNoL.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><p id="4c0d" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">主要发现是:</p><ul class=""><li id="461a" class="na nb jg lw b lx mq ma mr md nc mh nd ml ne mp nf ng nh ni bi translated">来自德国的顾客更有可能流失</li><li id="68ef" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated">男性客户流失的可能性略低</li><li id="89e2" class="na nb jg lw b lx nj ma nk md nl mh nm ml nn mp nf ng nh ni bi translated">活跃成员不太可能流失</li></ul><h1 id="73e4" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">数值变量分布</h1><p id="e582" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">检查与客户流失相关的数字变量的分布。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="a8be" class="nx ld jg nt b gy ny nz l oa ob">bank %&gt;% <br/>select_if(function(col) is.numeric(col) | all(col == .$Churn)) %&gt;%<br/>gather(key = "Variable", value = "Value", -Churn) %&gt;% ggplot(aes(Value, fill = Churn)) + <br/>geom_histogram(bins = 20) + <br/>facet_wrap(~ Variable, scales = "free") + <br/>labs( title = "Numerical variables histograms", x = "" ) + scale_fill_economist()</span></pre><figure class="no np nq nr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi od"><img src="../Images/368183c0443f64b6ede9c21009dfa4c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-iNHE3nvBeTlsNMs.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><p id="d8ed" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">年龄越大，流失的可能性就越大</p><h1 id="4b2a" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">相关漏斗</h1><p id="bf57" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">相关性是理解变量之间关系的一个非常重要的度量。软件包<a class="ae jd" href="https://business-science.github.io/correlationfunnel/index.html" rel="noopener ugc nofollow" target="_blank"><strong class="lw jh">correlation funnel</strong></a>生成一个图表，帮助我们了解所有变量(分类&amp;数值)与流失的关系。</p><p id="5954" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">首先，它创建每个类别变量的二元变量和每个数值变量的4个箱(基于分位数)。它从最相关到最不相关的所有变量开始绘制。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="ae64" class="nx ld jg nt b gy ny nz l oa ob"># Create correlation Funnel <br/>bank %&gt;% <br/>drop_na() %&gt;% <br/>binarize() %&gt;% <br/>correlate(Churn__Yes) %&gt;% <br/>plot_correlation_funnel()</span></pre><figure class="no np nq nr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi od"><img src="../Images/5f234a2c1eac14d69174a767b7c4247a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bAwLZsnFK549obYJ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><p id="3a90" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">看起来年龄、产品数量、地理位置和会员活动都很重要。平衡和性别不那么重要。信用评分、任期、预计工资和信用卡似乎对客户流失不重要，因为几乎所有类别的相关性都接近于零。</p><h1 id="928a" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated"><strong class="ak">建模</strong></h1><p id="2c9f" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">现在，我们可以继续开发一个机器学习模型，预测所有客户的流失概率。</p><h1 id="a0c3" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">分割数据集</h1><p id="f612" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">首先，我们将数据集分为两部分，训练和测试数据集。我们将使用训练数据集来训练我们的模型&amp;测试数据集来检查模型的性能。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="3c2e" class="nx ld jg nt b gy ny nz l oa ob"># Split the dataset in two parts <br/>set.seed(1) <br/>inTrain = createDataPartition(bank$Churn, p = .70)[[1]] </span><span id="b0f2" class="nx ld jg nt b gy oc nz l oa ob"># Assign the 70% of observations to training data <br/>training &lt;- bank[inTrain,] </span><span id="1068" class="nx ld jg nt b gy oc nz l oa ob"># Assign the remaining 30 % of observations to testing data <br/>testing &lt;- bank[-inTrain,]</span></pre><h1 id="1de8" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">为建模准备数据配方</h1><p id="e24a" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">这里，我们使用recipes包将相同的预处理步骤应用于训练和测试数据。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="d72b" class="nx ld jg nt b gy ny nz l oa ob"># Create the recipe object <br/>recipe_obj &lt;- recipe(Churn ~ ., data = training) %&gt;% step_zv(all_predictors()) %&gt;% # check any zero variance features step_center(all_numeric()) %&gt;% <br/>step_scale(all_numeric()) %&gt;% # scale the numeric features <br/>prep()</span></pre><h1 id="e8bd" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">根据配方处理数据</h1><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="0a19" class="nx ld jg nt b gy ny nz l oa ob">train_data &lt;- bake(recipe_obj, training) <br/>test_data &lt;- bake(recipe_obj, testing)</span></pre><h1 id="64ff" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">为建模设置列车控制</h1><p id="c1cd" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">我们使用TrainControl()函数在模型训练期间指定一些参数，例如重采样方法、K-Fold中的折叠数等。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="babe" class="nx ld jg nt b gy ny nz l oa ob">train_ctr &lt;- trainControl(method = 'cv', number = 10, classProbs = TRUE, summaryFunction = twoClassSummary)</span></pre><h1 id="9bf1" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">开发多种机器学习模型</h1><p id="6451" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">开发一个<strong class="lw jh">逻辑回归</strong>模型</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="c811" class="nx ld jg nt b gy ny nz l oa ob">Logistic_model &lt;- train(Churn ~ ., data = train_data, method = 'glm', family = 'binomial', trControl = train_ctr, metric = 'ROC')</span></pre><p id="185f" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">开发一个<strong class="lw jh">随机森林</strong>模型</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="548e" class="nx ld jg nt b gy ny nz l oa ob">rf_model &lt;- train(Churn ~ ., data = train_data, method = 'rf', trControl = train_ctr, tuneLength = 5, metric = 'ROC')</span></pre><p id="c0fe" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">开发一个<strong class="lw jh"> XGBoost模型</strong></p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="3623" class="nx ld jg nt b gy ny nz l oa ob">xgb_model &lt;- train(Churn ~ ., data = train_data, method = 'xgbTree', trControl = train_ctr, tuneLength = 5, metric = 'ROC')</span></pre><h1 id="e77e" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">模型比较</h1><p id="cef3" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">在这一步，我们将比较模型的准确性。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="e5b4" class="nx ld jg nt b gy ny nz l oa ob">model_list &lt;- resamples(list(Logistic = Logistic_model, Random_forest = rf_model, XgBoost = xgb_model)) summary(model_list)</span><span id="8bb3" class="nx ld jg nt b gy oc nz l oa ob">## <br/>## Call: <br/>## summary.resamples(object = model_list) <br/>## <br/>## Models: Logistic, Random_forest, XgBoost <br/>## Number of resamples: 10 <br/>## <br/>## ROC <br/>## Min. 1st Qu. Median Mean 3rd Qu. Max. NA's <br/>## Logistic 0.7310692 0.7629073 0.7713738 0.7685092 0.7793850 0.7893184 0 <br/>## Random_forest 0.8257989 0.8573118 0.8669290 0.8653269 0.8735644 0.8900139 0 <br/>## XgBoost 0.8445059 0.8651163 0.8716812 0.8717819 0.8818719 0.8984382 0 <br/>## <br/>## Sens <br/>## Min. 1st Qu. Median Mean 3rd Qu. Max. NA's <br/>## Logistic 0.9408602 0.9573794 0.9605027 0.9612578 0.9654857 0.9820789 0 <br/>## Random_forest 0.9425494 0.9546864 0.9631957 0.9608965 0.9681900 0.9802513 0 <br/>## XgBoost 0.9498208 0.9609515 0.9641577 0.9648430 0.9677275 0.9784946 0 <br/>## <br/>## Spec <br/>## Min. 1st Qu. Median Mean 3rd Qu. Max. NA's <br/>## Logistic 0.1818182 0.2126465 0.2245395 0.2307003 0.2376761 0.3076923 0 <br/>## Random_forest 0.3732394 0.4534128 0.4825175 0.4803211 0.5131119 0.5594406 0 <br/>## XgBoost 0.4265734 0.4797843 0.4964789 0.4902098 0.5034965 0.5524476 0</span></pre><p id="a6bf" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">基于ROC (AUC值)的最佳模型是<strong class="lw jh"> XgBoost </strong>。最佳模型的AUC值(逻辑回归的平均值)为<strong class="lw jh"> 0.87 </strong>。一般来说，AUC值为0.7的模型被认为是有用的，当然这取决于问题的背景。</p><h1 id="3e84" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">模型评估</h1><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="4ad1" class="nx ld jg nt b gy ny nz l oa ob"># Predictions on test data <br/>pred_logistic &lt;- predict(Logistic_model, newdata = test_data, type = 'prob') </span><span id="ac7e" class="nx ld jg nt b gy oc nz l oa ob">pred_rf &lt;- predict(rf_model, newdata = test_data, type = 'prob') </span><span id="fb3f" class="nx ld jg nt b gy oc nz l oa ob">pred_xgb &lt;- predict(xgb_model, newdata = test_data, type = 'prob') </span><span id="ed4a" class="nx ld jg nt b gy oc nz l oa ob">evaluation_tbl &lt;- tibble(true_class = test_data$Churn, </span><span id="c87a" class="nx ld jg nt b gy oc nz l oa ob">logistic_churn = pred_logistic$Yes, rf_churn = pred_rf$Yes, xgb_churn = pred_xgb$Yes) </span><span id="66c2" class="nx ld jg nt b gy oc nz l oa ob">evaluation_tbl</span><span id="2d1b" class="nx ld jg nt b gy oc nz l oa ob">## # A tibble: 2,999 x 4 <br/>## true_class logistic_churn rf_churn xgb_churn <br/>## &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; <br/>## 1 Yes 0.125 0.276 0.297 <br/>## 2 No 0.234 0.178 0.0503 <br/>## 3 Yes 0.289 0.758 0.997 <br/>## 4 No 0.112 0.158 0.0631 <br/>## 5 No 0.0600 0.002 0.0139 <br/>## 6 No 0.160 0.006 0.0324 <br/>## 7 No 0.0991 0.002 0.0349 <br/>## 8 No 0.0669 0.042 0.0267 <br/>## 9 No 0.232 0.164 0.246 ## 10 No 0.0311 0.056 0.0181 <br/>## # ... with 2,989 more rows</span></pre><h1 id="01ef" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">受试者工作特征曲线</h1><p id="e210" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">ROC曲线或受试者操作特征曲线是说明二元分类器系统在其辨别阈值变化时的诊断能力的图。</p><p id="fd68" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">即模型在不同阈值下的预测能力</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="f34b" class="nx ld jg nt b gy ny nz l oa ob"># set the second level as the positive class options(yardstick.event_first = FALSE) </span><span id="2f49" class="nx ld jg nt b gy oc nz l oa ob"># creating data for ploting ROC curve <br/>roc_curve_logistic &lt;- <br/>roc_curve(evaluation_tbl, true_class, logistic_churn) %&gt;% mutate(model = 'logistic') </span><span id="d4be" class="nx ld jg nt b gy oc nz l oa ob"><br/>roc_curve_rf &lt;- roc_curve(evaluation_tbl, true_class, rf_churn) %&gt;% mutate(model = 'RF') roc_curve_xgb &lt;- roc_curve(evaluation_tbl, true_class, xgb_churn) %&gt;% mutate(model = 'XGB') # combine all the roc curve data roc_curve_combine_tbl &lt;- Reduce(rbind, list(roc_curve_logistic, roc_curve_rf, roc_curve_xgb)) head(roc_curve_combine_tbl,10)</span><span id="ad0d" class="nx ld jg nt b gy oc nz l oa ob">## # A tibble: 10 x 4 ## .threshold specificity sensitivity model ## &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; ## 1 -Inf 0 1 logistic ## 2 0.0115 0 1 logistic ## 3 0.0118 0.000419 1 logistic ## 4 0.0134 0.000838 1 logistic ## 5 0.0137 0.00126 1 logistic ## 6 0.0141 0.00168 1 logistic ## 7 0.0144 0.00209 1 logistic ## 8 0.0149 0.00251 1 logistic ## 9 0.0152 0.00293 1 logistic ## 10 0.0154 0.00293 0.998 logistic</span><span id="0d9e" class="nx ld jg nt b gy oc nz l oa ob"># Plot ROC curves roc_curve_combine_tbl %&gt;% ggplot(aes(x = 1- specificity, y = sensitivity, color = model))+ geom_line(size = 1)+ geom_abline(linetype = 'dashed')+ scale_color_tableau()+ labs(title = 'ROC curve Comparison', x = '1 - Specificity', y = 'Sensitivity')</span></pre><figure class="no np nq nr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi od"><img src="../Images/3fd6ee2f9eef987feef2f7a13a24ff4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4aCKUbcedWzfJ-k-.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><p id="d9f9" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">AUC值越大，模型精确度越好。</p><h1 id="d451" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">特征重要性</h1><p id="2260" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">理解模型是如何工作的很重要，尤其是在客户流失模型的情况下。一种常用的度量是全局特征重要性。它衡量每个变量对客户流失预测的贡献。</p><p id="4926" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">这种重要性是为数据集中的每个属性显式计算的，允许对属性进行排序和相互比较。对于单个决策树，重要性通过每个属性分割点改进性能度量的量来计算，通过节点负责的观察的数量来加权。然后，对模型中所有决策树的特征重要性进行平均。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="8a8c" class="nx ld jg nt b gy ny nz l oa ob">ggplot(varImp(xgb_model)) + <br/>labs(title = "Feature Importance for XGBoost churn model")</span></pre><figure class="no np nq nr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi od"><img src="../Images/9c1d7e8cedcea9d2aeb134a09012a79e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CXEpE5LHADcCBI8w.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><p id="794d" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">看起来前2个最重要的特征是:<br/> — <strong class="lw jh">年龄</strong>—<br/>—<strong class="lw jh">产品数量</strong></p><h1 id="d6bd" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">预测新客户的流失</h1><p id="d6e9" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">当我们想要对客户进行预测时，我们可以遵循以下流程。</p><pre class="no np nq nr gt ns nt nu nv aw nw bi"><span id="0021" class="nx ld jg nt b gy ny nz l oa ob">new_data &lt;- read_csv(file = "/Users/manos/OneDrive/Projects/R/All_Projects/Churn/data/new_data_bank.csv") </span><span id="e594" class="nx ld jg nt b gy oc nz l oa ob">new_data_recipe &lt;- bake(recipe_obj, new_data) </span><span id="4b9b" class="nx ld jg nt b gy oc nz l oa ob">new_dat_pred &lt;- predict(Logistic_model, newdata = new_data_recipe, type = 'prob') %&gt;% <br/>select(Yes) %&gt;% <br/>rename(churn_prob = Yes) %&gt;% <br/>bind_cols(new_data) %&gt;% <br/>mutate(churn_group = ntile(churn_prob, n = 10)) %&gt;% select(churn_prob, churn_group, everything()) %&gt;% <br/>mutate(churn_prob = round(churn_prob, 2)) new_dat_pred %&gt;% select(churn_prob, churn_group, Age, NumOfProducts, Geography, HasCrCard, Tenure) %&gt;% head(10) %&gt;% <br/>kable() %&gt;% <br/>kableExtra::kable_styling()</span></pre><figure class="no np nq nr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oe"><img src="../Images/8da2ed850c429f722e786fda18a22887.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TfdBvirCL_5z_OAMEKEZbg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><h1 id="1bd8" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">创建流失风险排名</h1><p id="5b5e" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">虽然我们开发了一个模型，可以很好地预测客户是否会流失，但该模型的输出概率在业务环境中并不充分。我们需要一些能够被所有利益相关者理解和容易使用的度量标准，并消除例如向非技术利益相关者解释阈值的复杂性。</p><p id="35cd" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">因此，一个<strong class="lw jh">流失风险排名</strong>会比一个实际概率更有用。因此，我们将概率变量分解为10个流失风险桶。现在客户的流失风险从<strong class="lw jh"> 1(最低概率)到10(最高概率)</strong>。</p><h1 id="4800" class="lc ld jg bd le lf mv lh li lj mw ll lm km mx kn lo kp my kq lq ks mz kt ls lt bi translated">防止流失的策略</h1><p id="c341" class="pw-post-body-paragraph lu lv jg lw b lx ly kh lz ma mb kk mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">最初的策略是为不同的客户流失风险群体开发不同的销售方案(或营销活动)。</p><p id="c220" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">例如，属于流失风险组10和9的客户比示例1和2具有明显更高的流失风险。因此，向他们提供更多的东西来留住他们是至关重要的。</p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><p id="711d" class="pw-post-body-paragraph lu lv jg lw b lx mq kh lz ma mr kk mc md ms mf mg mh mt mj mk ml mu mn mo mp ij bi translated">【https://www.manosantoniou.com】最初发表于<a class="ae jd" href="https://www.manosantoniou.com/post/solve-a-real-world-churn-problem/" rel="noopener ugc nofollow" target="_blank"><em class="of"/></a><em class="of">。</em></p></div></div>    
</body>
</html>