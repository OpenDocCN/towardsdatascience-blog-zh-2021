<html>
<head>
<title>RStudio Server in AWS EMR easy, reproducible, and fast</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS EMR中的RStudio服务器简单、可重复且快速</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/rstudio-server-in-aws-emr-easy-reproducible-and-fast-f066aa6135d?source=collection_archive---------33-----------------------#2021-03-31">https://towardsdatascience.com/rstudio-server-in-aws-emr-easy-reproducible-and-fast-f066aa6135d?source=collection_archive---------33-----------------------#2021-03-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="a525" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/making-sense-of-big-data" rel="noopener" target="_blank">理解大数据</a></h2><div class=""/><figure class="gl gn jx jy jz ka gh gi paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="gh gi jw"><img src="../Images/030ea8ec802d95f31466c03ab4f78ee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lzz72dhIzqPezsgm"/></div></div><p class="kh ki gj gh gi kj kk bd b be z dk translated">由<a class="ae kl" href="https://unsplash.com/@fennings?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马克·佩津</a>在<a class="ae kl" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="e2a9" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在我之前写的一篇文章<a class="ae kl" rel="noopener" target="_blank" href="/data-science-meets-infrastructure-as-code-d2f62328646c?source=your_stories_page-------------------------------------">(可以在这里找到)</a>中，我分享了我对使用基础设施作为代码工具的看法，如Packer和Terraform，以创建Amazon机器映像(AMI)，为数据科学家和数据分析师创建一个可复制的环境，以利用机器中预装的许多工具(Jupyterhub和RStudio Server)探索云资源。</p><p id="fa57" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我不会在这篇文章中扩展自己，因为已经讨论过了，但是与另一篇博客文章相关的存储库使用Ansible playbooks来安装所需的包和库，以便使用R和Python来开发分析和模型，然而，我探索创建自定义ami的可能性的主要原因是在AWS EMR集群的部署中使用它们作为基础映像。</p><h1 id="582d" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">推理</h1><p id="a39e" class="pw-post-body-paragraph km kn iq ko b kp mi kr ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj ij bi translated">许多过去部署过EMR集群的人已经知道，集群的部署可以与引导脚本相关联，引导脚本将提供数据科学家、分析师或工程师在工作中使用的必要工具，尽管这是一个重要的解决方案，但它增加了服务器部署的时间代价(与集群初始化相关联的包和库越多，集群部署的时间就越长)。</p><p id="b2ad" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">EMR的默认部署允许配置Jupyter笔记本或Zeppelin笔记本以及集群的初始化，但是，R和RStudio用户落后了，因为这两种解决方案在EMR集群中都不可用，所以我觉得有必要探索其他既可扩展又快速的解决方案，允许每个分析师/科学家/工程师部署他们自己的集群，以最适合他们需求的语言完成他们的工作，然后在完成后关闭集群。</p><p id="0270" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">经过一番挖掘，我发现在EMR 5.7(以及更高版本)发布后，可以使用定制的Amazon机器映像来部署集群，只需遵循一些建议和最佳实践，如这里建议的<a class="ae kl" href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-custom-ami.html" rel="noopener ugc nofollow" target="_blank">这里的</a>，比如为高于EMR 5.30和6.x的EMR版本使用Amazon Linux 2。 使用Packer和Ansible创建一个定制的Amazon机器映像(以确保RStudio服务器的安装和配置)，然后使用这个映像部署一个EMR集群，再做一些配置以确保RStudio用户能够访问Spark环境、Hadoop和其他通过使用EMR集群可用的特性。</p><h1 id="054a" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">操作方法</h1><p id="5abc" class="pw-post-body-paragraph km kn iq ko b kp mi kr ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj ij bi translated">和我的另一篇博文一样，这篇博文与一个<a class="ae kl" href="https://github.com/paeselhz/emr-spark-client" rel="noopener ugc nofollow" target="_blank">库</a>相关联，它帮助用户:</p><ul class=""><li id="014e" class="mn mo iq ko b kp kq kt ku kx mp lb mq lf mr lj ms mt mu mv bi translated">使用Terraform和自定义AMI部署EMR集群</li><li id="f6e0" class="mn mo iq ko b kp mw kt mx kx my lb mz lf na lj ms mt mu mv bi translated">配置默认的RStudio服务器用户来访问Hadoop文件系统和Spark环境</li><li id="8234" class="mn mo iq ko b kp mw kt mx kx my lb mz lf na lj ms mt mu mv bi translated">将AWS Glue Metastore与Spark集群一起使用，以便EMR集群可以访问Glue中已经存在的数据目录</li></ul><p id="f445" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">请注意，这个部署是以AWS为中心的，我现在没有在其他云中开发这个相同项目的计划，尽管我知道通过使用Google云平台和Azure上可用的工具这是可能的。</p><h1 id="7fb2" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">使用Terraform部署EMR集群</h1><p id="67fb" class="pw-post-body-paragraph km kn iq ko b kp mi kr ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj ij bi translated">在项目<a class="ae kl" href="https://github.com/paeselhz/emr-spark-client" rel="noopener ugc nofollow" target="_blank">仓库</a>中，我们有一个堆栈来使用模块化的Terraform脚本部署EMR集群，因此任何满足您的基础设施需求的必要调整(如创建密钥或角色许可)都可以单独实现。到目前为止，Terraform希望变量如下所述，以允许创建集群主服务器和核心节点。</p><p id="afc9" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">该实现还支持在主节点和核心节点中使用现场实例，但是，在任何生产环境中，建议至少将主节点部署为按需实例，因为如果主节点关闭，整个集群将被终止。</p><p id="dddf" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我的地形配置中可用的变量如下:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="babc" class="nk ll iq ng b gy nl nm l nn no"># EMR general configurations<br/>name = "" <em class="np"># Name of the EMR Cluster</em><br/>region = "us-east-1" <em class="np"># Region of the cluster, must be the same region that the AMI was built</em><br/>key_name = "" <em class="np"># The name of the key pair that can be used to SSH into the cluster</em><br/>ingress_cidr_blocks = "" <em class="np"># Your IP address to connect to the cluster</em><br/>release_label = "emr-6.1.0" <em class="np"># The release of EMR of your choice</em><br/>applications = ["Hadoop", "Spark", "Hive"] <em class="np"># The applications to be available as the cluster starts up</em><br/><br/># Master node configurations<br/>master_instance_type = "m5.xlarge" <em class="np"># EC2 instance type of the master node</em> <em class="np">The underlying architecture of the machine must be compatible with the one used to build the custom AMI</em><br/>master_ebs_size = "50" <em class="np"># Size in GiB of the EBS disk allocated to master instance</em><br/>master_ami = ""  <em class="np"># ID of the AMI created with the custom installation of R and RStudio</em><br/># If the user chooses to set a bid price, it will implicitly create a SPOT Request<br/><em class="np"># If left empty, it will default to On-Demand instances</em>master_bid_price = ""<br/><br/># Core nodes configurations<br/>core_instance_type = "m5.xlarge" <em class="np"># EC2 instance type of each core node</em> <em class="np">The underlying architecture of the machine must be compatible with the one used to build the custom AMI</em><br/>core_ebs_size = "50" <em class="np"># Size in GiB of the EBS disk allocated to each core instance</em><br/>core_instance_count = 1 <em class="np"># Number of core instances that the cluster can scale</em><br/># If the user chooses to set a bid price, it will implicitly create a SPOT Request<br/><em class="np"># If left empty, it will default to On-Demand instances</em>core_bid_price = "0.10"</span></pre><p id="f998" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这些配置应该足以让您启动并运行一个定制的EMR集群。</p><h1 id="5c62" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">允许AWS EMR中的自定义端口</h1><p id="7569" class="pw-post-body-paragraph km kn iq ko b kp mi kr ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj ij bi translated">自2020年12月以来，增加了一些增强安全性的更改，要求用户手动允许端口公开可用，可在此处找到<a class="ae kl" href="https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-man-sec-groups.html" rel="noopener ugc nofollow" target="_blank"/>。如果不是这种情况，您可以跳到下一个会话，但是，如果您希望通过internet公开您的RStudio服务器实例，您必须遵循下述步骤:</p><ul class=""><li id="53b2" class="mn mo iq ko b kp kq kt ku kx mp lb mq lf mr lj ms mt mu mv bi translated">进入<a class="ae kl" href="https://console.aws.amazon.com/elasticmapreduce/home?region=us-east-1#block-public-access:" rel="noopener ugc nofollow" target="_blank"> AWS控制台&gt; EMR </a></li><li id="68fe" class="mn mo iq ko b kp mw kt mx kx my lb mz lf na lj ms mt mu mv bi translated">选择阻止公共访问(应被激活)</li><li id="427f" class="mn mo iq ko b kp mw kt mx kx my lb mz lf na lj ms mt mu mv bi translated">编辑端口间隔，以允许RStudio服务器公开使用端口8787</li></ul><p id="a32c" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果您希望部署只对少数ip地址可用的自定义服务器，您可以跳过这一步，将ingress_cidr_blocks设置为您的个人IP地址。</p><h1 id="8aef" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">配置RStudio服务器以使用全部AWS EMR资源</h1><p id="ae1e" class="pw-post-body-paragraph km kn iq ko b kp mi kr ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj ij bi translated">下面描述的步骤已经嵌入到部署集群的Terraform脚本中，如果有人希望对其进行调整和定制，这里只是为了提供信息。</p><p id="0b73" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在部署服务器之后，添加了配置环境变量的进一步步骤，这使得RStudio更容易找到必要的文件，以便与Spark、Hive、Hadoop和集群中可用的其他工具一起顺利运行。此外，该步骤将RStudio用户添加到Hadoop组，并允许它修改HDFS。</p><p id="4cee" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><strong class="ko ja">这个步骤可以在这个项目中找到。</strong></p><h1 id="dac7" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">AWS将metastore作为JSON配置粘附在Terraform模块中</h1><p id="2c17" class="pw-post-body-paragraph km kn iq ko b kp mi kr ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj ij bi translated">随着现成工具(如AWS Glue)的出现，允许以一种简单的方式转换数据和存储数据及其元数据，需要将EMR集群与该堆栈集成。这也已经在Terraform堆栈中完成，因此如果用户希望使用Hive Metastore而不是托管AWS Glue Metastore，则需要删除这部分代码。</p><p id="51fd" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这个步骤由EMR main Terraform中的configurations_json完成，它接收关于应该如何配置集群的多个输入，更改spark-defaults(例如，允许不同的SQL目录实现)，配置单元站点配置使用AWS Glue Metastore作为默认配置单元站点，等等。要配置的可能性列表可在<a class="ae kl" href="https://docs.aws.amazon.com/emr/latest/ReleaseGuide/emr-configure-apps.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="b962" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">结束语</h1><p id="3fcd" class="pw-post-body-paragraph km kn iq ko b kp mi kr ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj ij bi translated">该项目的部署旨在缩小数据科学相关堆栈的供应之间的差距，试图确保无论数据科学家/分析师/工程师打算使用什么工具，他们都有机会使用它。在部署结束时，人们应该能够在不到10分钟的时间内访问功能完整的EMR集群，在EMR的主节点上安装和配置R和RStudio服务器。</p><p id="bed3" class="pw-post-body-paragraph km kn iq ko b kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">任何与这个项目相关的问题，包括建议，都可以添加到Github资源库中。</p></div></div>    
</body>
</html>