<html>
<head>
<title>AMLSim Fraud Detection with TigerGraph and Google Vertex Part III: Preparing your Model for Custom Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用TigerGraph和Google Vertex检测AMLSim欺诈第三部分:为定制数据准备模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-iii-preparing-your-model-for-custom-561e333e1806?source=collection_archive---------37-----------------------#2021-07-04">https://towardsdatascience.com/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-iii-preparing-your-model-for-custom-561e333e1806?source=collection_archive---------37-----------------------#2021-07-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d6bd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">设置Google Vertex AI，加载我们的TigerGraph数据，并创建和拟合我们的模型</h2></div><blockquote class="kf kg kh"><p id="e97c" class="ki kj kk kl b km kn jr ko kp kq ju kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">注意:这是将TigerGraph与Google Vertex AI结合使用的系列文章的第三部分。要在本博客中使用这些数据，请关注<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-i-preparing-the-data-2f3e6487f398">本博客</a>:<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-i-preparing-the-data-2f3e6487f398">https://towards data science . com/AML sim-fraud-detection-with-tiger graph-and-Google-vertex-part-I-preparing-the-data-2f3e 6487 f 398</a></p><p id="3a50" class="ki kj kk kl b km kn jr ko kp kq ju kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">如果你想了解如何在谷歌控制台中通过AutoML使用TigerGraph数据，请查看<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-ii-using-automl-with-tigergraph-data-65cb86fc34b3">这篇博客</a>:<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-ii-using-automl-with-tigergraph-data-65cb86fc34b3">https://towardsdatascience . com/AML sim-fraud-detection-with-tiger graph-and-Google-vertex-part-ii-using-AutoML-with-tiger graph-data-65 CB 86 fc 34 b 3</a></p></blockquote><h1 id="776f" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">概观</h1><blockquote class="kf kg kh"><p id="1fac" class="ki kj kk kl b km kn jr ko kp kq ju kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">注:该系列由<a class="ly lz ep" href="https://medium.com/u/9ee92495f34e?source=post_page-----561e333e1806--------------------------------" rel="noopener" target="_blank">德州陈</a> (LinkedIn)在<a class="ly lz ep" href="https://medium.com/u/571f80cc8b69?source=post_page-----561e333e1806--------------------------------" rel="noopener" target="_blank">乔恩赫尔克</a> (LinkedIn)的帮助下共同创作。本实验基于Google Vertex的在线预测和批量预测的笔记本演练。</p></blockquote><p id="d790" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">在这个博客系列中，我们将TigerGraph的强大功能与Google的Vertex AI相结合。在第一篇博客中，我们加载了数据，运行了图形算法，编写了查询，最后导出了一个CSV。在第二篇博客中，我们在Google的控制台中使用了导出的CSV，并使用了AutoML。现在，让我们对我们的数据使用一个定制模型。这将在笔记本中通过Python完全运行。</p><p id="25c8" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">在这篇博客中，我们将加载我们的模型并设置必要的配置，然后在下一篇博客中，我们将运行批处理和在线预测。我们开始吧！</p><h1 id="0bb1" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">第一部分:安装库</h1><p id="4847" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">首先，我们需要安装所有的库。如果你在Google Cloud笔记本上运行你的程序，你需要运行这个单元格来添加一个用户标志。如果不是，那么这个细胞就没什么用了。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="ce43" class="mr lh iq mn b gy ms mt l mu mv">import os</span><span id="f3ce" class="mr lh iq mn b gy mw mt l mu mv">IS_GOOGLE_CLOUD_NOTEBOOK = os.path.exists("/opt/deeplearning/metadata/env_version")</span><span id="7159" class="mr lh iq mn b gy mw mt l mu mv">USER_FLAG = ""<br/>if IS_GOOGLE_CLOUD_NOTEBOOK:<br/>   USER_FLAG = "--user"</span></pre><p id="5fe2" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">接下来，我们需要安装所有的库。这将包括Vertex AI、Google云存储、pyTigerGraph、flat tables、NumPy和Pandas。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="0c2d" class="mr lh iq mn b gy ms mt l mu mv">! pip3 install {USER_FLAG} --upgrade google-cloud-storage<br/>! pip3 install {USER_FLAG} --upgrade pyTigerGraph<br/>! pip3 install {USER_FLAG} --upgrade flat-table<br/>! pip3 install {USER_FLAG} --upgrade numpy<br/>! pip3 install {USER_FLAG} --upgrade pandas</span></pre><p id="eaf7" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">最后，您需要重启笔记本来查找包。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="c5ce" class="mr lh iq mn b gy ms mt l mu mv">import os</span><span id="7023" class="mr lh iq mn b gy mw mt l mu mv">if not os.getenv("IS_TESTING"):<br/>   import IPython<br/>   app = IPython.Application.instance()<br/>   app.kernel.do_shutdown(True)</span></pre><p id="771d" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">运行该单元后，笔记本应该会自动重启。一旦完成，让我们开始设置模型！</p><h1 id="4a99" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">第二部分:启用顶点AI API和计算引擎API，并连接到Google Cloud</h1><blockquote class="kf kg kh"><p id="0b99" class="ki kj kk kl b km kn jr ko kp kq ju kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">注意:这些服务中的一部分是要收费的。谷歌云自动启动用户300美元免费。</p></blockquote><h2 id="d111" class="mr lh iq bd li mx my dn lm mz na dp lq ma nb nc ls mb nd ne lu mc nf ng lw nh bi translated">第一步:启用API</h2><p id="a71c" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">本实验将使用两个API:顶点AI和计算机引擎API。为此，请访问<a class="ae lf" href="https://console.cloud.google.com/flows/enableapi?apiid=aiplatform.googleapis.com,compute_component" rel="noopener ugc nofollow" target="_blank">此链接</a>:【https://console.cloud.google.com/flows/enableapi? T2】apid = ai platform . Google APIs . com，compute_component </p><p id="24f1" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">在该页面上，您需要选择要使用的项目。我们将使用我们在过去的博客中创建的相同的谷歌云项目。选择它后，按继续。</p><figure class="mi mj mk ml gt nj gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi ni"><img src="../Images/ed5f809d293776761982b3c7534c4ce4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fv9DImiux0Zv6honfottfw.png"/></div></div><p class="nq nr gj gh gi ns nt bd b be z dk translated">选择您在过去的博客中创建的项目。</p></figure><p id="dfbc" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">给它几分钟来设置，然后你会收到一个确认页面。</p><figure class="mi mj mk ml gt nj gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi ni"><img src="../Images/3f8cd1ef608e6a8bb208eb1651709d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cxfwTIYSHSuWJfy3DvVPfA.png"/></div></div><p class="nq nr gj gh gi ns nt bd b be z dk translated">API已启用。</p></figure><p id="24ae" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">干得好！您已经启用了您的API！现在，让我们验证您的Google Cloud帐户。</p><h2 id="3725" class="mr lh iq bd li mx my dn lm mz na dp lq ma nb nc ls mb nd ne lu mc nf ng lw nh bi translated">第二步:认证谷歌云</h2><p id="0f95" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">接下来，您需要授予您的Google帐户使用Cloud SDK的权限。运行以下代码:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="6b54" class="mr lh iq mn b gy ms mt l mu mv">import os<br/>import sys</span><span id="977c" class="mr lh iq mn b gy mw mt l mu mv">if "google.colab" in sys.modules:</span><span id="a5d9" class="mr lh iq mn b gy mw mt l mu mv">   from google.colab import auth as google_auth<br/>   google_auth.authenticate_user()</span><span id="1320" class="mr lh iq mn b gy mw mt l mu mv">elif not os.getenv("IS_TESTING"):</span><span id="18e3" class="mr lh iq mn b gy mw mt l mu mv">   %env GOOGLE_APPLICATION_CREDENTIALS ''</span></pre><p id="1147" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">当您运行此程序时，您将收到一个验证链接。当你点击它时，选择链接到你的谷歌云项目的谷歌账户。谷歌会要求下面的权限。如果你按“继续”，你会找到一个代码复制并粘贴到你的笔记本上，然后按enter。</p><figure class="mi mj mk ml gt nj gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nu"><img src="../Images/e49bfcc8d955aafd5fde31694326ce74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xp0-2YFImf6ql-gD4FPxsQ.png"/></div></div><p class="nq nr gj gh gi ns nt bd b be z dk translated">Google Cloud SDK的权限</p></figure><h2 id="97e0" class="mr lh iq bd li mx my dn lm mz na dp lq ma nb nc ls mb nd ne lu mc nf ng lw nh bi translated">第三步:在笔记本中设置变量</h2><p id="a84d" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">干得好！最后，您需要设置两个变量:PROJECT_ID和TIMESTAMP。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="ed7e" class="mr lh iq mn b gy ms mt l mu mv">PROJECT_ID = "tigergraph-test"</span><span id="dffc" class="mr lh iq mn b gy mw mt l mu mv">from datetime import datetime<br/>TIMESTAMP = datetime.now().strftime("%Y%m%d%H%M%S")</span></pre><p id="c9b8" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">你可以在你的控制台主页上找到你的项目id。</p><figure class="mi mj mk ml gt nj gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/591c50a0220dcbca714dae4aa1244ada.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*G7AVzk7aKDeKncepEjHrvg.png"/></div><p class="nq nr gj gh gi ns nt bd b be z dk translated">在控制台的主页上找到您的项目ID。</p></figure><p id="74a9" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">干得好！接下来，您需要为您将使用的Google Cloud bucket设置bucket名称和区域。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="c63d" class="mr lh iq mn b gy ms mt l mu mv">BUCKET_NAME = "gs://[your-bucket-name]"<br/>REGION = "[your-region]"</span></pre><p id="e687" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">你可以在这里 : <a class="ae lf" href="https://cloud.google.com/vertex-ai/docs/general/locations#available_regions" rel="noopener ugc nofollow" target="_blank">找到</a><a class="ae lf" href="https://cloud.google.com/vertex-ai/docs/general/locations#available_regions" rel="noopener ugc nofollow" target="_blank">地区列表https://cloud . Google . com/vertex-ai/docs/general/locations # available _ regions</a></p><p id="402f" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">对于bucket，您可以复制并粘贴您在过去的博客中选择的相同的bucket名称。</p><p id="99c0" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">最后，您可以通过运行以下命令来验证您是否连接到了正确的存储桶:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="7cb9" class="mr lh iq mn b gy ms mt l mu mv">! gsutil ls -al $BUCKET_NAME</span></pre><p id="e94e" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">不错！现在，您设置了我们将使用的所有工具。接下来，让我们为谷歌云声明一些变量。</p><h1 id="4997" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">第三部分:设置顶点人工智能</h1><h2 id="2257" class="mr lh iq bd li mx my dn lm mz na dp lq ma nb nc ls mb nd ne lu mc nf ng lw nh bi translated">第一步:导入你的库并初始化顶点人工智能</h2><p id="5525" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">首先，导入顶点SDK库并初始化你的顶点AI连接。在初始化过程中，您需要传递您的项目id、位置/地区和存储桶名称。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="d1dc" class="mr lh iq mn b gy ms mt l mu mv">import os<br/>import sys<br/>from google.cloud import aiplatform<br/>from google.cloud.aiplatform import gapic as aip</span><span id="ae28" class="mr lh iq mn b gy mw mt l mu mv">aiplatform.init(project=PROJECT_ID, location=REGION, staging_bucket=BUCKET_NAME)</span></pre><h2 id="4be9" class="mr lh iq bd li mx my dn lm mz na dp lq ma nb nc ls mb nd ne lu mc nf ng lw nh bi translated">第二步:设置加速器、预构建的容器和机器类型</h2><p id="f2b6" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">接下来，设置加速器。如果不想使用加速器，请将其设置为(无，无)。否则，检查<a class="ae lf" href="https://cloud.google.com/vertex-ai/docs/general/locations#accelerators" rel="noopener ugc nofollow" target="_blank">这里的</a>以查看哪个GPU可用于哪个位置/区域。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="1fe2" class="mr lh iq mn b gy ms mt l mu mv">TRAIN_GPU, TRAIN_NGPU = (None, None)<br/>DEPLOY_GPU, DEPLOY_NGPU = (None, None)</span></pre><p id="4c7d" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">然后选择一个预构建的容器用于培训和部署。你可以在这里找到训练版本<a class="ae lf" href="https://cloud.google.com/vertex-ai/docs/training/pre-built-containers" rel="noopener ugc nofollow" target="_blank">和部署版本</a><a class="ae lf" href="https://cloud.google.com/vertex-ai/docs/predictions/pre-built-containers" rel="noopener ugc nofollow" target="_blank">的预建容器列表。一旦你找到一个你喜欢的选项，你可以复制并粘贴除了:latest以外的所有内容。</a></p><figure class="mi mj mk ml gt nj gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nw"><img src="../Images/1589154892a0a05de44bfefc594f82de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ptYcOxxrjRgEhuMORoQn7w.png"/></div></div><p class="nq nr gj gh gi ns nt bd b be z dk translated">复制除:latest以外的最后一节。</p></figure><p id="d278" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">将您复制的内容粘贴到以下代码中的TRAIN_VERSION或DEPLOY_VERSION中。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2c7d" class="mr lh iq mn b gy ms mt l mu mv">TRAIN_VERSION = "tf-cpu.2-4"<br/>DEPLOY_VERSION = "tf2-cpu.2-5"</span><span id="d611" class="mr lh iq mn b gy mw mt l mu mv">TRAIN_IMAGE = "gcr.io/cloud-aiplatform/training/{}:latest".format(TRAIN_VERSION)<br/>DEPLOY_IMAGE = "gcr.io/cloud-aiplatform/prediction/{}:latest".format(DEPLOY_VERSION)</span><span id="4c68" class="mr lh iq mn b gy mw mt l mu mv">print("Training:", TRAIN_IMAGE, TRAIN_GPU, TRAIN_NGPU)<br/>print("Deployment:", DEPLOY_IMAGE, DEPLOY_GPU, DEPLOY_NGPU)</span></pre><p id="d7a9" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">最后，我们将设置机器类型。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="85a2" class="mr lh iq mn b gy ms mt l mu mv">MACHINE_TYPE = "n1-standard"<br/>VCPU = "4"<br/>TRAIN_COMPUTE = MACHINE_TYPE + "-" + VCPU<br/>print("Train machine type", TRAIN_COMPUTE)</span><span id="e7e3" class="mr lh iq mn b gy mw mt l mu mv">MACHINE_TYPE = "n1-standard"<br/>VCPU = "4"<br/>DEPLOY_COMPUTE = MACHINE_TYPE + "-" + VCPU<br/>print("Deploy machine type", DEPLOY_COMPUTE)</span></pre><p id="d603" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">太棒了。最后，让我们创建一个训练脚本，训练我们的模型！</p><h1 id="9f66" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">第四部分:建立培训档案</h1><h2 id="ae5a" class="mr lh iq bd li mx my dn lm mz na dp lq ma nb nc ls mb nd ne lu mc nf ng lw nh bi translated">第一步:设置参数</h2><p id="e742" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">让我们首先设置要传递到培训文件中的参数。我们将从声明JOB_NAME和MODEL_DIR(模型目录)开始。接下来，我们将为我们的模型确定训练策略、时期数和步骤。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="ba1a" class="mr lh iq mn b gy ms mt l mu mv">JOB_NAME = "custom_job_" + TIMESTAMP<br/>MODEL_DIR = "{}/{}".format(BUCKET_NAME, JOB_NAME)</span><span id="acbb" class="mr lh iq mn b gy mw mt l mu mv">if not TRAIN_NGPU or TRAIN_NGPU &lt; 2:<br/>   TRAIN_STRATEGY = "single"<br/>else:<br/>   TRAIN_STRATEGY = "mirror"</span><span id="7979" class="mr lh iq mn b gy mw mt l mu mv">EPOCHS = 25<br/>STEPS = 50<br/>CMDARGS = [<br/>   "--epochs=" + str(EPOCHS),<br/>   "--steps=" + str(STEPS),<br/>   "--distribute=" + TRAIN_STRATEGY,<br/>]</span></pre><h2 id="82e0" class="mr lh iq bd li mx my dn lm mz na dp lq ma nb nc ls mb nd ne lu mc nf ng lw nh bi translated">第二步:编写培训脚本</h2><blockquote class="kf kg kh"><p id="ca8c" class="ki kj kk kl b km kn jr ko kp kq ju kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">注意:这整个部分应该在一个单元格中，但是为了便于解释，它将被分解。</p></blockquote><p id="813a" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">现在，我们需要编写我们的培训脚本。在这里，我们将导入数据并创建模型。首先，我们将导入我们所有的库，包括Tensorflow、argparse、pyTigerGraph等等。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="9b02" class="mr lh iq mn b gy ms mt l mu mv">%%writefile task.py</span><span id="18ae" class="mr lh iq mn b gy mw mt l mu mv">import tensorflow as tf<br/>from tensorflow.python.client import device_lib<br/>import argparse<br/>import os<br/>import sys<br/>import pyTigerGraph as tg<br/>import flat_table<br/>import pandas as pd<br/>from sklearn.model_selection import train_test_split<br/>import numpy as np</span></pre><p id="e13c" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">接下来，我们将使用argparse来读取我们传递的所有参数。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="e83a" class="mr lh iq mn b gy ms mt l mu mv">parser = argparse.ArgumentParser()<br/>parser.add_argument('--lr', dest='lr', default=0.01, type=float, help='Learning rate.')<br/>parser.add_argument('--epochs', dest='epochs', default=10, type=int, help='Number of epochs.')<br/>parser.add_argument('--steps', dest='steps', default=200, type=int, help='Number of steps per epoch.')<br/>parser.add_argument('--distribute', dest='distribute', type=str, default='single', help='distributed training strategy')</span><span id="a75f" class="mr lh iq mn b gy mw mt l mu mv">args = parser.parse_args()</span></pre><p id="f765" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">我们将使用策略论点来确定张量流分布。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="c731" class="mr lh iq mn b gy ms mt l mu mv">if args.distribute == 'single':<br/>   if tf.test.is_gpu_available():<br/>      strategy = tf.distribute.OneDeviceStrategy(device="/gpu:0")<br/>   else:<br/>      strategy = tf.distribute.OneDeviceStrategy(device="/cpu:0")<br/>elif args.distribute == 'mirror':<br/>   strategy = tf.distribute.MirroredStrategy()<br/>elif args.distribute == 'multi':<br/>   strategy = tf.distribute.experimental.MultiWorkerMirroredStrategy()</span></pre><p id="b658" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">接下来，我们将设置缓冲区大小和批处理大小变量</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="6cd1" class="mr lh iq mn b gy ms mt l mu mv">BUFFER_SIZE = 10000<br/>BATCH_SIZE = 64</span></pre><p id="f556" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">然后我们将创建一个prepare_dataset函数。为了加载我们的数据，我们将首先连接到TigerGraph上的图表。在运行该命令之前，转到GraphStudio并确保您的解决方案旁边有一个绿色的“Ready”。如果它有一个蓝色的“停止”，然后按“操作”下的“解决方案操作”和下拉菜单，并按“开始”可能需要几分钟才能开始。</p><div class="mi mj mk ml gt ab cb"><figure class="nx nj ny nz oa ob oc paragraph-image"><img src="../Images/28b4d35925a9e57d5b05735d868827f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*J6bCIqe60QgQqrHkAA345Q.png"/></figure><figure class="nx nj od nz oa ob oc paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><img src="../Images/d3fb888c76ac63e975a2f29445dc23ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*-wpMBruWMixVcYdtYncjIw.png"/></div><p class="nq nr gj gh gi ns nt bd b be z dk oe di of og translated">如果您的状态显示为“已停止”，请转到“操作”下，然后从下拉列表中按“开始”。</p></figure></div><figure class="mi mj mk ml gt nj gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/6a922fae9b6cd913d00d09cede6fba48.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*onnEpfcqkf5zCCqUN7T5Ow.png"/></div><p class="nq nr gj gh gi ns nt bd b be z dk translated">当“状态”为绿色并显示“就绪”时，您就准备好继续前进了</p></figure><p id="de6d" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">一旦连接到我们的解决方案，我们将运行txMultiHopLimit查询。然后我们将使用pandas将结果转换成数据帧。我们将使用flat_table删除任何NaN值或其他潜在错误。最后，我们将使用sklearn的train_test_split将结果分成训练和测试部分，这将是我们返回的值。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="42d6" class="mr lh iq mn b gy ms mt l mu mv">def prepare_dataset():<br/>   conn = tg.TigerGraphConnection(host="https://SUBDOMAIN.i.tgcloud.io", username="tigergraph", password="tigergraph", graphname = "AMLSim")<br/>   conn.apiToken = conn.getToken(conn.createSecret())<br/>   tx_hop = conn.runInstalledQuery("txMultiHopLimit", {}, timeout="99999999999", sizeLimit="1500000000")<br/>   odf_tx_hop = pd.DataFrame(tx_hop[0]["@@txRecords"], index=None)<br/>   dataset = flat_table.normalize(odf_tx_hop)<br/>   features = ['tx_amount', 's_pagerank', 's_label', 's_min_send_tx', 's_min_receieve_tx', 's_max_send_tx', 's_max_recieve_tx', 's_avg_send_tx', 's_avg_recieve_tx', 's_cnt_recieve_tx', 's_cnt_send_tx', 's_timestamp', 'r_pagerank', 'r_label', 'r_min_send_tx', 'r_min_receieve_tx', 'r_max_send_tx', 'r_max_recieve_tx', 'r_avg_send_tx', 'r_avg_recieve_tx', 'r_cnt_recieve_tx', 'r_cnt_send_tx', 'r_timestamp']<br/>   X_train, X_test, y_train, y_test = train_test_split(dataset[features], dataset["tx_fraud"], test_size=0.2, random_state=42)<br/>   return X_train, X_test, y_train, y_test</span></pre><p id="688d" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">接下来，我们将使用Keras创建我们的神经网络模型。这将是一个简单的序列模型。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="a4b9" class="mr lh iq mn b gy ms mt l mu mv">def build_and_compile_model():<br/>   model = tf.keras.Sequential([<br/>      tf.keras.layers.Dense(32, activation='relu', input_shape=(1, 23)),<br/>      tf.keras.layers.Dense(64, activation='relu'),<br/>      tf.keras.layers.Dense(1, activation="sigmoid")<br/>   ])<br/>   model.compile( loss=tf.keras.losses.MSE, optimizer=tf.keras.optimizers.Adam(learning_rate=args.lr), metrics=['accuracy'])<br/>   return model</span></pre><p id="7763" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">然后我们将设置一些变量，特别是NUM_WORKERS、GLOBAL_BATCH_SIZE和MODEL_DIR。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="fd89" class="mr lh iq mn b gy ms mt l mu mv">NUM_WORKERS = strategy.num_replicas_in_sync<br/>GLOBAL_BATCH_SIZE = BATCH_SIZE * NUM_WORKERS<br/>MODEL_DIR = os.getenv("AIP_MODEL_DIR")</span></pre><p id="e67f" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">我们将运行prepare_dataset函数，然后构建模型。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="567c" class="mr lh iq mn b gy ms mt l mu mv">res = prepare_dataset()<br/>train_dataset, X_test, y_train, y_test = res</span><span id="942f" class="mr lh iq mn b gy mw mt l mu mv">with strategy.scope():<br/>   model = build_and_compile_model()</span></pre><p id="ab5d" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">最后，我们将拟合模型并保存它。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2c68" class="mr lh iq mn b gy ms mt l mu mv">model.fit(train_dataset, y_train, epochs=args.epochs, steps_per_epoch=args.steps, batch_size=GLOBAL_BATCH_SIZE, validation_data=(X_test, y_test))<br/>model.save(MODEL_DIR)</span></pre><p id="ad9f" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">厉害！一旦执行完毕，剩下的就是运行文件了。</p><h2 id="b919" class="mr lh iq bd li mx my dn lm mz na dp lq ma nb nc ls mb nd ne lu mc nf ng lw nh bi translated">第三步:训练模型</h2><p id="f0ea" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">最后，我们将运行并训练模型。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="69fe" class="mr lh iq mn b gy ms mt l mu mv">job = aiplatform.CustomTrainingJob( display_name=JOB_NAME, script_path="task.py", container_uri=TRAIN_IMAGE, requirements=["tensorflow_datasets==1.3.0", "pyTigerDriver==1.0.6", "pyTigerGraph==0.0.9.6.8", "pandas==1.1.5", "flat-table==1.1.1", "sklearn==0.0"], model_serving_container_image_uri=DEPLOY_IMAGE)</span><span id="799c" class="mr lh iq mn b gy mw mt l mu mv">MODEL_DISPLAY_NAME = "tg_custom_fraud_model-" + TIMESTAMP</span><span id="80aa" class="mr lh iq mn b gy mw mt l mu mv">if TRAIN_GPU:<br/>   model = job.run(model_display_name=MODEL_DISPLAY_NAME, args=CMDARGS, replica_count=1, machine_type=TRAIN_COMPUTE, accelerator_type=TRAIN_GPU.name, accelerator_count=TRAIN_NGPU)</span><span id="bd0f" class="mr lh iq mn b gy mw mt l mu mv">else:<br/>   model = job.run(model_display_name=MODEL_DISPLAY_NAME, args=CMDARGS, replica_count=1, machine_type=TRAIN_COMPUTE, accelerator_count=0)</span></pre><p id="7609" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">一旦你运行这个，你将能够在顶点人工智能面板的“模型”标签中看到你的模型。</p><figure class="mi mj mk ml gt nj gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi oi"><img src="../Images/7481770b5f44c48e7485652fba248e48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uO0TC5VDxUmK7lXCqEN3iw.png"/></div></div><p class="nq nr gj gh gi ns nt bd b be z dk translated">模型显示在顶点人工智能控制台。</p></figure><p id="8e64" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">暂时就这样吧！</p><h1 id="9c6d" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">第五部分:祝贺你！</h1><p id="3b46" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">感谢您关注本博客！期待下一个，我们将使用批量和在线预测！在此期间，如果你有任何问题，你可以加入TigerGraph Discord。</p><div class="oj ok gp gr ol om"><a href="https://discord.gg/gRHWBZNpxW" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">加入TigerGraph Discord服务器！</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">查看Discord上的TigerGraph社区-与577名其他成员一起玩，享受免费的语音和文本聊天。</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">不和谐. gg</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa no om"/></div></div></a></div></div></div>    
</body>
</html>