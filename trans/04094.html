<html>
<head>
<title>Displaying AWS ECS Fargate Logs in Airflow UI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Airflow UI中显示AWS ECS Fargate日志</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/displaying-aws-ecs-fargate-logs-in-airflow-ui-7b302321fd09?source=collection_archive---------34-----------------------#2021-04-06">https://towardsdatascience.com/displaying-aws-ecs-fargate-logs-in-airflow-ui-7b302321fd09?source=collection_archive---------34-----------------------#2021-04-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7357" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在气流任务中正确设置Cloudwatch日志组和流前缀</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/09c774a875332d282207af5be0b1a1c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NW8vzjCD3HGqU9o4"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kv" href="https://unsplash.com/@adityaries?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aditya Saxena </a>拍摄</p></figure><p id="3d9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我从事的一个项目中，我使用AWS弹性容器服务来运行Fargate任务。为什么？我有需要运行的作业，所以很容易打包到Docker容器中，并部署在Fargate上，只需为使用的资源付费。我用气流来安排这些任务。因为Airflow在Fargate上运行任务，所以所有的作业日志都是在Fargate任务(Docker容器)中创建的。幸运的是，Fargate支持将日志流式传输到CloudWatch，但如果您有十几行日志，在CloudWatch中浏览就不是超级友好的了(例如在线阅读和分页)。幸运的是，Airflow ECS Operator支持在Airflow UI中显示来自Fargate任务的日志，这对我来说更好也更有用，因为我把所有东西都放在一个地方，我不必去CloudWatch调查。</p><p id="5837" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在配置Airflow/Fargate来显示日志时遇到了问题，所以我想描述一下我的方法和我的理解。通常，当显示来自CloudWatch的日志出现问题时，气流日志中会出现异常:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="eeeb" class="lx ly iq lt b gy lz ma l mb mc">An error occurred (ResourceNotFoundException) when calling the GetLogEvents operation: The specified log group does not exist.</span></pre><p id="6ec3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并且气流任务被标记为失败。我的问题是正确设置日志配置，以便Airflow可以读取它(这可能是由于缺乏CloudWatch日志如何工作的知识造成的)</p><h2 id="8758" class="lx ly iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">1.设置Fargate任务</h2><p id="35f5" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">当设置Fargate任务和容器部分时，有日志配置选项，我选中“自动配置CloudWatch日志”,然后一切都是预定义的，当然，也可以设置自定义值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/1062577174847541d16d4532c31efecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*NX_gH7JeZ6u71LgD.png"/></div></figure><p id="e0b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用这些设置，云观察中的日志组会随后自动创建。</p><p id="4b3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我的例子中，容器名和Fargate任务名都是“fargate_logging”。</p><h2 id="0b5b" class="lx ly iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">2.设置气流任务。</h2><p id="ba79" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">在Airflow ECSOperator中，我用这些值设置日志:</p><p id="0fb9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> awslogs_group </strong>是<strong class="ky ir"> "/ecs/fargate_logging" </strong></p><p id="6103" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> awslogs_stream </strong>为<strong class="ky ir">“ECS/fargate _ logging”</strong>(开头不带“/”)。</p><p id="945b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">任务可能如下所示(非完整配置):</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="f7ac" class="lx ly iq lt b gy lz ma l mb mc">task = ECSOperator(<br/>    dag=dag,<br/>    task_id=task_id,<br/>    task_definition=task_definition,<br/>    cluster=cluster,<br/>    region_name=region_name,<br/>    launch_type=launch_type,<br/>    overrides = {},<br/>    awslogs_group='/ecs/fargate_logging',<br/>    awslogs_stream_prefix='ecs/fargate_logging'<br/>)</span></pre><h2 id="9989" class="lx ly iq bd md me mf dn mg mh mi dp mj lf mk ml mm lj mn mo mp ln mq mr ms mt bi translated">3.工作原理(引擎盖下):</h2><p id="fe9d" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf mw lh li lj mx ll lm ln my lp lq lr ij bi translated">在CloudWatch中检查是否创建了日志组，以及那里是否确实有日志:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/65c77aad39cd19b15d4948bb420a28ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*LG2L90lbsbqzRdV2.png"/></div></figure><p id="f69e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们看到日志流(名称)由“ECS/fargate _ logging”+某个数字组成</p><p id="ce47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Fargate任务执行后，Airflow ECS操作员正在读取CluodWatch日志和流作为Airflow日志，这是核心部分。我们看到它正在解析<strong class="ky ir"> task_id </strong>，并与<strong class="ky ir"> awslogs_stream_prefix </strong>一起将<strong class="ky ir"> stream_name </strong>放在一起。Task_id是执行的Fargate任务的id。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="73c6" class="lx ly iq lt b gy lz ma l mb mc">self.log.info('ECS Task logs output:')<br/>task_id = self.arn.split("/")[-1]<br/>stream_name = "{}/{}".format(self.awslogs_stream_prefix, task_id)<br/>self.log.info("aws log group {}".format(self.awslogs_group))<br/>self.log.info("stream name: {}".format(stream_name))<br/>self.log.info("task_id: {}".format(task_id))<br/>for event in self.get_logs_hook().get_log_events(self.awslogs_group, stream_name):<br/>    dt = datetime.fromtimestamp(event['timestamp'] / 1000.0)<br/>    self.log.info("[{}] {}".format(dt.isoformat(), event['message']))</span></pre><p id="8c04" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我添加了日志行，以查看在我设置值后什么会作为stream_name。这是我在气流日志界面上看到的:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="652e" class="lx ly iq lt b gy lz ma l mb mc">[2021-03-31 07:23:53,773] {ecs_operator.py:172} INFO - ECS Task logs output:<br/>[2021-03-31 07:23:53,774] {ecs_operator.py:175} INFO - aws log group /ecs/fargate_logging<br/>[2021-03-31 07:23:53,774] {ecs_operator.py:176} INFO - stream name: ecs/fargate_logging/571504e3bf504615b39d2fdbea15a987<br/>[2021-03-31 07:23:53,774] {ecs_operator.py:177} INFO - task_id: 571504e3bf504615b39d2fdbea15a987</span></pre><p id="973e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重点是<strong class="ky ir"> awslog_group </strong>和<strong class="ky ir"> stream_name </strong>和Cloud Watch里的相匹配。</p><p id="77c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，在CloudWatch中，我们有一个名为ecs/fargate_logging/571504 E3 BF 504615 b 39 D2 FD bea 15 a 987的日志流，<strong class="ky ir"> awslogs_stream_prefix </strong>是“ECS/fargate _ logging”。</p><p id="0857" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在调试时使用了下面的代码片段来直接读取日志:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="3263" class="lx ly iq lt b gy lz ma l mb mc">import boto3<br/>client = boto3.client('logs')<br/>response = client.get_log_events(<br/>    logGroupName='/ecs/fargate_logging',<br/>    logStreamName='ecs/fargate_logging/571504e3bf504615b39d2fdbea15a987'<br/><br/>)<br/>print(response)</span></pre><p id="bcde" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">同样，在配置Airflow时，ECS Operator awslog_group和awslogs_stream_prefix必须与CloudWatch中的内容相匹配(而不是相反)！！！</strong></p><p id="4ef5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Airflow中，您不需要设置您想要的值，而是在CloudWatch中设置它们，以便您可以正确读取它们。当我最初设置气流(对ECS没有太多经验)时，我认为我是在为日志设置它应该如何配置(它们将如何编写)，但正如我已经强调的那样，情况正好相反。</p><p id="1020" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这将帮助那些有类似问题的人。</p></div></div>    
</body>
</html>