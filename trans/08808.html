<html>
<head>
<title>Propensity Score Stratification in Observational Data: A Tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">观察数据中的倾向评分分层:指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/propensity-score-stratification-in-observational-data-a-tutorial-ef21321eb586?source=collection_archive---------5-----------------------#2021-08-14">https://towardsdatascience.com/propensity-score-stratification-in-observational-data-a-tutorial-ef21321eb586?source=collection_archive---------5-----------------------#2021-08-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="706a" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">实验和因果推理</h2><div class=""/><div class=""><h2 id="75db" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">倾向评分匹配的更好替代方案</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/968a9d452560557f72bdfbf127c5c362.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7CXpH0I-BtncQT9oKSySvw.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">Christophe Hautier 在<a class="ae lh" href="https://unsplash.com/s/photos/balance?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="4fbc" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated">介绍</h1><p id="4b96" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">你知道我们每天产生多少新数据吗？在2021年，这个数字大约是2.5万亿字节的数据。因此，我们并不缺乏数据，而是缺乏使其有用的正确工具。</p><p id="4121" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">很容易显示多种因素如何随着对大数据的访问而一起移动。然而，确定这种关系是因果关系还是仅仅是相关关系变得更具挑战性。总的来说，有三种类型的设计可以帮助我们:</p><ol class=""><li id="c220" class="nb nc it mc b md mw mg mx mj nd mn ne mr nf mv ng nh ni nj bi translated"><em class="nk">真正的实验设计，又名A/B测试，或随机控制试验</em></li><li id="a426" class="nb nc it mc b md nl mg nm mj nn mn no mr np mv ng nh ni nj bi translated"><em class="nk">准实验设计</em></li><li id="5897" class="nb nc it mc b md nl mg nm mj nn mn no mr np mv ng nh ni nj bi translated"><em class="nk">观察设计</em></li></ol><p id="3035" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">在一系列的博客文章中，我详细阐述了每个类别中的相关主题。例如，我们必须理解<a class="ae lh" rel="noopener" target="_blank" href="/an-a-b-test-loses-its-luster-if-a-a-tests-fail-2dd11fa6d241?sk=8d4cebf2d3362704a4121b4518364c36">A/A测试</a>的价值，避免<a class="ae lh" rel="noopener" target="_blank" href="/online-controlled-experiment-8-common-pitfalls-and-solutions-ea4488e5a82e?sk=736ba64dc8481993cd98e043256c4bf4">常见的陷阱</a>，遵循<a class="ae lh" rel="noopener" target="_blank" href="/a-practical-guide-to-a-b-tests-in-python-66666f5c3b02?sk=069c502acb69d326a3ea559273c7a04f">最佳实践</a>，并在运行A/B测试时小心<a class="ae lh" rel="noopener" target="_blank" href="/how-user-interference-may-mess-up-your-a-b-tests-f29abfcfccf8?sk=9ff3bbae01ff9951e6eca33e1c75cff4">用户干扰</a>。</p><p id="45f5" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">准实验类有各种可用的设计，包括<a class="ae lh" rel="noopener" target="_blank" href="/does-minimum-wage-decrease-employment-a-difference-in-differences-approach-cb208ed07327?sk=9b4ec9afcef8bee1041720945cd0dd7d">差异中的差异</a>、<a class="ae lh" rel="noopener" target="_blank" href="/the-crown-jewel-of-causal-inference-regression-discontinuity-design-rdd-bad37a68e786?sk=401520d9e48b64e24aeb0064745b34fe">回归不连续设计</a>、<a class="ae lh" rel="noopener" target="_blank" href="/what-is-the-strongest-quasi-experimental-method-interrupted-time-series-period-f59fe5b00b31?sk=8ccf52232b23f5be74856768d4af15ce">间断时间序列</a>、<a class="ae lh" rel="noopener" target="_blank" href="/causal-inference-using-synthetic-control-the-ultimate-guide-a622ad5cf827?sk=74c2e04700963a589b03357105ca765b">综合控制</a>和工具变量。一个常见的误导性论点是X/Y/Z方法是最佳设计。相反，数据科学家必须评估可用的信息，并选择最适合环境的信息。</p><p id="46d9" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">在最后一类中，倾向得分在使用观察设计获得因果推断中起着核心作用(Rosenbaum，1983)。倾向分分析主要有四种方法:<a class="ae lh" rel="noopener" target="_blank" href="/an-ultimate-guide-to-matching-and-propensity-score-matching-644395c46616?sk=e05b5a1a5bc741a2664159b599b56003"> PS匹配</a>，PS分层，PS加权，协变量调整。</p><p id="e2ad" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">在之前的<a class="ae lh" rel="noopener" target="_blank" href="/an-ultimate-guide-to-matching-and-propensity-score-matching-644395c46616?sk=e05b5a1a5bc741a2664159b599b56003">帖子</a>中，我介绍了我们如何使用<a class="ae lh" rel="noopener" target="_blank" href="/an-ultimate-guide-to-matching-and-propensity-score-matching-644395c46616?sk=e05b5a1a5bc741a2664159b599b56003"> PS匹配</a>来减少治疗组和对照组之间观察到的基线协变量失衡。在今天的帖子中，我们详细阐述了如何在PS的基础上对观察结果进行分层，并解释了为什么它是比<a class="ae lh" rel="noopener" target="_blank" href="/an-ultimate-guide-to-matching-and-propensity-score-matching-644395c46616?sk=e05b5a1a5bc741a2664159b599b56003"> PS匹配</a>更好的选择。在实证部分，我们用R编码，并用一个真实的例子计算治疗效果。</p></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><h1 id="4ee9" class="li lj it bd lk ll nx ln lo lp ny lr ls ki nz kj lu kl oa km lw ko ob kp ly lz bi translated">什么是倾向得分</h1><p id="7395" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">PS是在<strong class="mc jd"> <em class="nk">观察到</em> </strong>协变量的情况下接受治疗的条件概率的比例分数。因此，P.S .是有效检查治疗组和对照组之间协变量平衡的平衡指标。</p><p id="31d9" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">任何PS分析的潜在风险是影响结果变量的<strong class="mc jd"><em class="nk"/></strong>未观察到的协变量的存在。如果未观察到的协变量存在，有三种检验方法(Rosenbaum，2005):</p><ol class=""><li id="fdd2" class="nb nc it mc b md mw mg mx mj nd mn ne mr nf mv ng nh ni nj bi translated"><em class="nk">构建两个已知在未观察到的协变量上不同的对照组。</em></li><li id="3e09" class="nb nc it mc b md nl mg nm mj nn mn no mr np mv ng nh ni nj bi translated"><em class="nk">检查关联的一致性和剂量反应关系。</em></li><li id="be11" class="nb nc it mc b md nl mg nm mj nn mn no mr np mv ng nh ni nj bi translated"><em class="nk">检查不应受治疗影响的变量。</em></li></ol><p id="4bd1" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">请查看Rosenbaum (2005)以了解更多信息。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/7754e69100dc8bd5e010b78d5bf61531.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QMkgTa50HKbHU-jUnvb7cQ.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">肖恩·斯特拉顿在<a class="ae lh" href="https://unsplash.com/s/photos/balance?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="bf0e" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated">为什么倾向评分</h1><p id="e98b" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">让我们解决房间里的大象:</p><blockquote class="oc"><p id="fbf0" class="od oe it bd of og oh oi oj ok ol mv dk translated">倾向评分有什么好大惊小怪的？</p><p id="c7cf" class="od oe it bd of og oh oi oj ok ol mv dk translated">为什么每一种观察方法都要玩弄它？</p></blockquote><p id="6ded" class="pw-post-body-paragraph ma mb it mc b md om kd mf mg on kg mi mj oo ml mm mn op mp mq mr oq mt mu mv im bi translated">首先，我们必须了解观察数据的本质，以及为什么很难使用非实验(观察)数据进行因果推断。我们之所以称之为观察数据，是因为数据科学家无法控制或了解治疗分配过程。我们仅仅观察到治疗组中的一些单位和对照组中的其他单位。</p><p id="f9c1" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">由于缺乏有效的干预，很难建立可信的因果关系。<strong class="mc jd">在RCTs中，我们采用两均数差估计量来量化干预效果，即比较治疗组和对照组之间的平均差异。</strong>但是，我们不能在观测数据中使用同一个估计量，观测数据中可能包含选择偏差。即人们自选进入治疗组，其他人进入对照组。</p><p id="ff2a" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">这里有一个例子。</p><p id="759d" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">经济学家想了解职业培训项目在影响参与者家庭收入方面的有效性。然而，如果我们简单地比较项目参与者和非参与者之间的项目后工资，我们最终会得到一个有偏见的估计，因为那些比平均水平更有积极性的人更有可能参加培训项目。</p><p id="d9d7" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">如果我们只是比较差异而不进行调整，我们可能会将共同基础变量(在这种情况下是更好的动机)引起的影响归因于干预效应:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi or"><img src="../Images/93c3ce2f435b2ebce39671e879c4b0e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zg-3hsYHoDjZCDT0DTtNfg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">我自己的截图</p></figure><p id="49f1" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">为了获得一个无偏的估计量，我们必须调整关键协变量的不平衡，减少(甚至消除)选择偏差。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi os"><img src="../Images/af05ecbd006675195919c46c312b412c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OqSvqS5kizgUy-auxcCWWg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">我自己的截图</p></figure><p id="9a10" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">下一节我们来深挖PS分层的原因。</p></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><h1 id="3db9" class="li lj it bd lk ll nx ln lo lp ny lr ls ki nz kj lu kl oa km lw ko ob kp ly lz bi translated">为什么倾向评分分层</h1><p id="e1b4" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">PS是一个平衡分数:以PS为条件，观察到的协变量在治疗组和对照组之间的分布看起来相似(Austin，2011)。因此，它允许你通过调整分数来调整协变量的不平衡。</p><p id="b3d7" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">一些研究人员认为，我们可以根据参与者的PS匹配他们，并找到可比较的案例，即<a class="ae lh" rel="noopener" target="_blank" href="/an-ultimate-guide-to-matching-and-propensity-score-matching-644395c46616?sk=e05b5a1a5bc741a2664159b599b56003"> PS匹配</a>。然而，精确匹配过程增加了不平衡、低效、模型依赖、偏差，并且未能减少不平衡(King和Nielsen，2019)。相比之下，PS分层为PS匹配提供了更好的替代方案。</p><p id="77d9" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">具体步骤如下:</p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="65b5" class="oy lj it ou b gy oz pa l pb pc">1. Estimate the PS using a logistic regression <br/>2. Create mutually exclusive strata based on the estimated PS<br/>3. Group treated and control units into each stratum <br/>4. Within each stratum, we calculate the difference in means between the treated and control <br/>5. Weight the means in each stratum and obtain the target estimate</span></pre><p id="4f7e" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">第2步和第5步有两个额外的注意事项。<strong class="mc jd">在第二步，研究表明5层可以消除未经调整的估计中大约90%的偏差(罗森鲍姆和鲁宾，1984)。</strong>一个合理的假设是:如果我们尽可能多的增加地层呢？它能更好地降低偏置吗？</p><p id="0e5e" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">号码</p><p id="6bc3" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">模拟工作表明，5-10层导致最好的结果，10+层带来的边际收益很小(Neuhä user et al .，2018) </strong>。此外，还有一个实际的原因:我们拥有的层越多，每个层中的数据点就越少。</p><p id="5905" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">在第5步，PS分层允许我们估计平均治疗效果(<strong class="mc jd"> ATE </strong>)和平均治疗效果(<strong class="mc jd"> ATT </strong>)取决于我们如何权衡平均值。</p><blockquote class="pd pe pf"><p id="33c3" class="ma mb nk mc b md mw kd mf mg mx kg mi pg my ml mm ph mz mp mq pi na mt mu mv im bi translated"><strong class="mc jd">为了估计ate，我们按每个地层中的单元数进行加权；</strong></p><p id="88fe" class="ma mb nk mc b md mw kd mf mg mx kg mi pg my ml mm ph mz mp mq pi na mt mu mv im bi translated"><strong class="mc jd">为了估计ATT，我们根据每个地层中处理过的单位数量进行加权(Imbens，2004) </strong>。</p></blockquote><p id="c58e" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">你可能会对潜在结果框架(POF)符号感到困惑:ATE和ATT实际上是什么意思？</p><blockquote class="oc"><p id="eef2" class="od oe it bd of og oh oi oj ok ol mv dk translated">ATE:整个人群的平均治疗效果。</p><p id="d96a" class="od oe it bd of og oh oi oj ok ol mv dk translated">ATT:将接受治疗的受试者与未接受治疗的类似受试者进行比较。</p></blockquote><p id="3968" class="pw-post-body-paragraph ma mb it mc b md om kd mf mg on kg mi mj oo ml mm mn op mp mq mr oq mt mu mv im bi translated"><strong class="mc jd">从概念上讲，PS分层被认为是对各层内一组准随机对照试验的荟萃分析(Austin，2011)。</strong>我们可以将治疗分配过程视为以观察到的协变量为条件的随机分配，也称为可忽略假设，这意味着潜在的结果与治疗状态无关(Austin，2011)。</p><p id="fee8" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">在POF中，可忽略的假设允许我们获得无偏估计。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi gj"><img src="../Images/86623c180e7f54f80eba592e93e018bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3spGmf_L_PeQXEvkZlTqag.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">我自己的截图</p></figure><p id="d0b0" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><em class="nk">哪里</em></p><ul class=""><li id="f511" class="nb nc it mc b md mw mg mx mj nd mn ne mr nf mv pj nh ni nj bi translated"><em class="nk"> Y0i:如果I单元没有接受治疗</em></li><li id="82f7" class="nb nc it mc b md nl mg nm mj nn mn no mr np mv pj nh ni nj bi translated"><em class="nk"> Y1i:如果I单元接受治疗</em></li><li id="7da6" class="nb nc it mc b md nl mg nm mj nn mn no mr np mv pj nh ni nj bi translated"><em class="nk">子:治疗条件</em></li></ul><p id="53f0" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">通常，可忽略的假设在观察研究中不成立。换句话说，治疗组的单位比对照组的单位更有可能接受治疗。然而，PS分层提供了一个解决方案:以PS表示的观测协变量为条件，可忽略假设成立，即条件可忽略假设(CIA)。</p><p id="f91a" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">两组均数差估计量是ate的无偏阶层特异性估计量(D'Agostino，1998)。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pk"><img src="../Images/aa19bdb422163873cd4af46be15203de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IBW51sd5yapYRWzXvjxsTA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">我自己的截图</p></figure><p id="3d82" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><em class="nk">其中</em></p><ul class=""><li id="07da" class="nb nc it mc b md mw mg mx mj nd mn ne mr nf mv pj nh ni nj bi translated"><em class="nk"> Y0i:如果I单元没有接受治疗</em></li><li id="127c" class="nb nc it mc b md nl mg nm mj nn mn no mr np mv pj nh ni nj bi translated"><em class="nk"> Y1i:如果I单元接受治疗</em></li><li id="f82d" class="nb nc it mc b md nl mg nm mj nn mn no mr np mv pj nh ni nj bi translated"><em class="nk">子:治疗条件</em></li><li id="ea30" class="nb nc it mc b md nl mg nm mj nn mn no mr np mv pj nh ni nj bi translated"><strong class="mc jd"> <em class="nk"> Xi </em> </strong> <em class="nk">:被观测协变量的向量，表示为PS </em></li></ul><p id="d5d0" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">这就是PS分层背后的所有理论。</p><p id="c4a7" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">让我们用r编码。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pl"><img src="../Images/45c351398fe2ba59c58830e0c499d63e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R1tv3hxtGZS1nhmi0PRRqw.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><a class="ae lh" href="https://unsplash.com/@pineapple?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">菠萝供应公司</a>在<a class="ae lh" href="https://unsplash.com/s/photos/balance?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="7bcb" class="li lj it bd lk ll lm ln lo lp lq lr ls ki lt kj lu kl lv km lw ko lx kp ly lz bi translated">r实施</h1><p id="a172" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">在本节中，我们使用了LaLonde (1986)和Dehejia和Wahba (1997)使用的复合数据集。它由两部分组成:国家支持的工作示范(新南威尔士州)中经过处理的数据的子样本和来自收入动态人口调查(PSID)的比较样本。</p><blockquote class="pd pe pf"><p id="f397" class="ma mb nk mc b md mw kd mf mg mx kg mi pg my ml mm ph mz mp mq pi na mt mu mv im bi translated"><strong class="mc jd">出于教学原因，我简化了分析过程，并主要关注如何在r中进行倾向评分分层的工作流程。这就是为什么获得的ATT与原始论文略有不同。</strong></p></blockquote><p id="03d6" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">PS分层的快速回顾:</p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="23a0" class="oy lj it ou b gy oz pa l pb pc">1. Estimate the PS using a logistic regression <br/>2. Create mutually exclusive strata based on the estimated PS<br/>3. Group treated and control units into each stratum <br/>4. Within each stratum, we calculate the difference in means between the treated and control <br/>5. Weight the means in each stratum and obtain the target estimate</span></pre><p id="85f0" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">第0步:数据准备</strong></p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="990c" class="oy lj it ou b gy oz pa l pb pc">#install.packages(“MatchIt”)<br/>#install.packages(“optmatch”)</span><span id="f864" class="oy lj it ou b gy pm pa l pb pc">library(“MatchIt”)<br/>library(“optmatch”)</span><span id="bf70" class="oy lj it ou b gy pm pa l pb pc">data(“lalonde”)<br/>head(lalonde)<br/>#?lalonde</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pn"><img src="../Images/6238c43037485c183253fbc4fa729d0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bv_lsSmtOmdZwIuCbIILcA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">我自己的截图</p></figure><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="d964" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/>sum(lalonde$treat)<br/>```<br/>185</span></pre><p id="401f" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">总治疗人数为185人。</p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="ace6" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/>mean(lalonde[which(lalonde$treat==0),’re78'])<br/>```<br/>6984.17</span></pre><p id="33ee" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">对照组的结果变量是6984.17美元。</p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="e96b" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/>mean(lalonde[which(lalonde$treat==1),’re78'])<br/>```<br/>6349.144</span></pre><p id="e552" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">治疗组的结果变量为6349.144美元。</p><p id="2d81" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">步骤1:使用逻辑回归估计PS</strong></p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="bac0" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/>PS_logit &lt;- glm(treat ~ age + educ+race+married+nodegree+re74+re75, data = lalonde, family=binomial)<br/>PS_Scores = fitted(PS_logit)<br/>head(PS_Scores)<br/>```</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi po"><img src="../Images/88ee3119b8bf385981b45fa9975cfbbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sF9wPAzs_o_Pmm7ArmBAig.png"/></div></div></figure><p id="6723" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">第二步:根据估算的PS建立互斥地层</strong></p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="cb99" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/>lalonde$PS_Scores &lt;- PS_Scores<br/>lalonde<br/>```</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pp"><img src="../Images/bba107b7b4a054896e4b9f2853fd9f79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9hTv6sMM8U6KCMyBCs4o5A.png"/></div></div></figure><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="ba9e" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/># create strata <br/>Quintiles &lt;- quantile(lalonde$PS_Scores, prob=seq(from=0,to=1,by=0.2),na.rm=TRUE)<br/>lalonde$PS_Stratum &lt;- cut(lalonde$PS_Scores, breaks = Quintiles, labels = 1:5, include.lowest = TRUE)<br/>lalonde<br/>```</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pq"><img src="../Images/21950863312e3834d67ad9e040e2e6d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QavIYTR-eSmsYiiKSlLA1A.png"/></div></div></figure><p id="e6ee" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><strong class="mc jd">第三步&amp;第四步:将处理单元和对照单元分组到各个地层中；在每一层中，我们计算治疗组和对照组之间的平均值差异</strong></p><p id="5976" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">在R中，我们可以通过运行以下代码将步骤3和4结合在一起:</p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="3b4f" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/># Fifth Stratum: PS_Stratum = 5</span><span id="14cc" class="oy lj it ou b gy pm pa l pb pc">diff_5 = mean(lalonde[which(lalonde$treat==1&amp;lalonde$PS_Stratum==5), ’re78'])- mean(lalonde[which(lalonde$treat==0&amp;lalonde$PS_Stratum==5),’re78'])</span><span id="d4c9" class="oy lj it ou b gy pm pa l pb pc">diff_5<br/>```<br/>1364.036</span></pre><p id="4eb4" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">在第5层中，治疗组和对照组之间的结果变量(“re78”)的差异为1364.036美元。</p><p id="9d26" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">我们在下面的代码中对剩余的层重复同样的过程:</p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="9408" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/><strong class="ou jd"># Forth Stratum: PS_Stratum = 5<br/></strong>diff_4 = mean(lalonde[which(lalonde$treat==1 &amp; lalonde$PS_Stratum==4),’re78']) — mean(lalonde[which(lalonde$treat==0 &amp; lalonde$PS_Stratum==4),’re78'])<br/>diff_4<br/>841.7422</span><span id="2527" class="oy lj it ou b gy pm pa l pb pc"><strong class="ou jd"># Third Stratum: PS_Stratum = 3<br/></strong>diff_3 = mean(lalonde[which(lalonde$treat==1 &amp; lalonde$PS_Stratum==3),’re78']) — mean(lalonde[which(lalonde$treat==0 &amp; lalonde$PS_Stratum==3),’re78'])<br/>diff_3<br/>3167.41</span><span id="9679" class="oy lj it ou b gy pm pa l pb pc"><strong class="ou jd"># Second Stratum: PS_Stratum = 2<br/></strong>diff_2 = mean(lalonde[which(lalonde$treat==1 &amp; lalonde$PS_Stratum==2),’re78']) — mean(lalonde[which(lalonde$treat==0 &amp; lalonde$PS_Stratum==2),’re78'])<br/>diff_2<br/>2122.768</span><span id="b50c" class="oy lj it ou b gy pm pa l pb pc"># First Stratum: PS_Stratum = 1<br/>diff_1 = mean(lalonde[which(lalonde$treat==1 &amp; lalonde$PS_Stratum==1),’re78']) — mean(lalonde[which(lalonde$treat==0 &amp; lalonde$PS_Stratum==1),’re78'])<br/>diff_1<br/>-10467.06</span><span id="b820" class="oy lj it ou b gy pm pa l pb pc">```</span></pre><p id="a302" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">需要指出的是，第一层的差异似乎是:-10467.06。原因是地层中只有一个经过处理的观测值，从技术上讲，我们应该忽略它。然而，出于教学的原因，我们在分析中保留了它。<br/> <strong class="mc jd">第五步。对每一层的平均值进行加权并获得目标估计值，ATT </strong></p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="d65d" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/># the total nunmber of treated cases <br/>total_treated_n &lt;- nrow(lalonde[which(lalonde$treat==1),])<br/>total_treated_n <br/>185<br/>```</span></pre><p id="b6ea" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">首先，我们计算了接受治疗的病例总数，共有185例。</p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="a0e4" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/>#the number of treated cases in each stratum <br/>stratum_5_treated_n &lt;- nrow(lalonde[which(lalonde$treat==1 &amp; lalonde$PS_Stratum==5),])<br/>stratum_5_treated_n <br/>85<br/>```</span></pre><p id="c8d2" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">在地层中，治疗了85例。</p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="16b7" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/>ATT_5 = diff_5*stratum_5_treated_n/total_treated_n<br/>ATT_5<br/>626.7194<br/>```</span></pre><p id="9be0" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">然后，我们计算地层5中的加权处理效果。</p><p id="e7ab" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">对状态1–4重复相同的程序。</p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="01da" class="oy lj it ou b gy oz pa l pb pc">```{r}</span><span id="cfad" class="oy lj it ou b gy pm pa l pb pc">#the number of treated cases in each stratum <br/># stratum 4</span><span id="b38d" class="oy lj it ou b gy pm pa l pb pc">stratum_4_treated_n &lt;- nrow(lalonde[which(lalonde$treat==1 &amp; lalonde$PS_Stratum==4),])<br/>stratum_4_treated_n</span><span id="5db7" class="oy lj it ou b gy pm pa l pb pc">ATT_4 = diff_4*stratum_4_treated_n/total_treated_n<br/>ATT_4<br/>323.047</span><span id="e90f" class="oy lj it ou b gy pm pa l pb pc"># stratum 3<br/>stratum_3_treated_n &lt;- nrow(lalonde[which(lalonde$treat==1 &amp; lalonde$PS_Stratum==3),])<br/>stratum_3_treated_n</span><span id="f5ef" class="oy lj it ou b gy pm pa l pb pc">ATT_3=diff_3*stratum_3_treated_n/total_treated_n<br/>ATT_3<br/>359.5438</span><span id="8e2f" class="oy lj it ou b gy pm pa l pb pc"># stratum 2<br/>stratum_2_treated_n &lt;- nrow(lalonde[which(lalonde$treat==1 &amp; lalonde$PS_Stratum==2),])</span><span id="e7d0" class="oy lj it ou b gy pm pa l pb pc">stratum_2_treated_n<br/>7</span><span id="0a8d" class="oy lj it ou b gy pm pa l pb pc"># stratum 1<br/>stratum_1_treated_n &lt;- nrow(lalonde[which(lalonde$treat==1 &amp; lalonde$PS_Stratum==1),])<br/>stratum_1_treated_n</span><span id="c588" class="oy lj it ou b gy pm pa l pb pc">ATT_1= diff_1*stratum_1_treated_n/total_treated_n<br/>ATT_1<br/>- 56.57873</span><span id="c94d" class="oy lj it ou b gy pm pa l pb pc">```</span></pre><p id="e86a" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">最后一步，我们把它加起来，得到ATT:</p><pre class="ks kt ku kv gt ot ou ov ow aw ox bi"><span id="4770" class="oy lj it ou b gy oz pa l pb pc">```{r}<br/>ATT = ATT_1+ATT_2+ATT_3+ATT_4+ATT_5<br/>ATT</span><span id="bf3a" class="oy lj it ou b gy pm pa l pb pc">1333.052<br/>```</span></pre><p id="f24b" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">使用PS分层法，我们发现参加职业培训项目会导致项目后家庭收入增加1333.052美元。实验基准是1794美元，原论文使用PS分层估算<strong class="mc jd">1608</strong>。差距是由一些技术细节造成的。</p></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><p id="a295" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated"><em class="nk"> Medium最近进化出了它的</em> <a class="ae lh" href="https://blog.medium.com/evolving-the-partner-program-2613708f9f3c" rel="noopener"> <em class="nk">作家伙伴计划</em> </a> <em class="nk">，支持像我这样的普通作家。如果你还不是订户，通过下面的链接注册，我会收到一部分会员费。</em></p><div class="pr ps gp gr pt pu"><a href="https://leihua-ye.medium.com/membership" rel="noopener follow" target="_blank"><div class="pv ab fo"><div class="pw ab px cl cj py"><h2 class="bd jd gy z fp pz fr fs qa fu fw jc bi translated">阅读叶雷华博士研究员(以及其他成千上万的媒体作家)的每一个故事</h2><div class="qb l"><h3 class="bd b gy z fp pz fr fs qa fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="qc l"><p class="bd b dl z fp pz fr fs qa fu fw dk translated">leihua-ye.medium.com</p></div></div><div class="qd l"><div class="qe l qf qg qh qd qi lb pu"/></div></div></a></div></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><h1 id="ec26" class="li lj it bd lk ll nx ln lo lp ny lr ls ki nz kj lu kl oa km lw ko ob kp ly lz bi translated">参考</h1><p id="afaa" class="pw-post-body-paragraph ma mb it mc b md me kd mf mg mh kg mi mj mk ml mm mn mo mp mq mr ms mt mu mv im bi translated">奥斯汀，哥伦比亚特区，2011年。减少观察性研究中混杂效应的倾向评分方法介绍。<em class="nk">多元行为研究</em>，<em class="nk"> 46 </em> (3)，第399–424页。</p><p id="3178" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">小达戈斯蒂诺，R.B .，1998年。在治疗与非随机对照组的比较中减少偏倚的倾向评分方法。<em class="nk">医学统计学</em>，<em class="nk"> 17 </em> (19)，第2265–2281页。</p><p id="80b4" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">Dehejia，R.H .和Wahba，s .，1999年。非实验研究中的因果效应:重新评估训练计划的评估。<em class="nk">美国统计协会杂志</em>，<em class="nk"> 94 </em> (448)，第1053–1062页。</p><p id="5e8d" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">Imbens，G.W .，2004年。外源性下平均治疗效果的非参数估计:综述。<em class="nk">经济学与统计学回顾</em>，<em class="nk"> 86 </em> (1)，第4–29页。</p><p id="4f51" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">King，g .和Nielsen，r .，2019。为什么倾向评分不应用于匹配。<em class="nk">政治分析</em>，<em class="nk"> 27 </em> (4)，第435–454页。</p><p id="b77b" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">拉隆德，R.J .，1986年。用实验数据评估训练计划的经济计量评估。《美国经济评论》第604-620页。</p><p id="274d" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">neuhuser，m .，Thielmann，m .和Ruxton，G.D .，2018。二元结果的倾向分数分层中的层数。医学科学档案:AMS ，<em class="nk"> 14 </em> (3)，第695页</p><p id="6444" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">罗森鲍姆和鲁宾，1984年。使用倾向评分子类化减少观察性研究中的偏倚。<em class="nk">美国统计协会杂志</em>，<em class="nk"> 79 </em> (387)，第516–524页。</p><p id="8fe5" class="pw-post-body-paragraph ma mb it mc b md mw kd mf mg mx kg mi mj my ml mm mn mz mp mq mr na mt mu mv im bi translated">罗森鲍姆公关公司，2005年。观察研究中的敏感性分析。<em class="nk">行为科学统计百科</em>。</p></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><h1 id="ed6e" class="li lj it bd lk ll nx ln lo lp ny lr ls ki nz kj lu kl oa km lw ko ob kp ly lz bi translated">喜欢读这本书吗？</h1><blockquote class="pd pe pf"><p id="99b8" class="ma mb nk mc b md mw kd mf mg mx kg mi pg my ml mm ph mz mp mq pi na mt mu mv im bi translated">请在<a class="ae lh" href="https://www.linkedin.com/in/leihuaye/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>和<a class="ae lh" href="https://www.youtube.com/channel/UCBBu2nqs6iZPyNSgMjXUGPg" rel="noopener ugc nofollow" target="_blank"> Youtube </a>上找到我。</p><p id="83cd" class="ma mb nk mc b md mw kd mf mg mx kg mi pg my ml mm ph mz mp mq pi na mt mu mv im bi translated">还有，看看我其他关于人工智能和机器学习的帖子。</p></blockquote></div></div>    
</body>
</html>