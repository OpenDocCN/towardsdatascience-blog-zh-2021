<html>
<head>
<title>Exploring Electronic Health Records with MedCAT and Neo4j</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 MedCAT 和 Neo4j 探索电子健康记录</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/exploring-electronic-health-records-with-medcat-and-neo4j-f376c03d8eef?source=collection_archive---------13-----------------------#2021-12-07">https://towardsdatascience.com/exploring-electronic-health-records-with-medcat-and-neo4j-f376c03d8eef?source=collection_archive---------13-----------------------#2021-12-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/4a89a293619bef9236b6d71e194a88ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*my_skTcPX-awglk4EXhrYQ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">图 1:通过文档(粉色)显示与两名患者(蓝色)相关的疾病、症状、药物和程序。作者图片</p></figure><div class=""/><div class=""><h2 id="32aa" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">关于使从自由文本中提取的生物医学概念易于被临床医生和研究人员使用的实践指南</h2></div><p id="299f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">生物医学 NER+L 致力于从电子健康记录(EHRs)中的自由文本中提取概念，并将它们链接到大型生物医学数据库，如 SNOMED-CT 和 UMLS。</p><p id="1800" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在本帖中，我们将关注从自由文本中提取概念后该做什么，换句话说，如何让它们对临床医生和其他研究人员有用。</p><p id="ef55" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">先决条件</strong>:无，除非你想复制结果，那么你需要能够使用 MedCAT 和 Neo4j。</p><h1 id="3821" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">介绍</h1><p id="9a0b" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">假设我们访问了一家医院，并在 SNOMED 概念的电子健康记录中注释了所有自由文本。如果我们使用了 MedCAT，那么输出被存储到一个<code class="fe mn mo mp mq b">.json</code>文件中。我们的目标是将提取的概念移入一个数据库，该数据库将允许任何人编写简单的查询并利用注释，例如:</p><ul class=""><li id="eb5b" class="mr ms jf kw b kx ky la lb ld mt lh mu ll mv lp mw mx my mz bi translated">返回所有患有<em class="na">糖尿病</em>和<em class="na">腿痛</em>的患者</li><li id="76a3" class="mr ms jf kw b kx nb la nc ld nd lh ne ll nf lp mw mx my mz bi translated">返回<em class="na">病人 X </em> <strong class="kw jg">的所有疾病或</strong> <em class="na"> </em>返回特定单据中的所有疾病</li><li id="4b0a" class="mr ms jf kw b kx nb la nc ld nd lh ne ll nf lp mw mx my mz bi translated">返回所有出现呕吐症状<em class="na">且正在服用药物<em class="na"> valpam </em>的患者</em></li><li id="9e2e" class="mr ms jf kw b kx nb la nc ld nd lh ne ll nf lp mw mx my mz bi translated">返回所有没有阿尔茨海默氏症但有两次或更多次癫痫发作的男性患者。</li><li id="6a47" class="mr ms jf kw b kx nb la nc ld nd lh ne ll nf lp mw mx my mz bi translated">返回所有患有痴呆或任何其他疾病的患者，这些疾病是 SNOMED 本体论中痴呆概念的直接子代。</li></ul><p id="f203" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">虽然关系数据库可以完成这项工作(有些曲折)，但是图形数据库更适合。为什么？第一个原因是，我们希望导入 SNOMED/UMLS 本体(基本上是一个有向图),这样我们就可以轻松完成上面例子中的最后一个查询。第二，我们的注释可以很容易地表示为一个图形:<em class="na">病人-[HAS]- &gt;文档-[HAS]- &gt;概念</em>。换句话说:一个病人可以有一个或多个文档，一个文档可以有一个或多个概念的提及(例如疾病)。</p><p id="00d2" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在某种程度上，这篇文章的其余部分将是一个教程(伴随着一个<a class="ae ng" href="https://github.com/CogStack/MedCAT/blob/master/notebooks/TWDS%20-%20MedCAT%20%26%20Neo4j%20Tutorial.ipynb" rel="noopener ugc nofollow" target="_blank"> Jupyter 笔记本</a>)。它假设您在 localhost:7474 上安装了一个 Neo4j 数据库。由于我们无法使用真实数据，我从<a class="ae ng" href="https://www.mtsamples.com/" rel="noopener ugc nofollow" target="_blank"> mtsamples </a>中创建了两个虚拟文件:</p><ul class=""><li id="e928" class="mr ms jf kw b kx ky la lb ld mt lh mu ll mv lp mw mx my mz bi translated"><code class="fe mn mo mp mq b">patients.csv</code>包含所有患者的基本信息</li><li id="d990" class="mr ms jf kw b kx nb la nc ld nd lh ne ll nf lp mw mx my mz bi translated"><code class="fe mn mo mp mq b">documents.csv</code>包含文档文本+一个文档 ID</li></ul><h1 id="35de" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">注释文档</h1><p id="fdaa" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">在我们做任何事情之前，我们需要为<code class="fe mn mo mp mq b">documents.csv</code>中可用的自由文本生成注释。如果您已经用 MedCAT 或任何其他 NER+L 工具处理了文档，那么您可以跳过这一步。</p><pre class="nh ni nj nk gt nl mq nm nn aw no bi"><span id="8c76" class="np lr jf mq b gy nq nr l ns nt">from medcat.cat import CAT</span><span id="93f9" class="np lr jf mq b gy nu nr l ns nt">df_docs = pd.read_csv('./documents.csv')<br/># This would be a generator if we have a lot of docs<br/>data = [(k,v) for k,v in df_docs[['documentId', 'text']].values]</span><span id="6246" class="np lr jf mq b gy nu nr l ns nt"># You can find the model in the medcat repository<br/>cat = CAT.load_model_pack('./medmen_wstatus_2021_oct.zip')<br/>docs = cat.multiprocessing(data, nproc=10)<br/>json.dump(docs, open("./annotations.csv", 'w'))</span></pre><h1 id="ccd2" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">填充 Neo4j</h1><p id="a725" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">创建索引以加速数据接收和搜索(因为数据集可能非常大)</p><pre class="nh ni nj nk gt nl mq nm nn aw no bi"><span id="0bb2" class="np lr jf mq b gy nq nr l ns nt">from medcat.neo.data_preparation import *<br/>from medcat.neo.neo_connector import NeoConnector<br/>import pandas as pd</span><span id="6c15" class="np lr jf mq b gy nu nr l ns nt"># Helper for sending requests to neo<br/>neo = NeoConnector('bolt://localhost:7687/', user='neo4j')</span><span id="1d0b" class="np lr jf mq b gy nu nr l ns nt"># Indexes are pre-defined in the data_preparation helper<br/>for ind in get_index_queries():<br/>    try:<br/>        neo.execute(ind)<br/>    except Exception as e:<br/>        print(e)</span></pre><p id="bc3b" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">接下来，开始导入。</p><pre class="nh ni nj nk gt nl mq nm nn aw no bi"><span id="9781" class="np lr jf mq b gy nq nr l ns nt"># Import Patients<br/>df_pts = pd.read_csv('./patients.csv')<br/># If you cannot write to this output_dir save somewhere else and copy<br/>q = create_patients_csv(df_pts, output_dir='/var/lib/neo4j/import/')<br/># Run the query for import<br/>neo.execute(q)</span></pre><p id="bc3a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在 neo4j 浏览器(localhost:7474)中，现在将有 182 个带有标签<em class="na">患者</em>的新节点。对于<em class="na">概念</em>、<em class="na">文档</em>以及最后的<em class="na">注释</em>，将重复同样的操作。详细信息在随附的 Jupyter 笔记本中，这里我们跳过并假设所有内容都是导入的。</p><p id="50fa" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">下面的查询现在应该可以工作并返回数据样本:</p><pre class="nh ni nj nk gt nl mq nm nn aw no bi"><span id="c36e" class="np lr jf mq b gy nq nr l ns nt">MATCH (p:Patient)--&gt;(d:Document)--&gt;(c:Concept) RETURN p, d, c LIMIT 10</span></pre><p id="6824" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">输出图(差异是可能的，重要的是取回所有三种节点类型):</p><figure class="nh ni nj nk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nv"><img src="../Images/b3b06ff6ed87d510fd893d2403723fc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZoYydORORS6dUfPN0MGNA.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><h1 id="f141" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">查询 Neo4j</h1><p id="54dc" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">我们现在可以很容易地将上面展示的每个自然语言查询翻译成 Cypher(neo4j 查询语言)。但是，如果我们不知道 Cypher，MedCAT 有一个小类可以用来查询 Neo4j:</p><pre class="nh ni nj nk gt nl mq nm nn aw no bi"><span id="8c52" class="np lr jf mq b gy nq nr l ns nt"># Get all patients that have the concepts (Fever and Sleep Apnea). #We will set the ignore_meta flag as the medmentions model does not <br/>#have all required meta annotations.</span><span id="7bad" class="np lr jf mq b gy nu nr l ns nt">patients, q = neo.get_all_patients(concepts=['C0520679', 'C0015967'], limit=10, ignore_meta=True)</span></pre><p id="d36e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">或者将所有疾病分配给患者或文档:</p><pre class="nh ni nj nk gt nl mq nm nn aw no bi"><span id="3a7c" class="np lr jf mq b gy nq nr l ns nt"># Get all concepts from one patient<br/>stream, q = neo.get_all_concepts_from(patient_id='32', bucket_size_seconds=10**10)</span></pre><p id="cbb7" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">结果可以显示为数据帧:</p><figure class="nh ni nj nk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nw"><img src="../Images/b1fba4af75ff1a3683277b476e7ab964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KDEKJeIIrdeSnYb-Kpb0xg.png"/></div></div></figure><h1 id="5709" class="lq lr jf bd ls lt lu lv lw lx ly lz ma kl mb km mc ko md kp me kr mf ks mg mh bi translated">结束</h1><p id="e2b4" class="pw-post-body-paragraph ku kv jf kw b kx mi kg kz la mj kj lc ld mk lf lg lh ml lj lk ll mm ln lo lp ij bi translated">就这样，medcat.neo 库将随着时间的推移，使用新的查询和导入/导出功能进行更新。</p><p id="29a3" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">感谢您的阅读。</p></div></div>    
</body>
</html>