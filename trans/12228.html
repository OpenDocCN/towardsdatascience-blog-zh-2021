<html>
<head>
<title>How to Deploy Large-Size Deep Learning Models into Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将大规模深度学习模型部署到生产中</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-deploy-large-size-deep-learning-models-into-production-66b851d17f33?source=collection_archive---------4-----------------------#2021-12-12">https://towardsdatascience.com/how-to-deploy-large-size-deep-learning-models-into-production-66b851d17f33?source=collection_archive---------4-----------------------#2021-12-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="56ed" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">部署具有GB规模的培训的深度学习模型，并将它们作为商业产品在线托管</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d9349a8f530f1279fa3afd4f80a4767a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t7lx34vYoJ8lAeNU6un7_g.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">部署大型深度学习模型——图片来自<a class="ae kv" href="https://www.pexels.com/photo/high-angle-photo-of-robot-2599244/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的<a class="ae kv" href="https://www.pexels.com/@agk42?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">亚历山大·奈特</a></p></figure><p id="886c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">学习如何将深度学习模型从本地机器作为离线产品部署到在线产品是非常重要的，但主要挑战之一是训练模型的大规模。这篇文章将展示在部署更大规模的深度学习模型时，不同的解决方案和方法。</p><h1 id="c057" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">训练后的深度学习模型</h1><p id="11c8" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在选择了具有最佳调整和预测时间的最佳算法之后，您最终完成了模型的训练。<br/>是时候告诉你的朋友你的成功并庆祝一下了，对吗？如果您希望在线部署模型，并快速预测响应和管理大规模的训练负载，则情况并非如此！</p><p id="fb65" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一方面，Web服务更便宜，可以提供免费空间来部署ML模型，但在规模方面有限制，如<a class="ae kv" href="https://www.heroku.com/free" rel="noopener ugc nofollow" target="_blank"> Heroku Platform </a>和<a class="ae kv" href="https://streamlit.io/" rel="noopener ugc nofollow" target="_blank"> Streamlit Cloud </a>或者，你必须为部署深度学习模型支付昂贵的服务。但同样，当涉及到需要GPU或TPU高计算能力的千兆字节训练模型时，大小将是一个巨大的挑战。</p><p id="3402" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果模型是在GPU或TPU云服务中训练的，则CPU性能可用性是一个问题。深度学习模型可能会遇到缓慢的在线处理，或者可供其他应用程序使用，例如通过API调用。并且由于深度学习模型的巨大规模和其他问题，例如在TPU上运行和训练模型以及在CPU上部署，因此很难部署深度学习模型。因此，选择如何部署具有与本地机器或Colab笔记本培训相同性能的云服务是硬件考虑的关键。</p><h1 id="b9b7" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">在深度学习中部署模型</h1><p id="5c7a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">通过使用像Streamlit、<a class="ae kv" href="https://flask.palletsprojects.com/en/2.0.x/installation/" rel="noopener ugc nofollow" target="_blank"> Flask </a>和<a class="ae kv" href="https://www.djangoproject.com/" rel="noopener ugc nofollow" target="_blank"> Django </a>这样的Python框架，有许多不同的方式将深度学习模型部署为web应用。然后，使用<a class="ae kv" href="https://flask-restful.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> Flask RESTful </a>为模型服务构建一个REST API，以便与其他在线应用程序进行交互，并使您的模型在被调用时及时动作。(这里有一篇<a class="ae kv" rel="noopener" target="_blank" href="/how-to-build-a-machine-learning-api-using-flask-2fb345518801">构建API </a>的好文章)。</p><p id="142c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在构建了web应用程序接口之后，是时候将大尺寸的<a class="ae kv" href="https://www.tensorflow.org/install" rel="noopener ugc nofollow" target="_blank"> TensorFlow </a>、<a class="ae kv" href="https://keras.io/" rel="noopener ugc nofollow" target="_blank"> Keras </a>或<a class="ae kv" href="https://pytorch.org/" rel="noopener ugc nofollow" target="_blank"> PyTorch </a>模型部署到真实环境中了。下面的例子使用Streamlit加载张量模型，但是通过阅读带下划线的特定库的文档，确保如何保存和加载您自己的模型。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="cd3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="mr">大型训练模型存储在哪里，如何存储？</em> </strong></p><p id="2c30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有许多方法，但让我们展示最常用和最容易使用的免费方法，但有基于您消费多少和存储数据的区域的限制(继续提供免费服务，然后您可以在免费订阅的基础上以更低的价格扩展它)。亚马逊S3和谷歌云存储可以归类为<strong class="ky ir">【云存储】</strong>工具。找到更多关于<a class="ae kv" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank">亚马逊S3 </a>和<a class="ae kv" href="https://cloud.google.com/storage" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a>的信息，创建一个存储桶(保存数据的容器)来存储你的Gb大小的模型。</p><ul class=""><li id="987d" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated"><strong class="ky ir">下面是一个使用</strong> <a class="ae kv" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/setting-up-s3.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> AWS S3云存储</strong> </a>的例子</li><li id="47cb" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">在GCP  (Google云平台)创建<a class="ae kv" href="https://cloud.google.com/storage/docs/creating-buckets#storage-create-bucket-console" rel="noopener ugc nofollow" target="_blank">云存储的代码示例如下所示:</a></li></ul><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="af13" class="nl lt iq nh b gy nm nn l no np"># Colab Notebook! Run code in each cell<br/>from google.colab import auth<br/>auth.authenticate_user()  # Authenticate your cloud account</span><span id="bf68" class="nl lt iq nh b gy nq nn l no np"># your project ID in GCP ( from google console my project ) <br/>CLOUD_PROJECT = 'axial-trail-334'</span><span id="0887" class="nl lt iq nh b gy nq nn l no np"># storage name<br/>BUCKET = 'gs://' + 'axial-trail-334' + '-tf2-safarji-model' <br/>print(BUCKET)</span><span id="0a2d" class="nl lt iq nh b gy nq nn l no np"># with $ or !gcloud config set project 'axial-trail-334'<br/>!gcloud config set project $CLOUD_PROJECT </span><span id="70fd" class="nl lt iq nh b gy nq nn l no np"># with $  (create the BUCKET)<br/>!gsutil mb $BUCKET</span><span id="6cbd" class="nl lt iq nh b gy nq nn l no np"># Revoked credentia<br/>ls!gcloud auth revoke --all</span><span id="7688" class="nl lt iq nh b gy nq nn l no np">## with $  (check BUCKET) <br/>!gsutil ls -r $BUCKET </span></pre><p id="82dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这样，您就可以将模型部署到AI平台上了。在人工智能平台中，模型资源包含不同版本的模型。模型名称在项目中必须是唯一的。首先，让我们创建一个模型。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="d08b" class="nl lt iq nh b gy nm nn l no np"># Create model in Google Cloud (GCP) after following above steps <br/>MODEL = 'newmodel-T5'</span><span id="767a" class="nl lt iq nh b gy nq nn l no np">!gcloud ai-platform models create $MODEL --regions=us-central1</span><span id="6eef" class="nl lt iq nh b gy nq nn l no np"># check google</span></pre><ul class=""><li id="fa23" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">在人工智能平台云平台，你会看到你的模型如下:</li></ul><div class="kg kh ki kj gt ab cb"><figure class="nr kk ns nt nu nv nw paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/813ac86a3dd476da75731ca6a785400e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*t7cFNBUP-AQ7lbAxDi5pSg.png"/></div></figure><figure class="nr kk nx nt nu nv nw paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/95b9623f9f48776a1d00552ea378f411.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*2UhcbQxLesqsz6xP8wj7yw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk ny di nz oa translated">GCP控制台——来自作者</p></figure></div><ul class=""><li id="f248" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">基于您的模型类型TensorFlow或其他创建您的模型部署版本。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/d73814aeb73cb7bfda34d2f514758e2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y-Ev7ylb7OsEBOKIH0qHvw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">GCP控制台——来自作者</p></figure><blockquote class="oc od oe"><p id="3b00" class="kw kx mr ky b kz la jr lb lc ld ju le of lg lh li og lk ll lm oh lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="iq">重要提示:如果保存模型的桶大小以Gb为单位非常大，由于大小超出限制，您将无法获得如下所示的AI平台服务。</em>T3】</strong></p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/cb009173fc652ed05f5f5ea29b5156da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pt3tsLFdJB-UKmEnUU-k2g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">GCP控制台——来自作者</p></figure><blockquote class="oc od oe"><p id="4b92" class="kw kx mr ky b kz la jr lb lc ld ju le of lg lh li og lk ll lm oh lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="iq">遗憾的是，此限制目前不可调整，但未来可能会调整。与此同时，您需要调整vocab和嵌入大小，或者减少模型的整体大小。此外，请联系谷歌云，根据您的项目名称调整每个项目的配额</em></strong><a class="ae kv" href="http://cloudml-feedback@google.com" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir"><em class="iq">【cloudml-feedback@google.com】</em></strong></a><strong class="ky ir"><em class="iq">。</em> </strong></p><p id="ef9b" class="kw kx mr ky b kz la jr lb lc ld ju le of lg lh li og lk ll lm oh lo lp lq lr ij bi translated">*问题是他们的人工智能平台规模的大多数云提供商接受大型模型。</p></blockquote><p id="8f8b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="mr">还有别的解决方法吗？</em> </strong></p><p id="d52d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">是的，您可以选择一个<a class="ae kv" href="https://cloud.google.com/deep-learning-vm/docs/cloud-marketplace" rel="noopener ugc nofollow" target="_blank">定制深度学习云实例</a> (VM)和大小来部署您的模型在GPU和<a class="ae kv" href="https://cloud.google.com/tpu" rel="noopener ugc nofollow" target="_blank"> TPUs </a>方面所需的最佳要求。然而，存储模型的桶将是相同的，并通过GCP将它加载到新服务器的新实例中，或AWS实例中。</p><p id="668c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="mr">最重要的是:</em></strong>AWS中还有另外一个服务，可以部署大型变形金刚:</p><div class="oj ok gp gr ol om"><a href="https://aws.amazon.com/sagemaker/" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">亚马逊SageMaker -机器学习-亚马逊网络服务</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">让更多的人通过选择工具用ML进行创新——集成的数据开发环境…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">aws.amazon.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa kp om"/></div></div></a></div><h1 id="200a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">云服务中的存储桶</h1><p id="11e5" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在云服务中创建存储桶之后，是时候存储和加载模型了。下面是加载的一个片段:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="21ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意:确保使用缓存和其他策略来优化基于您使用的框架的web应用程序中的模型加载，因为这将有助于避免每次使用或预测时再次调用模型所耗费的时间和带宽。</strong></p><h1 id="e32c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论:</h1><p id="1577" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">训练大规模的深度学习模型只是数据科学项目的一个方面，该项目投入大量精力使其在生产中(在线)可用。在这篇文章中，我们展示了在部署更大规模的深度学习模型时可以遵循的不同解决方案和方法。</p><p id="7a85" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据您的应用程序，您可能需要选择一个可用选项，哪些云服务和哪些自定义实例支持模型部署和基础架构。然而，这篇文章只是我在部署大型深度学习模型时所经历的一个例子。但是我认为它为云服务和云存储工具方面的另一个概述提供了一个起点。生产中的深度学习模型还有很多其他后续动作，包括在GPU和TPU上的训练评测；然而，这些是为下一篇文章准备的。</p></div><div class="ab cl pb pc hu pd" role="separator"><span class="pe bw bk pf pg ph"/><span class="pe bw bk pf pg ph"/><span class="pe bw bk pf pg"/></div><div class="ij ik il im in"><h1 id="846e" class="ls lt iq bd lu lv pi lx ly lz pj mb mc jw pk jx me jz pl ka mg kc pm kd mi mj bi translated">参考资料:</h1><div class="oj ok gp gr ol om"><a href="https://cloud.google.com/ai-platform/prediction/docs/deploying-models" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">部署模型|人工智能平台预测|谷歌云</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">这一页解释了如何将你的模型部署到人工智能平台预测以获得预测。为了部署您的…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">cloud.google.com</p></div></div><div class="ov l"><div class="pn l ox oy oz ov pa kp om"/></div></div></a></div><div class="oj ok gp gr ol om"><a href="https://aws.amazon.com/getting-started/hands-on/build-train-deploy-machine-learning-model-sagemaker/" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">如何使用Amazon SageMaker | AWS构建、训练和部署机器学习模型</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">了解如何在10分钟内使用Amazon SageMaker构建、训练和部署机器学习模型。</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">aws.amazon.com</p></div></div><div class="ov l"><div class="po l ox oy oz ov pa kp om"/></div></div></a></div><div class="oj ok gp gr ol om"><a href="https://www.tensorflow.org/tutorials/keras/save_and_load" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">保存和加载模型| TensorFlow核心</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">如果使用SavedModel格式，可以跳过这一节。HDF5和SavedModel的主要区别在于…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">www.tensorflow.org</p></div></div><div class="ov l"><div class="pp l ox oy oz ov pa kp om"/></div></div></a></div><div class="oj ok gp gr ol om"><a href="https://acloudguru.com/videos/cloud-provider-comparisons/cloud-provider-comparisons-aws-vs-azure-vs-gcp-storage?utm_campaign=11244863417&amp;utm_source=google&amp;utm_medium=cpc&amp;utm_content=469352928666&amp;utm_term=_&amp;adgroupid=115625160932&amp;gclid=Cj0KCQiA2NaNBhDvARIsAEw55hjHEBCHxdry4t-gA2qgkNZll1W-yT1ELlVPnKOkzP1e_0UgutXWVvMaAk9iEALw_wcB" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">ACG视频</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">在云提供商比较中，我们看一下三大公共云提供商的相同云服务…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">acloudguru.com</p></div></div><div class="ov l"><div class="pq l ox oy oz ov pa kp om"/></div></div></a></div><p id="1eed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇文章中的所有源代码以及更多内容可以在我的GitHub上找到:<a class="ae kv" href="https://gist.github.com/A-safarji" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/A-safarji</a></p></div></div>    
</body>
</html>