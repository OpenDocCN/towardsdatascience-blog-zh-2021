<html>
<head>
<title>Explaining a BigQuery ML model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解释BigQuery ML模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/explaining-a-bigquery-ml-model-5cf8d9636ec9?source=collection_archive---------15-----------------------#2021-07-29">https://towardsdatascience.com/explaining-a-bigquery-ml-model-5cf8d9636ec9?source=collection_archive---------15-----------------------#2021-07-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="eaa1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何获得和解释对预测的解释</h2></div><p id="5a4b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BigQuery ML是一种简单易用的方法，只使用SQL就可以在结构化数据上调用机器学习模型。虽然它只是从线性回归开始，但通过将BigQuery ML与TensorFlow和Vertex AI连接起来作为后端，已经添加了更复杂的模型，如深度神经网络和AutoML表。换句话说，虽然我们写SQL，但是执行的是TensorFlow。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/9f3a5c2bb5dcd6670ffa422936a97f0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PjD0_qyq1I3D26SIV8HOtA.jpeg"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">图片由<a class="ae lr" href="https://pixabay.com/users/startupstockphotos-690514/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=849811" rel="noopener ugc nofollow" target="_blank"> StartupStockPhotos </a>来自<a class="ae lr" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=849811" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="66d6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BigQuery ML正在从Vertex AI后端*获取更多功能。在早先的一篇<a class="ae lr" href="https://medium.com/google-cloud/hyperparameter-tuning-directly-within-bigquery-ml-a0affb0991ae" rel="noopener">文章</a>中，我向你展示了超参数调谐。在这篇文章中，我将向你展示可解释性。</p><h2 id="74ff" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">什么是可解释性？</h2><p id="56c2" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">可解释性是理解机器学习模型正在做什么的一种方式。有两种类型的解释。在局部可解释性中，我们问ML模型它是如何得出个体预测的结果的。为什么上面说这个租赁会持续2000秒？为什么会暗示这个交易是欺诈性的？</p><p id="61b0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在全局可解释性中，我们询问特性的重要性。在预测租赁期限时，时间有多重要？交易金额对预测交易是否欺诈有多重要？</p><p id="23de" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BigQuery ML支持这两种类型的解释，但是根据我的经验，本地可解释性是最终用户想要的，所以我将重点讨论这一点。</p><h2 id="ae23" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">回归模型</h2><p id="5527" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我将采用一个简单的模型来预测我在整本书中使用的自行车租赁期限(BigQuery:权威指南):</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="2523" class="ls lt iq mr b gy mv mw l mx my">CREATE OR REPLACE MODEL ch09eu.bicycle_linear<br/>TRANSFORM(<br/>  * EXCEPT(start_date),<br/>  CAST(EXTRACT(dayofweek from start_date) AS STRING)<br/>         as dayofweek,<br/>  CAST(EXTRACT(hour from start_date) AS STRING)<br/>         as hourofday<br/>)<br/>OPTIONS(model_type='linear_reg', input_label_cols=['duration'])<br/>AS<br/>SELECT<br/>  duration<br/>  , start_station_name<br/>  , start_date    <br/>FROM <br/>  `bigquery-public-data`.london_bicycles.cycle_hire</span></pre><p id="3c93" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">解释预测</strong></p><p id="48f4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">而不是打电话给ML。预测，我们称之为ML。EXPLAIN_PREDICT在预测的同时获得解释:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="3189" class="ls lt iq mr b gy mv mw l mx my">SELECT * <br/>FROM <strong class="mr ir">ML.EXPLAIN_PREDICT</strong>(<br/>    MODEL `ai-analytics-solutions.ch09eu.bicycle_linear`, <br/>    (<br/>        SELECT 'Park Street, Bankside' AS start_station_name,<br/>        CURRENT_TIMESTAMP() AS start_date<br/>    )    <br/>)</span></pre><p id="2326" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果是:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/3a5687901b0ab4d2d78c247637c5371e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*7H84MyovJaZIEGh_CQnqcw.png"/></div></figure><p id="816b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">预计持续时间为1929秒。</p><p id="a2ad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该模型以4598秒的基线预测值开始，这是整个训练数据集的平均预测值。从第二个输入(时间戳)开始，模型提取出了一天中的小时和一周中的天。</p><p id="340a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">星期几是星期三，模型将基线值增加了247秒。换句话说，人们在周三租自行车的时间比平均时间稍长。</p><p id="62e1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，我们看到的是凌晨4点。这将导致租赁期限大幅下调2800秒！</p><p id="bb38" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，Parkside是一个租金通常较低的车站。因此，模型应用了另一个修正，这次是116秒。</p><p id="0093" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi">4598 + 247–2800–116 = 1929</p><h2 id="86e1" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">分类模型</h2><p id="eb2d" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">作为我们的第二个示例，我们来看一个欺诈预测模型:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="347d" class="ls lt iq mr b gy mv mw l mx my">CREATE OR REPLACE MODEL advdata.ulb_fraud_detection <br/>TRANSFORM(<br/>    * EXCEPT(Amount),<br/>    SAFE.LOG(Amount) AS log_amount<br/>)<br/>OPTIONS(<br/>    INPUT_LABEL_COLS=['class'],<br/>    AUTO_CLASS_WEIGHTS = TRUE,<br/>    DATA_SPLIT_METHOD='seq',<br/>    DATA_SPLIT_COL='Time',<br/>    MODEL_TYPE='logistic_reg'<br/>) AS<br/>SELECT <br/> *<br/>FROM `bigquery-public-data.ml_datasets.ulb_fraud_detection`</span></pre><p id="c8d4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同样，我们使用ML。解释_预测:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="f4c2" class="ls lt iq mr b gy mv mw l mx my">SELECT * <br/>FROM ML.EXPLAIN_PREDICT(<br/>    MODEL `ai-analytics-solutions.advdata.ulb_fraud_detection`, <br/>    (<br/>        SELECT *<br/>        FROM `bigquery-public-data.ml_datasets.ulb_fraud_detection`<br/>        WHERE Amount BETWEEN 300 AND 305<br/>        LIMIT 1<br/>    )    <br/>)</span></pre><p id="ea67" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果的欺诈预测类为0(无欺诈)，概率为0.946。这对应于-2.87的<em class="na"> logits </em>值(概率是logits的sigmoid)。</p><p id="1133" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不幸的是，这个数据集没有告诉我们列是什么，但是基线是-2.70，表明数据值没有太多异常。</p><p id="2e34" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们尝试一个不同的预测，这次选择一个非常高价值的交易:</p><pre class="lc ld le lf gt mq mr ms mt aw mu bi"><span id="0234" class="ls lt iq mr b gy mv mw l mx my">SELECT * <br/>FROM ML.EXPLAIN_PREDICT(<br/>    MODEL `ai-analytics-solutions.advdata.ulb_fraud_detection`, <br/>    (<br/>        SELECT *<br/>        FROM `bigquery-public-data.ml_datasets.ulb_fraud_detection`<br/>        <strong class="mr ir">WHERE Amount &gt; 10000</strong><br/>        LIMIT 1<br/>    )    <br/>)</span></pre><p id="a9c0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，该模型预测该交易很可能是欺诈性的。逻辑值是12.665，而基线值是-2.7。这笔交易的概率大幅增加背后的关键因素是V4(增加了10.67)和V14(减少了4)。当然，如果我们知道V4和V14是……这将意味着更多，但公开发布的财务数据集没有这些信息。</p><p id="739d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，您可以使用实例解释来解释不同的输入是如何导致结果值发生变化的。这有助于建立模型正常工作的信心。</p><p id="6ec7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p><p id="1978" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="na"> *可解释性以最有效的方式为每个模型类型实现。在某些情况下，Vertex AI被调用，而在其他情况下，它是在BigQuery内部完成的。但是这是一个实现细节——不管它是如何实现的，你都可以用同样的方式调用它。</em></p></div></div>    
</body>
</html>