<html>
<head>
<title>Stop detection in GPS tracks — Movingpandas &amp; KeplerGl</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GPS轨迹中的停止检测—移动熊猫和开普勒</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/stop-detection-in-gps-tracks-movingpandas-keplergl-point-map-with-stops-duration-in-bird-664064b3ccbc?source=collection_archive---------14-----------------------#2021-03-24">https://towardsdatascience.com/stop-detection-in-gps-tracks-movingpandas-keplergl-point-map-with-stops-duration-in-bird-664064b3ccbc?source=collection_archive---------14-----------------------#2021-03-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d37b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在鸟类迁徙追踪中创建带有停留时间的点地图</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8227f74ee420e7136f5263be0c7ac655.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*49CNz7Mo6fXaA-Ze4j3veA.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者提供，GPS轨迹的地图动画。</p></figure><p id="b142" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在过去的几个月里，我通过分析移动数据(GPS跟踪数据)发现了<a class="ae lu" href="https://github.com/anitagraser/movingpandas" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">移动熊猫</strong> </a>的力量。由<a class="ae lu" href="https://anitagraser.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu"> Anita Graser </strong> </a>开发的这个python库包含了让以非常方便的方式操作运动数据的算法。提出运动分析的问题与旅行行为模式有关，并找出被跟踪对象以特定方式运动的原因。真正抓住我并最吸引我的是<strong class="la iu"> <em class="lv">停止检测算法</em> </strong> <em class="lv"> </em>，它在特定的搜索半径(即邻域)内找到被跟踪的对象在轨迹中具有特定持续时间(停止)的路段。在这一点上，使用这种算法的想法可以在例如交通分析中的城市应用、繁殖行为的生物学应用、迁移分析的地理学应用中得到推广，你可以找到更多。关键的一点是，作为一名分析师，你必须在时间和搜索半径上保持明确和合理的参数。时间将揭示你可能想要发现的活动，例如在娱乐中心花费的时间和搜索半径社区/城市的大小。</p><p id="82ac" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本帖最终地图动画可以在<a class="ae lu" href="https://bryanvallejo16.github.io/stop-detection-bird-tracking/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">这里</strong> </a>！<br/>按下播放，探索！<br/>这里分析<a class="ae lu" href="https://github.com/bryanvallejo16/stop-detection-bird-tracking" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">这里分析</strong> </a>！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/df44db0ce307427cb6a1fb6864c4863b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6qUYzGJ6Wtzjn33dD50mHA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者提供，鸟类轨迹中带有停留时间的点地图。</p></figure><p id="8720" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们把手放在它上面。在这个分析示例中，我使用了来自<a class="ae lu" href="https://www.gbif.org/" rel="noopener ugc nofollow" target="_blank">全球生物多样性信息中心</a>的数据集，其中包含三只黑背鸥的GPS记录:Eric、Nico和Sanne。你可以在GBIF网站上找到有更多海鸥的<a class="ae lu" href="https://www.gbif.org/occurrence/download/0220376-200613084148143" rel="noopener ugc nofollow" target="_blank">整个数据集</a>，这三种鸟类的数据集在本文  的<a class="ae lu" href="https://github.com/bryanvallejo16/stop-detection-bird-tracking" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu"> <em class="lv">资源库中。该过程分为三个部分进行解释:1)使用Geopandas创建图层，2)使用移动pandas进行停止检测，3)使用KeplerGl进行点地图可视化。</em></strong></a></p><p id="c9c3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="lv"> 1。使用Geopandas </em>创建图层</strong></p><p id="2f40" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将在一个Jupyter笔记本中完成整个分析，因此导入我们将要使用的所有python库是非常有效的。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="6c42" class="mc md it ly b gy me mf l mg mh">import pandas as pd<br/>import geopandas as gpd<br/>import movingpandas as mpd<br/>from shapely.geometry import Point<br/>from pyproj import CRS<br/>from keplergl import KeplerGl<br/>from datetime import datetime, timedelta</span></pre><p id="9a5d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，过程变得简单。读取CSV文件，添加几何列，在WGS84中创建地理数据框。是这样的:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="e71a" class="mc md it ly b gy me mf l mg mh"># Reading file<br/>fp = r'data/bird_tracking_data.csv'<br/>data = pd.read_csv(fp)</span><span id="9d08" class="mc md it ly b gy mi mf l mg mh"># Creating a geometry column as Point geometry<br/>data['geometry'] = [Point(long, lat) for long, lat in zip(data['longitude'].to_list(), data['latitude'].to_list())]</span><span id="3287" class="mc md it ly b gy mi mf l mg mh"># Creating a Geodataframe. Be aware it is CRS 4326 WGS84<br/>geodata = gpd.GeoDataFrame(data, crs = CRS.from_epsg('4326'))</span></pre><p id="09cb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们有了<code class="fe mj mk ml ly b">geodata</code>我们可以开始下一个使用移动熊猫的部分。</p><p id="ff85" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">②<em class="lv">。停止侦测移动的熊猫</em> </strong></p><p id="c344" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在创建移动熊猫的轨迹之前，第一个主要步骤是在<code class="fe mj mk ml ly b">geodata</code>中添加<em class="lv">时间戳</em>作为索引</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="1111" class="mc md it ly b gy me mf l mg mh"># Create timestamp with Pandas datetime. Inclue None as timezone<br/>geodata['t'] = pd.to_datetime(geodata['date_time']).dt.tz_localize(None)</span><span id="ab2f" class="mc md it ly b gy mi mf l mg mh"># Set timestamp as Index<br/>geodata = geodata.set_index('t')</span><span id="d628" class="mc md it ly b gy mi mf l mg mh">geodata.head()</span></pre><p id="328a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你会有一张漂亮的桌子，如下图所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mm"><img src="../Images/0b268186480abd584b8c4c990aa06146.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_uZpy5i5oIrL11GLLuzweQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者提供，表格准备好用于移动熊猫分析</p></figure><p id="24ec" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此时，您可以分析数据集的一些特征，如长度(61920条记录)和本例中的鸟总数:Eric、Nico和Sanne。跟踪的时间范围从2013年8月15日开始，到2014年4月30日结束，共9个月。</p><p id="1ae3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于移动熊猫，您可以创建一个<code class="fe mj mk ml ly b">TrajectoryCollection</code>,指定轨迹的ID，在本例中是带有鸟的名字的列。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="60a8" class="mc md it ly b gy me mf l mg mh"># Create a Trajectory Collection with Movingpandas<br/>traj_collection = mpd.TrajectoryCollection(geodata, 'bird_name')</span></pre><p id="1c30" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在Anita Graser的资源库中，您可以探索这个<code class="fe mj mk ml ly b">TrajectoryCollection</code>的属性，但在这里我将直接继续讨论<strong class="la iu"> <em class="lv">停止检测算法</em> </strong>。当我们探索9个月的鸟类轨迹数据集时，我将在1000米的局部水平上以适度的<em class="lv">搜索</em>半径识别鸟类的停留，停留持续时间<em class="lv">为12小时或更长。</em></p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="f963" class="mc md it ly b gy me mf l mg mh"># Define parameters in Hours and Search radius in meters<br/>Hours = 12<br/>SearchRadio = 1000</span><span id="e3e4" class="mc md it ly b gy mi mf l mg mh"># stop detection<br/>stops = mpd.TrajectoryStopDetector(traj_collection).get_stop_segments(min_duration=timedelta(hours=Hours), max_diameter=SearchRadio)</span></pre><p id="7f63" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意！关于<strong class="la iu"> <em class="lv">停止检测算法</em> </strong>的一些有趣的事情是，每一次停止代表一段轨迹。所以，这一段是海鸥在1公里搜索半径内花了12个小时的地方。从逻辑上讲，作为一段轨迹的停止点具有持续时间、长度、起点、开始时间、终点和结束时间(以及其他属性，如速度)。作为一个快速视图，您可以看到下一个捕捉中的停靠点:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/fa7f03c86e3e1056c802bbc38fdf3d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*InAIX8Y4AYRqPanIWCbK3g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片，停止可视化(轨迹段)</p></figure><p id="5d8c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了得到一个点地图作为最终输出，我们将使用停止的起点。在这一点上，我们汇总了停止持续时间，这基本上意味着在停止(轨迹段)中花费的总时间。为了聚合点中的停止持续时间，我们创建了一个新的地理数据框，其中包含了该属性。接下来是代码:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="c280" class="mc md it ly b gy me mf l mg mh"># Create a new Geodataframe and define geometry column<br/>stops_start = gpd.GeoDataFrame(columns = ['geometry'])<br/>stops_start = stops_start.set_geometry('geometry')</span><span id="6d02" class="mc md it ly b gy mi mf l mg mh"># Add the ID of each stop track and define it as index<br/>stops_start['stop_id'] = [track.id for track in stops.trajectories]<br/>stops_start= stops_start.set_index('stop_id')</span><span id="912e" class="mc md it ly b gy mi mf l mg mh"># Iteration over the Stop Trajectories<br/>for stoptrack in stops.trajectories:<br/>    <br/>    # add stop duration in hours<br/>    stops_start.at[stoptrack.id,’duration_h’] =stoptrack.get_duration().total_seconds()/3600<br/>    <br/>    # add length<br/>    stops_start.at[stoptrack.id, 'length_m’]=stoptrack.get_length()<br/>    <br/>    # add bird name<br/>    stops_start.at[stoptrack.id, 'bird’]=stoptrack.id.split(’_’)[0]<br/>    <br/>    # add datetime<br/>    stops_start.at[stoptrack.id, 'datetime’]= pd.to_datetime(stoptrack.id.split(’_’)[1]).tz_localize(None)<br/>    <br/>    # geometry with start point<br/>    stops_start.at[stoptrack.id, 'geometry’] = stoptrack.get_start_location()<br/>    <br/>stops_start.head()</span></pre><p id="c9fa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你会有一张漂亮的桌子，看起来像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mo"><img src="../Images/e56d41b783fa03c9549436dcf49d7fc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KggbMjZKeD7Ghb6W_FWwLw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者提供，停止持续时间表已准备好进行可视化</p></figure><p id="7d6d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请记住，在接下来的步骤中，KeplerGl不接受时间戳类型，为了避免混淆，我们必须重置索引<code class="fe mj mk ml ly b">geodata </code>和<code class="fe mj mk ml ly b">stops_start</code>。您只需运行这些行:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="6fc2" class="mc md it ly b gy me mf l mg mh"># Reset indexes<br/>stops_start = stops_start.reset_index(drop=True)<br/>geodata= geodata.reset_index(drop=True)</span></pre><p id="4a35" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="lv"> 3。用开普勒Gl </em> </strong>实现点地图可视化</p><p id="9123" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">KeplerGl 是由优步开发的一个强大的python库，它有助于以一种非常有效的方式可视化大量的点。我发现适合运动数据的是，你可以添加一个时间窗口，并将其作为地图动画播放。运动数据中的动画有助于可视化之前提到的旅行行为，这篇文章旨在让您可视化鸟类的轨迹，它们在哪里停留了多久。</p><p id="6f49" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从KeplerGl开始，首先创建一个实例:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="6ebd" class="mc md it ly b gy me mf l mg mh"># Create KeplerGl instance<br/>m = KeplerGl(height=600)</span></pre><p id="7f37" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后将数据添加到实例中。我们想要可视化的是停止和轨迹。因此，您添加了下一个地理数据框:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="d2b5" class="mc md it ly b gy me mf l mg mh"># Add stop durations<br/>m.add_data(stops_start, 'stops')</span><span id="acb7" class="mc md it ly b gy mi mf l mg mh"># Add gps records<br/>m.add_data(geodata, 'trajectories')</span></pre><p id="ff7a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">调用实例后，您可以在KeplerGl控制台中编辑可视化，并放置颜色、大小、过滤器等。请记住，我们需要一个基于持续时间的点地图，所以我们在点大小中添加了以小时为单位的持续时间。您还可以添加时间过滤器。</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="6694" class="mc md it ly b gy me mf l mg mh">m</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mp"><img src="../Images/d8f7cb25ea361f5172d85d62a50e4cec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0pn0iUGEMt0TvOgx_L6Icg.png"/></div></div></figure><p id="3817" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦找到了最佳的可视化效果，就可以将地图保存为Html格式以供发布。在这里你可以查看<a class="ae lu" href="https://bryanvallejo16.github.io/stop-detection-bird-tracking/" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu">这张最终地图</strong> </a>。用下一行:</p><pre class="kj kk kl km gt lx ly lz ma aw mb bi"><span id="478f" class="mc md it ly b gy me mf l mg mh"># Save map as html<br/>m.save_to_html(file_name='index.html')</span></pre><p id="d8a8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">仅此而已！<br/>在您自己的研究中使用stop检测算法找到最佳见解。如果你需要工作流自动化方面的支持，我可以支持你。<a class="ae lu" href="https://www.linkedin.com/in/bryanrvallejo/" rel="noopener ugc nofollow" target="_blank">查看我的简介</a>。</p></div></div>    
</body>
</html>