<html>
<head>
<title>Using Pandera on Spark for Data Validation through Fugue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过神游在Spark上使用Pandera进行数据验证</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-pandera-on-spark-for-data-validation-through-fugue-72956f274793?source=collection_archive---------13-----------------------#2021-05-08">https://towardsdatascience.com/using-pandera-on-spark-for-data-validation-through-fugue-72956f274793?source=collection_archive---------13-----------------------#2021-05-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="443a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">本教程将展示如何用赋格将熊猫库引入Spark和Dask。在这个例子中，我们将使用Spark上的Pandera数据验证库。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8003c6debea19878f2c7da69c483c8a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bwKZDOhJvF9pSfcN"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@xoforoct?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">EJ·斯特拉特</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="aee4" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">数据有效性</h1><p id="c2a6" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">数据验证是进行适当的检查，以确保数据符合我们期望的格式和规范。随着数据管道变得越来越互联，无意中破坏其他管道的变化的机会也增加了。验证用于保证上游的更改不会破坏下游数据操作的完整性。常见的数据验证模式包括检查空值或检查数据框形状，以确保转换不会丢失任何记录。其他经常使用的操作是检查列的存在和模式。使用数据验证可以避免数据流程的无声失败，在这种情况下，一切都可以成功运行，但提供的结果不准确。</p><p id="7439" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">数据验证可以放在数据管道的开始，以确保任何转换顺利进行，也可以放在最后，以确保在输出提交到数据库之前一切正常。这就是可以使用像<a class="ae kv" href="https://github.com/pandera-dev/pandera" rel="noopener ugc nofollow" target="_blank">潘德拉</a>这样的工具的地方。在这篇文章中，我们将制作一个小熊猫数据框来展示例子。有三列，州、城市和价格。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/870ad2ad62b8f21c22654b26d449c90d.png" data-original-src="https://miro.medium.com/v2/resize:fit:804/format:webp/1*iVnmnzO7pUdtRZtbAaddpA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">样本数据—每个位置的价格</p></figure><h1 id="7383" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">潘德拉</h1><p id="3298" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Pandera是一个轻量级的数据验证框架，有很多内置的验证器来验证DataFrame模式和值。当验证失败时，它提供信息性错误，并且它对已经编写的代码也是非侵入性的，因为<a class="ae kv" href="https://pandera.readthedocs.io/en/stable/decorators.html" rel="noopener ugc nofollow" target="_blank">decorator</a>可以与其他函数一起使用来执行验证。下面是我们将如何检查我们的数据，以确保<strong class="lq ir">价格</strong>在推向生产之前是合理的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">基本的Pandera用法</p></figure><p id="b0fe" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">潘德拉代码是直观的。第3–5行定义了在<strong class="lq ir">列</strong>上执行的检查。我们正在检查价格值是否在5到20之间。第7–10行只是一个包装器函数(为了后面的目的)，但是我们真正需要的是调用第9行的<strong class="lq ir"> validate </strong>方法来应用验证。</p><h1 id="3fcf" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">对火花(或Dask)的需求</h1><p id="7dbb" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如果数据变得太大，熊猫无法有效处理(超过15GB)，我们该怎么办？为了加快我们的工作，我们需要使用分布式计算框架。这就是火花和达斯克的用武之地。计算操作是在一群机器上执行的，而不是在一台机器上。</p><p id="98fe" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在很多情况下，我们已经为熊猫写好了逻辑，但想把它带到Spark。一个用例是写出一个非常具体的大型验证模式。我们需要在Spark中重新创建该功能。不幸的是，Pandera只适用于熊猫，这意味着我们需要从头开始重新创建。问题是定制的业务逻辑需要Pandas和Spark的两个实现。</p><h1 id="f006" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">赋格入门</h1><p id="90d6" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这就把我们带到了赋格。Fugue是一个抽象层，允许用户将Python或Pandas代码移植到Spark或Dask。逻辑与执行解耦，用户只需修改一行代码就可以选择自己需要的引擎。我们可以用下面的代码来激发上面熊猫特有的逻辑。注意，第12行之前的所有内容都是从前面的Pandera代码片段中复制的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="b2ba" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">第15行中的<strong class="lq ir">fugeworkflow</strong>类包含一个执行引擎。如果没有传递任何内容，则默认使用熊猫。在这个具体的例子中，我们传递了<strong class="lq ir"> SparkExecutionEngine </strong>，它在Spark中执行我们所有的逻辑。<strong class="lq ir"> price_validation </strong>函数被映射到Spark分区。这将加快大型数据集的验证操作。</p><h1 id="5271" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">按分区验证</h1><p id="c6f2" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">当前的数据验证框架有一个缺点。根据我们掌握的数据，CA和FL的价格范围相差很大。因为验证是按列应用的，所以我们无法为每个位置指定不同的价格范围。然而，如果我们可以对每组数据应用不同的检查，那将是理想的。这就是我们所说的分区验证<strong class="lq ir">。</strong></p><p id="3202" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这个操作对于赋格来说变得非常琐碎。我们可以稍微修改上面的例子来达到这个目的。在下面的代码片段中，第6行到第12行只是前面验证的两个版本。一个用于FL，一个用于CA。我们在第14行将它们打包成一个字典。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="0b10" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们的<strong class="lq ir"> price_validation </strong>函数也做了一些调整。首先，我们的函数现在是在假设传入的数据帧只包含一个状态(CA或FL)的情况下编写的。我们从第一行的State值中提取位置，从字典中找到适当的验证，并应用它。</p><p id="a21b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">另一个变化是第24行现在在验证之前按照州对数据进行了划分。这基本上意味着Spark数据帧被分割成更小的Pandas数据帧，并且对每个数据帧分别进行操作。<strong class="lq ir"> price_validation </strong>函数为CA数据调用一次，为FL数据调用一次。这种验证是通过Spark执行引擎并行完成的。</p><h1 id="58a6" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="71be" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在这篇博客文章中，我们简要回顾了什么是数据验证。我们将Pandera库视为执行数据验证的一种方式。由于该库只在Pandas中可用，我们使用Fugue将它带到Spark，这是一个抽象层，允许用户将Python和Pandas代码移植到Spark和Dask。使用Fugue，我们可以在每个数据分区上应用Python/Pandas包，这允许我们在这里通过分区执行<strong class="lq ir">验证。</strong></p><p id="bdfa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">神游也可以将其他基于熊猫的库引入Spark。这个例子只是针对数据验证的。有关更多信息，请查看下面的参考资料。</p><h1 id="4d5a" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">资源</h1><p id="7417" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如果你对使用赋格感兴趣，想给我们反馈，或者有任何问题，我们很乐意在Slack上聊天！我们还将为对在数据工作流中应用Fugue感兴趣的数据团队举办更详细的研讨会。</p><p id="690d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><a class="ae kv" href="https://github.com/pandera-dev/pande" rel="noopener ugc nofollow" target="_blank">潘德拉</a></p><h2 id="734d" class="ms kx iq bd ky mt mu dn lc mv mw dp lg lx mx my li mb mz na lk mf nb nc lm nd bi translated">赋格</h2><p id="8600" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><a class="ae kv" href="https://fugue.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">文档</a> <br/> <a class="ae kv" href="https://github.com/fugue-project/fugue" rel="noopener ugc nofollow" target="_blank"> Git回购</a> <br/> <a class="ae kv" href="https://join.slack.com/t/fugue-project/shared_invite/zt-jl0pcahu-KdlSOgi~fP50TZWmNxdWYQ" rel="noopener ugc nofollow" target="_blank">社区闲置</a></p></div></div>    
</body>
</html>