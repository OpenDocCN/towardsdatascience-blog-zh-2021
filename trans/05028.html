<html>
<head>
<title>Dissecting Stockfish Part 2: In-Depth Look at a chess engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">剖析Stockfish第2部分:深入了解象棋引擎</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/dissecting-stockfish-part-2-in-depth-look-at-a-chess-engine-2643cdc35c9a?source=collection_archive---------5-----------------------#2021-05-03">https://towardsdatascience.com/dissecting-stockfish-part-2-in-depth-look-at-a-chess-engine-2643cdc35c9a?source=collection_archive---------5-----------------------#2021-05-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0df5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">当神经网络遇到硬编码知识时</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/899df9ac73a6c8853a29d2e52744717a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CsKzSd5s2D_sO6xfIn1QpA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Stockfish象棋引擎，背景照片由<a class="ae kv" href="https://unsplash.com/@jachymmichal?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> ᴊᴀᴄʜʏᴍ ᴍɪᴄʜᴀʟ </a>在<a class="ae kv" href="https://unsplash.com/s/photos/chess?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="c54a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个系列的第一部分展示了Stockfish如何抽象出一个国际象棋的位置，以及它如何快速找到每一个可能的走法。现在，引擎必须<em class="ls">评估一步棋</em>的质量，以便选择最好的一步。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><p id="90a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">过去，Stockfish只依赖一套固定的规则，这些规则是国际象棋概念的算法翻译:<a class="ae kv" href="https://en.wikipedia.org/wiki/Glossary_of_chess#tempo" rel="noopener ugc nofollow" target="_blank">速度</a>，<a class="ae kv" href="https://en.wikipedia.org/wiki/Glossary_of_chess#material" rel="noopener ugc nofollow" target="_blank">材料</a>，<a class="ae kv" href="https://en.wikipedia.org/wiki/Glossary_of_chess#space" rel="noopener ugc nofollow" target="_blank">空间</a> …但在2018年，神经网络进入了许多国际象棋引擎，Stockfish <a class="ae kv" href="https://www.youtube.com/watch?v=wui0YweevtY" rel="noopener ugc nofollow" target="_blank">的表现优于</a>。为了填补这一空白，Stockfish 12集成了一个神经网络，当已知经典评估的性能较差时，该网络优先于经典评估，通常处于平衡的闭合位置。</p><p id="054f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文将首先关注神经部分的内部工作，然后再研究经典的评估方法。</p><h1 id="fe5d" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">神经网络体系结构</h1><p id="10d4" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">神经评价函数基于俞那苏的NNUE架构(<a class="ae kv" href="https://www.apply.computer-shogi.org/wcsc28/appeal/the_end_of_genesis_T.N.K.evolution_turbo_type_D/nnue.pdf" rel="noopener ugc nofollow" target="_blank">基于高效可更新神经网络的计算机Shogi评价函数，俞那苏，2018 </a>)。这个微小的神经网络在不需要图形处理器的情况下评估CPU上的游戏位置:Stockfish仍然可以很容易地集成到许多设备上，并由它的大量贡献者进行调整。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/e5e17a67f55d26e286864618403c6a30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cO7sTmBgiJcmDl-GHTvEPA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">NNUE的建筑，图片来自<a class="ae kv" href="http://talkchess.com/forum3/viewtopic.php?f=2&amp;t=74059&amp;start=139" rel="noopener ugc nofollow" target="_blank">罗曼朱可夫，Stockfish NN Release (NNUE)，Talkchess </a></p></figure><h2 id="2626" class="my mb iq bd mc mz na dn mg nb nc dp mk lf nd ne mm lj nf ng mo ln nh ni mq nj bi translated">输入编码</h2><p id="c700" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">NNUE不理解位板，必须首先对位置进行编码。NNUE的输入参数表示如下布尔值，对每一个W，X，Y，Z迭代:<br/> <em class="ls">是正方形X上的一个王与正方形Z上的一个W[友|敌]棋子Y？</em></p><p id="a957" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">总共有40，960个参数。用这种二进制编码代替简单的“<em class="ls">棋子X在正方形Y上吗？”</em>编码(768个参数)有几个好处:</p><ul class=""><li id="2804" class="nk nl iq ky b kz la lc ld lf nm lj nn ln no lr np nq nr ns bi translated">在位置改变后更新输入和随后的神经元更快，因为这种编码允许<a class="ae kv" href="https://en.wikipedia.org/wiki/Incremental_computing" rel="noopener ugc nofollow" target="_blank">增量计算</a>，这是NNUE的优势；</li><li id="417c" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated">改变玩家的回合也更快，因为输入只需要翻转；</li><li id="8e67" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated">在编码中提供比所需更多的信息被称为过度专门化，并且允许向网络输入更多的知识以降低其训练成本。</li></ul><h2 id="75d9" class="my mb iq bd mc mz na dn mg nb nc dp mk lf nd ne mm lj nf ng mo ln nh ni mq nj bi translated">隐藏层和训练</h2><p id="72c4" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">该网络的目标是建立一个评价函数，该函数是由非线性分离的不同层的神经元的组合。该评估函数将根据其神经元的权重进行优化(训练阶段),以便在已知国际象棋游戏的情况下输出最准确的评估。</p><p id="05e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">NNUE训练的基本思想是建立一个巨大的随机生成位置的输入数据集，这些位置用经典的Stockfish在较低的深度进行评估。该网络使用该数据集进行训练，然后可以使用特定的位置和评估进行微调。就其本身而言，网络很简单，因为它由3个完全连接的层加上一个输出层组成，输出层可以表示为<a class="ae kv" href="https://en.wikipedia.org/wiki/Chess_piece_relative_value" rel="noopener ugc nofollow" target="_blank">材料分数</a>。</p><p id="8e5b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，NNUE的真正独特之处在于它的输入编码和针对CPU评估优化的增量计算。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/c34aa05e4aabd296101829454e519b9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*W2KvWkerw-T1Cwpp3K84kg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">NNUE:使用SIMD内部函数进行大量优化(nnue/layers/clipped_relu.h)</p></figure><h1 id="1331" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">经典评价</h1><p id="0840" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">除了非常平衡的立场，Stockfish仍然依赖于经典的评估。</p><p id="edc8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个想法是建立一个<em class="ls">评估函数，作为国际象棋概念</em>的组合，由几个加权和相加的标准组成。然后，该函数可以被缩放，以便用标准卒单位表示物质优势。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/c3348bc5c4b9e668b4d334506ed15238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*REppiKnQmNDgG0-nlRF32A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Stockfish中的经典评价，图片来自作者</p></figure><p id="e670" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">概念和相关标准如下:</p><ul class=""><li id="fba6" class="nk nl iq ky b kz la lc ld lf nm lj nn ln no lr np nq nr ns bi translated"><strong class="ky ir">材料不平衡</strong>:每个玩家的棋子数</li><li id="35af" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated"><strong class="ky ir">位置优势</strong>:在特定的方格上有特定的棋子</li><li id="ffc7" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated"><strong class="ky ir">材料优势</strong>:每件的强度，有一双毕肖普</li><li id="cbab" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated"><strong class="ky ir">兵的战略优势</strong>:双倍兵、孤立兵、连接兵、棋子支援兵、攻击兵</li><li id="cedd" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated">其他棋子的战略优势:被阻挡的棋子、在好哨站上的棋子、主教X射线攻击、长对角线上的主教、被困住的棋子、暴露的女王、被渗透的女王、在打开的文件上的车、车和女王炮台、被攻击的敌方国王</li><li id="b59f" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated"><strong class="ky ir">来袭威胁</strong>:攻击棋子、悬挂棋子、国王威胁、兵推威胁、发现/滑块攻击威胁、你的棋子可以移动但可以交换的方格、弱保护棋子</li><li id="cbb2" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated"><strong class="ky ir">走卒</strong>:被阻挡或未被阻挡的走卒</li><li id="ebac" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated">空间:由你所有的棋子控制的方格</li><li id="0d52" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated"><strong class="ky ir">王者安全</strong>:攻击王者，来袭检查，王者在‘棋子避难所’，守军位置</li></ul><p id="49aa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个巨大的结果评估函数实际上被计算到2阶，以基于玩家的已知攻击/防御状态来计算奖励/恶意。</p><p id="3ebd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Stockfish GitHub存储库中的许多pull请求包含上述标准权重的微小变化，这导致了ELO分数的微小提高。</p><h2 id="1ffc" class="my mb iq bd mc mz na dn mg nb nc dp mk lf nd ne mm lj nf ng mo ln nh ni mq nj bi translated">锥形缩放</h2><p id="79a9" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">不管我们是在开局、中局还是残局，不同标准的权重都是不同的。例如，一个被传递的棋子在游戏后期可能比中期更有价值。因此，Stockfish对每个标准都有两个权重集:一个用于中期游戏，一个用于末期游戏。Stockfish然后计算一个范围从0(游戏结束)到128(游戏未开始)的<em class="ls">相位因子</em>，这有助于在两个不同的权重之间进行插值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/0872d7d137e98b8e3dae8c585183c86c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qbqWFckzzWhFNomzxJd9Rg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">中局和残局之间的锥形评估</p></figure><p id="4334" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，评估将再次缩放，以符合<a class="ae kv" href="https://en.wikipedia.org/wiki/Fifty-move_rule" rel="noopener ugc nofollow" target="_blank">五十步规则</a>:当接近达到该规则时，评估将更接近平局。</p><h2 id="4a6b" class="my mb iq bd mc mz na dn mg nb nc dp mk lf nd ne mm lj nf ng mo ln nh ni mq nj bi translated">个案研究</h2><p id="976b" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">为了阐明经典的评估方法，我们将研究卡斯帕罗夫和托帕洛夫之间的一场比赛中的一个已知位置:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/afd04ccdc7a39711436bd0c3281fa8f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:782/format:webp/1*AGfWCnYCGe4zOkqsyg-Tcw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">卡斯帕罗夫-托帕洛夫，Wijk aan Zee，1999年。27:白棋</p></figure><p id="4f30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个例子将集中于位置优势标准:<em class="ls">在特定的方格上有特定的棋子</em>。对于棋盘上的每个方格，分数是根据占据该方格的棋子来分配的(例如，在中局中，a5上暴露的黑王的价值低于g8，G8是更安全的方格)。该分数奖励来自两个硬编码的正方形分数表:一个用于棋子，一个用于棋子。拥有两个不同得分表的原因是棋子的得分奖励在垂直轴上是对称的，而棋子<em class="ls">(</em><a class="ae kv" href="https://github.com/official-stockfish/Stockfish/blob/2046d5da30b2cd505b69bddb40062b0d37b43bc7/src/psqt.cpp" rel="noopener ugc nofollow" target="_blank"><em class="ls">psqt . CPP</em></a><em class="ls">)</em>则不是。</p><pre class="kg kh ki kj gt ob oc od oe aw of bi"><span id="e776" class="my mb iq oc b gy og oh l oi oj">if (typeof(piece) == PAWN) {<br/>   bonus += PBonus[rank][file];<br/>}<br/>else {<br/>   file = file &lt; 4 ? file : 8 - file;<br/>   bonus += Bonus[piece][rank][file];<br/>}</span></pre><p id="49b0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">黑棋和白棋的分数表是一样的，因为只需翻转<a class="ae kv" rel="noopener" target="_blank" href="/dissecting-stockfish-part-1-in-depth-look-at-a-chess-engine-7fddd1d83579">位板</a>就可以计算黑棋的分数。例如，D4上的白皇后在中局中值+8，在残局中值+24(如下所示),这与D5上的黑皇后是一样的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/1b63ee625a7bca2041f36b9a17532a5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NMlf1WCXSuSk2a5AtBaMFQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">棋子方桌奖金—中间游戏</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/ab3ae46ba9c4d0ecd770e6f8da677fdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8dar3f5Pu9eRhMwWrp2ROQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">棋子方桌奖金—结束游戏</p></figure><p id="c2bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">棋子平方得分是棋盘上所有棋子的总和，通过中间游戏和结束游戏的棋子平方得分表计算得出(见上文)。然后，基于棋盘上非棋子材料的数量来计算渐变评估的相位因子。这里，相位因子等于83。最后，使用该阶段因子计算在中间游戏和结束游戏棋子平方分数之间插入的最终奖金。</p><pre class="kg kh ki kj gt ob oc od oe aw of bi"><span id="0f01" class="my mb iq oc b gy og oh l oi oj"># MG: middle-game score<br/># EG: end-game score<br/># P: phase factor</span><span id="eb38" class="my mb iq oc b gy om oh l oi oj">FINAL_BONUS = (MG * P + (EG * (P_MAX - P)) / (P_MAX-P_MIN))</span></pre><p id="0c8d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最终白棋得分为+247，黑棋得分为+46:从Stockfish的角度来看，这个棋盘导致了白棋明显的位置优势。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="d64b" class="ma mb iq bd mc md on mf mg mh oo mj mk jw op jx mm jz oq ka mo kc or kd mq mr bi translated">结论</h1><p id="b854" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">本系列的第一部分介绍了如何读取一个位置，以及如何根据这个位置生成候选移动。现在，第二部分解释了如何评估任何给定的位置，以便为每个玩家输出一个分数。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi os"><img src="../Images/20c1db136b47e2e9f7037c414d12960a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*ibipG2Lr2fxqzAojAo1Knw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">本系列的前两部分解释了Stockfish概念</p></figure><p id="0f22" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，生成候选移动的每一个可能的组合并立即评估它们在性能上是不可思议的:随着我们搜索深度的增加，候选移动的数量呈指数增长。Stockfish需要明智地选择它们，这将是本系列下一部分的主题。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><p id="e96e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">https://antoinechampion.com<a class="ae kv" href="https://antoinechampion.com/" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>