<html>
<head>
<title>Funnel analytics with SQL: MATCH_RECOGNIZE() on Snowflake</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SQL: MATCH_RECOGNIZE()对雪花进行漏斗分析</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/funnel-analytics-with-sql-match-recognize-on-snowflake-8bd576d9b7b1?source=collection_archive---------4-----------------------#2021-03-26">https://towardsdatascience.com/funnel-analytics-with-sql-match-recognize-on-snowflake-8bd576d9b7b1?source=collection_archive---------4-----------------------#2021-03-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2beb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">SQL是一个很棒的工具，但是它不能做所有的事情。例如，找出一种用SQL分析漏斗和会话的方法确实很困难——直到现在。让我们通过用雪花分析一个Google Analytics电子商务漏斗来发现MATCH_RECOGNIZE()的强大之处。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/17a18fd641a46e612bc4e93bd18d82f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MAjUuFLLpv85R1sK.jpg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片:<a class="ae kv" href="https://pixabay.com/photos/architecture-buildings-cars-city-1837176/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="3cb2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当TJ墨菲发现雪花现在支持<code class="fe lu lv lw lx b">MATCH_RECOGNIZE</code>时，看看他的反应:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ly lz l"/></div></figure><h1 id="973c" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">样本用例:带有雪花的谷歌分析电子商务漏斗</h1><h2 id="3d9b" class="ms mb iq bd mc mt mu dn mg mv mw dp mk lf mx my mm lj mz na mo ln nb nc mq nd bi translated"><strong class="ak">你会如何用SQL: </strong>回答这个漏斗问题</h2><blockquote class="ne nf ng"><p id="a8b4" class="kw kx nh ky b kz la jr lb lc ld ju le ni lg lh li nj lk ll lm nk lo lp lq lr ij bi translated">“我们有一个电子商务商店。我们需要识别从任意推荐人(Instagram、脸书等)进入网站并最终购买了某些东西的会话。这些用户买东西经历了多少步，尝试了多少次支付才成功？”</p></blockquote><p id="7f3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用普通的SQL回答这个问题并不容易。但是<code class="fe lu lv lw lx b">MATCH_RECOGNIZE</code>最终给了我们一种优雅的方式来寻找像这样问题的答案。</p><p id="f044" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用<code class="fe lu lv lw lx b">MATCH_RECOGNIZE</code>,我们可以简单地定义我们想要在一系列事件中找到的步骤，然后我们可以为这些步骤定义任何模式——然后<code class="fe lu lv lw lx b">MATCH_RECOGNIZE</code>完成剩下的工作。</p><p id="e8d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个例子中，我们将使用来自电子商务商店的Google Analytics 360数据集。没有什么比真实数据更能证明我们工具的威力了。</p><h2 id="4198" class="ms mb iq bd mc mt mu dn mg mv mw dp mk lf mx my mm lj mz na mo ln nb nc mq nd bi translated">步骤1:将谷歌分析数据加载到雪花中</h2><p id="34d0" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">将数据从BigQuery取出放入Snowflake很容易。您可能需要工具来构建可靠的管道，但基本步骤很简单:</p><ul class=""><li id="4f18" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr nv nw nx ny bi translated">从BigQuery导出到GCS:您可以使用自己的GA数据，或者一个包含来自Google商品商店的数据的<a class="ae kv" href="https://support.google.com/analytics/answer/7586738?hl=en" rel="noopener ugc nofollow" target="_blank">样本数据集</a>。</li><li id="2cfa" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated"><a class="ae kv" href="https://stackoverflow.com/a/64168195/132438" rel="noopener ugc nofollow" target="_blank">将GA数据加载到雪花中</a>:这很简单。雪花会很乐意从GCS摄取文件，即使你的雪花账户住在AWS。加载JSON也像变魔术一样。您可能希望设置身份验证和权限以获得最大的安全性，而对于示例数据，我只使用了一个public bucket。</li></ul><pre class="kg kh ki kj gt oe lx of og aw oh bi"><span id="71c0" class="ms mb iq lx b gy oi oj l ok ol">create or replace table ga_demo2(src variant);</span><span id="a035" class="ms mb iq lx b gy om oj l ok ol">copy into ga_demo2<br/>from 'gcs://fhoffa/ga360/ga_sessions000000000000'<br/>file_format=(type='JSON');</span></pre><ul class=""><li id="30b8" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr nv nw nx ny bi translated">雪花中的查询:注意上面我们将JSON行加载到了一个<code class="fe lu lv lw lx b">variant</code>类型中。雪花使处理半结构化数据成为一种乐趣；你可以很容易地浏览谷歌分析模式。我们还可以在基本查询之外创建一个视图，以便更容易地执行以下所有步骤:</li></ul><pre class="kg kh ki kj gt oe lx of og aw oh bi"><span id="a701" class="ms mb iq lx b gy oi oj l ok ol">create or replace view ga360_parsed<br/>as<br/>select src:visitStartTime::timestamp ts<br/>    , hit.value:hitNumber::int hit<br/>    , src:visitId::string visit<br/>    , hit.value:eCommerceAction.action_type::int action_t<br/>    , hit.value:eCommerceAction.step::int action_s<br/>    , hit.value:eCommerceAction.option::string action_o<br/>    , hit.value:page.pagePath::string path<br/>    , hit.value:referer::string referer<br/>    , src:fullVisitorId::string visitor<br/>    , src:totals.transactions::int total_transactions<br/>from ga_demo2, lateral flatten(input =&gt; src:hits) hit</span></pre><h2 id="b69e" class="ms mb iq bd mc mt mu dn mg mv mw dp mk lf mx my mm lj mz na mo ln nb nc mq nd bi translated">第二步:查询漏斗很有趣</h2><p id="fb9c" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">这个“简单明了”的查询回答了我们想要回答的问题:</p><pre class="kg kh ki kj gt oe lx of og aw oh bi"><span id="66e5" class="ms mb iq lx b gy oi oj l ok ol">select count(*) visits<br/>  , avg(steps) avg_steps<br/>  , avg(payment_attempts) avg_pay_attempts<br/>  , max(payment_attempts) max_pay_attempts<br/>from ga360_parsed<br/>match_recognize(<br/>    partition by visit<br/>    order by hit<br/>    measures count(*) steps, count(payment.*) payment_attempts<br/>    one row per match<br/>    pattern(from_plex (payment | anything)*  completed)<br/>    define<br/>        from_plex as referer = '<a class="ae kv" href="https://mall.googleplex.com/'" rel="noopener ugc nofollow" target="_blank">https://mall.googleplex.com/'</a><br/>        , completed as path like '/ordercompleted.html'<br/>        , payment as action_o = 'Payment'<br/>);</span></pre><p id="f4ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果有21次访问是从那个特定的推荐人登陆到我们的网站，并最终购买了一些东西。平均来说，他们要走35.6步，尝试支付1.7次——至少有一个会话在成功前尝试支付9次。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi on"><img src="../Images/9648b6e3b21ef1dffef05d9ac0d24766.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*PMkINOqoHFWTNMo0VukFdQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">漏斗问题的结果</p></figure><h1 id="0c05" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">了解匹配识别</h1><p id="d1db" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">你可以跟随<a class="ae kv" href="https://docs.snowflake.com/en/user-guide/match-recognize-introduction.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>去发现<code class="fe lu lv lw lx b">MATCH_RECOGNIZE</code>的所有能力——这里我们将看看上面查询的基础。</p><h2 id="84bd" class="ms mb iq bd mc mt mu dn mg mv mw dp mk lf mx my mm lj mz na mo ln nb nc mq nd bi translated">规定</h2><p id="8763" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">让我们从<code class="fe lu lv lw lx b">define</code>部分开始，它用于定义用户漏斗中的步骤:</p><pre class="kg kh ki kj gt oe lx of og aw oh bi"><span id="9c21" class="ms mb iq lx b gy oi oj l ok ol">define<br/>        from_plex as referer = '<a class="ae kv" href="https://mall.googleplex.com/'" rel="noopener ugc nofollow" target="_blank">https://mall.googleplex.com/'</a><br/>        , completed as path like '/ordercompleted.html'<br/>        , payment as action_o = 'Payment</span></pre><p id="63f4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以看到我们给每一步取了一个任意的名字，条件可以是你想要的任何条件。我们的一个步骤查看<code class="fe lu lv lw lx b">referer</code>，另一个步骤查看用户登陆特定的<code class="fe lu lv lw lx b">path</code>，支付步骤由Google Analytics存储的<code class="fe lu lv lw lx b">action</code>变量标识。</p><h2 id="6c31" class="ms mb iq bd mc mt mu dn mg mv mw dp mk lf mx my mm lj mz na mo ln nb nc mq nd bi translated">模式</h2><p id="ef2a" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated"><code class="fe lu lv lw lx b">pattern</code>部分基本上是漏斗步骤的正则表达式:</p><pre class="kg kh ki kj gt oe lx of og aw oh bi"><span id="4fd3" class="ms mb iq lx b gy oi oj l ok ol">pattern(from_plex (payment | anything)*  completed)</span></pre><p id="0f2c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这表示"<em class="nh">查找以</em> <code class="fe lu lv lw lx b"><em class="nh">from_plex</em></code> <em class="nh">步骤开始的会话，随后是任意数量的</em> <code class="fe lu lv lw lx b"><em class="nh">payment</em></code> <em class="nh">或</em> <code class="fe lu lv lw lx b"><em class="nh">anything</em></code> <em class="nh">步骤，并以</em> <code class="fe lu lv lw lx b"><em class="nh">completed</em></code> <em class="nh">状态结束。</em></p><h2 id="b027" class="ms mb iq bd mc mt mu dn mg mv mw dp mk lf mx my mm lj mz na mo ln nb nc mq nd bi translated">匹配_识别</h2><p id="eed0" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">随着<code class="fe lu lv lw lx b">define</code>和<code class="fe lu lv lw lx b">pattern</code>的建立，我们可以进行一个基本的<code class="fe lu lv lw lx b">match_recognize</code>查询:</p><pre class="kg kh ki kj gt oe lx of og aw oh bi"><span id="e4c8" class="ms mb iq lx b gy oi oj l ok ol">select classified_as, hit, visit, action_o, referer ref, path<br/>from ga360_parsed<br/>match_recognize(<br/>    partition by visit<br/>    order by hit<br/>    measures classifier() as classified_as<br/>    all rows per match<br/>    pattern(from_plex (payment | anything)*  completed)<br/>    define<br/>        from_plex as referer = '<a class="ae kv" href="https://mall.googleplex.com/'" rel="noopener ugc nofollow" target="_blank">https://mall.googleplex.com/'</a><br/>        , completed as path like '/ordercompleted.html'<br/>        , payment as action_o = 'Payment'<br/>);</span></pre><p id="555a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们向该查询添加了3个构造。首先，如何拆分和排序我们的会话:<code class="fe lu lv lw lx b">partition by visit order by hit</code>。然后添加一列，显示每行在我们的漏斗中是如何分类的:<code class="fe lu lv lw lx b">measures classifier()</code>。然后我们希望看到每个漏斗的所有行，而不仅仅是一行摘要:<code class="fe lu lv lw lx b">all rows per match</code>。这使我们可以看到以下结果，其中突出显示了分类为“付款”的步骤:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/24835720b3d505395995b0a27f34a044.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TYqDcTo8RA3tmBFluXexJg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">显示每个匹配的所有行</p></figure><h2 id="3149" class="ms mb iq bd mc mt mu dn mg mv mw dp mk lf mx my mm lj mz na mo ln nb nc mq nd bi translated">回答漏斗问题</h2><p id="d33d" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">确定每个漏斗步骤后，我们就可以回答开头的问题了。我们可以不选择所有的行，而是要求每个漏斗有一个摘要:<code class="fe lu lv lw lx b">one row per match</code>。我们添加我们感兴趣的度量:<code class="fe lu lv lw lx b">measures count(*) steps, count(payment.*) payment_attempts</code>。<code class="fe lu lv lw lx b">MATCH_RECOGNIZE</code>完成剩下的工作，我们可以回到我们通常的SQL方式来获得计数、平均值和其他指标。</p><h1 id="6756" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">后续步骤</h1><p id="fd67" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">漏斗分析只是一个例子。想想工具箱里有<code class="fe lu lv lw lx b">MATCH_RECOGNIZE</code>的所有可能性:威胁检测、在天气和股票价格趋势线中寻找趋势，等等。</p><p id="7373" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们在未来的帖子中探讨这些话题，并分享您的最佳想法和结果。</p><h1 id="e173" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">阅读更多</h1><ul class=""><li id="8ef6" class="nq nr iq ky b kz nl lc nm lf op lj oq ln or lr nv nw nx ny bi translated">官方雪花<code class="fe lu lv lw lx b">MATCH_RECOGNIZE()</code>T5】文档。</li></ul><h1 id="961b" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">想要更多吗？</h1><p id="2377" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">我是Felipe Hoffa，雪花的数据云倡导者。谢谢你和我一起冒险。你可以<a class="ae kv" href="https://twitter.com/felipehoffa" rel="noopener ugc nofollow" target="_blank">在Twitter </a>上关注我，并查看<a class="ae kv" href="https://www.reddit.com/r/snowflake/" rel="noopener ugc nofollow" target="_blank">reddit.com/r/snowflake</a>最有趣的雪花新闻。</p><div class="os ot gp gr ou ov"><a href="https://github.com/Snowflake-Labs/awesome-snowflake" rel="noopener  ugc nofollow" target="_blank"><div class="ow ab fo"><div class="ox ab oy cl cj oz"><h2 class="bd ir gy z fp pa fr fs pb fu fw ip bi translated">雪花实验室/棒极了雪花</h2><div class="pc l"><h3 class="bd b gy z fp pa fr fs pb fu fw dk translated">关于雪花社区和内容的主要链接的令人敬畏的资源的策划列表，记得订阅:活动…</h3></div><div class="pd l"><p class="bd b dl z fp pa fr fs pb fu fw dk translated">github.com</p></div></div><div class="pe l"><div class="pf l pg ph pi pe pj kp ov"/></div></div></a></div></div></div>    
</body>
</html>