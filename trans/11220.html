<html>
<head>
<title>How To Manage Configurations Like a Boss</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何像老板一样管理配置</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-manage-configurations-like-a-boss-34e224f3bb4?source=collection_archive---------4-----------------------#2021-11-03">https://towardsdatascience.com/how-to-manage-configurations-like-a-boss-34e224f3bb4?source=collection_archive---------4-----------------------#2021-11-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6d1d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 Pydantic BaseSettings，你的生活会变得更容易</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/62d5407fb20457c15755e35436a90854.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a9ULD4qbr5WVopWu"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">费伦茨·阿尔马西在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="6890" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="66e1" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">每当您编写应用程序、算法或数据管道时，您很可能会有几个因环境或部署而异的变量。例如，与生产环境中的目标数据库相比，您在本地测试时连接到的数据库肯定是不同的。因此，数据库的名称或地址将是一个配置变量。</p><p id="07bd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">管理这样的配置变量至关重要；您肯定不希望在本地测试时意外地将垃圾写入生产数据库。为了获得良好的开发体验，添加和设置配置变量也应该是容易和轻松的。</p><p id="8283" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">尽管配置管理非常重要，但它并不被认为很有吸引力。在这篇文章中，我想改变这一点！具体地说，我想向您展示我认为在现代 Python 中管理配置的最性感的方式。你准备好了吗？我们开始吧！</p><h1 id="8c9c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">问题是</h1><p id="4e88" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">正如在引言中已经提到的，每当你写一个更大的软件时，在某个时候，你将不得不管理配置变量。我所说的配置变量指的是不同环境之间的变量，或者可以决定应用程序行为的变量。典型的例子有数据库地址、日志级别、并发线程的最大数量或 API 令牌等等。</p><p id="fb1b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要设置这些变量，您有几个选项。三种最常见的是</p><ul class=""><li id="8ded" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated"><em class="nb">将它们作为常量存储在代码</em>中。在这种情况下，您的优势在于，在运行您的应用程序或测试时，您不需要做任何事情，因为一切都是预先配置好的。最大的缺点是，当你把你的应用程序部署到不同的环境中时，它是非常不灵活和不适用的。实际上，这样做被认为是一种反模式，因为代码和配置是紧密耦合的。</li><li id="dbb9" class="ms mt it lt b lu nc lx nd ma ne me nf mi ng mm mx my mz na bi translated"><em class="nb">将它们存储在配置文件中。</em>这里，您必须在应用程序启动时加载一个文件，并将值赋给各个变量。这种方法很灵活，因为不同的环境可以有不同的文件。不利的一面是，它可能需要大量样板代码来很好地设置一切。此外，当涉及到测试时，保留虚拟配置文件来设置您的测试可能会很烦人。</li><li id="c0f6" class="ms mt it lt b lu nc lx nd ma ne me nf mi ng mm mx my mz na bi translated"><em class="nb">存储在环境变量</em>中。这里，您必须单独加载每个环境变量，并将加载的值分配给相应的代码变量。利弊与使用配置文件的描述相似。不过，使用环境变量可能会更灵活一些，但需要编写更多的代码。</li></ul><p id="4db2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如你所见，这三种选择都有利弊。问题是现在；我们能否利用它们的优点，同时避免或减轻它们的缺点？幸运的是，答案是</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/7a1b3ad80bb7af51fea7d0b7ca6b51f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ezuG-5C8rVnlFp1A"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">布雷特·乔丹在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="8e4b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">解决方案</h1><p id="0b8c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">当您使用伟大的<a class="ae ky" href="https://pydantic-docs.helpmanual.io/" rel="noopener ugc nofollow" target="_blank"> Pydantic 库</a>时，在 Python 中管理配置就像是轻而易举的事情。Pydantic 附带了一个名为<a class="ae ky" href="https://pydantic-docs.helpmanual.io/usage/settings/" rel="noopener ugc nofollow" target="_blank"> BaseSettings </a>的类，它允许您创建定义明确、有类型提示的应用程序配置类。除了给你的配置一个清晰的结构和定义良好的接口，这个类<em class="nb">自动从环境变量和配置文件</em>中读取值。因此，加载您的配置不需要编写任何额外的代码。听起来是不是很棒？</p><p id="810b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最后，当您将配置定义为标准 Python 类时，您可以为变量分配合理的默认值。这意味着您不必在每个环境中显式地设置每个变量，但是如果您希望或者将来必须这样做，您可以做好准备。</p><h2 id="aaf9" class="ni la it bd lb nj nk dn lf nl nm dp lj ma nn no ll me np nq ln mi nr ns lp nt bi translated">基本示例</h2><p id="799f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一小段话包含了很多信息。因此，让我们喘口气，看看一些示例代码，以进一步加深我们的理解</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="17ca" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我在这里做了什么？首先，我创建了一个继承自<code class="fe nw nx ny nz b">BaseSettings</code>的配置类<code class="fe nw nx ny nz b">MediumConfig</code>。这个类有三个配置变量<code class="fe nw nx ny nz b">tier, log_level,</code>和<code class="fe nw nx ny nz b">user</code>，它们都是字符串。Tier 和 log_level 分配了默认值，而用户变量必须显式设置。设置值最直接的方法是创建一个类的实例，如<code class="fe nw nx ny nz b">cfg = MediumConfig(user="hans.maulwurf", tier="stg")</code>。到目前为止，没有什么非常壮观的，只是普通的 Python。</p><p id="113e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然而，真正方便的是使用环境变量设置变量的第二个选项。对于给定的示例，您可以通过设置与带有前缀<code class="fe nw nx ny nz b">medium_</code>的<code class="fe nw nx ny nz b">MediumConfig</code>类中的环境变量同名的环境变量来实现，即<code class="fe nw nx ny nz b">medium_tier</code>和<code class="fe nw nx ny nz b">medium_log_level</code>。需要前缀，因为子类<code class="fe nw nx ny nz b">Config</code>中的<code class="fe nw nx ny nz b">env_prefix</code>变量被设置为前缀。如果你不想要那个，你可以不要它。一般来说，建议为 env 变量使用前缀，因为它允许您将特定于应用程序的变量与其他变量区分开来。</p><p id="b609" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是，可能有一些环境变量的名称您无法显式控制，也就是说，您不能只在它们的名称前添加前缀。尽管如此，您仍然希望能够自动加载这些变量。在这种情况下，您可以使用<code class="fe nw nx ny nz b">Field</code>类。在这里，将 Field 的一个实例分配给一个变量，并将其 env 参数设置为相应的环境变量名。您可以从取自<code class="fe nw nx ny nz b">user_name</code>环境变量的<code class="fe nw nx ny nz b">user</code>变量中看到这一点。注意，这里使用的前缀是<em class="nb">而不是</em>。</p><p id="7e54" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最后，您从示例中看到，您可以混合和匹配指定变量值的方式。如果一个变量以多种方式被指定，例如，一个值被传递给类初始化器并且相应的环境变量被设置，传递给类初始化器的值优先或者具有更高的优先级。这种优先顺序可以改变，甚至扩展。让我们在下一节看看如何做到这一点。</p><h2 id="ef99" class="ni la it bd lb nj nk dn lf nl nm dp lj ma nn no ll me np nq ln mi nr ns lp nt bi translated">高级示例</h2><p id="27a4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">到目前为止，我们已经看到了如何在代码中或者使用环境变量显式地设置我们的配置变量。我们还没有介绍的是如何使用配置文件做到这一点。为了了解它是如何工作的，让我们来看一些代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="9639" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这里发生了什么？我有</p><ul class=""><li id="2575" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated">增加了从 YAML 文件加载配置变量的可能性，</li><li id="8be7" class="ms mt it lt b lu nc lx nd ma ne me nf mi ng mm mx my mz na bi translated">更改了优先级顺序，使配置文件优先于环境变量，</li><li id="98b7" class="ms mt it lt b lu nc lx nd ma ne me nf mi ng mm mx my mz na bi translated">去掉了一种设置变量的方法，我在这里还没有讲到。</li></ul><p id="c7f0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我是怎么做到的？只需从 Config 子类实现和扩展<code class="fe nw nx ny nz b">customise_sources</code> classmethod。这个方法必须返回一个可调用元组，每个可调用元组实现一种加载配置变量的可能方式。从该函数返回可调用内容的顺序决定了从不同来源加载时的优先级。</p><p id="b72c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">具体地说，为了加载 YAML 配置文件，我实现了<code class="fe nw nx ny nz b">yml_config_setting</code>函数。该函数加载名为 config.yml 的 YAML 文件，并将其反序列化到 Python 字典中。为了在 config 类中使用这个函数，我将它添加为<code class="fe nw nx ny nz b">customise_sources</code>函数的返回值之一。为了给 YAML 配置文件比使用环境变量更高的优先级，我在返回值集合中把<code class="fe nw nx ny nz b">yml_config_setting</code>放在了<code class="fe nw nx ny nz b">env_settings</code> callable 之前。完成了。对我来说，这再简单不过了。</p><p id="ca41" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最后一点，加载配置变量不仅限于加载 YAML 文件。您可以将任何可以反序列化数据的东西添加到字典中。您甚至可以考虑添加一个函数，从 AWS SSM 这样的云参数存储中加载您的配置，但这超出了本文的范围。我相信你可以自己解决这个问题:)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/21b5fdacd918a4eba7163a23ea610c41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IrB8uSMQm31zqYGm"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@etiennegirardet?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">艾蒂安·吉拉尔代</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><h1 id="2baa" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">包裹</h1><p id="4a45" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本文中，我向您展示了如何使用 Pydantic 和 BaseSettings 类来定义和管理应用程序配置。使用这种开箱即用的方法，不仅可以为您的配置提供一个定义更好、更清晰的界面，还需要您编写和维护更少的代码。此外，我还向您展示了一种超级简单灵活的方法，如何扩展 BaseSettings 实现，使其能够处理其他源，如配置文件。有了这个，你应该配备一个工具集，让你像老板一样管理你的配置。对我来说，所有的一切都很性感，不是吗:-)</p><p id="9a70" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">感谢你关注这篇文章，我希望你喜欢它，并学到一些新东西。一如既往，欢迎随时联系 LinkedIn 或关注我，并在下面留下评论。</p></div></div>    
</body>
</html>