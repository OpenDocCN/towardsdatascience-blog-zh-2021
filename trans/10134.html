<html>
<head>
<title>BigQuery: 3 simple ways to Audit and Monitor your Database.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery:审计和监控数据库的3种简单方法。</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/bigquery-3-simple-ways-to-audit-and-monitor-your-dabatase-1cf09027f0de?source=collection_archive---------5-----------------------#2021-09-25">https://towardsdatascience.com/bigquery-3-simple-ways-to-audit-and-monitor-your-dabatase-1cf09027f0de?source=collection_archive---------5-----------------------#2021-09-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="34f4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何审计和监控您的BigQuery数据库，以保持其整洁和高效。</h2></div><p id="1f62" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Google BigQuery是一个可管理的、高度可伸缩的、无服务器的数据仓库，能够在几秒钟内查询万亿字节的数据。这是一个很棒的工具，数据分析师和科学家很容易使用。因为GCP使它完全被管理，你不必过多考虑数据库管理。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/26b04e6430a95fdfcda0091bf0676628.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ehyIvpFsBJAmSivycQk2w.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated"><a class="ae lu" href="https://unsplash.com/@sadswim" rel="noopener ugc nofollow" target="_blank"> @sadswim </a>在<a class="ae lu" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="96f4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">多年来，我一直在使用老式的企业级数据库(Oracle，SAP / Sybase，..).我们需要团队中的<strong class="kk iu">数据库管理员</strong>，<strong class="kk iu">来管理数据库“健康”</strong>。</p><p id="bb6d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是当谈到主要由数据分析师和数据科学家使用的完全托管的BigQuery数据库时，没有人接管这个角色是一个典型的陷阱。</p><p id="ca66" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，这里有5种简单的方法可以立即开始监控您的BigQuery DB！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1266" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">方法1:元数据</h1><blockquote class="mu mv mw"><p id="7b27" class="ki kj mx kk b kl km ju kn ko kp jx kq my ks kt ku mz kw kx ky na la lb lc ld im bi translated">元数据是提供关于其他数据的信息的数据。<br/> —维基百科</p></blockquote><p id="1b51" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于关系数据库，元数据提供关于数据库本身的信息:模式、表、列或任何其他关于数据库元素和用法的信息。</p><p id="11ff" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">GCP和BigQuery提供了一些通过元数据监控数据库的便捷方法。</p><blockquote class="mu mv mw"><p id="f73c" class="ki kj mx kk b kl km ju kn ko kp jx kq my ks kt ku mz kw kx ky na la lb lc ld im bi translated">我不会详细讨论BigQuery的元数据，因为你可以参考Skye Tran的这篇文章。但是让我们有一个概述。</p></blockquote><h2 id="4599" class="nb md it bd me nc nd dn mi ne nf dp mm kr ng nh mo kv ni nj mq kz nk nl ms nm bi translated">A.<strong class="ak"> <em class="nn">信息_模式</em> </strong></h2><p id="7fac" class="pw-post-body-paragraph ki kj it kk b kl no ju kn ko np jx kq kr nq kt ku kv nr kx ky kz ns lb lc ld im bi translated"><a class="ae lu" href="https://cloud.google.com/bigquery/docs/information-schema-intro" rel="noopener ugc nofollow" target="_blank"> INFORMATION_SCHEMA </a>是一系列视图，提供关于表、视图、数据集等等的信息。你可以访问<code class="fe nt nu nv nw b">INFORMATION_SCHEMA.TABLES</code>、<code class="fe nt nu nv nw b">INFORMATION_SCHEMA.VIEWS</code>、<code class="fe nt nu nv nw b">INFORMATION_SCHEMA.COLUMNS</code>等几个。</p><p id="29b4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">示例:深入了解模式中的表</strong></p><pre class="lf lg lh li gt nx nw ny nz aw oa bi"><span id="5847" class="nb md it nw b gy ob oc l od oe">-- Returns metadata for tables in a single dataset.</span><span id="5d2e" class="nb md it nw b gy of oc l od oe">SELECT * FROM `bigquery-public-data.census_bureau_international`.INFORMATION_SCHEMA.TABLES;</span></pre><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi og"><img src="../Images/f209f94577fbdbc95b0f08d35c801dff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BIvVVZbsWUUWGyJpFqe2HQ.png"/></div></div></figure><p id="5291" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">示例:显示按创建日期排序的数据集</strong></p><pre class="lf lg lh li gt nx nw ny nz aw oa bi"><span id="7784" class="nb md it nw b gy ob oc l od oe">SELECT * FROM myProject.INFORMATION_SCHEMA.SCHEMATA<br/>ORDER BY creation_time;</span></pre><p id="75bc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">b . _ _表__ </strong></p><p id="83b7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每个数据集都有自己的隐藏元数据表，名为<strong class="kk iu"> __TABLES__ </strong>。那个很有用！这是获取类似“<em class="mx">您的表最后一次更新是什么时候？”</em>或<em class="mx">“你们的桌子有多大？”</em>。</p><p id="c8fb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">示例:数据集的表最后一次更新是什么时候？</strong></p><pre class="lf lg lh li gt nx nw ny nz aw oa bi"><span id="8d15" class="nb md it nw b gy ob oc l od oe">SELECT<br/>  table_id,</span><span id="c0c7" class="nb md it nw b gy of oc l od oe">  # creation_time and last_modified_time to a timestamp <br/>  TIMESTAMP_MILLIS(creation_time) AS creation_time,<br/>  TIMESTAMP_MILLIS(last_modified_time) AS last_modified_time,</span><span id="90bd" class="nb md it nw b gy of oc l od oe">  row_count,</span><span id="af3e" class="nb md it nw b gy of oc l od oe"># convert size in MB<br/>  ROUND(size_bytes/(1024*1024),2) as size_mb,</span><span id="7675" class="nb md it nw b gy of oc l od oe"># Convert type from numerical to description <br/>  CASE <br/>   WHEN type = 1 THEN 'table' <br/>   WHEN type = 2 THEN 'view' <br/>  ELSE NULL <br/>  END AS type <br/>  <br/>FROM `bigquery-public-data.census_bureau_international`.__TABLES__ <br/>ORDER BY last_modified_time ASC</span></pre><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oh"><img src="../Images/84c802f0d54387e8955371df3463dc72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3JZ8snjKdXbObe842SQA7Q.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">一种非常方便的分析数据集的方法</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="40a0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">方法2:将Google Cloud日志导出到BigQuery</h1><p id="01cc" class="pw-post-body-paragraph ki kj it kk b kl no ju kn ko np jx kq kr nq kt ku kv nr kx ky kz ns lb lc ld im bi translated">现在，您希望对数据库中发生的事情有更多的控制:<em class="mx">您的表最后一次被访问是什么时候？一个用户“花费”多少？哪些桌子使用量最大？</em></p><p id="f5da" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">即使无法通过BigQuery的元数据获得信息，您也可以通过将<strong class="kk iu">云日志导出到BigQuery来回答这些问题。</strong></p><h2 id="1be0" class="nb md it bd me nc nd dn mi ne nf dp mm kr ng nh mo kv ni nj mq kz nk nl ms nm bi translated">A.如何将日志从云日志导出到Bigquery？</h2><p id="c8a1" class="pw-post-body-paragraph ki kj it kk b kl no ju kn ko np jx kq kr nq kt ku kv nr kx ky kz ns lb lc ld im bi translated"><strong class="kk iu">步骤1:创建一个新的BigQuery数据集来存储日志</strong></p><p id="bd64" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于您希望在BigQuery中接收日志并使用SQL对其进行分析，因此最好通过创建新的数据集来组织数据库。选择一个方便的名称，如<strong class="kk iu"> <em class="mx">日志</em> </strong>或<strong class="kk iu"> <em class="mx">监控</em> </strong>。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oi"><img src="../Images/8229493127b74bcf09561a6bf5d2bad6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4f9hN6gCE6uFhjjHFIYTeA.png"/></div></div></figure><p id="5968" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">第二步:创建云日志接收器</strong></p><p id="c06c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">接收器</strong>允许您将日志或日志的过滤子集路由到选定的目的地。你可以使用<a class="ae lu" href="https://cloud.google.com/bigquery/docs/reference/auditlogs#stackdriver_logging_exports" rel="noopener ugc nofollow" target="_blank"> gcloud CLI </a>或谷歌云的用户界面来创建它。让我们使用第二种方法。注意:接收器不会用创建前的事件进行回填。</p><p id="be93" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">进入谷歌<strong class="kk iu">云日志</strong>，选择<strong class="kk iu">日志路由器</strong>。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi oj"><img src="../Images/96f36f8fe0b0117028a37a8a83447c2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dTdO78GoGBz91U9VfpsvCw.png"/></div></div></figure><p id="70f0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">点击<strong class="kk iu">创建水槽。</strong>给它起个名字。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ok"><img src="../Images/5bc649250e9cc6f0f57a199e4fb84fe7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0jdsWHJeo1dizYZEGdLqPQ.png"/></div></div></figure><p id="838a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择<strong class="kk iu">大查询数据集</strong>作为目的地，并使用您新创建的数据集。我建议选中“使用分区表”选项:我可能会提高性能，并使您的数据集更具可读性。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ol"><img src="../Images/943c6a2eb8451c7972c475b1f86b59cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yBb4IZrVCq2e0orCaTsbOw.png"/></div></div></figure><p id="981d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，您可能希望<strong class="kk iu">使用一个过滤器</strong>来只包含相关的日志。<br/>要导出核心BigQuery操作的所有记录，请使用过滤器:<br/> <code class="fe nt nu nv nw b">protoPayload.metadata."@type"="type.googleapis.com/google.cloud.audit.BigQueryAuditMetadata"</code></p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi ol"><img src="../Images/5d466603b18903d406e9ce62aeca5b71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*keUhpXQLalBkRmrX4NnJqg.png"/></div></div></figure><p id="9bee" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">第三步:从BigQuery </strong>查询您的日志</p><p id="7f63" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">很快，您的日志就会流入数据集，形成3个表:</p><ul class=""><li id="5675" class="om on it kk b kl km ko kp kr oo kv op kz oq ld or os ot ou bi translated">cloud audit _ Google API _ com _ data _ access</li><li id="0d92" class="om on it kk b kl ov ko ow kr ox kv oy kz oz ld or os ot ou bi translated">cloud audit _ Google API _ com _ activity</li><li id="c507" class="om on it kk b kl ov ko ow kr ox kv oy kz oz ld or os ot ou bi translated">cloud audit _ Google API _ com _ system _ event</li></ul><p id="f33d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe nt nu nv nw b">cloudaudit_googleapis_com_data_access</code>是迄今为止监控数据库最有用的表。让我们开始吧！</p><h2 id="e0ed" class="nb md it bd me nc nd dn mi ne nf dp mm kr ng nh mo kv ni nj mq kz nk nl ms nm bi translated">B.如何通过cloud audit _ Google APIs _ com _ data _ access进行审计？</h2><p id="ceb2" class="pw-post-body-paragraph ki kj it kk b kl no ju kn ko np jx kq kr nq kt ku kv nr kx ky kz ns lb lc ld im bi translated">分析访问可能会有很大帮助。现在我们已经在<code class="fe nt nu nv nw b">cloudaudit_googleapis_com_data_access</code>中获得了“访问历史”日志，让我们运行一些查询吧！</p><p id="4c4f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">例子:你的表最后一次被访问是什么时候？</strong></p><pre class="lf lg lh li gt nx nw ny nz aw oa bi"><span id="bb66" class="nb md it nw b gy ob oc l od oe">SELECT</span><span id="0118" class="nb md it nw b gy of oc l od oe"># Dataset name<br/>REGEXP_EXTRACT(protopayload_auditlog.resourceName,   '^projects/[^/]+/datasets/([^/]+)/tables') AS dataset,</span><span id="a633" class="nb md it nw b gy of oc l od oe"># Table name<br/>SPLIT(REGEXP_EXTRACT(protopayload_auditlog.resourceName, '^projects/[^/]+/datasets/[^/]+/tables/(.*)$'), '$')[OFFSET(0)] AS table,</span><span id="f983" class="nb md it nw b gy of oc l od oe"># Last access date<br/>MAX(timestamp) as last_accessed_at,</span><span id="f2d9" class="nb md it nw b gy of oc l od oe"># Was it a Read or Write operation ?<br/>CASE WHEN JSON_EXTRACT(protopayload_auditlog.metadataJson, "$.tableDataRead") IS NOT NULL THEN 'Read'<br/>     WHEN JSON_EXTRACT(protopayload_auditlog.metadataJson, "$.tableDataChange") IS NOT NULL THEN 'Change'<br/>END method,</span><span id="28fb" class="nb md it nw b gy of oc l od oe"># Optionally: display the user who executed the operation<br/>#protopayload_auditlog.authenticationInfo.principalEmail</span><span id="8f08" class="nb md it nw b gy of oc l od oe">FROM logs.cloudaudit_googleapis_com_data_access</span><span id="36d4" class="nb md it nw b gy of oc l od oe">WHERE<br/>  JSON_EXTRACT(protopayload_auditlog.metadataJson, "$.tableDataRead") IS NOT NULL<br/>  OR JSON_EXTRACT(protopayload_auditlog.metadataJson, "$.tableDataChange") IS NOT NULL</span><span id="85d6" class="nb md it nw b gy of oc l od oe">GROUP BY dataset, table, method</span><span id="e113" class="nb md it nw b gy of oc l od oe"># Optionally: Select a specific dataset<br/>#HAVING dataset = 'public'</span><span id="bedf" class="nb md it nw b gy of oc l od oe">ORDER BY last_accessed_at desc</span></pre><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi pa"><img src="../Images/13cfe9f6f9155385f5c6fb16770eda88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3rHMot2AePWiL-96FRFqew.png"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">上次访问的表</p></figure><p id="dc6c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">示例:您的数据库每天/每小时/每月的成本是多少？<br/> </strong>这个方便的要求直接来自于<a class="ae lu" href="https://cloud.google.com/bigquery/docs/reference/auditlogs/migration#example_hourly_cost_breakdown" rel="noopener ugc nofollow" target="_blank">的文档</a>。</p><pre class="lf lg lh li gt nx nw ny nz aw oa bi"><span id="4f11" class="nb md it nw b gy ob oc l od oe">SELECT</span><span id="2579" class="nb md it nw b gy of oc l od oe"># Adapt the period of time according to your needs<br/>TIMESTAMP_TRUNC(TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, "$.jobChange.job.jobStats.endTime")), DAY) AS period,</span><span id="1365" class="nb md it nw b gy of oc l od oe">FORMAT('%9.2f',5.0 * (SUM(CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, "$.jobChange.job.jobStats.queryStats.totalBilledBytes") AS INT64))/POWER(2, 40))) AS Estimated_USD_Cost</span><span id="c273" class="nb md it nw b gy of oc l od oe">FROM logs.cloudaudit_googleapis_com_data_access</span><span id="b5f7" class="nb md it nw b gy of oc l od oe">WHERE</span><span id="20a1" class="nb md it nw b gy of oc l od oe">JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, "$.jobChange.job.jobConfig.type") = "QUERY"</span><span id="a5e1" class="nb md it nw b gy of oc l od oe">GROUP BY period</span><span id="1996" class="nb md it nw b gy of oc l od oe">ORDER BY period DESC</span></pre><p id="08e8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">示例:您的数据库每个用户每月的费用是多少？<br/> </strong>和前面的要求类似，我们来分解一下每个用户每月的费用！</p><pre class="lf lg lh li gt nx nw ny nz aw oa bi"><span id="197b" class="nb md it nw b gy ob oc l od oe">SELECT</span><span id="aecc" class="nb md it nw b gy of oc l od oe"># Adapt the period of time according to your needs<br/>TIMESTAMP_TRUNC(TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, "$.jobChange.job.jobStats.endTime")), MONTH) AS period,</span><span id="08f4" class="nb md it nw b gy of oc l od oe"># User<br/>protopayload_auditlog.authenticationInfo.principalEmail as principal,</span><span id="1673" class="nb md it nw b gy of oc l od oe">FORMAT('%9.2f',5.0 * (SUM(CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, "$.jobChange.job.jobStats.queryStats.totalBilledBytes") AS INT64))/POWER(2, 40))) AS Estimated_USD_Cost</span><span id="4aec" class="nb md it nw b gy of oc l od oe">FROM logs.cloudaudit_googleapis_com_data_access</span><span id="f4fe" class="nb md it nw b gy of oc l od oe">WHERE</span><span id="6eee" class="nb md it nw b gy of oc l od oe">JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, "$.jobChange.job.jobConfig.type") = "QUERY"</span><span id="b718" class="nb md it nw b gy of oc l od oe">GROUP BY period, principal</span><span id="523e" class="nb md it nw b gy of oc l od oe">ORDER BY period, principal DESC</span></pre><p id="0ef1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以在<a class="ae lu" href="https://cloud.google.com/bigquery/docs/reference/auditlogs" rel="noopener ugc nofollow" target="_blank">文档</a>中找到更多请求示例。请随意创建您自己的！</p><h2 id="6e74" class="nb md it bd me nc nd dn mi ne nf dp mm kr ng nh mo kv ni nj mq kz nk nl ms nm bi translated">额外收获:BigQuery实用程序</h2><p id="aade" class="pw-post-body-paragraph ki kj it kk b kl no ju kn ko np jx kq kr nq kt ku kv nr kx ky kz ns lb lc ld im bi translated">由于<code class="fe nt nu nv nw b">cloudaudit_googleapis_com_data_access</code>可能会令人困惑，BigQuery通过<a class="ae lu" href="https://github.com/GoogleCloudPlatform/bigquery-utils/tree/master/views/audit" rel="noopener ugc nofollow" target="_blank"> BigQuery utils项目</a>提供了这个表的帮助视图。</p><p id="23c7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您遵循了本文的内容，就不需要重新创建日志接收器。只需跳到先决条件的步骤3和4，执行。sql脚本，一切都准备好了！</p><h1 id="623c" class="mc md it bd me mf pb mh mi mj pc ml mm jz pd ka mo kc pe kd mq kf pf kg ms mt bi translated">结论</h1><p id="2741" class="pw-post-body-paragraph ki kj it kk b kl no ju kn ko np jx kq kr nq kt ku kv nr kx ky kz ns lb lc ld im bi translated">通过BigQuery 中的<strong class="kk iu"> INFORMATION_SCHEMA </strong>、<strong class="kk iu"> __TABLES__ </strong>和<strong class="kk iu">云日志，您现在有3种简单的方法来审计和监控您的数据库。</strong></p><p id="1e46" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为您不想每次检查数据库健康状况时都重写所有这些查询，<strong class="kk iu">基于您最常用的分析创建视图</strong>是一个好的实践。您还可以基于某些阈值创建警报，但那是以后的事情了！</p></div></div>    
</body>
</html>