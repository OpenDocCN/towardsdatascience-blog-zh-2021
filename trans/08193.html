<html>
<head>
<title>MLOps Practice: Using OpenMLDB in the Real-Time Anti-Fraud Model for the Bank’s Online Transaction</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MLOps实践:在银行在线交易的实时反欺诈模型中使用OpenMLDB</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/practice-of-openmldbs-transaction-real-time-anti-fraud-model-in-the-bank-s-online-event-40ab41fec6d4?source=collection_archive---------37-----------------------#2021-07-27">https://towardsdatascience.com/practice-of-openmldbs-transaction-real-time-anti-fraud-model-in-the-bank-s-online-event-40ab41fec6d4?source=collection_archive---------37-----------------------#2021-07-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d146" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">中国在线反欺诈MLOp实践</h2></div><h1 id="0b47" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">背景</h1><p id="e95d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如今，许多银行已经开始引入机器学习模型来辅助规则引擎进行决策。银行也做了很多线下的机器学习模型探索，效果很好，但是很少最终应用到线上环境中，主要有以下几个原因:</p><ol class=""><li id="9f9e" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ma mb mc md bi translated">在风险控制场景中，在线推理需要高性能，需要TP99 20ms，对于大多数机器学习模型来说，要达到这样的性能是具有挑战性的。</li><li id="bf65" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">对特征计算的时效性要求高，但大多数机器学习基础设施无法满足基于滑动时间窗的计时特性。</li><li id="86e9" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">特征计算复杂庞大，在线成本很高。</li><li id="c9ad" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">保持离线特征计算和在线特征计算的一致性并不容易。最后，线下效果好，线上效果差。</li></ol><p id="6dbb" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">这是因为，要完成反欺诈模型在线项目，需要做以下事情来解决一致性问题:</p><p id="b667" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">首先，数据科学家使用SQL离线处理数据。接下来，他们需要将特征工程解决方案从离线转换到在线。在此过程中，数据工程师需要使特征处理逻辑与数据科学家保持一致，并考虑数据科学家程序更改的风险(这总是发生在生产系统中)。</p><p id="4bd1" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">第二，数据工程师基于反欺诈在线系统架构设计在线和实时数据处理架构。</p><p id="87a8" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">最后，数据工程师应该开发数据科学家已经用SQL手动开发的所有特征处理逻辑。在这个过程中，数据工程师作为不同计算机语言的“翻译者”工作。考虑到反欺诈机器学习项目中的数百万个特征，这种翻译工作是不必要的，并且容易出错。</p><p id="3dab" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">下图描述了大多数MLOps平台的这一过程。</p><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mm"><img src="../Images/3c5d3c356fdf55c5b9232922559ce815.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3s8IYPP5AFgQZkDwx51t2A.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">作者图片</p></figure><p id="d47c" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">那么，有没有一种方法，数据工程师只需要将数据科学家编写的SQL脚本扔进一个魔盒，就可以完成机器学习模型的推理工作，并使其在线工作，而无需考虑功能脚本的逻辑？</p><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nc"><img src="../Images/cd3cd842b729396727b0a753910459a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HwTmsUgZiXHxNbSQmXlKWw.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">作者图片</p></figure><p id="1a34" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">今天，作为一个机器学习应用开发者，我将告诉你如何基于<a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>解决这些问题。如果你在你的机器学习系统中使用它，你可以享受这些好处:</p><ol class=""><li id="7e19" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ma mb mc md bi translated">不需要理解数据科学家的特性计划的逻辑。即使计划有所调整，我只需要将SQL更新到<a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>。</li><li id="8cf4" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">不需要设计一套完整的在线数据计算流程，使用<a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>让我感觉就像使用MySQL开发传统应用一样简单。</li><li id="9941" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">告别手工开发特征工程</li></ol><p id="da3c" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">你可以简化开发过程，如下图所示。</p><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mm"><img src="../Images/bfe3b3318a8ea8805ed50bcb82fe74dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1BSWRJvu_goUaHWinKb-HA.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">作者图片</p></figure><h1 id="8387" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">如何使用OpenMLDB解决一致性问题</h1><p id="eff4" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这里大家可能很好奇，<a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>怎么可以不做任何修改批量实时执行一条SQL，因为<a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>支持两种执行模式:</p><ol class=""><li id="b958" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ma mb mc md bi translated">批处理模式，为训练过程生成样本，类似于SQL的传统数据库执行。</li><li id="3150" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">请求模式为推理过程实时生成样本，并且只计算与请求相关的特征。</li></ol><p id="30cb" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">这里让我们用银行交易数据给你举个例子:</p><p id="e203" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">这里我们有两张表:</p><ol class=""><li id="5cbf" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ma mb mc md bi translated"><em class="ne">t _ ins:we查询的时间，包括user_id/record时间</em></li><li id="12df" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated"><em class="ne"> t_trx:所有用户的交易记录，包括每笔交易/交易时间的user_id / a </em>笔数</li></ol><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi nf"><img src="../Images/74a9b55740fcf1e138b9a0ec6a910437.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e61-WAcI2nd_Jy-TSHVH7A.png"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">作者图片</p></figure><h1 id="318f" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">如何使用OpenMLDB解决性能问题</h1><p id="8972" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>自带多项列编译优化技术，如函数动态循环绑定和数据在线部分完全在内存中，可以保证非常高的执行性能。以下是<a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>自带的性能数据。</p><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ng"><img src="../Images/08e5a79278053997fc48e096a5be3c11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HtL27slY46OE0Mt8.jpg"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">作者图片</p></figure><p id="5bc0" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">我们可以看到<a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>的执行性能比SingleStore和Hana有很大的优势。接下来，我们来看一个实际的SQL执行效率。SQL如下所示</p><pre class="mn mo mp mq gt nh ni nj nk aw nl bi"><span id="c627" class="nm kg iq ni b gy nn no l np nq">select * from<br/>(select<br/>card_no,<br/>trx_time,<br/>merchant_id,<br/>month(trx_time) as fea_month,<br/>dayofmonth(trx_time) as fea_day_of_month,<br/>hour(trx_time) as fea_hour,<br/>week(trx_time) as fea_week,<br/>substr(card_no, 1, 6) as card_no_prefix,<br/>max(trx_amt) over w30d as w30d_trx_max ,<br/>min(trx_amt) over w30d as w30d_trx_min,<br/>sum(trx_amt) over w30d,<br/>avg(trx_amt) over w30d,<br/>max(usd_amt) over w30d,<br/>min(usd_amt) over w30d,<br/>sum(usd_amt) over w30d,<br/>avg(usd_amt) over w30d,<br/>max(org_amt) over w30d,<br/>min(org_amt) over w30d,<br/>sum(org_amt) over w30d,<br/>avg(org_amt) over w30d,<br/>distinct_count(merchant_id) over w30d,<br/>count(merchant_id) over w30d,<br/>distinct_count(term_city) over w30d,<br/>count(term_city) over w30d,<br/>max(trx_amt) over w10d,<br/>min(trx_amt) over w10d,<br/>sum(trx_amt) over w10d,<br/>avg(trx_amt) over w10d,<br/>max(usd_amt) over w10d,<br/>min(usd_amt) over w10d,<br/>sum(usd_amt) over w10d,<br/>avg(usd_amt) over w10d,<br/>max(org_amt) over w10d,<br/>min(org_amt) over w10d,<br/>sum(org_amt) over w10d,<br/>avg(org_amt) over w10d,<br/>distinct_count(merchant_id) over w10d,<br/>count(merchant_id)  over w10d,<br/>distinct_count(term_city)  over w10d,<br/>count(term_city) over w10d<br/>from  tran<br/>window w30d as (PARTITION BY tran.card_no ORDER BY tran.trx_time ROWS_RANGE BETWEEN 30d PRECEDING AND CURRENT ROW),<br/>w10d as (PARTITION BY tran.card_no ORDER BY tran.trx_time ROWS_RANGE BETWEEN 10d PRECEDING AND CURRENT ROW)) as trx_fe<br/>last join card_info order by card_info.crd_lst_isu_dte on trx_fe.card_no = card_info.crd_nbr and trx_fe.trx_time &gt;= card_info.crd_lst_isu_dte ;</span></pre><p id="f4ff" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">首先，分析这个SQL，影响性能的因素有</p><ol class=""><li id="fd97" class="lt lu iq kz b la lv ld lw lg lx lk ly lo lz ls ma mb mc md bi translated">时间窗口中的数据数量</li><li id="78d6" class="lt lu iq kz b la me ld mf lg mg lk mh lo mi ls ma mb mc md bi translated">特征号</li></ol><p id="8df0" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">因为特性的数量是特定的，所以我们在不同的时间窗口中测试性能。</p><p id="a712" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated"><a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>有着梦幻般的表现。一个时间窗内有2000条数据，可以保证p99在1ms左右快速满足反诈骗场景苛刻的性能要求。</p><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ng"><img src="../Images/e8b68a585b27e0f1c0f129d38b2a05bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wFX1FSVXvR5CflOI.jpg"/></div></div><p class="my mz gj gh gi na nb bd b be z dk translated">作者图片</p></figure><p id="1bb2" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated"><a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>性能惊人。一个时间窗内有2000条数据，可以保证p99在1ms左右，这样我们就可以轻松满足反欺诈场景苛刻的性能要求。</p><h1 id="3b34" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">使用OpenMLDB在线业务效果</h1><p id="2a04" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">商业效益是每个人都非常关心的事情。目前我们已经上线了多家银行的反欺诈场景。线上效果和线下评价效果一致。与客户的专家规则相比，模型结果提高了2-8倍，并且在线和离线过程中召回率保持相同。在这种情况下，客户非常认可我们的工作，希望我的分享能帮到你。</p><h2 id="b962" class="nm kg iq bd kh nr ns dn kl nt nu dp kp lg nv nw kr lk nx ny kt lo nz oa kv ob bi translated">关于OpenMLDB</h2><p id="effb" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated"><a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>是一个开源数据库，为机器学习应用提供正确高效的数据供应。除了机器学习数据开发效率提升10倍以上，<a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank"> OpenMLDB </a>还提供统一的计算和存储引擎，降低开发、运营和维护的复杂性和整体成本。</p><h1 id="d1d3" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">体系结构</h1><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi ng"><img src="../Images/846b9e04cab7a0565ebc8dc9d6f7adfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HJp2uHvn9OxOgQh7.jpg"/></div></div></figure><p id="90b5" class="pw-post-body-paragraph kx ky iq kz b la lv jr lc ld lw ju lf lg mj li lj lk mk lm ln lo ml lq lr ls ij bi translated">欢迎大家参与到社区中的<a class="ae nd" href="https://github.com/4paradigm/OpenMLDB" rel="noopener ugc nofollow" target="_blank">HTTPS://github.com/4paradigm/Op enMLDB</a>。</p></div></div>    
</body>
</html>