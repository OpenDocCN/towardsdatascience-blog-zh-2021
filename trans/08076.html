<html>
<head>
<title>AWS System Manager — Manage Server remotely</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS系统管理器—远程管理服务器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/aws-system-manager-manage-server-remotely-4f8ffe63575d?source=collection_archive---------17-----------------------#2021-07-24">https://towardsdatascience.com/aws-system-manager-manage-server-remotely-4f8ffe63575d?source=collection_archive---------17-----------------------#2021-07-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/9196edf9d9252d28ca63414f42cc2917.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*an11DpHFnolIECmNhsF8KQ.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">丹尼尔·格雷瓜尔在<a class="ae jd" href="https://unsplash.com/s/photos/lighthouse?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><div class=""/><div class=""><h2 id="f660" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">SSM在多台主机上并行运行命令，不使用SSH</h2></div><p id="72a6" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最近，由于我们安全团队的一些更新，我们不得不在AWS帐户的所有主机上安装一个代理。我们在客户中运行了1100多个EC2实例。这些服务器有不同的操作系统(亚马逊Linux、Fedora、CentOS、RHEL、Ubuntu、Windows、FreeBSD等)。此外，这些服务器支持各种工作负载，如EMR(各种版本)、EKS、ECS、Airflow、Tableau、Alation。其中许多是供应商配置的服务器，它们有自己的ami。用代理为每种类型创建ami需要很长时间和巨大的努力。此外，有些服务器不能容忍重启(为了让用户数据脚本工作)。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="c252" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">AWS有一个名为System Manager的服务，它允许我们在不需要SSH的情况下运行远程命令。运行SSM文档的基本要求是主机应该运行<code class="fe ly lz ma mb b">amazon-ssm-agent</code>,并且主机应该有一个能够访问SSM(amazonsmsmanagedinstancecore)的IAM角色。下图总结了SSM运行命令的工作方式。</p><figure class="md me mf mg gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mc"><img src="../Images/a6bd0c2912c95636ca981a657d843523.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uk-msDGROTrOTtZYMqWdsw.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">SSM运行命令的高级流程|图片由作者提供</p></figure><h2 id="43be" class="mh mi jg bd mj mk ml dn mm mn mo dp mp le mq mr ms li mt mu mv lm mw mx my mz bi translated">SSM运行命令中的低级API调用:</h2><ol class=""><li id="5e65" class="na nb jg kx b ky nc lb nd le ne li nf lm ng lq nh ni nj nk bi translated">SSM代理向SSM服务端点更新实例详细信息。这每5分钟发生一次(ssm:UpdateInstanceInformation)。此更新增强了运行命令实例的详细信息。</li><li id="520e" class="na nb jg kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">代理持续轮询(长时间)来自消息传递服务(ec2messages:GetMessages)的消息。</li><li id="5c5f" class="na nb jg kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">一旦它接收到预定的消息，它就发送一个确认(ec2messages:AcknowledgeMessage)。</li><li id="ef3d" class="na nb jg kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">它从SSM下载文档(ssm:GetDocument)</li><li id="de66" class="na nb jg kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">执行文档。</li><li id="8511" class="na nb jg kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">如果在此期间收到取消消息，它将取消文档执行。</li><li id="b63d" class="na nb jg kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">将响应发送回消息传递服务(ec2messages:SendReply)。</li></ol></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="5c13" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">幸运的是，我们在这些服务器上安装了SSM代理。我们为SSM和其他所需的访问权限创建了一个托管策略，并将该策略附加到主机的IAM角色。我们利用boto3让所有拥有EC2服务的IAM角色成为可信实体，并向角色添加托管策略。</p><figure class="md me mf mg gt is"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="f879" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦满足了先决条件，我们就利用系统管理器的文档和运行命令功能来安装代理。对于正在运行的实例，我们采用了基于标签的方法，并基于该标签运行文档。</p><figure class="md me mf mg gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ns"><img src="../Images/45a3ef5c72baff87116b42800d088b49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0s_yskSmwy3ICgRBhiq0tg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">现有服务器修补解决方案设计|作者图片</p></figure><p id="8f05" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">由于我们的平台使用了大量的自动伸缩，我们还需要在由AWS管理的自动伸缩运行的新服务器上放置代理。我们可以使用启动模板的用户数据，但是EMR管理的扩展组(实例组)没有用户数据，我们不想干扰现有的引导脚本。我们使用了CloudWatch、Lambda、SQS和SSM来处理这些问题。</p><figure class="md me mf mg gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nt"><img src="../Images/6cd5d8d40924135e8b877fe680f8b8b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iVC0sIPziMwJ_YJFwYqNSQ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">现场安装解决方案设计|作者图片</p></figure><ul class=""><li id="cc40" class="na nb jg kx b ky kz lb lc le nu li nv lm nw lq nx ni nj nk bi translated">EC2实例出现，它生成事件并将它们发送到CloudWatch。</li><li id="e901" class="na nb jg kx b ky nl lb nm le nn li no lm np lq nx ni nj nk bi translated">CloudWatch基于实例状态变化(正在运行)来挖掘事件。它将该事件发送到SQS队列。</li></ul><figure class="md me mf mg gt is"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="cfb3" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">SQS队列在消息上增加了3分钟的延迟，然后在3分钟的窗口中对消息进行批处理。</p><figure class="md me mf mg gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ny"><img src="../Images/44eac53a5d6d6ef6bd6464364a99ff15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FMvEHMagJ3ylHccAXVFU_A.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">递送延迟的SQS队列配置|作者图片</p></figure><ul class=""><li id="580c" class="na nb jg kx b ky kz lb lc le nu li nv lm nw lq nx ni nj nk bi translated">AWS Lambda批量接收消息。它过滤由SSM管理的实例。对于不由它管理的实例，将它发送到另一个数据库。SSM it部门管理的所有实例都根据平台(Linux/Windows)进行分组。它调用SSM的相应文件。</li></ul><figure class="md me mf mg gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nz"><img src="../Images/aa5f51d86613ef4af3137678d127201b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ICNl8O39HfTOpvLvIIfMog.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">Lambda |图片的SQS事件触发器(作者)</p></figure><figure class="md me mf mg gt is"><div class="bz fp l di"><div class="nq nr l"/></div></figure><ul class=""><li id="1ffa" class="na nb jg kx b ky kz lb lc le nu li nv lm nw lq nx ni nj nk bi translated">SSM文档向所有目标实例发送命令，并在服务器上安装代理。</li></ul><figure class="md me mf mg gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oa"><img src="../Images/82a8ef3b225d54858ef5494c1ab8c44a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZxSDpzNL0OxSQAg_Nr77QA.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">SSM文档样本</p></figure><figure class="md me mf mg gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ob"><img src="../Images/c70bf3fb77205f2a8bcae8264182c7d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_4CldafPFDMUPhm5pzCNkg.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">命令的SSM文档运行历史|作者的图像</p></figure><p id="4a5e" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这种方法使我们能够在3天内对所有的机器运行安装命令(我们分批执行以减小爆炸半径)。所有新机器都通过lambda自动打补丁。我们也可以使用cli发送命令。</p><pre class="md me mf mg gt oc mb od oe aw of bi"><span id="ee4a" class="mh mi jg mb b gy og oh l oi oj">aws ssm send-command \<br/>    --document-name "&lt;Document_name&gt;" \<br/>    --targets "Key=instanceids,Values=i-1234567890abcdef0" \<br/>    --timeout-seconds 300</span></pre><p id="3be9" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">尽管我们这样做是为了安装特定的代理，但是该解决方案可以扩展到各种用例(自动化就是其中之一)。我能马上想到的一个是替换<strong class="kx jh">air flow . contrib . operators . ssh _ operator。</strong>有了SSM，我们不必创建SSH连接。一切都由SSM负责。解决方案中唯一的问题是SSM 15分钟的暂停。但是如果你跟着火走，却忘了接近，这将是一个很好的探索选择。</p><p id="258f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">云计算快乐！！</p></div></div>    
</body>
</html>