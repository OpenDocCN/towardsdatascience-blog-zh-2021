<html>
<head>
<title>Get better at building Pytorch models with Lightning and Ray Tune</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用闪电和光线调整更好地构建Pytorch模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/get-better-at-building-pytorch-models-with-lightning-and-ray-tune-9fc39b84e602?source=collection_archive---------23-----------------------#2021-09-02">https://towardsdatascience.com/get-better-at-building-pytorch-models-with-lightning-and-ray-tune-9fc39b84e602?source=collection_archive---------23-----------------------#2021-09-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/9dcd402db4bd9dfb737dc553a7fd32fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_LlxhrLD4GMF1OyQ"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">伊利亚·巴甫洛夫在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="3ec9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> Pytorch </strong>是领先的深度学习框架之一，因其易用性、丰富的功能和可靠性而在研究和行业中得到广泛应用。</p><p id="3d65" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然而，尽管现代深度学习框架在允许快速建立模型方面做得非常好，但仍然需要大量的样板代码。</p><p id="29ca" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了解决这个问题，新的库和框架正在开发中，它们旨在改善开发复杂深度学习模型的整体体验。</p><p id="2d85" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将讨论其中的两个框架，它们都可以单独与Pytorch一起使用，或者组合在一起快速原型化和开发新模型:</p><ul class=""><li id="b36e" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">Pytorch-lightning :通过在常规Pytorch代码上添加一个抽象层，提供了许多方便的特性，并允许用更少的代码获得相同的结果。</li><li id="36c5" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu"> Ray-tune </strong>:超参数调谐库，适用于任何比例的高级调谐策略。</li></ul><h1 id="389a" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">模型开发:Pytorch闪电</h1><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mq"><img src="../Images/6ffdc3b02986e43acf193f26a1e7957d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T2lwJ61ZON4qEONAa1VnwA.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://www.pytorchlightning.ai/" rel="noopener ugc nofollow" target="_blank">https://www.pytorchlightning.ai/</a></p></figure><p id="11cb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> Pytorch Lightning </strong>是一个旨在通过加快模型开发来增强Pytorch的框架。<em class="mv">“多花点时间在研究上，少花点时间在工程上”</em></p><p id="1f79" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">主要思想是深度学习模型共享大量样板代码，这些代码可能需要大量时间来正确编码和实现。日志记录、检查点、GPU/TPU支持或分布式训练等功能是与模型无关的，通常会一遍又一遍地重复开发。</p><p id="24b1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该框架提供了大量的功能，但这些好处是有代价的:为了使用该框架，您需要根据给定的结构开发您的模型:</p><pre class="mr ms mt mu gt mw mx my mz aw na bi"><span id="fe53" class="nb lt it mx b gy nc nd l ne nf">class MyModel(pl.LightningModule):<br/>def__init__(self)<br/>def forward(self, x)<br/>def configure_optimizers(self)<br/>def training_step(self, train_batch, batch_idx)<br/>def training_epoch_end(self, outs)<br/>def validation_step(self, val_batch, batch_idx)<br/>def validation_epoch_end(self, outs)</span></pre><ul class=""><li id="29d0" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">前进:与香草Pytorch相同</li><li id="a67d" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">培训/验证步骤:从数据加载器接收输入，执行损失计算，计算指标并记录下来</li><li id="f3d8" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">训练/验证时期(可选):接收时期期间所有步骤的输出，以便计算整个时期的度量</li><li id="ec06" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">Configure _ optimizers:应该为您的模型返回一个优化器和一个调度器对象</li></ul><p id="9f08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦将模型重构到这个新结构中，并将数据打包到Pytorch数据加载器中，就可以开始了。</p><p id="63b5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有许多不同的特性旨在使您的生活更轻松，因为框架是有据可查的，我将只列出我一直使用的那些:</p><ul class=""><li id="66ef" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated"><strong class="ki iu">在Tensorboard上自动登录</strong>:通过一个简单的函数调用，您可以在Tensorboard上记录任何指标并获得可视化效果。</li><li id="eae8" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">分布式训练，GPU/TPU支持</strong>:训练可以通过一个简单的命令行参数在不同的节点上分割，支持TPU和GPU。</li><li id="3403" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">对多个数据加载器的评估</strong>:您可以将您的验证或测试数据分割成多个数据加载器(例如在NLP中，每种语言一个数据加载器)并单独评估性能。</li><li id="034e" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">简单的检查点和早期停止:</strong>检查点是通过监控任何记录的指标来创建的。</li><li id="7e9d" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">渐变裁剪</strong>:为了避免“爆炸式渐变”干扰训练，您可以在训练器上用一个简单的参数裁剪渐变。</li><li id="8f7b" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">验证集区间评估</strong>:一个简单但强大的技巧，特别是对于较大的数据集，通过在每个时期对验证集进行多次评估，您可以更好地了解模型的性能，并且可以更快地迭代。如果将它与检查点结合使用，它还可以为您提供一个更好的模型。</li></ul><p id="2680" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">尽管采用了强制结构，但该框架可以处理复杂的嵌套模型，并且对于多任务和多损失非常适用。已经采取了特别的措施来确保框架对训练几乎没有性能影响，它也非常健壮，到目前为止我还没有遇到任何稳定版本的错误。</p><p id="a21b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一个警告是，根据我的经验，这个框架并没有真正被设计来处理复杂的训练过程，比如在同一个脚本中一个接一个地训练不同的模型。因此，如果您的用例非常奇特，那么检查您的培训过程是否得到支持可能是值得的。</p><p id="9d95" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请记住，该框架还很年轻，仍在积极开发中，新功能会定期添加进来。</p><p id="e8da" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你想自己尝试一下，你可以按照官方文档上的这个<a class="ae kf" href="https://pytorch-lightning.readthedocs.io/en/latest/starter/new-project.html" rel="noopener ugc nofollow" target="_blank">教程</a>，它会经过安装和使用框架的第一步。</p><h1 id="1d7b" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">超参数调整:光线调整</h1><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/e5e9d9ffeeb7ea60efab676c06c02ffb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gnqv1E1z1iN9AwlYDNPcxA.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://docs.ray.io/en/latest/tune/" rel="noopener ugc nofollow" target="_blank">https://docs.ray.io/en/latest/tune/</a></p></figure><p id="8b41" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">超参数调整</strong>是建立机器学习模型时必不可少的一步。虽然自己做<strong class="ki iu">网格搜索</strong>或<strong class="ki iu">随机搜索</strong>很快，但你可能想尝试更复杂的搜索算法(比如<strong class="ki iu">贝叶斯优化</strong>)，这些算法更难编码。</p><p id="2c72" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> Tune </strong>是一个超参数调整库，它是更大的<strong class="ki iu"> Ray </strong>框架的一部分，有助于构建和服务分布式应用。</p><p id="3c87" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">具体来说，<strong class="ki iu"> Tune </strong>允许您选择一个<a class="ae kf" href="https://docs.ray.io/en/latest/tune/api_docs/suggestion.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ki iu">搜索算法</strong> </a>，该算法将用于选择一组特定的超参数，以在每次迭代中进行测试。可用的算法主要包括:</p><ul class=""><li id="d559" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated"><a class="ae kf" href="https://docs.ray.io/en/latest/tune/api_docs/suggestion.html#tune-basicvariant" rel="noopener ugc nofollow" target="_blank">随机搜索/网格搜索</a></li><li id="efb2" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">贝叶斯/Bandit优化</li><li id="230f" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">树Parzen估计量(超点)</li><li id="4fb1" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">无梯度优化</li></ul><p id="712f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">除了搜索算法，您还可以使用<strong class="ki iu">试用调度程序。</strong>调度程序从头到尾管理超参数搜索。根据调度程序，它们可以与搜索算法一起使用，也可以完全替代搜索算法。</p><p id="66bd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">与只关注于选择一组足够的超参数进行测试的搜索算法不同，调度器将具有元学习策略，并具有及早停止不成功的尝试、暂停、克隆或改变它们的能力。这可以通过提前终止一些试验来加速搜索，并将时间分配给更有希望的试验。</p><p id="38ab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Tune提供了一些不同的调度程序，但它们基本上是两种技术的变体:</p><ul class=""><li id="48bf" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated"><strong class="ki iu">这篇<a class="ae kf" href="https://arxiv.org/pdf/1603.06560.pdf" rel="noopener ugc nofollow" target="_blank">论文</a>中描述的超带</strong>，主要思想是将贝叶斯优化与提前停止相结合。</li><li id="ad11" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated"><strong class="ki iu">基于人群的训练</strong>来自<strong class="ki iu"> OpenAI。</strong>在这篇<a class="ae kf" href="https://deepmind.com/blog/article/population-based-training-neural-networks" rel="noopener ugc nofollow" target="_blank">博文</a>中，他们描述了这项技术如何极大地增强了他们的深度强化学习模型的性能。</li></ul><p id="a4c9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu"> Tune </strong>与各种框架配合良好，为<a class="ae kf" href="https://docs.ray.io/en/latest/tune/tutorials/tune-tutorial.html" rel="noopener ugc nofollow" target="_blank"> Pytorch </a>和<a class="ae kf" href="https://docs.ray.io/en/latest/tune/tutorials/tune-pytorch-lightning.html" rel="noopener ugc nofollow" target="_blank"> Pytorch-lightning </a>提供了教程，你可以在他们的图库中找到其他框架的代码示例，如<a class="ae kf" href="https://docs.ray.io/en/latest/tune/examples/tune_mnist_keras.html" rel="noopener ugc nofollow" target="_blank"> Keras </a>。</p><h1 id="898e" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">结论</h1><p id="cd17" class="pw-post-body-paragraph kg kh it ki b kj nh kl km kn ni kp kq kr nj kt ku kv nk kx ky kz nl lb lc ld im bi translated">这两个框架都旨在通过向所有用户提供先进技术，使机器学习模型的开发更快、更方便和更强大。</p><p id="59bb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为一名软件开发人员，重新发明轮子总是很诱人的，但是如果你追求生产率，你可能更喜欢让一些库做繁重的工作，而把你的精力集中在提供更多价值的部分。</p></div></div>    
</body>
</html>