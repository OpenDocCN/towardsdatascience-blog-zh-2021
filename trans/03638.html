<html>
<head>
<title>Build a News recommendation app from python with Vespa</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Vespa从python构建新闻推荐应用程序</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-a-news-recommendation-app-from-python-with-vespa-7c5b3ce079be?source=collection_archive---------26-----------------------#2021-03-24">https://towardsdatascience.com/build-a-news-recommendation-app-from-python-with-vespa-7c5b3ce079be?source=collection_archive---------26-----------------------#2021-03-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2d6c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第1部分—新闻搜索功能</h2></div><p id="5250" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将在Vespa中构建一个新闻推荐应用程序，而不会离开python环境。在本系列的第一部分中，我们希望开发一个具有基本搜索功能的应用程序。未来的帖子将增加基于嵌入和其他ML模型的推荐功能。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/0cf8c9cafdb6dd84654f934d9744df3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b5TY4WdfdbSwOrdIPNfeQA.jpeg"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">照片由<a class="ae lr" href="https://unsplash.com/@filipthedesigner?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">菲利普·米舍夫斯基</a>在<a class="ae lr" href="/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="a02e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个系列是Vespa的<a class="ae lr" href="https://docs.vespa.ai/en/tutorials/news-2-basic-feeding-and-query.html" rel="noopener ugc nofollow" target="_blank">新闻搜索推荐教程</a>的简化版。我们还将使用<a class="ae lr" href="https://msnews.github.io/" rel="noopener ugc nofollow" target="_blank">微软新闻数据集(MIND) </a>的演示版本，这样任何人都可以在他们的笔记本电脑上跟随。</p><h2 id="8f69" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">资料组</h2><p id="e60e" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">最初的Vespa新闻搜索教程提供了一个脚本来下载、解析和转换MIND数据集为Vespa格式。为了方便您，我们提供了本教程所需的最终解析数据供下载:</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="737f" class="ls lt iq mt b gy mx my l mz na">{'abstract': "Shop the notebooks, jackets, and more that the royals can't live without.",<br/> 'title': 'The Brands Queen Elizabeth, Prince Charles, and Prince Philip Swear By',<br/> 'subcategory': 'lifestyleroyals',<br/> 'news_id': 'N3112',<br/> 'category': 'lifestyle',<br/> 'url': 'https://www.msn.com/en-us/lifestyle/lifestyleroyals/the-brands-queen-elizabeth,-prince-charles,-and-prince-philip-swear-by/ss-AAGH0ET?ocid=chopendata',<br/> 'date': 20191103,<br/> 'clicks': 0,<br/> 'impressions': 0}</span></pre><p id="d5ff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里使用的最终解析数据是一个列表，其中每个元素都是一个字典，包含一篇新闻文章的相关字段，比如<code class="fe nb nc nd mt b">title</code>和<code class="fe nb nc nd mt b">category</code>。我们也有文章收到的<code class="fe nb nc nd mt b">impressions</code>和<code class="fe nb nc nd mt b">clicks</code>的数量信息。mind数据集的演示版包含了28.603篇新闻文章。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="d236" class="ls lt iq mt b gy mx my l mz na">28603</span></pre><h2 id="7af5" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">安装pyvespa</h2><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><h2 id="5d91" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">创建搜索应用程序</h2><p id="ab6f" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">创建应用程序包。<code class="fe nb nc nd mt b">app_package</code>将保存与您的应用规范相关的所有相关数据。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="a191" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">向架构中添加字段。下面是对下面使用的非显而易见的参数的简短描述:</p><ul class=""><li id="13ef" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated">索引参数:为字段配置<a class="ae lr" href="https://docs.vespa.ai/en/reference/advanced-indexing-language.html" rel="noopener ugc nofollow" target="_blank">索引管道</a>，它定义了Vespa在索引期间如何处理输入。</li><li id="375e" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">“索引”:为此字段创建搜索索引。</li><li id="e858" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">“summary”:让该字段成为结果集中<a class="ae lr" href="https://docs.vespa.ai/en/document-summaries.html" rel="noopener ugc nofollow" target="_blank">文档摘要</a>的一部分。</li><li id="2ff5" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">“属性”:将该字段作为<a class="ae lr" href="https://docs.vespa.ai/en/attributes.html" rel="noopener ugc nofollow" target="_blank">属性</a>存储在内存中——用于<a class="ae lr" href="https://docs.vespa.ai/en/reference/sorting.html" rel="noopener ugc nofollow" target="_blank">排序</a>、<a class="ae lr" href="https://docs.vespa.ai/en/query-api.html" rel="noopener ugc nofollow" target="_blank">查询</a>和<a class="ae lr" href="https://docs.vespa.ai/en/grouping.html" rel="noopener ugc nofollow" target="_blank">分组</a>。</li><li id="6e1f" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">索引参数:<a class="ae lr" href="https://docs.vespa.ai/en/reference/schema-reference.html#index" rel="noopener ugc nofollow" target="_blank">配置</a>Vespa应该如何创建搜索索引。</li><li id="8c28" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">“enable-bm25”:设置一个兼容<a class="ae lr" href="https://docs.vespa.ai/en/reference/rank-features.html#bm25" rel="noopener ugc nofollow" target="_blank"> bm25排名</a>的索引进行文本搜索。</li><li id="fb2f" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">属性参数:<a class="ae lr" href="https://docs.vespa.ai/en/attributes.html" rel="noopener ugc nofollow" target="_blank">配置</a>Vespa应该如何对待一个属性字段。</li><li id="ef87" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">“快速搜索”:为属性字段建立索引。默认情况下，不会为属性生成索引，搜索这些属性默认为线性扫描。</li></ul><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="f27d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">向架构中添加字段集。字段集允许我们轻松地搜索多个字段。在这种情况下，搜索<code class="fe nb nc nd mt b">default</code>字段集等同于搜索<code class="fe nb nc nd mt b">title</code>和<code class="fe nb nc nd mt b">abstract</code>。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="0250" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有足够的资源来部署应用程序的第一个版本。在本教程的后面，我们将把一篇文章的受欢迎程度包括在相关性分数中，用于对匹配我们查询的新闻进行排名。</p><h2 id="7cf3" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">在Docker上部署应用程序</h2><p id="13cf" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">如果您的机器上安装了Docker，您可以在本地Docker容器中部署<code class="fe nb nc nd mt b">app_package</code>:</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="e025" class="ls lt iq mt b gy mx my l mz na">Waiting for configuration server.<br/>Waiting for configuration server.<br/>Waiting for configuration server.<br/>Waiting for configuration server.<br/>Waiting for configuration server.<br/>Waiting for configuration server.<br/>Waiting for configuration server.<br/>Waiting for configuration server.<br/>Waiting for application status.<br/>Waiting for application status.<br/>Finished deployment.</span></pre><p id="a471" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nb nc nd mt b">vespa_docker</code>将解析<code class="fe nb nc nd mt b">app_package</code>并将所有必要的Vespa配置文件写入<code class="fe nb nc nd mt b">disk_folder</code>。然后它将创建docker容器，并使用Vespa配置文件来部署Vespa应用程序。然后，我们可以使用<code class="fe nb nc nd mt b">app</code>实例与部署的应用程序进行交互，比如用于提要和查询。如果你想知道更多幕后发生的事情，我们建议你浏览<a class="ae lr" href="https://docs.vespa.ai/en/tutorials/news-1-getting-started.html" rel="noopener ugc nofollow" target="_blank">Docker入门教程</a>。</p><h2 id="93cf" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">向应用程序提供数据</h2><p id="8254" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我们可以使用<code class="fe nb nc nd mt b">feed_data_point</code>方法。我们需要具体说明:</p><ul class=""><li id="49c5" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated"><code class="fe nb nc nd mt b">data_id</code>:识别数据点的唯一id</li><li id="2a8e" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated"><code class="fe nb nc nd mt b">fields</code>:字典中的键与我们的应用程序包模式中定义的字段名相匹配。</li><li id="abbc" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated"><code class="fe nb nc nd mt b">schema</code>:我们要向其馈送数据的模式的名称。当我们创建应用程序包时，我们默认创建了一个与应用程序名同名的模式，在我们的例子中是<code class="fe nb nc nd mt b">news</code>。</li></ul><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><h2 id="9a86" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">查询应用程序</h2><p id="ff9c" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我们可以使用<a class="ae lr" href="https://docs.vespa.ai/en/query-api.html" rel="noopener ugc nofollow" target="_blank"> Vespa查询API </a>到<code class="fe nb nc nd mt b">app.query</code>来释放Vespa所能提供的全部查询灵活性。</p><h2 id="86fd" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">使用关键字搜索索引字段</h2><p id="85dd" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">从文档中选择<code class="fe nb nc nd mt b">default</code>(标题或摘要)包含关键字“音乐”的所有字段。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="1bd5" class="ls lt iq mt b gy mx my l mz na">{'id': 'index:news_content/0/5f1b30d14d4a15050dae9f7f',<br/> 'relevance': 0.25641557752127125,<br/> 'source': 'news_content'}</span></pre><p id="388f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">选择<code class="fe nb nc nd mt b">title</code>和<code class="fe nb nc nd mt b">abstract</code>，其中<code class="fe nb nc nd mt b">title</code>包含‘音乐’，<code class="fe nb nc nd mt b">default</code>包含‘节日’。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="2f0b" class="ls lt iq mt b gy mx my l mz na">{'id': 'index:news_content/0/988f76793a855e48b16dc5d3',<br/> 'relevance': 0.19587240022210403,<br/> 'source': 'news_content',<br/> 'fields': {'title': "At Least 3 Injured In Stampede At Travis Scott's Astroworld Music Festival",<br/>  'abstract': "A stampede Saturday outside rapper Travis Scott's Astroworld musical festival in Houston, left three people injured. Minutes before the gates were scheduled to open at noon, fans began climbing over metal barricades and surged toward the entrance, according to local news reports."}}</span></pre><h2 id="a288" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">按文档类型搜索</h2><p id="79e3" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">选择文档类型等于<code class="fe nb nc nd mt b">news</code>的所有文档的标题。我们的应用程序只有一种文档类型，所以下面的查询检索我们所有的文档。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="092a" class="ls lt iq mt b gy mx my l mz na">{'id': 'index:news_content/0/698f73a87a936f1c773f2161',<br/> 'relevance': 0.0,<br/> 'source': 'news_content',<br/> 'fields': {'title': 'The Brands Queen Elizabeth, Prince Charles, and Prince Philip Swear By'}}</span></pre><h2 id="e22a" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">搜索属性字段，如日期</h2><p id="500b" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">因为<code class="fe nb nc nd mt b">date</code>没有用<code class="fe nb nc nd mt b">attribute=["fast-search"]</code>指定，所以没有为它建立索引。因此，搜索它相当于对字段的值进行线性扫描。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="46e6" class="ls lt iq mt b gy mx my l mz na">{'id': 'index:news_content/0/debbdfe653c6d11f71cc2353',<br/> 'relevance': 0.0017429193899782135,<br/> 'source': 'news_content',<br/> 'fields': {'title': 'These Cranberry Sauce Recipes Are Perfect for Thanksgiving Dinner',<br/>  'date': 20191110}}</span></pre><p id="89ff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于<code class="fe nb nc nd mt b">default</code>字段集是由索引字段组成的，Vespa将首先过滤所有在<code class="fe nb nc nd mt b">title</code>或<code class="fe nb nc nd mt b">abstract</code>中包含关键字“天气”的文档，然后在<code class="fe nb nc nd mt b">date</code>字段中扫描“20191110”。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="fb06" class="ls lt iq mt b gy mx my l mz na">{'id': 'index:news_content/0/bb88325ae94d888c46538d0b',<br/> 'relevance': 0.27025156546141466,<br/> 'source': 'news_content',<br/> 'fields': {'title': 'Weather forecast in St. Louis',<br/>  'abstract': "What's the weather today? What's the weather for the week? Here's your forecast.",<br/>  'date': 20191110}}</span></pre><p id="e3f3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们还可以执行范围搜索:</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="e17e" class="ls lt iq mt b gy mx my l mz na">{'id': 'index:news_content/0/c41a873213fdcffbb74987c0',<br/> 'relevance': 0.0017429193899782135,<br/> 'source': 'news_content',<br/> 'fields': {'date': 20191109}}</span></pre><h2 id="3fa1" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">整理</h2><p id="3678" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">默认情况下，Vespa会按相关性分数降序对点击进行排序。相关性分数是由<a class="ae lr" href="https://docs.vespa.ai/en/nativerank.html" rel="noopener ugc nofollow" target="_blank"> nativeRank </a>给出的，除非另有说明，我们将在本文后面做些说明。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="bc75" class="ls lt iq mt b gy mx my l mz na">[{'id': 'index:news_content/0/5f1b30d14d4a15050dae9f7f',<br/>  'relevance': 0.25641557752127125,<br/>  'source': 'news_content',<br/>  'fields': {'title': 'Music is hot in Nashville this week',<br/>   'date': 20191101}},<br/> {'id': 'index:news_content/0/6a031d5eff95264c54daf56d',<br/>  'relevance': 0.23351089409559303,<br/>  'source': 'news_content',<br/>  'fields': {'title': 'Apple Music Replay highlights your favorite tunes of the year',<br/>   'date': 20191105}}]</span></pre><p id="6400" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，我们可以使用关键字<code class="fe nb nc nd mt b">order</code>通过给定的字段显式排序。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="67eb" class="ls lt iq mt b gy mx my l mz na">[{'id': 'index:news_content/0/d0d7e1c080f0faf5989046d8',<br/>  'relevance': 0.0,<br/>  'source': 'news_content',<br/>  'fields': {'title': "Elton John's second farewell tour stop in Cleveland shows why he's still standing after all these years",<br/>   'date': 20191031}},<br/> {'id': 'index:news_content/0/abf7f6f46ff2a96862075155',<br/>  'relevance': 0.0,<br/>  'source': 'news_content',<br/>  'fields': {'title': 'The best hair metal bands', 'date': 20191101}}]</span></pre><p id="fe45" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nb nc nd mt b">order</code>默认按升序排序，我们可以用<code class="fe nb nc nd mt b">desc</code>关键字覆盖:</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="c394" class="ls lt iq mt b gy mx my l mz na">[{'id': 'index:news_content/0/934a8d976ff8694772009362',<br/>  'relevance': 0.0,<br/>  'source': 'news_content',<br/>  'fields': {'title': 'Korg Minilogue XD update adds key triggers for synth sequences',<br/>   'date': 20191113}},<br/> {'id': 'index:news_content/0/4feca287fdfa1d027f61e7bf',<br/>  'relevance': 0.0,<br/>  'source': 'news_content',<br/>  'fields': {'title': 'Tom Draper, Black Music Industry Pioneer, Dies at 79',<br/>   'date': 20191113}}]</span></pre><h2 id="52d2" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">分组</h2><p id="f018" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我们可以使用Vespa的<a class="ae lr" href="https://docs.vespa.ai/en/grouping.html" rel="noopener ugc nofollow" target="_blank">分组</a>功能来计算文档数量最多的三个新闻类别:</p><ul class=""><li id="52c9" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated">有9115篇文章的新闻</li><li id="cac4" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">体育6765篇</li><li id="30c9" class="ne nf iq kh b ki nn kl no ko np ks nq kw nr la nj nk nl nm bi translated">金融1886篇</li></ul><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="400f" class="ls lt iq mt b gy mx my l mz na">{'id': 'group:root:0',<br/> 'relevance': 1.0,<br/> 'continuation': {'this': ''},<br/> 'children': [{'id': 'grouplist:category',<br/>   'relevance': 1.0,<br/>   'label': 'category',<br/>   'continuation': {'next': 'BGAAABEBGBC'},<br/>   'children': [{'id': 'group:string:news',<br/>     'relevance': 1.0,<br/>     'value': 'news',<br/>     'fields': {'count()': 9115}},<br/>    {'id': 'group:string:sports',<br/>     'relevance': 0.6666666666666666,<br/>     'value': 'sports',<br/>     'fields': {'count()': 6765}},<br/>    {'id': 'group:string:finance',<br/>     'relevance': 0.3333333333333333,<br/>     'value': 'finance',<br/>     'fields': {'count()': 1886}}]}]}</span></pre><h2 id="ffb8" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">使用新闻流行度信号进行排名</h2><p id="9ef4" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">默认情况下，Vespa使用<a class="ae lr" href="https://docs.vespa.ai/en/nativerank.html" rel="noopener ugc nofollow" target="_blank"> nativeRank </a>来计算相关性分数。我们将创建一个新的等级简档，它在我们的相关性分数计算中包括一个流行度信号。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="2ec5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们新的等级档案将被命名为<code class="fe nb nc nd mt b">popularity</code>。以下是对上述内容的细分:</p><ul class=""><li id="471f" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated">inherits="default "</li></ul><p id="f647" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这会将Vespa配置为创建一个名为popularity的新等级配置文件，它继承了所有默认的等级配置文件属性；只有显式定义或覆盖的属性才会与默认等级配置文件的属性不同。</p><ul class=""><li id="7a8e" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated">功能流行度</li></ul><p id="a3d5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就建立了一个可以从其他表达式中调用的函数。该函数计算点击数除以印象数，以表示受欢迎程度。然而，这并不是最好的计算方法，因为即使不确定性很高，一篇印象数少的文章也可以在这个值上得分很高。但这是一个开始:)</p><ul class=""><li id="1b4d" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated">第一期的</li></ul><p id="8951" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Vespa中的相关性计算分为两个阶段。第一阶段中完成的计算是对匹配查询的每个文档执行的。相比之下，第二阶段的计算仅在由第一阶段中完成的计算所确定的前n个文档上完成。我们现在只使用第一阶段。</p><ul class=""><li id="444d" class="ne nf iq kh b ki kj kl km ko ng ks nh kw ni la nj nk nl nm bi translated">表达式:nativeRank + 10 *人气</li></ul><p id="7bcc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该表达式用于对文档进行排序。在这里，默认的排名表达式—默认字段集的nativeRank被包含进来以使查询相关，而第二个术语调用popularity函数。这两个术语的加权和是每个文档的最终相关性。注意，这里的权重10是通过观察设定的。更好的方法是使用机器学习来学习这些值，我们将在未来的帖子中回到这个话题。</p><h2 id="ef15" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">重新部署应用程序</h2><p id="7b55" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">因为我们已经更改了应用程序包，所以我们需要重新部署我们的应用程序:</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="aafe" class="ls lt iq mt b gy mx my l mz na">Waiting for configuration server.<br/>Waiting for application status.<br/>Waiting for application status.<br/>Finished deployment.</span></pre><h2 id="42d0" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">使用新的流行度信号进行查询</h2><p id="4518" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">当重新部署完成时，我们可以通过使用<code class="fe nb nc nd mt b">ranking</code>参数来对匹配的文档进行排序。</p><figure class="lc ld le lf gt lg"><div class="bz fp l di"><div class="mq mr l"/></div></figure><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="2798" class="ls lt iq mt b gy mx my l mz na">{'id': 'id:news:news::N5870',<br/> 'relevance': 5.156596018746151,<br/> 'source': 'news_content',<br/> 'fields': {'sddocname': 'news',<br/>  'documentid': 'id:news:news::N5870',<br/>  'news_id': 'N5870',<br/>  'category': 'music',<br/>  'subcategory': 'musicnews',<br/>  'title': 'Country music group Alabama reschedules their Indy show until next October 2020',<br/>  'abstract': 'INDIANAPOLIS, Ind.   Fans of the highly acclaimed country music group Alabama, scheduled to play Bankers Life Fieldhouse Saturday night, will have to wait until next year to see the group. The group famous for such notable songs like "If You\'re Gonna Play in Texas", "Love In The First Degree", and "She and I", made the announcement that their 50th Anniversary Tour is being rescheduled till ...',<br/>  'url': 'https://www.msn.com/en-us/music/musicnews/country-music-group-alabama-reschedules-their-indy-show-until-next-october-2020/ar-BBWB0d7?ocid=chopendata',<br/>  'date': 20191108,<br/>  'clicks': 1,<br/>  'impressions': 2}}</span></pre><h1 id="1921" class="ns lt iq bd lu nt nu nv lx nw nx ny ma jw nz jx md jz oa ka mg kc ob kd mj oc bi translated">结论和未来工作</h1><p id="fca1" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">这篇文章提供了使用Vespa从python构建新闻搜索应用程序的一步一步的方法。我们还展示了如何部署、馈送和查询应用程序，重点介绍了排序和分组等查询功能。未来的帖子将添加用户信息，以展示我们如何将这个搜索应用程序变成由ML模型支持的推荐应用程序。</p></div></div>    
</body>
</html>