<html>
<head>
<title>A Guide to exploit Random Forest Classifier in PySpark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PySpark中随机森林分类器开发指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-guide-to-exploit-random-forest-classifier-in-pyspark-46d6999cb5db?source=collection_archive---------2-----------------------#2021-06-01">https://towardsdatascience.com/a-guide-to-exploit-random-forest-classifier-in-pyspark-46d6999cb5db?source=collection_archive---------2-----------------------#2021-06-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="efe3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">鸢尾花分类实用说明指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6296a82914ecbfb236eb205225cae9b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FIj65s952XFWEoFZ"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@ninszi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">阿德埃尔·grőber</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="9f47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将一步一步地指导你如何使用PySpark通过随机森林分类器对鸢尾花进行分类。</p><p id="05df" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我使用了流行的Iris数据集，并在文章末尾提供了数据集的链接。我使用Google Colab进行编码，我还在参考资料中提供了Colab notebook。</p><p id="2d4e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Pyspark是Apache Spark的Python API，pip是Python包的包管理器。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="677b" class="lx ly iq lt b gy lz ma l mb mc">!pip install pyspark</span></pre><p id="76ea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用上面的命令，可以使用pip安装pyspark。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="e0a3" class="lx ly iq lt b gy lz ma l mb mc">from pyspark.sql import SparkSession<br/>spark = SparkSession.builder.appName('ml-iris').getOrCreate()<br/>df = spark.read.csv('IRIS.csv', header = True, inferSchema = True)<br/>df.printSchema()</span></pre><p id="0553" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我需要为Spark中的所有功能创建一个入口点。SparkSession类用于此目的。<code class="fe md me mf lt b">SparkSession.builder()</code>创建一个基本SparkSession。使用<code class="fe md me mf lt b">appName(name)</code>为应用程序设置名称。在这里，我将“ml-iris”设置为应用程序名称。没有必要设置名称，如果没有设置，将为应用程序生成一个随机名称。<code class="fe md me mf lt b">getOrCreate()</code>如果没有现有会话，则创建新的SparkSession。否则，它将获取现有会话。</p><p id="0572" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe md me mf lt b">spark.read.csv(“path”)</code>用于将CSV文件读入Spark数据帧。数据框是一种2D数据结构，它以表格格式设置数据。Iris dataset有一个头，所以我设置了<code class="fe md me mf lt b">header = True</code>，否则API会把头当作一个数据记录。inferSchema属性与列类型相关。默认情况下，inferSchema为false。它将以字符串的形式给出所有的列。这里我设置了<code class="fe md me mf lt b">inferSchema = True</code>，所以Spark遍历文件，推断每一列的模式。<code class="fe md me mf lt b">printSchema()</code>将以树形格式打印模式。</p><p id="edbb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/d9fde5a625134f3970d50c94c4c95709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*-9ZcvZ_XE4Q4MRh_7E09OQ.png"/></div></figure><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="0fd1" class="lx ly iq lt b gy lz ma l mb mc">import pandas as pd<br/>pd.DataFrame(df.take(5), columns=df.columns).transpose()</span></pre><p id="4390" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">pandas是一个用于数据分析的工具包。这里<code class="fe md me mf lt b">df.take(5)</code>返回前5行，<code class="fe md me mf lt b">df.columns</code>返回所有列的名称。<code class="fe md me mf lt b">DataFrame.transpose()</code>转置数据帧的索引和列。它将列写成行，将行写成列。</p><p id="ef0a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mh"><img src="../Images/e0c08ab71ad354934ca247abeeec890c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*U4f1rH64zZite7S4x5j5QQ.png"/></div></div></figure><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="3604" class="lx ly iq lt b gy lz ma l mb mc">numeric_features = [t[0] for t in df.dtypes if t[1] == 'double']<br/>df.select(numeric_features).describe().toPandas().transpose()</span></pre><p id="1aaf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe md me mf lt b">df.dtypes</code>返回所有列的名称和类型。这里，我们将Double类型的列分配给numeric_features。<code class="fe md me mf lt b">select(numeric_features)</code>返回新的数据帧。<code class="fe md me mf lt b">describe()</code>计算统计数据，如列的计数、最小值、最大值、平均值，<code class="fe md me mf lt b">toPandas()</code>返回当前数据帧作为熊猫数据帧。</p><p id="a7f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/811f02492c6865b4e610843b343d37dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*If7N94QIamaRuVkKfhZdgg.png"/></div></div></figure><p id="4d3d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于我们对正在处理的数据集有了很好的了解，我们可以开始进行要素转换。特征转换意味着缩放、转换和修改特征，以便它们可以用于训练机器学习模型，从而做出更准确的预测。为此，我使用了字符串索引器和向量汇编程序。</p><p id="610c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我使用Vector Assembler将萼片长度、萼片宽度、花瓣长度和花瓣宽度组合成一个向量列。在这里，新的单一向量列称为features。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="ffe1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ml"><img src="../Images/a35633ccd6b8d9c4fd151dc9b319368c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w_YzKKPJELNgUxBzG77-Cw.png"/></div></div></figure><p id="1080" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我使用字符串索引器将物种的字符串列编码为标签索引的列。默认情况下，标签根据频率进行分配。因此，最常见的物种的指数为0。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="a2f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mm"><img src="../Images/7daec2d1983eb952d5d266d8ea7be040.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_o4M3MXZYQ_7MnKaI0Q1CQ.png"/></div></div></figure><p id="52d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，我们现在有了名为labelIndex和features的新专栏。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="314e" class="lx ly iq lt b gy lz ma l mb mc">pd.DataFrame(df.take(110), columns=df.columns).transpose()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mn"><img src="../Images/2ba26a639ddcbb33695cab14686e6c5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B9xgBW3-YNaX3H3XH38u5w.png"/></div></div></figure><p id="e258" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最下面一行是labelIndex。我们可以看到Iris-setosa的标签索引为0，Iris-versicolor的标签索引为1。Iris-virginica的labelIndex为2。</p><p id="5acb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们已经转换了我们的功能，然后我们需要将数据集分成训练和测试数据。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="0fe5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe md me mf lt b">randomSplit(</code>)将数据帧随机拆分成训练集和测试集。在这里，我为可复制性设置了种子。0.7和0.3是分割作为列表给出的数据集的权重，它们的总和应为1.0。</p><p id="55c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mo"><img src="../Images/c49cc8b4c129d8db417256a3df2c6972.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/0*aydyHQAGWR9tK8g4"/></div></div></figure><p id="34f7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们可以导入和应用随机森林分类器。随机森林是一种通过在训练阶段构建多个决策树来运行的方法。随机森林选择大多数树的决策作为最终决策。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/602d6ebba2e828ff7b41d0c1b0f8ab5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5x1avcPsURnhhcqQ"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">随机森林分类器的表示(图片由作者提供)</p></figure><p id="5e60" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它属于监督学习，主要用于分类，但也可以用于回归。随机森林分类器是有用的，</p><ol class=""><li id="75e9" class="mq mr iq ky b kz la lc ld lf ms lj mt ln mu lr mv mw mx my bi translated">不要过度拟合</li><li id="358f" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">高准确度</li><li id="d2eb" class="mq mr iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">估计缺失数据</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="9617" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里的<code class="fe md me mf lt b">featuresCol</code>是数据框的要素列表，在我们的例子中是要素列。<code class="fe md me mf lt b">labelCol</code>是目标特征，即labelIndex。<code class="fe md me mf lt b">rf.fit(train)</code>将随机森林模型拟合到我们名为train的输入数据集。<code class="fe md me mf lt b">rfModel.transform(test)</code>转换测试数据集。这将向数据框中添加新列，例如预测、原始预测和概率。</p><p id="688c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/18390b32f34f3dc31bcf3808e5922cb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w_HHCU_skkwv9tRrhMfZug.png"/></div></div></figure><p id="be0a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过下面的输出，我们可以清楚地比较实际值和预测值。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="529e" class="lx ly iq lt b gy lz ma l mb mc">predictions.select("labelIndex", "prediction").show(10)</span></pre><p id="ab05" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/28c437cdad9754f44ca969952277b6a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:478/format:webp/1*aznUE9x569jTu-OKFCp6ww.png"/></div></figure><p id="f3b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们已经将分类器应用于我们的测试数据，并且得到了预测。然后我们需要评估我们的模型。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="03ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">multi classclassificationevaluator是多类分类的赋值器。因为我们有3个类(鸢尾-Setosa，鸢尾-Versicolor，鸢尾-弗吉尼亚),我们需要多类分类评估器。方法<code class="fe md me mf lt b">evaluate()</code>用于评估分类器的性能。</p><p id="f161" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/70e602b3ebad90b6ed5378e9a83be8ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*u94NIRMEwLw81l6XMbplZA.png"/></div></figure><p id="c9e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在可以看到我们的模型精度很高，测试误差很低。这意味着我们的分类器模型表现良好。</p><p id="ec08" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以使用混淆矩阵来比较预测的鸢尾物种和实际的鸢尾物种。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="e8b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">MulticlassMetrics是pyspark mllib库中多类分类的评估器。</p><p id="ceb0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/a1f02d5401709fcc8833f107173ef143.png" data-original-src="https://miro.medium.com/v2/resize:fit:350/format:webp/1*ACMVXmsd1Cyz-FZ1z_AhyQ.png"/></div></figure><p id="21dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据混淆矩阵，在47个测试数据中有44个(12+16+16)物种被正确分类。3种被错误分类。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><p id="382b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这篇文章能帮助您学习如何使用PySpark并使用随机森林分类器完成分类任务。我在下面提供了数据集和笔记本链接。</p><p id="cd54" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">编码快乐！😀</p><h2 id="a56a" class="lx ly iq bd np nq nr dn ns nt nu dp nv lf nw nx ny lj nz oa ob ln oc od oe of bi translated">资源</h2><p id="03aa" class="pw-post-body-paragraph kw kx iq ky b kz og jr lb lc oh ju le lf oi lh li lj oj ll lm ln ok lp lq lr ij bi translated">资料组</p><div class="ol om gp gr on oo"><a href="https://www.kaggle.com/arshid/iris-flower-dataset" rel="noopener  ugc nofollow" target="_blank"><div class="op ab fo"><div class="oq ab or cl cj os"><h2 class="bd ir gy z fp ot fr fs ou fu fw ip bi translated">鸢尾花数据集</h2><div class="ov l"><h3 class="bd b gy z fp ot fr fs ou fu fw dk translated">用于多类分类的鸢尾花数据集。</h3></div><div class="ow l"><p class="bd b dl z fp ot fr fs ou fu fw dk translated">www.kaggle.com</p></div></div><div class="ox l"><div class="oy l oz pa pb ox pc kp oo"/></div></div></a></div><p id="cf98" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Colab笔记本</p><div class="ol om gp gr on oo"><a href="https://colab.research.google.com/drive/1en1X946wqbv4SC_cCLmspJa7iGL8DvYo?usp=sharing" rel="noopener  ugc nofollow" target="_blank"><div class="op ab fo"><div class="oq ab or cl cj os"><h2 class="bd ir gy z fp ot fr fs ou fu fw ip bi translated">谷歌联合实验室</h2><div class="ov l"><h3 class="bd b gy z fp ot fr fs ou fu fw dk translated">PySpark随机森林分类器</h3></div><div class="ow l"><p class="bd b dl z fp ot fr fs ou fu fw dk translated">colab.research.google.com</p></div></div><div class="ox l"><div class="pd l oz pa pb ox pc kp oo"/></div></div></a></div></div></div>    
</body>
</html>