<html>
<head>
<title>Q&amp;A for Ingesting Historical Data into SageMaker Feature Store</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将历史数据纳入SageMaker特征库的问答</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/q-a-for-ingesting-historical-data-into-sagemaker-feature-store-239e918ec594?source=collection_archive---------35-----------------------#2021-04-28">https://towardsdatascience.com/q-a-for-ingesting-historical-data-into-sagemaker-feature-store-239e918ec594?source=collection_archive---------35-----------------------#2021-04-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="626b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过直接写信给S3，回答如何将数据导入SageMaker离线功能商店的问题</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/034f4851564bf12a9c12f61117acd7ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uxaWOKiIWZgMP9NS"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">艾米丽·莫特在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="bbeb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" rel="noopener" target="_blank" href="/ingesting-historical-feature-data-into-sagemaker-feature-store-5618e41a11e6#f950-d5882f6deacb">之前的一篇博文</a>中，我展示了如何通过直接写入S3将数据导入SageMaker离线功能商店。我收到了关于高级场景的反馈和建议，我将在Q &amp; A中讨论这些反馈和建议。</p><h1 id="02ac" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">问:在要素记录具有不同时间戳的情况下，我如何获取历史数据？</h1><p id="94d7" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我通过给每个特性记录分配相同的时间戳来简化我前面的例子。然而，在真实场景中，历史特征记录更有可能具有不同的时间戳。在这种情况下，我们可以使用相同的方法，但在设置S3文件夹结构时，我们必须更复杂一点，我们必须根据时间戳分割数据集。</p><p id="db2f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们首先创建一个每个记录具有不同时间戳的要素数据集:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="e9f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此代码创建将2021年1月1日晚上8点到2021年1月2日上午10点之间的随机时间戳追加到数据集。</p><p id="7b25" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关于离线商店的S3文件夹结构的<a class="ae kv" href="https://docs.aws.amazon.com/sagemaker/latest/dg/feature-store-offline.html" rel="noopener ugc nofollow" target="_blank">文档</a>告诉我们，我们必须为这些时间戳的年、月、日和小时的每个唯一组合创建不同的文件夹。它还告诉我们，每个特性子集的文件名需要文件中最新时间戳的时间戳:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mr"><img src="../Images/5a6306bf8d65df2784b9eaedb6d5df0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BlcdYeNNy29kG55VYCllfQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">S3的命名惯例(图片由作者提供)</p></figure><p id="f8d3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为此，我们需要为数据集中的每条记录创建一个键。该键的格式为<em class="ms"> YYYY-MM-DD-HH，</em>表示该记录时间戳的年、月、日和小时。然后，我们将所有具有相同关键字的特征记录组合在一起:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/0fc466707ccc3313027d6c78d3119559.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fFL8cBW_D0dLC13_mqD6xA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">根据时间戳分割特征数据(按作者分类的图片)</p></figure><p id="812f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于每个子集，我们还需要识别相应的文件名。为此，我们需要识别每个子集内的最新时间戳。在上例中，关键字为<em class="ms">2021–01–01–22</em>的子集的文件名将以“<em class="ms"> 20210101224453 </em> _”开头，因为该子集中的最新条目来自22:44:53。</p><p id="9e16" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下代码为每个子集生成密钥以及S3路径和文件名:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="aa36" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了根据时间戳键分割数据集并将它们保存到S3的相应S3路径中，我们可以简单地利用pandas 的<a class="ae kv" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.groupby.html" rel="noopener ugc nofollow" target="_blank"> <em class="ms"> groupby() </em>方法:</a></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h2 id="299d" class="mu lt iq bd lu mv mw dn ly mx my dp mc lf mz na me lj nb nc mg ln nd ne mi nf bi translated">结论</h2><p id="3986" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在这个例子中，我们已经将带有不同时间戳的历史特征记录摄取到SageMaker离线特征存储中。我们根据特征记录时间戳分割数据，根据文档创建S3路径，并将每个子集存储在相应的S3位置。完整的例子和代码可以在<a class="ae kv" href="https://github.com/marshmellow77/sm-feature-store-backfill/blob/main/s3-backfill_different-timestamps.ipynb" rel="noopener ugc nofollow" target="_blank">这本笔记本</a>中找到。</p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><h1 id="1391" class="ls lt iq bd lu lv nn lx ly lz no mb mc jw np jx me jz nq ka mg kc nr kd mi mj bi translated">问:我对每个特性记录都有几个版本。我希望将历史功能记录导入到离线商店，但也希望将每个功能记录的最新版本与在线商店同步。我该怎么做？</h1><p id="9669" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在这种情况下，我们必须根据事件时间戳来识别每个特性记录的最新版本。然后，我们将通过将这些记录直接写入S3来回填所有比最新版本旧的版本。包含我们将使用常规摄取API摄取的最新记录的子集。最终，我们将在在线和离线功能商店中获得每条记录的最新版本。所有其他(历史)记录将仅在离线商店中可用。</p><p id="67d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们首先创建一个数据集来反映这个场景。下面的代码为每笔交易创建3条记录，每条记录都有不同的时间戳:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="2994" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果数据集有6，000条记录，每笔交易三条。现在我们想将数据分成两组:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="749c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一个子集(<em class="ms"> df_online </em>)包含每个事务的最新版本。这一个我们将使用API调用摄取。第二个子集(<em class="ms"> df_offline </em>)包含每个特征记录的旧版本。这一个我们将直接摄入S3以同样的方式在上面。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/6bdd59a63e1c04d11c36c1b30d30c56b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VIpehd5tHopWM1YREetU-g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将要素数据分为历史子集和当前子集(按作者分类的图片)</p></figure><p id="657d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为填充线下商店的代码同上，这里就不赘述了，不过你可以在这个<a class="ae kv" href="https://github.com/marshmellow77/sm-feature-store-backfill/blob/main/s3-backfill_sync-with-online-store.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本</a>里找到。我想明确指出的一个区别是，在创建功能组时，我们需要确保在线商店已启用:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="aeb3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦S3回填完成，我们就可以通过API获取每个要素记录的最新版本。这将把子集写入在线商店和离线商店:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="87e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">写入在线商店是即时的，我们可以通过调用GetRecord API立即测试它:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="9910" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过API写入离线商店需要几分钟时间。等待大约5-10分钟后，我们可以测试离线商店现在是否已正确填充:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="c235" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切正常，您应该会看到三条记录，其中两条是我们通过直接写给S3获取的，另一条是通过API获取的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/db914213c4b02028f2ce98fe51e5f4c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y2TNu6Wq7Mgm_Cj8l1K5Yw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><h2 id="9185" class="mu lt iq bd lu mv mw dn ly mx my dp mc lf mz na me lj nb nc mg ln nd ne mi nf bi translated">结论</h2><p id="f0a5" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在这一部分，我们通过直接写信给S3，将历史特征记录回填到离线商店中。我们还通过使用摄取API将当前版本的功能记录与在线商店同步。最后，我们在离线商店中有所有的特性记录，在在线商店中有最新的版本。这个例子的完整代码可以在这个<a class="ae kv" href="https://github.com/marshmellow77/sm-feature-store-backfill/blob/main/s3-backfill_sync-with-online-store.ipynb" rel="noopener ugc nofollow" target="_blank">笔记本</a>中找到。</p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><p id="a5ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢所有提供反馈和建议的人。如果您还有任何问题或反馈，请随时联系我们。</p></div></div>    
</body>
</html>