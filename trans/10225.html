<html>
<head>
<title>Using MLFlow to Track and Version Machine Learning Models</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MLFlow跟踪和版本化机器学习模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-mlflow-to-track-and-version-machine-learning-models-efd5daa08df0?source=collection_archive---------11-----------------------#2021-09-28">https://towardsdatascience.com/using-mlflow-to-track-and-version-machine-learning-models-efd5daa08df0?source=collection_archive---------11-----------------------#2021-09-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f3c3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">循序渐进的编码实践</h2></div><p id="2836" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我们调整机器学习模型的参数时，我们可能需要多次训练它，以便选择最佳模型。如果训练次数过多，我们可能会遇到两个问题。</p><ul class=""><li id="32e1" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld lj lk ll lm bi translated">我们如何跟踪每个模型的参数和度量？将它们手动写入excel文件？那将是乏味且容易出错的。</li><li id="4c2a" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">我们如何对每个模型进行版本控制？用不同的名字保存到磁盘上？很难记住哪个模型来自什么参数。</li></ul><p id="324a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae ls" href="https://mlflow.org/" rel="noopener ugc nofollow" target="_blank"> MLFlow </a>正是我们解决这些问题所需要的。它是一个强大的MLOps工具，用于ML模型跟踪、版本控制、打包等等。在这篇博客中，我们将关注跟踪和版本控制。关于跟踪，MLFlow可以跟踪参数、度量和模型。关于版本控制，MLFlow将模型存储在一个模型注册表中，然后用户可以很容易地选择一个特定的版本。</p><p id="a472" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">MLFlow可以在本地运行或从docker容器运行，也可以部署到kubernetes。它有Python、Java、R和REST的API。</p><p id="466b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇博客中，我们将展示如何使用mlflow来跟踪和版本化mnist分类模型。我们将首先使用tensorflow运行一个MNIST示例，然后扩展代码以集成mlflow。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi lt"><img src="../Images/efaf51cb954836a5dd168a3292756d12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sUS_ixOiZB8vjikT"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">图片来自<a class="ae ls" href="https://unsplash.com/photos/6EnTPvPPL6I" rel="noopener ugc nofollow" target="_blank">Unsplash</a>is AAC Smith</p></figure><p id="0000" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> MNIST的例子</strong></p><p id="a554" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先创建一个虚拟环境，pip安装tensorflow和mlflow。</p><pre class="lu lv lw lx gt mj mk ml mm aw mn bi"><span id="9e89" class="mo mp it mk b gy mq mr l ms mt"># my version is 2.6.0<br/>pip install tensorflow<br/># my version is 4.4.0<br/>pip install tensorflow_datasets<br/># my version is 1.9.1<br/>pip install mlflow</span></pre><p id="4245" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是使用tensorflow运行mnist分类的代码。</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="mu mv l"/></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">张量流中的MNIST分类</p></figure><p id="1d60" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行代码，您应该会看到如下所示的日志。它还将模型保存在模型文件夹中。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi mw"><img src="../Images/9586950911ba0d3ba785ecefa24380ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eF-6lUmQ_8MZtT0MllM5GA.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">mnist.py的日志(图片由作者提供)</p></figure><p id="edfb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">物流跟踪</strong></p><p id="7442" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，让我们跟踪参数、度量以及工件(模型)。见下面的代码，(也见底部的完整代码)。首先，我们需要命名一次跑步。如果我们愿意，我们甚至可以命名一个实验(更高级别的运行)。然后，我们使用函数<code class="fe mx my mz mk b">log_param</code>、<code class="fe mx my mz mk b">log_metric</code>和<code class="fe mx my mz mk b">log_artifacts</code>来记录参数、度量和工件。</p><pre class="lu lv lw lx gt mj mk ml mm aw mn bi"><span id="d71c" class="mo mp it mk b gy mq mr l ms mt">import mlflow</span><span id="f457" class="mo mp it mk b gy na mr l ms mt">with mlflow.start_run(run_name=run_name):<br/>  mlflow.log_param("batch_size", batch_size)<br/>  mlflow.log_param("learning_rate", learning_rate)<br/>  mlflow.log_param("epochs", epochs)<br/>  mlflow.log_metric("train_loss", train_loss)<br/>  mlflow.log_metric("train_accuracy", train_acc)<br/>  mlflow.log_metric("val_loss", val_loss)<br/>  mlflow.log_metric("val_accuracy", val_acc)<br/>  mlflow.log_artifacts("./model")</span></pre><p id="f8ff" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行mlflow代码后，我们可以看到磁盘中有一个名为<code class="fe mx my mz mk b">mlruns </code>的新文件夹。这是本地存储参数、指标和工件的地方。</p><p id="f7a7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们可以做一些参数调整，例如，改变批量大小和学习速率。每次运行都将被记录到mlflow中。</p><p id="fb66" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，让我们在mlflow的UI上查看所有运行。在虚拟环境中，键入:</p><pre class="lu lv lw lx gt mj mk ml mm aw mn bi"><span id="be78" class="mo mp it mk b gy mq mr l ms mt">mlflow ui</span></pre><p id="601e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，在<a class="ae ls" href="http://localhost:5000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:5000/ </a>浏览。我们可以看到所有运行都记录在那里。在一个页面上可以清楚地看到参数、指标和运行名称。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi nb"><img src="../Images/fef65f378e8f9a961be9aa6ad03b1d8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nEfih3DZWy7Pb3gPWFoc0g.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">在mlflow追踪上运行(图片由作者提供)</p></figure><p id="8749" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们点击一次跑步，我们可以看到关于这次跑步的更多细节。除了参数和度量，左下方的工件部分显示了我们的工件(模型)。</p><figure class="lu lv lw lx gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="gh gi nc"><img src="../Images/1c7898a023d9a8d7e29d54dc376dba7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wDRNhVzatnR3vsf6jdpEdA.png"/></div></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">mlflow运行的详细信息(图片由作者提供)</p></figure><p id="5eb8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每次运行的url地址具有以下格式。每个实验中的运行id都是唯一的。</p><pre class="lu lv lw lx gt mj mk ml mm aw mn bi"><span id="be67" class="mo mp it mk b gy mq mr l ms mt">http://localhost:5000/#/experiments/&lt;experiment id&gt;/runs/&lt;run id&gt;</span></pre><p id="7bc9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu"> MLFlow模型版本化</strong></p><p id="2979" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">MLflow Model Registry是存储和版本化模型的中心位置。有了它，一个模型就有了从(例如)v1，v2，…到v10的迭代版本。对于每个模型和版本，我们可以写一个降价描述(例如详细的参数),这样我们以后就知道这个模型代表了什么。此外，我们可以用<code class="fe mx my mz mk b">Staging</code>、<code class="fe mx my mz mk b">Production</code>或<code class="fe mx my mz mk b">Archived</code>来标记一个版本。</p><p id="61eb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了建立模型注册，我们需要一个数据库后端来存储模型，参见这里的<a class="ae ls" href="https://www.mlflow.org/docs/latest/tracking.html#id12" rel="noopener ugc nofollow" target="_blank">获取说明</a>。之后，我们可以将tensorflow模型上传到mlflow注册表。下面是一个代码示例。</p><pre class="lu lv lw lx gt mj mk ml mm aw mn bi"><span id="f14d" class="mo mp it mk b gy mq mr l ms mt">import mlflow.tensorflow<br/>from tensorflow.python.saved_model import signature_constants</span><span id="425e" class="mo mp it mk b gy na mr l ms mt">tag=[tf.saved_model.tag_constants.SERVING]<br/>key=signature_constants.DEFAULT_SERVING_SIGNATURE_DEF_KEY</span><span id="0e0c" class="mo mp it mk b gy na mr l ms mt">mlflow.tensorflow.log_model(tf_saved_model_dir="./model",<br/>                            tf_meta_graph_tags=tag,<br/>                            tf_signature_def_key=key,<br/>                            artifact_path="model",<br/>                            registered_model_name="mnist")</span></pre><p id="b966" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">总之，MLFlow是一个强大的MLOps工具，用于跟踪和版本化机器学习模型。它支持python、java、R等语言的API。通过其漂亮的用户界面，我们可以清楚地跟踪、存储和比较不同的模型版本。MLFlow已经成为许多ML项目中流行的MLOps工具。</p><p id="2f36" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是tensorflow中带有mlflow跟踪的mnist分类的完整代码。</p><figure class="lu lv lw lx gt ly"><div class="bz fp l di"><div class="mu mv l"/></div><p class="mf mg gj gh gi mh mi bd b be z dk translated">张量流中MNIST分类的完整代码</p></figure></div></div>    
</body>
</html>