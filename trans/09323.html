<html>
<head>
<title>Data has many periodic components you need to visualize? Treat it like audio!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据有许多需要可视化的周期性成分？把它当成音频！</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/data-has-many-periodic-components-you-need-to-visualize-treat-it-like-audio-dd9569e2a774?source=collection_archive---------17-----------------------#2021-08-29">https://towardsdatascience.com/data-has-many-periodic-components-you-need-to-visualize-treat-it-like-audio-dd9569e2a774?source=collection_archive---------17-----------------------#2021-08-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="65f1" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/tips-and-tricks" rel="noopener" target="_blank">提示和技巧</a></h2><div class=""/><div class=""><h2 id="b874" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">使用傅立叶变换可视化周期性分量。</h2></div><p id="e978" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">您正在处理时间序列数据，并且处于初始发现阶段。你试图找出数据随时间变化的所有不同方式。可能存在趋势，即数据随时间不断增加或减少。可能有完全随机的变化。并且可能存在以某些固定周期随时间上下变化的循环分量。</p><p id="3ce7" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果只有一个周期分量，这可能很容易在数据中看到，你甚至可以直观地估计它的周期。但是如果有多个周期分量，每个都有自己的周期呢？如果数据具有超过3个(有时超过2个)周期分量，简单的绘图通常没有用。</p><p id="fabd" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">有没有什么方法可以确保你已经识别出所有的周期性成分，每一个都有不同的周期，以及它们自己的趋势和随时间的变化，并将它们可视化？那个东西其实是存在的，它叫声谱图，是信号处理中一个很好理解的话题。由于您正在处理时间序列数据，因此信号处理中使用的许多技术都应该适用，因为信号(音频、天体物理学等)本质上是时间序列数据，其中每个观察值都有一个时间戳和值。</p><p id="f76d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">让我们来看看如何制作声谱图。</p><h1 id="52b3" class="lk ll iq bd lm ln lo lp lq lr ls lt lu kf lv kg lw ki lx kj ly kl lz km ma mb bi translated">傅立叶变换</h1><p id="1187" class="pw-post-body-paragraph ko kp iq kq b kr mc ka kt ku md kd kw kx me kz la lb mf ld le lf mg lh li lj ij bi translated">其数学基础被称为傅立叶变换。简而言之，如果您的信号有周期成分，FT是用于从信号中提取其频率(或周期)的数学过程。</p><div class="mh mi gp gr mj mk"><a href="https://en.wikipedia.org/wiki/Fourier_transform" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd ja gy z fp mp fr fs mq fu fw iz bi translated">傅立叶变换-维基百科</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">在数学中，傅立叶变换(FT)是一种数学变换，它根据空间或时间分解函数</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">en.wikipedia.org</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my mz mk"/></div></div></a></div><p id="b5f2" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">对信号中的时间间隔(一个窗口或一段时间)应用一次FT，可以得到该窗口内的周期分量。如果您将窗口移动到信号中的不同位置，并再次应用FT，您将获得该窗口中的周期分量。重复这个过程很多次，每次只移动窗口一点点，就会描绘出周期成分如何随时间演化的画面(如果有的话)。</p><h1 id="4a85" class="lk ll iq bd lm ln lo lp lq lr ls lt lu kf lv kg lw ki lx kj ly kl lz km ma mb bi translated">来自音频的教训</h1><p id="c500" class="pw-post-body-paragraph ko kp iq kq b kr mc ka kt ku md kd kw kx me kz la lb mf ld le lf mg lh li lj ij bi translated">在音频处理中，这种技术使用非常频繁。捕捉音频的一个小时间窗口并对其应用FT将揭示当时信号的“频谱”或音频的一组频率成分。</p><p id="1045" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这是我不久前开始的一个项目，目标是构建任何音频文件的声谱图(周期成分随时间的演变):</p><div class="mh mi gp gr mj mk"><a href="https://github.com/FlorinAndrei/soundspec" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab fo"><div class="mm ab mn cl cj mo"><h2 class="bd ja gy z fp mp fr fs mq fu fw iz bi translated">信号处理:音频文件的频谱可视化；使用…</h2><div class="mr l"><h3 class="bd b gy z fp mp fr fs mq fu fw dk translated">音频文件的频谱可视化；使用傅立叶变换需要Python 3和一些典型的数字运算…</h3></div><div class="ms l"><p class="bd b dl z fp mp fr fs mq fu fw dk translated">github.com</p></div></div><div class="mt l"><div class="na l mv mw mx mt my mz mk"/></div></div></a></div><p id="f484" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果你从电影<a class="ae nb" href="https://www.imdb.com/title/tt0468569/" rel="noopener ugc nofollow" target="_blank">《黑暗骑士</a>中选取歌曲<a class="ae nb" href="https://www.youtube.com/watch?v=1zyhQjJ5UgY" rel="noopener ugc nofollow" target="_blank"> Why So Serious </a>(小丑主题)，并对其应用soundspec，这就是你得到的声谱图:</p><figure class="nd ne nf ng gt nh gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi nc"><img src="../Images/2d7abef47826e133bbb71808a564655c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AvumJaY_ut2ppY5kFgWcig.png"/></div></div><p class="nn no gj gh gi np nq bd b be z dk translated">(图片由作者提供)</p></figure><p id="55ba" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在水平轴上，有时间。纵轴是频率。请注意，周期和频率是成反比的，所以周期= 1 /频率。颜色表示振幅，黄色表示高振幅，蓝色表示低振幅或零振幅。</p><p id="8d81" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">你可以看到在200到400秒之间有非常强的周期成分，频率约为30 … 40 Hz，因此周期为0.033 … 0.025秒(你可以在歌曲中听到这是一条强有力的低音线)。还有许多其他周期性成分散布在声谱图中——音乐通常非常复杂。</p><h1 id="341d" class="lk ll iq bd lm ln lo lp lq lr ls lt lu kf lv kg lw ki lx kj ly kl lz km ma mb bi translated">返回数据</h1><p id="cb80" class="pw-post-body-paragraph ko kp iq kq b kr mc ka kt ku md kd kw kx me kz la lb mf ld le lf mg lh li lj ij bi translated">让我们来看看这个数据集:</p><p id="b101" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><a class="ae nb" href="https://github.com/FlorinAndrei/misc/blob/master/fft_data.p?raw=true" rel="noopener ugc nofollow" target="_blank">https://github . com/FlorinAndrei/misc/blob/master/FFT _ data . p？raw=true </a></p><p id="2057" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">初始化所有库:</p><pre class="nd ne nf ng gt nr ns nt nu aw nv bi"><span id="d933" class="nw ll iq ns b gy nx ny l nz oa">import pandas as pd<br/>from matplotlib import pyplot as plt<br/>from scipy import signal<br/>import numpy as np<br/>import os<br/>import pickle</span><span id="6250" class="nw ll iq ns b gy ob ny l nz oa">plt.rcParams["figure.figsize"] = (16, 9)</span></pre><p id="f754" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">绘制数据集:</p><pre class="nd ne nf ng gt nr ns nt nu aw nv bi"><span id="8eaf" class="nw ll iq ns b gy nx ny l nz oa">if os.path.isfile('fft_data.p'):<br/>    dt = pickle.load(open('fft_data.p', 'rb'))<br/>plt.plot(dt);</span></pre><figure class="nd ne nf ng gt nh gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi oc"><img src="../Images/40fd989a0e5d38bff20ac97d1db16f0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZRzgM0Ht_09IbbLyzoc5BQ.png"/></div></div><p class="nn no gj gh gi np nq bd b be z dk translated">(图片由作者提供)</p></figure><p id="3ecb" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">第一部分有些明显，有一个周期成分，还有一些噪声。但是剩下的就变得相当复杂了。里面有多个周期成分吗？如果有，她们的经期是什么时候？他们有多少人？就对信号的贡献而言，它们在时间上是恒定的，还是变化的？</p><p id="f604" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">SciPy库有一个名为<code class="fe od oe of ns b">signal.spectrogram()</code>的函数，可以生成这个数据集/信号的谱图。让我们应用它:</p><pre class="nd ne nf ng gt nr ns nt nu aw nv bi"><span id="1c77" class="nw ll iq ns b gy nx ny l nz oa">f, t, Sxx = signal.spectrogram(dt, 1)<br/>plt.pcolormesh(t, f, np.log10(Sxx), shading='auto');</span></pre><figure class="nd ne nf ng gt nh gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi og"><img src="../Images/4c856fd918cbbb3319b662682a967efb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bq4jj7Du8R-cKnX2kHYtOA.png"/></div></div><p class="nn no gj gh gi np nq bd b be z dk translated">(图片由作者提供)</p></figure><p id="927c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如您所见，傅里叶变换对整个数据集应用了4次，生成了4组光谱。从黄色的位置可以很清楚地看出，所有的活动都发生在底部，低频的地方(短周期的地方)。</p><p id="6543" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们只保留声谱图底部的1/5放大，其余的可以忽略:</p><pre class="nd ne nf ng gt nr ns nt nu aw nv bi"><span id="d5dc" class="nw ll iq ns b gy nx ny l nz oa">f, t, Sxx = signal.spectrogram(dt, 1)<br/>frac = len(f) // 5<br/>fshort = f[0:frac]<br/>Sshort = Sxx[0:frac]<br/>per = np.rint(1 / fshort).astype(int)<br/>plt.pcolormesh(t, fshort, np.log10(Sshort), shading='auto');</span></pre><figure class="nd ne nf ng gt nh gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi oh"><img src="../Images/1fbf8119e397db15afce6946fbf13636.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a7eUNsjN3ePbNkrRPk8FmQ.png"/></div></div><p class="nn no gj gh gi np nq bd b be z dk translated">(图片由作者提供)</p></figure><p id="572d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">那更好。您可能已经开始怀疑可能有3个周期成分，一个(具有最高频率)在间隔的中心是重要的，另一个(具有中间频率)在间隔的后半部分，第三个(具有低频率)似乎在任何地方都是相同的。</p><p id="94bd" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们需要在时间和频率上提高图像的分辨率。为此，我们将通过<code class="fe od oe of ns b">signal.spectrogram()</code>的<code class="fe od oe of ns b">nperseg</code>参数为时间窗口定义一个固定的大小。我们还将通过<code class="fe od oe of ns b">noverlap</code>参数最大化连续窗口之间的重叠:如果<code class="fe od oe of ns b">noverlap = nperseg-1</code>将第一个窗口应用于信号的最左边部分，那么它将向右移动1个像素，再次应用，再次移动1个像素，以此类推。</p><pre class="nd ne nf ng gt nr ns nt nu aw nv bi"><span id="0474" class="nw ll iq ns b gy nx ny l nz oa">nseg = 200<br/>f, t, Sxx = signal.spectrogram(dt, 1, nperseg=nseg, noverlap=nseg-1)<br/>frac = len(f) // 5<br/>fshort = f[0:frac]<br/>Sshort = Sxx[0:frac]<br/>per = np.rint(1 / fshort).astype(int)<br/>plt.pcolormesh(t, fshort, np.log10(Sshort), shading='auto');</span></pre><figure class="nd ne nf ng gt nh gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi oi"><img src="../Images/30206126182ab3837fde0d856d0923f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RX90FgM2lTWvGu4zNpPx3w.png"/></div></div><p class="nn no gj gh gi np nq bd b be z dk translated">(图片由作者提供)</p></figure><p id="79e9" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">好多了。很明显，有3个周期成分。频率最低的一个在整个数据集中是恒定的，可能就是我们在原图中看到的那个——图像左三分之一的上下波动。其他两个组成部分随时间变化——这解释了为什么最后三分之二的情节不同。</p><p id="b38d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">让我们使用更大的窗口(400点)再次放大:</p><pre class="nd ne nf ng gt nr ns nt nu aw nv bi"><span id="3468" class="nw ll iq ns b gy nx ny l nz oa">nseg = 400<br/>f, t, Sxx = signal.spectrogram(dt, 1, nperseg=nseg, noverlap=nseg-1)<br/>frac = len(f) // 5<br/>fshort = f[0:frac]<br/>Sshort = Sxx[0:frac]<br/>per = np.rint(1 / fshort).astype(int)<br/>plt.pcolormesh(t, fshort, np.log10(Sshort), shading='auto');</span></pre><figure class="nd ne nf ng gt nh gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi oh"><img src="../Images/21d11e41e67e285856a3ab97c5969c53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LuoAagpLopKaHQ-tlbkSnA.png"/></div></div><p class="nn no gj gh gi np nq bd b be z dk translated">(图片由作者提供)</p></figure><p id="d599" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这可能是最好的了。请记住，这里有一些权衡:为了提高分辨率，您需要一个大窗口，同时也要正确检测长周期信号。但是增加窗口会丢失图像左右两端的数据点——大窗口无法“足够接近”边缘以进行分析。看看横轴是如何随着窗口变大而变短的。</p><p id="44ea" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在纵轴上，我们把频率转换成周期。让我们给图像添加一个网格。最后，让我们平滑图像，使它看起来更好(通过<code class="fe od oe of ns b">plt.pcolormesh()</code>的<code class="fe od oe of ns b">shading</code>参数)。</p><pre class="nd ne nf ng gt nr ns nt nu aw nv bi"><span id="9cb0" class="nw ll iq ns b gy nx ny l nz oa">nseg = 400<br/>f, t, Sxx = signal.spectrogram(dt, 1, nperseg=nseg, noverlap=nseg-1)<br/>frac = len(f) // 5<br/>fshort = f[0:frac]<br/>Sshort = Sxx[0:frac]<br/>per = np.rint(1 / fshort).astype(int)</span><span id="9cca" class="nw ll iq ns b gy ob ny l nz oa">plt.yticks(ticks=fshort[::2], labels=per[::2])<br/>plt.ylabel('period')<br/>plt.xlabel('obs')<br/>plt.pcolormesh(t, fshort, np.log10(Sshort), shading='gouraud')<br/>plt.grid(True)<br/>plt.show()</span></pre><figure class="nd ne nf ng gt nh gh gi paragraph-image"><div role="button" tabindex="0" class="ni nj di nk bf nl"><div class="gh gi oj"><img src="../Images/53a556bc7e8a346e21e474dcfb367130.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gl_PNOz8bY_aUSLQtgGqWA.png"/></div></div><p class="nn no gj gh gi np nq bd b be z dk translated">(图片由作者提供)</p></figure><p id="c4f8" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">现在很清楚了:有一个分量的周期是100个点，在整个数据集中是恒定的。还有一个50分周期的成分，只在后半段有关系。还有第三个成分，周期为25个点，在数据集的中间很强，但在极端情况下很弱。</p><p id="b030" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">数据集实际上是合成的。这是用于生成它的代码，在这里您可以看到分量、它们的频率以及它们的可变幅度:</p><pre class="nd ne nf ng gt nr ns nt nu aw nv bi"><span id="f0c4" class="nw ll iq ns b gy nx ny l nz oa">N = 1000<br/>dt = np.zeros(N)<br/>np.random.seed(0)</span><span id="beb3" class="nw ll iq ns b gy ob ny l nz oa">for t in range(N):<br/>    dt[t] += 50 * np.random.randn()<br/>    <br/>    a1 = 429 * np.exp(-((t - N / 2) / (N / 10)) ** 2)<br/>    p1 = 25<br/>    s1 = p1 / 5<br/>    dt[t] += a1 * np.sin(2 * np.pi * t / p1 + s1)<br/>    <br/>    a2 = 212 * (np.tanh(5 * (2 * t / N - 1)) + 1)<br/>    p2 = 50<br/>    s2 = p2 / 7<br/>    dt[t] += a2 * np.sin(2 * np.pi * t / p2 + s2 + np.random.randn() / 2)<br/>    <br/>    a3 = 375<br/>    p3 = 100<br/>    s3 = p3 / 4<br/>    dt[t] += a3 * np.sin(2 * np.pi * t / p3 + s3 + np.random.randn() / 10)</span><span id="f102" class="nw ll iq ns b gy ob ny l nz oa">pickle.dump(dt, open('fft_data.p', 'wb'))</span></pre><p id="5222" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">具有最短周期的分量具有按照高斯曲线随时间变化的幅度。中间分量的幅度随时间以双曲正切的形式变化。</p><h1 id="0d1a" class="lk ll iq bd lm ln lo lp lq lr ls lt lu kf lv kg lw ki lx kj ly kl lz km ma mb bi translated">最后的想法</h1><p id="e17a" class="pw-post-body-paragraph ko kp iq kq b kr mc ka kt ku md kd kw kx me kz la lb mf ld le lf mg lh li lj ij bi translated">如果数据没有间隙，并且时间维度是均匀的，傅立叶变换就可以很好地工作。否则，您将不得不估算缺失的数据点，填补空白，确保时间维度表现良好。</p><p id="faf9" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">包含本文中使用的所有代码的笔记本在这里:</p><p id="f230" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated"><a class="ae nb" href="https://github.com/FlorinAndrei/misc/blob/master/fft.ipynb" rel="noopener ugc nofollow" target="_blank">https://github.com/FlorinAndrei/misc/blob/master/fft.ipynb</a></p><p id="29f1" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">感谢阅读！</p></div></div>    
</body>
</html>