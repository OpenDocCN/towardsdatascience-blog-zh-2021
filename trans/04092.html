<html>
<head>
<title>Efficiently Streaming a Large AWS S3 File via S3 Select</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">é€šè¿‡S3é€‰æ‹©æœ‰æ•ˆåœ°ä¼ è¾“å¤§å‹AWS S3æ–‡ä»¶</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://towardsdatascience.com/efficiently-streaming-a-large-aws-s3-file-via-s3-select-85f7fbe22e46?source=collection_archive---------32-----------------------#2021-04-06">https://towardsdatascience.com/efficiently-streaming-a-large-aws-s3-file-via-s3-select-85f7fbe22e46?source=collection_archive---------32-----------------------#2021-04-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="b0ff" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/making-sense-of-big-data" rel="noopener" target="_blank">ç†è§£å¤§æ•°æ®</a></h2><div class=""/><div class=""><h2 id="31ad" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">ä½¿ç”¨AWS S3é€‰æ‹©å°†ä¸€ä¸ªå¤§çš„S3æ–‡ä»¶æµå¼å¤„ç†æˆæ˜“äºç®¡ç†çš„å—ï¼Œè€Œä¸éœ€è¦å°†æ•´ä¸ªæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/7d58fe2467eb2417f01101225250e6e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*No9IFtySUvJLQuoA6mG_gQ.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">åœ¨<a class="ae le" href="https://undraw.co/license" rel="noopener ugc nofollow" target="_blank">å…¬å…±è®¸å¯</a>ä¸‹<a class="ae le" href="https://undraw.co/" rel="noopener ugc nofollow" target="_blank">è§£å‹ç¼©</a>ç”Ÿæˆçš„å›¾åƒ</p></figure><p id="826a" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">AWS S3æ˜¯è¡Œä¸šé¢†å…ˆçš„å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚æˆ‘ä»¬å€¾å‘äºåœ¨S3ä¸Šå­˜å‚¨å¤§é‡æ•°æ®æ–‡ä»¶ï¼Œæœ‰æ—¶éœ€è¦å¤„ç†è¿™äº›æ–‡ä»¶ã€‚å¦‚æœæˆ‘ä»¬æ­£åœ¨å¤„ç†çš„æ–‡ä»¶å¾ˆå°ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥é‡‡ç”¨ä¼ ç»Ÿçš„æ–‡ä»¶å¤„ç†æµç¨‹ï¼Œä»S3è·å–æ–‡ä»¶ï¼Œç„¶åé€è¡Œå¤„ç†ã€‚ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œå¦‚æœæ–‡ä»¶çš„å¤§å°æ¯”ã€‚<code class="fe mb mc md me b">&gt; 1GB</code>ï¼ŸğŸ˜“</p><p id="5965" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">å¯¼å…¥(è¯»å–)å¤§æ–‡ä»¶å¯¼è‡´<code class="fe mb mc md me b">Out of Memory</code>é”™è¯¯ã€‚å®ƒè¿˜ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚æœ‰å›¾ä¹¦é¦†å³ã€‚<a class="ae le" href="https://pandas.pydata.org/docs/" rel="noopener ugc nofollow" target="_blank">ç†ŠçŒ«</a>ã€<a class="ae le" href="https://docs.dask.org/en/latest/" rel="noopener ugc nofollow" target="_blank">è¾¾æ–¯å…‹</a>ç­‰ã€‚éå¸¸æ“…é•¿å¤„ç†å¤§æ–‡ä»¶ï¼Œä½†åŒæ ·çš„æ–‡ä»¶æ˜¯åœ¨æœ¬åœ°ï¼Œå³æˆ‘ä»¬å°†ä¸å¾—ä¸ä»S3è¿›å£åˆ°æˆ‘ä»¬çš„æœ¬åœ°æœºå™¨ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¸æƒ³åœ¨æœ¬åœ°è·å–å’Œå­˜å‚¨æ•´ä¸ªS3æ–‡ä»¶å‘¢ï¼ŸğŸ¤”</p><p id="c809" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">ğŸ“œ<strong class="lh ja">è®©æˆ‘ä»¬è€ƒè™‘ä¸€äº›ç”¨ä¾‹:</strong></p><ul class=""><li id="6477" class="mf mg iq lh b li lj ll lm lo mh ls mi lw mj ma mk ml mm mn bi translated">æˆ‘ä»¬å¸Œæœ›æ¯å¤©å¤„ç†ä¸€ä¸ªå¤§çš„CSV S3æ–‡ä»¶(~2GB)ã€‚å®ƒå¿…é¡»åœ¨ä¸€å®šçš„æ—¶é—´èŒƒå›´å†…å¤„ç†(å¦‚4å°æ—¶)</li><li id="bfaf" class="mf mg iq lh b li mo ll mp lo mq ls mr lw ms ma mk ml mm mn bi translated">æˆ‘ä»¬éœ€è¦å®šæœŸå¤„ç†æ¥è‡ªFTPæœåŠ¡å™¨çš„å¤§å‹S3æ–‡ä»¶ã€‚æ–°æ–‡ä»¶ä»¥ç‰¹å®šçš„æ—¶é—´é—´éš”å‡ºç°ï¼Œå¹¶è¢«é¡ºåºå¤„ç†ï¼Œå³åœ¨å¼€å§‹å¤„ç†æ–°æ–‡ä»¶ä¹‹å‰å¿…é¡»å¤„ç†æ—§æ–‡ä»¶ã€‚</li></ul><p id="1820" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">è¿™äº›æ˜¯ä¸€äº›éå¸¸å¥½çš„åœºæ™¯ï¼Œå…¶ä¸­æœ¬åœ°å¤„ç†å¯èƒ½ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“æµç¨‹ã€‚æ­¤å¤–ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å®¹å™¨ä¸­è¿è¡Œè¿™äº›æ–‡ä»¶å¤„ç†å•å…ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çš„ç£ç›˜ç©ºé—´æ˜¯æœ‰é™çš„ã€‚å› æ­¤ï¼Œéœ€è¦ä¸€ä¸ªäº‘æµå¼ä¼ è¾“æµ(å®ƒè¿˜å¯ä»¥é€šè¿‡åœ¨å¹¶è¡Œçº¿ç¨‹/è¿›ç¨‹ä¸­æµå¼ä¼ è¾“åŒä¸€æ–‡ä»¶çš„ä¸åŒå—æ¥<code class="fe mb mc md me b">parallelize the processing of multiple chunks</code>åŒä¸€æ–‡ä»¶)ã€‚è¿™å°±æ˜¯æˆ‘å¶ç„¶å‘ç°<code class="fe mb mc md me b">AWS S3 Select</code>åŠŸèƒ½çš„åœ°æ–¹ã€‚ğŸ˜</p><p id="ea61" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">ğŸ“è¿™ç¯‡æ–‡ç« å…³æ³¨çš„æ˜¯å°†ä¸€ä¸ªå¤§æ–‡ä»¶åˆ†æˆæ›´å°çš„å¯ç®¡ç†çš„å—(æŒ‰é¡ºåº)ã€‚ç„¶åï¼Œé€šè¿‡åœ¨å¹¶å‘çº¿ç¨‹/è¿›ç¨‹ä¸­è¿è¡Œï¼Œè¿™ç§æ–¹æ³•å¯ç”¨äºå¹¶è¡Œå¤„ç†ã€‚æŸ¥çœ‹æˆ‘åœ¨è¿™ä¸ªä¸Šçš„<a class="ae le" rel="noopener" target="_blank" href="/parallelize-processing-a-large-aws-s3-file-d43a580cea3">ä¸‹ä¸€ç¯‡å¸–å­ã€‚</a></p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="ed71" class="na nb iq bd nc nd ne nf ng nh ni nj nk kf nl kg nm ki nn kj no kl np km nq nr bi translated">S3ç²¾é€‰</h1><p id="c16c" class="pw-post-body-paragraph lf lg iq lh b li ns ka lk ll nt kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">ä½¿ç”¨<code class="fe mb mc md me b">Amazon S3 Select</code>ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç®€å•çš„ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€(SQL)è¯­å¥æ¥è¿‡æ»¤äºšé©¬é€ŠS3å¯¹è±¡çš„å†…å®¹ï¼Œå¹¶åªæ£€ç´¢æ‚¨éœ€è¦çš„æ•°æ®å­é›†ã€‚ä½¿ç”¨<code class="fe mb mc md me b">Amazon S3 Select</code>è¿‡æ»¤è¿™äº›æ•°æ®ï¼Œæ‚¨å¯ä»¥å‡å°‘äºšé©¬é€ŠS3ä¼ è¾“çš„æ•°æ®é‡ï¼Œé™ä½æ£€ç´¢è¿™äº›æ•°æ®çš„æˆæœ¬å’Œå»¶è¿Ÿã€‚</p><p id="bbde" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">Amazon S3 Selecté€‚ç”¨äºä»¥CSVã€JSONæˆ–Apache Parquetæ ¼å¼å­˜å‚¨çš„å¯¹è±¡ã€‚å®ƒè¿˜å¯ä»¥å¤„ç†ç”¨GZIPæˆ–BZIP2å‹ç¼©çš„å¯¹è±¡(ä»…é€‚ç”¨äºCSVå’ŒJSONå¯¹è±¡)å’ŒæœåŠ¡å™¨ç«¯åŠ å¯†çš„å¯¹è±¡ã€‚æ‚¨å¯ä»¥å°†ç»“æœçš„æ ¼å¼æŒ‡å®šä¸ºCSVæˆ–JSONï¼Œå¹¶ä¸”å¯ä»¥ç¡®å®šå¦‚ä½•åˆ†éš”ç»“æœä¸­çš„è®°å½•ã€‚</p><p id="172f" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">ğŸ“æˆ‘ä»¬å°†ä½¿ç”¨Python <code class="fe mb mc md me b">boto3</code>æ¥å®Œæˆæˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡ã€‚</p><h1 id="8532" class="na nb iq bd nc nd nx nf ng nh ny nj nk kf nz kg nm ki oa kj no kl ob km nq nr bi translated">ğŸ§±æ„é€ SQLè¡¨è¾¾å¼</h1><p id="ea7f" class="pw-post-body-paragraph lf lg iq lh b li ns ka lk ll nt kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">ä¸ºäº†é…åˆ<code class="fe mb mc md me b">S3 Select</code>ï¼Œ<code class="fe mb mc md me b">boto3</code>æä¾›äº†<a class="ae le" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.select_object_content" rel="noopener ugc nofollow" target="_blank">select _ object _ content()</a>å‡½æ•°æ¥æŸ¥è¯¢S3ã€‚æ‚¨åœ¨è¯·æ±‚ä¸­å°†SQLè¡¨è¾¾å¼ä¼ é€’ç»™äºšé©¬é€ŠS3ã€‚<code class="fe mb mc md me b">Amazon S3 Select</code>æ”¯æŒSQLçš„å­é›†ã€‚<a class="ae le" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-glacier-select-sql-reference.html" rel="noopener ugc nofollow" target="_blank">æŸ¥çœ‹æ­¤é“¾æ¥ï¼Œäº†è§£å…³äºæ­¤</a>çš„æ›´å¤šä¿¡æ¯ã€‚</p><pre class="kp kq kr ks gt oc me od oe aw of bi"><span id="aa94" class="og nb iq me b gy oh oi l oj ok">response = s3_client.select_object_content(<br/>    Bucket=bucket,<br/>    Key=key,<br/>    ExpressionType='SQL',<br/>    Expression='SELECT * FROM S3Object',<br/>    InputSerialization={<br/>        'CSV': {<br/>            'FileHeaderInfo': 'USE',<br/>            'FieldDelimiter': ',',<br/>            'RecordDelimiter': '\n'<br/>        }<br/>    },<br/>    OutputSerialization={<br/>        'JSON': {<br/>            'RecordDelimiter': ','<br/>        }<br/>    }<br/>)</span></pre><p id="6e71" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">åœ¨ä¸Šé¢çš„è¯·æ±‚ä¸­ï¼Œ<code class="fe mb mc md me b">InputSerialization</code>å†³å®šäº†S3æ–‡ä»¶çš„ç±»å‹å’Œç›¸å…³å±æ€§ï¼Œè€Œ<code class="fe mb mc md me b">OutputSerialization</code>å†³å®šäº†æˆ‘ä»¬ä»è¿™ä¸ª<code class="fe mb mc md me b">select_object_content()</code>ä¸­å¾—åˆ°çš„<code class="fe mb mc md me b">response</code>ã€‚</p><h1 id="f0d6" class="na nb iq bd nc nd nx nf ng nh ny nj nk kf nz kg nm ki oa kj no kl ob km nq nr bi translated">ğŸŒ«ï¸æµå—</h1><p id="311c" class="pw-post-body-paragraph lf lg iq lh b li ns ka lk ll nt kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å¯¹<code class="fe mb mc md me b">S3 Select</code>çš„å·¥ä½œåŸç†æœ‰äº†ä¸€äº›äº†è§£ï¼Œè®©æˆ‘ä»¬è¯•ç€å®Œæˆä¸€ä¸ªå¤§æ–‡ä»¶çš„æµå—(å­é›†)ç”¨ä¾‹ï¼Œå°±åƒ<code class="fe mb mc md me b">paginated API works</code>ä¸€æ ·ã€‚ğŸ˜‹</p><p id="24dd" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><code class="fe mb mc md me b">S3 Select</code>æ”¯æŒ<code class="fe mb mc md me b">ScanRange</code>å‚æ•°ï¼Œè¯¥å‚æ•°é€šè¿‡æŒ‡å®šè¦æŸ¥è¯¢çš„å­—èŠ‚èŒƒå›´æ¥å¸®åŠ©æˆ‘ä»¬æµå¼ä¼ è¾“å¯¹è±¡çš„å­é›†ã€‚<code class="fe mb mc md me b">S3 Select</code>è¯·æ±‚ä¸€ç³»åˆ—ä¸é‡å çš„æ‰«æèŒƒå›´ã€‚æ‰«æèŒƒå›´ä¸éœ€è¦ä¸è®°å½•è¾¹ç•Œå¯¹é½ã€‚æŸ¥è¯¢å°†å¤„ç†åœ¨æŒ‡å®šæ‰«æèŒƒå›´å†…å¼€å§‹ä½†è¶…å‡ºè¯¥æ‰«æèŒƒå›´çš„è®°å½•ã€‚è¿™æ„å‘³ç€å°†åœ¨æ‰«æèŒƒå›´å†…æå–è¯¥è¡Œï¼Œå¹¶ä¸”å¯ä»¥æ‰©å±•åˆ°æå–æ•´è¡Œã€‚å¦‚æœæ˜¯<code class="fe mb mc md me b">doesn't fetch a subset of a row</code>ï¼Œè¦ä¹ˆè¯»å–æ•´è¡Œï¼Œè¦ä¹ˆè·³è¿‡æ•´è¡Œ(åœ¨å¦ä¸€ä¸ªæ‰«æèŒƒå›´å†…è¯»å–)ã€‚</p><p id="a721" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">è®©æˆ‘ä»¬å°è¯•ç”¨ä¸¤ä¸ªç®€å•çš„æ­¥éª¤æ¥å®ç°è¿™ä¸€ç‚¹:</p><h2 id="e40b" class="og nb iq bd nc ol om dn ng on oo dp nk lo op oq nm ls or os no lw ot ou nq iw bi translated">1.æ‰¾å‡ºS3æ–‡ä»¶çš„æ€»å­—èŠ‚æ•°</h2><p id="81a1" class="pw-post-body-paragraph lf lg iq lh b li ns ka lk ll nt kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">ä¸‹é¢çš„ä»£ç ç‰‡æ®µå±•ç¤ºäº†å°†å¯¹æˆ‘ä»¬çš„S3æ–‡ä»¶æ‰§è¡Œ<code class="fe mb mc md me b">HEAD</code>è¯·æ±‚å¹¶ç¡®å®šæ–‡ä»¶å¤§å°(ä»¥å­—èŠ‚ä¸ºå•ä½)çš„å‡½æ•°ã€‚</p><pre class="kp kq kr ks gt oc me od oe aw of bi"><span id="9c1c" class="og nb iq me b gy oh oi l oj ok">def get_s3_file_size(bucket: str, key: str) -&gt; int:<br/>    """Gets the file size of S3 object by a HEAD request<br/><br/>    Args:<br/>        bucket (str): S3 bucket<br/>        key (str): S3 object path<br/><br/>    Returns:<br/>        int: File size in bytes. Defaults to 0 if any error.<br/>    """<br/>    aws_profile = current_app.config.get('AWS_PROFILE_NAME')<br/>    s3_client = boto3.session.Session(profile_name=aws_profile).client('s3')<br/>    file_size = 0<br/>    try:<br/>        response = s3_client.head_object(Bucket=bucket, Key=key)<br/>        if response:<br/>            file_size = int(response.get('ResponseMetadata').get('HTTPHeaders').get('content-length'))<br/>    except ClientError:<br/>        logger.exception(f'Client error reading S3 file {bucket} : {key}')<br/>    return file_size</span></pre><h2 id="7890" class="og nb iq bd nc ol om dn ng on oo dp nk lo op oq nm ls or os no lw ot ou nq iw bi translated">2.åˆ›å»ºä¸€ä¸ªç”Ÿæˆå™¨æ¥ä¼ è¾“å—</h2><p id="e02e" class="pw-post-body-paragraph lf lg iq lh b li ns ka lk ll nt kd ln lo nu lq lr ls nv lu lv lw nw ly lz ma ij bi translated">ç°åœ¨ï¼Œé€»è¾‘æ˜¯äº§ç”ŸS3æ–‡ä»¶çš„å­—èŠ‚æµå—ï¼Œç›´åˆ°æˆ‘ä»¬è¾¾åˆ°æ–‡ä»¶å¤§å°ã€‚è¯·æ”¾å¿ƒï¼Œè¿™ç§è¿ç»­çš„æ‰«æèŒƒå›´ä¸ä¼šå¯¼è‡´å“åº”ä¸­çš„è¡Œé‡å ğŸ˜‰(æ£€æŸ¥è¾“å‡ºå›¾åƒ/ GitHub repo)ã€‚å¾ˆç®€å•ï¼Œå—¯ï¼ŸğŸ˜</p><pre class="kp kq kr ks gt oc me od oe aw of bi"><span id="208f" class="og nb iq me b gy oh oi l oj ok">import ast<br/>import boto3<br/>from botocore.exceptions import ClientError<br/><br/>def stream_s3_file(bucket: str, key: str, file_size: int, chunk_bytes=5000) -&gt; tuple[dict]:<br/>    """Streams a S3 file via a generator.<br/><br/>    Args:<br/>        bucket (str): S3 bucket<br/>        key (str): S3 object path<br/>        chunk_bytes (int): Chunk size in bytes. Defaults to 5000<br/>    Returns:<br/>        tuple[dict]: Returns a tuple of dictionary containing rows of file content<br/>    """<br/>    aws_profile = current_app.config.get('AWS_PROFILE_NAME')<br/>    s3_client = boto3.session.Session(profile_name=aws_profile).client('s3')<br/>    expression = 'SELECT * FROM S3Object'<br/>    start_range = 0<br/>    end_range = min(chunk_bytes, file_size)<br/>    while start_range &lt; file_size:<br/>        response = s3_client.select_object_content(<br/>            Bucket=bucket,<br/>            Key=key,<br/>            ExpressionType='SQL',<br/>            Expression=expression,<br/>            InputSerialization={<br/>                'CSV': {<br/>                    'FileHeaderInfo': 'USE',<br/>                    'FieldDelimiter': ',',<br/>                    'RecordDelimiter': '\n'<br/>                }<br/>            },<br/>            OutputSerialization={<br/>                'JSON': {<br/>                    'RecordDelimiter': ','<br/>                }<br/>            },<br/>            ScanRange={<br/>                'Start': start_range,<br/>                'End': end_range<br/>            },<br/>        )<br/><br/>        """<br/>        select_object_content() response is an event stream that can be looped to concatenate the overall result set<br/>        Hence, we are joining the results of the stream in a string before converting it to a tuple of dict<br/>        """<br/>        result_stream = []<br/>        for event in response['Payload']:<br/>            if records := event.get('Records'):<br/>                result_stream.append(records['Payload'].decode('utf-8'))<br/>        yield ast.literal_eval(''.join(result_stream))<br/>        start_range = end_range<br/>        end_range = end_range + min(chunk_bytes, file_size - end_range)<br/><br/><br/>def s3_file_processing():<br/>    bucket = '&lt;s3-bucket&gt;'<br/>    key = '&lt;s3-key&gt;'<br/>    file_size = get_s3_file_size(bucket=bucket, key=key)<br/>    logger.debug(f'Initiating streaming file of {file_size} bytes')<br/>    chunk_size = 524288  # 512KB or 0.5MB<br/>    for file_chunk in stream_s3_file(bucket=bucket, key=key,<br/>                                     file_size=file_size, chunk_bytes=chunk_size):<br/>        logger.info(f'\n{30 * "*"} New chunk {30 * "*"}')<br/>        id_set = set()<br/>        for row in file_chunk:<br/>            # perform any other processing here<br/>            id_set.add(int(row.get('id')))<br/>        logger.info(f'{min(id_set)} --&gt; {max(id_set)}')</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ov"><img src="../Images/2c582298f46f9d643ba51256fb85144c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UTbaGhAuJtcYCaVR.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated"><em class="ow">å›¾ç‰‡ä½œè€…</em></p></figure><p id="1986" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">æ­å–œä½ ï¼ğŸ‘æˆ‘ä»¬å·²ç»æˆåŠŸåœ°è§£å†³äº†åœ¨ä¸ä½¿ç³»ç»Ÿå´©æºƒçš„æƒ…å†µä¸‹å¤„ç†å¤§å‹S3æ–‡ä»¶çš„å…³é”®æŒ‘æˆ˜ä¹‹ä¸€ã€‚ğŸ¤˜</p><p id="f7cc" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">ğŸ“Œæ‚¨å¯ä»¥<a class="ae le" href="https://github.com/idris-rampurawala/s3-select-demo" rel="noopener ugc nofollow" target="_blank">æŸ¥çœ‹æˆ‘çš„GitHubåº“</a>ä»¥è·å¾—è¿™ç§æ–¹æ³•çš„å®Œæ•´å·¥ä½œç¤ºä¾‹ã€‚</p><p id="0241" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated">ğŸ”–å®ç°æ›´å¤šå¹¶å‘æ€§çš„ä¸‹ä¸€æ­¥æ˜¯å¹¶è¡Œå¤„ç†æ–‡ä»¶ã€‚ç‚¹å‡»æŸ¥çœ‹è¿™ç¯‡æ–‡ç« çš„ç»­é›†<a class="ae le" rel="noopener" target="_blank" href="/parallelize-processing-a-large-aws-s3-file-d43a580cea3">ã€‚</a></p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="0c19" class="na nb iq bd nc nd ne nf ng nh ni nj nk kf nl kg nm ki nn kj no kl np km nq nr bi translated">ä½¿ç”¨S3-Selectçš„âœ”ï¸ä¼˜åŠ¿</h1><ul class=""><li id="5457" class="mf mg iq lh b li ns ll nt lo ox ls oy lw oz ma mk ml mm mn bi translated">å‡å°‘IOï¼Œä»è€Œæé«˜æ€§èƒ½</li><li id="5b47" class="mf mg iq lh b li mo ll mp lo mq ls mr lw ms ma mk ml mm mn bi translated">ç”±äºæ•°æ®ä¼ è¾“è´¹ç”¨å‡å°‘ï¼Œæˆæœ¬é™ä½</li><li id="af3a" class="mf mg iq lh b li mo ll mp lo mq ls mr lw ms ma mk ml mm mn bi translated">ä½¿ç”¨å¤šçº¿ç¨‹/è¿›ç¨‹ä¸­çš„<code class="fe mb mc md me b">ScanRange</code>,å¯ä»¥å¹¶è¡Œè¿è¡Œå¤šä¸ªå—æ¥åŠ é€Ÿæ–‡ä»¶å¤„ç†</li></ul></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="5b3f" class="na nb iq bd nc nd ne nf ng nh ni nj nk kf nl kg nm ki nn kj no kl np km nq nr bi translated">S3é€‰æ‹©çš„â—é™åˆ¶</h1><ul class=""><li id="dee1" class="mf mg iq lh b li ns ll nt lo ox ls oy lw oz ma mk ml mm mn bi translated">è¾“å…¥æˆ–ç»“æœä¸­è®°å½•çš„æœ€å¤§é•¿åº¦æ˜¯1 MB</li><li id="5bf0" class="mf mg iq lh b li mo ll mp lo mq ls mr lw ms ma mk ml mm mn bi translated">äºšé©¬é€ŠS3é€‰æ‹©åªèƒ½ä½¿ç”¨JSONè¾“å‡ºæ ¼å¼å‘å‡ºåµŒå¥—æ•°æ®</li><li id="89ae" class="mf mg iq lh b li mo ll mp lo mq ls mr lw ms ma mk ml mm mn bi translated">S3é€‰æ‹©è¿”å›ä¸€ä¸ªç¼–ç å­—èŠ‚æµï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»å¾ªç¯è¿”å›çš„æµå¹¶è§£ç è¾“å‡º<code class="fe mb mc md me b">records['Payload'].decode('utf-8')</code></li><li id="d49f" class="mf mg iq lh b li mo ll mp lo mq ls mr lw ms ma mk ml mm mn bi translated">ä»…é€‚ç”¨äºä»¥CSVã€JSONæˆ–Apache Parquetæ ¼å¼å­˜å‚¨çš„å¯¹è±¡ã€‚ä¸ºäº†æ›´å¤šçš„çµæ´»æ€§/åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥é€‰æ‹©<a class="ae le" href="https://docs.aws.amazon.com/athena/latest/ug/what-is.html" rel="noopener ugc nofollow" target="_blank"> AWS Athena </a></li></ul></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="c9fc" class="na nb iq bd nc nd ne nf ng nh ni nj nk kf nl kg nm ki nn kj no kl np km nq nr bi translated">ğŸ“‘èµ„æº</h1><ul class=""><li id="38cc" class="mf mg iq lh b li ns ll nt lo ox ls oy lw oz ma mk ml mm mn bi translated"><a class="ae le" href="https://github.com/idris-rampurawala/s3-select-demo" rel="noopener ugc nofollow" target="_blank">æˆ‘çš„GitHubåº“æ¼”ç¤ºäº†ä¸Šè¿°æ–¹æ³•</a></li><li id="a352" class="mf mg iq lh b li mo ll mp lo mq ls mr lw ms ma mk ml mm mn bi translated"><a class="ae le" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.select_object_content" rel="noopener ugc nofollow" target="_blank"> AWS S3é€‰æ‹©boto3å‚è€ƒ</a></li><li id="82cd" class="mf mg iq lh b li mo ll mp lo mq ls mr lw ms ma mk ml mm mn bi translated"><a class="ae le" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/selecting-content-from-objects.html" rel="noopener ugc nofollow" target="_blank"> AWS S3é€‰æ‹©ç”¨æˆ·æŒ‡å—</a></li><li id="3aad" class="mf mg iq lh b li mo ll mp lo mq ls mr lw ms ma mk ml mm mn bi translated"><a class="ae le" href="https://aws.amazon.com/blogs/aws/s3-glacier-select/" rel="noopener ugc nofollow" target="_blank"> AWS S3é€‰æ‹©ç¤ºä¾‹</a></li><li id="3dcb" class="mf mg iq lh b li mo ll mp lo mq ls mr lw ms ma mk ml mm mn bi translated"><a class="ae le" rel="noopener" target="_blank" href="/parallelize-processing-a-large-aws-s3-file-d43a580cea3">è¿™ç¯‡æ–‡ç« çš„ç»­ç¯‡å±•ç¤ºäº†å¹¶è¡Œæ–‡ä»¶å¤„ç†</a></li></ul></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="44b4" class="pw-post-body-paragraph lf lg iq lh b li lj ka lk ll lm kd ln lo lp lq lr ls lt lu lv lw lx ly lz ma ij bi translated"><em class="pa">åŸè½½äº2021å¹´4æœˆ6æ—¥</em><a class="ae le" href="https://dev.to/idrisrampurawala/efficiently-streaming-a-large-aws-s3-file-via-s3-select-4on" rel="noopener ugc nofollow" target="_blank"><em class="pa">https://dev . to</em></a><em class="pa">ã€‚</em></p></div></div>    
</body>
</html>