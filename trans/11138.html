<html>
<head>
<title>How to deploy Azure machine learning models as a secure endpoint</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将Azure机器学习模型部署为安全端点</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-deploy-azure-machine-learning-models-as-a-secure-endpoint-704382bc71fd?source=collection_archive---------12-----------------------#2021-10-31">https://towardsdatascience.com/how-to-deploy-azure-machine-learning-models-as-a-secure-endpoint-704382bc71fd?source=collection_archive---------12-----------------------#2021-10-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="38b3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何使用Azure API管理构建MLOps管道，以将模型部署为安全端点。</h2></div><h1 id="c9e1" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">1.介绍</h1><p id="11ba" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">机器学习运营(<a class="ae lw" href="https://en.wikipedia.org/wiki/MLOps" rel="noopener ugc nofollow" target="_blank"> MLOps </a>)的目标是在生产中部署和维护机器学习模型。MLOps管道的一个常见工件是最终用户应用程序可以使用的实时评分端点。关键是使用网络隔离和身份验证来保护此端点。在这篇blogpost和git repo <code class="fe lx ly lz ma b"><a class="ae lw" href="https://github.com/rebremer/blog-mlopsapim-git" rel="noopener ugc nofollow" target="_blank">blog-mlopsapim-git</a></code>中，讨论了Azure中的MLOps管道，它执行以下操作:</p><ul class=""><li id="2d9f" class="mb mc it lc b ld md lg me lj mf ln mg lr mh lv mi mj mk ml bi translated">1.创建Azure DevOps项目并创建Azure ML、AKS和API管理基础架构</li><li id="e875" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">2.在Azure ML中训练和创建模型</li><li id="4d68" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">3a。将模型作为docker映像部署在隔离的Azure Kubernetes集群上</li><li id="e460" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">3b。使用<a class="ae lw" href="https://docs.microsoft.com/en-us/azure/api-management/api-management-key-concepts" rel="noopener ugc nofollow" target="_blank"> Azure API管理</a>和Azure AD公开安全端点</li></ul><p id="e538" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">另请参见下图:</p><figure class="mv mw mx my gt mz gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mu"><img src="../Images/8c6e0e9ff1fda0f3ce58e95ca71e532f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q1_i08NXIrf8vFANHD9aXA.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">1.架构概述，图片由作者提供</p></figure><p id="e0e3" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">这个项目是基于<a class="ae lw" href="https://www.linkedin.com/in/csiebler/" rel="noopener ugc nofollow" target="_blank">克莱门斯·西布勒</a>所做的伟大工作，可以在这里<a class="ae lw" href="https://github.com/csiebler/mlops-demo" rel="noopener ugc nofollow" target="_blank">找到</a>。在这篇博文的剩余部分，将会更详细地解释这个项目。在下一章中，将描述如何设置MLOps项目。</p><h1 id="7586" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">2.设置MLOps项目</h1><p id="ca3c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本章中，将创建一个MLOps项目。在这方面，需要做以下工作:</p><ul class=""><li id="d6f5" class="mb mc it lc b ld md lg me lj mf ln mg lr mh lv mi mj mk ml bi translated">2.1先决条件</li><li id="1757" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">2.2创建Azure DevOps项目</li><li id="0f93" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">2.3创建服务连接</li><li id="2120" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">2.4替代变量</li></ul><h2 id="b11c" class="nk kj it bd kk nl nm dn ko nn no dp ks lj np nq ku ln nr ns kw lr nt nu ky nv bi translated">2.1先决条件</h2><p id="4580" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">本教程需要以下资源:</p><ul class=""><li id="8832" class="mb mc it lc b ld md lg me lj mf ln mg lr mh lv mi mj mk ml bi translated"><a class="ae lw" href="https://azure.microsoft.com/en-us/free/" rel="noopener ugc nofollow" target="_blank"> Azure账号</a></li><li id="9c5d" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><a class="ae lw" href="https://azure.microsoft.com/en-us/services/devops/" rel="noopener ugc nofollow" target="_blank">天蓝色DevOps </a></li><li id="fdf4" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><a class="ae lw" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>(推荐，也用于故障排除)</li></ul><p id="2724" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">随后，转到Azure门户并创建一个资源组，所有Azure资源都将部署在该资源组中。这也可以使用以下Azure CLI命令来完成:</p><pre class="mv mw mx my gt nw ma nx ny aw nz bi"><span id="57cb" class="nk kj it ma b gy oa ob l oc od">az group create -n &lt;&lt;your resource group&gt;&gt; -l &lt;&lt;your location&gt;&gt;</span></pre><h2 id="9637" class="nk kj it bd kk nl nm dn ko nn no dp ks lj np nq ku ln nr ns kw lr nt nu ky nv bi translated">2.2创建Azure DevOps项目</h2><p id="8bdb" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Azure DevOps是一个工具，可以持续地构建、测试和部署你的代码到任何平台和云。创建新项目后，单击存储库文件夹并选择导入以下存储库:</p><ul class=""><li id="a648" class="mb mc it lc b ld md lg me lj mf ln mg lr mh lv mi mj mk ml bi translated">【https://github.com/rebremer/blog-mlopsapim-git T4】</li></ul><p id="3c22" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">也见下图。</p><figure class="mv mw mx my gt mz gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oe"><img src="../Images/3f505dc68990b46d7b3521ce8b4be88a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*73tuTQ92fc3ek8Tw.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">2.2将存储库添加到您的Azure DevOps项目中，图片由作者提供</p></figure><h2 id="e428" class="nk kj it bd kk nl nm dn ko nn no dp ks lj np nq ku ln nr ns kw lr nt nu ky nv bi translated">2.3创建服务连接</h2><p id="10ac" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">从Azure DevOps访问资源组中的资源需要服务连接。转到项目设置，服务连接，然后选择Azure资源管理器，另见下图。</p><figure class="mv mw mx my gt mz gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oe"><img src="../Images/be8a2da0e452a6dd3fe4ef86e7c6ffb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DrtVgZag3nuxbFA9.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">2.3.1将存储库添加到您的Azure DevOps项目，image by author</p></figure><p id="de5c" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">选择服务主体身份验证，并将范围限制到您之前创建的资源组，另请参见下图。</p><figure class="mv mw mx my gt mz gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oe"><img src="../Images/a3250eab6a417bff6a233bc1e845f67a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*21Y8gxGdhUm5sA7G.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">2.3.2按作者将范围限制到资源组、图像</p></figure><h2 id="b8f3" class="nk kj it bd kk nl nm dn ko nn no dp ks lj np nq ku ln nr ns kw lr nt nu ky nv bi translated">2.4替代变量</h2><p id="0628" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">转到您的repo，找到<code class="fe lx ly lz ma b"><a class="ae lw" href="https://github.com/rebremer/blog-mlopsapim-git/blob/master/pipelines/german-credit-config.yml" rel="noopener ugc nofollow" target="_blank">pipelines/german-credit-config.yml</a></code>并修改值以指向您的工作区，也见下文</p><pre class="mv mw mx my gt nw ma nx ny aw nz bi"><span id="42e3" class="nk kj it ma b gy oa ob l oc od">variables: <br/>  #<br/>  ml_workspace_connection: '&lt;&lt;service connection created in 2.3&gt;&gt;'  <br/>  ...<br/>  # subscription <br/>  ml_subscription_id: '&lt;&lt;your subscription&gt;&gt;'<br/>  ...<br/>  # apim<br/>  ml_apim_name: '&lt;&lt;your apim name'<br/>  ml_apim_email: '&lt;&lt;your email address&gt;&gt;'<br/>  ml_location: 'westeurope'<br/>  ml_tenant_id: '&lt;&lt;your tenant id&gt;&gt;'</span></pre><p id="2ddf" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">所有其他变量都可以替换，但这不是成功构建所必需的。MLOps项目现在可以运行了。</p><h1 id="c256" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">3.使用Azure API管理部署MLOps管道</h1><p id="5648" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这一章中，项目开始运行，MLOps管道将被部署，生成安全端点作为主要工件。在这方面，需要做以下工作:</p><ul class=""><li id="b183" class="mb mc it lc b ld md lg me lj mf ln mg lr mh lv mi mj mk ml bi translated">3.1 MLOps管道描述</li><li id="b6f3" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">3.2运行管道</li><li id="8d36" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">3.3测试安全端点</li></ul><h2 id="0c7b" class="nk kj it bd kk nl nm dn ko nn no dp ks lj np nq ku ln nr ns kw lr nt nu ky nv bi translated">3.1 MLOps管道描述</h2><p id="4fe2" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这个git repo中，创建了四个管道，它们将在下一章中运行。管道可以描述如下:</p><ul class=""><li id="140f" class="mb mc it lc b ld md lg me lj mf ln mg lr mh lv mi mj mk ml bi translated"><code class="fe lx ly lz ma b"><a class="ae lw" href="https://github.com/rebremer/blog-mlopsapim-git/blob/master/pipelines/1-german-credit-infrastructure.yml" rel="noopener ugc nofollow" target="_blank">pipelines/1-german-credit-infrastructure.yml</a></code> -部署带有数据集的Azure ML工作区、VNET的私有AKS集群和Azure Api管理</li><li id="b228" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><code class="fe lx ly lz ma b"><a class="ae lw" href="https://github.com/rebremer/blog-mlopsapim-git/blob/master/pipelines/2-german-credit-train-and-register.yml" rel="noopener ugc nofollow" target="_blank">pipelines/2-german-credit-train-and-register.yml</a></code> -自动训练和注册模型</li><li id="999a" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><code class="fe lx ly lz ma b"><a class="ae lw" href="https://github.com/rebremer/blog-mlopsapim-git/blob/master/pipelines/3a-german-credit-deploy.yml" rel="noopener ugc nofollow" target="_blank">pipelines/3a-german-credit-deploy.yml</a></code> -将训练好的模型部署到AKS集群，创建私有端点和密钥认证。密钥更新是部署过程的一部分。</li><li id="9cf7" class="mb mc it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><code class="fe lx ly lz ma b"><a class="ae lw" href="https://github.com/rebremer/blog-mlopsapim-git/blob/master/pipelines/3b-german-credit-apimoperation.yml" rel="noopener ugc nofollow" target="_blank">pipelines/3b-german-credit-apimoperation.yml</a></code> -部署暴露私有AKS端点的APIM端点。APIM的用户身份验证基于Azure AD。反过来，APIM后端是AKS私有端点的一部分，密钥身份验证用于向AKS端点进行身份验证。密钥更新是部署过程的一部分。</li></ul><p id="6460" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">在下一章中，将描述如何部署管道1。对于其他三个管道，可以遵循类似的过程。</p><h2 id="17ab" class="nk kj it bd kk nl nm dn ko nn no dp ks lj np nq ku ln nr ns kw lr nt nu ky nv bi translated">3.2运行管道</h2><p id="ca42" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">转到您的Azure DevOps项目，选择管道，然后单击“新建管道”。转到向导，选择您之前创建的Azure Repos Git和git repo。在“配置”选项卡中，选择“现有的Azure Pipelines YAML文件”,然后选择可以在git repo中找到的<code class="fe lx ly lz ma b"><a class="ae lw" href="https://github.com/rebremer/blog-mlopsapim-git/blob/master/pipelines/1-german-credit-infrastructure.yml" rel="noopener ugc nofollow" target="_blank">pipelines/1-german-credit-infrastructure.yml</a></code>,也见下文。</p><figure class="mv mw mx my gt mz gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oe"><img src="../Images/ec1028ffd101cbf57c1c30565c2aa7e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0ZtGobAxO_9h6ecI.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">3.2.1在管道配置向导中，选择现有的Azure管道YAML文件，按作者排序的图像</p></figure><p id="8eaa" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">一旦创建了管道，它就会立即运行，如下所示。</p><figure class="mv mw mx my gt mz gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oe"><img src="../Images/1a3425d14920a5a43c2814ceaab5d058.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*flDwuge7ju6_PcGn.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">3.2.2 Azure DevOps部署现代数据管道，图片由作者提供</p></figure><p id="bea8" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">作业运行后，部署所有资源并执行测试。随后，运行属于管道文件夹的所有其他管道，如3.1中所述。</p><p id="61bc" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">如果所有管道都运行成功，那么在API管理中会创建一个API，指向私有AKS集群的URL</p><figure class="mv mw mx my gt mz gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi of"><img src="../Images/bbd6948f98c174bd92f79dd2572379e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gPanCyLV93fUaO1SANE6Lw.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">3.3在API中成功部署，图像由作者提供</p></figure><p id="7fc4" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">随后，score操作使用JWT令牌验证来验证传入的Azure AD请求，并使用带密钥的命名值向AKS私有端点进行身份验证，另请参见<code class="fe lx ly lz ma b"><a class="ae lw" href="https://github.com/rebremer/blog-mlopsapim-git/blob/master/pipelines/scripts/api_policy_template.xml" rel="noopener ugc nofollow" target="_blank">api_policy_template.xml</a></code>。</p><h2 id="e259" class="nk kj it bd kk nl nm dn ko nn no dp ks lj np nq ku ln nr ns kw lr nt nu ky nv bi translated">3.3.测试安全端点</h2><p id="dc44" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在所有管道运行之后，部署一个由API管理器公开的端点。身份验证需要Azure承载令牌。通常，托管身份或服务主体用于创建承载令牌。在<a class="ae lw" href="https://github.com/rebremer/blog-mlopsapim-git/blob/master/README.md#testing" rel="noopener ugc nofollow" target="_blank"> github </a>中，可以找到一个用服务主体生成的承载令牌进行测试的例子。</p><p id="0f7c" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">作为一个快速测试，也可以决定使用以下CLI命令从已经登录的用户创建一个承载令牌。</p><pre class="mv mw mx my gt nw ma nx ny aw nz bi"><span id="9d46" class="nk kj it ma b gy oa ob l oc od">az account get-access-token --query accessToken --output tsv</span></pre><p id="f5a7" class="pw-post-body-paragraph la lb it lc b ld md ju lf lg me jx li lj mr ll lm ln ms lp lq lr mt lt lu lv im bi translated">然后，令牌可以被复制并在下面的脚本(或Postman)中使用</p><pre class="mv mw mx my gt nw ma nx ny aw nz bi"><span id="1d1f" class="nk kj it ma b gy oa ob l oc od">token = resp.json()['access_token']<br/>#<br/>url = 'https://&lt;&lt;your apim&gt;&gt;.azure-api.net/testprivv2/score'<br/>#<br/>test_data = {<br/>  'data': [{<br/>    "Age": 20,<br/>    "Sex": "male",<br/>    "Job": 0,<br/>    "Housing": "own",<br/>    "Saving accounts": "little",<br/>    "Checking account": "little",<br/>    "Credit amount": 100,<br/>    "Duration": 48,<br/>    "Purpose": "radio/TV"<br/>  }]<br/>}<br/><br/>headers = {'Content-Type':'application/json', 'Authorization': 'bearer ' + token}<br/>resp = requests.post(url, json=test_data, headers=headers)<br/><br/>print("Prediction (good, bad):", resp.text)</span></pre><h1 id="daa3" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">4.结论</h1><p id="5cdb" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">机器学习操作(<a class="ae lw" href="https://en.wikipedia.org/wiki/MLOps" rel="noopener ugc nofollow" target="_blank"> MLOps </a>)旨在部署和维护生产中的机器学习模型。MLOps管道的一个常见工件是由最终用户应用程序使用的REST端点。在blogpost和git repo <code class="fe lx ly lz ma b"><a class="ae lw" href="https://github.com/rebremer/blog-mlopsapim-git" rel="noopener ugc nofollow" target="_blank">blog-mlopsapim-git</a>,</code>中，讨论了一个项目，该项目1)所有的基础设施，2)构建和训练一个模型，3a)部署模型作为端点，3b)保护端点，参见下面的体系结构。</p><figure class="mv mw mx my gt mz gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mu"><img src="../Images/8c6e0e9ff1fda0f3ce58e95ca71e532f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q1_i08NXIrf8vFANHD9aXA.png"/></div></div><p class="ng nh gj gh gi ni nj bd b be z dk translated">4.架构概述，按作者列出的图像</p></figure></div></div>    
</body>
</html>