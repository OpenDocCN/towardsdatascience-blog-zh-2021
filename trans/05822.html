<html>
<head>
<title>Deploying a fastai model on Windows with Flask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Flask在Windows上部署fastai模型</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-a-fastai-model-on-windows-with-flask-c8846e6b9800?source=collection_archive---------38-----------------------#2021-05-24">https://towardsdatascience.com/deploying-a-fastai-model-on-windows-with-flask-c8846e6b9800?source=collection_archive---------38-----------------------#2021-05-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/e791309018775083a54e918b3879b1f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DGWNCE9_Yz7ETeRScddV2g.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">图片:作者</p></figure><div class=""/><p id="c0ef" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">对深度学习模型进行基本的web部署是一种很好的方式，可以原型化如何使用您的模型，并验证您在培训过程中所做的假设。在与Keras一起工作时，我做了几个模型的简单部署，并发表了一些文章，描述我用Facebook Messenger和T2 Flask部署Keras模型的经历。</p><p id="0aa0" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">由于我在去年花了大量时间使用另一个主要的高级深度学习框架<strong class="kh jj"> fastai </strong>，我希望获得fastai模型简单部署的实践经验。我决定用Flask来修改我在Keras模型的web部署中使用的方法。在本文中，我将描述创建fastai模型的简单web部署时必须克服的一些障碍，以及与Keras相比fastai为部署提供的一些意想不到的好处。</p><h2 id="9ce7" class="le lf ji bd lg lh li dn lj lk ll dp lm kq ln lo lp ku lq lr ls ky lt lu lv lw bi translated">目标</h2><p id="ccc4" class="pw-post-body-paragraph kf kg ji kh b ki lx kk kl km ly ko kp kq lz ks kt ku ma kw kx ky mb la lb lc im bi translated">我之前使用fastai管理的表格数据集ADULT_SAMPLE训练了一个fastai模型。该数据集的特征描述了个人(他们的年龄、工作类别、教育背景等)，如下所示:</p><figure class="md me mf mg gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mc"><img src="../Images/ac19beaf5e95515fe5807160cefa262e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2TGSqpZP8OCGpi9SSXJPlg.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">成人样本数据集的片段</p></figure><p id="e115" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我在ADULT_SAMPLE上训练的模型预测具有一组给定特征值的个人的收入是高于还是低于5万美元。出于部署的目的，我将这些特征值称为<strong class="kh jj">评分参数</strong>。</p><p id="3c78" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">对于本文中描述的部署，我希望创建一个简单的web应用程序，用户可以在其中选择个人的特征值/评分参数，并从训练好的模型中获得关于此人的收入是否会超过50 k美元阈值的预测。</p><h2 id="da99" class="le lf ji bd lg lh li dn lj lk ll dp lm kq ln lo lp ku lq lr ls ky lt lu lv lw bi translated">部署方法</h2><p id="6661" class="pw-post-body-paragraph kf kg ji kh b ki lx kk kl km ly ko kp kq lz ks kt ku ma kw kx ky mb la lb lc im bi translated">我想尽可能多地重用我为Keras模型所做的web部署中的代码。我改编了Keras web部署中的HTML文件和Flask模块，并采用了下图中描述的方法:</p><figure class="md me mf mg gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mh"><img src="../Images/db572caf5f00eaef38663a2609261c53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Maji9unxt3ydgxq_R0nJvA.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">Web部署方法</p></figure><ol class=""><li id="49cc" class="mi mj ji kh b ki kj km kn kq mk ku ml ky mm lc mn mo mp mq bi translated"><strong class="kh jj">home.html</strong>—用户选择评分参数(年龄、工作类别、教育背景等值)的网页，他们希望获得个人的收入预测。</li><li id="f434" class="mi mj ji kh b ki mr km ms kq mt ku mu ky mv lc mn mo mp mq bi translated"><strong class="kh jj"> Flask模块</strong> —服务网页并加载训练好的fastai模型。Flask模块包含用于组成部署的两个网页(home.html和show-prediction.html)的视图函数<strong class="kh jj">。当一个网页被加载时，该网页的视图函数被执行，这使我们有机会从熟悉的Python设置中采取行动，比如调用模型进行预测。</strong></li><li id="1fc2" class="mi mj ji kh b ki mr km ms kq mt ku mu ky mv lc mn mo mp mq bi translated"><strong class="kh jj">经过训练的fastai模型</strong>-这是我使用成人样本数据集训练的模型，它根据个人的评分参数预测个人的收入是否超过5万美元。当启动Flask模块时加载该模型，并使用从home.html传来的评分参数在show-prediction.html的查看功能中调用该模型。</li><li id="d438" class="mi mj ji kh b ki mr km ms kq mt ku mu ky mv lc mn mo mp mq bi translated">show-prediction.html<strong class="kh jj">-显示模型对个人预测的网页，评分参数设置在home.html。</strong></li></ol><p id="89e6" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在更新HTML文件以反映成人样本数据集的细节之后，我可以重用来自Keras部署的HTML文件。我不需要对这些文件做任何针对fastai的更改。</p><p id="cbd3" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我必须做一些工作来从Keras部署中获取Flask模块，以便正确地加载和应用fastai模型。在下一节中，我将描述实现这一点的挑战和一些惊喜。</p><h2 id="cec2" class="le lf ji bd lg lh li dn lj lk ll dp lm kq ln lo lp ku lq lr ls ky lt lu lv lw bi translated">将所有这些放在一起:三个陷阱和一个惊喜</h2><p id="afd3" class="pw-post-body-paragraph kf kg ji kh b ki lx kk kl km ly ko kp kq lz ks kt ku ma kw kx ky mb la lb lc im bi translated">整个解决方案中最困难的部分是将fastai模型正确无误地加载到Flask模块中。根据我在fastai论坛上读到的内容，如果我一直使用Linux而不是Windows作为开发环境，我会更容易一些。然而，Windows应该是fastai支持的平台，我的这个部署示例的观众需要能够使用Windows，所以放弃这个平台不是一个选项。</p><p id="0333" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">要使部署工作正常进行，我必须克服三个关键问题。</p><ul class=""><li id="a9e1" class="mi mj ji kh b ki kj km kn kq mk ku ml ky mm lc mw mo mp mq bi translated">当我试图加载fastai模型时，我一直得到PosixPath错误。我可以通过向Flask模块添加以下导入来解决这个问题(在这个<a class="ae ld" href="https://stackoverflow.com/questions/57286486/i-cant-load-my-model-because-i-cant-put-a-posixpath" rel="noopener ugc nofollow" target="_blank">堆栈溢出线程</a>的帮助下):</li></ul><figure class="md me mf mg gt iv"><div class="bz fp l di"><div class="mx my l"/></div></figure><ul class=""><li id="b308" class="mi mj ji kh b ki kj km kn kq mk ku ml ky mm lc mw mo mp mq bi translated">由于形状不匹配错误，加载模型一直失败。在我包含了上述代码片段中显示的导入之后，我能够加载模型(在与Flask模块相同的目录中)，但是我需要(a)将我的本地系统上的Pandas更新到最新级别(b)确保我使用了Python的平台不可知路径功能以避免反斜杠/正斜杠混淆，以及(c)使用模型的完全限定文件名作为load_learner的参数，如下所示:</li></ul><figure class="md me mf mg gt iv"><div class="bz fp l di"><div class="mx my l"/></div></figure><ul class=""><li id="1851" class="mi mj ji kh b ki kj km kn kq mk ku ml ky mm lc mw mo mp mq bi translated">我用来训练模型的成人样本数据集中的分类值都以空格开头。我忽略了在训练时进行转换来修剪这些空格，所以模型是用每个以空格开头的分类值来训练的。但是，我在home.html编码的分类特性的值(指定用户可以选择的有效值)不是以空格开头的。我没有注意到训练集和用户可以选择发送到部署模型的内容之间的不匹配。当我测试web部署时，该模型看到了所有分类特性的前所未有的值。结果是，在web部署中，模型总是预测“少于50 k美元”，即使在Jupyter笔记本中一次性调用时，模型预测得分参数集“大于50 k美元”。一旦我发现了训练集中的异常，我就更新home.html中的分类特征值，以一个空格开始。更新之后，web部署预测与一次性预测相匹配。</li></ul><p id="e6e0" class="pw-post-body-paragraph kf kg ji kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">最后，来自fastai的一个惊喜是:我能够部署模型，而不必显式地定义评分参数的管道。fastai在推理时自动调用与训练时相同的分类值转换。这比我在Keras部署中所做的修改有更大的优势，例如，如果在训练模型时“星期一”被映射到0，那么当调用部署的模型来获得预测时，它也被映射到0。</p><h2 id="2654" class="le lf ji bd lg lh li dn lj lk ll dp lm kq ln lo lp ku lq lr ls ky lt lu lv lw bi translated">结论</h2><p id="ac55" class="pw-post-body-paragraph kf kg ji kh b ki lx kk kl km ly ko kp kq lz ks kt ku ma kw kx ky mb la lb lc im bi translated">在Windows上完成一个fastai模型的简单的、基于Flask的web部署需要一些反复试验。为了能够成功地加载一个经过训练的fastai模型，我需要确保我有模型的精确正确的路径定义，这需要进行一些调查。我用来训练模型的数据集有一个异常，如果我在训练时修剪前导空格，就可以避免这个异常。然而，最终我能够使用适用于Keras模型的相同方法来部署fastai模型，fastai使我不必担心在训练时和推理时如何同步分类值的编码。</p><h2 id="84af" class="le lf ji bd lg lh li dn lj lk ll dp lm kq ln lo lp ku lq lr ls ky lt lu lv lw bi translated">背景</h2><ul class=""><li id="0a6d" class="mi mj ji kh b ki lx km ly kq mz ku na ky nb lc mw mo mp mq bi translated">Git repo使用本文描述的web部署代码:<a class="ae ld" href="https://github.com/ryanmark1867/fastai_deployment" rel="noopener ugc nofollow" target="_blank">https://github.com/ryanmark1867/fastai_deployment</a></li><li id="8df0" class="mi mj ji kh b ki mr km ms kq mt ku mu ky mv lc mw mo mp mq bi translated">本文视频版:【https://youtu.be/lLCeOPc82DI T2】</li><li id="e552" class="mi mj ji kh b ki mr km ms kq mt ku mu ky mv lc mw mo mp mq bi translated">fastai和Keras对比视频:<a class="ae ld" href="https://youtu.be/3d6rGGyPR5c" rel="noopener ugc nofollow" target="_blank">https://youtu.be/3d6rGGyPR5c</a>，<a class="ae ld" href="https://youtu.be/wCMuQD2QBMk" rel="noopener ugc nofollow" target="_blank">https://youtu.be/wCMuQD2QBMk</a></li></ul></div></div>    
</body>
</html>