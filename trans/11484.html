<html>
<head>
<title>Deep Learning on your phone: PyTorch Lite Interpreter for mobile platforms</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">手机深度学习:手机平台PyTorch Lite解释器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deep-learning-on-your-phone-pytorch-lite-interpreter-for-mobile-platforms-ae73d0b17eaa?source=collection_archive---------5-----------------------#2021-11-12">https://towardsdatascience.com/deep-learning-on-your-phone-pytorch-lite-interpreter-for-mobile-platforms-ae73d0b17eaa?source=collection_archive---------5-----------------------#2021-11-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ef4c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">PyTorch深度学习框架支持在移动设备上无缝运行服务器训练的CNN和其他ML模型。本文描述了如何在移动设备上优化和运行您的服务器训练模型。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b08019b40fd6a548f2f9b048c4374d29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ze6d1gm1EdWOC6Fm"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kv" href="https://unsplash.com/@frostroomhead?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rodion Kutsaev </a>拍照</p></figure><p id="fbf4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://pytorch.org/" rel="noopener ugc nofollow" target="_blank"> PyTorch </a>是一个深度学习框架，用于训练和运行机器学习(ML)模型，加快从研究到生产的速度。</p><p id="729a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常，人们会在功能强大的服务器上训练模型(在CPU或GPU上)，然后将预训练的模型部署在移动平台上(这通常更受资源限制)。本文将重点讨论PyTorch为在移动设备/平台上运行服务器训练的模型提供了哪些支持。</p><p id="c470" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://pytorch.org/mobile/home/" rel="noopener ugc nofollow" target="_blank"> PyTorch Mobile </a>目前支持在<a class="ae kv" href="https://pytorch.org/mobile/android/" rel="noopener ugc nofollow" target="_blank"> Android </a>和<a class="ae kv" href="https://pytorch.org/mobile/ios/" rel="noopener ugc nofollow" target="_blank"> iOS </a>平台上部署预训练模型进行推理。</p><h1 id="baff" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">高层次的步骤</h1><ol class=""><li id="dc2d" class="mk ml iq ky b kz mm lc mn lf mo lj mp ln mq lr mr ms mt mu bi translated">在服务器上训练模型(在CPU或GPU上)——本文不会讨论训练模型的细节。你可以在这里、<a class="ae kv" rel="noopener" target="_blank" href="/understanding-pytorch-with-an-example-a-step-by-step-tutorial-81fc5f8c4e8e">这里</a>和<a class="ae kv" href="https://www.kdnuggets.com/2020/06/fundamentals-pytorch.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到更多关于PyTorch <a class="ae kv" href="https://www.kdnuggets.com/2020/10/getting-started-pytorch.html" rel="noopener ugc nofollow" target="_blank">训练的信息。这里有一篇关于PyTorch </a>入门的好文章。</li><li id="7ee1" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">[可选]针对移动推理优化您的训练模型</li><li id="d92f" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">以lite解释器格式保存您的模型</li><li id="e3f9" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">使用PyTorch移动API在您的移动应用程序中进行部署</li><li id="c09a" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">利润！</li></ol><h1 id="aff9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">详细步骤</h1><p id="735f" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">本文的其余部分假设您已经预先接受了培训。pt模型文件，下面的示例将使用一个虚拟模型来遍历代码和工作流，以便使用PyTorch Lite解释器进行移动平台的深度学习。</p><h2 id="4fb8" class="nd lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">在服务器上创建/训练模型</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="73ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检查它是否运行，并产生合理的输出</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="e266" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应打印:</p><p id="2fd7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nr">张量(【4。, 11., 18.]) </em></p><h2 id="464c" class="nd lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">生成脚本模型</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><h2 id="3197" class="nd lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">[可选]为移动推理优化模型</h2><p id="6bc1" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">有关移动优化器的详细信息，请参见本页。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><h2 id="c898" class="nd lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">为移动推理保存模型</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><h2 id="75a1" class="nd lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">加载并运行移动模型进行推理(在移动设备上)</h2><p id="d54a" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">下面的代码直接使用C++ API。根据你的需求，你可以选择使用<a class="ae kv" href="https://pytorch.org/mobile/android/" rel="noopener ugc nofollow" target="_blank"> Android (Java) </a>或者<a class="ae kv" href="https://pytorch.org/mobile/ios/" rel="noopener ugc nofollow" target="_blank">iOS</a>API。您还可以查看<a class="ae kv" href="https://www.kdnuggets.com/2021/11/deep-learning-mobile-phone-pytorch-c-api.html" rel="noopener ugc nofollow" target="_blank">本文</a>开始使用C++ API在您的开发机器上以x平台的方式运行模型推理。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="d8f6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">optimize_for_mobile(模型)到底是做什么的？</h1><p id="c811" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">移动优化过程对模型的图形执行许多更改。你可以在这里找到移动优化通道<a class="ae kv" href="https://github.com/pytorch/pytorch/blob/master/torch/csrc/jit/passes/xnnpack_rewrite.cpp#L453" rel="noopener ugc nofollow" target="_blank">的源代码。下面是这种优化的一个不全面的列表。</a></p><ol class=""><li id="97d3" class="mk ml iq ky b kz la lc ld lf ns lj nt ln nu lr mr ms mt mu bi translated"><strong class="ky ir">模块冻结:</strong>这将不会被模型变异的属性提升为常量。在后续过程中很有用。</li><li id="adeb" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated"><strong class="ky ir">函数内联</strong>:如果从模型的forward()方法中调用一个方法，那么被调用的方法在优化的模块中被内联，以消除函数调用开销。</li><li id="13ad" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated"><strong class="ky ir">操作符融合</strong>:例如<a class="ae kv" href="https://web.stanford.edu/class/cs245/win2020/slides/09-PyTorch.pdf" rel="noopener ugc nofollow" target="_blank">融合</a>once巴奇诺姆或conv-雷鲁等……这允许在中间层重复使用进入CPU缓存的数据。</li><li id="710e" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated"><strong class="ky ir">去除漏失</strong> : <a class="ae kv" href="https://machinelearningmastery.com/dropout-for-regularizing-deep-neural-networks/" rel="noopener ugc nofollow" target="_blank">漏失</a>是一种近似并行训练大量不同架构神经网络的正则化方法。一旦模型进入eval() only模式，就不需要这样做了，删除它可以提高模型的推理性能。</li></ol><h1 id="3857" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">比较移动优化前后的模型图</h1><h2 id="93c1" class="nd lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">在优化之前</h2><p id="5d5f" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">原始模型有两个方法:forward()和helper()。forward()调用helper()。此外，张量t1是模型属性。</p><p id="f00a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nr"> scripted.forward.graph </em></p><p id="29e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将打印</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="3ed3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nr"> scripted.helper.graph </em></p><p id="cc79" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将打印</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><h2 id="10aa" class="nd lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">优化后</h2><p id="cbf8" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">优化的模型只有一个方法，forward()。此外，张量t1是模型常数。</p><p id="cb8d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nr">优化_模型.转发.图形</em></p><p id="3486" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将打印</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="f716" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">lite解释器模型与TorchScript模型有什么不同？</h1><p id="0778" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">lite解释器模型文件是一个常规的TorchScript模型文件，其中添加了特定于移动设备的字节码。您可以将移动模型作为普通的PyTorch TorchScript模型加载，也可以将其作为lite-interpreter模型加载。</p><p id="3039" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当保存为lite-interpreter(移动平台)时，PyTorch为模型的图形保存了额外的字节码，与TorchScript相比，在设备上执行更有效。相对于运行TorchScript，PyTorch在编译的应用程序中使用的二进制文件更少。</p><p id="c149" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是如何查看生成的bytecode.pkl文件。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="09ed" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="3b11" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">PyTorch现在支持移动平台上的推理。很容易采用服务器训练的模型，并将其转换为在移动平台上运行优化的推理。模型语义以TorchScript和Lite解释器格式保存。</p><h1 id="7c2d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">参考</h1><ol class=""><li id="24ac" class="mk ml iq ky b kz mm lc mn lf mo lj mp ln mq lr mr ms mt mu bi translated"><a class="ae kv" href="https://pytorch.org/mobile/home/" rel="noopener ugc nofollow" target="_blank"> PyTorch手机</a></li><li id="31ab" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated"><a class="ae kv" rel="noopener" target="_blank" href="/understanding-pytorch-with-an-example-a-step-by-step-tutorial-81fc5f8c4e8e">通过示例了解PyTorch:分步指南</a></li><li id="5f84" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated"><a class="ae kv" href="https://www.kdnuggets.com/2018/11/introduction-pytorch-deep-learning.html" rel="noopener ugc nofollow" target="_blank">深度学习PyTorch简介</a></li><li id="3864" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">【PyTorch入门</li><li id="f847" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated"><a class="ae kv" href="https://www.kdnuggets.com/2020/06/fundamentals-pytorch.html" rel="noopener ugc nofollow" target="_blank">你应该知道的PyTorch最重要的基础知识</a></li><li id="2d53" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated"><a class="ae kv" href="https://medium.com/data-folks-indonesia/pytorch-for-deep-learning-get-started-67c4c0a234e3" rel="noopener">深度学习PyTorch:入门</a></li><li id="309a" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated"><a class="ae kv" href="https://machinelearningmastery.com/dropout-for-regularizing-deep-neural-networks/" rel="noopener ugc nofollow" target="_blank">什么是辍学？</a></li><li id="12e4" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated"><a class="ae kv" href="https://web.stanford.edu/class/cs245/win2020/slides/09-PyTorch.pdf" rel="noopener ugc nofollow" target="_blank"> PyTorch算子融合</a></li><li id="b66f" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated"><a class="ae kv" href="https://pytorch.org/docs/stable/mobile_optimizer.html" rel="noopener ugc nofollow" target="_blank"> PyTorch移动优化器</a></li></ol></div></div>    
</body>
</html>