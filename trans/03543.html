<html>
<head>
<title>Running Apache Superset at Scale</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">大规模运行Apache超集</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/running-apache-superset-at-scale-1539e3945093?source=collection_archive---------23-----------------------#2021-03-22">https://towardsdatascience.com/running-apache-superset-at-scale-1539e3945093?source=collection_archive---------23-----------------------#2021-03-22</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="2958" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">大规模高效运行超集的一组建议和起点</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/c4de1007164ba08e5ad434a630bab28d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gPZi5dSm-pqnPBX7.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">样本超集仪表板(来源:<a class="ae kz" href="https://superset.apache.org/gallery/" rel="noopener ugc nofollow" target="_blank">https://superset.apache.org/gallery/</a></p></figure><p id="2b29" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi lw translated"><span class="l lx ly lz bm ma mb mc md me di"> W </span>谈到商业智能(BI)生态系统，专有工具在很长一段时间内都是标准。Tableau、Power BI和最近的Looker是企业BI用例的首选解决方案。但是后来，Apache超集发生了。</p><p id="306d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">由于对依赖专有BI解决方案的诸多不便感到失望(如缺乏与某些查询执行引擎和供应商锁定的兼容性)，Maxime Beauchemin使用Airbnb内部黑客马拉松从头开始构建BI工具。</p><p id="1506" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">该项目于2016年开源(最初为Caravel ),并在过去五年中成为今天的Apache超集，作为开源项目为全球开发者提供专有BI工具(及更多)的功能。因此，毫不奇怪，它很快被数十家公司采用。</p><p id="0332" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在最初发布五年后，当谈到大规模运行超集时，文档仍然有限，尽管该工具本身是云原生的，并且是为大规模运行而设计的。本文旨在提供一些起点和建议，可以在这方面帮助新的采用者。</p><h1 id="954e" class="mf mg iu bd mh mi mj mk ml mm mn mo mp ka mq kb mr kd ms ke mt kg mu kh mv mw bi translated">都是关于容器的</h1><p id="ddd5" class="pw-post-body-paragraph la lb iu lc b ld mx jv lf lg my jy li lj mz ll lm ln na lp lq lr nb lt lu lv in bi translated">无论您希望在哪个平台或云上运行超集，如果您正在计划可伸缩性，那么第一个构建块应该是准备您的定制容器映像。这将允许您拥有与您的用例相匹配的超集容器，并且可以部署到各种编排平台(如ECS或Kubernetes)。</p><p id="f970" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">起点应该是官方的超集映像(DockerHub 上的<a class="ae kz" href="https://hub.docker.com/r/apache/superset" rel="noopener ugc nofollow" target="_blank">)，然后在DockerHub文件中，您可以为您的用例添加额外的依赖项(如数据库驱动程序)。例如，如果我们想使用Redis，docker文件应该是这样的:</a></p><pre class="kk kl km kn gu nc nd ne nf aw ng bi"><span id="3b59" class="nh mg iu nd b gz ni nj l nk nl">FROM apache/superset:1.0.1<br/># We switch to root<br/>USER root<br/># We install the Python interface for Redis<br/>RUN pip install redis<br/># We switch back to the `superset` user<br/>USER superset</span></pre><p id="4efe" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此外，您应该创建一个包含您的定制配置的<em class="nm"> superset_config.py </em>文件。多亏了它，你可以覆盖超集的<a class="ae kz" href="https://github.com/apache/superset/blob/master/superset/config.py" rel="noopener ugc nofollow" target="_blank">主配置文件</a>中的值，比如认证方法或查询超时。</p><p id="4f5f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，我们可以通过添加以下命令来更新Dockerfile文件:</p><pre class="kk kl km kn gu nc nd ne nf aw ng bi"><span id="0345" class="nh mg iu nd b gz ni nj l nk nl"># We add the superset_config.py file to the container<br/>COPY superset_config.py /app/<br/># We tell Superset where to find it<br/>ENV SUPERSET_CONFIG_PATH /app/superset_config.py</span></pre><p id="eb32" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这将确保我们的定制配置被加载到容器中，并被超集识别。然后，您可以简单地在docker文件中添加一个CMD步骤来实际运行超集。</p><h1 id="0425" class="mf mg iu bd mh mi mj mk ml mm mn mo mp ka mq kb mr kd ms ke mt kg mu kh mv mw bi translated">缓存，缓存，缓存</h1><p id="2d7d" class="pw-post-body-paragraph la lb iu lc b ld mx jv lf lg my jy li lj mz ll lm ln na lp lq lr nb lt lu lv in bi translated">无论您想将超集连接到哪个(哪些)数据库，如果您计划大规模运行它，那么您肯定不希望它在每次有人打开仪表板时运行多个查询。</p><p id="c9bf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">该工具提供了不应被忽视的多种缓存可能性。至少，您应该尝试缓存超集自己的元数据和不同图表的数据。这样，在我们创建图表后，超集将把它的数据保存到我们配置的缓存中。之后，下次有人试图查看图表时(例如，通过仪表板)，超集将立即从缓存中检索数据，而不是在实际的数据库上运行查询。</p><p id="efac" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">基本上是一个Flask应用程序(它使用Flask-AppBuilder框架)，出于缓存的目的，Superset使用<a class="ae kz" href="https://pythonhosted.org/Flask-Cache/" rel="noopener ugc nofollow" target="_blank">Flask-Cache</a>——这反过来支持多个缓存后端，如Redis和Memcached。</p><p id="c5e5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果您还想将超集用于长时间运行的分析查询，那么您可以<a class="ae kz" href="https://superset.apache.org/docs/installation/async-queries-celery" rel="noopener ugc nofollow" target="_blank">使用Celery配置一个异步后端</a>，这样您就可以拥有一个查询结果的专用缓存机制。</p><h1 id="82c0" class="mf mg iu bd mh mi mj mk ml mm mn mo mp ka mq kb mr kd ms ke mt kg mu kh mv mw bi translated">设置身份验证</h1><p id="7223" class="pw-post-body-paragraph la lb iu lc b ld mx jv lf lg my jy li lj mz ll lm ln na lp lq lr nb lt lu lv in bi translated">不出所料，Superset也依赖Flask AppBuilder进行认证。它提供了多种身份验证选项，如OAuth和LDAP，可以轻松激活和配置。</p><p id="0100" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">对于可伸缩的设计，您可能希望激活一种身份验证方法，然后让用户在平台上执行自我注册。为此，您可以将下面两行添加到您的<em class="nm"> superset_config.py </em>中:</p><pre class="kk kl km kn gu nc nd ne nf aw ng bi"><span id="7281" class="nh mg iu nd b gz ni nj l nk nl">AUTH_USER_REGISTRATION = True<br/>AUTH_USER_REGISTRATION_ROLE = "a_custom_default_role"</span></pre><h1 id="6896" class="mf mg iu bd mh mi mj mk ml mm mn mo mp ka mq kb mr kd ms ke mt kg mu kh mv mw bi translated">权限很乱，不过没关系</h1><p id="d958" class="pw-post-body-paragraph la lb iu lc b ld mx jv lf lg my jy li lj mz ll lm ln na lp lq lr nb lt lu lv in bi translated">关于Superset的一个不太理想的方面是它的权限管理，在它的存储库上有一个公开的问题(大约两年前公开的),详细说明了当前实现的不同问题，并提出了一个更好的替代方案。</p><p id="b180" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">幸运的是，数据访问权限很容易配置，这个问题与Flask AppBuilder 生成的<a class="ae kz" href="https://flask-appbuilder.readthedocs.io/en/latest/security.html#permissions" rel="noopener ugc nofollow" target="_blank">特性相关的权限有关。</a></p><p id="3626" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了避免管理长长的权限列表，一种有效的方法是克隆现有角色<a class="ae kz" href="https://superset.apache.org/docs/security" rel="noopener ugc nofollow" target="_blank">中的一个</a>，并根据您的用例对其进行定制，这样您就可以在默认情况下为您的用户提供这个新的定制角色。</p><h1 id="6483" class="mf mg iu bd mh mi mj mk ml mm mn mo mp ka mq kb mr kd ms ke mt kg mu kh mv mw bi translated">结论</h1><p id="bb7c" class="pw-post-body-paragraph la lb iu lc b ld mx jv lf lg my jy li lj mz ll lm ln na lp lq lr nb lt lu lv in bi translated">得益于其庞大的社区，Superset迅速成为一个成熟且非常完整的项目(最近发布了1.0版本)。考虑到这一点，当您设计大规模BI平台时，它绝对应该被视为一个可行的选择。</p><p id="f638" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当我们考虑到它的一长串特性和功能时，它大规模工作所需的不同配置步骤只是一个小小的代价。Airbnb的设置以及他们如何利用其不同的功能(通过该公司博客上的一篇文章<a class="ae kz" href="https://medium.com/airbnb-engineering/supercharging-apache-superset-b1a2393278bd" rel="noopener">详细讨论了这一点)是其强大的最好例子。</a></p><p id="4d37" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，值得一提的是，Superset的创造者Maxime Beauchemin最近成立了<a class="ae kz" href="https://preset.io/" rel="noopener ugc nofollow" target="_blank">预置</a>——一家为Apache Superset提供托管云服务的公司。如果您希望最大限度地减少必要的配置工作，那么选择预置会更方便。</p></div><div class="ab cl nn no hy np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="in io ip iq ir"><p id="e005" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="nm">要了解更多数据工程内容，您可以订阅我的双周刊时事通讯Data Espresso，在其中我将讨论与数据工程和技术相关的各种主题:</em></p><div class="nu nv gq gs nw nx"><a href="https://dataespresso.substack.com/" rel="noopener  ugc nofollow" target="_blank"><div class="ny ab fp"><div class="nz ab oa cl cj ob"><h2 class="bd iv gz z fq oc fs ft od fv fx it bi translated">数据浓缩咖啡</h2><div class="oe l"><h3 class="bd b gz z fq oc fs ft od fv fx dk translated">数据工程更新和评论伴随您的午后咖啡。点击阅读数据咖啡，由马赫迪…</h3></div><div class="of l"><p class="bd b dl z fq oc fs ft od fv fx dk translated">dataespresso.substack.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol kt nx"/></div></div></a></div></div></div>    
</body>
</html>