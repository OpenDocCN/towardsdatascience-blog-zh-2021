<html>
<head>
<title>The Ultimate Guide to SQL CTEs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL CTEs的终极指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/the-ultimate-guide-to-sql-ctes-12a065187a15?source=collection_archive---------24-----------------------#2021-06-27">https://towardsdatascience.com/the-ultimate-guide-to-sql-ctes-12a065187a15?source=collection_archive---------24-----------------------#2021-06-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/6d726a3193bed3c18d725a363aa12702.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e7jceOvZ5rsGofkd5tBrEQ.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">迪米特拉·佩帕在<a class="ae jg" href="https://unsplash.com/s/photos/tables?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><div class=""/><div class=""><h2 id="a4d1" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">在5分钟内掌握常用的表格表达</h2></div><p id="330a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通用表表达式(cte)是一种SQL功能，允许您在一个简单易读的查询中执行复杂的多步转换。由于其强大的功能、可读性和灵活性，它们对于初学者和专家都是有用的工具。</p><h1 id="41b7" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">它们是如何工作的？</h1><p id="51d8" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">最简单地说，cte允许您创建临时数据集，以便稍后在查询中引用。</p><p id="3c0e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这些临时数据集在查询期间“可用”,但它们并不存储在数据库中，所以一旦执行了查询，它们就消失了。</p><h1 id="588f" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">我们为什么需要它们？</h1><p id="124e" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">cte的核心是做两件事:</p><ol class=""><li id="3f10" class="mr ms jj la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">它们解决了我喜欢称之为“逻辑之上的逻辑”的问题。当您必须执行数据操作，然后使用生成的数据集执行更多操作时，就会出现这种情况。</li><li id="cae9" class="mr ms jj la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">它们使您的代码更具可读性，也更容易使用</li></ol><h1 id="b758" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">语法看起来像什么？</h1><p id="d2a0" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">幸运的是，cte的语法非常简单:</p><ol class=""><li id="e96f" class="mr ms jj la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">首先键入关键字“with”+任何您想要用来引用您创建的数据集的名称+“as”</li><li id="416e" class="mr ms jj la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">在括号中写下您想要执行的查询</li><li id="ea89" class="mr ms jj la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">编写引用CTE的其他查询</li></ol><pre class="nf ng nh ni gt nj nk nl nm aw nn bi"><span id="015a" class="no lv jj nk b gy np nq l nr ns">with my_cte as </span><span id="b194" class="no lv jj nk b gy nt nq l nr ns">(select * from my_table)</span><span id="46b5" class="no lv jj nk b gy nt nq l nr ns">select * from my_cte;</span></pre><p id="771c" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">唯一不同的是，我们可以在同一个查询中使用多个cte(用逗号分隔):</p><pre class="nf ng nh ni gt nj nk nl nm aw nn bi"><span id="0e23" class="no lv jj nk b gy np nq l nr ns">with cte1 as</span><span id="d0c3" class="no lv jj nk b gy nt nq l nr ns">(select * from my_table1)</span><span id="85ca" class="no lv jj nk b gy nt nq l nr ns">, cte2 as </span><span id="b7e3" class="no lv jj nk b gy nt nq l nr ns">(select * from my_table2)</span><span id="476d" class="no lv jj nk b gy nt nq l nr ns">select cte1 <br/>union all<br/>select cte2;</span></pre><h1 id="c3d8" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">感觉还是很理论，能给我举个例子吗？</h1><p id="23cc" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">好的，让我们用一个Kaggle数据集快速地看一个例子，它包含了<a class="ae jg" href="https://www.kaggle.com/rishitjavia/netflix-movie-rating-dataset" rel="noopener ugc nofollow" target="_blank">网飞电影评分</a>。每条记录都是用户对电影的评价:</p><figure class="nf ng nh ni gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nu"><img src="../Images/5d58408450730f1ab66b19652db57db2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cy8_YPOZPvZx--uyzrv8Qw.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者图片</p></figure><p id="4acc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，假设我们想要选择平均收视率最高的10%的所有电影。</p><p id="3245" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是cte的一个很好的用例，因为它涉及多层次的聚合。</p><p id="569d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">处理这个查询的最好方法是一步一步地构建它。</p><p id="44c3" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我们需要计算每部电影的平均评分:</p><pre class="nf ng nh ni gt nj nk nl nm aw nn bi"><span id="ae28" class="no lv jj nk b gy np nq l nr ns">select movie_ID, Name, avg(Rating) as avg_rating<br/>from netflix.ratings<br/>group by 1,2;</span></pre><figure class="nf ng nh ni gt iv gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/a4ac12ed3376e25c844e68325160d4da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*YHIdGbpz-FOE_IbvgBEirQ.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者图片</p></figure><p id="b563" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后我们需要得到平均评分的十分位数。让我们用一个CTE吧！</p><pre class="nf ng nh ni gt nj nk nl nm aw nn bi"><span id="45b3" class="no lv jj nk b gy np nq l nr ns">with avg_ratings as</span><span id="80d9" class="no lv jj nk b gy nt nq l nr ns">(select Movie_ID, Name, avg(Rating) as avg_rating<br/>from netflix.ratings<br/>group by 1, 2)</span><span id="7dd2" class="no lv jj nk b gy nt nq l nr ns">select *, ntile(10) over (order by avg_rating desc) as rating_decile <br/>from avg_ratings;</span></pre><figure class="nf ng nh ni gt iv gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/9d9c4eb3a59ccd2760eb2ff0177e8c8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*sAaGBGL3i8hWFEM3QJC3Aw.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者图片</p></figure><p id="6c57" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，我们首先在CTE中获得电影的平均评级，然后在后续查询中引用该表。</p><p id="b47c" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们的最后一步是过滤，只包括rating_decile = 1的电影。我们可以通过使用第二个CTE来解决这个问题！</p><pre class="nf ng nh ni gt nj nk nl nm aw nn bi"><span id="e294" class="no lv jj nk b gy np nq l nr ns">with avg_ratings as</span><span id="1a41" class="no lv jj nk b gy nt nq l nr ns">(select Movie_ID, Name, avg(Rating) avg_rating<br/>from netflix.ratings<br/>group by 1, 2),</span><span id="896c" class="no lv jj nk b gy nt nq l nr ns">avg_ratings_decile as</span><span id="d275" class="no lv jj nk b gy nt nq l nr ns">(select *, ntile(10) over (order by avg_rating desc) as rating_decile <br/>from avg_ratings)</span><span id="71a6" class="no lv jj nk b gy nt nq l nr ns">select *<br/>from avg_ratings_decile<br/>where rating_decile = 1;</span></pre><figure class="nf ng nh ni gt iv gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/223e88601eedd355675069e2bae7c8ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*LrqKV-26Qx7wEq6L8XyD3A.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">作者图片</p></figure><p id="1392" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最终，CTEs帮助我们在一个查询中执行了三个后续的数据操作:</p><ol class=""><li id="ed73" class="mr ms jj la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">计算每部电影的平均评分</li><li id="42f5" class="mr ms jj la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">计算平均分之上的十分位数</li><li id="7f4f" class="mr ms jj la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">十分位数= 1的过滤器</li></ol><h1 id="52f7" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">但是等等，我们可以用子查询来做！</h1><p id="3755" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">是的。是的，我们可以。</p><p id="4855" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是子查询读起来绝对是一团糟，因为当试图理解逻辑时，它们需要你从里到外地工作。例如，我们上面的查询使用子查询如下所示:</p><pre class="nf ng nh ni gt nj nk nl nm aw nn bi"><span id="e1b3" class="no lv jj nk b gy np nq l nr ns">select *</span><span id="9584" class="no lv jj nk b gy nt nq l nr ns">from</span><span id="6856" class="no lv jj nk b gy nt nq l nr ns">(select *, ntile(10) over (order by avg_rating desc) as rating_decile</span><span id="9826" class="no lv jj nk b gy nt nq l nr ns">from</span><span id="5497" class="no lv jj nk b gy nt nq l nr ns">(select Movie_ID, Name, avg(Rating) avg_rating<br/>from netflix.ratings<br/>group by 1, 2) as avg_ratings) avg_ratings_decile</span><span id="0410" class="no lv jj nk b gy nt nq l nr ns">where rating_decile = 1;</span></pre><p id="5ff8" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">像这样剖析代码——使用所有不同的括号和别名——可能是一场噩梦。cte干净多了。</p><h1 id="e25d" class="lu lv jj bd lw lx ly lz ma mb mc md me kp mf kq mg ks mh kt mi kv mj kw mk ml bi translated">我想我明白了，但是我怎样才能得到更多的练习呢？</h1><p id="1c32" class="pw-post-body-paragraph ky kz jj la b lb mm kk ld le mn kn lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">获得更多实践的一个简单方法是自己完成上面的例子。</p><p id="c7f4" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为此，我建议:</p><ol class=""><li id="d3eb" class="mr ms jj la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">点击从Kaggle <a class="ae jg" href="https://www.kaggle.com/rishitjavia/netflix-movie-rating-dataset" rel="noopener ugc nofollow" target="_blank">下载免费数据集</a></li><li id="ea7e" class="mr ms jj la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">上传到SQL数据库。如果您还没有设置，您可以在下面找到我的指南，了解如何快速有效地设置:</li></ol><div class="is it gp gr iu nx"><a rel="noopener follow" target="_blank" href="/4-steps-to-start-practicing-sql-at-home-cb771beeca20"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd jk gy z fp oc fr fs od fu fw ji bi translated">在家开始练习SQL的4个步骤</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">下载MySQL自己做</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">towardsdatascience.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol ja nx"/></div></div></a></div><p id="defc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">3.尝试自己重新创建我在上面写的cte(注意，我首先将收视率数据与电影数据结合起来，以添加电影名称)</p><p id="303b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">4.自己写问题给自己回答！没有什么比提出你自己的研究问题更好的了，因为它可以帮助你内化“何时”和“为什么”你可能想要使用某些功能</p><p id="8a59" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la jk">如果您认为本文有帮助，请:</strong></p><ol class=""><li id="1d67" class="mr ms jj la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">对您希望我接下来撰写的SQL或数据科学主题发表评论，然后</li><li id="639e" class="mr ms jj la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated"><strong class="la jk"> <em class="om">订阅我的</em> </strong> <a class="ae jg" href="https://subscribe.to/everythingdata" rel="noopener ugc nofollow" target="_blank"> <strong class="la jk"> <em class="om">免费邮箱列表</em> </strong> </a></li></ol><p id="ce52" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您还可以在下面找到我的其他SQL指南:</p><div class="is it gp gr iu nx"><a rel="noopener follow" target="_blank" href="/6-hidden-sql-mistakes-to-avoid-2e771bed085b"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd jk gy z fp oc fr fs od fu fw ji bi translated">要避免的6个隐藏的SQL错误</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">他们在雷达下飞行，给你带来麻烦</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">towardsdatascience.com</p></div></div><div class="og l"><div class="on l oi oj ok og ol ja nx"/></div></div></a></div><div class="is it gp gr iu nx"><a rel="noopener follow" target="_blank" href="/you-know-excel-time-to-learn-sql-e77a2b5c8fbb"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd jk gy z fp oc fr fs od fu fw ji bi translated">你知道Excel。该学SQL了。</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">9个核心excel功能转化为SQL</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">towardsdatascience.com</p></div></div><div class="og l"><div class="oo l oi oj ok og ol ja nx"/></div></div></a></div></div></div>    
</body>
</html>