<html>
<head>
<title>Building and Sharing Reports at Scale With Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python构建和共享大规模报表</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-and-sharing-reports-at-scale-with-python-49dfdf9fa133?source=collection_archive---------28-----------------------#2021-05-04">https://towardsdatascience.com/building-and-sharing-reports-at-scale-with-python-49dfdf9fa133?source=collection_archive---------28-----------------------#2021-05-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/f75208ca5a5ef3d6465fe503e7d5264a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gQghKdE5JAeeCf9PwjcZdQ.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">📸—作者图片</p></figure><div class=""/><div class=""><h2 id="65cb" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">我们如何构建我们的内部报告系统来大规模共享报告</h2></div><p id="58ca" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">报告对于任何足够大的数据驱动型公司的运营都至关重要，HousingAnywhere 也不例外。我们所有部门每天都在运行各种各样的报告，其中大多数都是使用<a class="ae lq" href="https://mode.com/" rel="noopener ugc nofollow" target="_blank">模式分析</a>运行的。虽然Mode是满足我们大部分报告需求的强大工具，但它(像许多SaaS产品一样)有我们内部无法克服的局限性。为了适应我们的快速增长，我们发现，如果我们想提高报告水平，我们需要一个更加灵活的额外工具。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="13fe" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">问题</strong></p><p id="d4bf" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在HousingAnywhere进行报告的一个最重要的方面是共享单个城市级别的报告。作为一个专注于3-12个月住宿的住宿租赁平台，我们在欧洲多个城市提供服务，负责每个城市的团队需要能够了解该城市的具体情况。因此，我们有大量连续运行多次的报告，但每次都是针对不同的城市。在小范围内，这很好，但是每次都从头开始构建报告不是一个可扩展的解决方案。2021年，我们的重点城市数量从15个增加到32个，增加了一倍多(T7)，这意味着我们现在有32个城市需要构建这些报告(我们的目标是在未来几年增加这个数字)。因此，我们的旧系统被证明效率太低，成本太高。</p><figure class="lz ma mb mc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ly"><img src="../Images/5285b013bc68c8d9932d7e6597a70738.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xULcYook2ZXD5IhW"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated"><em class="md">在旧系统中，每次我们想要构建报告时，都必须运行所有n个查询。图片作者。</em></p></figure><p id="762e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在一个例子中，我们发现我们在雪花(我们的数据仓库)<em class="me">上为一份报告</em>每月支付超过50€；当我们在2021年初增加新的重点城市时，这一成本会进一步增加。仅一份报告每年在数据仓库上就要花费数百欧元？像这样的管理费用是不可能快速增长的。构建我们自己的系统也将使我们在需要安装和管理的任何包或集成上有充分的灵活性。</p><p id="f304" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们遇到的另一个问题涉及到对外共享我们的报告(例如，对我们的股东)。我们需要能够轻松地与组织外部的各方共享报告，如果报告系统不能处理这样的任务，这可能会很棘手。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="775a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">解决方案</strong></p><p id="df00" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们想要一个可以“缓存”数据的系统，这意味着我们可以运行一次查询，然后使用结果数据创建任意多的报告。这将允许我们建立大量的报告，但成本大大降低。我们只运行一次，而不是每个查询运行32次以上；将雪花的负荷减少到原来的一小部分。每当我们想要构建一个报告时，就会加载这些缓存数据，并可以根据一组给定的参数对其进行过滤。</p><figure class="lz ma mb mc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ly"><img src="../Images/2ffaa8bade202251c061e65a720d49aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1SPCI2qQwwquh3DI"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">新系统:所有查询只运行一次，然后在运行时过滤。数据仓库的负载显著降低。图片作者。</p></figure><p id="7f25" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">最终完成的报告可以以PDF格式共享到电子邮件地址、Slack频道、Google Drive文件夹或其他任何使用Python实现的地方。它还必须易于与我们当前的技术体系集成，因此将其实现为API是最有意义的:一个端点触发对报告的查询，一个端点触发报告本身的运行。这将使自动化调度过程变得容易，同时也使构建能够管理系统的web UI变得简单。它灵活高效，让我们在构建报告时有更多选择。</p><p id="a322" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们创建一个报告只需要几个文件:</p><ul class=""><li id="4f48" class="mf mg jf kw b kx ky la lb ld mh lh mi ll mj lp mk ml mm mn bi translated">一组查询。收集数据的sql文件</li><li id="2612" class="mf mg jf kw b kx mo la mp ld mq lh mr ll ms lp mk ml mm mn bi translated">包含描述如何过滤数据的函数的Python文件</li><li id="084e" class="mf mg jf kw b kx mo la mp ld mq lh mr ll ms lp mk ml mm mn bi translated">一个Python文件，包含用于绘制过滤数据的函数</li><li id="c99a" class="mf mg jf kw b kx mo la mp ld mq lh mr ll ms lp mk ml mm mn bi translated">存储报表布局的文本文件</li></ul><p id="d716" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">必须指出的是，与使用Mode或Tableau等传统工具构建报告相比，这一过程的用户友好性较差。这增加了创建报告所需的时间，使得将该系统视为此类工具的替代品变得不合理。我们的目标是将它们串联使用，使用我们的内部系统来处理需要额外TLC的报告。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="2aa8" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">实施</strong></p><figure class="lz ma mb mc gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ly"><img src="../Images/1f7a911218588f3f07d6a431a63f18ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ef0lu8kjvdhlahZ2"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">新系统概述。作者图片</p></figure><p id="2be6" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">该系统本身由打包在Docker容器中的Flask API组成，该容器部署在Google Kubernetes引擎上。我们的大部分技术已经部署在GCP，所以这是最简单的快速部署方法。</p><p id="fefa" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">如果进行API调用来运行特定报告的查询，则每个。使用<a class="ae lq" href="https://docs.snowflake.com/en/user-guide/python-connector.html" rel="noopener ugc nofollow" target="_blank">雪花连接器</a>收集并运行与报告对应的sql文件。结果在本地保存为。csv文件，可以在构建报告时引用。</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mt mu l"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">示例代码展示了如何使用Python连接器查询雪花，并将每个结果保存为CSV格式</p></figure><p id="f774" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">为了共享报告，API调用包括报告的参数和目的地，例如“将<em class="me">柏林</em>的<em class="me">日报</em>发送到<em class="me"># team-Berlin</em>Slack channel”。然后，系统使用这些参数构建报告，并将其发送给接收人。要构建报告本身，这个过程并不复杂。</p><p id="0622" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">数据过滤非常简单，由加载。csv文件，并使用Pandas过滤它们。输入参数采用字典的形式，允许使用任意多的过滤器。过滤后的数据被保存到将用于图表的数据帧字典中</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mt mu l"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">一个基本过滤函数的示例，根据API调用中给定的参数过滤数据。对这些函数中的每一个进行迭代，并在图表中使用生成的数据框</p></figure><p id="65bc" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这些图形遵循类似的格式:一系列Python函数接受前面提到的字典，创建图形并将这些图形保存为。svg图像。这为我们选择图形库(如Plotly、Matplotlib、Altair)提供了很大的灵活性，因为我们可以使用任何允许我们将图形保存到图像的库。</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mt mu l"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">一个基本图形函数的例子。graph_data是使用过滤函数中的数据填充的。然后可以在HTML模板中链接这些图像</p></figure><p id="b7c0" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">一旦这些图像被保存，它们可以在一个HTML文件中被链接。为了给每个图片添加特定的链接，我们使用Jinja用图片填充一个基本的HTML模板。为了获得正确的顺序，我们使用一个简单的“layout.txt”文件来记录报告的布局。在这里，我们可以添加图形名称、标题、分页符等。</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mt mu l"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">一页报表的layout.txt示例。显示一个标题、三个图表和一个分页符</p></figure><p id="089d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在本例中，我们有三个图形图像<em class="me"> bookings_kpis.svg </em>、<em class="me"> bookings_bar.svg </em>和<em class="me"> bookings_forecast.svg </em>，它们与部分标题一起添加，后面是分页符。这些被提取并解析，以允许<a class="ae lq" href="https://pypi.org/project/Jinja2/" rel="noopener ugc nofollow" target="_blank"> Jinja </a>注入相应的HTML。格式文件的每一行描述了最终HTML报告中的一个元素。HTML文件完成后，使用<a class="ae lq" href="https://pypi.org/project/pdfkit/" rel="noopener ugc nofollow" target="_blank"> PDFKit </a>将其转换为PDF。</p><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mt mu l"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">HTML模板的简化版本</p></figure><figure class="lz ma mb mc gt is"><div class="bz fp l di"><div class="mt mu l"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">使用Jinja填充HTML模板的示例代码</p></figure><p id="ae9d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">从那里，我们可以发送PDF到Slack，电子邮件，谷歌驱动器或任何必要的地方。这意味着我们还能够为外部电子邮件添加一个白名单，让我们有机会在住宅之外的任何地方指定电子邮件地址，以便与他们共享报告。</p><p id="e6b6" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们使用一个非常基本的定制气流操作器来安排我们的报告。我们在气流方面的工作已经在以前的文章中提到过，在那里我们详细介绍了我们使用Selenium的<a class="ae lq" rel="noopener" target="_blank" href="/scraping-the-web-with-selenium-on-google-cloud-composer-airflow-7f74c211d1a1">网络抓取</a>或我们的<a class="ae lq" rel="noopener" target="_blank" href="/testing-airflow-jobs-on-google-cloud-composer-using-pytest-9e0a1198b4cd"> CI/CD设置</a>，这是一个我们经常使用的工具，因此简单的集成就可以将我们的报告系统和气流连接起来，这非常有帮助。它使我们能够以一种简洁的方式轻松安排和共享报告，而不必偏离我们当前的技术堆栈。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="c217" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">该项目的目标是授予数据团队扩展能力，同时继续为每个城市提供所需的支持。在API发布之前，我们努力在不花费大量成本的情况下，高效地构建15个重点城市的报告。自从我们部署了这个系统，我们就能够以很低的成本定期分享高质量的报告。我们可以继续为每个城市提供这样的报告，不管未来几年我们支持多少个城市。</p><p id="ae7e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">感谢<a class="ae lq" href="https://medium.com/@julian.smidek" rel="noopener"> Julian Smidek </a>和<a class="ae lq" href="https://medium.com/@bdanh96" rel="noopener"> Duc Anh Bui </a>在整个项目和本文中给予的支持和建议。</p></div></div>    
</body>
</html>