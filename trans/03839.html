<html>
<head>
<title>openCV GPU usage disappoints…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">openCV GPU的使用令人失望…</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/opencv-gpu-usage-disappoints-bc331329932d?source=collection_archive---------25-----------------------#2021-03-30">https://towardsdatascience.com/opencv-gpu-usage-disappoints-bc331329932d?source=collection_archive---------25-----------------------#2021-03-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7204" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将GPU与您的openCV代码结合使用，获得性能提升…不！</h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi kg"><img src="../Images/37a9634cff89939cf337f5715c80f05c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mXxbcnT1VIexRz7xgWSeZw.png"/></div></div></figure><p id="f64c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">有好几次，我被在GPU上使用关键openCV调用的诱惑所吸引。最近一次是matchTemplate呼叫，在此之前是与视觉里程计相关的呼叫。啊，失望！</p><p id="7335" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">现在的情况是，我有31个可能的图像(或模板)来匹配来自传感器的图像。我想找出哪一个最适合——大图像上的任何地方。对31幅图像中的每一幅使用openCV调用matchTemplate，我得到了最佳匹配的分数——最高分就是赢家。我计划在nVidia单板计算机上运行这个——无论是nano、Xavier还是任何适合成本和性能的计算机。</p><p id="4e4d" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">首先，正在使用的代码的基础知识(无聊的部分省略…)</p><pre class="kh ki kj kk gt lo lp lq lr aw ls bi"><span id="2782" class="lt lu iq lp b gy lv lw l lx ly">// Initialize the GPU TemplateMatching object</span><span id="791a" class="lt lu iq lp b gy lz lw l lx ly">// - running in 8 bit mode</span><span id="2103" class="lt lu iq lp b gy lz lw l lx ly">cv::Ptr&lt;cv::cuda::TemplateMatching&gt; cvCuda;</span><span id="7fe1" class="lt lu iq lp b gy lz lw l lx ly">cvCuda = cv::cuda::createTemplateMatching(CV_8U, cv::TM_CCORR);// , Size(0, 0));</span><span id="c56f" class="lt lu iq lp b gy lz lw l lx ly">// Initialize the big image - in GPU land</span><span id="0b44" class="lt lu iq lp b gy lz lw l lx ly">cv::cuda::GpuMat img_Gpu;</span><span id="8df8" class="lt lu iq lp b gy lz lw l lx ly">img_Gpu.upload(inputImg);</span><span id="89b4" class="lt lu iq lp b gy lz lw l lx ly">// Initialize the templates for matching - in GPU land</span><span id="7cf3" class="lt lu iq lp b gy lz lw l lx ly">for (int i=0; i&lt;kTemplateAngles; i++)  {</span><span id="a630" class="lt lu iq lp b gy lz lw l lx ly">    cv::cuda::GpuMat tmplGMA_GPU;</span><span id="e929" class="lt lu iq lp b gy lz lw l lx ly">    tmplGMA_GPU.upload(newGMA);</span><span id="b1af" class="lt lu iq lp b gy lz lw l lx ly">    vTmplGMA_Gpu.push_back( tmplGMA_GPU );</span><span id="e2d0" class="lt lu iq lp b gy lz lw l lx ly">}</span><span id="15cb" class="lt lu iq lp b gy lz lw l lx ly">// Initialize the results matrix in GPU land</span><span id="20fe" class="lt lu iq lp b gy lz lw l lx ly">int result_cols =  monoImg.cols - baseGMAImg.cols + 1;</span><span id="4681" class="lt lu iq lp b gy lz lw l lx ly">int result_rows = monoImg.rows - baseGMAImg.rows + 1;</span><span id="cbee" class="lt lu iq lp b gy lz lw l lx ly">cv::Mat result( result_rows, result_cols, CV_32FC1 );</span><span id="fd11" class="lt lu iq lp b gy lz lw l lx ly">cv::cuda::GpuMat result_Gpu( result_rows, result_cols, CV_32FC1 );</span><span id="ccf5" class="lt lu iq lp b gy lz lw l lx ly">// start timer - and do more than one loop to take multiple seconds</span><span id="a69a" class="lt lu iq lp b gy lz lw l lx ly">// loop through our 31 templates</span><span id="96cb" class="lt lu iq lp b gy lz lw l lx ly">for (int i=0; i&lt;kTemplateAngles; i++)  {</span><span id="4170" class="lt lu iq lp b gy lz lw l lx ly">    cvCuda-&gt;match( img_Gpu, vTmplGMA_Gpu[i], result_Gpu );</span><span id="603f" class="lt lu iq lp b gy lz lw l lx ly">    cv::cuda::minMaxLoc( result_Gpu, &amp;minVal, &amp;maxVal, &amp;minLoc, &amp;maxLoc );</span><span id="c65f" class="lt lu iq lp b gy lz lw l lx ly">}</span><span id="d315" class="lt lu iq lp b gy lz lw l lx ly">// end timer</span></pre><p id="37b7" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">好吧，让我们直接看结果:</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/9b8ef3fe5db4b60e931225347f293d0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*g_GgNQ9OUeyJKu8F4Lud-Q.png"/></div></figure><p id="f3be" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在桌面上，GPU几乎慢了3倍！在Nano上— <em class="mb">只比</em>慢了将近2倍。</p><p id="06b3" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这似乎是网络上常见的抱怨。概述的主要问题似乎是:</p><ul class=""><li id="5a92" class="mc md iq ku b kv kw ky kz lb me lf mf lj mg ln mh mi mj mk bi translated">(上下文的)初始化可能需要10秒钟。我已经做了多次定时循环——post初始化。第二次稍微快一点，比如说快15%，但是之后时间就稳定了(如上表所示)。)</li><li id="ae00" class="mc md iq ku b kv ml ky mm lb mn lf mo lj mp ln mh mi mj mk bi translated">将数据移动到GPU内存需要时间。当然，这就是为什么我试图提前做这些。</li><li id="1d5f" class="mc md iq ku b kv ml ky mm lb mn lf mo lj mp ln mh mi mj mk bi translated">或许其他人，可以在底部随意评论。还有…</li><li id="c342" class="mc md iq ku b kv ml ky mm lb mn lf mo lj mp ln mh mi mj mk bi translated">与CUDA启动/结束的开销相比，GPU的实际执行时间相对较短——在快速GPU上运行的任何潜在收益都将丢失。</li></ul><p id="3b6a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">最后，我认为是核心问题。也就是说，<strong class="ku ir"> <em class="mb">我在GPU上做得还不够，无法补偿来回调用</em> </strong>所产生的所有开销。(<em class="mb">现在如果matchTemplate上有一个openCV包装器就好了——比方说迭代N个模板…) </em></p><p id="e495" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">顺便说一下，使用GPU仍然有意义，即使它比CPU花费更多的时间。在我做这项调查的第一个案例中，我们受到CPU的限制。将任何东西卸载到GPU将释放CPU来执行其他任务——只要我们不花费太多时间！</p><p id="00d2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">总之，也许我错过了一些东西，但我两次都希望在openCV调用中使用GPU来提高速度。</p></div></div>    
</body>
</html>