<html>
<head>
<title>Deploying An ML Model With FastAPI — A Succinct Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用FastAPI部署ML模型——简明指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/deploying-an-ml-model-with-fastapi-a-succinct-guide-69eceda27b21?source=collection_archive---------10-----------------------#2021-04-04">https://towardsdatascience.com/deploying-an-ml-model-with-fastapi-a-succinct-guide-69eceda27b21?source=collection_archive---------10-----------------------#2021-04-04</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="b303" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">如何使用NLP模型作为API——智能的、生产就绪的方式。</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/181ae1226f75564de2ce86af0bb0050c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CMrJe-Z2RiTARj4R"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@berko?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">冉贝尔科维奇</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="b146" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">FastAPI是一种更新、更好的方法，可以将您的机器学习模型部署为REST API，用于web应用程序。在他们的<a class="ae kz" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank">官方文档</a>中，他们声称这是启动并运行生产的最快方法，自然，这激起了我的兴趣。</p><blockquote class="lw lx ly"><p id="d9ef" class="la lb lz lc b ld le jv lf lg lh jy li ma lk ll lm mb lo lp lq mc ls lt lu lv in bi translated">准备好探索这个新的库，我继续前进，用<strong class="lc iv"> spacy </strong>做了一个简单的NLP模型，并试图围绕它构建一个API。老实说，它相当简单，非常方便，有无数有用的函数，我在不到一个小时的时间里就准备好了API——还有测试，也没有Postman或CURL。</p></blockquote><p id="9702" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">炒作够了吧？下面我描述一下<em class="lz">你</em>可以用你自己的ML模型做同样的事情的步骤。</p><p id="133e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">👇我们走吧！</p><h2 id="2212" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">设置您的环境</h2><p id="106d" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">设置虚拟环境的两个简单步骤:</p><ol class=""><li id="c38c" class="nb nc iu lc b ld le lg lh lj nd ln ne lr nf lv ng nh ni nj bi translated">激活新的<strong class="lc iv"> pipenv </strong> env:</li></ol><pre class="kk kl km kn gu nk nl nm nn aw no bi"><span id="30b2" class="md me iu nl b gz np nq l nr ns">pipenv shell</span></pre><p id="e26c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">2.在其中安装库:</p><pre class="kk kl km kn gu nk nl nm nn aw no bi"><span id="d736" class="md me iu nl b gz np nq l nr ns">pipenv install spacy spacytextblob pydantic fastapi uvicorn</span></pre><h2 id="d292" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">构建模型</h2><p id="d156" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">在尝试任何新的库时，我总是更专注于探索库提供的确切功能，而不是背景细节。</p><p id="fea7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">出于这个原因，我只用最少的设置用spacy构建了一个简单的情绪分析模型，以便快速获得一个模型来进行预测。</p><p id="f2f0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这是模型的完整代码，在一个名为<strong class="lc iv"> model.py. </strong>的模块中定义</p><pre class="kk kl km kn gu nk nl nm nn aw no bi"><span id="2f11" class="md me iu nl b gz np nq l nr ns">import spacy<br/>from spacytextblob import SpacyTextBlob<br/>from pydantic import BaseModel</span><span id="b9ed" class="md me iu nl b gz nt nq l nr ns">class SentimentQueryModel(BaseModel):<br/>    text : str</span><span id="dda2" class="md me iu nl b gz nt nq l nr ns">class SentimentModel:<br/>    def get_sentiment(self, text):<br/>        nlp = spacy.load('en_core_web_sm')<br/>        spacy_text_blob = SpacyTextBlob()<br/>        nlp.add_pipe(spacy_text_blob)</span><span id="4013" class="md me iu nl b gz nt nq l nr ns">doc = nlp(text)</span><span id="e617" class="md me iu nl b gz nt nq l nr ns">polarity = doc._.sentiment.polarity      <br/>        subjectivity = doc._.sentiment.subjectivity</span><span id="b731" class="md me iu nl b gz nt nq l nr ns">return polarity, subjectivity</span></pre><p id="6275" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">是的，真的是这个。如果你像我一样从FastAPI开始，我建议你先用这个简单的模型探索这个API及其特性，然后再去开发更复杂、更大的模型。</p><p id="312b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我简单解释一下代码:</p><ul class=""><li id="309e" class="nb nc iu lc b ld le lg lh lj nd ln ne lr nf lv nu nh ni nj bi translated">我们首先导入项目所需的库</li><li id="35f5" class="nb nc iu lc b ld nv lg nw lj nx ln ny lr nz lv nu nh ni nj bi translated"><strong class="lc iv"> SentimentQueryModel </strong>只是一个模型，包含我们对这个模型的唯一查询——我们将预测其情感的文本。<a class="ae kz" href="https://pydantic-docs.helpmanual.io" rel="noopener ugc nofollow" target="_blank"> Pydantic </a>库有助于确保我们可以快速拥有一个包含模型所需数据的字段，这将是<strong class="lc iv"> <em class="lz">文本</em> </strong>变量。FastAPI文档还描述了许多使用这个库声明数据字段的方法。</li><li id="5ddb" class="nb nc iu lc b ld nv lg nw lj nx ln ny lr nz lv nu nh ni nj bi translated"><strong class="lc iv">sensition model</strong>是加载spacy tokeniser和spacytextblob库并对文本执行情感预测的类</li></ul><p id="35cf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">情感分析得分的两个主要组成部分是:</strong></p><p id="ae6d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">极性</strong> —它是一个位于[-1，1]范围内的浮点数，其中1表示完全肯定的陈述，而-1表示完全否定的陈述。</p><p id="dda4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">主观性</strong>—<em class="lz">主观</em>句一般指个人观点、情感或判断，而<em class="lz">客观</em>则指事实信息。<strong class="lc iv">主观性</strong>分量<strong class="lc iv"> </strong>是一个位于[0，1]范围内的浮点数。</p><p id="4c6f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，我们已经从模型中返回了两个分数，让我们转到实际构建API的部分。</p><h2 id="719f" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">制作API</h2><p id="05cd" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">首先，我们导入我们的库和模块:</p><pre class="kk kl km kn gu nk nl nm nn aw no bi"><span id="90af" class="md me iu nl b gz np nq l nr ns">import uvicornfrom fastapi <br/>import FastAPIfrom model <br/>import SentimentModel, SentimentQueryModel</span></pre><p id="beba" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然后，我们实例化FastAPI对象和预测类:</p><pre class="kk kl km kn gu nk nl nm nn aw no bi"><span id="c0bd" class="md me iu nl b gz np nq l nr ns">app = FastAPI()<br/>model = SentimentModel()</span></pre><p id="80d7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，我们创建了一个新函数，通过一个<strong class="lc iv"> POST </strong>请求来获取预测:</p><pre class="kk kl km kn gu nk nl nm nn aw no bi"><span id="1117" class="md me iu nl b gz np nq l nr ns">@app.post('/predict')<br/>def predict(data: SentimentQueryModel):    <br/>    data = data.dict()    <br/>    polarity, subjectivity = model.get_sentiment(data['text'])<br/>    return { 'polarity': polarity,        <br/>             'subjectivity': subjectivity    <br/>           }</span></pre><p id="c12e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">确保我们可以从POST函数中访问作为JSON对象的文本字符串对象。</p><p id="1440" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">得到分数后，我们简单地将它们作为另一个dictionary对象返回。</p><p id="f363" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在我们完成了，我们继续运行应用程序，代码如下:</p><pre class="kk kl km kn gu nk nl nm nn aw no bi"><span id="0cd9" class="md me iu nl b gz np nq l nr ns">if __name__ == '__main__':    <br/>    uvicorn.run(app, host='127.0.0.1', port=8000)</span></pre><p id="26c0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们完事了。这是完整的代码，你的API已经可以测试了。</p><h2 id="4127" class="md me iu bd mf mg mh dn mi mj mk dp ml lj mm mn mo ln mp mq mr lr ms mt mu mv bi translated">总结→测试您的API</h2><p id="afb1" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">这是学习使用FastAPI最令人兴奋的部分之一。显然，通过它与SwaggerUI的集成，你可以直接测试API，而不需要任何外部工具，如<strong class="lc iv"> Postman </strong>或终端命令<strong class="lc iv"> CURL </strong>。</p><p id="2a93" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">导航到地址<code class="fe oa ob oc nl b">http://127.0.0.1:8000/docs </code>以查看您的API的运行情况。按下<strong class="lc iv">试一试</strong>按钮。</p><p id="1539" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">它应该是这样的:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj od"><img src="../Images/7ca5c0754d8cb54a0400cf08b0f0603c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6m3461Z0Mq3X23NEvWKD7Q.png"/></div></div></figure><p id="6e9f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">继续在字段中输入您的文本。</p><p id="4181" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，按下<strong class="lc iv">执行</strong>。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oe"><img src="../Images/26933e590fc88610b4eb388b94907dea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*51x3HKfxpR7ZISQNTQUxSQ.png"/></div></div></figure><p id="1fe9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在你知道了！这些预测，以及浏览器本身返回的响应代码。是不是很神奇？</p><p id="a326" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">请放心，我将来也会广泛地探索这个库！</p><p id="7d60" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">整个代码也可以在这个要点<a class="ae kz" href="https://gist.github.com/yashprakash13/998e7322769ce3257b9f8dae786c0e36" rel="noopener ugc nofollow" target="_blank">获得。</a></p><p id="8d9d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然而，如果您已经遵循了这一点，那么您应该已经有了可以开始构建自己的API的代码！</p><p id="3bb8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">感谢阅读！:)</p></div><div class="ab cl of og hy oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="in io ip iq ir"><blockquote class="lw lx ly"><p id="2712" class="la lb lz lc b ld le jv lf lg lh jy li ma lk ll lm mb lo lp lq mc ls lt lu lv in bi translated">单独学习数据科学可能会很难。跟我来，让我们一起变得有趣。😁</p><p id="13d9" class="la lb lz lc b ld le jv lf lg lh jy li ma lk ll lm mb lo lp lq mc ls lt lu lv in bi translated">在<a class="ae kz" href="https://twitter.com/csandyash" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上与我联系。</p></blockquote><p id="91d6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这里是我所有数据科学故事的代码库。快乐学习！⭐️</p></div><div class="ab cl of og hy oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="in io ip iq ir"><p id="cb52" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">另外，看看我的另一篇文章，你可能会感兴趣:</p><div class="om on gq gs oo op"><a rel="noopener follow" target="_blank" href="/making-your-first-kaggle-submission-36fa07739272"><div class="oq ab fp"><div class="or ab os cl cj ot"><h2 class="bd iv gz z fq ou fs ft ov fv fx it bi translated">首次提交Kaggle</h2><div class="ow l"><h3 class="bd b gz z fq ou fs ft ov fv fx dk translated">一个易于理解的指南，开始与竞争，并成功建模，使你的第一…</h3></div><div class="ox l"><p class="bd b dl z fq ou fs ft ov fv fx dk translated">towardsdatascience.com</p></div></div><div class="oy l"><div class="oz l pa pb pc oy pd kt op"/></div></div></a></div></div></div>    
</body>
</html>