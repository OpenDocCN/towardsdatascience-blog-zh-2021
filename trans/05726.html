<html>
<head>
<title>Using Apache Airflow DockerOperator with Docker Compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Apache Airflow DockerOperator和Docker Compose</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-apache-airflow-dockeroperator-with-docker-compose-57d0217c8219?source=collection_archive---------8-----------------------#2021-05-22">https://towardsdatascience.com/using-apache-airflow-dockeroperator-with-docker-compose-57d0217c8219?source=collection_archive---------8-----------------------#2021-05-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/61a8a32315b83039ba474c0214daebb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RxEzJ0jrAhN5hImd4wLDuQ.png"/></div></div></figure><p id="ff32" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">围绕<code class="fe kw kx ky kz b"><a class="ae la" href="https://airflow.apache.org/docs/apache-airflow-providers-docker/stable/_api/airflow/providers/docker/operators/docker/index.html" rel="noopener ugc nofollow" target="_blank">DockerOperator</a></code>的互联网上的大多数教程都很棒，但是它们有一个缺失的环节，我今天想在这里介绍一下，它们都没有假设你正在用Docker Compose 运行<a class="ae la" href="https://airflow.apache.org/docs/apache-airflow/stable/start/docker.html" rel="noopener ugc nofollow" target="_blank"> Apache Airflow。</a></p><p id="b82a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里的所有代码和进一步的说明都在repo<a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose" rel="noopener ugc nofollow" target="_blank">fclesio/air flow-docker-operator-with-compose</a>中。</p><h2 id="16db" class="lb lc iq bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">游戏攻略</h2><p id="d826" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">a)首先，使用webservice创建一个容器，并创建<code class="fe kw kx ky kz b">airflow</code>用户<a class="ae la" href="https://airflow.apache.org/docs/apache-airflow/stable/start/docker.html" rel="noopener ugc nofollow" target="_blank">，如官方文档</a>中所述:</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="0b4a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果应该大致类似于下图:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/6418b41dcaea8193ec5efd4c701c344b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ss5cMFXS5iHD-hUL5MdFOw.png"/></div></div></figure><p id="0aff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">b)完成初始设置后，通过<code class="fe kw kx ky kz b">docker-compose</code>启动网络服务和其他组件:</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/3fbcef697099c42b57fe6bfa9902e350.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TKgBtrMSQmbd5j3RbCYnkA.png"/></div></div></figure><p id="b53b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当您运行下面的语句时，您可以使用<code class="fe kw kx ky kz b">docker container ps</code>来检查docker容器。结果应该大致如下所示:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mh"><img src="../Images/dedd12efbf799cb67c990c22de87434f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7wjjzi-8hT-6ynaniPsEWg.png"/></div></div></figure><p id="1c20" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">c)所有容器都已启动并运行，让我们使用<code class="fe kw kx ky kz b">airflow</code>作为登录和密码进入气流UI:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/11dfe650bfc4431283197f1d7dae27e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PTm64cWm4RQ24rOPUgcXSA.png"/></div></div></figure><p id="9248" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">d)在Airflow UI中，您会发现一个与Docker操作符相关的DAG:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/487d0af3947f24e63df4f0d4d7cf5804.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M08cUNnowsajrL-3UNcZgg.png"/></div></div></figure><p id="4213" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">e)取消暂停DAG:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mk"><img src="../Images/694dde542d49e4eff561dcc87222d631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vXwfqd96fNnusQkOHncJ1Q.png"/></div></div></figure><p id="8fb3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">f)单击DAG并进入图形模式:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/61a8a32315b83039ba474c0214daebb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RxEzJ0jrAhN5hImd4wLDuQ.png"/></div></div></figure><p id="f635" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您将看到正在执行的两个任务。这是下面的DAG代码:</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="d96f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如我们所见，我们正在执行一条<code class="fe kw kx ky kz b">sleep</code>语句和另一条带有<code class="fe kw kx ky kz b">echo</code>语句的语句。[N1]</p><p id="ba56" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在执行过程中，这将是<code class="fe kw kx ky kz b">docker container ps</code>语句的结果:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/1ca5626bc084434f046be0e78984b16d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w0rUWImwWpuL3QdwQ_FXtg.png"/></div></div></figure><p id="9c25" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这幅图中，我们可以看到每个任务都有自己的容器。我使用任务中的<code class="fe kw kx ky kz b">container_name</code>属性来命名这些任务。我强烈建议你<strong class="ka ir">总是</strong>在每个任务的容器中输入名字，因为如果你有一些容器在做一些意想不到的事情(<em class="mm">例如</em>无限循环，花费很长时间等等)，调试一些未命名的容器将会非常困难。</p><p id="ce61" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">g)我在DAG中做了一个小的改动，我加入了两个<code class="fe kw kx ky kz b">echo</code>语句来显示这些信息将如何返回到气流日志中。只需将以下代码复制并粘贴到您的DAG中:</p><figure class="lz ma mb mc gt jr"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="a9fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将向负责该任务的每个容器发送两条<code class="fe kw kx ky kz b">echo</code>语句。一个带有<code class="fe kw kx ky kz b">hello</code>，另一个带有<code class="fe kw kx ky kz b">world</code>:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mn"><img src="../Images/cea3bae3ff904c0362bff91cb7006528.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MiTuvxMBvyG0-kuxDGbQ1Q.png"/></div></div></figure><p id="0a1c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">h)刷新并触发DAG:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/224ab3d0757b75bb666dd413dee0adb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*kukwLqNCR5uM5PPOeoPWnw.png"/></div></figure><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/2b75d18a1bfd64c4f0197ba94b8a43fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qwb-31wZ0ZeYLL7HPFu2wA.png"/></div></div></figure><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/8301d58a557c84bccee40129d3535813.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ccex8A_TZ8LyB_mfGdOlwQ.png"/></div></div></figure><p id="ae0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">I)使用图形视图检查DAG中的执行情况:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/3e3de2b4bc61fba583419b2c1f905d20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FbqzHYaGHHb5Z0kOFisHlA.png"/></div></div></figure><p id="a0b7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的机器上执行相当快，但是我们可以通过查看日志来检查每个任务的结果。</p><p id="b750" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们点击<code class="fe kw kx ky kz b">docker_command_hello</code>任务并选择<code class="fe kw kx ky kz b">logs</code>选项，我们将看到<code class="fe kw kx ky kz b">command</code>的输出</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/a8fc649dee8498f333e71a5bf19393e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t2Z450y5IAHW3W6Zg5fgIQ.png"/></div></div></figure><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/ef57eb2aa38a55beef739ce8b03f40c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Fz9MR8ccmnztRK2MRs8sw.png"/></div></div></figure><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/4783cd3e205275adb578ae3ead78e16b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Av5VxHceWOJUAfgHUNcJJw.png"/></div></div></figure><p id="0f60" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们在<code class="fe kw kx ky kz b">docker_command_world</code>任务中也会得到相同的结果:</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/3d45291184fc64817a7365d2da33b2e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qpd4VZCSz0oEf2xYODEVgQ.png"/></div></div></figure><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/56d0d460185720d3527281fc4d689284.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_gbaj85N6ykcqHYAaXu3_Q.png"/></div></div></figure><p id="2918" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">j)在实验结束时，运行<code class="fe kw kx ky kz b">docker-compose down</code>并停止所有容器。</p><h1 id="8865" class="mx lc iq bd ld my mz na lg nb nc nd lj ne nf ng lm nh ni nj lp nk nl nm ls nn bi translated">一些实际的用法</h1><ul class=""><li id="7d95" class="no np iq ka b kb lu kf lv kj nq kn nr kr ns kv nt nu nv nw bi translated">独立于语言的任务编排(例如，我目前正在一个完全用Ruby编写的数据管道中工作)；</li><li id="2272" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated">提交第三方平台的作业(<em class="mm">例如</em> AWS Sage Maker、Spark jobs、Databricks、Azure等)；</li><li id="e953" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://docs.getdbt.com/reference/node-selection/syntax" rel="noopener ugc nofollow" target="_blank">在隔离环境中运行dbt模型</a>；</li><li id="4211" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated">ETL/ELT任务的容器化；</li><li id="1850" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://github.com/sodadata/soda-sql" rel="noopener ugc nofollow" target="_blank">用soda.sql进行一些ETL/ELT测试</a>；</li><li id="40d5" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated">包括一个额外的步骤<a class="ae la" href="https://greatexpectations.io/" rel="noopener ugc nofollow" target="_blank">数据剖析、验证和测试，并对其寄予厚望</a>，没有环境问题。</li></ul><h1 id="57d8" class="mx lc iq bd ld my mz na lg nb nc nd lj ne nf ng lm nh ni nj lp nk nl nm ls nn bi translated">使用的小技巧</h1><ul class=""><li id="d83a" class="no np iq ka b kb lu kf lv kj nq kn nr kr ns kv nt nu nv nw bi translated"><a class="ae la" href="https://marclamberti.com/blog/how-to-use-dockeroperator-apache-airflow/" rel="noopener ugc nofollow" target="_blank">正如Marc Lamberti所描述的</a>如果您的docker映像不是在相同的本地环境中构建的(例如在worker中)，这意味着它需要被下载，这将增加SLA</li><li id="fb55" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated">docker容器用户(<a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/main/dags/docker_job/Dockerfile" rel="noopener ugc nofollow" target="_blank">在这个例子中是用户</a> <code class="fe kw kx ky kz b"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/main/dags/docker_job/Dockerfile" rel="noopener ugc nofollow" target="_blank">airflow</a></code> ) <strong class="ka ir">需要在docker守护进程</strong>中有权限(一个简单的<code class="fe kw kx ky kz b">chmod</code>给气流用户权限就可以解决[N2】)；</li><li id="c8a7" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/main/dags/docker_job/Dockerfile" rel="noopener ugc nofollow" target="_blank">一个单独的</a> <code class="fe kw kx ky kz b"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/main/dags/docker_job/Dockerfile" rel="noopener ugc nofollow" target="_blank">dockerfile</a></code> <a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/main/dags/docker_job/Dockerfile" rel="noopener ugc nofollow" target="_blank">可以被转换成一个图像</a>，供每个DAG使用。有一个"<em class="mm"> god docker image </em>"包含所有的依赖项和包，可以运行ELT管道中的所有任务，这很有吸引力。请不要这样做。图像会变得不必要的臃肿，构建会花费很长时间(这将反映在SLA中)；</li><li id="6d91" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://github.com/apache/airflow/issues/13487" rel="noopener ugc nofollow" target="_blank">由于DockerOperator实现中的一个问题</a>，选项<code class="fe kw kx ky kz b"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/docker-compose.yaml#L54" rel="noopener ugc nofollow" target="_blank">AIRFLOW__CORE__ENABLE__XCOM_PICKLING</a></code> <a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/docker-compose.yaml#L54" rel="noopener ugc nofollow" target="_blank">应该设置为</a><code class="fe kw kx ky kz b"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/docker-compose.yaml#L54" rel="noopener ugc nofollow" target="_blank">true</a></code>；</li><li id="848b" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/docker-compose.yaml#L59" rel="noopener ugc nofollow" target="_blank">我们需要将运行docker守护进程</a>的主机的URL链接作为一个卷传递给<a class="ae la" href="https://stackoverflow.com/q/51342810/7024760" rel="noopener ugc nofollow" target="_blank">以允许web服务器容器启动Docker映像</a>；</li><li id="b5bd" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/dags/docker_job/docker-job.py#L36" rel="noopener ugc nofollow" target="_blank">不要忘记在</a> <code class="fe kw kx ky kz b"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/dags/docker_job/docker-job.py#L36" rel="noopener ugc nofollow" target="_blank">DockerOperator</a></code> <a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/dags/docker_job/docker-job.py#L36" rel="noopener ugc nofollow" target="_blank">中建立</a> <code class="fe kw kx ky kz b"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/dags/docker_job/docker-job.py#L36" rel="noopener ugc nofollow" target="_blank">container_name</a></code> <a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/dags/docker_job/docker-job.py#L36" rel="noopener ugc nofollow" target="_blank">属性。</a>这一点非常重要，因为如果您忘记建立不同的名称，您可能会遇到容器名称冲突，DAG将会失败(长话短说:出于某种原因，我发现Airflow正在尝试重新连接一些上游启动的容器；而这引起了一些冲突)；</li><li id="959d" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/dags/docker_job/docker-job.py#L35" rel="noopener ugc nofollow" target="_blank">默认情况下，</a> <code class="fe kw kx ky kz b"><a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/dags/docker_job/docker-job.py#L35" rel="noopener ugc nofollow" target="_blank">image</a></code> <a class="ae la" href="https://github.com/fclesio/airflow-docker-operator-with-compose/blob/11e67d9248d0639c9786313643190028b27659f0/dags/docker_job/docker-job.py#L35" rel="noopener ugc nofollow" target="_blank">属性</a>将总是拍摄最新的图像。根据经验，我<strong class="ka ir">强烈</strong>建议使用最近的<code class="fe kw kx ky kz b">Dockerfile</code>构建所有图像。如果您希望100%确保作业将始终使用(事实)最新的映像，请考虑为您的映像包含一个以前的构建任务。类似<code class="fe kw kx ky kz b">docker build -f path/to/Dockerfile -t yourname/image_name .</code>的东西。</li><li id="b45b" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated">据我查看Docker实现的<a class="ae la" href="https://github.com/apache/airflow/blob/b66b54c83cb2efa274ba8040ce22ae719defbe75/airflow/providers/docker/operators/docker.py#L329" rel="noopener ugc nofollow" target="_blank">源代码，Airflow在Docker套接字中使用了一种绑定安装来启动容器。我不是100%确定，但这意味着气流没有做<em class="mm">对接</em>T6】可能会导致其他一些过多的问题</a>。</li></ul><h1 id="e17b" class="mx lc iq bd ld my mz na lg nb nc nd lj ne nf ng lm nh ni nj lp nk nl nm ls nn bi translated">结束语</h1><p id="57d6" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我个人认为Airflow + Docker是一个很好的组合，可以为ELT/ETL任务提供灵活、可扩展和无麻烦的环境。不幸的是，在互联网上，大多数使用Docker Compose的Airflow实现都没有考虑到使用DockerOperator作为灵活的任务编排环境的可行替代方案。</p><p id="40a2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就ELT/ETL架构而言，这种使用Docker Compose + DockerOperator的气流组合认为是一个很好的替代方案，与以下相比:(I)由于我们不需要处理工作人员供应，(ii)由于其固有的复杂性，(iii)使用<a class="ae la" href="https://docs.docker.com/engine/swarm/" rel="noopener ugc nofollow" target="_blank"> Docker Swarm </a>管理这些任务，但其在供应和故障恢复能力方面存在局限性。</p><h1 id="10b1" class="mx lc iq bd ld my mz na lg nb nc nd lj ne nf ng lm nh ni nj lp nk nl nm ls nn bi translated">参考</h1><p id="b94b" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">有用的链接，我在这个过程中使用的重要性排序。</p><ul class=""><li id="d9bb" class="no np iq ka b kb kc kf kg kj oc kn od kr oe kv nt nu nv nw bi translated"><a class="ae la" href="https://airflow.apache.org/docs/apache-airflow/stable/start/docker.html" rel="noopener ugc nofollow" target="_blank">对接器中的运行气流</a></li><li id="1db6" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://www.reddit.com/r/dataengineering/comments/kmojyc/how_can_i_used_the_dockeroperator_in_airflow_of_i/" rel="noopener ugc nofollow" target="_blank">我已经在Docker中运行Airflow，如何在Airflow中使用DockerOperator？</a></li><li id="af4e" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/" rel="noopener ugc nofollow" target="_blank">在您的CI或测试环境中使用Docker-in-Docker？三思而后行。</a></li><li id="3450" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://marclamberti.com/blog/how-to-use-dockeroperator-apache-airflow/" rel="noopener ugc nofollow" target="_blank">如何在Apache Airflow中使用docker operator</a></li><li id="0806" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" rel="noopener" target="_blank" href="/how-to-use-airflow-without-headaches-4e6e37e6c2bc">如何使用气流而不头疼</a></li><li id="cd34" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://gist.github.com/fclesio/436aedee06b91aa8ac863b671919372e" rel="noopener ugc nofollow" target="_blank">码头工人灭霸(小心使用)</a></li><li id="f167" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://github.com/apache/airflow/issues/13487" rel="noopener ugc nofollow" target="_blank"> DockerOperator无法将XCom值序列化到JSON中</a></li><li id="d2b8" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated">从docker内部运行docker可以吗？</li><li id="6519" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://serverfault.com/questions/772227/chmod-not-working-correctly-in-docker" rel="noopener ugc nofollow" target="_blank">停靠栏中的chmod无法正常工作</a></li><li id="8ad5" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://stackoverflow.com/questions/61186983/airflow-dockeroperator-connect-sock-connectself-unix-socket-filenotfounderror" rel="noopener ugc nofollow" target="_blank">air flow docker operator:connect sock . connect(self . UNIX _ socket)file not found error:[Errno 2]没有这样的文件或目录</a></li><li id="9f59" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://stackoverflow.com/questions/36185035/how-to-mount-docker-socket-as-volume-in-docker-container-with-correct-group" rel="noopener ugc nofollow" target="_blank">如何使用正确的组将docker插座作为卷安装到docker容器中</a></li><li id="7e47" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://stackoverflow.com/questions/56782039/permission-issue-on-running-docker-command-in-python-subprocess-through-apache-a/60092639#60092639" rel="noopener ugc nofollow" target="_blank">关于通过Apache Airflow在Python子进程中运行docker命令的权限问题</a></li><li id="787b" class="no np iq ka b kb nx kf ny kj nz kn oa kr ob kv nt nu nv nw bi translated"><a class="ae la" href="https://devopscube.com/run-docker-in-docker/" rel="noopener ugc nofollow" target="_blank">如何在Docker容器中运行Docker</a></li></ul><h2 id="abe8" class="lb lc iq bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">笔记</h2><p id="9f10" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">[N1] —我在任务名称和命令语句中犯了一点小错误。</p><p id="cac0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">【N2】—<a class="ae la" href="https://www.reddit.com/r/dataengineering/comments/kmojyc/how_can_i_used_the_dockeroperator_in_airflow_of_i/go44nip/" rel="noopener ugc nofollow" target="_blank">在Reddit </a>的这个帖子中，一个用户通过<code class="fe kw kx ky kz b">chmod 777 /var/run/docker.sock</code>为主机Docker守护进程中的权限做了一个激进的解决方案。我个人不推荐。</p></div></div>    
</body>
</html>