<html>
<head>
<title>Building Custom Column Transformers in a Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在管道中构建自定义列转换器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-custom-column-transformers-in-a-pipeline-9147a88d6b4?source=collection_archive---------23-----------------------#2021-08-21">https://towardsdatascience.com/building-custom-column-transformers-in-a-pipeline-9147a88d6b4?source=collection_archive---------23-----------------------#2021-08-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f7ce" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">向现有管道添加自定义转换。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4caad8408c4f3635a17dbfad73f1ee50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8BaoXr94q52Yja73"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@victor_g?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">维克多</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="0ade" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated"><strong class="ak">当标准变换不够时</strong></h1><p id="8ac3" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">标准的scikit-learn库提供了许多不同的功能。然而，许多转换、修改和变更数据的常用函数已经存在，并且很容易与管道兼容。</p><p id="f0bf" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这篇文章将讨论如何为管道构建定制的转换器。<strong class="lt iu">有几个代码块可供复制。</strong>最终的变压器具有您选择的超参数优化方法的优化参数。</p><p id="1fe4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">Scikit-learn并没有完全涵盖数据科学家需要的所有内容，大多数问题都需要根据手头的问题进行定制<strong class="lt iu">。幸运的是，有专门为此定制的变压器。</strong></p><p id="c29e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可能会有一个直接的问题，为什么定制转换需要作为管道的一部分。或者，您可以在通过管道推送数据之前手动转换数据。然而，将转换合并到您的管道中有几个好处。</p><ul class=""><li id="00a1" class="ms mt it lt b lu mn lx mo ma mu me mv mi mw mm mx my mz na bi translated"><strong class="lt iu">管道是可重复和可扩展的。</strong>从原始数据进行转换所执行的操作可以在另一台机器上从原始数据中以平稳的流程轻松重现。因此，您可以将工作负载分散到多台机器上，并分配计算负载。</li><li id="fe37" class="ms mt it lt b lu nb lx nc ma nd me ne mi nf mm mx my mz na bi translated"><strong class="lt iu">管道内的参数是可优化的。</strong>虽然不是所有的转换都需要参数，但其他转换可能需要参数。例如，假设您想要测试某个要素的平方值或立方值在模型中的表现是否更好。然后，指数可以被参数化和优化，以确定最佳配置。</li></ul></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="ccd2" class="kz la it bd lb lc nn le lf lg no li lj jz np ka ll kc nq kd ln kf nr kg lp lq bi translated"><strong class="ak">定制变压器需要什么</strong></h1><p id="dfc0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">创建自定义转换有几个考虑因素。第一，转换器应该被定义为一个类。这种设计创建了易于整合到管道中的框架。</p><p id="6cdf" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">该类继承自<strong class="lt iu"> BaseEstimator和TransformerMixin类。</strong>这些类为自定义转换类提供一些基本功能，并确保与sklearn管道的兼容性。下一步是定义三个基本方法，一个<strong class="lt iu"> __init__() </strong>方法、一个<strong class="lt iu"> fit() </strong>方法和一个<strong class="lt iu"> transform() </strong>方法。需要使用<strong class="lt iu"> __init__() </strong>方法来初始化类，在管道拟合时调用<strong class="lt iu"> fit() </strong>方法，在管道上调用transform或fit时调用<strong class="lt iu"> transform() </strong>方法。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="9034" class="kz la it bd lb lc nn le lf lg no li lj jz np ka ll kc nq kd ln kf nr kg lp lq bi translated"><strong class="ak">问题建构</strong></h1><p id="ac2a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">定制转换器的实验使用乳腺癌数据集。代码和转换很容易根据不同的用例进行调整，以满足您的问题的需要。数据被分成训练集、测试集和用于分类问题的“ROC_AUC”度量。</p><p id="a51e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">转换后，整个管道将进行随机超参数搜索。该搜索允许通过选择超参数搜索来有效地优化变换中的参数。关于不同的超参数搜索的更多细节，请参考我关于这个主题的帖子:</p><div class="ns nt gp gr nu nv"><a rel="noopener follow" target="_blank" href="/hyperparameter-tuning-always-tune-your-models-7db7aeaf47e9"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">超参数调整—始终调整您的模型</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">不要放弃免费的性能提升。</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">towardsdatascience.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj ks nv"/></div></div></a></div><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="a668" class="op la it ol b gy oq or l os ot">import pandas as pd<br/>import numpy as np<br/>from sklearn.model_selection import train_test_split, RandomizedSearchCV<br/>from sklearn.metrics import roc_auc_score<br/>from sklearn.pipeline import make_pipeline<br/>from sklearn.pipeline import Pipeline<br/>from sklearn.datasets import load_breast_cancer<br/>from sklearn.tree import DecisionTreeClassifier<br/>from scipy.stats import randint</span><span id="dc22" class="op la it ol b gy ou or l os ot">TEST_SIZE = 0.1<br/>RANDOM_STATE = 10<br/>data = load_breast_cancer()<br/>df = pd.DataFrame(data.data, columns=data.feature_names)<br/>df['target'] = data.target<br/>X = df.drop(['target'], axis=1)<br/>y = df['target'].astype(float)<br/>X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=TEST_SIZE, random_state=RANDOM_STATE, stratify=y)</span></pre></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="8233" class="kz la it bd lb lc nn le lf lg no li lj jz np ka ll kc nq kd ln kf nr kg lp lq bi translated"><strong class="ak">定义自定义变换</strong></h1><p id="69a4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">下面的代码块中定义的CustomTransformer类进行了一些修改，以提供高度的灵活性。应用了三种不同的变换，幂、对数和根。幂变换要求指定指数的次数。</p><p id="dc6c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">对于这些转换中的每一个，保持原始特征列。</strong>这种构造有潜在的问题，因为转换后的特征和原始特征是相互依赖的。或者，您可以调整代码，用一个转换覆盖原始列，以消除这些依赖性。</p><p id="91a3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要转换的列通过转换器中的“feature_names”参数确定。电力变压器的指数由“电力”参数决定。将您想要优化的参数定义为类的属性是至关重要的。<strong class="lt iu">在超参数搜索和随后的优化过程中，只能修改类别的属性。</strong>关于不同管道参数定义的更多细节，请参考我在完整sklearn管道上的帖子:</p><div class="ns nt gp gr nu nv"><a rel="noopener follow" target="_blank" href="/automated-machine-learning-with-sklearn-pipelines-a2be2a0a6e1"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">使用Sklearn管道的自动机器学习</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">一条管道来统治他们。</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">towardsdatascience.com</p></div></div><div class="oe l"><div class="ov l og oh oi oe oj ks nv"/></div></div></a></div><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="7530" class="op la it ol b gy oq or l os ot">from sklearn.base import BaseEstimator, TransformerMixin</span><span id="1d61" class="op la it ol b gy ou or l os ot">class CustomTransformer(BaseEstimator, TransformerMixin):<br/>    # List of features in 'feature_names' and the 'power' of the exponent transformation<br/>    def __init__(self, feature_names, power):<br/>        self.feature_names = feature_names<br/>        self.power = power</span><span id="0d53" class="op la it ol b gy ou or l os ot">    def fit(self, X, y=None):<br/>        return self</span><span id="a33b" class="op la it ol b gy ou or l os ot">    def transform(self, X, y=None):<br/>        X_copy = X.copy()<br/>        for feat in self.feature_names:<br/>            X_copy[feat + '_power' + str(self.power)] = self.power_transformation(X_copy[feat])<br/>            X_copy[feat + '_log'] = self.log_transformation(X_copy[feat])<br/>            X_copy[feat + '_root'] = self.power_transformation(X_copy[feat])<br/>        return X_copy<br/>  <br/>    def power_transformation(self, x_col):<br/>        return np.power(x_col, self.power)</span><span id="cae0" class="op la it ol b gy ou or l os ot">    def log_transformation(self, x_col):<br/>        return np.log(x_col +0.0001)</span><span id="0490" class="op la it ol b gy ou or l os ot">    def root_transformation(self, x_col):<br/>        return np.root( x_col)</span></pre></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="74b3" class="kz la it bd lb lc nn le lf lg no li lj jz np ka ll kc nq kd ln kf nr kg lp lq bi translated"><strong class="ak">在管道中使用变压器</strong></h1><p id="d2b2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为流水线初始化几个元参数。这些包括折叠数、评分、指标、详细信息和并行化作业。请根据需要随时更新这些内容；然而，它们被初始化为以有限的计算能力运行。流水线是用决策树分类器和决策树的几个超参数分布建立的。</p><p id="6997" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">此外，我还包括了定制转换器的参数。首先是功率参数的随机分布，如前所述。接下来是一组不同特性名称的集合。<strong class="lt iu">该设置仅允许对特征子集进行转换，而不是对所有特征进行转换</strong>。由于使用的优化技术是随机超参数搜索，这三个特性列表将被随机选择并用于优化。</p><pre class="kj kk kl km gt ok ol om on aw oo bi"><span id="294e" class="op la it ol b gy oq or l os ot">N_ITER = 5<br/>K_FOLDS = 5<br/>SCORING_METRIC = 'roc_auc'<br/>VERBOSE = 1<br/>N_JOBS = 1</span><span id="ea64" class="op la it ol b gy ou or l os ot">hyperparameter_dict = {<br/>    'custom_transformer__power': randint(1,4),<br/>    'custom_transformer__feature_names': [<br/>        ['mean texture', 'mean perimeter', 'mean area'],<br/>        ['smoothness error', 'compactness error', 'concavity error'],<br/>        ['worst concave points', 'worst symmetry', 'worst fractal dimension'],<br/>    ],<br/>    'model__max_depth': randint(3,10),<br/>    'model__max_features': ['sqrt'],<br/>    'model__min_samples_split': randint(2,20),<br/>}</span><span id="dde6" class="op la it ol b gy ou or l os ot">pipe = Pipeline(steps=[<br/>    ('custom_transformer', CustomTransformer(feature_names=list(X.columns), power=2)),<br/>    ('model', DecisionTreeClassifier())<br/>])<br/>optimal_model = RandomizedSearchCV(<br/>    pipe, hyperparameter_dict, n_iter = N_ITER, cv=K_FOLDS,<br/>    scoring=SCORING_METRIC, n_jobs = N_JOBS,<br/>    return_train_score=True, verbose = VERBOSE<br/>)<br/>optimal_model.fit(X_train, y_train)<br/>print(<br/>    optimal_model.score(X_test, y_test),<br/>    optimal_model.best_params_<br/>)</span></pre></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="3ff0" class="kz la it bd lb lc nn le lf lg no li lj jz np ka ll kc nq kd ln kf nr kg lp lq bi translated"><strong class="ak">结论</strong></h1><p id="124e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这篇文章讨论了如何创建一个与sklearn管道兼容的自定义转换函数。此外，<strong class="lt iu">这些变压器结合了优化参数</strong>。</p><p id="2134" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最终，标准sklearn包和函数中已经包含了许多功能。然而，肯定不是一切。可以有效地利用自定义转换来为现有管道增加额外的灵活性，并添加自定义功能。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><p id="3945" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果你有兴趣阅读关于新颖的数据科学工具和理解机器学习算法的文章，可以考虑在Medium上关注我。</p><p id="4f22" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果你对我的写作感兴趣，并想直接支持我，请通过以下链接订阅。这个链接确保我会收到你的会员费的一部分。</p><div class="ns nt gp gr nu nv"><a href="https://zjwarnes.medium.com/membership" rel="noopener follow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">通过我的推荐链接加入Medium-Zachary Warnes</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">阅读扎卡里·沃恩斯(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接支持…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">zjwarnes.medium.com</p></div></div><div class="oe l"><div class="ox l og oh oi oe oj ks nv"/></div></div></a></div></div></div>    
</body>
</html>