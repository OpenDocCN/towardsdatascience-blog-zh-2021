<html>
<head>
<title>From SQLite to Pandas — 7 Essential Operations You Need to Know</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从SQLite到Pandas——你需要知道的7个基本操作</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/from-sqlite-to-pandas-7-essential-operations-you-need-to-know-c7a5dd71f232?source=collection_archive---------11-----------------------#2021-08-17">https://towardsdatascience.com/from-sqlite-to-pandas-7-essential-operations-you-need-to-know-c7a5dd71f232?source=collection_archive---------11-----------------------#2021-08-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4022" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">相信我——这很简单。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/61397ce5cf1663b816da70374a49484f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DUmypmOBgYxmAEU7"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">兰迪·塔兰皮在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="f465" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大约十年前，当我在做iOS开发时，还没有成熟的移动应用程序数据库解决方案，因此，我必须在应用程序中实现自己的数据库。我选择使用SQLite，这是一种成熟的轻量级关系数据库解决方案。</p><p id="1d4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我将部分职业重心转向数据科学时，我很高兴地得知Python也有管理SQLite的API。重要的是，pandas是数据处理的首选库，它提供了与各种数据库(包括SQLite)通信的相关功能。将它们结合使用，我们可以对本地存储和数据操作做很多事情。在本文中，让我们探索一些基本的操作。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="8a66" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">1.连接到数据库</h2><p id="b9f1" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">为了使用SQLite数据库，我们利用了内置的<code class="fe na nb nc nd b">sqlite3</code>模块，它提供了完整的通用SQLite数据库操作。下面向您展示了我们如何连接到数据库。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="2d84" class="mc md it nd b gy ni nj l nk nl">import sqlite3<br/><br/>con = sqlite3.connect("test.db")</span></pre><p id="97d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过调用<code class="fe na nb nc nd b">connect</code>函数，将会发生两件事。</p><ol class=""><li id="9365" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu nr ns nt nu bi translated">该模块将连接到<code class="fe na nb nc nd b">test.db</code>数据库。如果它不存在，它将在当前目录中创建这样命名的数据库。</li><li id="bf5a" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">这个函数调用将创建一个代表数据库的<code class="fe na nb nc nd b"><a class="ae ky" href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Connection" rel="noopener ugc nofollow" target="_blank">Connect</a></code>对象。从现在开始，我们用这个<code class="fe na nb nc nd b">Connection</code>对象执行任何与数据库相关的操作。</li></ol><p id="bedf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你不想处理一个物理测试数据库，模块可以通过运行下面的代码在内存中创建一个数据库。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="2adc" class="mc md it nd b gy ni nj l nk nl">con_memory = sqlite3.connect(":memory:")</span></pre><p id="e398" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了当前的教程，我们将坚持使用链接到<code class="fe na nb nc nd b">test.db</code>的<code class="fe na nb nc nd b">con</code>对象。</p><h2 id="40a5" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">2.创建新表并插入记录</h2><p id="835e" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">首先，我们把一些数据放入数据库。为简单起见，假设我们想要两个数据字段(姓名和年级),将有四条记录，如下所示。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="2b9b" class="mc md it nd b gy ni nj l nk nl">names = ['John', 'Mike', 'Jane', 'Bella']<br/>grades = [90, 95, 92, 98]</span></pre><p id="4648" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的代码向您展示了我们如何创建一个表并相应地插入这些记录。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">新表和记录</p></figure><ul class=""><li id="ee47" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu oc ns nt nu bi translated">就像其他数据库一样，我们首先需要创建一个游标来执行SQLite语句。<em class="od">有一点需要注意的是，你可以使用非标准的</em> <code class="fe na nb nc nd b"><em class="od">execute</em></code> <em class="od">和</em> <code class="fe na nb nc nd b"><em class="od">executemany</em></code> <em class="od">方法直接与</em> <code class="fe na nb nc nd b"><em class="od">Connect</em></code> <em class="od">对象在一起，让你的代码看起来更整洁一点，尽管在这个遮光罩下，光标仍然是由Python为你创建的。关于是否显式创建光标，这是您的个人选择。</em></li><li id="4c9f" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu oc ns nt nu bi translated">为了在SQLite数据库中创建一个表，我们使用了<code class="fe na nb nc nd b">CREATE TABLE table_name (field0 field0_type, field1 field1_type, …)</code>。你可以在SQLite网站<a class="ae ky" href="https://www.sqlite.org/datatype3.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到支持的数据类型。简而言之，它支持文本、整数、blob(可以用blob保存二进制数据)和实数。值得注意的是，SQLite没有boolean类型，您可以考虑使用整数0和1来表示布尔值。</li><li id="acea" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu oc ns nt nu bi translated">要插入一条记录，只需调用<code class="fe na nb nc nd b">cur.execute(“INSERT into transcript values (‘John’, 90)”)</code>。但是，要用一个函数调用插入多条记录，您应该使用<code class="fe na nb nc nd b">executemany</code>方法，在该方法中，您将SQL语句模板和一个<code class="fe na nb nc nd b">iterator</code>一起传递，后者的项将被顺序添加到模板中。</li><li id="e13c" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu oc ns nt nu bi translated">为了提交所有这些事务来更新数据库，我们在<code class="fe na nb nc nd b">con</code>对象上调用<code class="fe na nb nc nd b">commit</code>方法。</li></ul><h2 id="098a" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">3.查询记录</h2><p id="9ba5" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">要查询记录，您可以应用类似的方法——使用<code class="fe na nb nc nd b">execute</code>方法提交所需的SQL语句。下面的代码向您展示了我们如何查询按成绩排序的记录。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="0193" class="mc md it nd b gy ni nj l nk nl">&gt;&gt;&gt; cur.execute("select * from transcript order by grade desc")<br/>&lt;sqlite3.Cursor object at 0x1103b5ea0&gt;</span></pre><p id="44eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能会注意到，调用<code class="fe na nb nc nd b">execute</code>并没有直接返回我们预期的结果——所有记录。相反，这个调用返回同一个<code class="fe na nb nc nd b">cursor</code>对象。运行SELECT语句后，可以将游标视为迭代器。因此，我们可以将它包含在一个列表构造函数中，以显示所有记录。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="f4bf" class="mc md it nd b gy ni nj l nk nl">&gt;&gt;&gt; list(cur)<br/>[('Bella', 98), ('Mike', 95), ('Jane', 92), ('John', 90)]</span></pre><p id="cc39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，cursor对象有内置的方法<code class="fe na nb nc nd b">fetchall</code>来显示记录，或者<code class="fe na nb nc nd b">feathone</code>来检索一个匹配的记录。顺便提一下，为了避免返回值调用<code class="fe na nb nc nd b">execute</code>，我们使用了下划线。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="0c09" class="mc md it nd b gy ni nj l nk nl">&gt;&gt;&gt; _ = cur.execute("select * from transcript order by grade desc")<br/>&gt;&gt;&gt; cur.fetchall()<br/>[('Bella', 98), ('Mike', 95), ('Jane', 92), ('John', 90)]<br/>&gt;&gt;&gt; _ = cur.execute("select * from transcript order by grade desc")<br/>&gt;&gt;&gt; cur.fetchone()<br/>('Bella', 98)</span></pre><h2 id="4b45" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">4.更新记录</h2><p id="881d" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">为了更新记录，我们使用下面的SQL语句语法:<code class="fe na nb nc nd b">update table_name set field_name=new_value, another_field=new_value where condition</code>。应用这个语法，让我们考虑下面的更新。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="b7ff" class="mc md it nd b gy ni nj l nk nl">&gt;&gt;&gt; cur.execute("update transcript set grade = 100 where name = 'John'")<br/>&lt;sqlite3.Cursor object at 0x1103b5ea0&gt;<br/>&gt;&gt;&gt; list(cur.execute("select * from transcript order by grade desc"))<br/>[('John', 100), ('Bella', 98), ('Mike', 95), ('Jane', 92)]</span></pre><p id="927f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如上所示，我们成功地更新了John的分数，这样我们就有了不同的分数顺序。</p><h2 id="873c" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">5.删除记录</h2><p id="95a8" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">要删除记录，我们使用下面的SQL语句语法:<code class="fe na nb nc nd b">delete from table_name where condition</code>。不要忽略条件，这一点非常重要，否则会删除表中的所有行，在大多数情况下，这不是我们想要的操作。下面是一个例子。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="4a99" class="mc md it nd b gy ni nj l nk nl">&gt;&gt;&gt; _ = cur.execute("delete from transcript where name='John'")<br/>&gt;&gt;&gt; list(cur.execute("select * from transcript order by grade desc"))<br/>[('Bella', 98), ('Mike', 95), ('Jane', 92)]</span></pre><p id="2363" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如上所示，我们已经删除了John的记录。</p><h2 id="35f5" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">6.用熊猫读取SQLite数据</h2><p id="0b6c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">用熊猫操纵SQLite数据库很好玩。Pandas提供了一个函数<code class="fe na nb nc nd b">read_sql</code>，它允许我们直接执行SQL语句，而不用担心底层的基础设施。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="bd50" class="mc md it nd b gy ni nj l nk nl">&gt;&gt;&gt; import pandas as pd<br/>&gt;&gt;&gt; df = pd.read_sql("select * from transcript", con)<br/>&gt;&gt;&gt; df<br/>    name  grade<br/>0   Mike     95<br/>1   Jane     92<br/>2  Bella     98</span></pre><p id="c8bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本质上，这个函数调用创建了一个<code class="fe na nb nc nd b">DataFrame</code>，从这里您可以利用pandas库提供的所有通用方法。</p><p id="4e33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有些人可能见过熊猫功能<code class="fe na nb nc nd b">read_sql_table</code>和<code class="fe na nb nc nd b">read_sql_query</code>。实际上，<code class="fe na nb nc nd b">read_sql</code>函数只是这两个函数的包装器。它将评估输入并调用适当的函数。因此，在我们的日常使用中，我们可以简单地使用<code class="fe na nb nc nd b">read_sql</code>功能，让熊猫为我们做繁重的工作。</p><h2 id="30a3" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">7.将数据帧写入SQLite</h2><p id="a83e" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在使用pandas处理数据之后，是时候将DataFrame写回SQLite数据库进行长期存储了。Pandas为此操作提供了<code class="fe na nb nc nd b">to_sql</code>方法。下面显示了一种可能的用法。</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="f1c1" class="mc md it nd b gy ni nj l nk nl">&gt;&gt;&gt; df['gpa'] = [4.0, 3.8, 3.9]<br/>&gt;&gt;&gt; df.to_sql("transcript", con, if_exists="replace", index=False)<br/>&gt;&gt;&gt; list(cur.execute("select * from transcript order by grade desc"))<br/>[('Bella', 98, 3.9), ('Mike', 95, 4.0), ('Jane', 92, 3.8)]</span></pre><ul class=""><li id="84b4" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu oc ns nt nu bi translated">不像<code class="fe na nb nc nd b">read_sql</code>，它是熊猫库中的一个函数，<code class="fe na nb nc nd b">to_sql</code>是<code class="fe na nb nc nd b">DataFrame</code>类的一个方法，因此它将被<code class="fe na nb nc nd b">DataFrame</code>对象直接调用。</li><li id="d15b" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu oc ns nt nu bi translated">在<code class="fe na nb nc nd b">to_sql</code>方法中，您指定要保存<code class="fe na nb nc nd b">DataFrame</code>的表。</li><li id="62ff" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu oc ns nt nu bi translated"><code class="fe na nb nc nd b">if_exists</code>参数很重要，因为默认情况下，该参数被设置为<code class="fe na nb nc nd b">“fail”</code>，这意味着当表已经存在时，您不能将当前的<code class="fe na nb nc nd b">DataFrame</code>写入该表——将引发一个<code class="fe na nb nc nd b">ValueError</code>。因为在我们的例子中，由于更新的GPA信息，我们想要替换现有的表，我们将<code class="fe na nb nc nd b">if_exisits</code>参数指定为<code class="fe na nb nc nd b">“replace”</code>。</li><li id="877f" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu oc ns nt nu bi translated">将<code class="fe na nb nc nd b">index</code>设置为<code class="fe na nb nc nd b">False</code>会在保存到表格时忽略<code class="fe na nb nc nd b">DataFrame</code>对象的索引。它与您可能更熟悉的<code class="fe na nb nc nd b">to_csv</code>方法具有相同的效果。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="8ace" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">结论</h2><p id="9249" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在本文中，我们回顾了使用Python内置的sqlite3模块来使用SQLite数据库的基本操作。正如您所看到的，使用提供的方法，我们可以非常方便地操作常见的SQL操作，如插入、更新和删除。本质上，如果您已经了解SQL，就没有太多的学习曲线。</p><p id="e637" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还探索了pandas如何与SQLite数据库接口。记住接口的诀窍很简单——read _ SQL是从SQLite数据库中提取任何内容，而to_sql是将数据转储回SQLite数据库。也就是说，假设您的主要数据处理工具是pandas，相对于SQLite数据库，<code class="fe na nb nc nd b">read_sql</code>用于out，<code class="fe na nb nc nd b">to_sql</code>用于in。</p></div></div>    
</body>
</html>