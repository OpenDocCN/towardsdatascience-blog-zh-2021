<html>
<head>
<title>Creating a Telegram Chatbot Quiz with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python创建电报聊天机器人测验</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/creating-a-telegram-chatbot-quiz-with-python-711a43c0c424?source=collection_archive---------6-----------------------#2021-05-10">https://towardsdatascience.com/creating-a-telegram-chatbot-quiz-with-python-711a43c0c424?source=collection_archive---------6-----------------------#2021-05-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f08a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">教程和一个真实的例子:“世界首都”聊天机器人测验</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fd112316f8c5287341625fc269847ccb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vLGy6Cv4-1a15DoX_ATS1A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="a777" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Telegram成为一个伟大的聊天机器人平台的特征之一是能够创建<a class="ae lu" href="https://telegram.org/blog/polls-2-0-vmq" rel="noopener ugc nofollow" target="_blank">投票</a>。这是在2019年推出的，后来通过添加<strong class="la iu">问答模式</strong>进行了改进，最重要的是，通过将其提供给Telegram Chatbot API。</p><p id="b71e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">可以在Telegram应用程序中直接创建投票(无需编码),但这里我们将探索如何使用<a class="ae lu" href="https://python-telegram-bot.readthedocs.io/" rel="noopener ugc nofollow" target="_blank"> Python Telegram Bot </a>库从头开始开发Telegram聊天机器人测验。</p><p id="bf58" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先做一些热身:<strong class="la iu">玩一个真实的例子</strong>，测试你对世界各国首都的了解😎。使用<code class="fe lv lw lx ly b">/start</code>命令(*)开始对话。</p><div class="lz ma gp gr mb mc"><a href="https://t.me/world_capitals_quiz_bot" rel="noopener  ugc nofollow" target="_blank"><div class="md ab fo"><div class="me ab mf cl cj mg"><h2 class="bd iu gy z fp mh fr fs mi fu fw is bi translated">世界首都测验</h2><div class="mj l"><h3 class="bd b gy z fp mh fr fs mi fu fw dk translated">测试你对世界各国首都的了解🌎</h3></div><div class="mk l"><p class="bd b dl z fp mh fr fs mi fu fw dk translated">t.me</p></div></div><div class="ml l"><div class="mm l mn mo mp ml mq ks mc"/></div></div></a></div><p id="58dc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">(*)请耐心等待，它会按需运行，可能需要几秒钟才能醒来并开始聊天😊</p><h1 id="64cf" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">聊天机器人设置</h1><p id="d4a0" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">该设置包括3个步骤:</p><ul class=""><li id="67e0" class="no np it la b lb lc le lf lh nq ll nr lp ns lt nt nu nv nw bi translated">交谈<a class="ae lu" href="https://t.me/botfather" rel="noopener ugc nofollow" target="_blank">机器人父亲</a>创建一个新的聊天机器人并获得授权令牌</li><li id="3ecc" class="no np it la b lb nx le ny lh nz ll oa lp ob lt nt nu nv nw bi translated">配置更新程序对象和方法处理程序</li><li id="84c2" class="no np it la b lb nx le ny lh nz ll oa lp ob lt nt nu nv nw bi translated">启动聊天机器人(在本例中，在<strong class="la iu">轮询模式下</strong>，但是可以使用Webhook代替)</li></ul><pre class="kj kk kl km gt oc ly od oe aw of bi"><span id="85ff" class="og ms it ly b gy oh oi l oj ok">def<strong class="ly iu"> </strong>main():<br/>  updater = Updater('secret token', use_context=True)<br/><br/>  dp = updater.dispatcher<br/><br/>  <em class="ol"># command handlers<br/>  </em>dp.add_handler(<strong class="ly iu">CommandHandler</strong>("help", help_command_handler))<br/>  <em class="ol"># message handler<br/>  </em>dp.add_handler(<strong class="ly iu">MessageHandler</strong>(Filters.text, main_handler))<br/>  <em class="ol"># quiz handler<br/>  </em>dp.add_handler(<strong class="ly iu">PollHandler</strong>(poll_handler, pass_chat_data=True, pass_user_data=True))</span><span id="13da" class="og ms it ly b gy om oi l oj ok">  # start<br/>  updater.start_polling()<br/>  updater.idle()</span></pre><p id="547e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">理解上面定义的<strong class="la iu">处理器</strong>负责处理“帮助”命令、简单的文本消息和投票回答是很重要的。</p><h1 id="8f7a" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">获取聊天Id</h1><p id="9ad8" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">我们将首先创建一个助手方法来获取聊天id:这将在本教程中非常有用，而且如果你开发其他电报聊天机器人。</p><pre class="kj kk kl km gt oc ly od oe aw of bi"><span id="5da6" class="og ms it ly b gy oh oi l oj ok"># extract chat_id based on the incoming object<br/>def get_chat_id(update, context):<br/>  chat_id = -1<br/><br/>  if update.<strong class="ly iu">message</strong> is not None:<br/>    chat_id = update.message.chat.id<br/>  elif update.<strong class="ly iu">callback_query</strong> is not None:<br/>    chat_id = update.callback_query.message.chat.id<br/>  elif update.<strong class="ly iu">poll</strong> is not None:<br/>    chat_id = context.bot_data[update.poll.id]<br/><br/>  return chat_id</span></pre><h1 id="fcb6" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">测验问题</h1><p id="256b" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">使用<code class="fe lv lw lx ly b">send_poll</code>方法可以创建测验答案</p><pre class="kj kk kl km gt oc ly od oe aw of bi"><span id="56dd" class="og ms it ly b gy oh oi l oj ok">c_id = <strong class="ly iu">get_chat_id</strong>(update, context)</span><span id="ba88" class="og ms it ly b gy om oi l oj ok">q = 'What is the capital of Italy?'<br/>answers = ['Rome', 'London', 'Amsterdam']</span><span id="bc2e" class="og ms it ly b gy om oi l oj ok">message = context.bot.<strong class="ly iu">send_poll</strong>(chat_id=c_id, question=q, options=answers, type=Poll.<strong class="ly iu">QUIZ</strong>, correct_option_id=0)</span></pre><p id="bce2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe lv lw lx ly b">type</code>必须是<code class="fe lv lw lx ly b">Poll.QUIZ</code>才能触发<strong class="la iu">测验效果</strong>(选择正确答案后的纸屑)<code class="fe lv lw lx ly b">correct_option_id</code>必须与<code class="fe lv lw lx ly b">answers</code>提供的列表中的正确选项(位置)相匹配。</p><h1 id="4a9e" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">测验问题增强</h1><p id="51ad" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">让我们不要停留在基础知识上，而是让测验变得更有趣一点。</p><p id="77b1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">可以在<strong class="la iu">中增加一个倒计时</strong>来让它更刺激:</p><pre class="kj kk kl km gt oc ly od oe aw of bi"><span id="b351" class="og ms it ly b gy oh oi l oj ok">message = context.bot.send_poll(chat_id=c_id, question=q, options=answers, type=Poll.QUIZ, correct_option_id=0, <strong class="ly iu">open_period</strong>=5)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/ec6201359adec2e65c0816728b512739.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*moeqh3hFWglH114f7R6mUg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">超时5秒的问题—图片由作者提供</p></figure><p id="04d7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">可以包括<strong class="la iu">附加解释</strong>以在用户回答后提供额外信息:注意用户可用的灯图标。</p><pre class="kj kk kl km gt oc ly od oe aw of bi"><span id="557a" class="og ms it ly b gy oh oi l oj ok">message = context.bot.send_poll(chat_id=c_id, question=q, options=answers, type=Poll.QUIZ, correct_option_id=0, <br/><strong class="ly iu">explanation</strong>= <strong class="ly iu">'</strong>Well, honestly that depends on what you eat<strong class="ly iu">'</strong>, <strong class="ly iu">explanation_parse_mode</strong> = telegram.ParseMode.MARKDOWN_V2)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/f0d0a7f48a69ccb6322a66a88651f2cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h8woeoLA9z3bDC3KlpznPw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">带附加“解释”的问题—作者图片</p></figure><h1 id="fba8" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">处理答案</h1><p id="8cf3" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">了解如何处理用户答案很重要。</p><p id="8507" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Telegram BOT API提供了方法和对象来呈现一个漂亮的界面，以及庆祝正确的答案(或标记错误的响应)。然而，<strong class="la iu">开发人员需要跟踪成功的答案</strong>并构建必要的逻辑，例如计算分数、增加后续问题的复杂性等...</p><p id="7ec7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所有测验答案都被发送到<code class="fe lv lw lx ly b">PollHandler</code>,在那里<code class="fe lv lw lx ly b">update</code>对象将携带包含所有必要信息的有效载荷</p><pre class="kj kk kl km gt oc ly od oe aw of bi"><span id="caba" class="og ms it ly b gy oh oi l oj ok"># handling Poll answers<br/>def poll_handler(update, context):</span><span id="537f" class="og ms it ly b gy om oi l oj ok">  # Quiz question<br/>  question = update.poll.question<br/>  # position of correct answer<br/>  correct_answer = update.<strong class="ly iu">poll.correct_option_id</strong></span><span id="8ec9" class="og ms it ly b gy om oi l oj ok">  # first option (text and voted yes|no)<br/>  option_1_text = update.<strong class="ly iu">poll.options[0].text</strong><br/>  option_1_vote = update.<strong class="ly iu">poll.options[0].voter_count</strong></span></pre><p id="332a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有效载荷中的每个<code class="fe lv lw lx ly b">option</code>指示它是否已经被投票(<code class="fe lv lw lx ly b">voter_count</code>等于1)。</p><pre class="kj kk kl km gt oc ly od oe aw of bi"><span id="f30b" class="og ms it ly b gy oh oi l oj ok"># find the answer chosen by the user<br/>def get_answer(update):<br/>  answers = update.poll.options<br/><br/>  ret = ""<br/><br/>  for answer in answers:<br/>    if <strong class="ly iu">answer.voter_count == 1</strong>:<br/>      # found it<br/>      ret = answer.text<br/>      break</span><span id="9f87" class="og ms it ly b gy om oi l oj ok">  return ret</span></pre><p id="21ef" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用<code class="fe lv lw lx ly b">correct_option_id</code>可以确定用户给出的答案是否正确。</p><pre class="kj kk kl km gt oc ly od oe aw of bi"><span id="580b" class="og ms it ly b gy oh oi l oj ok"># determine if user answer is correct<br/>def is_answer_correct(update):<br/>  answers = update.poll.options<br/><br/>  ret = <strong class="ly iu">False</strong><br/>  counter = 0<br/><br/>  for answer in answers:<br/>    if answer.voter_count == 1 and \<br/>                update.poll.correct_option_id == counter:<br/>      ret = <strong class="ly iu">True</strong><br/>      break<br/>    <br/>    counter = counter + 1</span><span id="b138" class="og ms it ly b gy om oi l oj ok">  return ret</span></pre><h1 id="4dd9" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">常规民意测验差异</h1><p id="a54a" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">可以创建一个<strong class="la iu">常规投票</strong>来代替测验:逻辑和代码是相同的，但是有一些不同之处，使得标准投票更适合于调查和问卷:</p><ul class=""><li id="1181" class="no np it la b lb lc le lf lh nq ll nr lp ns lt nt nu nv nw bi translated">没有五彩纸屑庆祝</li><li id="5a22" class="no np it la b lb nx le ny lh nz ll oa lp ob lt nt nu nv nw bi translated">允许多个答案</li><li id="0fe0" class="no np it la b lb nx le ny lh nz ll oa lp ob lt nt nu nv nw bi translated">让用户可以看到结果</li></ul><pre class="kj kk kl km gt oc ly od oe aw of bi"><span id="c8d4" class="og ms it ly b gy oh oi l oj ok">message = context.bot.send_poll(chat_id=cid, question=q, options=answers, type=Poll.<strong class="ly iu">REGULAR</strong>, <strong class="ly iu">allows_multiple_answers</strong>=True,<br/><strong class="ly iu">is_anonymous</strong>=False)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/cb53c800b448636880db0356c20f84e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BGgIuZoALw822LR30EkCHA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">定期投票-按作者分类的图片</p></figure><h1 id="bd8d" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">结论</h1><p id="d966" class="pw-post-body-paragraph ky kz it la b lb nj ju ld le nk jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">我们已经介绍了在Telegram上开发一个测验的所有关键概念，查看<a class="ae lu" href="https://github.com/gcatanese/SampleTelegramQuiz" rel="noopener ugc nofollow" target="_blank"> Github repo </a>从一个基本的测验实现开始，使用本文中提供的代码片段。</p><p id="60eb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您正在开发电报聊天机器人，您可能会发现这很有用:</p><div class="lz ma gp gr mb mc"><a rel="noopener follow" target="_blank" href="/bring-your-telegram-chatbot-to-the-next-level-c771ec7d31e4"><div class="md ab fo"><div class="me ab mf cl cj mg"><h2 class="bd iu gy z fp mh fr fs mi fu fw is bi translated">让你的电报聊天机器人更上一层楼</h2><div class="mj l"><h3 class="bd b gy z fp mh fr fs mi fu fw dk translated">发现可以改变现状的高级功能</h3></div><div class="mk l"><p class="bd b dl z fp mh fr fs mi fu fw dk translated">towardsdatascience.com</p></div></div><div class="ml l"><div class="oq l mn mo mp ml mq ks mc"/></div></div></a></div><p id="3929" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如有问题和建议，请在Twitter上找到我，如果你创建了一个电报问答聊天机器人，请与我分享！</p></div></div>    
</body>
</html>