<html>
<head>
<title>Write Your Own C-extension to Speed Up Python by 100x</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写自己的 C-extension，将 Python 的速度提高 100 倍</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/write-your-own-c-extension-to-speed-up-python-x100-626bb9d166e7?source=collection_archive---------5-----------------------#2021-12-08">https://towardsdatascience.com/write-your-own-c-extension-to-speed-up-python-x100-626bb9d166e7?source=collection_archive---------5-----------------------#2021-12-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ee13" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何编写、编译、打包和导入你自己的超高速 C 模块到 Python 中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4ab0aa53a87ee1f51b06927edd48394a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cntFbQ43ZUgDTeKz"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这就像在你的卡车上安装喷气发动机一样！(图片由<a class="ae ky" href="https://unsplash.com/@santonii" rel="noopener ugc nofollow" target="_blank"> Y S </a>在<a class="ae ky" href="https://unsplash.com/photos/MbJpHqUOt0U" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure><p id="5622" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Python 是一种非常棒的语言，非常容易掌握，开发速度非常快，而且读起来非常清晰。所有这些好处都是有代价的:与其他一些语言相比，Python 相当慢。在继续弄清楚我们正在试图解决的问题之前，我强烈推荐阅读<a class="ae ky" href="https://mikehuls.medium.com/why-is-python-so-slow-and-how-to-speed-it-up-485b5a84154e" rel="noopener"> <strong class="lb iu">这篇文章</strong> </a>。本文的目标是回答这个问题:</p><blockquote class="lv"><p id="432f" class="lw lx it bd ly lz ma mb mc md me lu dk translated">如何在不牺牲速度的情况下，结合 Python 的易开发性？</p></blockquote><p id="4bc0" class="pw-post-body-paragraph kz la it lb b lc mf ju le lf mg jx lh li mh lk ll lm mi lo lp lq mj ls lt lu im bi translated">讽刺的答案是用另一种语言重写项目，但这不是我们在这里的目的。你是一名 Python 程序员，已经有很多用 Python 编写的程序，并且只想加快其中一小部分的速度。另外:如果你习惯于用 Python 来写，转换到另一种语言如 C#或 Java 可能会很困难。</p><p id="b9e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将结合两个世界的精华:我们用一个用 C 编写的小模块来扩展我们的程序。Python 程序员只需导入这个包，不需要知道一行 C 语言，仍然可以享受 100 倍的速度提升。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b1e2c05c4af07f74be0fd0b3ca713b45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Munh3uruhFAplQZu"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将 C 模块导入我们的 Python 程序(图片由(<a class="ae ky" href="https://unsplash.com/@_ks_" rel="noopener ugc nofollow" target="_blank">Kat sazo nova</a>on<a class="ae ky" href="https://unsplash.com/photos/KlOw94HiuGc" rel="noopener ugc nofollow" target="_blank">Unsplash</a>)提供)</p></figure><h2 id="631a" class="mk ml it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated">用 C 写？听起来很难</h2><p id="4ec8" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">”<em class="ni">用 C 写的！？</em>“我听到你问了。</p><p id="45ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">"<em class="ni">你刚刚谈到了向 Java 的粗略过渡，现在我们要转向 C 了？！</em>”。的确，用 C 写代码可能有点挑战性，但是你会发现 100 倍的速度提升绝对是值得的！</p><p id="3d60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们只需用 C 语言重写一小部分代码(在我们的例子中，只是一个函数)。</p><h2 id="d820" class="mk ml it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated">这和用另一种语言重新写项目不一样吗？</h2><p id="e483" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">本文描述的解决方案的美妙之处在于，您只需重写代码中较慢的部分。假设我们用 Python 编写了一个 API 来接收和分析音频文件。用 C 重写分析音频文件的函数是有意义的，因为这是项目的瓶颈。我们会浪费很多时间来重写我们的 API。</p><h2 id="73c7" class="mk ml it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated">这个不能做的简单一点吗？</h2><p id="3883" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">是的，有更简单的方法来创建 C 扩展，这将大大加快我们的程序。在<a class="ae ky" href="https://mikehuls.medium.com/getting-started-with-cython-how-to-perform-1-7-billion-calculations-per-second-in-python-b83374cfcf77" rel="noopener"> <strong class="lb iu">这篇文章</strong> </a>中，我们使用 Cython 将一些类似 Python 的代码转换成 C 模块，实现了大致相同的性能提升。</p><p id="cbd9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，在这篇文章中，我们将努力用 C 编写我们自己的模块，因为它让我们对 Python 的内部工作以及它如何集成用 C 编写的模块有了一个非常有趣的了解。</p><h2 id="8f6e" class="mk ml it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated">什么时候创建 C 模块有意义？</h2><p id="74ea" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">我们能够优化的任务类型是 CPU 密集型任务，而不是等待响应之类的 I/O 任务。在“更快的语言”中，等待 API 并不会更快。</p><p id="1963" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们希望优化一小部分执行 CPU 密集型任务的代码。这类任务非常适合在 c 语言中进行优化。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b07b91ace5ef36725b86629563ad0f17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qPq4PiRhxnXaKy-W"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">让我们开始工作，加速这个项目(图片由<a class="ae ky" href="https://unsplash.com/@kpzhnv" rel="noopener ugc nofollow" target="_blank"> Damir Kopezhanov </a>在<a class="ae ky" href="https://unsplash.com/photos/w-bRrLmXODg" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供)</p></figure><h1 id="f6a0" class="nj ml it bd mm nk nl nm mp nn no np ms jz nq ka mv kc nr kd my kf ns kg nb nt bi translated">设置</h1><p id="0e44" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">首先要做的事情是:建立一个虚拟环境。这并不是绝对必要的，但是保持你的依赖关系不混乱是最好的做法。</p><p id="6559" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你在前面读到的，我们需要一个做大量计算的函数。我们将使用一个简单的例子:计算一个范围内的素数。下面是实现这一点的普通 Python 代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="dabf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的代码看起来有点乱，我听说你认为“<em class="ni"> WHILE LOOPS？！旗帜？！</em>”。相信我，他们进去是有原因的。</p><p id="0870" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还要注意，这不是计算质数最有效的方法，但这不是重点:我们只需要一个需要大量计算的函数！</p></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><h2 id="8af6" class="mk ml it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated">您已经在使用 C 编译的功能</h2><p id="2275" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">代替 while 循环和标志，我们可以使用内置函数<code class="fe od oe of og b">range()</code>。这通过了生成、迭代，并检查我们是否完成了更快的 C 模块。让我们用<code class="fe od oe of og b">range()</code>升级那个讨厌的功能:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="ad7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，这段代码不仅可读性更好，而且速度更快。我们可以使用这两个函数来查找 0 到 100.000 之间的素数:</p><pre class="kj kk kl km gt oh og oi oj aw ok bi"><span id="129c" class="mk ml it og b gy ol om l on oo">[Vanilla] examined 100000 numbers; found 9592 primes in 30.38632 sec<br/>[V+range] examined 100000 numbers; found 9592 primes in 20.00026 sec</span></pre><p id="ac56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用一些内置的 C 模块已经稍微提高了执行速度，但是我们才刚刚开始。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/dcb5201293df746a060778c00c59e300.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NSinvdgOLrkAX6J1"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们必须让我们的手有点脏，但结果将是惊人的(图片由<a class="ae ky" href="https://unsplash.com/@adigold1" rel="noopener ugc nofollow" target="_blank"> Adi Goldstein </a>在<a class="ae ky" href="https://unsplash.com/photos/E_8Zk_hfpcE" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供)</p></figure><h1 id="f303" class="nj ml it bd mm nk nl nm mp nn no np ms jz nq ka mv kc nr kd my kf ns kg nb nt bi translated">为 Python 编写 C 模块</h1><p id="2b8e" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">我们要做的第一件事是将寻找素数的函数转换成 C 语言。然后，我们必须让 Python 与 C 语言的函数进行对话。这个问题的解决方案是将 C 函数封装在 Python 模块中。</p><p id="abcf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你对这些已经很熟悉了。想想<code class="fe od oe of og b">time</code>、<code class="fe od oe of og b">os</code>和<code class="fe od oe of og b">sys</code>，例如，我们称我们的模块为<code class="fe od oe of og b">Fastcount</code>。</p><p id="b6d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这一部分的最后，我们将安装我们的模块，以便您可以导入模块并在模块上执行如下方法:</p><pre class="kj kk kl km gt oh og oi oj aw ok bi"><span id="0b1f" class="mk ml it og b gy ol om l on oo">import Fastcount<br/>res = Fastcount.primecounter(0, 100)<br/>print(res) <br/># 25</span></pre><p id="9dfc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将分三步完成:</p><ol class=""><li id="9d40" class="op oq it lb b lc ld lf lg li or lm os lq ot lu ou ov ow ox bi translated">用 C 重写求素数函数</li><li id="b006" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu ou ov ow ox bi translated">将 C 函数打包到 Python 模块中</li><li id="360e" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu ou ov ow ox bi translated">构建并安装模块</li></ol></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><h2 id="2e29" class="mk ml it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated">第一步:C 功能</h2><p id="2547" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">如果你不熟悉 C 语言，这部分可能有点难。它很像 Python，但有更多的限制。看看这个:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="57ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了这里或那里的一些语法，这个函数看起来很像我们在前一章写的那个讨厌的函数。</p></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><h2 id="144b" class="mk ml it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated">2.在模块中包装 C 函数</h2><p id="f2e7" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">好，我们有一个用 C 写的函数和一个 Python 文件。我们如何从 Python 文件中访问 C 函数？我们必须采取一些措施:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/b6250e2a0dad406c211dc4a1bc707059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pnyzW0B0rcZKxfyq-rLeKw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">所有元素如何组合在一起(图片由作者提供)</p></figure><p id="c1b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经在上面定义了我们的 C 函数，所以让我们将 C 函数包装在一个 Python 对象和(黑色)中，并向外展开:</p><p id="dc0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 2.1 将</strong> <code class="fe od oe of og b"><strong class="lb iu">C-function</strong></code> <strong class="lb iu">包装成</strong> <code class="fe od oe of og b"><strong class="lb iu">Python Object</strong></code> <strong class="lb iu">。<br/> </strong>我们来看一下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="b18f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">记住 Python 中的一切都是对象？事实上 Python 中的一切都是一个<code class="fe od oe of og b">PyObject</code>。即使声明 integer 也会导致一个<code class="fe od oe of og b">PyObject</code>。在幕后，Python 引擎使用这种结构来支持动态类型。</p><p id="d1bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的代码中，我们将 C 函数包装在一个<code class="fe od oe of og b">PyObject</code>中。这个函数使用<code class="fe od oe of og b">PyArg_ParseTuple</code>函数解析 Python 发送给我们的参数。<code class="fe od oe of og b">ii</code>表示我们期望两个整数(更多信息<a class="ae ky" href="https://docs.python.org/3/c-api/arg.html" rel="noopener ugc nofollow" target="_blank">在这里</a>)。</p><p id="7572" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们称之为 C-函数，即发现的素数。最后，在我们把它们转换成一个<code class="fe od oe of og b">PyLong</code>之后，我们返回找到的素数；Python 可以解释为类型的对象<code class="fe od oe of og b">long</code>。</p><p id="9c34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 2.2 将</strong> <code class="fe od oe of og b"><strong class="lb iu">Python Object</strong></code> <strong class="lb iu">增加到一个</strong> <code class="fe od oe of og b"><strong class="lb iu">list of methods</strong></code> <strong class="lb iu">。下面的代码指定了我们在 Python 中调用的函数名:</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="1be1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我们定义了模块拥有的所有方法的列表。</p><p id="c2e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，我们将<code class="fe od oe of og b">primecounter</code>定义为函数名；这就是我们在 Python 中称之为函数的东西。然后我们引用上一步中创建<code class="fe od oe of og b">PyObject</code>的函数。<code class="fe od oe of og b">METH_VARAGS</code>定义了签名:它期望来自 Python 的<code class="fe od oe of og b">self</code>和<code class="fe od oe of og b">*args</code>。最后，我们为 docstring 定义了一个方法描述。</p><p id="4e42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们希望我们的模块有更多的功能，我们可以在那里添加更多的对象，但是为了这个演示的目的，我们将保持简单。这个<code class="fe od oe of og b">PyMethodDef</code>也需要 3 号线；包含所有<code class="fe od oe of og b">NULL</code>的行。</p><p id="93a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 2.3 创建</strong> <code class="fe od oe of og b"><strong class="lb iu">Module Definition</strong></code> <strong class="lb iu">并在上面注册模块名称、描述和</strong> <code class="fe od oe of og b"><strong class="lb iu">list of methods</strong></code> <strong class="lb iu">。<br/> </strong>下面是代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="bbfe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这段代码定义了我们的模块。创建<code class="fe od oe of og b">PyModuleDef</code>需要第一项。在第 4 行和第 5 行，我们指定了模块的名称和描述。</p><p id="e739" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第 6 行中，我们可以指定存储程序状态所需的内存量。当您的程序在多个子解释器中使用时，这是必需的。</p><p id="186a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">负值表示这个模块不支持子解释器。用一个非负值指定要在每个子解释器会话上分配的模块的内存需求。</p><p id="12f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第 7 行的最后一项引用了我们在上一步中指定的方法列表。</p><p id="6037" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 2.4 创建一个</strong> <code class="fe od oe of og b"><strong class="lb iu">Initialization function</strong></code> <strong class="lb iu">，从</strong> <code class="fe od oe of og b"><strong class="lb iu">Module Definition</strong></code> <strong class="lb iu">创建我们的模块。<br/> </strong>最后一块！这是 Python 第一次导入我们的模块时将调用的函数:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="402b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用<code class="fe od oe of og b">PyModule_Create</code>并传递给它一个对前一部分的<code class="fe od oe of og b">PyModuleDef</code>的引用。这将返回一个包装了我们的 C 函数的<code class="fe od oe of og b">PyObject</code>。点击查看全部代码<a class="ae ky" href="https://gist.github.com/mike-huls/e424bfe1f6f8633fa2079c33d06823bb" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><h2 id="f0b0" class="mk ml it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated">3.构建、安装和运行扩展</h2><p id="d4e9" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">这部分类似于创建您自己的公共或私有 Python 包的过程中的步骤。我们必须创建一个<code class="fe od oe of og b">setup.py</code>文件，该文件指向上一步中的 C 代码，然后创建包。我们走吧:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="07a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的代码非常简单明了；最重要的一行是第 11 行，在这里我们指定了在哪里可以找到我们在步骤 2 中编写的 C 文件。</p><p id="006b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步:简单地给<code class="fe od oe of og b">python setup.py install</code>打电话。这将把我们所有的代码打包到一个名为 Fastcount 的模块中。现在在 Python 中，我们可以:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h2 id="71cf" class="mk ml it bd mm mn mo dn mp mq mr dp ms li mt mu mv lm mw mx my lq mz na nb nc bi translated"><strong class="ak">故障排除</strong></h2><p id="90ac" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">Windows:调用<code class="fe od oe of og b">python setup.py install</code>可能会得到一个类似如下的错误:</p><pre class="kj kk kl km gt oh og oi oj aw ok bi"><span id="5d18" class="mk ml it og b gy ol om l on oo">Microsoft Visual C++ 14.0 or greater is required. Get it with "Microsoft C++ Build Tools": <a class="ae ky" href="https://visualstudio.microsoft.com/visual-cpp-build-tools" rel="noopener ugc nofollow" target="_blank">https://visualstudio.microsoft.com/visual-cpp-build-tools</a></span></pre><p id="a3ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以通过安装 C++构建工具来解决这个问题，你可以在这里下载<a class="ae ky" href="https://visualstudio.microsoft.com/visual-cpp-build-tools" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7740253b4d296882d025c4faa45e7e5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*itzI0TFtecqbcjTI"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">让我们比赛算法(图片由<a class="ae ky" href="https://unsplash.com/@jon_chng" rel="noopener ugc nofollow" target="_blank"> Jonathan Chng </a>在<a class="ae ky" href="https://unsplash.com/photos/HgoKvtKpyHA" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供)</p></figure><h1 id="7c7e" class="nj ml it bd mm nk nl nm mp nn no np ms jz nq ka mv kc nr kd my kf ns kg nb nt bi translated">标杆管理</h1><p id="68ac" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">让我们测试一下我们的代码；我们想计算 0 到 500.000 之间的质数。为了做到这一点，我们需要检查大约 13 亿个数字；我可怜的笔记本有很多工作要做。我们将进行基准测试:</p><ul class=""><li id="29e4" class="op oq it lb b lc ld lf lg li or lm os lq ot lu pe ov ow ox bi translated">香草蟒</li><li id="ccff" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated">普通 Python +内置(比如 range)</li><li id="bced" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated">快速计数(我们的 C 模块)</li><li id="71fb" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated">快速计数 MP</li></ul><p id="5490" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在多次执行所有方法并花费最少的时间后，结果就出来了。所有方法都找到了正确的素数(41.538)，这是它们花费的时间(越少越好):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/e9036d10721c8b734a8484dc7cc6c0bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h5lDRaoPOwX6PJGJXKzIzA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">查找一个范围内素数的所有方法的执行时间(越低越好，图片由作者提供)</p></figure><p id="938e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用像<code class="fe od oe of og b">range()</code>这样的内置函数已经节省了大约 35%的完成时间。尽管这是一个相当不错的增加，但我们自己的模块几乎比普通 Python 完成了这个任务。</p><p id="bc28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了获得更快的速度，我们通过多重处理我们的函数将所有计算分散到多个 CPU 上，与普通 Python 相比，这个函数完成了我们的计算。查看<a class="ae ky" href="https://mikehuls.medium.com/multi-tasking-in-python-speed-up-your-program-10x-by-executing-things-simultaneously-4b4fc7ee71e" rel="noopener"> <strong class="lb iu">这篇文章</strong> </a>或<a class="ae ky" href="https://mikehuls.medium.com/advanced-multi-tasking-in-python-applying-and-benchmarking-threadpools-and-processpools-90452e0f7d40" rel="noopener"> <strong class="lb iu">这篇文章</strong> </a>了解更多关于使用线程和进程在 Python 中安全执行多任务的信息。</p></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><h1 id="cddb" class="nj ml it bd mm nk pg nm mp nn ph np ms jz pi ka mv kc pj kd my kf pk kg nb nt bi translated">结论</h1><p id="dcaa" class="pw-post-body-paragraph kz la it lb b lc nd ju le lf ne jx lh li nf lk ll lm ng lo lp lq nh ls lt lu im bi translated">这是一篇很长很复杂的文章，但是我们学到了很多关于 Python 如何在幕后工作的知识。我们已经编写、编译、打包并导入了我们自己的定制 C 模块。尽管这篇文章相当长，但最终，我们将执行速度从 10 分钟以上降低到了近 6 秒:减少了 99%的执行时间！</p><p id="3709" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有建议/澄清，请评论，以便我可以改进这篇文章。同时，看看我的其他关于各种编程相关主题的文章:</p><ul class=""><li id="2076" class="op oq it lb b lc ld lf lg li or lm os lq ot lu pe ov ow ox bi translated"><a class="ae ky" href="https://mikehuls.medium.com/why-is-python-so-slow-and-how-to-speed-it-up-485b5a84154e" rel="noopener">Python 为什么这么慢，如何加速</a></li><li id="cd73" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated">【Cython 入门:如何在 Python 中执行&gt;每秒 17 亿次计算</li><li id="93c4" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated"><a class="ae ky" href="https://mikehuls.medium.com/multi-tasking-in-python-speed-up-your-program-10x-by-executing-things-simultaneously-4b4fc7ee71e" rel="noopener">Python 中的多任务处理:通过同时执行，将程序速度提高 10 倍</a></li><li id="c5ed" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated"><a class="ae ky" href="https://mikehuls.medium.com/advanced-multi-tasking-in-python-applying-and-benchmarking-threadpools-and-processpools-90452e0f7d40" rel="noopener">Python 中的高级多任务处理:应用线程池和进程池并进行基准测试</a></li><li id="5e49" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated"><a class="ae ky" href="https://mikehuls.medium.com/create-a-fast-auto-documented-maintainable-and-easy-to-use-python-api-in-5-lines-of-code-with-4e574c00f70e" rel="noopener">用 FastAPI 用 5 行代码创建一个快速自动归档、可维护且易于使用的 Python API</a></li><li id="67e3" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated"><a class="ae ky" href="https://mikehuls.medium.com/create-and-publish-your-own-python-package-ea45bee41cdc" rel="noopener">创建并发布你自己的 Python 包</a></li><li id="bfc7" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated"><a class="ae ky" href="https://mikehuls.medium.com/create-your-custom-python-package-that-you-can-pip-install-from-your-git-repository-f90465867893" rel="noopener">创建您的定制私有 Python 包，您可以从您的 Git 库 PIP 安装该包</a></li><li id="4ae7" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated"><a class="ae ky" href="https://mikehuls.medium.com/virtual-environments-for-absolute-beginners-what-is-it-and-how-to-create-one-examples-a48da8982d4b" rel="noopener">绝对初学者的虚拟环境——什么是虚拟环境，如何创建虚拟环境(+示例)</a></li><li id="31f2" class="op oq it lb b lc oy lf oz li pa lm pb lq pc lu pe ov ow ox bi translated"><a class="ae ky" href="https://mikehuls.medium.com/dramatically-improve-your-database-inserts-with-a-simple-upgrade-6dfa672f1424" rel="noopener">通过简单的升级大大提高您的数据库插入速度</a></li></ul><p id="cbce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><p id="147a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="ee98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page 的缩写）学生:比如我正在做的事情？<a class="ae ky" href="https://mikehuls.medium.com/membership" rel="noopener">跟我来！</a></p></div></div>    
</body>
</html>