<html>
<head>
<title>Transforming spatial data to tabular data in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">R中空间数据到表格数据的转换</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/transforming-spatial-data-to-tabular-data-in-r-4dab139f311f?source=collection_archive---------21-----------------------#2021-08-02">https://towardsdatascience.com/transforming-spatial-data-to-tabular-data-in-r-4dab139f311f?source=collection_archive---------21-----------------------#2021-08-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="46ea" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于原始格式的空间数据和将其转换成表格数据的技术问题的评论</h2></div><h1 id="c33a" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">转型的需要</h1><p id="05a0" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">您可能会问的第一个问题是，为什么还要转换空间数据。在我的案例中，在一个闪亮的数据可视化应用程序上处理空间数据时，转换的需求是必然的。</p><p id="d09d" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">但是，(地理)空间数据是与映射到地图上的地理位置的数据一致地构造的，由特定的经度和纬度值控制。我们从这些数据中提出的问题要求我们对其进行子集划分/过滤/查询，并最终对其进行处理，以呈现我们希望展示给目标受众的信息。</p><p id="1e84" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">R中有几个函数可用于以其原生格式绘制空间数据，例如plot()、image()和filled.contour()函数。</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="b245" class="mh kg iq md b gy mi mj l mk ml">library(raster)</span><span id="d15d" class="mh kg iq md b gy mm mj l mk ml">rainfall &lt;- raster("2007.daily_rain.nc")<br/>image(rainfall,plot.title = title(main = "Isarithmic(Contour) plot of total rainfall(in mm) in Australia in 2017"))<br/>plot(rainfall, plot.title = title(main = "Isarithmic(Contour) plot of rainfall(in mm) in Australia in 2017"))</span></pre><figure class="ly lz ma mb gt mo gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/5233b530f2b166a63a0b5b5b936c0321.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*S4MJLEL8vn4pwsC2nKbp-w.jpeg"/></div><p class="mr ms gj gh gi mt mu bd b be z dk translated">作者图片</p></figure><p id="e3da" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">但是，在某些情况下，您需要不断地处理空间数据来过滤/子集化坐标或与坐标相关联的信息(例如，x-y坐标位置或z坐标位置的降雨量，通常是时间)，以显示受约束区域或时间的数据。</p><p id="f6eb" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">尽管这可以通过使用某些库来实现，比如<strong class="kz ir"> tidync </strong>(如下所示)</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="4874" class="mh kg iq md b gy mi mj l mk ml">library(tidync)</span><span id="98e7" class="mh kg iq md b gy mm mj l mk ml">nc_2007 &lt;- tidync(“2007.daily_rain.nc”)</span><span id="b110" class="mh kg iq md b gy mm mj l mk ml"># Filtering based on longitude,lattitude or time(available variables)</span><span id="47fd" class="mh kg iq md b gy mm mj l mk ml">nc_2007 %&gt;% hyper_filter(lon = lon &lt; 120)<br/>nc_2007 %&gt;% hyper_filter(time = time &lt;= 5 &amp; time &gt;= 2) # 2nd Jan to 5th Jan 2007 data<br/>nc_2007 %&gt;% hyper_filter(lat = lat &lt;120,time = between(time,1,10))</span></pre><p id="a1fa" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">使用<strong class="kz ir"> dplyr </strong>软件包进行数据操作的简便性是无与伦比的。</p><p id="d9db" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">为此，我们需要将空间数据转换成表格数据(最好是dataframe格式)。</p><p id="9614" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">但首先，让我们看看空间数据及其常见格式的一些基础知识。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="ec06" class="kf kg iq bd kh ki nc kk kl km nd ko kp jw ne jx kr jz nf ka kt kc ng kd kv kw bi translated">空间数据及其常见类型和格式</h1><h2 id="2aa1" class="mh kg iq bd kh nh ni dn kl nj nk dp kp lg nl nm kr lk nn no kt lo np nq kv nr bi translated">什么是空间数据？</h2><p id="97f3" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">项目与地图上的地理位置相关联的数据。比如澳大利亚各个城市的降雨量。</p><h2 id="bda8" class="mh kg iq bd kh nh ni dn kl nj nk dp kp lg nl nm kr lk nn no kt lo np nq kv nr bi translated">常见的空间数据类型</h2><ol class=""><li id="2ad9" class="ns nt iq kz b la lb ld le lg nu lk nv lo nw ls nx ny nz oa bi translated"><strong class="kz ir">基于光栅或像素的数据</strong></li></ol><p id="6f61" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">Arial照片、卫星图像和高程数据通常存储为栅格数据。</p><p id="bf73" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">最常用的格式:</p><ul class=""><li id="5ab2" class="ns nt iq kz b la lt ld lu lg ob lk oc lo od ls oe ny nz oa bi translated">ADRG</li><li id="e73e" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated">二进制文件</li><li id="d9af" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated">Esri网格</li><li id="6444" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated">netCDF网格</li><li id="e996" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated">GeoTIFF</li><li id="24d7" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated">JPEG2000</li></ul><p id="68d2" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">2.<strong class="kz ir">矢量数据</strong></p><p id="5895" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">地理形状存储为矢量数据。</p><ul class=""><li id="59ee" class="ns nt iq kz b la lt ld lu lg ob lk oc lo od ls oe ny nz oa bi translated"><strong class="kz ir">点</strong>用于存储0维特征的位置，如山峰</li><li id="5d33" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated"><strong class="kz ir">线/折线</strong>用于存储道路或河流等一维特征的位置</li><li id="7fff" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated"><strong class="kz ir">多边形</strong>用于存储湖泊或国家等二维特征的位置和形状</li></ul><p id="cc9f" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">最常用的格式:</p><ul class=""><li id="4b92" class="ns nt iq kz b la lt ld lu lg ob lk oc lo od ls oe ny nz oa bi translated">锁眼标记语言(KML)</li><li id="beb3" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated">地理标记语言(GML)</li><li id="195d" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated">Esri shapefile</li><li id="a6b7" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated">杰奥森</li><li id="6227" class="ns nt iq kz b la of ld og lg oh lk oi lo oj ls oe ny nz oa bi translated">挽救（saving的简写）</li></ul><p id="a27f" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">在本文中，我将重点介绍转换最常用的栅格数据格式之一:netCDF grid。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="c94b" class="kf kg iq bd kh ki nc kk kl km nd ko kp jw ne jx kr jz nf ka kt kc ng kd kv kw bi translated">将栅格数据转换为数据帧</h1><p id="4a5d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这里使用的栅格数据是从SILO收集的，SILO是一个从1889年到现在的澳大利亚气候数据的数据库，由昆士兰环境和科学部(DES)托管。我们在这里关注的数据是2017年澳大利亚不同经度和纬度的月降雨量数据。</p><blockquote class="ok ol om"><p id="bd6c" class="kx ky on kz b la lt jr lc ld lu ju lf oo lv li lj op lw lm ln oq lx lq lr ls ij bi translated">这些数据可以通过下面的超链接访问。</p><p id="6bc7" class="kx ky on kz b la lt jr lc ld lu ju lf oo lv li lj op lw lm ln oq lx lq lr ls ij bi translated"><a class="ae or" href="https://www.longpaddock.qld.gov.au/silo/gridded-data/" rel="noopener ugc nofollow" target="_blank">https://www.longpaddock.qld.gov.au/silo/gridded-data/</a></p></blockquote><p id="ab56" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">网格数据主要由三个坐标和每个x-y-z的相应属性组成，以月降雨量表示:</p><p id="3be1" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><strong class="kz ir"> X —经度</strong></p><p id="85d2" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><strong class="kz ir"> Y —纬度</strong></p><p id="388a" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><strong class="kz ir"> Z —一年中的某月</strong></p><h2 id="ac0c" class="mh kg iq bd kh nh ni dn kl nj nk dp kp lg nl nm kr lk nn no kt lo np nq kv nr bi translated">步骤1:从netCDF网格格式创建一个RasterBrick对象</h2><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="f27c" class="mh kg iq md b gy mi mj l mk ml">library(raster)</span><span id="13af" class="mh kg iq md b gy mm mj l mk ml">r_2017 &lt;- brick("2017.monthly_rain.nc")<br/>r_2017</span></pre><figure class="ly lz ma mb gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ot ou di ov bf ow"><div class="gh gi os"><img src="../Images/3674c698dc4413cfc2b8d5dca9331edb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xcAraGhVZO3GVcLmcxvYzA.jpeg"/></div></div><p class="mr ms gj gh gi mt mu bd b be z dk translated">对象的尺寸和属性—按作者分类的图像</p></figure><p id="c5ee" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">使用栅格库的brick()函数部分，将<strong class="kz ir"> netCDF grid </strong>数据转换为<strong class="kz ir"> RasterBrick </strong>对象，允许我们使用plot()、image()函数作为<strong class="kz ir">栅格</strong>库的一部分直接绘制该对象。</p><h2 id="e957" class="mh kg iq bd kh nh ni dn kl nj nk dp kp lg nl nm kr lk nn no kt lo np nq kv nr bi translated">步骤2:将RasterBrick对象转换为SpatialPointsDataFrame对象，最后转换为DataFrame</h2><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="eb70" class="mh kg iq md b gy mi mj l mk ml">r_2017_df &lt;- as.data.frame(rasterToPoints(r_2017,spatial = TRUE))<br/>head(r_2017_df)</span></pre><figure class="ly lz ma mb gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ot ou di ov bf ow"><div class="gh gi ox"><img src="../Images/2faba4b592fd30847e1e3e61a18e3e92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PXczgxQfDJqMUiE_MiZ2XA.jpeg"/></div></div><p class="mr ms gj gh gi mt mu bd b be z dk translated">按作者显示数据框的前几行图像</p></figure><p id="f54c" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated"><em class="on"> rasterToPoints() </em>将<strong class="kz ir"> RasterBrick </strong>对象转换为Points对象，这是一种矢量数据，如果您还记得上一节的话。</p><p id="78e1" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">设置<em class="on">空间</em>参数= TRUE将其转换为<strong class="kz ir"> <em class="on">空间点数据帧</em> </strong>对象。</p><p id="f91a" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">最后，通过使用转换函数<em class="on"> as.data.frame() </em>，我们可以很容易地将其从<strong class="kz ir"><em class="on">spatialpointsdata frame</em></strong>对象转换为<strong class="kz ir"> dataframe </strong>。</p><h2 id="738f" class="mh kg iq bd kh nh ni dn kl nj nk dp kp lg nl nm kr lk nn no kt lo np nq kv nr bi translated">步骤3:重命名列名以提高可读性</h2><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="d6a8" class="mh kg iq md b gy mi mj l mk ml">library(dplyr)</span><span id="82ef" class="mh kg iq md b gy mm mj l mk ml">r_2017_df &lt;- dplyr::rename(r_2017_df,January = 'X2017.01.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,February = 'X2017.02.15')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,March = 'X2017.03.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,April = 'X2017.04.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,May = 'X2017.05.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,June = 'X2017.06.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,July = 'X2017.07.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,August = 'X2017.08.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,September = 'X2017.09.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,October = 'X2017.10.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,November = 'X2017.11.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,December = 'X2017.12.16')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,Longitude = 'x')<br/>r_2017_df &lt;- dplyr::rename(r_2017_df,Latitude = 'y')</span></pre><figure class="ly lz ma mb gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="ot ou di ov bf ow"><div class="gh gi oy"><img src="../Images/6ce10abca107764d41e02ca31fe7721b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sPkAN5JT4Q3DGXBR7OWWpw.jpeg"/></div></div><p class="mr ms gj gh gi mt mu bd b be z dk translated">对数据框架进行最终更新，以重命名列名—图片由作者提供</p></figure><p id="483d" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">最后，我们可以使用<strong class="kz ir"> dplyr </strong>包中的<strong class="kz ir"> <em class="on">重命名</em> </strong>函数，将列名重命名为更有意义的名称。</p><p id="c5e0" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">现在，我们可以轻松地操纵我们的数据框架来绘制美丽的可视化图形，从数据中找到有趣的见解，如下所述。</p><pre class="ly lz ma mb gt mc md me mf aw mg bi"><span id="49a5" class="mh kg iq md b gy mi mj l mk ml">library(ggplot2)</span><span id="ed91" class="mh kg iq md b gy mm mj l mk ml">ggplot(r_2017_df,aes(x=Longitude,y=Latitude,z=.data[["January"]])) + theme_void() + geom_contour_filled_interactive(aes(fill = stat(level),data_id = stat(level),tooltip = paste("Rainfall Range", stat(level))), bins = 9) +  labs(fill = "Rainfall Range(in mm)") + scale_fill_brewer(palette = "Blues")</span></pre><figure class="ly lz ma mb gt mo gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/5cb3e807f08a72abdd608c93df883543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*F_HBhAtJDVh5e60bHfyBKQ.jpeg"/></div><p class="mr ms gj gh gi mt mu bd b be z dk translated">2017年1月澳大利亚降雨量的空间分布-图片由作者提供</p></figure><p id="11a4" class="pw-post-body-paragraph kx ky iq kz b la lt jr lc ld lu ju lf lg lv li lj lk lw lm ln lo lx lq lr ls ij bi translated">总之，通过采用这种将空间数据转换为表格数据的方法，我们可以更好地控制数据，让我们能够更轻松地操作数据，从而帮助我们更自由地从数据中提出问题。</p></div></div>    
</body>
</html>