<html>
<head>
<title>Writing ML code that scales</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写可伸缩的ML代码</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/writing-ml-code-that-scales-51028e9872a0?source=collection_archive---------31-----------------------#2021-05-13">https://towardsdatascience.com/writing-ml-code-that-scales-51028e9872a0?source=collection_archive---------31-----------------------#2021-05-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1034" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从单台机器到多工人设置</h2></div><p id="ddd7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在你最终创建了培训脚本之后，是时候扩大规模了。从一个本地开发环境，无论是IDE还是Colab，到一个大型的计算机集群，这是一个相当大的挑战。以下最佳实践使这种转变更加容易。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="gh gi le"><img src="../Images/0bc1e4dc53ad977dc72f3de3dcb1b708.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*54tXA6MyPvDzPIQN"/></div></div><p class="lq lr gj gh gi ls lt bd b be z dk translated">弗兰克·布施在<a class="ae lu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h2 id="3f80" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">参数分析器</h2><p id="dafe" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">首先是使用参数解析器。Python通过<em class="mt"> argparse </em>模块提供了这样的功能。通常，您希望将批处理大小、时期数和任何目录作为可选参数。手动浏览一个脚本，找到所有使用特定参数的地方，然后全部手动更改，这非常令人沮丧。因此，避免硬编码这样的参数。而不是写作</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="3c9b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">写起来更方便</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="cc58" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">将参数解析器的设置与训练代码分开</h2><p id="ddea" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这是我经常犯的错误。我在训练脚本中创建了参数解析器，并在本地验证了训练。接下来，我部署了这段代码。却看到它在远程机器上失败了:我设置为默认参数的目录指向我的本地磁盘。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><p id="3e14" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">编辑/注释</strong>:虽然我仍然推荐使用参数解析器，但我发现处理超过10个、20个参数是混乱的。在这种情况下，我建议仅将它们用于主要设置。对于更高级的设置，我推荐使用<a class="ae lu" href="https://github.com/google/gin-config" rel="noopener ugc nofollow" target="_blank"> <em class="mt"> Gin </em> python库</a>。</p><p id="2753" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">点击此处了解更多信息:</p><div class="nd ne gp gr nf ng"><a rel="noopener follow" target="_blank" href="/many-hyperparameters-use-gin-fdf6741d282"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd iu gy z fp nl fr fs nm fu fw is bi translated">很多超参数？使用杜松子酒</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">如何处理所有的参数</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">towardsdatascience.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu lo ng"/></div></div></a></div></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h2 id="6a26" class="lv lw it bd lx ly lz dn ma mb mc dp md kr me mf mg kv mh mi mj kz mk ml mm mn bi translated">将参数解析器的设置与训练代码分开</h2><p id="dfdf" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">而不是编写类似于</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="7c0f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">(覆盖您在部署机器上手动更改的参数)，您有一个不受更新影响的单独文件:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="a435" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您的本地项目和已部署的项目都有这个文件。然后在主训练代码中导入这个方法；在本地，路径指向您的本地文件夹，在远程机器上，它们指向相应的目录。这样，在从本地单个GPU机器转到多工作器设置后，您就不必记得更改默认参数了。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><p id="14d7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">注意</strong>:和之前类似，我现在推荐用<a class="ae lu" href="https://github.com/google/gin-config" rel="noopener ugc nofollow" target="_blank"> <em class="mt"> Gin </em> python库</a>处理参数设置。我在这里写了<a class="ae lu" rel="noopener" target="_blank" href="/many-hyperparameters-use-gin-fdf6741d282">一个简短的介绍</a>。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="fc63" class="nv lw it bd lx nw nx ny ma nz oa ob md jz oc ka mg kc od kd mj kf oe kg mm of bi translated">单独的模型创建脚本</h1><p id="d5dc" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">将您的模型创建例程从主要的训练代码中分离出来会产生精益代码。与上一点类似，您使用一个单独的文件来存储模型及其配置，然后在主代码中导入该方法。将这一点与下一点结合起来，实现巨大的可伸缩性。</p><h1 id="6c3d" class="nv lw it bd lx nw og ny ma nz oh ob md jz oi ka mg kc oj kd mj kf ok kg mm of bi translated">使超参数易于编辑</h1><p id="68f2" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">当您硬编码任何参数时，您将很难更新它们。使用512个内核而不是16个？使用更大的致密层？</p><p id="a735" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每次你尝试一个新的配置，你首先要找到相关的代码，然后改变它。这将很快变得令人讨厌。解决方案是将超参数作为脚本参数的一部分，或者用一个单独的文件来存储它们。</p><p id="fed7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一个选项看起来像</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="4ce8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第二个选项类似于</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="a31a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这两种情况下，您都有一个管理默认参数的中心位置。从16核扩展到512核？那只是几秒钟的事了。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><p id="a051" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">注意</strong>:和之前类似，我现在推荐用<a class="ae lu" href="https://github.com/google/gin-config" rel="noopener ugc nofollow" target="_blank"> <em class="mt"> Gin </em> python库</a>处理参数设置。我在这里写了<a class="ae lu" rel="noopener" target="_blank" href="/many-hyperparameters-use-gin-fdf6741d282">一个简短的介绍</a>。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="665c" class="nv lw it bd lx nw nx ny ma nz oa ob md jz oc ka mg kc od kd mj kf oe kg mm of bi translated">使用与设备无关的代码</h1><p id="614e" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这是我在<a class="ae lu" href="https://www.tensorflow.org/api_docs/python/tf/distribute/Strategy" rel="noopener ugc nofollow" target="_blank"> TensorFlow </a>上看到的一个极好的特性:无论是单个GPU还是20个工人，每个人都有16个GPU，编写你的代码，它无论如何都可以工作——无需任何修改。TensorFlow用<em class="mt">策略</em>对象为您处理这个问题。这使您能够在单个GPU和多个工作人员之间无缝切换，当您在编码时只能访问单个设备，但在部署时使用多个设备时，这非常方便。</p><p id="7363" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">而不是写作</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="e60a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您用策略对象包装模型创建和编译例程:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="7215" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将您的代码包装在策略对象的范围内负责分发模型和优化器。您可以使用Hugginface的Transformer库中的以下代码片段来创建这样一个对象:</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="8ef9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我使用相同的技术从本地非GPU设置扩展到多GPU集群和TPU培训。在一个命令中使用四个、八个甚至更多的GPU是很神奇的。</p><h1 id="5777" class="nv lw it bd lx nw og ny ma nz oh ob md jz oi ka mg kc oj kd mj kf ok kg mm of bi translated">让您的框架来处理数据集</h1><p id="8962" class="pw-post-body-paragraph ki kj it kk b kl mo ju kn ko mp jx kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">您可以让ML框架来完成这项任务，而不是手动负责加载数据、解析、缓存等等。许多人为这些项目做出了贡献，使得默认管道非常有效。它们本身支持多处理、缓存、批处理等等。如果您正在使用TensorFlow，有许多方法可以让您的数据为这些操作做好准备；在这篇文章中，我展示了其中的一些<a class="ae lu" rel="noopener" target="_blank" href="/a-practical-guide-to-tfrecords-584536bc786c">。</a></p><p id="6f49" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">尤其是对于复杂的环境，这一点至关重要:如何将数据提供给三个工作人员？这些功能通常已经实现。不要多此一举，但<strong class="kk iu">专注于有趣的部分:</strong></p><p id="1805" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">创建和训练模型。</strong></p></div></div>    
</body>
</html>