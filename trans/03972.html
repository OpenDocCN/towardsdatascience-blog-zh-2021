<html>
<head>
<title>How to build unit tests for Azure Data Factory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为Azure数据工厂构建单元测试</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-build-unit-tests-for-azure-data-factory-3aa11b36c7af?source=collection_archive---------5-----------------------#2021-04-03">https://towardsdatascience.com/how-to-build-unit-tests-for-azure-data-factory-3aa11b36c7af?source=collection_archive---------5-----------------------#2021-04-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="aedd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用Azure DevOps和pytest进行数据工厂单元测试</h2></div><h1 id="48c4" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">0.介绍</h1><p id="8fd9" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><em class="lw"> TLTR:使用azure-pipelines.yml创建Azure devo PS</em><a class="ae lx" href="https://github.com/rebremer/blog-adfv2unittest-git" rel="noopener ugc nofollow" target="_blank"><em class="lw">git projec</em></a><em class="lw">t，创建构建工件，部署ADFv2和SQLDB bacpac，触发pytest做单元测试</em></p><p id="6ee4" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">单元测试是一种软件工程实践，侧重于测试代码的各个部分。在单元测试中，以下<a class="ae lx" href="https://docs.microsoft.com/en-us/dotnet/core/testing/unit-testing-best-practices#characteristics-of-a-good-unit-test" rel="noopener ugc nofollow" target="_blank">最佳实践</a>是适用的:</p><ul class=""><li id="6767" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated"><strong class="lc iu">快</strong>。运行单元测试应该只需要很少的时间。毫秒。</li><li id="0404" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><strong class="lc iu">孤立的</strong>。单元测试是独立的，可以单独运行</li><li id="2a89" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><strong class="lc iu">可重复</strong>。运行单元测试应该总是返回相同的结果</li><li id="ea35" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><strong class="lc iu">自检</strong>。自动检测测试是通过还是失败</li><li id="6b84" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><strong class="lc iu">及时</strong>。没有不成比例的长时间编写单元测试代码</li></ul><p id="3654" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">在Azure Data Factory (ADFv2)中创建单元测试可能是一个挑战，因为总是存在对外部数据源的依赖。此外，ADFv2需要首先部署到Azure，管道只能作为一个整体进行测试。为了(部分地)克服这些挑战并遵循上面的最佳实践，ADFv2单元测试项目被创建如下:</p><ol class=""><li id="e6d0" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mr mj mk ml bi translated">设置Azure DevOps CI/CD项目以使测试<strong class="lc iu">可重复</strong></li><li id="83c5" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mr mj mk ml bi translated">创建包含所有脚本的构建工件，并在发布管道中部署ADFv2 ARM模板、SQLDB bacpac和csv文件。通过使数据源成为发布管道的一部分，外部依赖性受到限制，并且更加孤立</li><li id="9aa0" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mr mj mk ml bi translated">使用SQLDB运行两条ADFv2管道，使用pytest运行ADLSGen2，并将测试结果传播到Azure DevOps中的test选项卡。这样，就有了测试结果的<strong class="lc iu">自检</strong></li></ol><p id="1437" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">通常，ADFv2项目包含多个管道。使用<a class="ae lx" href="https://pypi.org/project/pytest-xdist/" rel="noopener ugc nofollow" target="_blank"> pytest-xdist </a>可以并行运行管道测试的单元测试。通过这种方式，测试可以更快<strong class="lc iu"/>(虽然永远无法实现毫秒级，但总测试时间大约等于最长运行的ADFv2管道)。使用具有pytest、pyodbc和azure-blob-storage的现有代码库，可以<strong class="lc iu">及时</strong>创建新的测试。另见下图。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ms"><img src="../Images/a2fec940c75c1e0d9cdfd58369eaf9a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QlMvEQpzGYdrmWEiHBTkVQ.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">ADfv2单元测试—概述，作者图片</p></figure><p id="69fc" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">在这篇博文的剩余部分，将会更详细地解释这个项目。在下一章中，项目将被部署。</p><h1 id="d9b8" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">1.设置Azure DevOps CI/CD项目</h1><p id="8ed4" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这一章中，项目开始运行，并将创建ADFv2单元测试项目。在这方面，需要做以下工作:</p><ul class=""><li id="c1ca" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated">1.1先决条件</li><li id="d674" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">1.2创建Azure DevOps项目</li><li id="0b57" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">1.3创建服务连接</li><li id="46ac" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">1.4配置和建造/发布YAML管道</li></ul><h2 id="40af" class="ni kj it bd kk nj nk dn ko nl nm dp ks lj nn no ku ln np nq kw lr nr ns ky nt bi translated">1.1先决条件</h2><p id="7fef" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">本教程需要以下资源:</p><ul class=""><li id="fc66" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated"><a class="ae lx" href="https://azure.microsoft.com/en-us/free/" rel="noopener ugc nofollow" target="_blank"> Azure账户</a></li><li id="9ace" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><a class="ae lx" href="https://azure.microsoft.com/en-us/services/devops/" rel="noopener ugc nofollow" target="_blank">蔚蓝DevOps </a></li><li id="5875" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><a class="ae lx" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>(推荐，也用于故障排除)</li></ul><p id="0e60" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">随后，转到Azure门户并创建一个资源组，所有Azure资源都将部署在该资源组中。这也可以使用以下Azure CLI命令来完成:</p><pre class="mt mu mv mw gt nu nv nw nx aw ny bi"><span id="cfeb" class="ni kj it nv b gy nz oa l ob oc">az group create -n &lt;&lt;your resource group&gt;&gt; -l &lt;&lt;your location&gt;&gt;</span></pre><h2 id="ae4b" class="ni kj it bd kk nj nk dn ko nl nm dp ks lj nn no ku ln np nq kw lr nr ns ky nt bi translated">1.2创建Azure DevOps项目</h2><p id="50a1" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Azure DevOps是一个工具，可以持续地构建、测试和部署你的代码到任何平台和云。通过以下教程在Azure DevOps中创建新项目。创建新项目后，单击存储库文件夹并选择导入以下存储库:</p><ul class=""><li id="0ba2" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated"><a class="ae lx" href="https://github.com/rebremer/blog-adfv2unittest-git" rel="noopener ugc nofollow" target="_blank">https://github.com/rebremer/blog-adfv2unittest-git</a></li></ul><p id="0cc9" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">也见下图。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi od"><img src="../Images/e5263e023a1526723a94deeb31f85838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eBo7wUJnstiMa9XU.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">1.2将存储库添加到您的Azure DevOps项目中，图片由作者提供</p></figure><h2 id="27a4" class="ni kj it bd kk nj nk dn ko nl nm dp ks lj nn no ku ln np nq kw lr nr ns ky nt bi translated">1.3创建服务连接</h2><p id="bfc2" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">从Azure DevOps访问资源组中的资源需要服务连接。转到项目设置，服务连接，然后选择Azure资源管理器，另见下图。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oe"><img src="../Images/ed79cfefc045236e03c4dabfae3ec4bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Jbcgz4iH7kVxn5rk.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">1.3.1创建服务连接，由作者创建图像</p></figure><p id="609c" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">选择服务主体身份验证，并将范围限制到您之前创建的资源组，另请参见下图。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi od"><img src="../Images/3759b598040c105426b4e8b5611a517a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*D7CFJ40dXYA2AsDi.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">1.3.2按作者将范围限制到资源组、图像</p></figure><p id="6e69" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">默认情况下，服务连接的服务主体(SPN)拥有资源组的参与者权限。但是，对于此管道，SPN需要资源组的所有者权限(或贡献者旁边的附加用户访问管理员权限)，因为ADFv2 MI需要获得ADLSgen2帐户的RBAC权限。在Azure DevOps中点击你的服务连接上的“管理服务主体”时，可以找到应用id。使用以下Azure CLI脚本向SPN分配所有者权限(也可以在门户中完成):</p><pre class="mt mu mv mw gt nu nv nw nx aw ny bi"><span id="10bc" class="ni kj it nv b gy nz oa l ob oc"># get your subscription id<br/>az account list<br/># create role<br/>az role assignment create --assignee "&lt;&lt;application id&gt;&gt;" --role "Owner" --scope "/subscriptions/&lt;&lt;your subscription Id&gt;&gt; /resourcegroups/&lt;&lt;resource group name&gt;&gt;"</span></pre><p id="21d8" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">最后，验证SPN是否在Azure门户中或使用下面的CLI命令为您的资源组分配了所有者角色。</p><pre class="mt mu mv mw gt nu nv nw nx aw ny bi"><span id="8be0" class="ni kj it nv b gy nz oa l ob oc">az role assignment list --resource-group &lt;&lt;resource group name&gt;&gt;</span></pre><h2 id="c05a" class="ni kj it bd kk nj nk dn ko nl nm dp ks lj nn no ku ln np nq kw lr nr ns ky nt bi translated">1.4配置和建造/发布YAML管道</h2><p id="9a42" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">转到您的Azure DevOps项目，选择管道，然后单击“新建管道”。转到向导，选择您之前创建的Azure Repos Git和git repo。在“配置”选项卡中，选择“现有Azure Pipelines YAML文件”,然后选择可以在git repo中找到的azure-pipelines.yml，另请参见下文。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi of"><img src="../Images/1ae9e3613eee31fd7ddfc179e03a8804.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B_63_6Fqji6hxGw1.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">1.4.1在管道配置向导中，选择现有的Azure管道YAML文件，按作者排序的图像</p></figure><p id="2d81" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">随后，需要用您自己的值替换以下变量:</p><pre class="mt mu mv mw gt nu nv nw nx aw ny bi"><span id="98b3" class="ni kj it nv b gy nz oa l ob oc">variables: <br/>  #<br/>  # 1. Azure DevOps settings, change with your own<br/>  AzureServiceConnectionId: '&lt;&lt;your service connection Id&gt;&gt; '<br/>  SUBSCRIPTIONID: '&lt;&lt;your subscription Id&gt;&gt; '</span></pre><p id="665c" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">一旦变量被替换，管道就被创建并立即运行，见下文。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi od"><img src="../Images/6f9bdef39ba43650de2a88c2a10a585a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Lk0M3vMuT-E4KZH3.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">1.4.2 Azure DevOps部署现代数据管道，图片由作者提供</p></figure><p id="b7f3" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">作业运行后，部署所有资源并执行测试。在下一章中，对结果进行了验证。</p><h1 id="d9e9" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">2.验证测试结果</h1><p id="b57e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在Azure DevOps管道的第一步，部署ADFv2、SQLDB和ADLSgen2。部署完成后，可以使用Azure CLI验证是否部署了所有资源。</p><pre class="mt mu mv mw gt nu nv nw nx aw ny bi"><span id="2831" class="ni kj it nv b gy nz oa l ob oc">az resource list -g &lt;&lt;your resource group&gt;&gt;</span></pre><p id="17d6" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">在Azure DevOps管道的第二步中，测试了两条ADFv2管道。可以在ADFv2 monitor选项卡中验证两个管道是否都已执行。在pytest结果中，可以验证测试是否成功。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi og"><img src="../Images/7dfb08c182b6900edba50da8777c3eb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cx7iIxMah7oBCkN9OKD5hg.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">2.1测试结果，图片由作者提供</p></figure><p id="7307" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">对两条管道执行以下测试:</p><p id="6829" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated"><strong class="lc iu">ADF v2 _ data flows _ adlsgen 2 _ delete _ pii columns:</strong></p><ul class=""><li id="df48" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated">被REST触发后，管道返回HTTP 200</li><li id="9e83" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">检查管道中是否发生超时</li><li id="836c" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">检查OrdersAggregated表是否已创建，并且在注释列中不包含空值</li></ul><p id="4df6" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated"><strong class="lc iu">ADF v2 _ data flows _ sqldb _ remove _ null values:</strong></p><ul class=""><li id="abef" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated">被REST触发后，管道返回HTTP 200</li><li id="9fd3" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">检查管道中是否发生超时</li><li id="4bb9" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">检查是否可以在ADLSgen2的管理文件系统中找到文件adultcensusincomepiiremoved . parquet</li><li id="7e07" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">检查PII的敏感年龄栏是否被从拼花文件中删除</li></ul><p id="2786" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">测试也可以在data factory的monitor选项卡中进行验证，如下所示。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oh"><img src="../Images/931bc466cd63c73b21e08722be3bcfda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zYRoplNU_qZi-uDc7L0-_Q.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">2.2数据工厂运行，按作者排列的图像</p></figure><h1 id="b89e" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">3.结论</h1><p id="58ed" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">单元测试是一种软件工程实践，侧重于测试代码的各个部分。速度、隔离、可重复性、自检和及时性是单元测试的<a class="ae lx" href="https://docs.microsoft.com/en-us/dotnet/core/testing/unit-testing-best-practices#characteristics-of-a-good-unit-test" rel="noopener ugc nofollow" target="_blank">最佳实践</a>。在这篇博客中，描述了一个ADFv2单元测试项目，该项目利用Azure DevOps、SQLDB bacpac和pytest的功能，使测试更加隔离、可重复和自检。也见下图。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oi"><img src="../Images/305453c0f817cea6addce00e6aeada96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UDvDmIN4oV-5aVPe0GmTjQ.png"/></div></div><p class="ne nf gj gh gi ng nh bd b be z dk translated">3.ADfv2单元测试—概述，作者图片</p></figure></div></div>    
</body>
</html>