<html>
<head>
<title>Snakes on a Plane</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">飞机上的蛇</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/snakes-on-a-plane-75b5b95612e0?source=collection_archive---------29-----------------------#2021-11-09">https://towardsdatascience.com/snakes-on-a-plane-75b5b95612e0?source=collection_archive---------29-----------------------#2021-11-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6ed2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><strong class="ak">使用Python包分发系统运送您的Snakemake管道</strong></h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b4594e0a94eb1bf9a9ccc1fd93e97af6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tecUFHsa-KmBPWGiB1Rw9A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片由pch.vector / Freepik提供</p></figure><p id="9a6f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Snakemake是最流行的数据科学工作流管理包之一，但是它缺乏分发您创建的工作流(管道)的功能。在这篇文章中，我将演示如何通过使用Python包分发系统来添加这样的功能。使用这种分配系统有以下好处:</p><ul class=""><li id="4da2" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">在可安装包中将工作流分发给无法访问您的基础架构的其他数据科学家</li><li id="2bb2" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">向管道添加版本控制</li><li id="8ff9" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">减少Snakemake的样板文件(例如必需的参数<code class="fe mf mg mh mi b">—-cores</code>)</li></ul><p id="a22e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">遵循这些指导方针，安装和运行snakemake工作流将像执行以下命令一样简单:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><h1 id="cb75" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">步骤0:先决条件</h1><p id="4cf1" class="pw-post-body-paragraph kv kw iq kx b ky nd jr la lb ne ju ld le nf lg lh li ng lk ll lm nh lo lp lq ij bi translated">要构建一个包，需要(可发现的)Python 3安装。最简单的方法是创建一个包含Python 3的Conda环境。在这篇文章中，我在Unix系统上使用了Python 3.9。要继续学习，需要一些使用Conda和Snakemake的经验。</p><h1 id="6f8e" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">步骤1:创建包装材料</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/25cdaa1b3e38edfadb23716ba1abf8da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L8bqZxqpYrr8ooVEq3d9Eg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自burst.shopify.com</p></figure><p id="e983" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于这个例子，我们将创建一个Python包(称为snakepack ),它使用一个简单的内部Snakemake管道将所有的<code class="fe mf mg mh mi b">.txt</code>文件从输入目录复制到输出目录。</p><p id="dcfa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了模拟真实情况，我们将创建两个单独的文件夹，一个包含包文件，另一个包含用户用来运行包的输入和配置文件。</p><p id="c461" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">包文件夹结构</strong></p><p id="ab45" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这个结构将包含创建实际包的所有文件。根文件夹包含构建包所需的文件。snakepack子文件夹包含实际的模块。snakepack子文件夹中是snakemake文件夹，其中包含管道文件。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="5f34" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这种结构可以例如通过运行</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="f22e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这些文件一直是空的，直到我们以后把它们填满。</p><p id="fee7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">用户文件</strong></p><p id="ab5d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这些文件夹包含将用于演示管道工作的文件。它们可以位于任何位置，但在本例中，它们将位于个人(<code class="fe mf mg mh mi b">~</code>)文件夹中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="dc8b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这种结构可以例如通过运行</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><h1 id="48ed" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">第二步:锻造管子进行包装</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/9b4c8449a204a9c6f774a6bd96d59939.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DmeRh5dR2mU9WM5Wn8x5Tg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自burst.shopify.com</p></figure><p id="7e43" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们从在Snakemake文件夹中创建snakemake管道开始，看看它在没有包包装的情况下是否工作。因为我们希望我们的包的用户能够配置管道，所以我们将使用Snakemake的配置文件来定义输入和输出目录，并将它们传递给Snakemake。</p><p id="1104" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> Snakefile </strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="9d58" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我们的<code class="fe mf mg mh mi b">snakepack_files</code>文件夹中(见上文),我们可以填写配置文件:</p><p id="b7c8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> config.yaml </strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><h2 id="6cae" class="nk mm iq bd mn nl nm dn mr nn no dp mv le np nq mx li nr ns mz lm nt nu nb nv bi translated">测试</h2><p id="9031" class="pw-post-body-paragraph kv kw iq kx b ky nd jr la lb ne ju ld le nf lg lh li ng lk ll lm nh lo lp lq ij bi translated">现在可以通过命令行从<code class="fe mf mg mh mi b">snakemake</code>文件夹运行该管道</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><h1 id="2691" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">第三步:打包</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/0cddcb86d27433c2ab0eb721163e0df6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nkmANqAsqblAav6y5jshcw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自burst.shopify.com</p></figure><p id="6ce9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将围绕现有的snakemake管道创建一个包包装器，它允许我们创建一个包含包并可以分发的<code class="fe mf mg mh mi b">.whl</code>文件。使用上述文件夹/文件结构填写这些文件:</p><p id="1ca8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> copyfiles.py </strong></p><p id="d14d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因为我们希望能够在安装包之后从命令行调用管道，所以这个文件充当一个包装器，它接受命令行参数并使用它们来启动snakemake管道。一个优点是，我们可以控制用户设置哪些参数，以及我们自动固定或确定哪些参数。</p><p id="6538" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这种情况下，我们可以区分以下参数:</p><ul class=""><li id="69dc" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">用户定义的:配置文件的位置</li><li id="22f2" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">修正:snake文件在包中的位置</li><li id="c025" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">自动确定:可用CPU的数量</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">copyfiles.py</p></figure><p id="bef6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> requirements.txt </strong></p><p id="d66f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该文件包含Python包的要求。在这种情况下，snakemake是一个需求。我们还包括了曼巴，因为这优化了蛇制造的使用。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">requirements.txt</p></figure><p id="7fec" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当您稍后安装snakepack包时，这些需求将被自动下载和安装。</p><p id="27d9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> setup.py </strong></p><p id="377f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe mf mg mh mi b">setup.py</code>文件将为python包工具提供如何创建包的指导。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">setup.py</p></figure><p id="ce86" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe mf mg mh mi b">setup</code>命令指示包构建器这是包snakepack的0.0.1版本。<code class="fe mf mg mh mi b">find_packages()</code>调用确保python模块将包含在轮子中。<code class="fe mf mg mh mi b">install_requires</code>定义了我们从<code class="fe mf mg mh mi b">requirements.txt</code>读入的需求。最后，我们将<code class="fe mf mg mh mi b">include_package_data</code>设置为<code class="fe mf mg mh mi b">True</code>，并指向包含在包中的snakemake目录。</p><h2 id="7c85" class="nk mm iq bd mn nl nm dn mr nn no dp mv le np nq mx li nr ns mz lm nt nu nb nv bi translated">测试</h2><p id="f97c" class="pw-post-body-paragraph kv kw iq kx b ky nd jr la lb ne ju ld le nf lg lh li ng lk ll lm nh lo lp lq ij bi translated">一旦创建了上述文件，您就可以测试您的包是否可以在开发模式下安装，并且可以运行该模块。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="1bb1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这将运行管道并复制文件。之后删除复制的文件。</p><h1 id="137b" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">第四步:起跳！</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/9b9afe80bae36a1a02090a7df58a38c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y_3KWQCGlSUQ9mII3IoaxQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自burst.shopify.com</p></figure><p id="5d18" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果第3步成功，您就可以构建实际的包了:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="b712" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这将在名为<code class="fe mf mg mh mi b">dist/</code>的新子文件夹中创建一个wheel ( <code class="fe mf mg mh mi b">.whl</code>)文件。这个轮子可以和别人分享。</p><h2 id="6a62" class="nk mm iq bd mn nl nm dn mr nn no dp mv le np nq mx li nr ns mz lm nt nu nb nv bi translated">测试</h2><p id="4512" class="pw-post-body-paragraph kv kw iq kx b ky nd jr la lb ne ju ld le nf lg lh li ng lk ll lm nh lo lp lq ij bi translated">让我们试试它是否安装并运行:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mj mk l"/></div></figure><h1 id="af92" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">结论</h1><p id="e924" class="pw-post-body-paragraph kv kw iq kx b ky nd jr la lb ne ju ld le nf lg lh li ng lk ll lm nh lo lp lq ij bi translated">这篇文章使用了一个非常简单的snakemake管道来展示它可以通过包含在一个定制的Python包中来进行分发。如果您经常使用Snakemake，并且希望轻松地共享和版本控制您的管道，那么您可以使用更复杂的管道来扩展所提供的框架，并根据您的需要进行定制。</p><h1 id="cf13" class="ml mm iq bd mn mo mp mq mr ms mt mu mv jw mw jx mx jz my ka mz kc na kd nb nc bi translated">来源</h1><ul class=""><li id="7093" class="lr ls iq kx b ky nd lb ne le nx li ny lm nz lq lw lx ly lz bi translated"><a class="ae oa" href="https://snakemake.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank">https://snakemake.readthedocs.io/en/stable/</a></li><li id="99f6" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">https://packaging.python.org/overview/<a class="ae oa" href="https://packaging.python.org/overview/" rel="noopener ugc nofollow" target="_blank"/></li></ul></div></div>    
</body>
</html>