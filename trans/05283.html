<html>
<head>
<title>PIVOT in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery中的透视</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pivot-in-bigquery-4eefde28b3be?source=collection_archive---------2-----------------------#2021-05-10">https://towardsdatascience.com/pivot-in-bigquery-4eefde28b3be?source=collection_archive---------2-----------------------#2021-05-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3aa2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将行转换为列</h2></div><p id="4708" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有时，您可能想要重新格式化表格结果，以便为每个唯一值设置单独的列。这被称为数据透视表——通常，它只是BI工具支持的一个显示功能。但是，在SQL中创建数据透视表有时会很有帮助。下面是如何在Google BigQuery中使用PIVOT操作符来创建数据透视表。</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi lb"><img src="../Images/a41a9677a6ecab41a43a287262310682.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tJLkyRXGg17Vo_ccI4urBg.png"/></div></div><p class="ln lo gj gh gi lp lq bd b be z dk translated">图片由<a class="ae lr" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2034023" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a>的Gerd Altmann 提供</p></figure><h2 id="f35c" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">Pivot是做什么的？</h2><p id="fc63" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">透视将行更改为列。例如，假设我们有一个航班和航班延误表，如下所示:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/9f327110f7feeaf97df2ed3ec9ac3a51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*qQP5CbrM8vESDz_hOcVv1A.png"/></div></figure><p id="21fc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们希望输出获得每个机场-航空公司对的平均出发延迟，其中航空公司代码是列:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi mr"><img src="../Images/a28cf6ed99aea883bdc67707d0958c01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Py-7nPOO1lY8InLhvCPGPw.png"/></div></div></figure><p id="0896" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们会做一个旋转。请注意，如果我们只是想要平均出发延误，并且接受不同行上的平均值，我们可以简单地做:</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="732b" class="ls lt iq mt b gy mx my l mz na">SELECT <br/>  airline,<br/>  departure_airport,<br/>  AVG(departure_delay)<br/>FROM `bigquery-samples.airline_ontime_data.flights`<br/>GROUP BY 1, 2</span></pre><p id="1ded" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并获得:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/f4c2d44dc6c9a01dbe03c377f627b07c.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/1*WFbH3r8RPC8UW6FgniyM_A.png"/></div></figure><p id="22ca" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事实是我们需要它<strong class="kh ir">像2D桌子</strong>一样摆放，需要一个支点。</p><h2 id="f20b" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">枢轴语法</h2><p id="4ac3" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">BigQuery中的<a class="ae lr" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#pivot_operator" rel="noopener ugc nofollow" target="_blank"> Pivot操作符</a>需要您指定三件事:</p><ul class=""><li id="9927" class="nc nd iq kh b ki kj kl km ko ne ks nf kw ng la nh ni nj nk bi translated"><em class="nl">起输入作用的from_item </em>。航班表中的三列(航空公司、出发机场、出发延误)是我们的from_item。</li><li id="822d" class="nc nd iq kh b ki nm kl nn ko no ks np kw nq la nh ni nj nk bi translated"><em class="nl">聚合</em>因为输出表的每个单元格都由多个值组成。这里，这是出发延迟的AVG</li><li id="3182" class="nc nd iq kh b ki nm kl nn ko no ks np kw nq la nh ni nj nk bi translated"><em class="nl"> pivot_column </em>，其值构成输出表中的列的列。不幸的是，这需要是一个常量——您不能在其中放入查询。</li></ul><p id="3398" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们看几个例子。</p><h2 id="e2c9" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">航班表透视</h2><p id="6264" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">我们想要机场和航空公司的起飞延迟。透视查询是:</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="6c2e" class="ls lt iq mt b gy mx my l mz na">SELECT * FROM<br/>(<br/>  -- #1 from_item<br/>  SELECT <br/>    airline,<br/>    departure_airport,<br/>    departure_delay<br/>  FROM `bigquery-samples.airline_ontime_data.flights`<br/>)<br/>PIVOT<br/>(<br/>  -- #2 aggregate<br/>  AVG(departure_delay) AS avgdelay<br/>  -- #3 pivot_column<br/>  FOR airline in ('AA', 'KH', 'DL', '9E')<br/>)</span></pre><p id="3945" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意这三个部分，将出发延误转换成一个由出发机场和航空公司代码组织的表。因为pivot_column需要是一个常量，所以我们必须显式地列出它们。</p><p id="16ab" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">结果:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nr"><img src="../Images/e8ddc94eb0e5714562332591271c7828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WhgT3T-BgrxozxweDWwl4A.png"/></div></div></figure><p id="88e6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用前缀avgdelay的原因是我们将聚合称为avgdelay。</p><h2 id="7cd5" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">堆栈溢出枢纽</h2><p id="533c" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">让我们按年份创建一个带有给定标签的问题数量的枢纽</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="1d90" class="ls lt iq mt b gy mx my l mz na"> SELECT<br/>    tag,<br/>    EXTRACT(YEAR from creation_date) AS year,<br/>    COUNT(*) AS n<br/>  FROM <br/>    `bigquery-public-data.stackoverflow.posts_questions`,<br/>    UNNEST(SPLIT(tags, '|')) AS tag<br/>  WHERE tags IS NOT null<br/>  GROUP BY 1, 2</span></pre><figure class="lc ld le lf gt lg gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/2b79350a9bc06f2bc007a8192da35c27.png" data-original-src="https://miro.medium.com/v2/resize:fit:676/format:webp/1*uovTKx9QP46jgHbiD959JA.png"/></div></figure><p id="1341" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中行是标签，列是年份:</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="d5e0" class="ls lt iq mt b gy mx my l mz na">SELECT * FROM <br/>(<br/>  -- #1 from_item<br/>  SELECT<br/>    tag,<br/>    EXTRACT(YEAR from creation_date) AS year<br/>  FROM <br/>    `bigquery-public-data.stackoverflow.posts_questions`,<br/>    UNNEST(SPLIT(tags, '|')) AS tag<br/>  WHERE tags IS NOT null<br/>)<br/>PIVOT<br/>(<br/>  -- #2 aggregate<br/>  COUNT(*) AS n<br/>  -- #3 pivot_column<br/>  FOR year in (2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020)<br/>)</span></pre><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nt"><img src="../Images/d04e65f88e377f3d4fa2b49f19a518c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ASZhKOpYF2oYPEUw0KCodw.png"/></div></div></figure><h2 id="62ee" class="ls lt iq bd lu lv lw dn lx ly lz dp ma ko mb mc md ks me mf mg kw mh mi mj mk bi translated">动态生成透视列值</h2><p id="10c4" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">如果不能事先列出所有可能的值或透视列，该怎么办？一种解决方案是使用脚本。在这里，我创建了一个名为airlines的变量，它以正确的格式打印出字符串(尝试一下):</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="5086" class="ls lt iq mt b gy mx my l mz na">DECLARE airlines STRING;<br/>SET airlines = (<br/>  SELECT <br/>    CONCAT('("', STRING_AGG(DISTINCT airline, '", "'), '")'),<br/>  FROM `bigquery-samples.airline_ontime_data.flights`<br/>);</span></pre><p id="6508" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我可以使用EXECUTE IMMEDIATE运行实际的查询:</p><pre class="lc ld le lf gt ms mt mu mv aw mw bi"><span id="a229" class="ls lt iq mt b gy mx my l mz na"><strong class="mt ir">EXECUTE IMMEDIATE format</strong>("""<br/>SELECT * FROM<br/>(<br/>  SELECT <br/>    airline,<br/>    departure_airport,<br/>    departure_delay<br/>  FROM `bigquery-samples.airline_ontime_data.flights`<br/>)<br/>PIVOT<br/>(<br/>  AVG(departure_delay) AS avgdelay<br/>  FOR airline in <strong class="mt ir">%s</strong><br/>)<br/>ORDER BY departure_airport ASC<br/>""", <strong class="mt ir">airlines</strong>);</span></pre><p id="4edd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这导致:</p><figure class="lc ld le lf gt lg gh gi paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="gh gi nu"><img src="../Images/da2e1329e3a6eead9611fc7acce4b015.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Qkp7LHN8ndwCquXcLyy0w.png"/></div></div></figure><p id="f3ed" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尽情享受吧！</p></div></div>    
</body>
</html>