<html>
<head>
<title>Back Up your Valuable BigQuery Views and Scheduled Queries</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">备份您有价值的BigQuery视图和计划查询</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/back-up-your-valuable-bigquery-views-and-scheduled-queries-424791b6f2c7?source=collection_archive---------19-----------------------#2021-10-14">https://towardsdatascience.com/back-up-your-valuable-bigquery-views-and-scheduled-queries-424791b6f2c7?source=collection_archive---------19-----------------------#2021-10-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4401" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">你的宝贝SQL也需要一些爱</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5b6937b45082debd36130f8a632a251c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eRBa3I58PrihVqiqunt2JQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">原图<a class="ae kv" href="https://unsplash.com/@karishea" rel="noopener ugc nofollow" target="_blank">卡莉·谢伊</a></p></figure><p id="9197" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">进行数据备份很重要。但是隐藏在视图和预定查询中的宝贵的SQL代码呢？本教程将向您展示如何使用Python将所有SQL代码备份到Git存储库中。</strong></p><p id="f209" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在许多情况下，视图和预定查询包含了所有艰苦工作(和花费的大量时间)的结果。它们基本上包含了很多构建模块。想想数据转换、特征工程、选择甚至模型本身。</p><blockquote class="ls lt lu"><p id="86d7" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="iq">注:</em> </strong> <em class="iq">你喜欢这篇文章吗？阅读</em> <a class="ae kv" href="https://stacktonic.com/article/backup-your-valuable-big-query-views-and-scheduled-queries-using-python" rel="noopener ugc nofollow" target="_blank"> <em class="iq">原文</em> </a> <em class="iq">(以及其他许多动手营销技术相关文章)上</em><a class="ae kv" href="https://stacktonic.com" rel="noopener ugc nofollow" target="_blank"><em class="iq">stacktonic.com</em></a><em class="iq"/>🚀</p></blockquote><p id="13e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，当很多用户积极参与谷歌云平台(GCP)环境的开发时，很难跟踪视图和预定查询的变化。</p><p id="610c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本教程中提供的解决方案将:</p><ul class=""><li id="2ecd" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated"><strong class="ky ir">备份</strong>您的BigQuery <strong class="ky ir">视图</strong>和<strong class="ky ir">调度查询</strong>到本地文件系统上的<code class="fe mi mj mk ml b">.sql</code>文件。</li><li id="c0f6" class="lz ma iq ky b kz mm lc mn lf mo lj mp ln mq lr me mf mg mh bi translated">能够提交对一个<strong class="ky ir"> Git </strong>库的更改。定期运行脚本时，可以跟踪<strong class="ky ir">变更历史</strong>。</li><li id="d1ac" class="lz ma iq ky b kz mm lc mn lf mo lj mp ln mq lr me mf mg mh bi translated">支持<strong class="ky ir">多个</strong> GCP项目。</li></ul><h1 id="f943" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">准备</h1><p id="2d21" class="pw-post-body-paragraph kw kx iq ky b kz nj jr lb lc nk ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">我们将使用服务帐户对您的Google云项目进行身份验证。</p><blockquote class="ls lt lu"><p id="703f" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><em class="iq">通过将此具有正确角色的服务帐户添加到您想要备份的所有GCP项目，您可以对所有项目使用相同的服务帐户。</em></p></blockquote><p id="61da" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你不熟悉设置服务账户，请先阅读谷歌文档。</p><ul class=""><li id="0f5c" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated">创建一个服务帐户，并为该帐户启用<code class="fe mi mj mk ml b">BigQuery User</code>角色。</li><li id="78a8" class="lz ma iq ky b kz mm lc mn lf mo lj mp ln mq lr me mf mg mh bi translated">为服务帐户生成并下载JSON密钥文件。</li><li id="15d4" class="lz ma iq ky b kz mm lc mn lf mo lj mp ln mq lr me mf mg mh bi translated">在您的GCP项目中启用<code class="fe mi mj mk ml b">Data Transfer API</code></li></ul><h1 id="911c" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">脚本如何工作</h1><ul class=""><li id="51d3" class="lz ma iq ky b kz nj lc nk lf no lj np ln nq lr me mf mg mh bi translated">Python脚本将获取脚本中配置的GCP项目中所有视图和计划查询的SQL代码。</li><li id="67ac" class="lz ma iq ky b kz mm lc mn lf mo lj mp ln mq lr me mf mg mh bi translated">文件被下载到您的本地文件系统。</li><li id="17fa" class="lz ma iq ky b kz mm lc mn lf mo lj mp ln mq lr me mf mg mh bi translated">当您启用<code class="fe mi mj mk ml b">REPO_COMMIT</code>设置时，脚本将首先克隆一个(远程)存储库，获取视图和预定查询SQL，并将更改提交给存储库。在克隆远程存储库之前，它将首先删除旧版本的存储库</li></ul><blockquote class="ls lt lu"><p id="78db" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><em class="iq">当使用Git存储库备份SQL和跟踪变更历史时，可以使用SSH密钥进行认证。参见</em> <a class="ae kv" href="https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> GitHub </em> </a> <em class="iq">或</em><a class="ae kv" href="https://support.atlassian.com/bitbucket-cloud/docs/set-up-an-ssh-key/" rel="noopener ugc nofollow" target="_blank"><em class="iq">bit bucket</em></a>的说明</p></blockquote><p id="31bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">文件结构</strong></p><p id="9687" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该脚本将根据以下文件夹/文件结构创建和填充:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/1c954270f790959df694358e52e41061.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tUNtLoefqsZaDVgqYFEfXw.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/1530db392ad15cb260808e587ba98ee2.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/0*c-oWN6EhyXk2Gp3L.PNG"/></div></figure><h1 id="8d50" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">安装和运行代码</h1><p id="f775" class="pw-post-body-paragraph kw kx iq ky b kz nj jr lb lc nk ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated"><strong class="ky ir">安装包</strong></p><p id="9fb3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该脚本需要一些依赖项。使用<code class="fe mi mj mk ml b">pip</code>来安装这些包:</p><pre class="kg kh ki kj gt nt ml nu nv aw nw bi"><span id="bfab" class="nx ms iq ml b gy ny nz l oa ob">pip install google-auth<br/>pip install google-cloud-bigquery<br/>pip install GitPython</span></pre><p id="4513" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后一步是调整脚本中的设置:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/1e876cf1f40bfab278262dd5c1986e41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s8jBmkoNFylShRkGQtmk0g.png"/></div></div></figure><p id="ccec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您已经准备好运行代码了:</p><pre class="kg kh ki kj gt nt ml nu nv aw nw bi"><span id="1150" class="nx ms iq ml b gy ny nz l oa ob">python backup_views_scheduled_queries.py</span></pre><h1 id="281d" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">Python脚本</h1><p id="d4d9" class="pw-post-body-paragraph kw kx iq ky b kz nj jr lb lc nk ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">手动将代码保存到一个文件中，或者直接从我们的GitHub库下载代码<a class="ae kv" href="https://gist.github.com/krisjan-oldekamp/78869851421af2f75325c32302fa2137" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="c0af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">backup _ views _ scheduled _ query . py</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><h1 id="2882" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">一些最后的提示</h1><ul class=""><li id="f6d3" class="lz ma iq ky b kz nj lc nk lf no lj np ln nq lr me mf mg mh bi translated">您可能希望每天安排这个脚本。你可以使用你最喜欢的调度工具，比如Apache Airflow或者good ol' cronjobs。</li><li id="e99c" class="lz ma iq ky b kz mm lc mn lf mo lj mp ln mq lr me mf mg mh bi translated">在windows上，配置SSH密钥可能会给您带来一些麻烦。参见<a class="ae kv" href="https://docs.github.com/en/github/authenticating-to-github/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent" rel="noopener ugc nofollow" target="_blank"> GitHub </a>和<a class="ae kv" href="https://support.atlassian.com/bitbucket-cloud/docs/troubleshoot-ssh-issues/" rel="noopener ugc nofollow" target="_blank"> Bitbucket </a>文档进行故障排除。</li></ul></div></div>    
</body>
</html>