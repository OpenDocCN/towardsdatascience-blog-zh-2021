<html>
<head>
<title>Big Data Visualization Using Datashader in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python中的Datashader实现大数据可视化</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/big-data-visualization-using-datashader-in-python-c3fd00b9b6fc?source=collection_archive---------0-----------------------#2021-10-06">https://towardsdatascience.com/big-data-visualization-using-datashader-in-python-c3fd00b9b6fc?source=collection_archive---------0-----------------------#2021-10-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="a33f" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/making-sense-of-big-data" rel="noopener" target="_blank">理解大数据</a></h2><div class=""/><div class=""><h2 id="9c82" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">【Datashader是如何工作的，为什么速度会如此之快？</h2></div><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/6740d41920793c4fe964d7ef16127fd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sxFIlsh4e5QH9iJ4yHYzhA.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">图片来自<a class="ae lf" href="https://examples.pyviz.org/opensky/opensky.html" rel="noopener ugc nofollow" target="_blank">https://examples.pyviz.org/opensky/opensky.html</a>经许可</p></figure><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lg lh l"/></div></figure><p id="d36f" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">几个月前，我写了一篇关于我最喜欢的Python Viz工具——holo Viz的文章。许多人有兴趣了解更多关于<a class="ae lf" href="https://datashader.org/" rel="noopener ugc nofollow" target="_blank"> Dashshader </a>的信息HoloViz家族中的大数据可视化工具。我非常喜欢Datashader，喜欢Datashader如何快速创建大型数据集的有意义的可视化。因此，在本文中，我将带您浏览一个简单的Datashader示例，解释Datashader是如何工作的，以及它为什么这么快。</p><h1 id="430d" class="me mf iq bd mg mh mi mj mk ml mm mn mo kf mp kg mq ki mr kj ms kl mt km mu mv bi translated"><strong class="ak">为什么大数据可视化很难？</strong></h1><p id="6c17" class="pw-post-body-paragraph li lj iq lk b ll mw ka ln lo mx kd lq lr my lt lu lv mz lx ly lz na mb mc md ij bi translated">以我的理解，大数据可视化主要有两个障碍。</p><ul class=""><li id="6004" class="nb nc iq lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated">首先是速度。如果您使用常规的Python绘图工具来绘制我下面的例子中的1100万个数据点，将会非常慢，并且您的Jupyter内核很可能会崩溃。</li><li id="f079" class="nb nc iq lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">第二是画质。即使它没有崩溃，并且您愿意等待，大多数绘图库也会简单地将每个新数据点绘制为一个圆形或其他形状，这将导致过度绘图。在这种情况下，即使为重叠点添加alpha透明度也不总是有帮助。想象一下，在一幅图像上，你有许多点一个接一个地显示:你所看到的将是一个斑点，并且很难从这个斑点中提取信息。</li></ul><p id="2c09" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">Datashader为这两个障碍提供了优雅且看似神奇的解决方案。接下来，我将向您展示一个示例，并探究其中的神奇之处。</p><h1 id="9a41" class="me mf iq bd mg mh mi mj mk ml mm mn mo kf mp kg mq ki mr kj ms kl mt km mu mv bi translated"><strong class="ak">使用Datashader的大数据可视化—示例</strong></h1><p id="846d" class="pw-post-body-paragraph li lj iq lk b ll mw ka ln lo mx kd lq lr my lt lu lv mz lx ly lz na mb mc md ij bi translated">该示例来自pyviz.org的纽约市出租车数据示例。完整示例请参见<a class="ae lf" href="https://examples.pyviz.org/nyc_taxi/nyc_taxi.html" rel="noopener ugc nofollow" target="_blank">https://examples.pyviz.org/nyc_taxi</a>。</p><ul class=""><li id="bbc2" class="nb nc iq lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated"><strong class="lk ja">导入需要的包</strong></li></ul><p id="de82" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated"><code class="fe np nq nr ns b">conda install</code>您的Conda环境中所需的软件包:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt lh l"/></div></figure><p id="b83c" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">然后在Python文件中导入包:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt lh l"/></div></figure><p id="ebba" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated"><strong class="lk ja">读入数据</strong></p><p id="4e89" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">对于非常大的文件，您会希望使用像Dask这样的分布式处理库和Datashader，但是这里我们有一个“只有”1100万条记录的Parquet文件，Datashader可以在使用Pandas的笔记本电脑上轻松处理它，而不需要任何特殊的计算资源。在这里，我们将加载两列来表示出租车的下车地点。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt lh l"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nu"><img src="../Images/53b1a09dfd979d9e0e6a8d6eb103b27d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pi4aa0X_4jcXLJfA65r_Lw.png"/></div></div></figure><ul class=""><li id="a134" class="nb nc iq lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated"><strong class="lk ja">绘图</strong></li></ul><p id="c845" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">在这里，我们使用Datashader绘制数据。我只用了4行代码和6毫秒的时间，用我的笔记本电脑绘制了1100万行数据，覆盖在纽约地区的地图上:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt lh l"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nv"><img src="../Images/077eb3bda216f1a1fb014059897347bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dGSZsWZjm0o42s2QVznmqQ.png"/></div></div></figure><p id="29dc" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">或者，不使用<code class="fe np nq nr ns b">datashade</code>函数，我们可以使用<code class="fe np nq nr ns b">hvplot</code>和<code class="fe np nq nr ns b">rasterize=True</code>来使用Datashader应用栅格化。如此简单！我强烈推荐使用hvplot进行可视化。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt lh l"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nw"><img src="../Images/738328703cecf3ba69d5564922cbd8b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gO_705M3V4FcBAYGN_7G5Q.png"/></div></div></figure><p id="30dd" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">如果您正在实时运行它，那么您将能够放大到此地图的任何区域，并且绘图会动态更新以使用该缩放级别的全分辨率。</p><h1 id="95b8" class="me mf iq bd mg mh mi mj mk ml mm mn mo kf mp kg mq ki mr kj ms kl mt km mu mv bi translated">【Datashader是如何工作的？</h1><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nx"><img src="../Images/dc5938da845110484db148c571dc6539.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IUtOh9VLg3xaQyOp"/></div></div></figure><p id="c4c2" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">图一。Datashader pipeline(图片经许可来自Datashader)。</p><p id="8f0f" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">Datashader使用五步管道将您的数据转化为绘图。<a class="ae lf" href="https://datashader.org/getting_started/Pipeline.html" rel="noopener ugc nofollow" target="_blank"> Datashader文档</a>说明了管道在每个步骤中是如何工作的——投影、聚合、转换、色彩映射和嵌入。我将把我前面的例子分解成这些小步骤，这样我们就可以确切地看到Datashader在幕后做什么。</p><p id="fbf7" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">让我们首先安装底层的Datashader函数，这样我们就可以运行各个步骤:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt lh l"/></div></figure><ul class=""><li id="fbb1" class="nb nc iq lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated"><strong class="lk ja">投影</strong></li></ul><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt lh l"/></div></figure><p id="5e31" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">首先，我们为要投影的数据定义一个具有宽度和高度的2D画布。画布定义了我们希望在最终图像中看到多少像素，并可选地定义将映射到这些像素的<code class="fe np nq nr ns b">x_range</code>和<code class="fe np nq nr ns b">y_range</code>。此处，要绘制的数据范围未在画布中设置，因此它们将在下一步中根据数据框中数据x和y值的最大值和最小值自动填充。画布定义了投影的内容，但是为了加快速度，每个点实际上都是在聚合步骤中投影的。</p><ul class=""><li id="0c82" class="nb nc iq lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated"><strong class="lk ja">聚合</strong></li></ul><p id="b9c1" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">在定义了投影画布之后，我们将每个点投影到二维输出网格中，并聚合每个像素的结果。Datashader支持这种聚合的许多选项，但在本例中，我们只是通过遍历数据点并在该点所在的位置增加像素，来计算有多少数据点投影到每个像素中。这种情况下的结果是一个计算每个像素衰减的二维直方图:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ny"><img src="../Images/03c79f507d38a890e972591a6bcd3846.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3IfL1SiHwmToJ40k"/></div></div></figure><ul class=""><li id="d84c" class="nb nc iq lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated"><strong class="lk ja">转换(可选)</strong></li></ul><p id="3b9e" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">无论原始数据集有多大，上一步的结果现在都是固定大小的格网。一旦数据在这个网格中，我们可以对它进行任何类型的转换，比如只选择某个范围的计数，根据其他数据集或值的结果屏蔽数据，等等。在这里，衰减数据的范围从一些像素的零到其他像素的数万，如果我们试图直接绘制网格，我们只会看到几个热点。为了使所有不同的水平都可见，如上图所示，使用图像处理技术“直方图均衡化”对数据进行转换，以显示计数的分布，而不是它们的绝对值。直方图均衡化实际上被合并到下面的色彩映射步骤中，但是如果我们愿意，我们可以在这个阶段进行显式转换，例如对计数求平方:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nz"><img src="../Images/ca45e06330f261268baeb0899c1baefd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z_XQIzGJ2c7e23QV"/></div></div></figure><ul class=""><li id="40b8" class="nb nc iq lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated"><strong class="lk ja">色彩映射</strong></li></ul><p id="2f3d" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">接下来，我们可以将入库的网格数据渲染到图像的相应像素。通过线性插值或自动变换(例如，通过对每个值调用对数函数，或如这里使用直方图均衡化)，每个箱值被映射到色图中定义的256种颜色之一。这里我们使用Colorcet的“fire”色图，它从黑色开始，代表最低的计数(1和2衰减)，经过红色，代表更高的值(以百为单位)，然后是黄色，代表更高的值(以千为单位)，最后是白色，代表每像素的最高计数(在本例中为数万)。我们将背景设置为黑色，以便更好地显示数据。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oa"><img src="../Images/8782a872e2c226d14f678dce13cda9e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IH814XH6JSD31jjy"/></div></div></figure><ul class=""><li id="6787" class="nb nc iq lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated"><strong class="lk ja">嵌入</strong></li></ul><p id="e580" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">如您所见，Datashader只渲染数据，而不渲染任何轴、彩条或您在完整绘图中预期的类似特征。为了获得那些有助于解释数据的特性，我们可以将Datashader生成的图像嵌入到一个绘图中。最简单的方法是使用HoloViews，这是一个高级绘图API，它提供了使用Matplotlib、Bokeh或Plotly作为后端的灵活性。这是一个使用全息视图定义一个“点”对象，然后对所有点进行数据阴影处理的例子。在这里，我们演示了一个替代方法“光栅化”而不是“数据阴影”，这样Bokeh就负责变换和色彩映射步骤，并允许悬停和彩条工作。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nt lh l"/></div></figure><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ob"><img src="../Images/d4eb99f89499b967f4a1143584275c79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_bRlr_Wf3XIhIw27bYSJBg.png"/></div></div></figure><h1 id="294f" class="me mf iq bd mg mh mi mj mk ml mm mn mo kf mp kg mq ki mr kj ms kl mt km mu mv bi translated"><strong class="ak">为什么Datashader速度如此之快？</strong></h1><p id="9962" class="pw-post-body-paragraph li lj iq lk b ll mw ka ln lo mx kd lq lr my lt lu lv mz lx ly lz na mb mc md ij bi translated">首先，我们需要谈谈原始数据格式。Datashader非常快，以至于读入数据通常是最慢的一步，尤其是当您的原始数据是一堆JSON文件或CSV文件时。对于像dropoff points这样的列数据，Parquet文件格式通常是一个很好的选择，因为它很紧凑，可以快速加载，只有效地读取您需要的列和范围，并在适当的时候支持分布式和核外操作。</p><p id="9ca1" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">第二，使用正确的输入文件格式，我们可以研究下一个最昂贵的任务，这是组合的投影+聚集步骤。这一步需要计算数百万个数据点中每一个的值，而所有后续计算都使用最终的固定大小的网格，因此速度更快。那么，Datashader怎么做才能让这一步走得快呢？</p><ul class=""><li id="7bc6" class="nb nc iq lk b ll lm lo lp lr nd lv ne lz nf md ng nh ni nj bi translated">Datashader的聚合计算是用Python编写的，然后使用<a class="ae lf" href="http://numba.pydata.org/" rel="noopener ugc nofollow" target="_blank"><strong class="lk ja">【Numba】</strong></a>即时编译成超快的机器代码。例如，这里是<a class="ae lf" href="https://github.com/holoviz/datashader/blob/5633ae7681c04f09d8b66ef9e0788c8c316a7122/datashader/reductions.py#L266-L308" rel="noopener ugc nofollow" target="_blank">代码</a>，在这里对每个箱子进行计数。</li><li id="25a1" class="nb nc iq lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">上面的例子使用了一个CPU，但是Datashader + Numba也支持<strong class="lk ja"> CUDA </strong> cudf数据帧作为Pandas数据帧的替代，如果你有一个GPU，它会运行得更快。</li><li id="2e9d" class="nb nc iq lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated">Datashader还可以并行化其管道(<a class="ae lf" href="https://github.com/holoviz/datashader/blob/6bb4736be8114a9ee83a8884a2b65c5257af2602/datashader/data_libraries/dask.py" rel="noopener ugc nofollow" target="_blank">代码示例</a>)，以便您可以利用所有可用的计算核心，扩展到更大的数据集，并提供更快的结果。</li></ul><p id="98b0" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">因为Datashader非常快，我们实际上可以交互地可视化大数据，无论何时缩放或平移，都可以动态地重新绘制。这里有一个<a class="ae lf" href="https://examples.pyviz.org/nyc_taxi/dashboard.html" rel="noopener ugc nofollow" target="_blank">示例</a>，您可以在面板仪表盘中交互查看纽约市出租车数据。我最喜欢的关于<a class="ae lf" href="https://examples.pyviz.org/ship_traffic/ship_traffic.html" rel="noopener ugc nofollow" target="_blank">船舶交通</a>的例子说明，即使你看到的只是Datashader渲染的像素化图像，你仍然可以检查单个数据点并理解你所看到的。examples.pyviz.org的另一个例子展示了大得多的文件的数据散列，在一台普通的笔记本电脑上高达数十亿个点。</p><h1 id="9e98" class="me mf iq bd mg mh mi mj mk ml mm mn mo kf mp kg mq ki mr kj ms kl mt km mu mv bi translated"><strong class="ak">在哪里可以了解到更多关于Datashader的信息？</strong></h1><ul class=""><li id="3572" class="nb nc iq lk b ll mw lo mx lr oc lv od lz oe md ng nh ni nj bi translated"><a class="ae lf" href="https://datashader.org/" rel="noopener ugc nofollow" target="_blank">https://datashader.org/</a></li><li id="4dd3" class="nb nc iq lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated"><a class="ae lf" href="https://www.youtube.com/watch?v=v0QiTptWt3w" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=v0QiTptWt3w</a></li><li id="681c" class="nb nc iq lk b ll nk lo nl lr nm lv nn lz no md ng nh ni nj bi translated"><a class="ae lf" href="https://www.youtube.com/watch?v=t5oFw9NUhlQ" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=t5oFw9NUhlQ</a></li></ul><p id="d786" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">总之，本文向您展示了一个使用Datashader可视化1100万行坐标数据的示例，并解释了为什么Datashader能够如此快速地生成有意义的可视化效果。值得注意的一点是，Datashader可以用于任何类型的数据，而不仅仅是上面例子中的地理点。我强烈推荐看看Datashader.org大学的许多好例子。</p><h1 id="7f6f" class="me mf iq bd mg mh mi mj mk ml mm mn mo kf mp kg mq ki mr kj ms kl mt km mu mv bi translated"><strong class="ak">确认</strong></h1><p id="5621" class="pw-post-body-paragraph li lj iq lk b ll mw ka ln lo mx kd lq lr my lt lu lv mz lx ly lz na mb mc md ij bi translated">非常感谢Jim Bednar对本文的指导和反馈。</p><h1 id="707f" class="me mf iq bd mg mh mi mj mk ml mm mn mo kf mp kg mq ki mr kj ms kl mt km mu mv bi translated"><strong class="ak">参考文献</strong></h1><p id="23b6" class="pw-post-body-paragraph li lj iq lk b ll mw ka ln lo mx kd lq lr my lt lu lv mz lx ly lz na mb mc md ij bi translated">【https://examples.pyviz.org/nyc_taxi/nyc_taxi.html T4】</p><p id="3965" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated"><a class="ae lf" href="https://datashader.org/getting_started/Pipeline.html" rel="noopener ugc nofollow" target="_blank">https://datashader.org/getting_started/Pipeline.html</a></p><p id="8e83" class="pw-post-body-paragraph li lj iq lk b ll lm ka ln lo lp kd lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated"><a class="ae lf" href="http://numba.pydata.org/" rel="noopener ugc nofollow" target="_blank">http://numba.pydata.org/</a></p></div></div>    
</body>
</html>