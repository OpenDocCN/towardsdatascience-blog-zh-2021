<html>
<head>
<title>Writing YAML files with python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用python编写YAML文件</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/writing-yaml-files-with-python-a6a7fc6ed6c3?source=collection_archive---------0-----------------------#2021-10-23">https://towardsdatascience.com/writing-yaml-files-with-python-a6a7fc6ed6c3?source=collection_archive---------0-----------------------#2021-10-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5fe3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用ruamel.yaml注释配置文件</h2></div><p id="b13f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lb">本文期望读者对</em> <a class="ae lc" href="https://docs.python.org/3/" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> python编程语言</em> </a> <em class="lb">有一个基本的了解。</em></p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ld"><img src="../Images/56cb0c26116a90d83247360882a03099.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tkfqkaJDBO4OFivpB4Qc5g.jpeg"/></div></div><p class="lp lq gj gh gi lr ls bd b be z dk translated">https://pxhere.com/en/photo/492303</p></figure><p id="bba2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Yaml文件已经存在了二十多年了。它们对于显示数据结构非常有用，并且是配置文件的一种流行格式。从<a class="ae lc" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> AWS CloudFormation </a>、<a class="ae lc" href="https://www.commonwl.org/user_guide/" rel="noopener ugc nofollow" target="_blank">公共工作流语言</a>到<a class="ae lc" href="https://www.home-assistant.io/" rel="noopener ugc nofollow" target="_blank">家庭助手</a> ⁴，yamls是互联网配置文件的基本支柱。它们比其他格式(如<a class="ae lc" href="https://en.wikipedia.org/wiki/JSON" rel="noopener ugc nofollow" target="_blank"> JSON </a>)更容易阅读，支持注释并易于版本控制——试着在两个略有不同的JSON文件上运行<code class="fe lt lu lv lw b">git merge</code>,你会明白我的意思。尽管如此，当涉及到用我们钟爱的语言python编写yaml文件时，我们的选择相当有限。只有<a class="ae lc" href="https://pyyaml.org/wiki/PyYAMLDocumentation" rel="noopener ugc nofollow" target="_blank"> PyYAML </a>和<a class="ae lc" href="https://yaml.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> ruamel.yaml </a>在<a class="ae lc" href="https://matrix.yaml.io/" rel="noopener ugc nofollow" target="_blank"> yaml一致性测试矩阵</a>中有注册表，其中只有ruamel.yaml支持处理注释。</p><p id="6157" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果用户可能需要在稍后阶段手动修改配置文件，那么能够将注释写入配置文件是非常有用的。另一个优势是enum支持，通过向yaml文件添加注释，用户可以看到某个设置的所有可用选项，而不必滚动文档来找到它们！更好的是，配置文件中的注释可以让用户包括到文档的链接，在那里他们可以阅读配置文件的那个部分！</p><p id="619a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，让我们开始通过python编写一些yaml</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h2 id="c6d3" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">一个示例yaml文件:</h2><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="3f08" class="me mf iq lw b gy nb nc l nd ne">employees:<br/>  - name: Jeffrey Bezos<br/>    job title: CEO<br/>    annual salary (USD): 1000000000000<br/>  - name: John Smith<br/>    job title: factory worker<br/>    annual salary (USD): 20000</span></pre><p id="90d8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个yaml文件相当于python中的一个字典，只有一个关键字<em class="lb">“</em>employees ”,包含两个元素的列表。<br/>嵌套列表中的每个元素包含三个相同的关键字:“姓名”、“职位”和“年薪(美元)”。</p><p id="c54c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">yaml文件很酷的一点是能够使用“#”符号对它们进行注释</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="3b33" class="me mf iq lw b gy nb nc l nd ne">employees:<br/>  # Start with CEO<br/>  - name: Jeffrey Bezos  # Goes by Jeff<br/>    job title: CEO # ...entrepreneur, born in 1964... <br/>    annual salary (USD): 1000000000000  # This is too much<br/>  # List of factory workers below<br/>  - name: John Smith<br/>    job title: factory worker<br/>    annual salary (USD): 20000  # Probably deserves a raise</span></pre><h2 id="1aed" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">安装ruamel.yaml</h2><p id="811f" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">下面我们将尝试用ruamel.yaml 将这个yaml文件加载到python中。如果你需要安装ruamel.yaml，我们将使用版本<code class="fe lt lu lv lw b">0.17.4</code>，这里有一些命令可以帮助你。</p><p id="4892" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">安装选项1:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="624d" class="me mf iq lw b gy nb nc l nd ne">pip install ruamel.yaml==0.17.4</span></pre><p id="bccb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">安装选项2:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="6c56" class="me mf iq lw b gy nb nc l nd ne">conda install -c conda-forge ruamel.yaml==0.17.4</span></pre><h2 id="b99f" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">将ruamel导入python并加载yaml文件</h2><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="2674" class="me mf iq lw b gy nb nc l nd ne"># Imports<br/>from ruamel.yaml.main import round_trip_load as yaml_load</span><span id="dc54" class="me mf iq lw b gy nk nc l nd ne">employees_dict = yaml_load("""<br/>employees:<br/>  # Start with CEO<br/>  - name: Jeffrey Bezos  # Goes by Jeff<br/>    job title: CEO # / Entrepreneur, born in 1964...<br/>    annual salary (USD): 1000000000000  # This is too much<br/>  # List of factory workers below<br/>  - name: John Smith<br/>    job title: factory worker<br/>    annual salary (USD): 20000  # Probably deserves a raise<br/>""")</span><span id="a959" class="me mf iq lw b gy nk nc l nd ne">print(employees_dict)<br/>print(f"Type: {type(employees_dict}")</span></pre><p id="3e6f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="02f4" class="me mf iq lw b gy nb nc l nd ne">ordereddict([('employees', [ordereddict([('name', 'Jeffrey Bezos'), ('job title', 'CEO'), ('annual salary (USD)', 1000000000000)]), ordereddict([('name', 'John Smith'), ('job title', 'factory worker'), ('annual salary (USD)', 20000)])])])<br/>Type: &lt;class 'ruamel.yaml.comments.CommentedMap'&gt;</span></pre><p id="ba4d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">酷！这很简单。现在让我们试着从头开始构建一个yaml文件！</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="4c34" class="nl mf iq bd mg nm nn no mj np nq nr mm jw ns jx mp jz nt ka ms kc nu kd mv nv bi translated">从头开始构建yaml文件</h1><h2 id="9e9f" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">让我们首先设置我们的导入和全局变量</h2><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="1e11" class="me mf iq lw b gy nb nc l nd ne"># Regular imports<br/>from copy import deepcopy<br/><br/># Yaml loaders and dumpers<br/>from ruamel.yaml.main import \<br/>    round_trip_load as yaml_load, \<br/>    round_trip_dump as yaml_dump<br/><br/># Yaml commentary<br/>from ruamel.yaml.comments import \<br/>    CommentedMap as OrderedDict, \<br/>    CommentedSeq as OrderedList<br/><br/># For manual creation of tokens<br/>from ruamel.yaml.tokens import CommentToken<br/>from ruamel.yaml.error import CommentMark</span><span id="d3fe" class="me mf iq lw b gy nk nc l nd ne"># Globals<br/># Number of spaces for an indent <br/>INDENTATION = 2 <br/># Used to reset comment objects<br/>tsRESET_COMMENT_LIST = [None, [], None, None]</span></pre><p id="7e89" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并使用<code class="fe lt lu lv lw b">OrderedDict</code> <em class="lb"> </em>和<code class="fe lt lu lv lw b">OrderedList</code>属性创建一个购物清单。</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="cc04" class="me mf iq lw b gy nb nc l nd ne">shopping_list = OrderedDict({<br/>    "Shopping List": OrderedDict({<br/>        "eggs": OrderedDict({<br/>            "type": "free range",<br/>            "brand": "Mr Tweedy",<br/>            "amount": 12<br/>        }),<br/>        "milk": OrderedDict({<br/>            "type": "pasteurised",<br/>            "litres": 1.5,<br/>            "brands": OrderedList([<br/>                "FarmFresh",<br/>                "FarmHouse gold",<br/>                "Daisy The Cow"<br/>            ])<br/>        })<br/>    })<br/>})</span><span id="cc71" class="me mf iq lw b gy nk nc l nd ne"># Dump the yaml file<br/>print(yaml_dump(shopping_list, preseve_quotes=True))</span></pre><p id="0537" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="ed0f" class="me mf iq lw b gy nb nc l nd ne">Shopping List:<br/>  eggs:<br/>    type: free range<br/>    brand: Mr Tweedy<br/>    amount: 12<br/>  milk:<br/>    type: pasteurised<br/>    litres: 1.5<br/>    brands:<br/>      - FarmFresh<br/>      - FarmHouse gold<br/>      - Daisy The Cow</span></pre><p id="a1fe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建我们的数据结构是相当乏味的。我们希望写入yaml的数据结构也不太可能是这种格式。它更有可能是标准的字典和/或列表格式。没关系，我们可以用<code class="fe lt lu lv lw b">dump</code>和<code class="fe lt lu lv lw b">load</code>来代替，将标准字典和列表格式转换成我们的OrderedList ( <code class="fe lt lu lv lw b">CommentedMap</code>)和OrderedList ( <code class="fe lt lu lv lw b">CommentedSeq</code>)。</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="dfbb" class="me mf iq lw b gy nb nc l nd ne"># Original object<br/>shopping_list = {<br/>    "Shopping List": {<br/>        "eggs": {<br/>            "type": "free range",<br/>            "brand": "Mr Tweedy",<br/>            "amount": 12<br/>        },<br/>        "milk": {<br/>            "type": "pasteurised",<br/>            "litres": 1.5,<br/>            "brands": [<br/>                "FarmFresh",<br/>                "FarmHouse gold",<br/>                "Daisy The Cow"<br/>            ]<br/>        }<br/>    }<br/>}<br/><br/># To yaml object<br/>shopping_list = yaml_load(yaml_dump(shopping_list), preseve_quotes=True)</span><span id="2294" class="me mf iq lw b gy nk nc l nd ne"># Show object type<br/>print(type(shopping_list))</span></pre><p id="5d87" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="af4a" class="me mf iq lw b gy nb nc l nd ne">&lt;class 'ruamel.yaml.comments.CommentedMap'&gt;</span></pre><p id="fbad" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完美！</p><h2 id="0231" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">向yaml文件添加标题</h2><p id="9d8c" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">我们可以使用<code class="fe lt lu lv lw b">yaml_set_start_comment</code>属性在地图对象上添加注释</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="f22e" class="me mf iq lw b gy nb nc l nd ne">shopping_list.yaml_set_start_comment("Shopping Lists for date: "<br/>                                     "23 Oct 2021")<br/>print(yaml_dump(shopping_list, <br/>                indent=INDENTATION, <br/>                block_seq_indent=INDENTATION))</span></pre><p id="a652" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="cd11" class="me mf iq lw b gy nb nc l nd ne"># Shopping Lists for date: 21 Oct 2021<br/>Shopping List:<br/>  eggs:<br/>    type: free range<br/>    brand: Mr Tweedy<br/>    amount: 12<br/>  milk:<br/>    type: pasteurised<br/>    litres: 1.5<br/>    brands:<br/>      - FarmFresh<br/>      - FarmHouse gold<br/>      - Daisy The Cow</span></pre><h2 id="6a36" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">在嵌套键前添加注释</h2><p id="9f3b" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">假设我们真的不想忘记鸡蛋，让我们在鸡蛋键上方写上“请不要忘记鸡蛋！”。由于<code class="fe lt lu lv lw b">shopping_list</code>对象的‘购物清单’属性也是一个<code class="fe lt lu lv lw b">OrderedDict</code>或<code class="fe lt lu lv lw b">OrderedList</code>，我们可以在<code class="fe lt lu lv lw b">Shopping List</code>属性上使用<code class="fe lt lu lv lw b">yaml_set_comment_before_after_key</code>方法。</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="00d1" class="me mf iq lw b gy nb nc l nd ne">shopping_list.get("Shopping List").\<br/>    yaml_set_comment_before_after_key(key="eggs",<br/>                                      before="Please don't forget "<br/>                                             "eggs!")<br/>print(yaml_dump(shopping_list, <br/>                indent=INDENTATION, <br/>                block_seq_indent=INDENTATION))</span></pre><p id="94c4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="cc85" class="me mf iq lw b gy nb nc l nd ne"># Shopping Lists for date: 21 Oct 2021<br/>Shopping List:<br/>#  Please don't forget eggs!<br/>  eggs:<br/>    type: free range<br/>    brand: Mr Tweedy<br/>    amount: 12<br/>  milk:<br/>    type: pasteurised<br/>    litres: 1.5<br/>    brands:<br/>      - FarmFresh<br/>      - FarmHouse gold<br/>      - Daisy The Cow</span></pre><p id="38da" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">呃，这可不理想！那个评论应该缩进。让我们删除它，并确保下次使用<code class="fe lt lu lv lw b">indent</code>参数。要删除评论，我们需要重置<code class="fe lt lu lv lw b">OrderedDict</code>的<code class="fe lt lu lv lw b">ca</code>属性中的<em class="lb">蛋</em>键，然后重试。</p><h2 id="af7b" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">删除注释对象</h2><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="5d6d" class="me mf iq lw b gy nb nc l nd ne">shopping_list.get("Shopping List").ca.\<br/>    items["eggs"] = deepcopy(RESET_COMMENT_LIST)<br/>print(yaml_dump(shopping_list, <br/>                indent=INDENTATION, <br/>                block_seq_indent=INDENTATION))</span></pre><p id="6465" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="fc19" class="me mf iq lw b gy nb nc l nd ne"># Shopping Lists for date: 21 Oct 2021<br/>Shopping List:<br/>  eggs:<br/>    type: free range<br/>    brand: Mr Tweedy<br/>    amount: 12<br/>  milk:<br/>    type: pasteurised<br/>    litres: 1.5<br/>    brands:<br/>      - FarmFresh<br/>      - FarmHouse gold<br/>      - Daisy The Cow</span></pre><p id="98c5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们用<code class="fe lt lu lv lw b">indent</code>参数(设置为2个空格)再试一次</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="0ddf" class="me mf iq lw b gy nb nc l nd ne">object_depth = 1 # Shopping List<br/><br/>shopping_list.get("Shopping List").\<br/>    yaml_set_comment_before_after_key(<br/>        key="eggs",<br/>        before="Don't forget the eggs",<br/>        indent=object_depth*INDENTATION<br/>    )</span><span id="9891" class="me mf iq lw b gy nk nc l nd ne">print(yaml_dump(shopping_list, <br/>                indent=INDENTATION, <br/>                block_seq_indent=INDENTATION))</span></pre><p id="1b51" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="c184" class="me mf iq lw b gy nb nc l nd ne"># Shopping Lists for date: 21 Oct 2021<br/>Shopping List:<br/>  # Don't forget the eggs<br/>  eggs:<br/>    type: free range<br/>    brand: Mr Tweedy<br/>    amount: 12<br/>  milk:<br/>    type: pasteurised<br/>    litres: 1.5<br/>    brands:<br/>      - FarmFresh<br/>      - FarmHouse gold<br/>      - Daisy The Cow</span></pre><h2 id="75ac" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">在键后添加注释</h2><p id="b2c2" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">我们也可以在一个键后添加注释</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="e828" class="me mf iq lw b gy nb nc l nd ne">object_depth = 2 # Shopping List -&gt; Eggs<br/>shopping_list.get("Shopping List").\<br/>    yaml_set_comment_before_after_key(<br/>        key="eggs",<br/>        after="Please don't forget eggs!",<br/>        after_indent=object_depth*INDENTATION<br/>    )<br/>print(yaml_dump(shopping_list, <br/>                indent=INDENTATION, <br/>                block_seq_indent=INDENTATION))</span></pre><p id="4304" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="5557" class="me mf iq lw b gy nb nc l nd ne"># Shopping Lists for date: 21 Oct 2021<br/>Shopping List:<br/>  # Don't forget the eggs<br/>  eggs:<br/>    # Please don't forget eggs!<br/>    type: free range<br/>    brand: Mr Tweedy<br/>    amount: 12<br/>  milk:<br/>    type: pasteurised<br/>    litres: 1.5<br/>    brands:<br/>      - FarmFresh<br/>      - FarmHouse gold<br/>      - Daisy The Cow</span></pre><h2 id="49d2" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">让我们给一个键添加一个行尾注释</h2><p id="0069" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">礼貌地提醒一下，两升牛奶太多了！</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="60f6" class="me mf iq lw b gy nb nc l nd ne">shopping_list.get("Shopping List").\<br/>    get("milk").\<br/>    yaml_add_eol_comment(<br/>        key="litres",<br/>        comment="2 litres is too much milk!"<br/>    )</span><span id="69d1" class="me mf iq lw b gy nk nc l nd ne">print(yaml_dump(shopping_list, <br/>                indent=INDENTATION, <br/>                block_seq_indent=INDENTATION))</span></pre><p id="ce36" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="19e1" class="me mf iq lw b gy nb nc l nd ne"># Shopping Lists for date: 21 Oct 2021<br/>Shopping List:<br/>  # Don't forget the eggs<br/>  eggs:<br/>    # Please don't forget eggs!<br/>    type: free range<br/>    brand: Mr Tweedy<br/>    amount: 12<br/>  milk:<br/>    type: pasteurised<br/>    litres: 1.5  # 2 litres is too much milk!<br/>    brands:<br/>      - FarmFresh<br/>      - FarmHouse gold<br/>      - Daisy The Cow</span></pre><h2 id="8171" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">在列表中添加注释</h2><p id="968b" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">请注意，<em class="lb">农家金</em>和<em class="lb">奶牛雏菊</em>是最后的选择。通过在列表的农舍金牌项目的索引上使用before参数。对于列表中的注释，仅支持before参数。</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="1c57" class="me mf iq lw b gy nb nc l nd ne">object_depth = 3 # Shopping List -&gt; Milk -&gt; Brands<br/>shopping_list.get("Shopping List").\<br/>    get("milk").\<br/>    get("brands").\<br/>    yaml_set_comment_before_after_key(<br/>        key=1, # "Farmhouse gold" is the second item in the list<br/>        before="Last Resorts",<br/>        indent=object_depth*INDENTATION<br/>    )<br/>print(yaml_dump(shopping_list, <br/>                indent=INDENTATION, <br/>                block_seq_indent=INDENTATION))</span></pre><p id="8eb8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="6869" class="me mf iq lw b gy nb nc l nd ne"># Shopping Lists for date: 21 Oct 2021<br/>Shopping List:<br/>  # Don't forget the eggs<br/>  eggs:<br/>    type: free range<br/>    brand: Mr Tweedy<br/>    amount: 12<br/>  milk:<br/>    type: pasteurised<br/>    litres: 1.5  # 2 litres is too much milk!<br/>    brands:<br/>      - FarmFresh<br/>      # Last Resorts<br/>      - FarmHouse gold<br/>      - Daisy The Cow</span></pre><h2 id="fc62" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">向列表中的项目添加行尾注释</h2><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="6962" class="me mf iq lw b gy nb nc l nd ne">object_depth = 3 # Shopping List -&gt; Milk -&gt; Brands<br/>shopping_list.get("Shopping List").\<br/>    get("milk").\<br/>    get("brands").\<br/>    yaml_add_eol_comment(<br/>        key=1, <br/>        comment="Too creamy"<br/>    )<br/>print(yaml_dump(shopping_list, <br/>                indent=INDENTATION, <br/>                block_seq_indent=INDENTATION))</span></pre><p id="8a2a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="0168" class="me mf iq lw b gy nb nc l nd ne">TypeError: 'CommentToken' object is not iterable</span></pre><p id="0379" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">哦不！这是一个<a class="ae lc" href="https://sourceforge.net/p/ruamel-yaml/tickets/404/" rel="noopener ugc nofollow" target="_blank">已知的bug </a>，我们将不得不使用brands对象的<code class="fe lt lu lv lw b">ca</code>属性将其添加到列表中。</p><h2 id="b186" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">ca属性的细分:</h2><p id="f484" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">让我们先看看我们在处理什么:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="ea39" class="me mf iq lw b gy nb nc l nd ne">print(shopping_list.get("Shopping List").get("milk").get("brands").ca)</span></pre><p id="9c65" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="3658" class="me mf iq lw b gy nb nc l nd ne">Comment(<br/>  start=None,<br/>  items={<br/>    1: [None, [CommentToken('# Last Resorts\n', col: 6)], None, None]<br/>  })</span></pre><p id="9058" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe lt lu lv lw b">CommentedSeq</code>中只使用了items属性值中的前两个元素。第一个元素是eol注释，而第二个元素是before注释列表。对于<code class="fe lt lu lv lw b">CommentedMap</code>，第一个元素代表“开始注释”，第二个元素是之前注释，第三个是eol注释，第四个是之后注释。本文的<em class="lb">资源</em>部分对此进行了总结。</p><h2 id="bb9d" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">手动添加CommentToken对象</h2><p id="ca89" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">我们需要将项目的第一个元素设置为我们想要的注释。<br/>手动添加一个<code class="fe lt lu lv lw b">CommentToken</code>对象时，我们以<code class="fe lt lu lv lw b">\ #</code>为前缀，以一个新的行字符<code class="fe lt lu lv lw b">\n</code>结束。<br/>我们用一个最小的<code class="fe lt lu lv lw b">CommentMark</code>对象初始化<code class="fe lt lu lv lw b">start_mark</code>参数，并将<code class="fe lt lu lv lw b">end_mark</code>参数设置为<code class="fe lt lu lv lw b">None</code>。</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="8a2f" class="me mf iq lw b gy nb nc l nd ne">shopping_list.get("Shopping List").\<br/>    get("milk").\<br/>    get("brands").ca.\<br/>    items[1][0] = CommentToken(value=" # Too creamy\n",<br/>                               start_mark=CommentMark(0),<br/>                               end_mark=None)<br/>print(yaml_dump(shopping_list, <br/>                indent=INDENTATION, <br/>                block_seq_indent=INDENTATION))</span></pre><p id="a523" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">输出:</p><pre class="le lf lg lh gt mx lw my mz aw na bi"><span id="a0f5" class="me mf iq lw b gy nb nc l nd ne"># Shopping Lists for date: 21 Oct 2021<br/>Shopping List:<br/>  # Don't forget the eggs<br/>  eggs:<br/>    type: free range<br/>    brand: Mr Tweedy<br/>    amount: 12<br/>  milk:<br/>    type: pasteurised<br/>    litres: 1.5  # 2 litres is too much milk!<br/>    brands:<br/>      - FarmFresh<br/>      # Last Resorts<br/>      - FarmHouse gold  # Too creamy<br/>      - Daisy The Cow</span></pre><h1 id="5c71" class="nl mf iq bd mg nm nw no mj np nx nr mm jw ny jx mp jz nz ka ms kc oa kd mv nv bi translated">变通办法概述</h1><p id="fcfa" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">由此可以看出ruamel.yaml还有一定的提升空间:</p><ol class=""><li id="9aa1" class="ob oc iq kh b ki kj kl km ko od ks oe kw of la og oh oi oj bi translated">在使用<code class="fe lt lu lv lw b">yaml_set_comment_before_after_key</code>方法的before或after参数时，需要设置缩进。这也意味着在创建注释时需要知道嵌套有多深。</li><li id="987d" class="ob oc iq kh b ki ok kl ol ko om ks on kw oo la og oh oi oj bi translated">如果在列表中的元素上已经存在before注释，则不能使用<code class="fe lt lu lv lw b">yaml_add_eol_comment</code>方法。</li><li id="094d" class="ob oc iq kh b ki ok kl ol ko om ks on kw oo la og oh oi oj bi translated">在我写这篇文章的时候，ruamel的最新版本(0.17.16)有一个bug，使得许多输出省略了许多注释。</li><li id="ab04" class="ob oc iq kh b ki ok kl ol ko om ks on kw oo la og oh oi oj bi translated">ruamel.yaml文档中没有关于将注释写入yaml文件的内容。</li></ol><h2 id="57d4" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">对我的发现的小小咆哮</h2><p id="55b2" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">互联网最重要的配置格式结构之一怎么会没有一个来自世界上最流行的编程语言之一的完全受支持的解析器呢？我确信一定有成千上万的python开发者和我有着同样的想法。</p><p id="78e1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在任何人急于发表评论之前，你应该向开发商have⁵ ⁶ ⁷.提出这个问题这样做，我可以假设为什么在我之前有这么多人从来没有烦恼过。ruamel.yaml由<a class="ae lc" href="https://sourceforge.net/projects/ruamel-yaml/" rel="noopener ugc nofollow" target="_blank"> SourceForge </a>托管，当你访问这个网站时，你会觉得你已经进入了90年代(从UX的背景来看，90年代是一个糟糕的地方)。与GitHub不同，SourceForge不允许你在创建后编辑问题。界面笨拙，搜索算法在搜索现有问题时过于敏感(什么都会出现！)而且通知服务是古老的——它不是一个通知标签，你会在一个新的评论被添加到你的问题(包括你自己的)时收到一封电子邮件，或者你可以订阅一个RSS提要。</p><p id="6e4c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然PyYAML似乎已经重新获得了maintenance⁸，但是当前的开发人员仍然处于一个尴尬的境地，许多软件依赖于PyYAML而没有指定version⁹.更新代码以合并/导入ruamel.yaml中完成的许多工作，如支持注释、YAML 1.2格式或其他常规改进，会有破坏向后兼容性的风险，因此会导致许多用户代码中断。对于那些没有对依赖项进行版本控制的人来说，这是一个很好的教训，但是我不确定每个人都这样认为。</p><p id="3fb9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我个人不知道正确的解决方案是什么，像PyYAML2这样的新名称可以继承ruamel.yaml的工作，同时保持对使用set PyYAML的人的向后兼容性？更多支持ruamel.yaml？</p><p id="2a86" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章绝不是对PyYAML或ruamel.yaml的维护者的攻击。我一点也不羡慕他们，我真诚地希望更多的支持在路上。我还完全允许复制/编辑这段代码，并将其用作在python中处理yaml的文档。至少，我希望这篇文章至少对那些希望将有限的、粗糙的注释写入yaml文件的开发人员有用，并避免其他人通过反复试验对源代码进行逆向工程。</p><h2 id="1d16" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">资源:</h2><p id="4462" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">stack overflow:<a class="ae lc" href="https://stackoverflow.com/questions/40704916/how-to-insert-a-comment-line-to-yaml-in-python-using-ruamel-yaml" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/40704916/how-to-insert-a-comment-line-to-YAML-in-python-using-ruamel-YAML</a></p><p id="6569" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">my binder . org:<a class="ae lc" href="https://mybinder.org/v2/gist/alexiswl/7fe1b3a90d86313c9785992bd0ce6e19/HEAD" rel="noopener ugc nofollow" target="_blank">https://my binder . org/v2/gist/Alexis wl/7 Fe 1 B3 a 90d 86313 c 9785992 BD 0 ce 6 e 19/HEAD</a></p><p id="d7f4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">ruamel.yaml文档:<a class="ae lc" href="https://yaml.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">https://yaml.readthedocs.io/en/latest/</a></p><p id="0455" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注释标记对象结构:</p><ul class=""><li id="587c" class="ob oc iq kh b ki kj kl km ko od ks oe kw of la op oh oi oj bi translated">CommentedMap: <br/> 0:用<code class="fe lt lu lv lw b">yaml_set_start_comment</code>方法设置的注释。<br/> 1:用<code class="fe lt lu lv lw b">before</code>参数从<code class="fe lt lu lv lw b">yaml_set_comment_before_after_key</code>方法设置的注释。<br/> 2:来自<code class="fe lt lu lv lw b">yaml_set_eol_comment</code> <br/>的注释集3:来自带<code class="fe lt lu lv lw b">after</code>参数的<code class="fe lt lu lv lw b">yaml_set_comment_before_after_key</code>方法的注释集。</li><li id="ae53" class="ob oc iq kh b ki ok kl ol ko om ks on kw oo la op oh oi oj bi translated">CommentedSeq: <br/> 0:从<code class="fe lt lu lv lw b">yaml_set_eol_comment</code> <br/>设置的注释1:从带有<code class="fe lt lu lv lw b">before</code>参数的<code class="fe lt lu lv lw b">yaml_set_comment_before_after_key</code>方法设置的注释。<br/> 2:未使用<br/> 3:未使用</li></ul><h2 id="e28a" class="me mf iq bd mg mh mi dn mj mk ml dp mm ko mn mo mp ks mq mr ms kw mt mu mv mw bi translated">参考资料:</h2><p id="7afa" class="pw-post-body-paragraph kf kg iq kh b ki nf jr kk kl ng ju kn ko nh kq kr ks ni ku kv kw nj ky kz la ij bi translated">[1]:<a class="ae lc" href="https://yaml.org/about.html" rel="noopener ugc nofollow" target="_blank">https://yaml.org/about.html</a><br/>【2】:<a class="ae lc" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-formats.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AWS cloudformation/latest/user guide/template-formats . html</a><br/>【3】:<a class="ae lc" href="https://www.commonwl.org/user_guide/02-1st-example/index.html" rel="noopener ugc nofollow" target="_blank">https://www . commonwl . org/user _ guide/02-1st-example/index . html</a><br/>【4】:<a class="ae lc" href="https://www.home-assistant.io/docs/configuration/yaml/" rel="noopener ugc nofollow" target="_blank">https://www.home-assistant.io/docs/configuration/yaml/</a><br/>【5】:<a class="ae lc" href="https://sourceforge.net/p/ruamel-yaml/tickets/400/" rel="noopener ugc nofollow" target="_blank">https://sourceforge.net/p/ruamel-yaml/tickets/400/</a><a class="ae lc" href="https://sourceforge.net/p/ruamel-yaml/tickets/400/" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>