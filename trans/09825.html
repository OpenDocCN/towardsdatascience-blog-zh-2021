<html>
<head>
<title>How I crawled the entire list of postal codes in a country with Java</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我是如何用Java爬取一个国家的邮政编码列表的</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-i-crawled-the-entire-list-of-postal-codes-in-a-country-with-java-fde6259a8353?source=collection_archive---------29-----------------------#2021-09-14">https://towardsdatascience.com/how-i-crawled-the-entire-list-of-postal-codes-in-a-country-with-java-fde6259a8353?source=collection_archive---------29-----------------------#2021-09-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1ada" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从OneMap.sg中检索新加坡的141，848个邮政编码—代码实现</h2></div><p id="f982" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi le translated">在我居住的地方，没有太多的地理空间专业知识。当然，研究起来很有趣，也很吸引人，但是由于这个领域非常小众，很难在这个领域找到志同道合的人，更不用说找到另一个愿意不断更新️she地图数据的人了。其中一个仓库恰好是新加坡现有邮政编码的完整列表，我计划每年发送几次。</p><p id="82d6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">被分配到一个有很多限制的环境中工作，让我变得越来越敏捷，越来越适应环境。这表现为寻找替代方案，通过漏洞绕过等等。手头有一份邮政编码列表恰好是我在工作中使用的少数几个技巧之一。对于地理编码相关的任务，例如<strong class="kk iu">识别某个建筑物所在的地理边界</strong>，</p><blockquote class="ln"><p id="41d9" class="lo lp it bd lq lr ls lt lu lv lw ld dk translated">[……]与在分配任务后仅使用地图服务API<strong class="ak">标记每个感兴趣的地点相比，</strong>使用带有相关地带/地区/区域标记的邮政编码列表可以节省我几天的工作时间。</p></blockquote><p id="79d0" class="pw-post-body-paragraph ki kj it kk b kl lx ju kn ko ly jx kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">对于有兴趣了解如何以最少的麻烦对位置列表进行地理编码的读者，请阅读我关于<a class="ae mc" href="https://turfjs.org/" rel="noopener ugc nofollow" target="_blank"> TurfJS </a>的文章:</p><div class="md me gp gr mf mg"><a rel="noopener follow" target="_blank" href="/using-turf-js-to-geocode-coordinates-with-custom-boundaries-bb843b7150d0"><div class="mh ab fo"><div class="mi ab mj cl cj mk"><h2 class="bd iu gy z fp ml fr fs mm fu fw is bi translated">使用Turf.js通过自定义边界对坐标进行地理编码</h2><div class="mn l"><h3 class="bd b gy z fp ml fr fs mm fu fw dk translated">这个位置属于❝Which地区/区域/区域吗？❞</h3></div><div class="mo l"><p class="bd b dl z fp ml fr fs mm fu fw dk translated">towardsdatascience.com</p></div></div><div class="mp l"><div class="mq l mr ms mt mp mu mv mg"/></div></div></a></div><h1 id="31a7" class="mw mx it bd my mz na nb nc nd ne nf ng jz nh ka ni kc nj kd nk kf nl kg nm nn bi translated">Java代码实现——用令牌调用API</h1><h2 id="1c83" class="no mx it bd my np nq dn nc nr ns dp ng kr nt nu ni kv nv nw nk kz nx ny nm nz bi translated">第1点—以编程方式更新API令牌</h2><p id="5752" class="pw-post-body-paragraph ki kj it kk b kl oa ju kn ko ob jx kq kr oc kt ku kv od kx ky kz oe lb lc ld im bi translated">对于熟悉Google Maps服务API的读者来说，您应该知道专门为您的API帐户生成了一个令牌，以限制您调用API服务器的次数。类似地，我使用一个名为<a class="ae mc" href="https://www.onemap.gov.sg/main/v2/" rel="noopener ugc nofollow" target="_blank"> OneMap.sg </a>的地图服务提供者，它需要一个令牌。然而，问题是OneMap选择在某个月之后使令牌失效，因此，每当我的调度程序被编程设置为开始进行API调用时，我需要首先确保进行单独的API POST请求，以便检索未过期的令牌。以下是我在Java中使用的效用函数:</p><pre class="of og oh oi gt oj ok ol bn om on bi"><span id="fce0" class="oo mx it ok b be op oq l or os">private static void setAccessToken() throws UnsupportedEncodingException, IOException {<br/>        String endpoint = "https://developers.onemap.sg/privateapi/auth/post/getToken";<br/>        String email = "&lt;EMAIL REGISTERED&gt;";<br/>        String password = "&lt;PASSWORD OF ACCOUNT&gt;";<br/>CloseableHttpClient httpclient = HttpClients.createDefault();<br/>        HttpPost httpPost = new HttpPost(endpoint);<br/>List&lt;NameValuePair&gt; params = new ArrayList&lt;NameValuePair&gt;();<br/>        params.add(new BasicNameValuePair("email", email));<br/>        params.add(new BasicNameValuePair("password", password));<br/>        httpPost.setEntity(new UrlEncodedFormEntity(params));<br/>CloseableHttpResponse httpresponse = httpclient.execute(httpPost);<br/>        int statusCode = httpresponse.getStatusLine().getStatusCode();<br/>        System.out.println("Success Status: " + statusCode);<br/>if (statusCode &gt;= 200 &amp;&amp; statusCode &lt;= 299) {<br/>            Scanner sc = new Scanner(httpresponse.getEntity().getContent());<br/>            StringBuilder sb = new StringBuilder();<br/>            while (sc.hasNext()) {<br/>                sb.append(sc.next());<br/>            }<br/>            String jsonStrResult = sb.toString();<br/>            JSONObject responseObj = new JSONObject(jsonStrResult);<br/>            access_token = responseObj.getString("access_token");<br/>        }<br/>        httpclient.close();<br/>    }</span></pre><h2 id="89f9" class="no mx it bd my np nq dn nc nr ns dp ng kr nt nu ni kv nv nw nk kz nx ny nm nz bi translated">第2点——使用递归处理分页API</h2><p id="b8c9" class="pw-post-body-paragraph ki kj it kk b kl oa ju kn ko ob jx kq kr oc kt ku kv od kx ky kz oe lb lc ld im bi translated">由于一个邮政编码可以引用许多地址，这取决于感兴趣的地区/国家，API可以被分页—例如，如果有<strong class="kk iu"> 50个结果</strong>，但是每个页面只返回<strong class="kk iu"> 10个响应</strong>，那么有必要连续调用API来检索<strong class="kk iu">最后4页</strong>中的完整结果列表。</p><p id="054b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据API的分页格式，您可能需要相应地调整代码。</p><blockquote class="ot ou ov"><p id="2ed3" class="ki kj ow kk b kl km ju kn ko kp jx kq ox ks kt ku oy kw kx ky oz la lb lc ld im bi translated">然而，实现处理API分页的逻辑的一个简单方法是<code class="fe pa pb pc ok b">check if <strong class="kk iu">no. of returned addresses &lt;</strong> <strong class="kk iu">maximum no. of addresses per page</strong></code> <strong class="kk iu">。</strong></p></blockquote><p id="c74d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，在实用函数中包含将每个页面的结果连接成一个JSON数组也更简洁:</p><pre class="of og oh oi gt oj ok ol bn om on bi"><span id="8f0a" class="oo mx it ok b be op oq l or os">private static JSONArray concatArray(JSONArray arr1, JSONArray arr2) <br/>throws JSONException {<br/>    JSONArray result = new JSONArray();<br/>    for (int i = 0; i &lt; arr1.length(); i++) {<br/>        JSONObject obj = (JSONObject) arr1.get(i);<br/>        result.put(obj);<br/>    }<br/>    for (int i = 0; i &lt; arr2.length(); i++) {<br/>        JSONObject obj = (JSONObject) arr2.get(i);<br/>        result.put(obj);<br/>    }<br/>    return result;<br/>}</span></pre><p id="5c23" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是完整源代码实现的链接:<a class="ae mc" href="https://gist.githubusercontent.com/incubated-geek-cc/cb9add24621824c1a0f65196768144ee/raw/5c59da01d595ac46dffca8f61e19e918aa8e6bf7/StreamAPIResponseWithToken.java" rel="noopener ugc nofollow" target="_blank"> GitHub </a></p><h2 id="fa6a" class="no mx it bd my np nq dn nc nr ns dp ng kr nt nu ni kv nv nw nk kz nx ny nm nz bi translated">使用的JAR依赖项有:</h2><ul class=""><li id="9970" class="pd pe it kk b kl oa ko ob kr pf kv pg kz ph ld pi pj pk pl bi translated">commons-log-1.2 . jar</li><li id="faac" class="pd pe it kk b kl pm ko pn kr po kv pp kz pq ld pi pj pk pl bi translated">httpclient-4.5.2.jar</li><li id="a680" class="pd pe it kk b kl pm ko pn kr po kv pp kz pq ld pi pj pk pl bi translated">httpcore-4.4.12.jar</li><li id="9ea1" class="pd pe it kk b kl pm ko pn kr po kv pp kz pq ld pi pj pk pl bi translated">json-20140107.jar</li><li id="d861" class="pd pe it kk b kl pm ko pn kr po kv pp kz pq ld pi pj pk pl bi translated">sqlite-jdbc-3.27.2.1.jar(可选。仅适用于SQLite DB用户。)</li></ul><p id="52ba" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让它运行几天，根据国家/大洲邮政编码的格式，值的范围需要相应地调整<strong class="kk iu"> ( </strong>我使用的例子是新加坡，它使用<strong class="kk iu">一个6位数的格式</strong>，所以范围是<strong class="kk iu">10000–999999)</strong></p><p id="ff78" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一方面，代码中的字段名(如<strong class="kk iu">【BLK编号】、【建筑】、【道路名称】、【地址】、【邮政】、【纬度】、【经度】、【X】、【Y】、【搜索值】</strong>)应与地图服务提供商返回的每个地址的字段名相匹配。</p><figure class="of og oh oi gt ps gh gi paragraph-image"><div role="button" tabindex="0" class="pt pu di pv bf pw"><div class="gh gi pr"><img src="../Images/763816ee0d7c498aa73b871787984bfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6kAfCyYDt4By6DDNWHRYWg.png"/></div></div><p class="py pz gj gh gi qa qb bd b be z dk translated">作者截图|我的SQLite DB中存储的SG地址列表。请注意，OneMap.sg的数据由<a class="ae mc" href="https://www.onemap.gov.sg/legal/opendatalicence.html" rel="noopener ugc nofollow" target="_blank">开放数据许可证</a>管理。</p></figure></div><div class="ab cl qc qd hx qe" role="separator"><span class="qf bw bk qg qh qi"/><span class="qf bw bk qg qh qi"/><span class="qf bw bk qg qh"/></div><div class="im in io ip iq"><p id="05bf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">对读者的评论:</strong>虽然你的工作角色不一定是以地理空间为中心的，但拥有一份你所在国家的邮政编码列表不会有什么坏处<em class="ow">(除了需要一些存储空间)</em>事实上，在你最意想不到的时候，它会被证明是有用的！</p><p id="ec65" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">持怀疑态度？然后看看你能在日常生活中完成以下哪些任务:</strong></p><ul class=""><li id="fc78" class="pd pe it kk b kl km ko kp kr qj kv qk kz ql ld pi pj pk pl bi translated">寻找附近的医院进行医疗护理</li><li id="c4ee" class="pd pe it kk b kl pm ko pn kr po kv pp kz pq ld pi pj pk pl bi translated">确定离工作场所/居住区最近的公交车站/火车站在哪里</li><li id="af57" class="pd pe it kk b kl pm ko pn kr po kv pp kz pq ld pi pj pk pl bi translated">估计到达目的地的最短路线(考虑到你必须完成的任务和你需要中途停留的地方)</li></ul><blockquote class="ot ou ov"><p id="2d6d" class="ki kj ow kk b kl km ju kn ko kp jx kq ox ks kt ku oy kw kx ky oz la lb lc ld im bi translated">与从头开始搜索和盲目地搜索地址相比，从一系列地点中筛选出你要找的地点总是容易得多。</p></blockquote><h2 id="1d2a" class="no mx it bd my np nq dn nc nr ns dp ng kr nt nu ni kv nv nw nk kz nx ny nm nz bi translated">因此，尝试代码并享受其中的乐趣吧！</h2><h2 id="23d2" class="no mx it bd my np nq dn nc nr ns dp ng kr nt nu ni kv nv nw nk kz nx ny nm nz bi translated">非常感谢你坚持到这篇文章的结尾！❤希望有人会觉得这很有用，并欢迎使用Medium 跟随我。会非常感激😃</h2><div class="md me gp gr mf mg"><a href="https://geek-cc.medium.com/membership" rel="noopener follow" target="_blank"><div class="mh ab fo"><div class="mi ab mj cl cj mk"><h2 class="bd iu gy z fp ml fr fs mm fu fw is bi translated">通过我的推荐链接加入灵媒——李思欣·崔</h2><div class="mn l"><h3 class="bd b gy z fp ml fr fs mm fu fw dk translated">获得李思欣·崔和其他作家在媒体上的所有帖子！😃您的会员费直接…</h3></div><div class="mo l"><p class="bd b dl z fp ml fr fs mm fu fw dk translated">geek-cc.medium.com</p></div></div><div class="mp l"><div class="qm l mr ms mt mp mu mv mg"/></div></div></a></div></div></div>    
</body>
</html>