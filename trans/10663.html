<html>
<head>
<title>PostGIS, A Complete Workflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个完整的工作流程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/postgis-a-complete-workflow-729bb604f34c?source=collection_archive---------4-----------------------#2021-10-13">https://towardsdatascience.com/postgis-a-complete-workflow-729bb604f34c?source=collection_archive---------4-----------------------#2021-10-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bfb7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">用PostGIS分四步应对地理空间挑战</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e5630d3efeacdb3b6ae9a518f04d3133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gtaA6vB-0ijU9ZpD"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@huchenme?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">陈虎</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="7f35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您有世界各国和主要城市的单独shapefiles，则可以使用ArcGIS、QGIS或任何其他GIS软件包查看和查询数据。你可以在这里下载来自<a class="ae kv" href="https://drive.google.com/file/d/1HhyQ1b7wDoripkCfBrG7qSYKO3MMNO2g/view?usp=sharing" rel="noopener ugc nofollow" target="_blank">的数据</a>(用天然泥土制成)。</p><p id="d46f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，您可以执行以下操作:</p><ul class=""><li id="8c42" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">使用<em class="mb">识别</em>工具获取关于您点击的特征的一些信息</li><li id="2a95" class="ls lt iq ky b kz mc lc md lf me lj mf ln mg lr lx ly lz ma bi translated">确定或设置数据参考的空间参考系统</li><li id="e991" class="ls lt iq ky b kz mc lc md lf me lj mf ln mg lr lx ly lz ma bi translated">重新投影您的数据</li><li id="8eee" class="ls lt iq ky b kz mc lc md lf me lj mf ln mg lr lx ly lz ma bi translated">计算距离和面积</li><li id="7b2b" class="ls lt iq ky b kz mc lc md lf me lj mf ln mg lr lx ly lz ma bi translated">计算质心</li><li id="2c66" class="ls lt iq ky b kz mc lc md lf me lj mf ln mg lr lx ly lz ma bi translated">执行缓冲分析</li></ul><p id="476c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好消息是，你可以用PostGIS完成所有这些操作。对于在空间数据库上执行所有这些操作的必要性，可能会出现一个问题。当我们可以在开源或专有软件包中轻松解决问题时，在PostGIS中重新表述我们的问题有什么意义呢？</p><p id="ab69" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您想要开发web、移动或桌面应用程序时，PostGIS会派上用场。我们在这里使用的数据只包含有限数量的静态记录。在某些情况下，您可能会发现自己处于连续数据流的情况下。桌面GIS工具可能不适合消化此类数据并执行(近)实时分析。</p><p id="0991" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">处理地理空间问题时，您可以考虑以下四个重要步骤来正确回答问题:</p><ol class=""><li id="c1da" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr mh ly lz ma bi translated"><a class="ae kv" href="#48b9" rel="noopener ugc nofollow">造型</a></li><li id="654b" class="ls lt iq ky b kz mc lc md lf me lj mf ln mg lr mh ly lz ma bi translated"><a class="ae kv" href="#d67c" rel="noopener ugc nofollow">准备和加载数据</a></li><li id="77af" class="ls lt iq ky b kz mc lc md lf me lj mf ln mg lr mh ly lz ma bi translated"><a class="ae kv" href="https://medium.com/@fashouri/8dc2732bbde8#b37b" rel="noopener">编写一个查询来解决问题</a></li><li id="3dd1" class="ls lt iq ky b kz mc lc md lf me lj mf ln mg lr mh ly lz ma bi translated"><a class="ae kv" href="https://medium.com/@fashouri/8dc2732bbde8#cac4" rel="noopener">查看结果</a></li></ol><p id="9ae4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在图上为你描绘了这些步骤:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/f4f8153146431c73aad009ea7369cb1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vp62jjtvqUxUq0tKoY6yvA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图1-空间数据库的空间问题工作流(图片由作者提供)</p></figure><p id="436a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将经历所有这些步骤，并尝试应对之前提出的挑战。</p><h1 id="48b9" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">1.系统模型化</h1><p id="7bbd" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">建模是将现实世界转化为由数据库对象组成的模型的过程。换句话说，根据定义，模型是现实的简化表示。例如，将国家表示为面，将城市表示为点。然后，您将为每个对象创建一个表。您需要存储关于每条记录的一些信息。您可能无法保留关于它们的所有信息，因此您将选择那些有助于解决当前问题或以后可能出现的问题的信息。</p><p id="293d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一步，您需要创建一个数据库和一个模式来保存您的数据。模式是一个容器，它对对象(表、函数、视图等)进行逻辑分段，以便更好地管理。您在PostgreSQL中创建的数据库中有一个默认的公共模式，但我会创建一个新的。请记住，这取决于您希望在模型中简化真实世界的程度。建模本质上是简单性和充分性之间的权衡。尽管所有模型都有缺陷，但它们为我们提供了一种更具成本效益的方法。最好先创建一个数据库和一个模式:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="1e98" class="nl mk iq nh b gy nm nn l no np"> CREATE DATABASE postgis_training;<br/> CREATE SCHEMA postgis1;</span></pre><p id="4da8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">默认情况下，PostGIS功能和操作不起作用，您需要在数据库中启用PostGIS才能使其起作用:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="a775" class="nl mk iq nh b gy nm nn l no np">CREATE EXTENSION postgis;</span></pre><p id="a6c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们需要创建两个表来存放世界国家和城市数据:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="00b9" class="nl mk iq nh b gy nm nn l no np">CREATE TABLE postgis1.countries (<br/>  id serial,<br/>  formal_name VARCHAR(50) PRIMARY key,<br/>  country_iso3 CHAR(3),<br/>  population INT,<br/>  gdp INT,<br/>  economy VARCHAR(50),<br/>  income_group VARCHAR(50),<br/>  continent VARCHAR(50),<br/>  subregion VARCHAR(50),<br/>  region_world_bank VARCHAR(50),<br/>  geog geography(multipolygon, 4326)<br/>);</span><span id="0e59" class="nl mk iq nh b gy nq nn l no np">CREATE TABLE postgis1.cities (<br/>  id SERIAL PRIMARY KEY,<br/>  city_name VARCHAR(50),<br/>  country_iso3_code CHAR(3),<br/>  featurecla VARCHAR(50),<br/>  population INT,<br/>  geog GEOGRAPHY(POINT, 4326)<br/>);</span></pre><p id="b54e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">看看你已经<a class="ae kv" href="https://drive.google.com/file/d/1HhyQ1b7wDoripkCfBrG7qSYKO3MMNO2g/view?usp=sharing" rel="noopener ugc nofollow" target="_blank">下载了</a>的shapefiles。我们不需要他们提供的所有字段。我们选择适合我们问题的方法。我认为我们创建的表中的列名足够直观，除了其中的几个之外，不需要任何解释。这里的<em class="mb"> country_iso3 </em>和<em class="mb"> country_iso_code </em>列表示Alpha-3代码，是由<em class="mb">国际标准化组织(ISO) </em>出版的<em class="mb">ISO 3166–1</em>中定义的三个字母的国家代码。为了避免混淆，我特意选择了不同的名称。对于具有相同含义的列，可以使用相同的名称。</p><p id="28e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在图2中看到我们数据库的ERD表示。对于那些可能不熟悉<em class="mb"> spatial_ref_sys </em>表的人来说，它是每个启用了PostGIS的数据库中的一个表，列出了所有有效的SRID值及其对应的空间参考系统(SRS)的<em class="mb"> proj4text </em>表示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/8a5bfa908dcdd02f7c605b962fb97b33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yOdERw730CeDQFVIbJ_bgA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图2 —数据库的ERD表示(图片由作者提供)</p></figure><h1 id="d67c" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">2.准备和加载数据</h1><p id="59e8" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">让我们把你所有的形状文件直接导入我们的数据库。当我们直接从外部文件导入数据时，我们通常称之为临时表。临时表只是包含原始数据的临时表。它们用于填充我们已经设计好的模型中的主表。为了导入<em class="mb">ne _ 50m _ populated _ places . shp</em>shape file，我们使用PostGIS安装附带的命令行实用程序<em class="mb"> shp2pgsql </em>。在操作系统的命令行工具中导航到shapefiles文件夹，并运行以下命令:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="cefd" class="nl mk iq nh b gy nm nn l no np">shp2pgsql -s 4326 -I -G ne_50m_populated_places.shp postgis1.cities_staging &gt; staging_cities.sql</span></pre><p id="c8fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它会在同一个文件夹中创建一个名为<em class="mb"> staging_cities.sql </em>的文件。我们告诉我们想要创建的表的SRID是4326 ( <em class="mb"> -s 4326 </em>)。我们通过添加选项<em class="mb"> -I </em>在geocolumn上创建一个空间索引。我们添加了<em class="mb"> -G </em>选项，这意味着我们正在使用地理类型。您可以使用这个命令做更多的事情，但是我们决定在这里保持简单。下一步是运行创建的SQL文件，以生成<em class="mb">postgis 1 . cities _ staging</em>表。您可以使用内置的<em class="mb"> psql </em>命令行实用程序来实现:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="a0f1" class="nl mk iq nh b gy nm nn l no np">psql -h localhost -d postgis_training -U postgres -f staging_cities.sql</span></pre><p id="9341" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令对<em class="mb">ne _ 110m _ admin _ 0 _ countries . shp</em>表执行相同的操作:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="74a7" class="nl mk iq nh b gy nm nn l no np">shp2pgsql -s 4326 -I -G ne_110m_admin_0_countries.shp postgis1.countries_staging &gt; staging_countries.sql</span><span id="2dae" class="nl mk iq nh b gy nq nn l no np">psql -h localhost -d postgis_training -U postgres -f staging_countries.sql</span></pre><p id="e0bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">既然我们已经导入了shapefiles，现在是时候填充我们在模型中创建的表了。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="d148" class="nl mk iq nh b gy nm nn l no np">INSERT INTO postgis1.countries (<br/>  formal_name, country_iso3, population, gdp,<br/>  economy, income_group, continent, subregion,<br/>  region_world_bank, geog<br/>)<br/>SELECT<br/>  name_sort,<br/>  adm0_a3,<br/>  pop_est,<br/>  gdp_md_est,<br/>  economy,<br/>  income_grp,<br/>  continent,<br/>  subregion,<br/>  region_wb,<br/>  geog<br/>FROM <br/>  postgis1.countries_staging;</span><span id="497c" class="nl mk iq nh b gy nq nn l no np">INSERT INTO postgis1.cities (<br/>  city_name, country_iso3_code, featurecla,<br/>  population, geog<br/>)<br/>SELECT <br/>  NAME,<br/>  SOV_a3,<br/>  FEATURECLA,<br/>  POP_OTHER,<br/>  geog<br/>FROM <br/>  postgis1.cities_staging;</span></pre><p id="3480" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们只是从临时表中选择相应的列来填充我们的主表。</p><p id="63f7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已经讲述了如何对一个空间问题建模并使用真实世界的数据填充它。在本文的下一部分，我们将处理一些您可能会遇到的常见问题。</p><h1 id="b37b" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">3.编写一个查询来解决问题</h1><p id="675f" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">现在我们的模型和数据库已经准备好运行空间SQL查询来回答不同的问题。这里我们有一些问题需要回答，我们将逐一回答:</p><p id="1451" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">选择并创建所有欧洲国家的表格</strong></p><p id="ee54" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作为破冰者，我们希望返回欧洲国家。这里我们不使用任何空间函数:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="fd3b" class="nl mk iq nh b gy nm nn l no np">SELECT <br/>  * INTO postgis1.eu_countries<br/>FROM <br/>  postgis1.countries<br/>WHERE <br/>  continent = 'Europe'</span></pre><p id="2ea9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">选择所有居住在欧洲国家的城市</p><p id="a27d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们选择所有与欧洲国家相交的城市。因为我们需要这两个表，所以我们必须连接这两个表:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="61d9" class="nl mk iq nh b gy nm nn l no np">SELECT <br/>  postgis1.cities.* INTO postgis1.eu_cities<br/>FROM <br/>  postgis1.cities<br/>  INNER JOIN postgis1.eu_countries ON<br/>    ST_Intersects(<br/>      postgis1.cities.geog, postgis1.eu_countries.geog<br/>    );</span></pre><p id="6330" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">重新投影欧洲城市和国家表，并将其存储为单独的几何表</strong></p><p id="3d74" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果要将地理表重新投影到投影坐标参考系统中，可将地理列转换为几何列。那么geog列名可能会产生误导。首先，让我们将两个表中的geog列重命名为<em class="mb"> geom </em>:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="0cf5" class="nl mk iq nh b gy nm nn l no np">ALTER TABLE <br/>  postgis1.eu_cities RENAME COLUMN geog TO geom;</span><span id="2031" class="nl mk iq nh b gy nq nn l no np">ALTER TABLE <br/>  postgis1.eu_countries RENAME COLUMN geog TO geom;</span></pre><p id="7755" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，我们将列重命名为geom，但是它们仍然包含地理数据。我们不会让这种情况继续下去，而是将它转换为世界墨卡托(SRID 3395)，这是一个投影坐标参考系统:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="5177" class="nl mk iq nh b gy nm nn l no np">ALTER TABLE <br/>  postgis1.eu_cities ALTER COLUMN geom TYPE geometry(POINT, 3395)<br/>  USING ST_Transform(geom::geometry, 3395);</span><span id="d7f3" class="nl mk iq nh b gy nq nn l no np">ALTER TABLE <br/>  postgis1.eu_countries ALTER COLUMN geom TYPE<br/>  geometry(MULTIPOLYGON, 3395) USING ST_Transform(geom::geometry,<br/>  3395);</span></pre><p id="e116" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们已经将欧洲表完全转换为世界墨卡托和几何数据类型。许多PostGIS函数不支持地理类型。此外，许多空间计算在投影的CRS上固有地正确执行。对于其余的操作，我们考虑这两个表。</p><p id="6919" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">将新创建的表格导出为shape file</strong></p><p id="49c3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以使用另一个名为<em class="mb"> pgsql2shp </em>的命令行实用程序将空间表导出到shapefiles。在操作系统上可用的命令行工具中运行以下命令。确保在运行命令的同一个文件夹中创建一个名为<em class="mb"> shp </em>的文件夹:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="b6d9" class="nl mk iq nh b gy nm nn l no np">pgsql2shp -f ./shp/eu_cities_shp -h localhost -u postgres postgis_training postgis1.eu_cities</span><span id="9fd9" class="nl mk iq nh b gy nq nn l no np">pgsql2shp -f eu_countries_shp -h localhost -u postgres postgis_training postgis1.eu_countries</span></pre><p id="28a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些命令将在<em class="mb"> shp </em>文件夹中创建城市和国家的形状文件。</p><p id="2d95" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="mb"> pgsql2shp </em>命令的格式如下:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="0fc3" class="nl mk iq nh b gy nm nn l no np">pgsql2shp [options] database [schema.]table</span></pre><p id="cb83" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些选项看起来很直观，但我对它们进行了详细说明，以使一切变得清晰:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="8120" class="nl mk iq nh b gy nm nn l no np"><strong class="nh ir">-f</strong> use this option to specify the shapefile name and address you want to create</span><span id="2409" class="nl mk iq nh b gy nq nn l no np"><strong class="nh ir">-h</strong> use this option to specify the database host to connect to</span><span id="381a" class="nl mk iq nh b gy nq nn l no np"><strong class="nh ir">-u</strong> use this option to connect to the database as the specified user</span></pre><p id="7df9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可能需要考虑一些其他选项，但是指定的选项对于我们想要做的事情来说已经足够了。</p><p id="91f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">识别特定点所在的国家</strong></p><p id="478c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">考虑在大地坐标系(WGS84经度/纬度SRID 4326)中拥有坐标，其中经度= 32.6542，纬度= 50.9533。我们想知道这个点在哪个国家。我们要做的是堪比大多数GIS软件包中的<em class="mb">识别</em>工具。</p><p id="a828" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，我们的数据集不再使用SRID 4326。我们需要动态地将该点转换为世界墨卡托(SRID 3395):</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="4165" class="nl mk iq nh b gy nm nn l no np">WITH identify AS(<br/>  SELECT <br/>    ST_Transform(<br/>      ST_SetSRID(<br/>        ST_Point(32.6542, 50.9533),<br/>        4326<br/>      ),<br/>      3395<br/>    ) AS ipoint<br/>)</span><span id="905e" class="nl mk iq nh b gy nq nn l no np">SELECT <br/>  postgis1.eu_countries.*<br/>FROM<br/>  postgis1.eu_countries,<br/>  identify<br/>WHERE<br/>  ST_Within(ipoint, geom)</span></pre><p id="4c0b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们用CTE来定义和变换一个点。<em class="mb"> ST_Within(geometry A，geometry B) </em>如果几何图形A完全在几何图形B内，则返回TRUE。此函数将帮助我们找到要查找的国家。</p><p id="87e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">查找一个国家的面积</strong></p><p id="ab23" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">PostGIS有一个<em class="mb"> ST_Area </em>函数，用于确定多边形的面积。它以SRID指定的单位返回面积。同样，我们需要即时改造SRID:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="7b4a" class="nl mk iq nh b gy nm nn l no np">WITH identify AS(<br/>  SELECT <br/>    ST_Transform(<br/>      ST_SetSRID(<br/>        ST_Point(32.6542, 50.9533),<br/>        4326<br/>      ),<br/>      3395<br/>    ) AS ipoint<br/>)</span><span id="2b99" class="nl mk iq nh b gy nq nn l no np">SELECT <br/>  ST_Area(geom)<br/>FROM<br/>  postgis1.eu_countries,<br/>  identify<br/>WHERE<br/>  ST_Within(ipoint, geom)</span></pre><p id="34d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">识别CTE部分只是为了查找国家，后面是一段代码来确定地区。如果我们运行这个代码，它返回1394397442159.71，单位是平方米，相当于1394.39平方公里。如果你用谷歌搜索乌克兰的面积，你会得到一个完全不同的数字。乌克兰的面积为603.63平方公里。我们计算出的数字是实际数字的两倍多。这怎么能说得过去呢？</p><p id="8283" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">事实是，世界墨卡托(SRID 3395)并不保护该地区。从赤道向外，多边形的面积比实际数量增加得快得多。这就是为什么格陵兰在许多世界地图上看起来要大得多。为了获得精确的面积，我们需要使用等面积空间参考系统。为此，我选择了欧洲艾伯斯等面积圆锥曲线(SRID 102013)。它覆盖了整个欧洲，并希望保留多边形的面积。在我们的查询中，我们需要一个动态的乌克兰多边形转换:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="bb09" class="nl mk iq nh b gy nm nn l no np">WITH identify AS(<br/>  SELECT<br/>    ST_Transform(<br/>      ST_SetSRID(<br/>        ST_Point(32.6542, 50.9533),<br/>        4326<br/>      ),<br/>      3395<br/>    ) AS ipoint<br/>)<br/>SELECT<br/>  ST_Area(<br/>    ST_Transform(geom, 3035)<br/>  )<br/>FROM <br/>  postgis1.eu_countries,<br/>  identify<br/>WHERE <br/>  ST_Within(ipoint, geom)</span></pre><p id="2699" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果是601914411764.12平方米相当于601.91平方公里。与国家官方面积(603.63 km2)相当，略有差异极有可能是地图上多边形不准确所致。</p><p id="723b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，还有第二种选择。使用geography类型时，面积和距离测量(尤其是在大面积上)保证是准确的。而且考虑了地球的曲率。为了利用地理类型的优势，让我们看看我们原始模型中的<em class="mb">国家</em>表，看看我们是否能解决问题。然而，地理类型并不支持所有的空间功能，包括<em class="mb"> ST_Distance </em>。我们可以选择适合地理类型的<em class="mb"> ST_Covers </em>:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="1b95" class="nl mk iq nh b gy nm nn l no np">WITH identify AS(<br/>  SELECT<br/>    ST_SetSRID(<br/>      ST_Point(32.6542, 50.9533),<br/>      4326<br/>    ) AS ipoint<br/>)<br/>SELECT <br/>  ST_Area(geog)<br/>FROM <br/>  postgis1.countries,<br/>  identify<br/>WHERE <br/>  ST_Covers(geog, ipoint)</span></pre><p id="f722" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">找出柏林和伦敦之间的距离。</p><p id="c0f4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们从之前的挑战中了解到，对于大面积的测量，地理数据类型可能是一个合适的选项:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="8318" class="nl mk iq nh b gy nm nn l no np">SELECT <br/>  ST_Distance(a.geog, b.geog)<br/>From <br/>  postgis1.cities a,<br/>  postgis1.cities b<br/>WHERE <br/> a.city_name = 'Berlin'<br/> AND b.city_name = 'London'</span></pre><p id="91bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为你想在同一个表中找到两点之间的距离，你必须引用同一个表两次。<em class="mb"> ST_Distance </em>将利用椭球模型，对于许多应用来说，可以认为足够精确。该查询将返回933677.99m，这似乎是合理的。</p><h1 id="cac4" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">4.查看结果</h1><p id="44b4" class="pw-post-body-paragraph kw kx iq ky b kz nb jr lb lc nc ju le lf nd lh li lj ne ll lm ln nf lp lq lr ij bi translated">有时PostGIS没有GIS 就叫<em class="mb"> GIS。空间数据的可视化表示对于理解任何地理空间问题都至关重要。没有在地图上看到它，你将不能完全了解情况。然而，空间数据库并不是为可视化空间数据而设计的。但是，您可以找到一种方法来解决这个问题。一些GIS软件包可以直接连接到PostGIS以显示空间表和查询。我最喜欢的是QGIS。</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/eac4b8256f03bd0067ad36475d8fafa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*I6eWEvPBRpQKyn0BSokx2w.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图3-QGIS-PostGIS连接设置(图片由作者提供)</p></figure><p id="1f38" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击并选择<em class="mb">视图&gt;面板&gt;浏览器</em>。如果默认情况下没有打开<em class="mb">浏览器面板</em>，它会为您打开。在<em class="mb">浏览器面板</em>中，可以找到<em class="mb"> PostGIS </em>。右键点击并选择<em class="mb">新建连接</em>。在对话框中，像我一样填写选项(图3)并测试连接。如果添加的连接成功，您可以点击<em class="mb"> ok </em>按钮进行连接。</p><p id="6ace" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<em class="mb">浏览器面板</em>的<em class="mb"> PostGIS </em>分支下，会出现一个具有您所选择的名称的新连接(在我的例子中是:<em class="mb"> postgis_conn </em>)。您可以在<em class="mb"> postgis1 </em>数据库中找到您的模式和表(图4)。如果您双击任何表格，它将显示在地图画布上，并添加到图层面板。图层可以像shapefiles一样打开、关闭、导出和使用。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/27faf61d035326d14f964b9e2e8aefdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8qNnA0ANukIzzk4QxZth0g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图PostGIS和QGIS之间的连接(图片由作者提供)</p></figure><p id="d7cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们想在地图上显示查询的结果呢？为此，从主菜单中选择<em class="mb">数据库&gt;数据库管理器… </em>。在<em class="mb">数据库管理器中，</em>选择<em class="mb">数据库&gt; SQL窗口</em>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/b6905072a40055fef857af6c5091fa2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0QIiz_4YsS_cDwCweOU8tg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图5——如何将查询结果显示为图层(作者图片)</p></figure><p id="33c6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据图5，我们编写了一个简单的查询来返回亚洲国家，然后我点击<em class="mb"> execute </em>。然后我勾选了<em class="mb">加载为图层</em>复选框，填写了必要的字段，点击<em class="mb">加载。</em>令人惊讶的是，如果你再次检查图层面板，你可以在图层面板上找到一个具有你选择的名称的新图层(这里，图层名称是:<em class="mb"> Asian_Query </em>)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/3200c7d1bd29fb039b56c648bda4faed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*61ptk0oLHDUb-mCxVGgEMw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图6 —查询结果显示亚洲国家(图片由作者提供)</p></figure><p id="d29c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">借助简单的例子，我们考察了使用PostGIS解决空间问题的整个工作流程。PostGIS可以做更多的事情，但对于许多空间挑战，工作流程是相同的。</p></div></div>    
</body>
</html>