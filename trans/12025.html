<html>
<head>
<title>Why You Should Use Callbacks in TensorFlow 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么应该在TensorFlow 2中使用回调</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/why-you-should-use-callbacks-in-tensorflow-2-a634e2c54465?source=collection_archive---------16-----------------------#2021-12-03">https://towardsdatascience.com/why-you-should-use-callbacks-in-tensorflow-2-a634e2c54465?source=collection_archive---------16-----------------------#2021-12-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="751b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">定制你的深度神经网络训练-实用指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/08152570eb2f2e2304d1fe37351274f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mHtX4rNqyA88T1g2"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">约翰·施诺布里奇在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="3273" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当你想控制一个模型的训练时，回调是必不可少的。</p><p id="c7d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">而你<em class="lv">难道</em>想控制训练…</p><p id="a70a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">回调帮助我们防止过度拟合，可视化我们的训练进度，节省检查点等等。</p><h1 id="8ea2" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">张量流</h1><p id="41b9" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">但是为什么是TensorFlow呢？</p><p id="9954" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">TensorFlow是世界上很多公司首选的深度学习API。</p><p id="0ce4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由谷歌内部维护和大量使用，这是最先进的技术。</p><p id="aa9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这一成功的原因之一无疑是其生态系统中可用的大量工具和库，使公司和个人能够轻松访问其产品和系统的研究和技术。</p><p id="1a2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，它是一个<em class="lv"> Python库</em>会有所帮助，因为<em class="lv"> Python </em>是数据科学中最常用的编程语言。</p><p id="ee6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天我们来看看一个特别有用的工具。如果使用得当，它会让你的生活变得更加轻松。</p><h1 id="f5df" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">建立模型</h1><p id="8b84" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">回调是您可以在模型训练中使用的函数。</p><p id="ab4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果您希望基于高精度停止训练，或者当您的损失函数曲线开始变平时，可以使用它们。</p><p id="2799" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我不会过多关注实际的模型，而是看看我们如何通过回调来控制培训过程。</p><p id="a860" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我假设读者知道如何在TensorFlow中构建一个简单的模型，因此我不会详细介绍代码。</p><p id="d121" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过编写一个简单的CNN预测一些手写数字来热身。</p><p id="2714" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们导入一些库并加载数据。我们将在这里使用MNIST数据集。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="5519" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以上是非常标准的东西。我们加载(或多或少)原始数据，通过将所有像素值除以最大值255来对其进行整形和归一化。</p><p id="694f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，当您将NumPy数组除以一个数字时，您会将所有条目除以该数字。</p><p id="a904" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们对目标进行一次热编码，这基本上意味着将数字n转换成一个向量，除了第<em class="lv"> n </em>个条目外，其他地方都为零。</p><p id="1060" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来定义这个模型。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="9337" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我不会详细介绍卷积神经网络，但这是一个非常标准的网络，它使用成对的conv池层，中间有一些脱落层以避免过度拟合。</p><p id="af26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在生成特征之后，它们被分别输入到具有ReLu和Softmax激活的密集神经网络中。</p><p id="3d05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后的softmax层输出对应于一位热码编码目标的10个值。</p><p id="c36e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们希望添加一个回调，而不仅仅是按原样训练模型。</p><h1 id="03c4" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">复试</h1><p id="1d1b" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在TensorFlow中，回调有两种使用方式。我们可以使用现成的内置回调函数，也可以自己构建回调函数。</p><p id="03f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将通过一些例子向您展示如何做到这两点。</p><h2 id="a55b" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated">学习率计划程序</h2><p id="4be0" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">假设我们想在训练中对学习速度有更多的控制。</p><p id="b3bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们知道，在追求使用梯度达到损失函数的最小值时，当我们足够接近时，我们可能会采取太宽的跳跃。</p><p id="203a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以通过改变训练时的学习率来调整这些跳跃！</p><p id="14fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用<code class="fe nh ni nj nk b">tensorflow.keras.callbacks</code>中可用的LearningRateScheduler来实现。</p><p id="16b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看看下面的片段。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="7de2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，我们在3个时期后调整学习率。</p><p id="aaaa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，我们仍然不知道什么时候能达到可接受的精度。如果我们想在达到98%的准确率后停止训练呢？</p><h2 id="057a" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated">自定义回拨</h2><p id="6cbb" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">让我们为这个场景构建一个定制的回调类。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="befb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我已经将自定义回调添加到回调列表中，该列表现在包含两个回调。这完全没问题。</p><p id="9442" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这段代码的输出如下。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="f49f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">非常好！</p><p id="cc2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当使用自定义回调时，您可以指定在培训中您想要挖掘和更改的地方。</p><p id="afaf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以通过使用<code class="fe nh ni nj nk b">on_train_begin</code>、<code class="fe nh ni nj nk b">on_epoch_begin</code>、<code class="fe nh ni nj nk b">on_epoch_end</code>、<code class="fe nh ni nj nk b">on_train_end</code>等函数来实现。</p><h2 id="aaa4" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated">提前停止</h2><p id="955e" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">大多数情况下，我们没有特定的度量目标，而是希望避免过度拟合。</p><p id="75c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一种方法是使用内置的<em class="lv">提前停止</em>回调。你可以创建如下:<code class="fe nh ni nj nk b">early_stopping = tf.keras.callbacks.EarlyStopping(patience=1)</code>例如，这在一般情况下非常方便。</p><h2 id="d0ea" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated">模型检查点</h2><p id="5237" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">使用早期停止回调是好的，但是如果退出训练前的最后一个时期打乱了我们在最后通过过度适应努力获得的重量，那就糟了。</p><p id="70c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是模型检查点发挥作用的地方。基本上，这个回调让您为每个时期保存一个模型版本，这样您就可以选择具有最高验证准确性的版本。</p><p id="edb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">语法和其他的类似:<code class="fe nh ni nj nk b">tf.keras.callbacks.ModelCheckpoint</code>。您需要知道您想要将保存的模型放在哪里，您可以使用<em class="lv"> filepath </em>参数来指定。</p><p id="d010" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您可以这样做:</p><pre class="kj kk kl km gt nl nk nm nn aw no bi"><span id="367c" class="mv lx it nk b gy np nq l nr ns">checkpoint = tf.keras.callbacks.ModelCheckpoint(filepath='model.{epoch:02d}-{val_loss:.2f}.h5')</span></pre><p id="3291" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将它保存在当前文件夹中。更明智的选择可能是将其保存在一个名为<code class="fe nh ni nj nk b">checkpoints</code>的文件夹中。</p><h2 id="95ae" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated">张量板</h2><p id="59cf" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我要展示的最后一个回调是<em class="lv"> TensorBoard </em>。</p><p id="8998" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">TensorBoard用于可视化您的训练进度，这在实验情况下非常方便。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="abdd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你开始训练，然后从<em class="lv">终端</em>或<em class="lv"> cmd </em>将<em class="lv"> cd </em>你自己放入你的模型所在的文件夹，并输入:<code class="fe nh ni nj nk b">tensorboard --logdir='logs'</code>，那么终端会引导你进入<a class="ae ky" href="http://localhost:6006/#scalars" rel="noopener ugc nofollow" target="_blank"> http://localhost:6006/ </a>。</p><p id="d61c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在那里你会看到如下的训练进度。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/9f1fd42652aa64479336a6dc1095f071.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wGPSOzfc2Qe8YbzEmS2Wug.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h1 id="7109" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="f312" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">如果您在阅读过程中忘记了编码，我在这里为您收集了代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="588f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，我们并不真正使用训练的输出，而是将它存储在<em class="lv">历史</em>中。欢迎您编码并保存模型，绘制度量标准等等。</p><p id="4560" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">回调比我在这里介绍的多得多，但我们必须在某个时候停下来。但这并不意味着它们不重要。</p><p id="a917" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">他们是！请看这里的<a class="ae ky" href="https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="38e4" class="mv lx it bd ly mw mx dn mc my mz dp mg li na nb mi lm nc nd mk lq ne nf mm ng bi translated">总结</h2><p id="55ba" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">回调是一个强大的工具，用于定制和控制深度学习工具箱中的训练过程。</p><p id="5f7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从基于一些定制逻辑的调试和停止训练到可视化，<em class="lv">回调</em>应该是每个数据科学家在建模和实验时最好的朋友。</p></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><p id="0bf9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">喜欢在Medium上阅读像这样的文章？ <a class="ae ky" href="https://kaspermuller.medium.com/membership" rel="noopener"> <em class="lv">获得会员资格</em> </a> <em class="lv">获得完全权限。</em></p><p id="a0c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您有任何问题、意见或顾虑，请通过LinkedIn联系我:</p><div class="ob oc gp gr od oe"><a href="https://www.linkedin.com/in/kasper-m%C3%BCller-96ba95169/" rel="noopener  ugc nofollow" target="_blank"><div class="of ab fo"><div class="og ab oh cl cj oi"><h2 class="bd iu gy z fp oj fr fs ok fu fw is bi translated">Kasper Müller -高级顾问，数据和分析，金融服务，技术咨询- EY | LinkedIn</h2><div class="ol l"><h3 class="bd b gy z fp oj fr fs ok fu fw dk translated">编程、数学和教学是我最大的兴趣。数据科学、机器学习、编程…</h3></div><div class="om l"><p class="bd b dl z fp oj fr fs ok fu fw dk translated">www.linkedin.com</p></div></div><div class="on l"><div class="oo l op oq or on os ks oe"/></div></div></a></div></div></div>    
</body>
</html>