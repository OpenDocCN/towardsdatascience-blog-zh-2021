<html>
<head>
<title>Apply Propensity Score Methods in Causal Inference — Part 1: Stratification</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">倾向得分方法在因果推理中的应用——第一部分:分层</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apply-propensity-score-methods-in-causal-inference-part-1-stratification-afce2e85730c?source=collection_archive---------16-----------------------#2021-07-11">https://towardsdatascience.com/apply-propensity-score-methods-in-causal-inference-part-1-stratification-afce2e85730c?source=collection_archive---------16-----------------------#2021-07-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="67cb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用Python一步步实现了一个例子</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2806a019bdc5262e0c7e4e8fc6af584b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ffESrGTkAoz4f6JNwalksg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">蒂姆·斯蒂夫在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="7b53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文介绍并实现了Dehejia和Wahba (1999)“非实验性研究中的因果效应:重新评估培训计划的评估”，<em class="lv">美国统计协会杂志</em>，第94卷，№448(1999年12月)，第1053–1062页。我将简要回顾一下这些理论，然后一步一步地介绍我是如何实现分层匹配的。文章末尾提供了完整的Python代码。</p><h1 id="e6bc" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">直觉</h1><p id="5745" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">倾向得分方法的直觉是:我们尝试以X <em class="lv"> ᵢ.估计的倾向得分为条件，而不是以协变量X <em class="lv"> ᵢ </em>的完整向量为条件，这在有许多治疗前变量且治疗组和对照组非常不同时会变得困难</em></p><p id="8e9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您需要回顾协变量匹配，我之前的文章介绍了条件独立假设(CIA)下的协变量精确匹配:</p><div class="mt mu gp gr mv mw"><a rel="noopener follow" target="_blank" href="/apply-matching-method-in-causal-analysis-19e032144e93"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">匹配法在因果分析中的应用</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">用Python写了一个真实的例子</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">towardsdatascience.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk ks mw"/></div></div></a></div><h1 id="94eb" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">倾向得分定理</h1><p id="491f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">将倾向得分p(X <em class="lv"> ᵢ】定义为</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/69606325c0f2eb13a27c3681746dbe60.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/format:webp/1*CBQRNgy2M8hfQiWTl-dUeg.png"/></div></figure><p id="adbf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有如下:假设中央情报局认为</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/de4905d677afd51a02af2203ad59ddc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:366/format:webp/0*2D1NAxMk27NI8E3c.png"/></div></div></figure><p id="39c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么这个成立:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/0f1dbdb356a4982857f1352aaf068b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:428/format:webp/1*-0MzKZrspVzCOja0_uckxg.png"/></div></figure><p id="e90b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">倾向得分匹配与协变量匹配的工作方式相同，只是我们根据得分而不是直接根据协变量进行匹配。</strong>由倾向得分定理可知:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/8e501277a846bb0eb32fa2651352228a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*orw9nE2dFiZrPHTQeE3hvw.png"/></div></div></figure><h1 id="a359" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">应用</h1><p id="44c7" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated"><strong class="lb iu">在实践中，估算通常分两步完成。首先，我们估计倾向得分。第二，我们通过使用一种匹配方法来估计治疗的效果。</strong></p><p id="33b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Dehejia和Wahba (1999年)使用的数据来自国家支持的工作(NSW)项目，该项目旨在为长期存在“就业问题”的人提供过渡性补贴工作经验方案。合格的申请人被随机分配接受培训(治疗组)或不接受培训(对照组)。评估的目的是估计培训对收入的影响。</p><p id="6553" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下步骤中所示的分析组织如下:<strong class="lb iu">首先，由于该项目是作为RCT进行的，因此原始数据(NSW)是实验数据，用于估计作为基准的处理效果。接下来，我们使用额外的政府调查数据(CPS和PSID)来模拟观察数据。然后，我们估计和应用倾向得分和分层方法来估计提供培训对收入的影响使用观察数据。</strong></p><h2 id="2be1" class="np lx it bd ly nq nr dn mc ns nt dp mg li nu nv mi lm nw nx mk lq ny nz mm oa bi translated">1.实验基准</h2><p id="8bad" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">如果随机化处理得当，我们预计对照组和治疗组之间的预处理特征应该没有系统性差异。否则，我们可能会怀疑它们在未观察到的特征上也有所不同，这可能会导致对治疗的因果效应的有偏见的估计。</p><p id="f8f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，检查两组之间的预处理变量是否平衡总是一个好主意。为了测试治疗前变量的协变量平衡(re78是实现的结果变量，所有其他变量在分配到治疗组或对照组之前是预先确定的)，我运行了8个单独的简单线性回归，并将结果报告在表1中。它表明对照组和治疗组的样本平均值没有差异。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/a2564e24f20b74b8a5d8d19790781d90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vqk5LfwbrIysLVahaovfCA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表1:使用实验数据测试对照组和治疗组之间的协变量平衡</p></figure><p id="bb83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我使用实验数据来估计平均治疗效果(ate ),作为提供在职培训对培训后收入(re87)的因果影响。<strong class="lb iu">控制协变量后，我得到了1676美元的效果。我会以此为基准牢记在心。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/944878bc27e927ab32404a5cf5129f0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*ips_DaA7GuIM6aWu1LMzTg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表2:使用实验数据估计的ATE(平均治疗效果)</p></figure><h2 id="62f2" class="np lx it bd ly nq nr dn mc ns nt dp mg li nu nv mi lm nw nx mk lq ny nz mm oa bi translated">2.观测资料</h2><p id="e1bd" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Dehejia和Wahba (1999)使用两个调查数据样本(CPS和PSID调查)作为与新南威尔士州治疗组的对照组，以构建观察数据库(CPS代表当前人口调查，PSID代表收入动态的小组研究)。</p><p id="a9e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，我比较了新南威尔士州的样本均值(实验数据)和增加的比较样本(CPS和PSID)。在表3中，很明显，新南威尔士州治疗组与CPS/PSID组在人口统计学特征以及治疗前收入(re74和re75)方面有很大不同。新南威尔士州的治疗组更年轻，受教育程度更低，更有可能是非白人，并且在项目开始前收入更低。直接比较新南威尔士州治疗组和对照组是没有意义的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/c5a56ebf0bb963dd6000f46ffb59c15e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5ko766kahhXMjPhV85eocQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表3:新南威尔士州(实验)和对比样本的样本均值比较</p></figure><h2 id="5c79" class="np lx it bd ly nq nr dn mc ns nt dp mg li nu nv mi lm nw nx mk lq ny nz mm oa bi translated">3.倾向得分估计</h2><p id="485e" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated"><em class="lv">从这一步开始，我用PSID作为对照组，用新南威尔士州处理的构建观察数据库。</em></p><p id="c94b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我使用逻辑回归模型来估计倾向得分。具体来说，我研究了两个规格回归两组不同的协变量(在第二组中，我添加了年龄和教育年限的平方):</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="09ab" class="np lx it of b gy oj ok l ol om">X1 = [‘age’, ‘ed’, ‘black’, ‘hisp’, ‘married’, ‘nodeg’, ‘re74’,’re75']</span><span id="71fc" class="np lx it of b gy on ok l ol om">X2 = [‘age’, ‘ed’, ‘black’, ‘hisp’, ‘married’, ‘nodeg’, ‘re74’,’re75',’age2',’ed2']</span></pre><p id="aff8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我使用交叉验证来调整参数C，这是正则化的强度。C值越高，意味着正则化程度越低。</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="fe30" class="np lx it of b gy oj ok l ol om">best = 0.0<br/>for strength in [0.00001,0.0001,0.001,0.01,0.1, 1, 10, 100, 1000, 10000, 100000, 1000000] :<br/> model = LogisticRegression(C=strength, max_iter=10000)<br/> curScore = cross_val_score(model,df_combine[X1], df_combine[T],scoring=’f1').mean()<br/> if curScore &gt; best :<br/> best = curScore<br/> print(strength)<br/> print (curScore)</span></pre><p id="a110" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我运行具有最佳C值的逻辑回归模型，并将估计的倾向得分添加回观察集。下面，我绘制了比较组和治疗组的估计p值。不足为奇的是，这两个群体之间没有太多的重叠。治疗组(n=185)的平均p值为0.62，而对照组(n=2490)的平均p值为0.03。事实上，正如Dehejia和Wahba (1999)所指出的，倾向得分法的优势之一是它戏剧性地强调了一个事实，即大多数比较单位与处理单位非常不同。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/a2d4b5690577f7b7f03e96f122aab1f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/1*_jwR9sThBNoFatyNGBlpDg.png"/></div></figure><h2 id="2c71" class="np lx it bd ly nq nr dn mc ns nt dp mg li nu nv mi lm nw nx mk lq ny nz mm oa bi translated">4.整理</h2><p id="f61f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">治疗组和对照组之间的巨大差异自然导致了修整和匹配的步骤，在我的Python代码中，这些步骤是在同一个函数<em class="lv">分层_函数</em>中完成的。微调的目的是找到共同的支持，使治疗组或对照组的p值都不会超出支持范围。调整后，我们从PSID对照组中剔除了大约1300个超出共同支持范围的观察结果，其中大部分的估计倾向得分低于治疗单位的最小估计倾向得分。调整的原因是为了防止当我们进入分层/匹配阶段时，我们最终得到处理过的单元而没有匹配的控制单元，反之亦然。</p><h2 id="9137" class="np lx it bd ly nq nr dn mc ns nt dp mg li nu nv mi lm nw nx mk lq ny nz mm oa bi translated">5.分层匹配</h2><p id="5781" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">分层的基本思想是根据估计的倾向分数来定义层，然后将治疗和比较单位分组到每个层中。在每一层中，我们取治疗组和对照组之间的结果的平均值的差异，然后我们通过每一层中治疗单位的数量来计算跨层的加权平均值。治疗组和对照组的最终加权平均差异(ATT)计算如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi op"><img src="../Images/64f407ff52b99a67355e06dd8ad23942.png" data-original-src="https://miro.medium.com/v2/resize:fit:662/format:webp/1*FzwGTQD8tBoRtZF2JzbwpA.png"/></div></figure><p id="be8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的代码中，这是在函数<em class="lv">的分层_函数中完成的。</em>我还测试了两种定义阶层的方法:</p><pre class="kj kk kl km gt oe of og oh aw oi bi"><span id="1f1b" class="np lx it of b gy oj ok l ol om">blocks1 = np.array_split(df_ps.query(“treat==1”)[“pscore”].sort_values(), nostrata)</span><span id="8baa" class="np lx it of b gy on ok l ol om">blocks2 = np.linspace(0,1,11)</span></pre><p id="c134" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设我们需要10层。第一种方式将处理单元的估计倾向分数分成10个相同大小的块，然后将比较单元与每个块范围内的估计倾向分数进行匹配。第二种方法简单地把1分成10个等间距的区间。</p><p id="1a54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">记得在第三步倾向得分估计中，我测试了两个逻辑回归模型。将两个逻辑回归模型与两个strata定义相结合，我在输出端有四个模型，我将其命名为:M11 (reg1，strata1)、M12(reg1，strata2)、M21(reg2，strata1)和M22(reg2，strata2)。结果如表4所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/bbbf1720ea0b950071ef465d4532340d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*n9VWUVwoHDkl6bFWbOsqkg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表4:不同模型选项的加权平均差异</p></figure><p id="f824" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这四个选项中，最终模型的选择应基于每个阶层内的协变量在处理单元和比较单元之间的平衡程度。所以我觉得<strong class="lb iu"> Model21 </strong>最好。<strong class="lb iu"> Model21估计效果= 1632美元(含标准差。误差=1，514)，这非常接近我们的实验基准效果= 1，676美元。</strong></p><p id="eecb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">最后，正如我所承诺的，下面是我的第1步到第5步的完整Python代码，它也输出了汇总表1-4:</strong></p><p id="8553" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">我从NYU的</em> <a class="ae ky" href="https://users.nber.org/~rdehejia/nswdata.html" rel="noopener ugc nofollow" target="_blank"> <em class="lv">网站</em> </a>下载了所有数据</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="or os l"/></div></figure></div></div>    
</body>
</html>