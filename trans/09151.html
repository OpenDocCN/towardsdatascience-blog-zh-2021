<html>
<head>
<title>Getting started with Task Groups in Airflow 2.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开始使用Airflow 2.0中的任务组</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/getting-started-with-task-groups-in-airflow-2-0-d85b7517767e?source=collection_archive---------9-----------------------#2021-08-24">https://towardsdatascience.com/getting-started-with-task-groups-in-airflow-2-0-d85b7517767e?source=collection_archive---------9-----------------------#2021-08-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="403a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个包含两组任务的简单管道，使用来自Airflow 2的TaskFlow API的@taskgroup decorator。</h2></div><h1 id="a385" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">介绍</h1><p id="9b6f" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在Airflow 2.0中的任务分组之前，子标记是分组任务的首选API。在Airflow 2.0中，子标签<a class="ae lt" href="https://www.astronomer.io/guides/subdags" rel="noopener ugc nofollow" target="_blank">被降级</a>，现在被任务组功能取代。任务流API很简单，允许适当的代码结构，有利于清晰地分离关注点。</p><p id="2027" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">我们今天构建的是一个包含两组任务的简单DAG，使用了来自气流2的任务流API的<code class="fe lz ma mb mc b">@taskgroup</code>装饰器。图表视图为:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/95059af8bc95f70f69d6f110b5b2902b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZTkxAoPzrveKsHlc"/></div></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">作者图片</p></figure><p id="5956" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">这条管道对给定的初始值进行不同的操作。任务实例化了一个值为<code class="fe lz ma mb mc b">0</code>的变量。然后，它传递给一组子任务(<code class="fe lz ma mb mc b">group_1</code>)，这些子任务处理初始值。<code class="fe lz ma mb mc b">group_2</code>将所有的值聚合成一个。最后，<code class="fe lz ma mb mc b">end()</code>子任务将打印出最终结果。</p><p id="dcdf" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">让我们从将管道分成几个部分开始。</p><h1 id="365d" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">任务分组-分解</h1><p id="565e" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如上图所示，有一个<code class="fe lz ma mb mc b">init()</code>和<code class="fe lz ma mb mc b">end()</code>任务。在这两者之间，有两组任务，但是让我们从管道的第一个和最后一个任务开始。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/38c45454c327c2a34e478ab0fcdf306d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8Tw2cC6wlHddy7rN"/></div></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">作者图片</p></figure><p id="6714" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated"><code class="fe lz ma mb mc b">init()</code>任务是这个管道的起点——它返回将在整个管道中操作的初始值:0。任务将把管道中的所有操作打印到控制台。</p><p id="c9f5" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">让我们看看<code class="fe lz ma mb mc b">init()</code>任务的代码:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="36d8" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">就是这样。现在是<code class="fe lz ma mb mc b">end()</code>任务的代码:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="0c7c" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">定义整个管道的流程也很简单，由包装所有内容的函数返回:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="d70d" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">查看上面的代码，可以看到:</p><h1 id="3da4" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">任务组#1 ( <code class="fe lz ma mb mc b">group_1</code>)</h1><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mv"><img src="../Images/bd25103f50044fb8f4840116b2770fcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UR9ZhD7A8yXntwQH"/></div></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">作者图片</p></figure><p id="7789" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated"><code class="fe lz ma mb mc b">group_1</code>有一组操纵原始数字的三个任务:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="41eb" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated"><code class="fe lz ma mb mc b">group_1</code>函数接收来自<code class="fe lz ma mb mc b">init()</code>任务的结果。注意这里返回的是什么:三个值的列表。每个值都源于<code class="fe lz ma mb mc b">subtask_1</code>、<code class="fe lz ma mb mc b">subtask_2</code>和<code class="fe lz ma mb mc b">subtask_3</code>。这个值列表就是将要发送给<code class="fe lz ma mb mc b">group_2</code>的内容。</p><h1 id="612d" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">任务组#2 ( <code class="fe lz ma mb mc b">group_2</code>)</h1><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mv"><img src="../Images/8bdf7cf45cb2c5ffbe841f138952295b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kOxA9CCKZcwzD3od"/></div></div><p class="mp mq gj gh gi mr ms bd b be z dk translated">作者图片</p></figure><p id="2de0" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">很简单。它接收从<code class="fe lz ma mb mc b">group_1</code>发送来的列表，并对所有值求和(<code class="fe lz ma mb mc b">subtask_4</code>完成)，然后<code class="fe lz ma mb mc b">subtask_5</code>将来自<code class="fe lz ma mb mc b">subtask_4</code>的结果乘以2:</p><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="a1fb" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">就是这样——下一个任务是<code class="fe lz ma mb mc b">end()</code>，在本帖之前已经处理过了。同样，这里有可能看到完整的代码<a class="ae lt" href="https://github.com/pmadruga/airflow-dags/blob/main/taskgroup.py" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="81c8" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">如果您检查“end()”任务的日志(参见我以前的帖子，了解如何检查任务日志)，您将看到打印的结果。最后的结果应该是<code class="fe lz ma mb mc b">12</code>。</p><p id="5136" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">成功！🎉</p><h1 id="cecb" class="kf kg iq bd kh ki kj kk kl km kn ko kp jw kq jx kr jz ks ka kt kc ku kd kv kw bi translated">结论</h1><p id="e731" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在Airflow 2中创建任务组很容易——它消除了以前存在的复杂性，并允许用干净的代码创建管道。</p></div><div class="ab cl mw mx hu my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ij ik il im in"><h1 id="3dac" class="kf kg iq bd kh ki nd kk kl km ne ko kp jw nf jx kr jz ng ka kt kc nh kd kv kw bi translated">背景</h1><p id="f3ac" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这篇文章是ETL系列教程的一部分。这最初发布在<a class="ae lt" href="https://pedromadruga.com" rel="noopener ugc nofollow" target="_blank">pedromadruga.com</a>上。如果你喜欢这篇文章，可以考虑订阅<a class="ae lt" href="http://localhost:1313/newsletter" rel="noopener ugc nofollow" target="_blank">时事通讯</a>或者在<a class="ae lt" href="https://twitter.com/pmadruga_" rel="noopener ugc nofollow" target="_blank">推特</a>上关注我。</p><p id="25b6" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated">完整的代码可在<a class="ae lt" href="https://github.com/pmadruga/airflow-dags/blob/main/taskgroup.py" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><p id="d193" class="pw-post-body-paragraph kx ky iq kz b la lu jr lc ld lv ju lf lg lw li lj lk lx lm ln lo ly lq lr ls ij bi translated"><em class="ni">原载于</em>【https://pedromadruga.com】<em class="ni"/><em class="ni">。如果你喜欢这篇文章，可以考虑订阅<a class="ae lt" href="http://localhost:1313/newsletter" rel="noopener ugc nofollow" target="_blank">时事通讯</a>或者在<a class="ae lt" href="https://twitter.com/pmadruga_" rel="noopener ugc nofollow" target="_blank">推特</a>上关注我。</em></p></div></div>    
</body>
</html>