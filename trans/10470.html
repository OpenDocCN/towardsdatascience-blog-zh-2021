<html>
<head>
<title>Window Functions in SQL: Aggregating Values</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL中的窗口函数:聚集值</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/window-functions-in-sql-aggregating-values-278f2bdb545?source=collection_archive---------31-----------------------#2021-10-05">https://towardsdatascience.com/window-functions-in-sql-aggregating-values-278f2bdb545?source=collection_archive---------31-----------------------#2021-10-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d897" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用窗口函数计算累计</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/57e7bdf25b5572ba5c21f6e0f82fa980.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IO41n1cTayv5DEJLsPsFQQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:照片由<a class="ae ky" href="https://pixabay.com/users/christopherpluta-108394/" rel="noopener ugc nofollow" target="_blank"> ChristopherPluta </a>从<a class="ae ky" href="https://pixabay.com/photos/surface-rain-drops-raindrops-455120/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>拍摄</p></figure><p id="66ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在SQL中使用表时，通常会希望聚合值，或者计算表中值的累计。</p><p id="d048" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将研究如何使用所谓的<strong class="lb iu">窗口函数</strong>来实现这一点。</p><p id="91ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们还将看到如何将<strong class="lb iu"> CASE </strong>语句嵌套在窗口函数中，以进一步定制基于特定条件对数组执行的计算。</p><h1 id="96f3" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用窗口函数求和平均</h1><p id="ee0d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">考虑以下假设的某一天商店中列出的服装项目表(由作者虚构的值)。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="df31" class="mx lw it mt b gy my mz l na nb">date            | item               | price   | size <br/>----------------+--------------------+---------+--------<br/>2021-01-01      | Sky Blue Jeans     |  79.99  | 31<br/>2021-01-02      | Fire Red Jeans     |  89.99  | 36<br/>2021-01-03      | Sky Blue Shirt     |  59.99  | 38<br/>2021-01-04      | Grass Green Shirt  |  69.99  | 34<br/>2021-01-05      | Peach Purple Hat   |  79.99  | 40<br/>2021-01-06      | Sun Yellow Jeans   |  109.99 | 42<br/>2021-01-07      | Olive Green Hat    |  89.99  | 37</span></pre><p id="a782" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，假设所有者希望在累积的基础上对每个值求和并求平均值，即创建一个新数组，显示前两个值的总和，然后是前三个值，依此类推。这同样适用于计算平均值。</p><p id="7e76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以使用窗口函数对这些值求和，如下所示(显示了前五行):</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="3170" class="mx lw it mt b gy my mz l na nb">&gt;&gt;&gt; SELECT date,price,<br/>&gt;&gt;&gt;   SUM(price) OVER (ORDER BY date)<br/>&gt;&gt;&gt;   AS total_price<br/>&gt;&gt;&gt; FROM table;</span><span id="d221" class="mx lw it mt b gy nc mz l na nb">date                 | price   | total_price <br/>---------------------+---------+------------<br/> 2021-01-01          |  79.99  |      79.99<br/> 2021-01-02          |  89.99  |     169.98<br/> 2021-01-03          |  59.99  |     229.97<br/> 2021-01-04          |  69.99  |     299.96<br/> 2020-01-05          |  79.99  |     379.95<br/>(5 rows)</span></pre><p id="e216" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同理，也可以计算出平均累计价格。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="ab52" class="mx lw it mt b gy my mz l na nb">&gt;&gt;&gt; SELECT date,price,<br/>&gt;&gt;&gt;   AVG(price) OVER (ORDER BY date)<br/>&gt;&gt;&gt;   AS mean_price<br/>&gt;&gt;&gt; FROM table;</span><span id="0df7" class="mx lw it mt b gy nc mz l na nb">date                 | price   | mean_price <br/>---------------------+---------+------------<br/> 2021-01-01          |  79.99  |      79.99<br/> 2021-01-02          |  89.99  |      84.99<br/> 2021-01-03          |  59.99  |      76.66<br/> 2021-01-04          |  69.99  |      74.99<br/> 2020-01-05          |  79.99  |      75.99<br/>(5 rows)</span></pre><h1 id="e681" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">将CASE语句与窗口函数相结合</h1><p id="b97a" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">CASE语句的功能类似于if-then语句。如果满足条件，则返回一个特定值，否则，如果不满足条件，则返回另一个值。</p><p id="7f4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们考虑这个例子。假设对于这个特定的服装店，商家必须为某些商品提供退款。这如何反映在累计总数中？</p><p id="2814" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">考虑这个扩展的表。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="bd52" class="mx lw it mt b gy my mz l na nb">date            | item               | price   | size   | refund<br/>----------------+--------------------+---------+--------+---------<br/>2021-01-01      | Sky Blue Jeans     |  79.99  | 31     | no<br/>2021-01-02      | Fire Red Jeans     |  89.99  | 36     | no    <br/>2021-01-03      | Sky Blue Shirt     |  59.99  | 38     | no<br/>2021-01-04      | Grass Green Shirt  |  69.99  | 34     | yes<br/>2021-01-05      | Peach Purple Hat   |  79.99  | 40     | yes<br/>2021-01-06      | Sun Yellow Jeans   |  109.99 | 42     | no<br/>2021-01-07      | Olive Green Hat    |  89.99  | 37     | no</span></pre><p id="8d95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从上面我们可以看到，在这种情况下，商家在1月4日和5日提供退款。为了计算新的累积和，这些值需要从<strong class="lb iu">中减去</strong>——而不是加到总数中。</p><p id="2844" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这方面，CASE语句嵌套在window函数中——如果<strong class="lb iu">退款</strong>变量包含<em class="nd">是</em>值，则使用一条指令使价格值为负。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="1e61" class="mx lw it mt b gy my mz l na nb">&gt;&gt;&gt; SELECT date,price,refund,SUM(CASE WHEN refund = 'yes' THEN -1*price ELSE price END) OVER (ORDER BY date) AS total_price FROM table;</span><span id="fb29" class="mx lw it mt b gy nc mz l na nb">date                 | price   | total_price  | refund<br/>---------------------+---------+--------------+------------<br/> 2021-01-01          |  79.99  |      79.99   | no<br/> 2021-01-02          |  89.99  |     169.98   | no<br/> 2021-01-03          |  59.99  |     229.97   | no<br/> 2021-01-04          |  69.99  |     159.98   | yes<br/> 2020-01-05          |  79.99  |     79.99    | yes<br/> 2020-01-06          |  79.99  |     189.98   | no<br/> 2020-01-07          |  79.99  |     279.97   | no</span><span id="0bb8" class="mx lw it mt b gy nc mz l na nb">(5 rows)</span></pre><p id="1304" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所看到的，一旦在1月4日和5日减去69.99和79.99的价格，就会计算出279.97的总价格，这是由CASE语句执行的，因为退款变量的<em class="nd"> yes </em>条目会导致CASE语句指定一个负价格。</p><h1 id="2ddc" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="fd21" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在本文中，您已经看到:</p><ul class=""><li id="d77d" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated">使用窗口功能的目的</li><li id="0345" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">如何使用窗口函数获得累积值</li><li id="4566" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">将窗口函数与CASE语句结合起来，使窗口函数更加灵活</li></ul><p id="3361" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">非常感谢阅读，任何问题或反馈都非常感谢！您还可以在这里找到原始文章<a class="ae ky" href="https://www.michael-grogan.com/articles/window-functions-postgresql" rel="noopener ugc nofollow" target="_blank">以及有用的SQL实践的更多示例。</a></p><h1 id="50de" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">参考</h1><ul class=""><li id="5b44" class="ne nf it lb b lc mn lf mo li ns lm nt lq nu lu nj nk nl nm bi translated"><a class="ae ky" href="https://learnsql.com/blog/what-is-a-running-total-and-how-to-compute-it-in-sql/" rel="noopener ugc nofollow" target="_blank"> learnsql.com:什么是sql运行总数，如何计算？</a></li><li id="8c13" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><a class="ae ky" href="https://stackoverflow.com/questions/69452575/how-to-add-column-with-accumulations-of-certain-values-from-another-column-in-sq" rel="noopener ugc nofollow" target="_blank">堆栈溢出:如何在SQL中添加包含另一列中某些值的累积的列？</a></li><li id="ef12" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><a class="ae ky" href="https://www.w3schools.com/sql/sql_case.asp" rel="noopener ugc nofollow" target="_blank"> w3schools.com: SQL Case语句</a></li></ul><p id="4692" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nd">免责声明:本文是在“原样”的基础上编写的，没有任何担保。它旨在提供数据科学概念的概述，不应被解释为专业建议。本文中的发现和解释是作者的发现和解释，不被本文中提到的任何第三方认可或隶属于任何第三方。作者与本文提及的任何第三方无任何关系。</em></p></div></div>    
</body>
</html>