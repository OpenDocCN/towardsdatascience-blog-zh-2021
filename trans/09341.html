<html>
<head>
<title>SQL— inserting only unique values in a UNIQUE table</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL仅在唯一表中插入唯一值</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sql-inserting-only-unique-values-in-a-unique-table-af2eb3b9890a?source=collection_archive---------15-----------------------#2021-08-30">https://towardsdatascience.com/sql-inserting-only-unique-values-in-a-unique-table-af2eb3b9890a?source=collection_archive---------15-----------------------#2021-08-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b891" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如果表格中不存在值，则将其插入表格中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fbd30699d88db0341a7aba4715e6f1c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G_YWukzNviItaOFg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们只想要我们的表中的唯一值(图片由<a class="ae ky" href="https://unsplash.com/@dariuscotoi" rel="noopener ugc nofollow" target="_blank"> Darius Cotoi </a>在<a class="ae ky" href="https://unsplash.com/photos/d8cKjamtQH4" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供)</p></figure><p id="00ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">想象我们是一家卖各种菜的餐厅。因为我们很聪明，我们在数据库中记录所有的成分。<code class="fe lv lw lx ly b">ingredients</code>表将只包含唯一的成分，每个成分都有自己的id。</p><p id="25bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文的目标是创建一个查询，将表中没有的独特成分插入到表中。其他表可以引用ingredient_id，这样我们就可以过滤和连接整数，这在大型数据集中要快得多。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="7dc4" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">1.创建表</h1><p id="ea5a" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">首先，我们将创建包含配料的表。本文使用Postgres，但同样的技术适用于所有关系数据库。成分表:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建配料表</p></figure><p id="9877" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们有两列:</p><ul class=""><li id="ce23" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">身份证。因为这个id是一个串行主键，所以它会在插入时自动递增。我们不必将这个id传递给表，表会为我们创建它</li><li id="390e" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">成分。成分名称。此列有一个<code class="fe lv lw lx ly b">unique</code>约束；这意味着它只能包含唯一的值。</li></ul></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="39d2" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">2插入配料</h1><p id="e073" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">下一步是编写一些代码，只将新的配料插入配料表:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">让我们把意大利面的所有配料都放进桌子里</p></figure><p id="70d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们浏览一下这段代码:</p><ol class=""><li id="246c" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nt nl nm nn bi translated">首先我们定义想要输入的数据，这发生在<code class="fe lv lw lx ly b">WITH </code>子句中。可以把它想象成一个名为<code class="fe lv lw lx ly b">inputvalues</code>的表，列为<code class="fe lv lw lx ly b">ingredient</code>。我们将6种成分放入输入值中。</li><li id="b26c" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nt nl nm nn bi translated">我们将把输入值放到<code class="fe lv lw lx ly b">public.ingredients</code>表中<code class="fe lv lw lx ly b">INSERT</code></li><li id="a418" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nt nl nm nn bi translated">我们将过滤插入<code class="fe lv lw lx ly b">WHERE</code>输入值中的成分还不存在于<code class="fe lv lw lx ly b">public.ingredients</code>中。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/61ab9b59bafaf6e4d5caf4522a89c6a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2o6LdEaGJw93noel"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这些是一些新鲜的原料(图片由<a class="ae ky" href="https://unsplash.com/@videmusart" rel="noopener ugc nofollow" target="_blank"> Syd Wachs </a>在<a class="ae ky" href="https://unsplash.com/photos/epqNIYI6S7E" rel="noopener ugc nofollow" target="_blank"> unsplash </a>上提供)</p></figure><p id="c981" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">执行此查询将输出下表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/2cd754cd37a7e0772e62f2e71831fbce.png" data-original-src="https://miro.medium.com/v2/resize:fit:584/format:webp/1*2ZPpTS3wDH1iNljlwmtFDQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们新加入的配料</p></figure><p id="bebb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们用咖喱来试试这个查询:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="37cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">执行后，Postgres说<code class="fe lv lw lx ly b">INSERT 0 2</code>这是个好消息！这意味着我们只向表中插入了两条记录，尽管我们传递了六条记录。我们只插入了表中没有的两种配料:paksoy和大米。让我们检查一下表格的内容，看看它是否有效:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/0be60ed19675681acc807214d853fe3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*ewxIG88F4nyCMxDgjzvhbg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的配料表</p></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="ca88" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">3.保存插入</h1><p id="1fad" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">使用上面的查询，我们只能插入独特的成分。如果我们试图插入Postgres中已经存在的成分，就会返回一个错误。</p><pre class="kj kk kl km gt nw ly nx ny aw nz bi"><span id="a56d" class="oa mh it ly b gy ob oc l od oe">INSERT INTO public.ingredients (ingredient) VALUES (‘paprika’);</span></pre><p id="b21b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">会产生以下错误:</p><pre class="kj kk kl km gt nw ly nx ny aw nz bi"><span id="5285" class="oa mh it ly b gy ob oc l od oe">ERROR: duplicate key value violates unique constraint “ingredients_ingredient_key” DETAIL: Key (ingredient)=(paprika) already exists. SQL state: 23505</span></pre><p id="0d74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，即使我们忘记了使用这个令人惊叹的新查询，表中的惟一约束也可以防止重复值。厉害！</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="bed5" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">结论</h1><p id="79dd" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">通过这篇文章，我希望对如何处理惟一值和使用惟一约束有所启发。如果你有建议/澄清，请评论，以便我可以改进这篇文章。与此同时，请查看我的<a class="ae ky" href="https://mikehuls.medium.com/" rel="noopener">其他文章</a>关于各种与编程相关的主题，例如:</p><ul class=""><li id="0d1a" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-delete-into-another-table-b5b946a42299" rel="noopener">删除到另一个表格</a></li><li id="0eb6" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-into-another-table-bfc3dff79a66" rel="noopener">更新到另一个标签页</a> le</li><li id="55d2" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-insert-delete-and-update-in-one-statement-sync-your-tables-with-merge-14814215d32c" rel="noopener">在一条语句中插入、删除和更新</a></li><li id="5867" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-select-in-one-query-b067a7e60136" rel="noopener">更新选择一批记录</a></li><li id="6faa" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><a class="ae ky" href="https://mikehuls.medium.com/python-to-sql-upsert-safely-easily-and-fast-17a854d4ec5a" rel="noopener">保存上插</a></li></ul><p id="e887" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><p id="961d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="5bc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page的缩写）学生:比如我正在做的事情？<a class="ae ky" href="https://github.com/mike-huls" rel="noopener ugc nofollow" target="_blank">跟我来</a>！</p></div></div>    
</body>
</html>