<html>
<head>
<title>Why You Should Use Context Managers in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么应该在Python中使用上下文管理器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/why-you-should-use-context-managers-in-python-4f10fe231206?source=collection_archive---------3-----------------------#2021-11-13">https://towardsdatascience.com/why-you-should-use-context-managers-in-python-4f10fe231206?source=collection_archive---------3-----------------------#2021-11-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/fcba8c3934093d22d8b5d3f4093e14f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Utn4e5P4YryUcaCwltYxzg.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">图片由<a class="ae kf" href="https://unsplash.com/@anasalshanti?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Anas Alshanti </a>在<a class="ae kf" href="https://unsplash.com/s/photos/code?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="9de2" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">什么是上下文管理器</h1><p id="618d" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果您在Python中使用过<code class="fe mc md me mf b">with</code>语句，那么您很可能已经使用过上下文管理器。</p><p id="a721" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">上下文管理器通常负责设置一些资源，例如打开一个连接，并在我们完成后自动处理清理工作。</p><p id="d405" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">可能，最常见的用例是打开一个文件。</p><pre class="ml mm mn mo gt mp mf mq mr aw ms bi"><span id="656e" class="mt kh it mf b gy mu mv l mw mx"><strong class="mf iu">with open('/path/to/file.txt', 'r') as f</strong>:<br/>  for line in f:<br/>    print(line)</span></pre><p id="8a4b" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">上面的代码将打开文件，并保持打开状态，直到我们退出<code class="fe mc md me mf b">with</code>语句。然后它会关闭它。整洁，对吗？</p><h1 id="1fa3" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">你为什么要在乎？</h1><p id="083b" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，你可以不用<code class="fe mc md me mf b">with</code>打开一个文件，但是你必须自己清理。</p><pre class="ml mm mn mo gt mp mf mq mr aw ms bi"><span id="9543" class="mt kh it mf b gy mu mv l mw mx">f = open('/path/to/file.txt', 'r')<br/>for line in f:<br/>    print(line)<br/>f.close()  # must remember to close f</span></pre><p id="f356" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">除了这需要一行额外的代码之外，还有一些其他的缺点。也就是说，</p><ul class=""><li id="766b" class="my mz it lg b lh mg ll mh lp na lt nb lx nc mb nd ne nf ng bi translated">很容易忘记关闭文件，</li><li id="33f8" class="my mz it lg b lh nh ll ni lp nj lt nk lx nl mb nd ne nf ng bi translated"><code class="fe mc md me mf b">f.close()</code>如果在代码的前面某处有异常，就不会被调用。</li></ul><p id="b565" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">为了准确地复制使用<code class="fe mc md me mf b">with</code>语句打开文件，我们需要更多的代码来确保即使在出现异常的情况下也能关闭文件。</p><pre class="ml mm mn mo gt mp mf mq mr aw ms bi"><span id="e7f9" class="mt kh it mf b gy mu mv l mw mx">f = open('/path/to/file.txt', 'r')</span><span id="0541" class="mt kh it mf b gy nm mv l mw mx">try:<br/>  for line in f:<br/>    print(line)<br/>finally:<br/>  f.close()  # runs no matter what happens</span></pre><p id="d175" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">你应该关心正确地关闭文件，因为，在其他事情中，如果你打开太多文件，你会得到一个<code class="fe mc md me mf b">OSError</code>。</p><p id="fce4" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">意识到什么是上下文管理器，可以帮助你决定如果你计划实现的东西被构造成上下文管理器的话，什么时候会更容易阅读和使用。让我们来学习如何实现它们！</p><h1 id="f6ee" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">如何实现上下文管理器</h1><p id="2af1" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">有两种方法可以实现上下文管理器。第一个是定义一个实现了<code class="fe mc md me mf b">__enter__</code>和<code class="fe mc md me mf b">__exit__</code>方法的类。第二种方法是创建一个生成器并使用<code class="fe mc md me mf b">contextlib.contextmanager</code>装饰器。</p><h2 id="dbd5" class="mt kh it bd ki nn no dn km np nq dp kq lp nr ns ku lt nt nu ky lx nv nw lc nx bi translated">定义类别</h2><p id="bddb" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">正如我们之前提到的，为了能够使用一个类作为上下文管理器，你需要实现<code class="fe mc md me mf b">__enter__</code>和<code class="fe mc md me mf b">__exit__</code>。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ny"><img src="../Images/dccc11ac7f2fe40e74b9343af3309470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e0UZKdzTKBURYl3JIORvsA.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">上下文管理器的玩具示例。图片由作者提供。</p></figure><p id="4ac4" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">您会注意到，<code class="fe mc md me mf b">__exit__</code>方法以<code class="fe mc md me mf b">exc_type</code>、<code class="fe mc md me mf b">exc_val</code>、<code class="fe mc md me mf b">exc_tb</code>作为参数。这些用于传递关于发生在<code class="fe mc md me mf b">with</code>语句中的潜在异常的信息。</p><p id="38fa" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">好的，让我们看看当我们使用它时会发生什么。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/92c6de224dd52d0a7e13b4ab24d5d3ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LBFQ15D8f2kX7WXJMALb0Q.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">使用上下文管理器。图片由作者提供。</p></figure><p id="13de" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">首先，对象被实例化，然后调用<code class="fe mc md me mf b">__enter__</code>方法。此时，我们在<code class="fe mc md me mf b">with</code>语句内部。其中的任何代码都会被执行，在我们的例子中，它只是<code class="fe mc md me mf b">toy.run()</code>。在运行完<code class="fe mc md me mf b">with</code>中的所有代码后，调用<code class="fe mc md me mf b">__exit___</code>方法。</p><p id="c11e" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">让我们看看当出现异常时会发生什么。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/f84611498df15b778f7c82b6875eeb7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MB79z5lJknbs8rxbe6KLJg.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">发生异常时使用上下文管理器。图片由作者提供。</p></figure><p id="59fc" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">这次<code class="fe mc md me mf b">toy.run()</code>没有运行，但是我们仍然进入<code class="fe mc md me mf b">__exit__</code>，现在它的参数不是<code class="fe mc md me mf b">None</code>，而是包含了关于异常的信息。在我们离开<code class="fe mc md me mf b">__exit__</code>之后，异常被引发。</p><p id="9b6c" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">您可能想知道为什么将关于异常的信息传递给<code class="fe mc md me mf b">__exit__</code>是有用的。是给你处理的选择权。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ob"><img src="../Images/6e734f8d5c0e49ae7d9b7a6db428c8b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dDTwHznGJzcLFLPc0-u9Kw.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">__exit__中的处理值错误。图片由作者提供。</p></figure><p id="6914" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">当出现异常时，如果<code class="fe mc md me mf b">__exit__</code>方法返回<code class="fe mc md me mf b">True</code>，那么这意味着它已经被处理了，所以不会被引发。如果它返回任何其他内容，那么它将由<code class="fe mc md me mf b">with</code>引发。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oc"><img src="../Images/abe487ddf3db6e31cede62502a0bf245.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wXx80ly_QE7y2kn8AMMQMw.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">处理ValueError但引发所有其他异常。图片由作者提供。</p></figure><h2 id="86d7" class="mt kh it bd ki nn no dn km np nq dp kq lp nr ns ku lt nt nu ky lx nv nw lc nx bi translated">使用发电机+ <code class="fe mc md me mf b">contextlib.contextmanager</code></h2><p id="ab00" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，让我们看看如何使用生成器实现类似的东西。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi od"><img src="../Images/faac3e5ced779fb8740caf99700ce21c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4OTmfS3XP47WcUA71vxJqw.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">作为生成器实现的上下文管理器。图片由作者提供。</p></figure><p id="9838" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">在到达<code class="fe mc md me mf b">yield</code>之前，<code class="fe mc md me mf b">toy_example</code>内的代码将一直运行。在这一点上，我们将进入<code class="fe mc md me mf b">with</code>声明。如果发生任何异常，它们可以像在<code class="fe mc md me mf b">try-except-finally</code>程序块中一样被处理。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oe"><img src="../Images/ea9566b38e17f0b3bd3612a691169fba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T0Cn5ecuTmOwS48tiFiwpA.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">使用上下文管理器——没有例外。图片由作者提供。</p></figure><p id="616b" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">您可以认为<code class="fe mc md me mf b">except</code>和<code class="fe mc md me mf b">finally</code>模块中发生的事情等同于<code class="fe mc md me mf b">__exit__</code>中发生的事情。</p><figure class="ml mm mn mo gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi of"><img src="../Images/e79f411ba501373f0ab2b259a2033d25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RzyIb5g1InrVr-QN6ao0Tw.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">出现异常时使用上下文管理器。图片由作者提供。</p></figure><p id="9aa2" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">这种方法可能更容易理解，但了解这两种方法将有助于您选择最合适的方法。</p><h1 id="c24f" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">结论</h1><p id="b19c" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在这篇文章中，我们讨论了上下文管理器，为什么它们有用，以及如何实现它们。</p></div><div class="ab cl og oh hx oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="im in io ip iq"><div class="ml mm mn mo gt on"><a href="https://eminik355.medium.com/subscribe" rel="noopener follow" target="_blank"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">每当阿耳忒弥斯·卡尼出版时，就收到一封电子邮件。</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">每当阿耳忒弥斯·卡尼出版时，就收到一封电子邮件。注册后，如果您还没有，您将创建一个中型帐户…</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">eminik355.medium.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb jz on"/></div></div></a></div></div><div class="ab cl og oh hx oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="im in io ip iq"><p id="1ec0" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated"><strong class="lg iu">出自同一作者。</strong></p><div class="pc pd gp gr pe on"><a rel="noopener follow" target="_blank" href="/how-not-to-use-python-lists-d06cbe8e593"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">如何不使用Python列表</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">理解Python中的可变对象。</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="pf l oy oz pa ow pb jz on"/></div></div></a></div><div class="pc pd gp gr pe on"><a href="https://medium.com/analytics-vidhya/multi-armed-bandits-part-1-epsilon-greedy-algorithm-with-python-code-534b9e2abc9" rel="noopener follow" target="_blank"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">多臂强盗:Epsilon-Greedy算法和Python代码</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">了解Epsilon-Greedy的工作原理。为所有实验提供完整的python代码。</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">medium.com</p></div></div><div class="ow l"><div class="pg l oy oz pa ow pb jz on"/></div></div></a></div><div class="pc pd gp gr pe on"><a rel="noopener follow" target="_blank" href="/going-bayesian-testing-rate-metrics-82e872b79175"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">走向贝叶斯:测试速率度量</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">如何在没有p值和置信区间的情况下运行速率度量的A/B测试？</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="ph l oy oz pa ow pb jz on"/></div></div></a></div><div class="pc pd gp gr pe on"><a rel="noopener follow" target="_blank" href="/how-to-use-abstract-classes-in-python-d4d2ddc02e90"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">如何在Python中使用抽象类</h2><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">towardsdatascience.com</p></div></div><div class="ow l"><div class="pi l oy oz pa ow pb jz on"/></div></div></a></div></div><div class="ab cl og oh hx oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="im in io ip iq"><h1 id="4975" class="kg kh it bd ki kj pj kl km kn pk kp kq kr pl kt ku kv pm kx ky kz pn lb lc ld bi translated">参考</h1><p id="6ff2" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">[1]https://book.pythontips.com/en/latest/context_managers.html<a class="ae kf" href="https://book.pythontips.com/en/latest/context_managers.html" rel="noopener ugc nofollow" target="_blank"/></p><p id="9aa0" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">[2]<a class="ae kf" href="https://stackoverflow.com/questions/7395542/is-explicitly-closing-files-important" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/7395542/is-explicitly-closing-files-important</a></p><p id="e3ad" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">[3]<a class="ae kf" href="https://docs.sqlalchemy.org/en/14/orm/session_transaction.html" rel="noopener ugc nofollow" target="_blank">https://docs . sqlalchemy . org/en/14/ORM/session _ transaction . html</a></p><p id="b53e" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated"><a class="ae kf" href="https://realpython.com/python-with-statement/" rel="noopener ugc nofollow" target="_blank">https://realpython.com/python-with-statement/</a></p><p id="6f58" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">[5]<a class="ae kf" href="https://stackoverflow.com/questions/17577137/do-files-get-closed-during-an-exception-exit" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/17577137/do-files-get-closed-during-an-exception-exit</a></p><p id="934b" class="pw-post-body-paragraph le lf it lg b lh mg lj lk ll mh ln lo lp mi lr ls lt mj lv lw lx mk lz ma mb im bi translated">[6]<a class="ae kf" href="https://docs.python.org/3/library/io.html#io.IOBase" rel="noopener ugc nofollow" target="_blank">https://docs.python.org/3/library/io.html#io.IOBase</a></p></div></div>    
</body>
</html>