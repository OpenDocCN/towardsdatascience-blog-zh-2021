<html>
<head>
<title>Effective IaC AWS Cost Reduction Actions You’ll Not Find in any AWS Recommendation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你在任何AWS建议中都找不到的有效IaC AWS成本降低措施</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/effective-iac-aws-cost-reduction-actions-youll-not-find-any-aws-recommendation-c1922cb4bbf9?source=collection_archive---------31-----------------------#2021-08-22">https://towardsdatascience.com/effective-iac-aws-cost-reduction-actions-youll-not-find-any-aws-recommendation-c1922cb4bbf9?source=collection_archive---------31-----------------------#2021-08-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="78cb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何在不购买保留实例的情况下大幅降低EC2成本。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b73fc0043191775db044d6e4b4cfa294.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LHzl5gZ2fMZka_6u"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@micheile?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">视觉故事||米歇尔</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="f8c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">简介</strong></p><p id="e7bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当开发一个新项目时，在AWS上从头开始建立云架构会很快导致成本快速增加。从第一天起，了解服务成本并采取节约成本的措施是至关重要的。</p><p id="cfdc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常，客户希望尽可能地灵活，但由于需求快速变化，为他们的计算或数据库服务利用保留实例定价是不可行的。</p><p id="ad00" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将解释<strong class="ky ir">如何在不购买保留实例的情况下大幅降低EC2成本</strong>。</p><h1 id="a23b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">大小合适的实例</h1><p id="1ce6" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在讨论AWS服务的不同定价模式之前，有必要看一下通常由两种AWS服务提供的适当调整建议:</p><ul class=""><li id="5751" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">成本管理/合适的规模建议[2]</li><li id="ae40" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">计算优化器[3]</li></ul><p id="52b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">考虑这些服务的建议<strong class="ky ir">可以从一开始就防止过度供应</strong>。</p><h1 id="9f62" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">尽可能对所有非生产环境使用Spot实例</h1><p id="671e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">通常，在应用程序在生产环境中投入使用之前，会有一些部署阶段(开发、测试、UAT、试运行等)。).对于非生产环境，只要有可能就使用点实例被证明是有效的，尤其是当您使用无状态、容错的工作负载时([1])。</p><p id="7e0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用spots时，你要预料到它们可能会被打断。在选择实例类型之前，可以通过查看AWS的<a class="ae kv" href="https://aws.amazon.com/de/ec2/spot/instance-advisor/" rel="noopener ugc nofollow" target="_blank">“spot Instance Advisor”</a>[2】来评估Spot实例被中断的概率，该向导显示了与按需实例相比的节省，以及Spot实例被中断的概率，具体取决于地区。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nd ne l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">欧盟-中欧-1(法兰克福)现场顾问2021–08–05</p></figure><p id="3da4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上表显示了中断的可能性，并比较了从AWS文档[5]中收集的3种实例类型(m5.large、m4.large、c5.xlarge)的不同定价模式(按需、现货、预留1年全额预付)的降价情况。</p><p id="bf73" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用/创建spot实例与相应的terraform资源有各种不同的方式:</p><ul class=""><li id="8261" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">单点实例/ <code class="fe nf ng nh ni b">aws_spot_instance_request</code> [6]</li><li id="6f6a" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">现货舰队请求/<code class="fe nf ng nh ni b">aws_spot_fleet_request</code>【7】</li><li id="2c90" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">使用混合实例策略/ <code class="fe nf ng nh ni b">aws_autoscaling_group</code> [8]自动缩放组</li></ul><p id="663a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用自动缩放组并设置<code class="fe nf ng nh ni b">descired_capacity</code>、<code class="fe nf ng nh ni b">min_size</code>和<code class="fe nf ng nh ni b">max-size</code>不仅可以确保spot实例在被中断时被重新请求，还可以让我们非常容易地实现另一个节省成本的措施，我们将在下一节中看到如何实现。</p><p id="3399" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过用<code class="fe nf ng nh ni b">on_demand_base_capacity=0</code>、<code class="fe nf ng nh ni b">on_demand_percentage_above_base_capacity=0</code>配置<code class="fe nf ng nh ni b">aws_autoscaling_group</code> —资源中的<code class="fe nf ng nh ni b">instances_distribution</code>块，可以确保只使用点实例。将<code class="fe nf ng nh ni b">spot_allocation_strategy</code>设置为<code class="fe nf ng nh ni b">lowest-price</code>将进一步从定义的实例池中请求最便宜的实例类型。</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="1c47" class="nn lt iq ni b gy no np l nq nr">instances_distribution {<br/>      on_demand_base_capacity                  = 0<br/>      on_demand_percentage_above_base_capacity = 0<br/>      spot_allocation_strategy                 = "lowest-price"<br/>    }</span></pre><h1 id="5abb" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">在非办公时间关闭所有非生产环境的实例</h1><p id="3a98" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">除了通过使用spots实现节约之外，在用户不工作的时间或节假日实施计划停机也是可行的。</p><blockquote class="ns"><p id="36a5" class="nt nu iq bd nv nw nx ny nz oa ob lr dk translated">"为什么要为根本没有使用的资源支付租金？"</p></blockquote><p id="e174" class="pw-post-body-paragraph kw kx iq ky b kz oc jr lb lc od ju le lf oe lh li lj of ll lm ln og lp lq lr ij bi translated">对于ASG管理的实例，如使用具有混合实例策略的启动模板的方法所描述的，这可以通过自动缩放组的“预定动作”功能来实现[10]。</p><p id="fe26" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过使用terra form-resource<code class="fe nf ng nh ni b">aws_autoscaling_schedule</code>【9】，您可以通过在cron表达式定义的特定时间设置所需的ASG大小参数来缩放ASG。</p><p id="95f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们使用所描述的方法，将非办公时间定义为</p><ul class=""><li id="a716" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">周一至周五:20:00–06:00</li><li id="c27f" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">星期六，星期日:00:00–24:00</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nd ne l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">一个实例的月成本比较</p></figure><p id="1ddd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">比较不同的成本节约选项，我们会发现将现场实例和计划关闭相结合明显优于标准保留实例定价(1年全额预付)。</p><h1 id="d88c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="4a77" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">AWS文档包含许多优化成本的信息和文档，通常非常受欢迎。可以理解的是，并不是每种方法都被AWS正式推荐，但是在实践中证明是非常有效的。</p><p id="45ea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我展示了一种方法，它结合了spot实例的使用，并使用ASG调度操作在非办公时间关闭它们，与按需定价相比，这大大降低了成本。</p><p id="b721" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您在降低AWS基础设施成本方面需要更多帮助，请联系我们。</p><h1 id="5509" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">参考文献</strong></h1><p id="f334" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">[1]<a class="ae kv" href="https://docs.aws.amazon.com/whitepapers/latest/cost-optimization-leveraging-ec2-spot-instances/when-to-use-spot-instances.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/white papers/latest/cost-optimization-leveling-ec2-spot-instances/when-to-use-spot-instances . html</a></p><p id="fac6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[2]<a class="ae kv" href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/ce-rightsizing.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AWS count billing/latest/about v2/ce-right sizing . html</a></p><p id="3b7c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[3]https://aws.amazon.com/de/compute-optimizer/<a class="ae kv" href="https://aws.amazon.com/de/compute-optimizer/" rel="noopener ugc nofollow" target="_blank"/></p><p id="87bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://aws.amazon.com/de/ec2/spot/instance-advisor/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/de/ec2/spot/instance-advisor/</a></p><p id="38a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[5]<a class="ae kv" href="https://aws.amazon.com/de/ec2/pricing/reserved-instances/pricing/#" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/de/ec2/pricing/reserved-instances/pricing/#</a></p><p id="f322" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[6]<a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/spot_instance_request" rel="noopener ugc nofollow" target="_blank">https://registry . terraform . io/providers/hashi corp/AWS/latest/docs/resources/spot _ instance _ request</a></p><p id="5384" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[7]<a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/spot_fleet_request" rel="noopener ugc nofollow" target="_blank">https://registry . terraform . io/providers/hashi corp/AWS/latest/docs/resources/spot _ fleet _ request</a></p><p id="bf50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[8]<a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group#mixed-instances-policy-with-spot-instances-and-capacity-rebalance" rel="noopener ugc nofollow" target="_blank">https://registry . terra form . io/providers/hashi corp/AWS/latest/docs/resources/auto scaling _ group # mixed-instances-policy-with-spot-instances-and-capacity-rebalance</a></p><p id="8274" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[9]<a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_schedule" rel="noopener ugc nofollow" target="_blank">https://registry . terraform . io/providers/hashi corp/AWS/latest/docs/resources/auto scaling _ schedule</a></p><p id="2701" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[10]<a class="ae kv" href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/schedule_time.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/auto scaling/ec2/user guide/schedule _ time . html</a></p></div></div>    
</body>
</html>