<html>
<head>
<title>Geocoding in Python: A Complete Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中的地理编码:完整指南</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/geocoding-in-python-a-complete-guide-d68a4faafdc6?source=collection_archive---------14-----------------------#2021-07-15">https://towardsdatascience.com/geocoding-in-python-a-complete-guide-d68a4faafdc6?source=collection_archive---------14-----------------------#2021-07-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8b62" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Python进行地理编码的分步教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b1e02be9c5310f2b9f13451a195cdd41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PEW8oReQoTod7lbU.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安德鲁·斯图特斯曼在<a class="ae ky" href="https://unsplash.com/s/photos/map?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="6308" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="6aaf" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在处理机器学习的大型数据集时，您是否遇到过类似这样的地址列？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/c242ec75a451f8aaaca4ac01941b6a53.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/0*qGHCm9xTJkadt8Ye.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="4cc4" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">位置数据可能非常混乱，难以处理。</p><p id="1974" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">很难对地址进行编码，因为它们的基数非常高。如果您尝试使用类似one-hot编码的技术对这样的列进行编码，这将导致高维度，并且您的机器学习模型可能性能不佳。</p><p id="c2e2" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">克服这个问题最简单的方法就是<strong class="lt iu">对这些列进行地理编码</strong>。</p><h1 id="be26" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">什么是地理编码？</h1><p id="cddc" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">地理编码是将地址转换为地理坐标的过程。这意味着您将把原始地址转换成纬度/经度对。</p><h1 id="8889" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Python中的地理编码</h1><p id="0aba" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">有许多不同的库可以帮助你用Python做到这一点。最快的是<strong class="lt iu"> Google Maps API，</strong>如果你有超过1000个地址需要在短时间内转换，我推荐使用。</p><p id="e467" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">然而，谷歌地图API不是免费的。你需要为每1000个请求支付大约5美元。</p><p id="f99b" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">谷歌地图API的一个免费替代品是OpenStreetMap API。然而，OpenStreetMap API要慢得多，而且也不太准确。</p><p id="097c" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在本文中，我将用这两个API带您完成地理编码过程。</p><h1 id="6976" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">方法1:谷歌地图应用编程接口</h1><p id="a055" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们首先使用Google Maps API将地址转换成纬度/经度对。为此，你首先需要创建一个谷歌云账户，并输入你的信用卡信息。</p><p id="3778" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">虽然这是一项付费服务，但当你第一次创建谷歌云账户时，谷歌会给你200美元的免费积分。这意味着您可以使用他们的地理编码API进行大约40，000次呼叫，然后才需要付费。只要你没有达到这个限额，你的账户就不会被扣款。</p><p id="ac58" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">首先，<a class="ae ky" href="https://cloud.google.com/gcp/getting-started" rel="noopener ugc nofollow" target="_blank">用Google Cloud设置一个免费账户</a>。然后，一旦你建立了一个帐户，你就可以按照<a class="ae ky" href="https://www.youtube.com/watch?v=OGTG1l7yin4" rel="noopener ugc nofollow" target="_blank">这个</a>教程来获得你的谷歌地图API密钥。</p><p id="2ae3" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">一旦你收到你的API密匙，你就可以开始编码了！</p><h2 id="4ee6" class="mt la it bd lb mu mv dn lf mw mx dp lj ma my mz ll me na nb ln mi nc nd lp ne bi translated">先决条件</h2><p id="b54a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本教程中，我们将使用<a class="ae ky" href="https://www.kaggle.com/shrutimehta/zomato-restaurants-data" rel="noopener ugc nofollow" target="_blank"> Zomato Restaurants Kaggle </a>数据集。确保将数据集安装在您的路径中。然后，使用以下命令安装googlemaps API包:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="5932" class="mt la it ng b gy nk nl l nm nn">pip install -U googlemaps</span></pre><h2 id="7e0c" class="mt la it bd lb mu mv dn lf mw mx dp lj ma my mz ll me na nb ln mi nc nd lp ne bi translated">进口</h2><p id="190b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">运行下面几行代码来导入入门所需的库:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="1d4c" class="mt la it ng b gy nk nl l nm nn">import csv<br/>import pandas as pd<br/>import googlemaps</span></pre><h2 id="c7f9" class="mt la it bd lb mu mv dn lf mw mx dp lj ma my mz ll me na nb ln mi nc nd lp ne bi translated">读取数据集</h2><p id="5e59" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，让我们读取数据集并检查数据帧的头部:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="f90e" class="mt la it ng b gy nk nl l nm nn">data = pd.read_csv('zomato.csv',encoding="ISO-8859-1")<br/>df = data.copy()<br/>df.head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/1d259da03fdbc8ce663e4fe94570700a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J6XNNBIzllfzZWG3.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="c381" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">这个数据帧有21列和9551行。</p><p id="4002" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">我们只需要address列进行地理编码，因此我将删除所有其他列。然后，我将删除重复的地址，这样我们只获得唯一的地址:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="44ea" class="mt la it ng b gy nk nl l nm nn">df = df[['Address']]<br/>df = df.drop_duplicates()</span></pre><p id="9dd8" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">再看一下数据帧的头部，我们只能看到地址列:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/76d8dfc2297d6c3eee69012fe0b1182b.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/0*_7MnDgVTwjeI_w2v.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="f9db" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">太好了！我们现在可以开始地理编码了。</p><h2 id="f918" class="mt la it bd lb mu mv dn lf mw mx dp lj ma my mz ll me na nb ln mi nc nd lp ne bi translated">地理编码</h2><p id="1a57" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">首先，我们需要用Python访问我们的API密钥。为此，请运行以下代码行:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="06a2" class="mt la it ng b gy nk nl l nm nn">gmaps_key = googlemaps.Client(key="your_API_key")</span></pre><p id="4208" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">现在，让我们先尝试对一个地址进行地理编码，然后看看输出。</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="5ebd" class="mt la it ng b gy nk nl l nm nn">add_1 = df['Address'][0]<br/>g = gmaps_key.geocode(add_1)<br/>lat = g[0]["geometry"]["location"]["lat"]<br/>long = g[0]["geometry"]["location"]["lng"]<br/>print('Latitude: '+str(lat)+', Longitude: '+str(long))</span></pre><p id="ec25" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">上述代码的输出如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/408bd198b3b40a3ff6675d2014570e7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/0*PhWnq80puVbA725d.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="9f73" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">如果你得到上面的输出，太好了！一切正常。</p><p id="b5d4" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">我们现在可以对整个数据帧重复这一过程:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="3dba" class="mt la it ng b gy nk nl l nm nn"># geocode the entire dataframe:<br/><br/>def geocode(add):<br/>    g = gmaps_key.geocode(add)<br/>    lat = g[0]["geometry"]["location"]["lat"]<br/>    lng = g[0]["geometry"]["location"]["lng"]<br/>    return (lat, lng)<br/><br/>df['geocoded'] = df['Address'].apply(geocode)</span></pre><p id="119a" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">让我们再次检查数据帧的头部，看看这是否有效:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="1899" class="mt la it ng b gy nk nl l nm nn">df.head()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/644441c4d7e2b68d7a4c7ea485f690b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/0*uf_i7yMZ1q3ykuKA.png"/></div></figure><p id="899a" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">如果你的输出看起来像上面的截图，那么恭喜你！您已成功对整个数据帧中的地址进行了地理编码。</p><h1 id="b716" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">方法2: OpenStreetMap API</h1><p id="81a9" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">OpenStreetMap API是完全免费的，但是比Google maps API慢，也不准确。</p><p id="c8bf" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">这个API无法定位数据集中的许多地址，所以这次我们将使用<em class="nr">位置</em>列。</p><p id="da65" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">在我们开始本教程之前，让我们看看<em class="nr">地址</em>和<em class="nr">地点</em>列之间的区别。为此，请运行以下代码行:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="a7e4" class="mt la it ng b gy nk nl l nm nn">print('Address: '+data['Address'][0]+'\n\nLocality: '+data['Locality'][0])</span></pre><p id="77f3" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">您的输出将如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/a0c0a27e55f2febf4a46153bba27b49c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WNQWMRttMFJJZ7OF.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="a5bf" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated"><em class="nr">地址</em>列比<em class="nr">位置</em>列更细粒度，它提供了餐馆的确切位置，包括楼层号。这可能是OpenStreetMap API无法识别地址的原因，但位置可以识别。</p><p id="3869" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">让我们对第一个地点进行地理编码，并查看输出。</p><h2 id="ca2d" class="mt la it bd lb mu mv dn lf mw mx dp lj ma my mz ll me na nb ln mi nc nd lp ne bi translated">地理编码</h2><p id="68e2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">运行以下代码行:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="9e9b" class="mt la it ng b gy nk nl l nm nn">import url<br/>import requests<br/><br/>data = data[['Locality']]<br/><br/>url = 'https://nominatim.openstreetmap.org/search/' + urllib.parse.quote(df['Locality'][0]) +'?format=json'<br/>response = requests.get(url).json()<br/>print('Latitude: '+response[0]['lat']+', Longitude: '+response[0]['lon'])</span></pre><p id="5082" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">上述代码的输出与Google Maps API生成的结果非常相似:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/35e8dd819b1b4bbfe694cc9b300fb297.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/0*Uvg6Yn_w9p3A1uAi.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="9781" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">现在，让我们创建一个函数来查找整个数据帧的坐标:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="ab1a" class="mt la it ng b gy nk nl l nm nn">def geocode2(locality):<br/>    url = 'https://nominatim.openstreetmap.org/search/' + urllib.parse.quote(locality) +'?format=json'<br/>    response = requests.get(url).json()<br/>    if(len(response)!=0):<br/>        return(response[0]['lat'], response[0]['lon'])<br/>    else:<br/>        return('-1')<br/><br/>data['geocoded'] = data['Locality'].apply(geocode2)</span></pre><p id="4996" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">太好了！现在，让我们看看数据帧的头部:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="2c66" class="mt la it ng b gy nk nl l nm nn">data.head(15)</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/a94cc6aff8ce213285f33beab73d3219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/0*l1GHCv_jgACa4n0P.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="345b" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">请注意，该API无法为数据帧中的许多位置提供坐标。</p><p id="b672" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">尽管它是谷歌地图API的一个很好的免费替代品，但是如果你用OpenStreetMap进行地理编码，你可能会丢失很多数据。</p></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><p id="01f2" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">本教程到此为止！我希望你从这里学到一些新的东西，并对处理地理空间数据有更好的理解。</p><p id="6ccc" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">祝您的数据科学之旅好运，感谢您的阅读！</p><p id="54ae" class="pw-post-body-paragraph lr ls it lt b lu mo ju lw lx mp jx lz ma mq mc md me mr mg mh mi ms mk ml mm im bi translated">本文原载<a class="ae ky" href="https://www.natasshaselvaraj.com/a-step-by-step-guide-on-geocoding-in-python/" rel="noopener ugc nofollow" target="_blank">此处</a>。</p></div></div>    
</body>
</html>