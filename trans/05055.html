<html>
<head>
<title>Sarcasm Text Classification using spaCy in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中基于空间的讽刺文本分类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sarcasm-text-classification-using-spacy-in-python-7cd39074f32e?source=collection_archive---------6-----------------------#2021-05-04">https://towardsdatascience.com/sarcasm-text-classification-using-spacy-in-python-7cd39074f32e?source=collection_archive---------6-----------------------#2021-05-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="6c22" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="3585" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">训练自己的自定义TextCat组件，并将其打包为Python模块</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/957723de60ebee3a8b6895b100780d67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cOu6ZIABKdInOzASfx-wyw.jpeg"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">照片由<a class="ae lh" href="https://unsplash.com/s/photos/sarcasm?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae lh" href="https://unsplash.com/@capnsnap?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> capnsnap </a>拍摄</p></figure><p id="a7bc" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">通过阅读本文，您将学会训练一个讽刺文本分类模型，并将其部署到您的Python应用程序中。检测文本中讽刺的存在是一项有趣但具有挑战性的自然语言处理任务。</p><p id="82bd" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">本教程主要关注于训练一个自定义多分类空间的<code class="fe me mf mg mh b">TextCat</code>组件。如果您刚刚开始或者有自己的用例，您需要做的就是用您喜欢的数据集替换掉数据集。设置和培训过程大致相同，只是对配置做了一些小的改动。</p><p id="4c70" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了保持简单和简短，这部分的培训架构将基于以下内容的叠加组合:</p><ul class=""><li id="e93a" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated">线性词袋模型和</li><li id="54e8" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">建立在Tok2Vec层上并使用注意力的神经网络模型。</li></ul><p id="a410" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在内部，spaCy支持任何具有预训练权重和来自<a class="ae lh" href="https://huggingface.co/transformers/pretrained_models.html" rel="noopener ugc nofollow" target="_blank"> HuggingFace </a>的PyTorch实现的变压器模型。如果您喜欢使用最新的变压器模型，如BERT、ALBERT、RoBERTa等，请随意修改模型架构。</p><p id="4326" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">事不宜迟，让我们进入下一节，开始安装必要的模块</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="c57c" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">设置</h1><p id="ab8e" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">强烈建议您在继续之前设置一个虚拟环境。</p><h2 id="6e27" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">宽大的</h2><p id="8159" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">根据您的喜好，有多种方式安装空间<a class="ae lh" href="https://spacy.io/usage" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="1c6d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">通过<code class="fe me mf mg mh b">pip</code>的安装可以通过以下命令完成(仅限CPU):</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="a7f6" class="oa ne it mh b gy op oq l or os">pip install -U spacy</span></pre><p id="518c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">对于GPU支持，请使用以下命令:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="dce7" class="oa ne it mh b gy op oq l or os">pip install -U spacy[cuda102]</span></pre><p id="0ed3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">或者，您可以通过<code class="fe me mf mg mh b">conda</code>安装，如下所示:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="b9b8" class="oa ne it mh b gy op oq l or os"># CPU<br/>conda install -c conda-forge spacy</span><span id="bff7" class="oa ne it mh b gy ot oq l or os"># GPU<br/>conda install -c conda-forge spacy<br/>conda install -c conda-forge cupy</span></pre><h2 id="5ba2" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">资料组</h2><p id="040c" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">本教程在Kaggle的Reddit数据集上使用了<a class="ae lh" href="https://www.kaggle.com/danofer/sarcasm" rel="noopener ugc nofollow" target="_blank">讽刺。如果您在访问它时遇到问题，请查看存放数据的</a><a class="ae lh" href="https://nlp.cs.princeton.edu/SARC/0.0/" rel="noopener ugc nofollow" target="_blank">原始链接</a>..请根据您的用例随意更改数据集。</p><p id="a386" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">下载以下文件:</p><ul class=""><li id="e6d4" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated">测试平衡. csv</li><li id="0866" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">train-balanced.csv</li></ul><p id="b896" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">下图展示了数据集的内容及其相应的标题。最重要的数据点是:</p><ul class=""><li id="77cc" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated"><code class="fe me mf mg mh b">label</code>:表示文本是讽刺性的(1)还是非讽刺性的(0)</li><li id="88d7" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">comment</code>:代表文本</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ou"><img src="../Images/2e40a5934d69ac6b9c415bf3b6bb4d9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mSOyFovYQF0lSx3Rs1NjFw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片</p></figure><p id="316b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您需要处理数据集并将其转换为两个JSONL文件，如下所示:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="cff4" class="oa ne it mh b gy op oq l or os">{"text": "Certainly not number of recruiting stars.", "cats": {"sarcasm": 0.0, "other": 1.0}}<br/>{"text": "actually Mercedes parts are quite cheap.", "cats": {"sarcasm": 0.0, "other": 1.0}}<br/>{"text": "Because four days really makes all the difference!", "cats": {"sarcasm": 1.0, "other": 0.0}}</span></pre><p id="065a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">每行代表一个具有以下属性的字典:</p><ul class=""><li id="e050" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated">文本</li><li id="72fd" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">猫</li></ul><p id="79e8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><code class="fe me mf mg mh b">cats</code>表示相应文本的标签。将相应的目标标签标记为<code class="fe me mf mg mh b">1.0</code>，其余标记为<code class="fe me mf mg mh b">0.0</code>。在这种情况下，讽刺被标记为<code class="fe me mf mg mh b">1.0</code>，而其他被标记为<code class="fe me mf mg mh b">0.0</code>。将<code class="fe me mf mg mh b">assets</code>文件夹中的JSONL文件另存为:</p><ul class=""><li id="0684" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated">data.train.jsonl</li><li id="9d38" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">data.valid.jsonl</li></ul><h2 id="f02a" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">转换器脚本</h2><p id="4941" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">此外，您将需要一个额外的转换器脚本，以便在训练期间将新创建的JSONL数据转换为spaCy二进制格式。创建一个名为<code class="fe me mf mg mh b">scripts</code>的新文件夹。然后，创建一个名为<code class="fe me mf mg mh b">convert.py</code>的Python文件，其中包含以下代码:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ov ow l"/></div></figure><h2 id="aad7" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">配置文件</h2><p id="b10b" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">接下来，在您的工作目录中创建一个名为<code class="fe me mf mg mh b">configs</code>的新文件夹。在该文件夹中，创建一个名为<code class="fe me mf mg mh b">config.conf</code>的新文件，并在其中添加以下配置:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="e957" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">它表示在spaCy中训练模型时使用的自定义管道。这表示将使用<a class="ae lh" href="https://spacy.io/api/architectures#TextCatEnsemble" rel="noopener ugc nofollow" target="_blank">空间对<code class="fe me mf mg mh b">textcat</code>组件进行培训。TextCatEnsemble.v2 </a>架构。您可以根据自己的喜好随意修改配置。</p><p id="3435" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">例如，您可以将<code class="fe me mf mg mh b">patience</code>值更改为更高的值，以防止过早停止。如果1000步后分数没有提高，当前设置将停止训练。</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="412b" class="oa ne it mh b gy op oq l or os">[training]<br/>...<br/>patience = 1000<br/>max_epochs = 1<br/>max_steps = 0<br/>eval_frequency = 100<br/>...</span></pre><p id="cdab" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">请注意，对于用于多分类任务的<code class="fe me mf mg mh b">textcat</code>组件，应始终使用<code class="fe me mf mg mh b">exclusive_classes = true</code>。另一方面，在训练多标签分类模型时，你应该使用<code class="fe me mf mg mh b">exclusive_classes = false</code>。</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="5ee3" class="oa ne it mh b gy op oq l or os">[components.textcat.model.linear_model]                       @architectures = "spacy.TextCatBOW.v1"                       exclusive_classes = true<br/>ngram_size = 1<br/>no_output_layer = false<br/>nO = null</span></pre><h2 id="b779" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">项目文件</h2><p id="5c59" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">让我们通过在您的工作目录中创建一个名为<code class="fe me mf mg mh b">project.yml</code>的新文件来结束设置。在其中添加以下代码:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="091c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">它包含以下内容:</p><ul class=""><li id="3099" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated">与项目相关的元数据</li><li id="fc7e" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">命令</li><li id="def0" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">工作流程</li></ul><p id="4931" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您可以在<code class="fe me mf mg mh b">vars</code>部分修改与现有项目相关的所有元数据。例如，如果您打算使用本地机器的第一个GPU进行训练，可以将<code class="fe me mf mg mh b">gpu_id</code>更改为0。通过在每次训练中指定不同的<code class="fe me mf mg mh b">version</code>，spaCy会通过<code class="fe me mf mg mh b">version</code>将你的模型打包到不同的文件夹后缀中。</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="0d91" class="oa ne it mh b gy op oq l or os">vars:<br/>  name: "textcat_multilabel_emotion"<br/>  # Supported languages: all except ja, ko, th, vi, and zh, which would require<br/>  # custom tokenizer settings in config.cfg<br/>  lang: "en"<br/>  # Set your GPU ID, -1 is CPU<br/>  gpu_id: -1<br/>  version: "0.0.0"<br/>  train: "data.train.jsonl"<br/>  dev: "data.valid.jsonl"<br/>  config: "config.cfg"</span></pre><p id="bb81" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">命令是预定义的操作，可以通过以下方式触发:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="d3f7" class="oa ne it mh b gy op oq l or os">spacy project run [command]</span></pre><p id="c94b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">假设您已经定义了以下命令:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="0747" class="oa ne it mh b gy op oq l or os">...<br/>commands:<br/>  - name: "convert"<br/>    help: "Convert the data to spaCy's binary format"<br/>    script:<br/>      - "python scripts/convert.py ${vars.lang} assets/${vars.train} corpus/train.spacy"<br/>      - "python scripts/convert.py ${vars.lang} assets/${vars.dev} corpus/dev.spacy"<br/>    deps:<br/>      - "assets/${vars.train}"<br/>      - "assets/${vars.dev}"<br/>      - "scripts/convert.py"<br/>    outputs:<br/>      - "corpus/train.spacy"<br/>      - "corpus/dev.spacy"<br/>...</span></pre><p id="c6ba" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您可以通过在命令行中运行以下命令来触发它。</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="a06d" class="oa ne it mh b gy op oq l or os">spacy project run convert</span></pre><p id="e80a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">或者，您可以将所有命令捆绑到一个工作流中，如下所示:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="30d1" class="oa ne it mh b gy op oq l or os">workflows:<br/>  all:<br/>    - convert<br/>    - train<br/>    - evaluate<br/>    - package</span></pre><p id="ef9a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然后，您可以运行以下命令来按顺序执行所有命令:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="16d5" class="oa ne it mh b gy op oq l or os">spacy project run all</span></pre><p id="f258" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您已经完成了初始设置。前往下一部分训练你的模型。</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="cf9a" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">履行</h1><p id="c054" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">在本节中，您将学习训练模型并将其部署到Python应用程序中。在您之前创建的<code class="fe me mf mg mh b">project.yml</code>脚本中，它包含以下命令:</p><ul class=""><li id="b2e1" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated"><code class="fe me mf mg mh b">convert</code> —将数据转换为spaCy的二进制格式</li><li id="4eb8" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">train</code> —训练textcat模型</li><li id="e1ac" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">evaluate</code> —评估模型并导出指标</li><li id="5e6a" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">package</code> —将训练好的模型打包成pip包</li><li id="da19" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">visualize-model</code>-使用Streamlit交互式可视化模型输出</li></ul><p id="b053" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果您打算运行<code class="fe me mf mg mh b">visualize-model</code>命令，请转到<a class="ae lh" href="https://github.com/explosion/projects/blob/v3/pipelines/textcat_demo/scripts/visualize_model.py" rel="noopener ugc nofollow" target="_blank">下面的链接</a>并将代码保存为<code class="fe me mf mg mh b">visualize_model.py</code>在<code class="fe me mf mg mh b">scripts</code>文件夹中。除此之外，您还需要通过以下命令安装<code class="fe me mf mg mh b">spacy-streamlit</code>。</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="abba" class="oa ne it mh b gy op oq l or os">pip install spacy-streamlit --pre</span></pre><h2 id="041b" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">使用工作流</h2><p id="95f8" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">让我们利用以下工作流，而不是逐个运行命令:</p><ul class=""><li id="c2cd" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated">转换数据</li><li id="8bb7" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">训练模型</li><li id="7993" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">评估模型</li><li id="2bea" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">打包训练好的模型</li></ul><p id="94de" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">运行以下命令:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="a8c1" class="oa ne it mh b gy op oq l or os">spacy project run all</span></pre><h2 id="cf32" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">检查文件夹</h2><p id="6501" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">它将首先检查您的工作目录，并生成其中不存在的文件夹。您应该有以下文件夹:</p><ul class=""><li id="f49a" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated">资产</li><li id="da23" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">文集</li><li id="fc98" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">配置</li><li id="f3cd" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">培养</li><li id="7ad3" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">剧本</li><li id="42ec" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">包装</li></ul><h2 id="eb5c" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">转换数据集</h2><p id="26d7" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">之后，它将加载您的JSONL数据集，并在<code class="fe me mf mg mh b">corpus</code>文件夹中将其转换为二进制格式:</p><ul class=""><li id="4d8c" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated">火车空间</li><li id="366a" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">开发空间</li></ul><h2 id="7ddd" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">训练模型</h2><p id="8d06" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">一旦转换完成，它将初始化管道组件并开始训练模型。您应该会在控制台中看到以下输出:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="44ce" class="oa ne it mh b gy op oq l or os">ℹ Pipeline: ['textcat_sarcasm']<br/>ℹ Initial learn rate: 0.001<br/>E    #       LOSS TEXTC...  CATS_SCORE  SCORE<br/>---  ------  -------------  ----------  ------<br/>  0       0           0.06       48.55    0.49<br/>  0     100           1.90       52.71    0.53<br/>  0     200           1.41       57.34    0.57<br/>  0     300           1.07       60.73    0.61<br/>  0     400           0.83       63.55    0.64</span></pre><ul class=""><li id="59d2" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated"><code class="fe me mf mg mh b">E</code> —表示已经完成的历元数。</li><li id="5926" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">#</code> —表示当前的总训练步数。您可以通过配置文件中的<code class="fe me mf mg mh b">eval_frequency</code>更改频率。</li><li id="9b0d" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">LOSS TEXTCAT</code> —损失值。</li><li id="c66d" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">CATS_SCORE</code> —评估分数，从0到100。</li><li id="7754" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">SCORE</code> —评价得分从0.0到1.0，小数点后两位(四舍五入)。</li></ul><p id="2c2e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">训练将持续进行，直到满足以下任一条件:</p><ul class=""><li id="2a80" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated">达到了定义的<code class="fe me mf mg mh b">max_epochs</code></li><li id="e0a3" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">达到了定义的<code class="fe me mf mg mh b">max_steps</code></li><li id="2e29" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">达到定义的<code class="fe me mf mg mh b">patience</code>(分数没有任何提高的步数)</li></ul><p id="b7eb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">它会将最佳模型和最后模型保存在<code class="fe me mf mg mh b">training</code>文件夹中。</p><h2 id="6974" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">模型评估</h2><p id="d6b5" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">下一步是模型评估。它将使用最佳模型计算指标，并将结果作为<code class="fe me mf mg mh b">training</code>文件夹中的<code class="fe me mf mg mh b">metrics.json</code>导出。</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="0619" class="oa ne it mh b gy op oq l or os">{<br/>  "token_acc":1.0,<br/>  "cats_score":0.728515388,<br/>  "speed":36132.1250494927,<br/>  "cats_f_per_type":{<br/>    "sarcasm":{<br/>      "p":0.7550697085,<br/>      "r":0.6728651527,<br/>      "f":0.7116012201<br/>    },<br/>    "other":{<br/>      "p":0.709381495,<br/>      "r":0.7853374063,<br/>      "f":0.7454295559<br/>    }<br/>  },<br/>  "cats_auc_per_type":{<br/>    "sarcasm":0.8028807945,<br/>    "other":0.8028807993<br/>  }<br/>}</span></pre><ul class=""><li id="0b30" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated"><code class="fe me mf mg mh b">p</code> —表示精度值</li><li id="51d1" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">r</code> —代表召回值</li><li id="0fdc" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated"><code class="fe me mf mg mh b">f</code>—f1值</li></ul><h2 id="a46f" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">打包模型</h2><p id="9403" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">工作流程的最后一步是将最佳模型作为pip包打包在<code class="fe me mf mg mh b">packages</code>文件夹中。确保在每次培训期间修改<code class="fe me mf mg mh b">project.yml</code>中的版本。它将相应地输出一个新文件夹，如下所示:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="7bf5" class="oa ne it mh b gy op oq l or os">en_textcat_sarcasm-0.0.0<br/>en_textcat_sarcasm-0.0.1<br/>en_textcat_sarcasm-0.0.2</span></pre><p id="7b9c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在每个包中，它包含以下文件和文件夹:</p><ul class=""><li id="5a0d" class="mi mj it lk b ll lm lo lp lr mk lv ml lz mm md mn mo mp mq bi translated">距离</li><li id="5845" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">en _ textcat _讽刺</li><li id="643a" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">en _ textcat _讥讽. egg-信息</li><li id="d760" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">清单. in</li><li id="d297" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">meta.json</li><li id="2f7e" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md mn mo mp mq bi translated">setup.py</li></ul><h2 id="9db0" class="oa ne it bd nf ob oc dn nj od oe dp nn lr of og np lv oh oi nr lz oj ok nt iz bi translated">部署包</h2><p id="177f" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">您可以在文件夹中运行以下命令，将它安装到您的虚拟环境中:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="31d5" class="oa ne it mh b gy op oq l or os">python setup.py</span></pre><p id="0f7a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">或者，您可以复制出底层的<code class="fe me mf mg mh b">en_textcat_sarcasm</code>文件夹，并将其直接放入Python应用程序的同一文件夹中。它将被视为另一个Python模块。因此，您可以在Python应用程序中正常调用包，如下所示:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="0966" class="oa ne it mh b gy op oq l or os">import en_textcat_sarcasm                                               </span><span id="9038" class="oa ne it mh b gy ot oq l or os">nlp = en_textcat_sarcasm.load()</span></pre><p id="3bf5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">一旦加载了模型，就可以按如下方式处理单个文本:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="7dcb" class="oa ne it mh b gy op oq l or os">doc = nlp("This is a text")</span></pre><p id="6524" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">它将返回一个空间的Doc对象。您可以通过以下方式获得基础<code class="fe me mf mg mh b">cats</code>分数:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="9bf0" class="oa ne it mh b gy op oq l or os">doc.cats</span></pre><p id="fc66" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">处理大量文本时，您应该使用<code class="fe me mf mg mh b">pipe</code>成批处理:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="a31e" class="oa ne it mh b gy op oq l or os">texts = ["This is a text", "These are lots of texts", "..."]</span><span id="8e94" class="oa ne it mh b gy ot oq l or os"># bad<br/>docs = [nlp(text) for text in texts]</span><span id="a0f4" class="oa ne it mh b gy ot oq l or os"># good<br/>docs = list(nlp.pipe(texts))</span></pre><p id="270b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">以下是打印所有文本及其相应分数的示例脚本:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="0da4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您应该在命令行中获得以下输出:</p><pre class="ks kt ku kv gt ol mh om on aw oo bi"><span id="bac7" class="oa ne it mh b gy op oq l or os">yea right, so funny<br/>{'sarcasm': 0.9599524736404419, 'other': 0.040047552436590195}</span><span id="bd2c" class="oa ne it mh b gy ot oq l or os">You forgot "Am I a joke to you" guy<br/>{'sarcasm': 0.3846711814403534, 'other': 0.615328848361969}</span><span id="03f3" class="oa ne it mh b gy ot oq l or os">Pretty ballsey for Ted to mouth off to his bosses like that.<br/>{'sarcasm': 0.2167516052722931, 'other': 0.7832483649253845}</span><span id="656e" class="oa ne it mh b gy ot oq l or os">I’m sure she is going to make an absolutely stellar cop, with no power trip agenda whatsoever<br/>{'sarcasm': 0.878804087638855, 'other': 0.12119589745998383}</span><span id="ea6a" class="oa ne it mh b gy ot oq l or os">Shut up, college boy!!<br/>{'sarcasm': 0.6504116654396057, 'other': 0.3495883643627167}</span></pre></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="3ae8" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">结论</h1><p id="954b" class="pw-post-body-paragraph li lj it lk b ll nv kd ln lo nw kg lq lr nx lt lu lv ny lx ly lz nz mb mc md im bi translated">让我们回顾一下你今天所学的内容。</p><p id="ba76" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">本文首先简要介绍了spaCy的TextCat组件和一个构建讽刺分类器模型的用例。</p><p id="918b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">然后，它继续通过<code class="fe me mf mg mh b">pip</code>或<code class="fe me mf mg mh b">conda</code>安装spaCy。除此之外，还介绍了使用Kaggle中的数据集进行数据准备以及创建相关的配置文件。</p><p id="1aca" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">接下来，介绍了整个实现过程，包括将数据集转换为spaCy的二进制格式、训练模型、模型评估以及将最佳模型打包为pip包。</p><p id="0083" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">最后，本文提供了一个示例，说明如何在Python应用程序中部署它并获得相应的分类器结果。</p><p id="7bd8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">感谢你阅读这篇文章。希望在我的下一篇文章中再次见到你！</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><h1 id="3470" class="nd ne it bd nf ng nh ni nj nk nl nm nn ki no kj np kl nq km nr ko ns kp nt nu bi translated">参考</h1><ol class=""><li id="5adb" class="mi mj it lk b ll nv lo nw lr ox lv oy lz oz md pa mo mp mq bi translated"><a class="ae lh" href="https://spacy.io/usage" rel="noopener ugc nofollow" target="_blank">安装空间——文件</a></li><li id="a060" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md pa mo mp mq bi translated"><a class="ae lh" href="https://github.com/explosion/projects/tree/v3/pipelines/textcat_demo" rel="noopener ugc nofollow" target="_blank">空间项目:演示文本猫</a></li><li id="718b" class="mi mj it lk b ll mr lo ms lr mt lv mu lz mv md pa mo mp mq bi translated"><a class="ae lh" href="https://www.kaggle.com/danofer/sarcasm" rel="noopener ugc nofollow" target="_blank">Reddit上的嘲讽——Kaggle</a></li></ol></div></div>    
</body>
</html>