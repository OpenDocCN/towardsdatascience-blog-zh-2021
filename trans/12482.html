<html>
<head>
<title>How to monitor Docker Containers with Elasticsearch, Filebeat &amp; Metricbeat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Elasticsearch、Filebeat 和 Metricbeat 监控 Docker 容器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-monitor-docker-containers-with-elasticsearch-filebeat-metricbeat-493b18681464?source=collection_archive---------11-----------------------#2021-12-21">https://towardsdatascience.com/how-to-monitor-docker-containers-with-elasticsearch-filebeat-metricbeat-493b18681464?source=collection_archive---------11-----------------------#2021-12-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/2013100acd06fe9513953807a1cfed04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RMaJr-wcFa52YRiBtQfwIg.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">集装箱——摄影<a class="ae jg" href="https://unsplash.com/@jonassmith?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">乔纳斯·史密斯</a>在<a class="ae jg" href="https://unsplash.com/s/photos/container?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><div class=""/><div class=""><h2 id="7603" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">使用弹性堆栈监控码头集装箱</h2></div><p id="5bf8" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi lu translated"><span class="l lv lw lx bm ly lz ma mb mc di"> H </span>避免多个容器分布在不同的节点上带来了跟踪容器健康状况、存储、CPU、内存利用率和网络负载的挑战。虽然您可以使用 Portainer 之类的工具来监控和跟踪您的 dockers，但是在生产环境中，Elastic stack 成为监控和维护这些工具的最佳工具(依我之见)。</p><figure class="me mf mg mh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi md"><img src="../Images/1986f98039e1cfe7bbda512938d753b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r9seOx97mu_AA0ZX.png"/></div></div></figure><p id="6ed3" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Elastic 的趋势已经转向通过弹性代理进行集成，现在包括一个 Docker 集成，它可以从 Docker 容器中获取指标。它侧重于默认情况下启用的以下指标:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="331a" class="mn mo jj mj b gy mp mq l mr ms">container<br/>cpu<br/>diskio<br/>healthcheck<br/>info<br/>memory<br/>network</span></pre><p id="3663" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">弹性代理显然是集成到弹性堆栈的未来，是非常需要的无障碍配置，但在现实中，Metricbeat 和 Filebeats 仍然非常需要，因为它们提供了更多的灵活性。目前的情况是，即使服务器上安装了弹性代理，仍有一些用例没有集成到弹性代理中。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h2 id="d881" class="mn mo jj bd na nb nc dn nd ne nf dp ng lh nh ni nj ll nk nl nm lp nn no np nq bi translated">测试环境</h2><ul class=""><li id="d3fd" class="nr ns jj la b lb nt le nu lh nv ll nw lp nx lt ny nz oa ob bi translated">Ubuntu 16.04 (Xenial Xerus) <em class="oc">(其中一些是使用 Macbook 上运行的 Docker 上的弹性堆栈在本地执行和测试的)</em></li><li id="9389" class="nr ns jj la b lb od le oe lh of ll og lp oh lt ny nz oa ob bi translated">Filebeat 7.16</li><li id="44af" class="nr ns jj la b lb od le oe lh of ll og lp oh lt ny nz oa ob bi translated">Metricbeat 7.10</li></ul></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="108f" class="oi mo jj bd na oj ok ol nd om on oo ng kp op kq nj ks oq kt nm kv or kw np os bi translated">安装 Metricbeat</h1><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="daac" class="mn mo jj mj b gy mp mq l mr ms">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-7.10.0-amd64.deb </span><span id="a845" class="mn mo jj mj b gy ot mq l mr ms">sudo dpkg -i metricbeat-7.10.0-amd64.deb</span></pre><p id="8377" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">编辑配置:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="51f9" class="mn mo jj mj b gy mp mq l mr ms">output.elasticsearch:   <br/>hosts: ["&lt;es_url&gt;"]   <br/>username: "elastic"   <br/>password: "&lt;password&gt;" <br/>setup.kibana:   <br/>host: "&lt;kibana_url&gt;"</span></pre><p id="9314" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">其中<code class="fe ou ov ow mj b">&lt;password&gt;</code>是<code class="fe ou ov ow mj b">elastic</code>用户的密码，<code class="fe ou ov ow mj b">&lt;es_url&gt;</code>是 Elasticsearch 的网址，<code class="fe ou ov ow mj b">&lt;kibana_url&gt;</code>是 Kibana 的网址。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="02cf" class="mn mo jj mj b gy mp mq l mr ms">sudo metricbeat modules enable docker </span><span id="ff8b" class="mn mo jj mj b gy ot mq l mr ms">sudo metricbeat setup //This will load all the dashboards in Kibana</span><span id="8371" class="mn mo jj mj b gy ot mq l mr ms">sudo service metricbeat start</span></pre><figure class="me mf mg mh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ox"><img src="../Images/cde0cef9e32595abf3841d2e1e0e4b45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GaIP4FYDtyrXLg8_Bdwy1w.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">斯蒂芬·查彭达玛截图<a class="oy oz ep" href="https://medium.com/u/f0493e7e1c22?source=post_page-----493b18681464--------------------------------" rel="noopener" target="_blank"/></p></figure><p id="77ed" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Metricbeat 提供的是 CPU 使用率、磁盘空间和性能相关的统计数据。但是，如果您想深入了解容器内部的情况，该怎么办呢？不幸的是，Metricbeat 不提供这种功能。因此，试图理解为什么在凌晨 2 点出现峰值意味着我们需要更深入，这就是 Filebeat 的用武之地。</p><h2 id="8349" class="mn mo jj bd na nb nc dn nd ne nf dp ng lh nh ni nj ll nk nl nm lp nn no np nq bi translated">关键资源</h2><ul class=""><li id="b059" class="nr ns jj la b lb nt le nu lh nv ll nw lp nx lt ny nz oa ob bi translated"><a class="ae jg" href="https://www.elastic.co/guide/en/beats/metricbeat/current/index.html" rel="noopener ugc nofollow" target="_blank"> Metricbeat 参考文件</a></li></ul><figure class="me mf mg mh gt iv"><div class="bz fp l di"><div class="pa pb l"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">如何安装 metric beat-by Elastic</p></figure></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h2 id="d535" class="mn mo jj bd na nb nc dn nd ne nf dp ng lh nh ni nj ll nk nl nm lp nn no np nq bi translated">容器里有什么？</h2><p id="82e4" class="pw-post-body-paragraph ky kz jj la b lb nt kk ld le nu kn lg lh pc lj lk ll pd ln lo lp pe lr ls lt im bi translated">要查看由容器本身生成的日志，我们需要安装 Filebeat 来直接查看特定路径中的容器。不幸的是，Metricbeat 没有提供这种详细程度的信息。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d726" class="mn mo jj mj b gy mp mq l mr ms">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.10.0-amd64.deb </span><span id="9b3b" class="mn mo jj mj b gy ot mq l mr ms">sudo dpkg -i filebeat-7.10.0-amd64.deb</span></pre><p id="9a93" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">修改<code class="fe ou ov ow mj b">/etc/filebeat/filebeat.yml</code>设置连接信息:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="7826" class="mn mo jj mj b gy mp mq l mr ms">output.elasticsearch:   <br/>hosts: ["&lt;es_url&gt;"]   <br/>username: "elastic"   <br/>password: "&lt;password&gt;" <br/>setup.kibana:   <br/>host: "&lt;kibana_url&gt;"</span></pre><p id="4237" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">其中<code class="fe ou ov ow mj b">&lt;password&gt;</code>是<code class="fe ou ov ow mj b">elastic</code>用户的密码，<code class="fe ou ov ow mj b">&lt;es_url&gt;</code>是 Elasticsearch 的网址，<code class="fe ou ov ow mj b">&lt;kibana_url&gt;</code>是 Kibana 的网址。在<code class="fe ou ov ow mj b">/etc/filebeat/filebeat.yml</code>中，我们还需要添加以下内容:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="ae37" class="mn mo jj mj b gy mp mq l mr ms">- type: container</span><span id="34ac" class="mn mo jj mj b gy ot mq l mr ms"># Change to true to enable this input configuration.<br/>  enabled: true</span><span id="1591" class="mn mo jj mj b gy ot mq l mr ms"># Paths that should be crawled and fetched. Glob based paths.<br/>  paths:<br/>    - /var/lib/docker/containers/*/*-json.log<br/>    </span></pre><p id="99a0" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">默认情况下，所有 docker 容器的标准输出(stdout)都被写入 JSON 文件。这些日志文件存储在运行 docker 引擎的主机上，可以在下面的路径<code class="fe ou ov ow mj b">/var/lib/docker/containers/{container-id}/{container-id}-json.log</code>下找到。</p><blockquote class="pf pg ph"><p id="018e" class="ky kz oc la b lb lc kk ld le lf kn lg pi li lj lk pj lm ln lo pk lq lr ls lt im bi translated">一个常见的错误是没有将类型指定为 container，因此要确保指定希望 filebeat 输出容器日志。</p></blockquote><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="e59f" class="mn mo jj mj b gy mp mq l mr ms">sudo filebeat setup </span><span id="dba5" class="mn mo jj mj b gy ot mq l mr ms">sudo service filebeat start</span></pre><figure class="me mf mg mh gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi pl"><img src="../Images/b85db519b366d8621582f0fafe45b0b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TutDK3UpL1HcbpTDcZ0b_g.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">斯蒂芬·查彭达玛截图</p></figure><p id="765b" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">值得注意的是 docker 日志的位置。上面提到的是 Ubuntu 服务器上的 docker 日志，但这在 MacOS 上会有所不同，就像在 Windows 上一样，所以请记住这一点。对于 Mac，这可能很难确定，因为这取决于您运行的 macOS 版本。</p><h2 id="d095" class="mn mo jj bd na nb nc dn nd ne nf dp ng lh nh ni nj ll nk nl nm lp nn no np nq bi translated">关键资源</h2><p id="7756" class="pw-post-body-paragraph ky kz jj la b lb nt kk ld le nu kn lg lh pc lj lk ll pd ln lo lp pe lr ls lt im bi translated"><a class="ae jg" href="https://www.elastic.co/guide/en/beats/filebeat/current/index.html" rel="noopener ugc nofollow" target="_blank"> Filebeat 文档</a></p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><p id="0ac0" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">斯蒂芬·查彭达玛的帖子</p></div></div>    
</body>
</html>