<html>
<head>
<title>Three ways to run Linear Mixed Effects Models in Python Jupyter Notebooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Python Jupyter笔记本中运行线性混合效果模型的三种方法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-run-linear-mixed-effects-models-in-python-jupyter-notebooks-4f8079c4b589?source=collection_archive---------4-----------------------#2021-03-22">https://towardsdatascience.com/how-to-run-linear-mixed-effects-models-in-python-jupyter-notebooks-4f8079c4b589?source=collection_archive---------4-----------------------#2021-03-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="818d" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="a5a9" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">关于如何在Python和Jupyter笔记本中运行线性混合效应回归(LMER)模型的教程</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/409f9131d9231980b110ecb0c3e204c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h4rZNfZFDsON1r_3"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated"><a class="ae lh" href="https://unsplash.com/@forest_ms?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">森林西蒙</a>在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="5844" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我不能完全从R切换到Python进行数据分析的原因之一是<a class="ae lh" href="https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf" rel="noopener ugc nofollow" target="_blank">线性混合效应模型</a>只在R中可用。线性混合效应模型是一种强大的统计方法，在处理纵向、层次或聚类数据时非常有用。简而言之，如果您的数据具有重复的样本、相关数据或自然“分组”，例如来自同一个人的重复响应、按不同地理位置聚类的数据，甚至是来自一组交互的人的数据，您可能希望在分析中使用线性混合效应模型。</p><p id="5749" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">您可以从这些资源(<a class="ae lh" href="https://www.jstor.org/stable/2290128?seq=1" rel="noopener ugc nofollow" target="_blank">林德斯特罗姆&amp;贝茨，1988 </a> ) ( <a class="ae lh" href="https://www.jstatsoft.org/article/view/v067i01" rel="noopener ugc nofollow" target="_blank">贝茨等人，2015 </a>)中了解更多关于线性混合效应模型或线性混合效应回归(LMER)如何以及为什么有效的信息，但在本教程中，我们将重点关注如何在Python <a class="ae lh" href="https://jupyter.org/" rel="noopener ugc nofollow" target="_blank"> Jupyter笔记本</a>环境中运行这些模型。在早期，人们从Python中保存数据，在R中打开数据并运行LMER模型。多年来，R &amp; Python对彼此有了更好的了解，出现了几种用Python运行LMER分析的选项。下面是我们将探讨的三个选项，我为每个选项提供了示例代码:</p><ol class=""><li id="3d8f" class="me mf it lk b ll lm lo lp lr mg lv mh lz mi md mj mk ml mm bi translated"><strong class="lk jd">统计模型中的LMER</strong></li><li id="2994" class="me mf it lk b ll mn lo mo lr mp lv mq lz mr md mj mk ml mm bi translated"><strong class="lk jd">使用rpy2和%Rmagic访问R中的LMER</strong></li><li id="fcf6" class="me mf it lk b ll mn lo mo lr mp lv mq lz mr md mj mk ml mm bi translated"><strong class="lk jd"> Pymer4无缝接入LMER R</strong></li></ol><p id="2b0a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这里有一个Google Colab Jupyter笔记本来遵循这些方法！</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ms mt l"/></div></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="3e6a" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">统计模型中的LMER</h1><p id="9411" class="pw-post-body-paragraph li lj it lk b ll nt kd ln lo nu kg lq lr nv lt lu lv nw lx ly lz nx mb mc md im bi translated">目前，最简单的开箱即用解决方案是使用<a class="ae lh" href="https://www.statsmodels.org/stable/index.html" rel="noopener ugc nofollow" target="_blank"> Statsmodels </a>包中的LMER实现(示例<a class="ae lh" href="https://www.statsmodels.org/stable/examples/notebooks/generated/mixed_lm_example.html" rel="noopener ugc nofollow" target="_blank">此处为</a>)。安装最容易，就像<code class="fe ny nz oa ob b">pip install statsmodels</code>一样简单。安装后，您可以像下面这样运行LMER。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="691c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了提供更多的背景信息，我们正在分析<code class="fe ny nz oa ob b">dietox</code>数据集(<a class="ae lh" href="https://rdrr.io/cran/geepack/man/dietox.html" rel="noopener ugc nofollow" target="_blank">在此了解更多关于数据集的信息</a>)，以预测猪的<code class="fe ny nz oa ob b">weight</code>作为<code class="fe ny nz oa ob b">time</code>的函数，其随机斜率由<code class="fe ny nz oa ob b">re_formula="~Time"</code>指定，随机截距由<code class="fe ny nz oa ob b">groups=data["Pig"]</code>自动指定。输出如下图所示，包括系数、标准误差、z统计、p值和95%置信区间。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oc"><img src="../Images/9abd41b1846d6722f134928ebd3df6da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fhUR-tYbRrr9W2avfEb0Cw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">Statsmodels LMER输出</p></figure><p id="015e" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">虽然这很好，但是用这种语法指定随机效应有些不方便，并且偏离了LMER在R中使用的传统公式表达式。例如，在R中，随机斜率和截距是在模型公式中指定的，在一行中，例如:</p><pre class="ks kt ku kv gt od ob oe of aw og bi"><span id="658e" class="oh nc it ob b gy oi oj l ok ol">lmer('Weight ~ Time + (1+Time|Pig)', data=dietox)</span></pre><p id="9342" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这导致了我们的第二个选择，即通过rpy2在Python和R之间的直接接口在R中使用LMER。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="c968" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">使用rpy2和%Rmagic访问R中的LMER</h1><p id="2122" class="pw-post-body-paragraph li lj it lk b ll nt kd ln lo nu kg lq lr nv lt lu lv nw lx ly lz nx mb mc md im bi translated">第二种选择是通过<strong class="lk jd"> rpy2 </strong>接口直接访问R中原来的LMER包。rpy2接口允许用户在Python Jupyter笔记本环境和R环境之间来回传递数据和结果。rpy2过去在安装上是出了名的挑剔，但是这些年来它变得更加稳定了。要使用这个选项，您需要在您的机器上安装R和rpy2，这可以在Google Colab中通过以下代码实现:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="e781" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">第一行使用Linux语法安装R。如果你使用的是Mac或Windows，你可以简单地按照安装说明来完成。下一组命令行安装rpy2，然后使用rpy2安装<code class="fe ny nz oa ob b">lme4</code>和<code class="fe ny nz oa ob b">lmerTest</code>包。</p><p id="81d3" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">接下来，您需要通过运行以下代码，在Jupyter笔记本单元中激活Rmagic。</p><pre class="ks kt ku kv gt od ob oe of aw og bi"><span id="3cbf" class="oh nc it ob b gy oi oj l ok ol">%load_ext rpy2.ipython</span></pre><p id="5c8a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在这之后，任何以<code class="fe ny nz oa ob b">%%R</code>开头的Jupyter笔记本单元都允许你从笔记本上运行R命令。例如，要运行我们在statsmodels中运行的模型，您需要执行以下操作:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="3da6" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">请注意，该代码以<code class="fe ny nz oa ob b">%%R</code>开头，表示该单元包含R代码。我们还使用了比statsmodels更简单的公式表达式，我们能够指定我们的分组是<code class="fe ny nz oa ob b">Pigs</code>，并且我们正在通过<code class="fe ny nz oa ob b">(1+Time|Pig)</code>估计随机斜率和截距。这将给出一些结果，如果您在r中使用过LMER，您会更加熟悉这些结果</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi om"><img src="../Images/bd249e1dc00103b7a1682dff14da7c15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4x6JBsb43vtffN16JRbqzw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">rpy2的LMER输出</p></figure><p id="ad68" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">正如我前面提到的，您也可以将您的熊猫数据帧传递给r。还记得我们之前在statsmodels部分加载的<code class="fe ny nz oa ob b">data</code>数据帧吗？我们可以将它传递给R，运行相同的LMER模型，并像这样检索系数:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="6b82" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><code class="fe ny nz oa ob b">-i data</code>将我们的Python熊猫数据帧<code class="fe ny nz oa ob b">data</code>发送到R中，我们用它来估计我们的模型<code class="fe ny nz oa ob b">m</code>。接下来，我们从带有<code class="fe ny nz oa ob b">beta &lt;- fixef(m)</code>的模型中检索贝塔系数，该系数被导出回我们的笔记本，因为我们在第一行<code class="fe ny nz oa ob b">-o betas</code>中指定了。</p><p id="2785" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这种方法最好的部分是，在运行模型之前，您可以在R环境中添加额外的代码。例如，您可能希望确保名为<code class="fe ny nz oa ob b">Evit</code>的列被识别为带有<code class="fe ny nz oa ob b">data$Evit &lt;- as.factor(data$Evit)</code>的因子，使用<code class="fe ny nz oa ob b">contrasts(data$Evit) &lt;- contr.poly</code>为该分类变量指定新的对比，或者甚至在公式本身中重新调整分类数据。当使用rpy2从r访问LMER时，所有这些都可以很容易地实现</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="65b6" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">总之，<strong class="lk jd"> rpy2接口为您提供了最大的灵活性和访问LMER和R中附加功能的能力</strong>，如果您正从R过渡到Python，您可能会更熟悉这些功能。最后，我们将使用<strong class="lk jd"> Pymer4 </strong>包来接触一个中间选项。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="e312" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">LMER与皮梅尔4</h1><p id="d062" class="pw-post-body-paragraph li lj it lk b ll nt kd ln lo nu kg lq lr nv lt lu lv nw lx ly lz nx mb mc md im bi translated"><strong class="lk jd"> Pymer4 </strong> ( <a class="ae lh" href="https://joss.theoj.org/papers/10.21105/joss.00862" rel="noopener ugc nofollow" target="_blank"> Jolly，2018 </a>)可以作为直接通过rpy2使用LMER和在Statsmodels中使用LMER实现之间的一个方便的中间地带。这个包基本上给你带来了使用R公式语法的便利，但是以一种更Pythonic化的方式，而不必处理R魔细胞。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ms mt l"/></div></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi on"><img src="../Images/dcf39174e84cf499d43bb5ebda0feedd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cFtm21ZzxQYnC6b5fFn9cQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">Pymer4的LMER输出</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oo"><img src="../Images/29dddabd3b5cab0b39466a9ea5179519.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bbBCEoka7UsucBeIC9gjWA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">估计值包括随机截距和斜率估计值。</p></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="b6c4" class="nb nc it bd nd ne nf ng nh ni nj nk nl ki nm kj nn kl no km np ko nq kp nr ns bi translated">结论</h1><p id="aac8" class="pw-post-body-paragraph li lj it lk b ll nt kd ln lo nu kg lq lr nv lt lu lv nw lx ly lz nx mb mc md im bi translated">我们介绍了在Python Jupyter笔记本环境中运行线性混合效果模型的3种方法。Statsmodels可能是最方便的，但是对于已经使用过R语法中的LMER的用户来说，这种语法可能并不熟悉。使用rpy2为您提供了最大的灵活性和能力，但这可能会变得很麻烦，因为您需要使用Rmagic在Python和R单元之间切换。Pymer4是一个很好的折衷方案，它提供了对R中LMER的方便访问，同时最小化了语言之间的切换成本。</p><p id="ad74" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">这里有一个谷歌Colab Jupyter笔记本来运行所有的教程。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="d0eb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">感谢您的阅读，并随时查看我的其他数据科学教程！</p><div class="op oq gp gr or os"><a rel="noopener follow" target="_blank" href="/four-ways-to-quantify-synchrony-between-time-series-data-b99136c4a9c9"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd jd gy z fp ox fr fs oy fu fw jc bi translated">量化时间序列数据之间同步性的四种方法</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">用于计算同步指标的样本代码和数据，包括皮尔逊相关、时滞交叉相关…</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">towardsdatascience.com</p></div></div><div class="pb l"><div class="pc l pd pe pf pb pg lb os"/></div></div></a></div><div class="op oq gp gr or os"><a rel="noopener follow" target="_blank" href="/how-to-correctly-interpret-your-continuous-and-categorical-variable-interactions-in-regressions-51e5eed5de1e"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd jd gy z fp ox fr fs oy fu fw jc bi translated">如何使用R正确解释连续变量和分类变量的相互作用</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">当你有互动时，解释系数可能是棘手的。你对它们的解释正确吗？</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">towardsdatascience.com</p></div></div><div class="pb l"><div class="ph l pd pe pf pb pg lb os"/></div></div></a></div><div class="op oq gp gr or os"><a href="https://jinhyuncheong.medium.com/membership" rel="noopener follow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd jd gy z fp ox fr fs oy fu fw jc bi translated">通过我的推荐链接加入Medium金贤昌博士</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">jinhyuncheong.medium.com</p></div></div><div class="pb l"><div class="pi l pd pe pf pb pg lb os"/></div></div></a></div></div></div>    
</body>
</html>