<html>
<head>
<title>“Isolation Forest”: The Anomaly Detection Algorithm Any Data Scientist Should Know</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">“隔离森林”:任何数据科学家都应该知道的异常检测算法</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/isolation-forest-the-anomaly-detection-algorithm-any-data-scientist-should-know-1a99622eec2d?source=collection_archive---------3-----------------------#2021-07-04">https://towardsdatascience.com/isolation-forest-the-anomaly-detection-algorithm-any-data-scientist-should-know-1a99622eec2d?source=collection_archive---------3-----------------------#2021-07-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="aa29" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过出色的无监督算法进行异常检测(也可在Scikit-learn中获得)</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/01a96052e13224f003c91b8e41aeb5a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gbfkT3OHrDTG9DsEI2nfjg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">[图片由作者提供]</p></figure><p id="fa52" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">“隔离森林”是诞生于2009年的一个高明的异常检测算法(<a class="ae lu" href="https://www.researchgate.net/publication/224384174_Isolation_Forest" rel="noopener ugc nofollow" target="_blank">此处</a>为原文)。它已经变得非常流行:它也在Scikit-learn中实现(参见<a class="ae lu" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.IsolationForest.html" rel="noopener ugc nofollow" target="_blank">文档</a>)。</p><p id="5f61" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，我们将欣赏这种算法背后的直觉之美，并借助一些例子理解它到底是如何工作的。</p><h1 id="1f13" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">“为什么异常检测如此困难？”</h1><p id="e363" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">异常(或异常值)检测的任务是识别与大多数观察值相比“非常奇怪”的数据点。</p><p id="516e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这在一系列应用中非常有用，从故障检测到发现金融欺诈，从发现健康问题到识别不满意的客户。此外，它也有利于机器学习管道，因为<a class="ae lu" href="https://axon.cs.byu.edu/papers/smith.ijcnn2011.pdf" rel="noopener ugc nofollow" target="_blank">已经证明</a>去除异常值会提高模型的准确性。</p><p id="59ff" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">异常检测之所以如此困难，是因为它是一个无人监管的问题。换句话说，我们通常没有标签来告诉我们哪些实例实际上是“异常”。或者更确切地说，即使我们有标签，也很难将异常检测框定为监督问题。事实上:</p><ul class=""><li id="a7d1" class="ms mt it la b lb lc le lf lh mu ll mv lp mw lt mx my mz na bi translated">异常很少见；</li><li id="530a" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">异常是新奇的；</li><li id="a755" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">异常各不相同。</li></ul><p id="46da" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">出于所有这些原因，监督技术通常不适合异常检测。</p><h1 id="bf2a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">隔离森林有什么特别之处</h1><p id="238a" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">传统的异常检测方法大致是:</p><ol class=""><li id="1db0" class="ms mt it la b lb lc le lf lh mu ll mv lp mw lt ng my mz na bi translated">描述“正常实例”是什么样子的(这通常涉及到聚类分析)。</li><li id="e778" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt ng my mz na bi translated">将不符合这些配置文件的所有实例标记为离群值。</li></ol><p id="a87c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">隔离森林引入的创新是，它直接从异常值开始，而不是从正常观察值开始。</p><blockquote class="nh"><p id="6671" class="ni nj it bd nk nl nm nn no np nq lt dk translated">核心思想是基于使异常独特的特征来“隔离”异常应该是非常容易的。</p></blockquote><p id="55d8" class="pw-post-body-paragraph ky kz it la b lb nr ju ld le ns jx lg lh nt lj lk ll nu ln lo lp nv lr ls lt im bi translated">从技术上讲，这转化为这样一个事实，<strong class="la iu">如果我们在所有观察值上拟合一个决策树，离群值应该比“正常”实例更接近树的根。</strong></p><p id="98d2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是什么意思？让我们用一个例子来说明这一点。</p><p id="4b4a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设我们有一个数据集，其中包含了目前活着的所有7，932，843，214个人的数据。我们想要多少变量就有多少变量:年龄、净资产、居住地、职称…</p><p id="1459" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这样的数据集中有哪些离群值？请记住，异常值不一定是错误的数据:它们只是与总体中的其他数据点非常不同的数据点。在这个例子中，杰夫·贝索斯肯定是一个异数。</p><p id="870f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在想象一下，我们可以拟合一个决策树，使得每个末端叶子包含一个且只有一个人。换句话说，这棵树完全没有修剪。如果隔离森林背后的假设是正确的，那么杰夫·贝索斯会比我自己更接近树根。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/2d5d735da25664a611b1a930f9e18744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qN0OQBW3GimthEYEaCD9NQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一棵完全未修剪的决策树，其中每一片末端叶子代表世界上的一个人[图片由作者提供]</p></figure><p id="f2f4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">作为一个局外人，杰夫·贝索斯更容易被孤立:只要问一句“他的身价超过1700亿美元吗？”就够了在近80亿人中找回他。另一方面，由于我比杰夫·贝索斯普通得多，你可能需要至少10个是非题来缩小搜索范围，直到找到我。</p><h1 id="3c99" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">在引擎盖下寻找</h1><p id="b96e" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">现在我们已经看到了隔离森林背后的主要直觉，让我们借助一些简单的数据点来尝试理解算法的确切机制。</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="3642" class="oc lw it ny b gy od oe l of og">import pandas as pd</span><span id="6646" class="oc lw it ny b gy oh oe l of og">df = pd.DataFrame({<br/>    'x': [1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 2.0],<br/>    'y': [2.1, 2.4, 3.0, 2.6, 2.2, 2.8, 3.7]<br/>}, index = ['A', 'B', 'C', 'D', 'E', 'F', 'G'])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/6fe13ba3631cde6798872aa3c19f5bc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ixt-NRlLqFPZ5dVYmPk0ig.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一些数据点[图片由作者提供]</p></figure><p id="9245" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从A到F的项目表示一个非常紧凑的点云:它们是“正常的”数据点。与这些实例相比，G可能是一个异常值:它对于<em class="oj"> x </em>和<em class="oj"> y </em>都有异常值。</p><p id="efd9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">隔离林是以树为基础的，所以让我们根据这些数据拟合一棵树:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/48351ce96ac64dcefa3e57e672baeb9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MuzuVZJjhqC716YZhM_MiA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据点上的树随机拟合。[图片由作者提供]</p></figure><blockquote class="ol om on"><p id="ac51" class="ky kz oj la b lb lc ju ld le lf jx lg oo li lj lk op lm ln lo oq lq lr ls lt im bi translated">注意，这棵树是随机生长的。</p></blockquote><p id="a4b5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里最基本的概念是<strong class="la iu">每个元素所在叶子的深度</strong>。例如，在这个树中，称为G(我们的离群值)的观察值在深度1(例如，离根节点1层)，而C在深度3。</p><p id="2c13" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">隔离林背后的想法是，平均而言，离群点将比正常实例更接近根节点(即，在更低的深度)。</strong></p><p id="c311" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在机器学习中，关键是迭代。事实上，如果我们随机拟合许多决策树，然后对不同树上的每个观察值的深度取平均值，我们会发现一个“平均深度”，它代表了一个“外部性”的经验度量。</p><h1 id="1a7c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Scikit中的隔离林-学习</h1><p id="56c6" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">让我们通过Scikit-learn的实现来看一个使用示例。</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="6176" class="oc lw it ny b gy od oe l of og">from sklearn.ensemble import IsolationForest</span><span id="9834" class="oc lw it ny b gy oh oe l of og">iforest = IsolationForest(n_estimators = 100).fit(df)</span></pre><p id="d388" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们从森林中取出前9棵树(<code class="fe or os ot ny b">iforest.estimators_[:9]</code>)并绘制它们，我们会得到:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/f6687fb40f0570c798201eeb53d5f4cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t2BuEGwS4lH5ceam2JOEMA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">隔离林的前9个(100个)决策树。每个数据点旁边的数字是它在树中的深度。[图片由作者提供]</p></figure><p id="55b2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">看一看这前9棵树，我们已经可以看到一个模式:G往往比任何其他点的深度低得多(平均1.44)。的确，第二个点是平均深度为2.78的A。</p><blockquote class="nh"><p id="9825" class="ni nj it bd nk nl nm nn no np nq lt dk translated">从概念上讲，这正是该算法的工作原理:平均深度越低，出现异常值的可能性就越大。</p></blockquote><p id="b1c6" class="pw-post-body-paragraph ky kz it la b lb nr ju ld le ns jx lg lh nt lj lk ll nu ln lo lp nv lr ls lt im bi translated">然而，在实践中，我们不能使用平均深度，因为树的深度取决于它所适合的样本数。由于这个原因，我们需要一个公式来考虑实例的总数。这是论文中提出的公式:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/5bfd8d34a495c29bbc1c4868189142d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*byGdtk1dR5wmihZJ_RZqlA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">刘提出的“另类”评分。[截图自<a class="ae lu" href="https://www.researchgate.net/publication/224384174_Isolation_Forest" rel="noopener ugc nofollow" target="_blank">此处</a></p></figure><p id="093e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">其中<em class="oj"> n </em>是实例的数量，<em class="oj"> h(x) </em>是在特定树中找到数据点的深度(<em class="oj"> E(h(x)) </em>是它在不同树中的平均值)，而<em class="oj"> H </em>是调和数。</p><p id="cdd3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="oj"> s(x，n) </em>是一个介于0和1之间的数字，其中分数越高，越有可能是异常值。</p><blockquote class="ol om on"><p id="f375" class="ky kz oj la b lb lc ju ld le lf jx lg oo li lj lk op lm ln lo oq lq lr ls lt im bi translated">注意:Scikit-learn的实现返回与上面定义的分数相反的分数。所以上面所说的仍然有效，但是带有负号。</p></blockquote><p id="0845" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们的小数据集上，分数由下式给出:</p><pre class="kj kk kl km gt nx ny nz oa aw ob bi"><span id="81a7" class="oc lw it ny b gy od oe l of og">scores = iforest.score_samples(df)</span></pre><p id="26c1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们来看看我们每一点的估计分数:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/c9756a6826366014e49ededbbba67ca7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iUd-XSVBL7IdEO6UdGv1eg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">隔离森林估计的分数[图片由作者提供]</p></figure><p id="65d1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如我们所料，G更有可能是一个离群值，因为它的分数低于所有其他分数。</p></div><div class="ab cl ow ox hx oy" role="separator"><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb"/></div><div class="im in io ip iq"><p id="60e3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">除了我们的玩具数据集，模拟算法在某些特定情况下会产生什么也很有趣。例如，如果我们在两个变量(<em class="oj"> x </em>和<em class="oj"> y </em>)上取一些大致形成圆形的数据点，这是我们将通过隔离森林获得的分数的等值线图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/f1c04a4504e87ac3c915dad97c97bf0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bORqkP7c1pK0b5ybjG4PsA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们将通过隔离林获得的分数的数据点(左)和等高线图(右)。[图片由作者提供]</p></figure><p id="14b2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有趣的是，不仅最极端的区域可能是异常值，而且位于圆圈中心的部分也可能是异常值，因为它是<em class="oj"> x </em>和<em class="oj"> y </em>的不寻常组合。</p></div><div class="ab cl ow ox hx oy" role="separator"><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb"/></div><div class="im in io ip iq"><p id="d0a4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢您的阅读！我希望这篇文章对你有用。</p><p id="18d6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我感谢反馈和建设性的批评。如果你想谈论这篇文章或其他相关话题，你可以发短信给我<a class="ae lu" href="https://www.linkedin.com/in/samuelemazzanti/" rel="noopener ugc nofollow" target="_blank">我的Linkedin联系人</a>。</p></div></div>    
</body>
</html>