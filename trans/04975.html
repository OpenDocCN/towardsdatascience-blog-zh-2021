<html>
<head>
<title>How to connect Databricks to your Azure Data Lake</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将数据块连接到Azure数据湖</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-connect-databricks-to-your-azure-data-lake-ff499f4ca1c?source=collection_archive---------6-----------------------#2021-05-01">https://towardsdatascience.com/how-to-connect-databricks-to-your-azure-data-lake-ff499f4ca1c?source=collection_archive---------6-----------------------#2021-05-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b623" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何将多个Databricks工作区连接到1个中央ADLSgen2客户</h2></div><h1 id="8fd1" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">1.介绍</h1><p id="3660" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><em class="lw"> TLTR:克隆这个</em> <a class="ae lx" href="https://github.com/rebremer/blog-databrickshubspoke-git" rel="noopener ugc nofollow" target="_blank"> <em class="lw"> git项目</em> </a> <em class="lw">，设置params并运行0_script.sh部署1个ALDSgen2 hub和N个Databricks辐条</em></p><p id="56e8" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">一个<a class="ae lx" href="https://en.wikipedia.org/wiki/Data_lake" rel="noopener ugc nofollow" target="_blank">数据湖</a>是一个集中的数据存储库，允许企业从数据中创造商业价值。Azure Databricks是一个分析数据和构建数据管道的流行工具。在这篇博客中，讨论了Azure Databricks如何以一种安全和可扩展的方式连接到ADLSgen2存储帐户。在这方面，以下是关键:</p><ul class=""><li id="00ea" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated">深度防御:ADLSgen2包含敏感数据，应该使用私有端点和Azure AD ( <a class="ae lx" href="https://docs.microsoft.com/en-us/azure/storage/common/shared-key-authorization-prevent?tabs=portal" rel="noopener ugc nofollow" target="_blank">禁用访问密钥</a>)来保护。Databricks只能使用专用链接和Azure AD访问ADLSgen2</li><li id="6882" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">访问控制:业务单元通常有他们自己的数据块工作区。应使用基于角色的访问控制(RBAC)授予多个工作区对ADLSgen2文件系统的访问权限</li><li id="28bc" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">中心/分支架构:只有一个中心网络可以使用专用链路访问ADLSgen2帐户。数据块辐条网络与集线器网络对等，以简化联网</li></ul><p id="6c1a" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">另请参见下图:</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mr"><img src="../Images/3485febcffba4d9b11967b51915065f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eze9PHDi1pCOFXSoTgTz3A.png"/></div></div><p class="nd ne gj gh gi nf ng bd b be z dk translated">1.使用集线器(H)和私有端点(PE)连接到多个数据块(DB)分支的数据湖(DL)——图片来自<a class="ae lx" href="https://www.linkedin.com/in/marc-de-droog-776a94/" rel="noopener ugc nofollow" target="_blank"> Marc de Droog </a></p></figure><p id="112d" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">在这篇博文的剩余部分，将会更详细地解释这个项目。在下一章中，项目将被部署。</p><h1 id="756b" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">2.用N个数据块工作空间设置ADLSgen2</h1><p id="6acf" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本博客的剩余部分，使用以下步骤部署项目:</p><ul class=""><li id="9c83" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated">2.1先决条件</li><li id="1c12" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">2.2通过hub network创建1个ADLSgen2帐户</li><li id="553c" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">2.3使用分支网络创建N个数据块工作区</li><li id="58e4" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">2.4使用专用链路连接数据块和ADLSgen2帐户</li><li id="2994" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">2.5使用数据块装载存储帐户</li></ul><h2 id="ee2b" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">2.1先决条件</h2><p id="9925" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">本教程需要以下资源:</p><ul class=""><li id="7409" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated"><a class="ae lx" href="https://azure.microsoft.com/en-us/free/" rel="noopener ugc nofollow" target="_blank"> Azure账户</a></li><li id="67ad" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">运行shell脚本的Azure DevOps或Ubuntu终端</li><li id="6ca8" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated"><a class="ae lx" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank">蔚蓝CLI </a></li></ul><p id="b0ef" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">最后，克隆下面的项目或在您的Azure DevOps项目中添加存储库。</p><pre class="ms mt mu mv gt nt nu nv nw aw nx bi"><span id="b8b4" class="nh kj it nu b gy ny nz l oa ob">git clone <a class="ae lx" href="https://github.com/rebremer/blog-databrickshubspoke-git" rel="noopener ugc nofollow" target="_blank">https://github.com/rebremer/blog-databrickshubspoke-git</a></span></pre><p id="774c" class="pw-post-body-paragraph la lb it lc b ld ly ju lf lg lz jx li lj ma ll lm ln mb lp lq lr mc lt lu lv im bi translated">该存储库包含5个脚本，其中0_script.sh触发了完成部署的其他4个脚本。它还包含一个params_template.sh文件。这个文件中的变量值需要用您的变量替换，并重命名为params.sh。然后您就可以运行脚本了。这4个脚本将在本博客的剩余部分讨论。</p><h2 id="45d7" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">2.2通过hub network创建1个ADLSgen2帐户</h2><p id="c08b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在脚本1_deploy_resources_1_hub.sh中，将执行以下步骤:</p><ul class=""><li id="6341" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated">创建启用了分层命名空间的ADLSgen2帐户。这允许创建文件夹和进行细粒度的访问控制</li><li id="51de" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">创建一个VNET，并向存储帐户添加一个专用端点</li><li id="6756" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">使用专用端点作为区域创建专用dns区域</li></ul><h2 id="ad89" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">2.3使用分支网络创建N个数据块工作区</h2><p id="54c2" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在脚本2_deploy_resources_N_spokes.sh中，执行以下步骤:</p><ul class=""><li id="f599" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated">创建N个数据块工作空间。工作区部署在它们自己的VNET中，并且可能部署在不同的订阅中。Databricks部署的集群只有一个<a class="ae lx" href="https://docs.microsoft.com/en-us/azure/databricks/security/secure-cluster-connectivity" rel="noopener ugc nofollow" target="_blank">私有IP </a>。</li><li id="c889" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">对于每个数据块工作区，创建一个服务主体。授予服务主体在存储帐户中对其自己的文件系统的访问权限</li></ul><h2 id="f361" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">2.4使用专用链路连接数据块和ADLSgen2帐户</h2><p id="854a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在脚本3 _ configure _ network _ N _ spokes . sh中，执行以下步骤:</p><ul class=""><li id="db29" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated">为从VNET分支到存储帐户的VNET中心的每个数据块创建一个对等关系</li><li id="d0b3" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">反之亦然，创建从集线器VNET到每个数据块分支VNET的对等关系</li><li id="9e93" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">将所有数据块虚拟网络添加到专用dns区域，以便存储帐户的专用端点可以在数据块笔记本中使用</li></ul><h2 id="380a" class="nh kj it bd kk ni nj dn ko nk nl dp ks lj nm nn ku ln no np kw lr nq nr ky ns bi translated">2.5使用数据块装载存储帐户</h2><p id="7864" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在脚本4_mount_storage_N_spokes.sh中，将执行以下步骤:</p><ul class=""><li id="4204" class="md me it lc b ld ly lg lz lj mf ln mg lr mh lv mi mj mk ml bi translated">对于每个Databricks工作区，使用Databricks REST API将安装笔记本添加到工作区</li><li id="9f1c" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">对于每个数据块工作区，将服务主体的凭证存储在数据块支持的机密范围中</li><li id="c2a7" class="md me it lc b ld mm lg mn lj mo ln mp lr mq lv mi mj mk ml bi translated">创建一个集群，并在集群上运行笔记本。Notebook将从存储帐户获取服务主体凭据，并使用存储的私有端点将其安装到存储帐户中自己的文件系统，另请参见下面的屏幕截图</li></ul><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi oc"><img src="../Images/c3a3663c3f14437769a36b844794fbbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EM2s9ZIPFM5D-ad5.png"/></div></div><p class="nd ne gj gh gi nf ng bd b be z dk translated">2.使用专用链接将数据块工作区I成功装载到ADLSgen2文件系统</p></figure><h1 id="8654" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">3.结论</h1><p id="d35a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">一个<a class="ae lx" href="https://en.wikipedia.org/wiki/Data_lake" rel="noopener ugc nofollow" target="_blank">数据湖</a>是一个集中的数据存储库，允许企业从数据中创造商业价值。Azure Databricks是一个分析数据和构建数据管道的流行工具。在这篇博客中，讨论了如何使用深度防御、Azure AD访问控制和中心/分支架构将Azure Databricks连接到ADLSgen2存储帐户，另请参见下图。</p><figure class="ms mt mu mv gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mr"><img src="../Images/3485febcffba4d9b11967b51915065f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eze9PHDi1pCOFXSoTgTz3A.png"/></div></div><p class="nd ne gj gh gi nf ng bd b be z dk translated">3.使用集线器(H)和私有端点(PE)连接到多个数据块(DB)分支的数据湖(DL)——图片由<a class="ae lx" href="https://www.linkedin.com/in/marc-de-droog-776a94/" rel="noopener ugc nofollow" target="_blank">马克·德·德鲁戈</a>提供</p></figure></div></div>    
</body>
</html>