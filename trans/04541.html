<html>
<head>
<title>Dask Delayed — How to Parallelize Your Python Code With Ease</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Dask延迟——如何轻松并行化您的Python代码</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/dask-delayed-how-to-parallelize-your-python-code-with-ease-19382e159849?source=collection_archive---------7-----------------------#2021-04-19">https://towardsdatascience.com/dask-delayed-how-to-parallelize-your-python-code-with-ease-19382e159849?source=collection_archive---------7-----------------------#2021-04-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d555" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用一个装饰器并行化任何函数</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/721310baa7224e18edad8a80bb83858c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tgMVNQdFO1eG3uyh.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Jose Castillo 在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="9456" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们都知道Python不是最快的编程语言。它的<a class="ae ky" href="https://docs.python.org/3/glossary.html#term-global-interpreter-lock" rel="noopener ugc nofollow" target="_blank"> <em class="lv">全局解释器锁</em> </a> <em class="lv"> </em> (GIL)机制一次只允许一个线程执行Python字节码。您可以通过更改解释器或实现基于进程的并行技术来避免这种限制。</p><p id="fbd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我过去曾谈论过Python中的并行性，所以如果您不熟悉这个主题，请务必查看这些文章:</p><ul class=""><li id="0258" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/python-parallelism-essential-guide-to-speeding-up-your-python-code-in-minutes-5ec71cbd88e1"> Python并行性:几分钟内加速Python代码的基本指南</a></li><li id="9854" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/concurrency-in-python-how-to-speed-up-your-code-with-threads-bb89d67c1bc9">Python中的并发性:如何用线程加速你的代码</a></li></ul><p id="7c48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些方法非常有效，但是还有一个更简单的替代方法——使用Dask库进行并行处理。</p><p id="211e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你不熟悉Dask，它基本上相当于大型数据集的熊猫。这太简单了，所以请在这里阅读更多关于库的信息。</p><p id="7cb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章的结构如下:</p><ul class=""><li id="a6a7" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">问题描述</li><li id="0ce7" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">测试:按顺序运行任务</li><li id="e402" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">测试:用Dask并行运行任务</li><li id="283d" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">结论</li></ul><p id="03f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在这里下载这篇文章的源代码。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="acc9" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">问题描述</h1><p id="94b9" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">目标是连接到<a class="ae ky" href="https://jsonplaceholder.typicode.com/" rel="noopener ugc nofollow" target="_blank">jsonplaceholder.typicode.com</a>——一个免费的假REST API。</p><p id="bdf4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将连接到几个端点并获取JSON格式的数据。总共会有六个端点。不是很多，Python很可能在几秒钟内完成任务。对于展示并行能力来说不太好，所以我们将增加一些趣味。</p><p id="465e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了获取API数据，程序还会在发出请求之间休眠一秒钟。由于有六个端点，程序应该在六秒钟内什么都不做——但是只有当调用按顺序执行时。</p><p id="5147" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下代码片段导入了所需的库，声明了一个URL列表和一个从单个URL获取数据的函数:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="7e7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们先测试一下没有并行的执行时间。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="50ae" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">测试:按顺序运行任务</h1><p id="0f2b" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">下面的代码片段在Jupyter笔记本中顺序获取数据。如果您不在笔记本环境中，请删除<code class="fe nq nr ns nt b">%%time</code> magic命令:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="a10d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">执行该单元格后，您将看到类似的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/8c8948e22a6746c58fcc98bb0fbb7842.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*9W-DvWmz0j0idCb6FooxKA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1 —顺序执行(作者提供的图片)</p></figure><p id="7c95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这并不奇怪——Python按照声明的顺序从API端点获取数据，大约花了8秒钟才完成，主要是由于调用了<code class="fe nq nr ns nt b">sleep()</code>。</p><p id="59d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事实证明，这些API调用是独立的，可以并行调用。让我们看看接下来该怎么做。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="8077" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">测试:用Dask并行运行任务</h1><p id="f32c" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">我们需要稍微修改一下代码。首先要做的是用一个<code class="fe nq nr ns nt b">delayed</code>装饰器包装我们的<code class="fe nq nr ns nt b">fetch_single</code>函数。一旦在循环之外，我们还必须对<code class="fe nq nr ns nt b">fetch_dask</code>数组中的每一项调用Dask的<code class="fe nq nr ns nt b">compute</code>函数，因为调用<code class="fe nq nr ns nt b">delayed</code>并不做计算。</p><p id="2007" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是完整的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="4dd8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用<code class="fe nq nr ns nt b">delayed</code>装饰器包装函数的替代方法是在函数声明上方使用<code class="fe nq nr ns nt b">@delayed</code>符号。随便用。</p><p id="f42a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不管怎样，执行结果如下图所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/f79ae0089c8dc6ca531b01b997c860a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ac9n_pmyqKdG_yNYAM2fOQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图2 —延迟Dask的并行执行(图片由作者提供)</p></figure><p id="5b70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，打印顺序不同。这是因为Dask被指示单独开始所有的任务。总执行时间不到1.5秒，其中1秒用于睡眠。</p><p id="5ed2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总的来说，进步很大。</p><p id="7215" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">问题仍然存在— <strong class="lb iu">返回的结果是否相同？</strong>嗯，是也不是，顺序例子中得到的值在一个列表中，而调用<code class="fe nq nr ns nt b">compute</code>后得到的值在一个元组中。</p><p id="acc4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图验证了:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/0edbb6f867d21257cb8a3b6ff1a1faa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:780/format:webp/1*QWOmsnzKeDfRnamBuy0m4Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3 —数据类型比较(作者图片)</p></figure><p id="fd3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们不能直接比较数据结构，但我们可以在将第二个数据结构转换为列表后进行比较:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/1cf1a6ddf02e0b20d7457ed14dd2e20d.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*ugPd8p-Og-CcA0RIcmL3dQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4 —内容对比(作者图片)</p></figure><p id="a45d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终的答案是肯定的——两种方法都会得到相同的结果，但是并行化的方法花费的时间要少一些。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="3f23" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">结论</h1><p id="68b1" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">对您的应用程序或数据科学管道实施并行处理需要深思熟虑。幸运的是，代码实现很简单，因为只需要两个函数。</p><p id="0f01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好消息是——您可以使用Dask来并行处理几乎任何事情。从基本的数据集加载、统计汇总到模型训练，Dask都可以处理。</p><p id="a057" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想要更高级的基于数据科学的Dask教程，请告诉我。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><p id="fba3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">喜欢这篇文章吗？成为 <a class="ae ky" href="https://medium.com/@radecicdario/membership" rel="noopener"> <em class="lv">中等会员</em> </a> <em class="lv">继续无限制学习。如果你使用下面的链接，我会收到你的一部分会员费，不需要你额外付费。</em></p><div class="ny nz gp gr oa ob"><a href="https://medium.com/@radecicdario/membership" rel="noopener follow" target="_blank"><div class="oc ab fo"><div class="od ab oe cl cj of"><h2 class="bd iu gy z fp og fr fs oh fu fw is bi translated">通过我的推荐链接加入Medium-Dario rade ci</h2><div class="oi l"><h3 class="bd b gy z fp og fr fs oh fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oj l"><p class="bd b dl z fp og fr fs oh fu fw dk translated">medium.com</p></div></div><div class="ok l"><div class="ol l om on oo ok op ks ob"/></div></div></a></div></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="3e9b" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">了解更多信息</h1><ul class=""><li id="452e" class="lw lx it lb b lc nj lf nk li oq lm or lq os lu mb mc md me bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/3-programming-books-every-data-scientist-must-read-db1d3a1a284c">每位数据科学家必读的3本编程书籍</a></li><li id="0dc3" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/how-to-make-python-statically-typed-the-essential-guide-e087cf4fa400">如何让Python静态类型化—基本指南</a></li><li id="901b" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/object-orientated-programming-with-python-everything-you-need-to-know-cb0ada963756">使用Python进行面向对象编程——您需要知道的一切</a></li><li id="8e6a" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/python-dictionaries-everything-you-need-to-know-9c2159e5ea8a"> Python字典:你需要知道的一切</a></li><li id="0780" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" rel="noopener" target="_blank" href="/introducing-f-strings-the-best-option-for-string-formatting-in-python-b52975b47b84">介绍f字符串Python中字符串格式化的最佳选项</a></li></ul></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="3a6d" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">保持联系</h1><ul class=""><li id="bef9" class="lw lx it lb b lc nj lf nk li oq lm or lq os lu mb mc md me bi translated">关注我的<a class="ae ky" href="https://medium.com/@radecicdario" rel="noopener"> Medium </a>了解更多类似的故事</li><li id="f8fb" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">注册我的<a class="ae ky" href="https://mailchi.mp/46a3d2989d9b/bdssubscribe" rel="noopener ugc nofollow" target="_blank">简讯</a></li><li id="2a88" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">在<a class="ae ky" href="https://www.linkedin.com/in/darioradecic/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上连接</li><li id="00fd" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">查看我的<a class="ae ky" href="https://www.betterdatascience.com/" rel="noopener ugc nofollow" target="_blank">网站</a></li></ul></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><p id="00fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">原载于2021年4月19日https://betterdatascience.com</em><em class="lv"><a class="ae ky" href="https://betterdatascience.com/parallelism-with-dask-delayed/" rel="noopener ugc nofollow" target="_blank"><em class="lv">。</em></a></em></p></div></div>    
</body>
</html>