<html>
<head>
<title>How to Handle Data Loading in BigQuery with Serverless Ingest Manager and Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用无服务器摄取管理器和Node.js处理BigQuery中的数据加载</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-handle-data-loading-in-bigquery-with-serverless-ingest-manager-and-node-js-4f99fba92436?source=collection_archive---------24-----------------------#2021-11-24">https://towardsdatascience.com/how-to-handle-data-loading-in-bigquery-with-serverless-ingest-manager-and-node-js-4f99fba92436?source=collection_archive---------24-----------------------#2021-11-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="5873" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="4c9a" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">文件格式、yaml管道定义、转换和事件触发器，为您提供简单可靠的数据接收管理器</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/98fc74c71249e8a3965e1001bf064c84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*QybEt7ehRPQPq_VsXH4MZg.gif"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">样本管道定义。作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><blockquote class="lj"><p id="8a55" class="lk ll it bd lm ln lo lp lq lr ls lt dk translated">-“现在，您只需使用一个'<strong class="ak"> $ npm run test' </strong>'命令，就可以从云存储中加载与您的管道定义匹配的所有文件，或者在那里创建文件时调用数据加载。</p></blockquote><p id="73a3" class="pw-post-body-paragraph lu lv it lw b lx ly kd lz ma mb kg mc md me mf mg mh mi mj mk ml mm mn mo lt im bi translated"><a class="ae mp" href="https://github.com/mshakhomirov/BigQuery-ingest-manager" rel="noopener ugc nofollow" target="_blank">代码为</a>的Github库</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi mq"><img src="../Images/9e6ed2cc7ba874492c45bdc87b0a198d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oRvRb4n9Q21dSMTgzj0ARw.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><p id="37c6" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><strong class="lw jd">您将了解如何:</strong></p><ol class=""><li id="0c3d" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt nb nc nd ne bi translated">将数据自动加载到您的数据仓库中，并使用<em class="nf">无服务器</em> (AWS Lambda)构建一个<strong class="lw jd"> <em class="nf">数据加载服务</em> </strong></li><li id="eb29" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">添加各种文件格式支持和加载不同的文件，即JSON，CSV，AVRO，拼花。</li><li id="edef" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">添加DynamoDB表来存储摄取日志，并检查文件是否已经被摄取</li><li id="169b" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">添加数据转换功能，例如，万一您想要屏蔽一些敏感数据或动态更改格式。</li><li id="44af" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">一次加载多个文件</li><li id="d5d3" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">使用<strong class="lw jd">基础设施作为代码</strong>部署您的数据加载服务，即<strong class="lw jd"> AWS Cloudformation </strong></li><li id="906c" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">如何将压缩文件加载到BigQuery</li><li id="7dbb" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">如何监控数据加载错误</li></ol><h2 id="aa11" class="nl nm it bd nn no np dn nq nr ns dp nt md nu nv nw mh nx ny nz ml oa ob oc iz bi translated">关于这个想法</h2><h2 id="0529" class="nl nm it bd nn no np dn nq nr ns dp nt md nu nv nw mh nx ny nz ml oa ob oc iz bi translated">构建数据仓库:加载数据</h2><p id="7c30" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">通常，您会希望将您的数据仓库解决方案(BigQuery、Snowflake或任何其他解决方案)放在图表的<strong class="lw jd">中心</strong>。</p><ul class=""><li id="7eb7" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated"><strong class="lw jd">轻松连接</strong>任何外部数据源，即设置一个管道从某个任意API获取数据，即像我之前写的关于<a class="ae mp" rel="noopener" target="_blank" href="/extract-data-from-paypal-api-c25c76748746">PayPal</a>【15】并保存到云中。</li><li id="9f8f" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated"><strong class="lw jd">加载</strong>数据到<strong class="lw jd"> BigQuery </strong></li><li id="a001" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated"><strong class="lw jd">转换</strong>数据，并使用Git、CI/CD创建文档化的数据管道。例如，用<strong class="lw jd">数据表单</strong>或<strong class="lw jd"> dbt </strong>。</li><li id="9445" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated"><strong class="lw jd">使用<strong class="lw jd">云形成</strong>或<strong class="lw jd">地形</strong> ( <strong class="lw jd">基础设施作为代码</strong>)简化和自动化部署</strong></li><li id="b701" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated"><strong class="lw jd">用<strong class="lw jd"> Google Data Studio </strong>创建BI报告</strong>(例如，收入对账等。)或任何其他商业智能解决方案。查看下图，了解其他选项。</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oj"><img src="../Images/22f45b2568ff019d0ab47b5961dbbc82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7pOZ9RpmaV5kza-G.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><h1 id="302a" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">现代数据堆栈工具(当然不是完整的列表):</h1><ul class=""><li id="e4ec" class="mw mx it lw b lx od ma oe md ov mh ow ml ox lt oi nc nd ne bi translated">摄入:五川，缝合</li><li id="9956" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">仓储:雪花，大查询，红移</li><li id="bb13" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">转换:dbt、数据表单、API。</li><li id="410b" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">BI: Looker，Mode，Periscope，Chartio，Metabase，Redash</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oy"><img src="../Images/4085ad070e65547d8000686f1083459c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QfGjUiW1n7aNY4-l.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><p id="2aaf" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">谈到<strong class="lw jd">数据提取和接收</strong>您可能希望使用付费和托管工具，如<strong class="lw jd"> Fivetran </strong>或<strong class="lw jd"> Stitch </strong>从任意数据源(即支付商户提供商、汇率、地理编码数据库等)提取数据。)但是如果你遵循这个指南，你将完全有能力自己做这件事。</p><h1 id="bf09" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">方案</h1><p id="ac7b" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">假设你是一名数据工程师，你正在做一个项目，将不同的数据源连接到你的数据仓库中。您的公司是一家手机游戏开发工作室，在IOS和ANDROID两个平台上销售各种产品。</p><p id="0778" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><strong class="lw jd">你的筹码</strong></p><blockquote class="oz pa pb"><p id="5a91" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><em class="it">你的开发栈是混合的，包括</em><strong class="lw jd"><em class="it">AWS</em></strong><em class="it">和</em><strong class="lw jd"><em class="it">GCP</em></strong><em class="it">。</em></p><p id="0da3" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated">你的团队经常使用Node.js。数据科学团队使用Python，但服务器和客户端数据管道是使用Node创建的。</p><p id="5bf1" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><em class="it">您的数据堆栈是现代的、事件驱动的和数据密集型的。</em></p><p id="93a8" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><em class="it">数据仓库解决方案必须具有足够的成本效益和灵活性，以便您可以添加任何所需的数据源。它必须能够轻松扩展，以满足您不断增长的数据。</em></p></blockquote><p id="5fee" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><strong class="lw jd">任务</strong></p><p id="8e29" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">所有数据来自各种数据表面的文件，即数据库、kinesis消防水带流和各种通知服务。它以不同的格式(CSV、JSON、PARQUET等)存储到您的云数据湖中。).</p><p id="6972" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">作为一名<strong class="lw jd">数据工程师</strong>，你的任务是将<strong class="lw jd">数据加载</strong>过程自动化到你的<strong class="lw jd"> BigQuery </strong>数据仓库中。你有许多任意的数据源和管道将文件送入你的AWS S3数据湖。</p><p id="40a4" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><em class="nf">现在你需要</em></p><blockquote class="lj"><p id="b8ab" class="lk ll it bd lm ln pf pg ph pi pj lt dk translated"><em class="pk">……“一个可靠的</em>服务<em class="pk">来管理文件格式，决定上传到哪个表并监控整个过程。”</em></p></blockquote><p id="b259" class="pw-post-body-paragraph lu lv it lw b lx ly kd lz ma mb kg mc md me mf mg mh mi mj mk ml mm mn mo lt im bi translated"><em class="nf">你决定使用</em><strong class="lw jd"><em class="nf">AWS Lambda</em></strong><em class="nf">函数和</em><strong class="lw jd"><em class="nf">node . js</em></strong><em class="nf">来完成这个任务。</em></p><h1 id="ad84" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">你的微服务应用逻辑:</h1><ol class=""><li id="693b" class="mw mx it lw b lx od ma oe md ov mh ow ml ox lt nb nc nd ne bi translated">您的数据连接器从一些数据源提取数据(可以是任意的，如PayPal)</li><li id="4b63" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">文件正在被保存到S3 T21的数据库中。</li><li id="9cda" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">当新文件进入您的<em class="nf"> S3数据桶</em>时，将触发数据接收。</li><li id="f355" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">该服务将处理这些文件，并为<em class="nf"> BigQuery </em>做好准备，以便将其插入到表中。该服务将决定插入哪个表。</li><li id="aa89" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">该服务将检查文件是否已经被摄取，以防止重复。您将使用<em class="nf"> AWS DynamDB </em>来保存数据加载记录。</li><li id="f086" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">捕捉数据摄取错误，并在需要时保存文件以供进一步调查。</li><li id="d416" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">现在，您可以在数据仓库中转换数据。</li><li id="9683" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">通过通知监控您的数据加载过程。如果有任何错误，您将收到一封电子邮件。</li></ol><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pl"><img src="../Images/8be0d1e8dfbfdb3c9de01b5142f79a21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B9VBn25hBYtNB_3c.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><h1 id="ef63" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">先决条件、库和设置</h1><p id="5e08" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated"><strong class="lw jd">工具</strong></p><ul class=""><li id="3d7f" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">已安装Node.js和节点包管理器</li><li id="7f01" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">对云计算(Amazon Web Services帐户)、AWS CLI和AWS SDK有基本的了解</li><li id="adb2" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">Google BigQuery和一个服务帐户来验证您的服务。</li><li id="0296" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">Shell(命令行界面)命令和脚本(高级)。</li></ul><p id="75eb" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><strong class="lw jd">技法</strong></p><ul class=""><li id="bdb2" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">对REST APIs的理解。</li><li id="8c25" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">良好的节点知识。JS(中级)。您将创建一个Lambda函数。</li><li id="5bf5" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated"><strong class="lw jd">你必须了解节点。JS基本概念，即异步函数、节点包和代码如何工作。</strong></li><li id="d495" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated"><strong class="lw jd">基本调试(控制台，打印报表)</strong></li><li id="f4c0" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated"><strong class="lw jd">循环:即用于</strong></li><li id="e8b5" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated"><strong class="lw jd">分支:if，if/else，开关</strong></li><li id="1266" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">Shell命令和脚本，就像您希望从命令行使用AWS CLI部署Lambda并能够在本地测试它一样。</li></ul><h1 id="3e88" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">我们开始吧</h1><h1 id="0266" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">第一步。如何使用无服务器(AWS Lambda)构建数据加载服务，并自动将数据加载到数据仓库中</h1><h1 id="261e" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">为您的数据湖创建新的S3存储桶</h1><p id="2807" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">用您的bucket名称替换<code class="fe pm pn po pp b">your-bigquery-project-name.test.aws</code>,并从命令行运行，例如，如果您使用AWS CLI:</p><p id="484b" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><code class="fe pm pn po pp b">aws s3 mb s3://bq-shakhomirov.bigquery.aws</code></p><p id="31dd" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">您将看到如下内容:</p><p id="b258" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><code class="fe pm pn po pp b">$ make_bucket: bq-shakhomirov.bigquery.aws</code>确认存储桶已创建。<a class="ae mp" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-commands.html#using-s3-commands-managing-buckets-creating" rel="noopener ugc nofollow" target="_blank">阅读AWS S3文档</a></p><p id="b844" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">将数据集从上传到您新创建的S3存储桶:</p><p id="8320" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><code class="fe pm pn po pp b">$ aws s3 cp ./data/payment_transaction s3://bq-shakhomirov.bigquery.aws/payment_transaction</code></p><p id="dee5" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><code class="fe pm pn po pp b">$ aws s3 cp ./data/paypal_transaction s3://bq-shakhomirov.bigquery.aws/paypal_transaction</code></p><h1 id="3850" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">创建一个空的AWS Lambda函数(Node.js)。</h1><p id="c94a" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">您可以使用<em class="nf"> AWS web控制台</em>或<em class="nf"> AWS CLI </em>来完成。这取决于您，并在本地初始化您的<code class="fe pm pn po pp b">Node.js</code>应用程序。您的微服务文件夹结构必须如下所示:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="4216" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">其中<code class="fe pm pn po pp b">bq-shakhomirov-service-account-credentials.json</code>是您的BigQuery服务帐户凭证。</p><h1 id="4e01" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">授予您的服务从数据湖桶中读取数据的权限</h1><p id="7e56" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">您可能希望从您的<strong class="lw jd"> S3数据桶</strong>中读取您的数据集文件，然后将该数据加载到您的<strong class="lw jd"> BigQuery </strong>数据仓库中。因此，您需要通过向Lambda函数的角色添加一个策略，将Lambda函数的S3访问权限授予您的bucket，如下所示:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="c52a" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">你可以在AWS文档<a class="ae mp" href="https://aws.amazon.com/blogs/security/how-to-create-an-aws-iam-policy-to-grant-aws-lambda-access-to-an-amazon-dynamodb-table/" rel="noopener ugc nofollow" target="_blank">中找到更多关于如何创建<strong class="lw jd">角色</strong>的信息。后面我会举例说明如何用</a><a class="ae mp" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"><strong class="lw jd">AWS cloud formation</strong></a>栈来做。</p><h1 id="431a" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">安装所需的依赖项</h1><p id="0797" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">安装所需的<code class="fe pm pn po pp b">node</code>模块和库，如<code class="fe pm pn po pp b">./package.json</code>所示。您将需要:</p><ul class=""><li id="5e95" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">“AWS-SDK”:“2 . 804 . 0”用于访问带有数据的S3桶</li><li id="9f5a" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">" run-local-lambda": "1.1.1 "来测试nad并在本地运行您的Lamdba</li><li id="bb78" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">“@google-cloud/bigquery”:摄取数据的“⁵.7.0”</li><li id="d41c" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">“时刻”:" . 24.0 "处理日期并创建相关的<code class="fe pm pn po pp b">file names</code> / <code class="fe pm pn po pp b">BigQuery jobIds</code></li></ul><p id="ae27" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">确保您可以在本地运行它。这个想法是通过从命令行运行<code class="fe pm pn po pp b">npm run local</code>命令来模拟一个事件(<em class="nf"> S3对象创建事件</em>)。安装“run-local-lambda”:“1 . 1 . 1”来测试并在本地运行您的Lamdba。</p><p id="9bef" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">你的<code class="fe pm pn po pp b">./package.json</code>一定是这样的:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="9d64" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">在命令行中运行<code class="fe pm pn po pp b">npm i</code>，它将安装依赖项。</p><h1 id="a149" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">app.js</h1><p id="a51b" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">在您的<code class="fe pm pn po pp b">./app.js</code>中添加<strong class="lw jd"><em class="nf">async process event()</em></strong>函数来处理事件。</p><p id="b2bd" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">您的<code class="fe pm pn po pp b">./app.js</code>看起来会像:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="9a72" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">哪里<code class="fe pm pn po pp b">./config.json</code>是你的服务<strong class="lw jd">配置文件</strong>。</p><blockquote class="oz pa pb"><p id="ef19" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><em class="it">我更喜欢用</em><strong class="lw jd"><em class="it">YAML</em></strong><em class="it">来代替，不过是口味问题。最终你会找到使用</em> <code class="fe pm pn po pp b"><em class="it">npm config</em></code> <em class="it">和</em> <strong class="lw jd"> <em class="it"> yaml的解决方案。</em> </strong> <em class="it">对你的</em><strong class="lw jd"><em class="it"/></strong><em class="it">来说似乎是正确的事情。</em></p></blockquote><p id="09b6" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">你的<code class="fe pm pn po pp b">./config.json</code>的例子可以有<strong class="lw jd">现场</strong>和<strong class="lw jd">登台</strong>环境设置，看起来像这样:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><blockquote class="oz pa pb"><p id="f244" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><em class="it">使用配置文件定义逻辑、表名以及如何为这些表选择相关文件。</em></p></blockquote><p id="f913" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><strong class="lw jd">使用上面的这个配置文件，您的数据加载服务将尝试将</strong> <code class="fe pm pn po pp b">name</code> <strong class="lw jd">键与相关文件名</strong> <code class="fe pm pn po pp b">fileKey</code> <strong class="lw jd">匹配。如果它在S3事件中找到匹配，那么它将开始加载数据。</strong></p><h1 id="b28b" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">BigQuery凭据文件</h1><p id="6199" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated"><code class="fe pm pn po pp b">./bq-shakhomirov-b86071c11c27.json</code>是<strong class="lw jd"> BigQuery </strong>凭证文件的一个例子。你将需要这个<strong class="lw jd"> <em class="nf">服务帐户凭证</em> </strong>文件来通过谷歌认证你的微服务，这样它实际上可以做一些事情。点击阅读更多关于<a class="ae mp" href="https://cloud.google.com/docs/authentication/production" rel="noopener ugc nofollow" target="_blank">服务账户认证的信息。只需从你的<em class="nf">谷歌云平台</em>账号下载，添加到你的应用文件夹。</a></p><p id="724e" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">看起来应该是这样的:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><h1 id="b679" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">如何检查BigQuery中是否存在表</h1><p id="6a28" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">您可能希望在加载数据之前执行此操作。将这个函数添加到您的<code class="fe pm pn po pp b">./app.js</code>文件的<code class="fe pm pn po pp b">processEvent()</code>中。如果表不存在，它将使用配置文件中的模式并创建一个。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="ccde" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">这个函数将在名为<code class="fe pm pn po pp b">source</code>的数据集中创建一个带有配置文件模式的表。它也应该来自<code class="fe pm pn po pp b">./config.json</code>，但这只是一个例子。</p><h1 id="cb60" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">如何将JSON文件流式加载到BigQuery中</h1><p id="4fb9" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">这将是一个<strong class="lw jd"> <em class="nf">逐行</em> </strong>的插入操作。</p><p id="b765" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">当一行不符合模式时，只有该特定行会被插入，而不是BigQuery中的<strong class="lw jd"> <em class="nf">批量插入</em> </strong>(一行模式验证失败—所有文件上传失败)。</p><p id="7cd1" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">您可能想要添加一个新功能:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="5142" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">这只是一个例子，其中已经声明了JSON数据(不需要从本地文件或者从<strong class="lw jd"> <em class="nf">云存储</em> </strong>)并且已经创建了表。<code class="fe pm pn po pp b">simple_transaction</code>是一个简单的表，只有3列:<code class="fe pm pn po pp b">transaction_id</code>、<code class="fe pm pn po pp b">user_id</code>和<code class="fe pm pn po pp b">dt</code>，在<code class="fe pm pn po pp b">./config.json</code>模式中为名为<code class="fe pm pn po pp b">simple_transaction</code>的表定义。试试看，它会将数据逐行插入BigQuery表中。</p><p id="14a2" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">您可以稍微调整此函数，例如从<strong class="lw jd">本地文件</strong>中读取数据，它将处理新的行分隔文件<code class="fe pm pn po pp b">./data/simple_transaction</code>并创建一个<a class="ae mp" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/Job#JobConfigurationLoad" rel="noopener ugc nofollow" target="_blank">加载作业操作</a>来代替我们之前使用的<a class="ae mp" href="https://googleapis.dev/nodejs/bigquery/latest/Table.html#createWriteStream" rel="noopener ugc nofollow" target="_blank">写流</a>。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><h1 id="2bad" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">如何从AWS S3加载JSON新行分隔数据</h1><p id="567b" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">如果你的数据是新行分隔的JSON(big query加载JSON数据的自然方式),那么你需要一个像下面这样的函数。该功能将执行以下操作:</p><ol class=""><li id="b2fc" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt nb nc nd ne bi translated">从<strong class="lw jd"> AWS S3 </strong>创建一个读取流并读取文件</li><li id="8561" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">使用<a class="ae mp" href="https://github.com/dominictarr/JSONStream" rel="noopener ugc nofollow" target="_blank"> <em class="nf"> JSONStream </em> </a>模块解析JSON文件中的数据</li><li id="a1f3" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">在BigQuery中创建一个<strong class="lw jd"> <em class="nf">批处理</em> </strong>加载作业。</li></ol><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="162e" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">把这个加到你的<code class="fe pm pn po pp b">./app.js</code>里，试试<code class="fe pm pn po pp b">npm run test</code>。将<code class="fe pm pn po pp b">./test/data.json</code>修改为<code class="fe pm pn po pp b">object.key = 'simple_transaction</code>:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="743f" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">您的“simple_transaction”文件内容应该如下所示:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><blockquote class="oz pa pb"><p id="d3dd" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><em class="it">那么</em> <strong class="lw jd"> <em class="it"> BigQuery流插入</em> </strong> <em class="it">和</em> <strong class="lw jd"> <em class="it">批量</em> </strong> <em class="it">插入操作有什么区别呢？</em></p></blockquote><p id="27a4" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">它仍然是一个作业(不是像我们上面做的那样<strong class="lw jd"><em class="nf">big query streaming</em></strong>insert ),但是在架构方面它是非常高效的内存，并且<strong class="lw jd"> <em class="nf">是空闲的</em> </strong>。您只需要不超过每天每个表的批处理作业配额。我之前在这里写过如何在BigQuery 中监控<strong class="lw jd">批量加载作业操作:</strong></p><div class="ps pt gp gr pu pv"><a rel="noopener follow" target="_blank" href="/monitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa"><div class="pw ab fo"><div class="px ab py cl cj pz"><h2 class="bd jd gy z fp qa fr fs qb fu fw jc bi translated">使用Data Studio监控您的BigQuery成本并报告使用情况</h2><div class="qc l"><h3 class="bd b gy z fp qa fr fs qb fu fw dk translated">简单有效的仪表板。具有实际的报告名称、用户和标签。包括方便的模板。</h3></div><div class="qd l"><p class="bd b dl z fp qa fr fs qb fu fw dk translated">towardsdatascience.com</p></div></div><div class="qe l"><div class="qf l qg qh qi qe qj lb pv"/></div></div></a></div><blockquote class="oz pa pb"><p id="a740" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated">很好，但可能会产生更高的费用。</p></blockquote><p id="35c7" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">我建议尽可能使用<code class="fe pm pn po pp b">batch</code> insert。每个表每天有2000个插入的配额，但是您可以一次插入整个文件。<strong class="lw jd"> <em class="nf">流媒体插入</em> </strong>没那么便宜，每GB 0.05美元，1TB 50美元。</p><blockquote class="lj"><p id="19f5" class="lk ll it bd lm ln pf pg ph pi pj lt dk translated">流式插入是导入数据的推荐方式，因为它是可伸缩的。</p></blockquote><p id="8bd4" class="pw-post-body-paragraph lu lv it lw b lx ly kd lz ma mb kg mc md me mf mg mh mi mj mk ml mm mn mo lt im bi translated">然而，如果数据湖中的文件相对较小(这通常发生在使用数据流时，即Kinesis或Kafka ),这不会产生很大的影响。在这里阅读更多关于<a class="ae mp" href="https://cloud.google.com/bigquery/quotas" rel="noopener ugc nofollow" target="_blank">大查询配额和限制的信息</a></p><h1 id="cd7d" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">如何用Node.js和AWS Lambda微服务将CSV数据加载到BigQuery表中</h1><p id="c176" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">您可能希望添加一个函数，该函数从S3对象读取数据，并将其作为<strong class="lw jd"> CSV </strong>上传到BigQuery表中:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="69c6" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">这是一个从S3读取一个<strong class="lw jd"> CSV </strong>文件的例子，理想情况下，你会希望在<em class="nf"> Node.js流</em>模式下这样做以节省你的内存，而不是将整个文件读入内存。它创建一个<strong class="lw jd"> <em class="nf">可读流</em> </strong>然后流入<strong class="lw jd"> <em class="nf">流可写</em> </strong>到BigQuery。</p><h1 id="a25f" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">局部解决</h1><p id="fccc" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">这是这个项目的<code class="fe pm pn po pp b">app.js</code>。这是一个简化的应用程序。复制此文件并使用它来开发您的解决方案。</p><p id="0f2c" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">您必须创建自己的BigQuery服务帐户凭证，例如，像我一样下载<code class="fe pm pn po pp b">./bq-shakhomirov-b86071c11c27.json</code>并创建自己的<code class="fe pm pn po pp b">./config.json</code>来定义表模式和应用程序环境。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="b150" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><strong class="lw jd">该<em class="nf">应用</em>执行以下操作:</strong></p><ol class=""><li id="2031" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt nb nc nd ne bi translated">当您运行<code class="fe pm pn po pp b">$npm run test</code>时，它将使用来自<code class="fe pm pn po pp b">./test/data.json</code>的有效载荷来描述S3文件的位置(查看<code class="fe pm pn po pp b">./package.json</code>中的脚本)</li><li id="0a98" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">然后，它将从<code class="fe pm pn po pp b">./config.json</code>获取设置，即凭证位置等。并使用<strong class="lw jd"> BigQuery API </strong>进行认证</li><li id="b3c1" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">它将遍历<code class="fe pm pn po pp b">./config.json</code>中描述的表格，试图在有效载荷中找到一个匹配。<strong class="lw jd">本例中的有效载荷</strong>模拟<strong class="lw jd"> S3对象创建的</strong> <a class="ae mp" href="https://stackoverflow.com/questions/7985599/notification-of-new-s3-objects" rel="noopener ugc nofollow" target="_blank">事件</a>。</li><li id="87df" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">如果找到匹配，服务将尝试从S3获取该文件，并将其中的数据加载到相关的<strong class="lw jd"> BigQuery </strong>表中。</li><li id="a5c3" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">它将检查表格是否存在，如果不存在，它将使用<code class="fe pm pn po pp b">./config.json</code>的模式创建一个新的表格</li></ol><h1 id="e689" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">添加DynamoDB来保存数据摄取记录</h1><p id="f664" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">如果您需要处理加载作业的复制尝试，那么您可能会想要创建一个新表，并保留摄取文件的记录。那么您可以考虑将这个片段添加到您的应用程序中，在<code class="fe pm pn po pp b">./app.js</code>:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="9a60" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">如果你添加类似于<code class="fe pm pn po pp b">await logSuccessfulEvent(sourceBucket, fileKey, now.format('YYYY-MM-DDTHH:mm:ss'));</code>的东西，它将开始记录成功摄取的文件，但是你需要首先创建一个表:进入AWS <a class="ae mp" href="https://us-east-2.console.aws.amazon.com/dynamodb/home?region=us-east-2#gettingStarted:" rel="noopener ugc nofollow" target="_blank">控制台</a>:</p><ul class=""><li id="7161" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">为成功获取的文件创建一个名为<code class="fe pm pn po pp b">ingestManager</code>的表。</li><li id="c71e" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">向您的Lambda添加访问Dynamo表的权限。</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qk"><img src="../Images/9c58d7d8d8b25623c45069d5acbae88b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XfPkVFblkNjRgv-X.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><ul class=""><li id="fbf6" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">将处理<code class="fe pm pn po pp b">successfull</code>事件的<code class="fe pm pn po pp b">logSuccessfulEvent</code>函数添加到<code class="fe pm pn po pp b">./app.js</code>文件:</li></ul><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="d671" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">因此，您应该会看到创建了一个新的摄取记录:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ql"><img src="../Images/45916f3aa2aec4556a4c23d8b9829251.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XH0Li7FZMlrM310z.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><p id="77a6" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">现在，您可能想要添加一个新函数。姑且称之为<code class="fe pm pn po pp b">checkAlreadyIngested()</code>。</p><blockquote class="oz pa pb"><p id="f180" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><em class="it">此函数将检查您的数据加载管道是否有任何复制企图，并防止这些复制企图。</em></p></blockquote><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="4074" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">确保用<code class="fe pm pn po pp b">try, catch</code>块包裹即可。</p><h1 id="30d4" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">如何监控BigQuery数据加载服务中的错误和复制尝试</h1><p id="a0fc" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">…或者任何其他数据仓库。</p><p id="3178" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">您可能想在每次出现错误时收到通知。</p><ul class=""><li id="7bc3" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">使用简单通知服务(SNS)创建一个<strong class="lw jd"> AlarmNotificationTopic </strong>，以便在出现任何摄取错误时通过电子邮件接收通知。</li><li id="8d51" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">当您创建Lambda并附加策略时，它一定已经创建了一个<strong class="lw jd"> LogGroupName </strong> : <code class="fe pm pn po pp b">/aws/lambda/ingestManager</code>或类似的东西。使用它创建<strong class="lw jd"> ERRORMetricFilter </strong>，其中<em class="nf">错误计数&gt; 0 </em>。例如，我的日志组如下所示:</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qm"><img src="../Images/f1d5f5ab3745bf6f628ee46c40ad16e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_8BvFq0ivmt0td6c.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片</p></figure><ul class=""><li id="67d0" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">使用以下模式创建一个ERROR metric filter:filter pattern:' ERROR '调用它<code class="fe pm pn po pp b">ingestManagerStagingMetricFilter</code></li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qn"><img src="../Images/22b52769f4d6183b844a785b183f7e28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vlw7qXfzeb1dz9Yz.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><ul class=""><li id="fc44" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">现在去<code class="fe pm pn po pp b">SNS</code>创建你的提醒主题:</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qo"><img src="../Images/fbdc49a0be5c04b51655a5ad6d87f087.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bh2WdZs4vPwrPVyG.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><ul class=""><li id="2aea" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">单击创建订阅并输入您的电子邮件:</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qp"><img src="../Images/cff096d16ef42aa86cf8c5d126a6dac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j1VcaszhXR5lfb4t.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><ul class=""><li id="301c" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">最后创建<a class="ae mp" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cw-alarm.html" rel="noopener ugc nofollow" target="_blank"><strong class="lw jd">ERROR metric alarm</strong></a>动作，当数字误差连续5分钟大于5时触发报警。它应该发送通知到您的社交网站的主题。</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qq"><img src="../Images/830bf0ec77d22813b35b31d8e729c94a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DqeibXTWCkvOxuTK.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qr"><img src="../Images/1f0b8e0a432f9bfd71813c77d550c941.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pO2BWiS9KSx-8y5_.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><ul class=""><li id="946f" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">选择遇到警报时发送通知的位置:</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qs"><img src="../Images/9b198744bad361da500dad0185cd3a21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gE4iAm_ie_USuFSk.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><ul class=""><li id="fd23" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">在摄取管理器出错的情况下，期望的输出是一个通知:</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi qt"><img src="../Images/bdf01a88d615724a62d4ba40853e8b64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NZ9PzOgU2a7hOpCg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">作者图片<a class="lh li ep" href="https://medium.com/u/e06a48b3dd48?source=post_page-----4f99fba92436--------------------------------" rel="noopener" target="_blank">💡迈克·沙克霍米罗夫</a></p></figure><blockquote class="oz pa pb"><p id="d358" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><em class="it">理想情况下，你会希望使用类似于</em><strong class="lw jd"><em class="it">AWS cloud formation</em></strong><em class="it">的东西来管理你的</em> <strong class="lw jd">基础设施，代码为</strong> <em class="it">。</em></p></blockquote><p id="b82c" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">示例堆栈文件可以在本教程的<a class="ae mp" href="https://github.com/mshakhomirov/BigQuery-ingest-manager" rel="noopener ugc nofollow" target="_blank"> Github库</a>中找到。</p><h1 id="b0f5" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">如何转换原始数据湖文件中的数据并为BigQuery做准备</h1><p id="4bf5" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">自然地，<strong class="lw jd"> BigQuery </strong>可以使用<a class="ae mp" href="http://ndjson.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="lw jd">新行分隔的JSON </strong> </a>或者其他已经正确形成的格式。因此，如果你正在加载<code class="fe pm pn po pp b">ndJSON</code>，那么它应该在那之前被新行分隔:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="d633" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">现在假设您有另一个服务从<strong class="lw jd"> <em class="nf"> MySQL数据库</em> </strong>中提取数据，它的输出看起来像一个JSON对象数组:<code class="fe pm pn po pp b">[{...},{...},{...}]</code>。这些单独的JSON对象也可以深度嵌套。您可能希望将它转换成<code class="fe pm pn po pp b">nldj</code> : <code class="fe pm pn po pp b">'{...}'\n'{...}'\n'{...}'\n</code>，这样BigQuery就可以将它装载到表中。</p><p id="ad41" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">或者想象你正在使用标准的<strong class="lw jd">消防软管</strong>输出，其中数据被写成一串<code class="fe pm pn po pp b">JSON</code>对象<code class="fe pm pn po pp b">{...}{...}{...}</code>。没有逗号。您可能需要为从<strong class="lw jd"><em class="nf">OBJECT _ STRING</em></strong>到<strong class="lw jd"> <em class="nf"> SRC </em> </strong> variant格式的<strong class="lw jd"> BigQuery </strong>(转换为<code class="fe pm pn po pp b">nldj</code>)准备数据，即<code class="fe pm pn po pp b">{...}{...}{...}</code> &gt; &gt; &gt; <code class="fe pm pn po pp b">'{...}'\n'{...}'\n'{...}'\n</code>。</p><p id="a6cb" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">看到里面的使徒了吗？这将把它定义为类型<code class="fe pm pn po pp b">STRING</code>，并且您需要创建一个只有一列的表:<code class="fe pm pn po pp b">name: "src", type: "STRING"</code>。</p><p id="9169" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">这可能是一个具有挑战性的任务，但我写了一些方便的助手函数。你以后会找到它们的。</p><blockquote class="oz pa pb"><p id="f572" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><em class="it">因此，只需在您的</em> <code class="fe pm pn po pp b"><em class="it">config</em></code> <em class="it">中添加文件格式规范，就可以定义处理逻辑并正确地将所有文件加载到</em><strong class="lw jd"><em class="it">big query</em></strong><em class="it">中。</em></p></blockquote><p id="323f" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">例如，您可能希望在<code class="fe pm pn po pp b">yaml</code>配置中定义您的表，如下所示:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="0fb0" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">第一个名为<code class="fe pm pn po pp b">paypal_transaction</code>的<code class="fe pm pn po pp b">pipe</code>有一个单独JSON对象的数组(深度嵌套),您可能希望将每个单独的嵌套对象作为一个JSON记录插入，这样您就可以稍后在您的<strong class="lw jd">数据仓库</strong>中用<code class="fe pm pn po pp b">JSON_PARSE</code>函数<strong class="lw jd">解析</strong>它。</p><p id="baa8" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">第二个管道<code class="fe pm pn po pp b">GeoIP2-Country-Blocks-IPv4</code>需要从CSV中解析出来，并插入到<strong class="lw jd"> BigQuery </strong>表中，相关的模式有六列。这里您可能希望显式声明一个<strong class="lw jd"> CSV分隔符</strong>来帮助BigQuery加载数据。</p><p id="f9be" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">第三个表示一些配置不佳的Kinesis流输出，需要作为JSON插入，但必须首先为BigQuery做好准备(转换为NLDJ格式)。</p><p id="f222" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">第四个也需要作为<strong class="lw jd"> NLDJ </strong>加载，但是它被压缩了，所以你想先解压缩它。</p><h1 id="253a" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">如何将压缩文件加载到BigQuery</h1><p id="0fd8" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">如果你的文件是压缩的，那么你会想先用<code class="fe pm pn po pp b">zlib</code>库解压它。您可能想要添加一个功能<code class="fe pm pn po pp b">loadGzJsonFileFromS3()</code>。因此，在本例中，我们首先<strong class="lw jd">解压缩</strong>文件，然后<em class="nf">将该流通过管道</em>传输到<strong class="lw jd"> JSONparse </strong>，后者将提取我们需要的JSON，并且<em class="nf">将</em>通过管道<strong class="lw jd"> createWriteStream </strong>传输到BigQuery。</p><blockquote class="oz pa pb"><p id="a643" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated">用这种方法你可以非常有效地加载大文件。</p></blockquote><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="5c16" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">在这个代码为的<a class="ae mp" href="https://github.com/mshakhomirov/BigQuery-ingest-manager" rel="noopener ugc nofollow" target="_blank"> Github库中有更多的例子，包括这些加载函数的分支。例如，一个名为<code class="fe pm pn po pp b">checkSourceFileFormatAndIngest()</code>的函数定义了如何转换数据格式的逻辑，然后将数据加载到<strong class="lw jd"> BigQuery </strong>中。</a></p><blockquote class="lj"><p id="7c42" class="lk ll it bd lm ln pf pg ph pi pj lt dk translated">在上面的例子中，我还使用了定制的BigQuery jobIds。这是在BigQuery中防止重复的另一种方法。</p></blockquote><blockquote class="oz pa pb"><p id="3b68" class="lu lv nf lw b lx ly kd lz ma mb kg mc pc me mf mg pd mi mj mk pe mm mn mo lt im bi translated"><em class="it">在这种情况下你不需要</em><strong class="lw jd"><em class="it">DynamoDB</em></strong><em class="it">但是我仍然使用并插入额外的度量，即插入 <em class="it">的</em> <strong class="lw jd">行数和一个</strong></em> <strong class="lw jd">表名</strong> <em class="it">来生成统计数据。</em></p></blockquote><h1 id="96ae" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">如何使用AWS Cloudformation部署服务</h1><p id="aacb" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">我不想用<strong class="lw jd"> AWS控制台</strong>创建所有那些资源。<strong class="lw jd"> AWS Cloudformation </strong>是一种简单的方法，只需点击一下鼠标，即可自动部署和配置所有资源。</p><blockquote class="oz pa pb"><p id="ed02" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><em class="it">除其他优势外，您会发现创建生产和试运行环境以及整理(删除)所有资源非常简单。</em></p></blockquote><blockquote class="lj"><p id="176b" class="lk ll it bd lm ln lo lp lq lr ls lt dk translated">这个教程实际上是免费的，那些工具不会花费你任何东西。</p></blockquote><p id="3bb1" class="pw-post-body-paragraph lu lv it lw b lx ly kd lz ma mb kg mc md me mf mg mh mi mj mk ml mm mn mo lt im bi translated">用代码在<a class="ae mp" href="https://github.com/mshakhomirov/BigQuery-ingest-manager" rel="noopener ugc nofollow" target="_blank"> Github库中检查。</a></p><p id="b985" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">在<code class="fe pm pn po pp b">./stack/cf-config.yaml</code>中，你会发现<strong class="lw jd"> AWS Cloudformation </strong>模板描述了本教程可能需要的所有资源。包括例如<strong class="lw jd"> AWS Lambda角色</strong>:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="6d7f" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">要在您的<strong class="lw jd"> AWS帐户</strong>中部署服务，请转到<code class="fe pm pn po pp b">./stack</code>并在命令行中运行这两个命令:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="8626" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">那个<code class="fe pm pn po pp b">lambdas.bq-shakhomirov.aws</code>是你的服务工件的S3桶，你的lambda代码将保存在那里。换成你的。</p><h1 id="c59a" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">如何一次将所有文件加载到BigQuery表中</h1><p id="72de" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">当您需要在选定的时间范围内(即特定日期)将所有文件从数据湖中一次性<code class="fe pm pn po pp b">load / reload</code>到您的数据仓库中时，这种多文件上传功能可能会很有用。</p><blockquote class="lj"><p id="dfb0" class="lk ll it bd lm ln pf pg ph pi pj lt dk translated">如果需要，该服务必须能够扫描您的数据湖，并挑选符合您需要的描述和时间分区的文件。</p></blockquote><p id="9ac3" class="pw-post-body-paragraph lu lv it lw b lx ly kd lz ma mb kg mc md me mf mg mh mi mj mk ml mm mn mo lt im bi translated">假设您的数据湖有来自不同来源的文件保存在<strong class="lw jd"> AWS S3 </strong>中，具有<strong class="lw jd"> <em class="nf">关键字</em> </strong>前缀，其中包含<strong class="lw jd">大查询</strong> <code class="fe pm pn po pp b">table name</code>和<code class="fe pm pn po pp b">date</code>分区，即:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="d406" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">所以在这里，您会希望您的服务扫描数据湖桶，并只选择与这三个<code class="fe pm pn po pp b">pipes</code> : <code class="fe pm pn po pp b">paypal_transaction</code>、<code class="fe pm pn po pp b">simple_transaction</code>和<code class="fe pm pn po pp b">some-other-transaction</code>相关的文件，并带有日期前缀<code class="fe pm pn po pp b">2021/10/04</code>。</p><p id="0158" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">然后，您会希望<strong class="lw jd">摄取管理器</strong>生成一个最终的<code class="fe pm pn po pp b">payload</code>，其中包含找到的所有文件密钥，并将它们加载到BigQuery中。</p><blockquote class="oz pa pb"><p id="6f91" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated"><code class="fe pm pn po pp b">./test/data.json</code>的最终<code class="fe pm pn po pp b">payload</code>应该在数据湖中找到所有文件:</p></blockquote><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><blockquote class="oz pa pb"><p id="d687" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated">在你的本地文件夹中有了这个 <code class="fe pm pn po pp b"><em class="it">payload</em></code> <em class="it">你就可以在你的命令行中运行</em> <code class="fe pm pn po pp b"><em class="it">$ npm run test</em></code> <em class="it">(如果你的有效负载在</em> <code class="fe pm pn po pp b"><em class="it">./test/data.json</em></code> <em class="it">)你的微服务会把这些文件一个一个的加载到</em><strong class="lw jd"><em class="it">big query</em></strong><em class="it">中。</em></p></blockquote><p id="27f7" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">我在我的<code class="fe pm pn po pp b">./package.json</code>中添加了脚本来运行这些命令。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><ol class=""><li id="7ca5" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt nb nc nd ne bi translated">例如，如果我在命令行中运行<code class="fe pm pn po pp b">$ npm run test-service</code>，那么<code class="fe pm pn po pp b">./loadTestIngestManager.js</code>中的应用程序将使用<code class="fe pm pn po pp b">test/integration/loadTestPipelines.json</code>中的<strong class="lw jd">管道定义</strong>扫描数据湖，并生成一个包含所有找到的文件的输出。它会将其保存到<code class="fe pm pn po pp b">test/integration/loadTestPayload.json</code>。</li><li id="1f9a" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt nb nc nd ne bi translated">然后，如果我运行<code class="fe pm pn po pp b">$ npm run test-load</code> <code class="fe pm pn po pp b">./app.js</code>，摄取管理器将使用文件的有效负载，并将它们发送到<strong class="lw jd"> BigQuery </strong>。</li></ol><blockquote class="lj"><p id="8f8c" class="lk ll it bd lm ln lo lp lq lr ls lt dk translated">使用这些脚本，您可以轻松地为加载到BigQuery中的文件和格式编写集成测试。</p></blockquote><p id="e0de" class="pw-post-body-paragraph lu lv it lw b lx ly kd lz ma mb kg mc md me mf mg mh mi mj mk ml mm mn mo lt im bi translated">您可能注意到上面的<code class="fe pm pn po pp b">payload.json</code>与<code class="fe pm pn po pp b">original S3 Obj created</code>事件负载略有不同:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="2809" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">那只是因为在我的环境中，我有另一个由<code class="fe pm pn po pp b">S3 Obj created</code>事件触发的<code class="fe pm pn po pp b">orchestrator</code>服务，它将为<code class="fe pm pn po pp b">ingest-manager</code>创建有效负载。该服务可以执行您需要的任何其他功能，并且它会在需要时<code class="fe pm pn po pp b">invoke</code> <strong class="lw jd">摄取管理器</strong>。</p><p id="4d20" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">随意调整<strong class="lw jd">摄取管理器</strong>的有效载荷。您可能希望在<code class="fe pm pn po pp b">processEvent()</code>函数中为<code class="fe pm pn po pp b">event</code>处理添加<code class="fe pm pn po pp b">S3</code>键。</p><h1 id="9626" class="ok nm it bd nn ol om on nq oo op oq nt ki or kj nw kl os km nz ko ot kp oc ou bi translated">结论</h1><p id="8f53" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">您刚刚学习了如何为用Node编写的BigQuery  创建一个简单可靠的摄取管理器。带有一些<strong class="lw jd"> <em class="nf">牛逼功能</em> </strong>的JS:</p><ul class=""><li id="4de9" class="mw mx it lw b lx mr ma ms md my mh mz ml na lt oi nc nd ne bi translated">无服务器设计和<em class="nf"> AWS Lambda功能</em>。</li><li id="4001" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">非常<strong class="lw jd">性价比</strong>。针对<strong class="lw jd">批量加载作业</strong>进行了优化，这意味着您无需为数据加载付费。基本上它是免费的，但检查BigQuery负载作业限制。</li><li id="6e64" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">可以使用<em class="nf">流式</em>插入(BigQuery流式加载)。</li><li id="eb8a" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">为<strong class="lw jd"> AWS </strong>量身定制但可以轻松迁移到<strong class="lw jd"> <em class="nf"> GCP，Azure </em> </strong>。</li><li id="c26a" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated"><strong class="lw jd"> <em class="nf">用AWS Cloudformation构建的代码为</em> </strong>的基础设施。在任何其他AWS帐户中一键部署。</li><li id="a3e6" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">使用AWS Dynamo进行有效的负载作业监控和文件重复处理。</li><li id="11a2" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">自定义BigQuery作业id。如果你不想使用Dynamo，另一个防止复制的方法是。</li><li id="e157" class="mw mx it lw b lx ng ma nh md ni mh nj ml nk lt oi nc nd ne bi translated">支持单元和集成测试。</li></ul><p id="f838" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">许多人认为Python是完成这项任务的最佳选择，但是我不同意。所有的选择都是好的，只要他们能完成工作。以前我写过如何用Python写代码，Python是我最喜欢的编程语言之一。我的大部分生产管道都是用<strong class="lw jd"> Python </strong>或<strong class="lw jd"> Java </strong>编写的。</p><blockquote class="oz pa pb"><p id="1b6d" class="lu lv nf lw b lx mr kd lz ma ms kg mc pc mt mf mg pd mu mj mk pe mv mn mo lt im bi translated">我的观点是你不应该限制自己。</p></blockquote><p id="b093" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">本教程不是关于编程语言或它们的具体应用。我确实认为数据只适用于Python/Java这种陈词滥调。当我看到不使用SQL(或者不知道如何使用)的数据科学家时，我也很沮丧。</p><p id="3d39" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">这个项目是关于<strong class="lw jd">数据工程</strong>、现代数据堆栈、跳出框框思考、自我学习、定制、语言不可知<strong class="lw jd">以及能够用非常规方法达到预期结果。</strong></p><h2 id="990e" class="nl nm it bd nn no np dn nq nr ns dp nt md nu nv nw mh nx ny nz ml oa ob oc iz bi translated">资源</h2><p id="b2e1" class="pw-post-body-paragraph lu lv it lw b lx od kd lz ma oe kg mc md of mf mg mh og mj mk ml oh mn mo lt im bi translated">[1]:<a class="ae mp" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-commands.html#using-s3-commands-managing-buckets-creating" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CLI/latest/user guide/CLI-services-S3-commands . html # using-S3-commands-managing-buckets-creating</a></p><p id="b0c6" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[2]:https://cloud.google.com/docs/authentication/production<a class="ae mp" href="https://cloud.google.com/docs/authentication/production" rel="noopener ugc nofollow" target="_blank"/></p><p id="f2e2" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[3]:<a class="ae mp" href="https://github.com/dominictarr/JSONStream" rel="noopener ugc nofollow" target="_blank">https://github.com/dominictarr/JSONStream</a></p><p id="6af2" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[4]:<a class="ae mp" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/Job#JobConfigurationLoad" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/rest/v2/Job # JobConfigurationLoad</a></p><p id="4dea" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[5]:<a class="ae mp" href="https://googleapis.dev/nodejs/bigquery/latest/Table.html#createWriteStream" rel="noopener ugc nofollow" target="_blank">https://Google APIs . dev/nodejs/big query/latest/table . html # create write stream</a></p><p id="4d39" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[6]:<a class="ae mp" href="https://aws.amazon.com/dynamodb" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/dynamodb</a></p><p id="3102" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[7]:<a class="ae mp" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cw-alarm.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AWS cloudformation/latest/user guide/AWS-properties-CW-alarm . html</a></p><p id="3137" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[8]:<a class="ae mp" href="https://aws.amazon.com/blogs/security/how-to-create-an-aws-iam-policy-to-grant-aws-lambda-access-to-an-amazon-dynamodb-table/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/security/how-to-create-an-AWS-iam-policy-to-grant-AWS-lambda-access-to-an-Amazon-dynamo db-table/</a></p><p id="335c" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">【9】:【https://aws.amazon.com/cloudformation/ T4】</p><p id="c654" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">【10】:<a class="ae mp" href="http://ndjson.org/" rel="noopener ugc nofollow" target="_blank">http://ndjson.org/</a></p><p id="93b5" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">【11】:<a class="ae mp" href="https://cloud.google.com/bigquery/quotas" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/bigquery/quotas</a></p><p id="ed8d" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[12]:<a class="ae mp" href="https://stackoverflow.com/questions/7985599/notification-of-new-s3-objects" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/7985599/notification-of-new-S3-objects</a></p><p id="15e7" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[13]:<a class="ae mp" href="https://medium.com/swlh/loading-data-into-bigquery-from-cloud-storage-complete-guide-e212f5c2db6" rel="noopener">https://medium . com/swlh/loading-data-into-big query-from-cloud-storage-complete-guide-e 212 F5 C2 db 6</a></p><p id="a10b" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[14]:<a class="ae mp" rel="noopener" target="_blank" href="/monitoring-your-bigquery-costs-and-reports-usage-with-data-studio-b77819ffd9fa">https://towards data science . com/monitoring-your-big query-costs-and-reports-usage-with-data-studio-b 77819 ffd 9 fa</a></p><p id="749b" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated">[15]:<a class="ae mp" rel="noopener" target="_blank" href="/extract-data-from-paypal-api-c25c76748746?gi=e76b91a696e">https://towardsdatascience . com/extract-data-from-paypal-API-c25c 76748746？gi=e76b91a696e </a></p></div><div class="ab cl qu qv hx qw" role="separator"><span class="qx bw bk qy qz ra"/><span class="qx bw bk qy qz ra"/><span class="qx bw bk qy qz"/></div><div class="im in io ip iq"><p id="33b7" class="pw-post-body-paragraph lu lv it lw b lx mr kd lz ma ms kg mc md mt mf mg mh mu mj mk ml mv mn mo lt im bi translated"><em class="nf">原载于https://mydataschool.com</em><a class="ae mp" href="https://mydataschool.com/blog/how-to-load-data-into-bigquery-with-serverless-node-js/" rel="noopener ugc nofollow" target="_blank"><em class="nf"/></a><em class="nf">。</em></p></div></div>    
</body>
</html>