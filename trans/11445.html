<html>
<head>
<title>Getting Started with BigQuery Scripting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery 脚本入门</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/getting-started-with-bigquery-scripting-45bdd968010c?source=collection_archive---------18-----------------------#2021-11-10">https://towardsdatascience.com/getting-started-with-bigquery-scripting-45bdd968010c?source=collection_archive---------18-----------------------#2021-11-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f11a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">揭开 BigQuery 功能强大但可能难以理解的一面，一步一步来</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/00e9addf2d98b6383e09d8d7d6c495c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QCN9GDaGbl7Hk5P1"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">BigQuery 脚本有点像回到过去。照片由<a class="ae ky" href="https://unsplash.com/@aaronburden?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aaron Burden </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="d95b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">BigQuery 中的脚本功能非常强大，但语法复杂，尤其是对于习惯于使用简洁、描述性的、大部分是顺序的和人类可读的语言(如 Python)的人来说。</p><p id="d948" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/scripting" rel="noopener ugc nofollow" target="_blank">脚本</a>的官方文档是一个很好的参考，但我总是发现很难找到一本指南来帮助我一步一步地学习核心概念，从最简单的情况到更复杂的情况。</p><p id="d10a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为解释概念会让你更深入地学习它们，所以我尽最大努力学得更深一点。</p><p id="d066" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以让我们从头开始。</p><h1 id="d9d8" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">什么是 BigQuery 脚本？</h1><p id="19b8" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">BigQuery 中的脚本是做事情的语句序列。它们有基本的控制结构，如变量和循环，并使您能够自动化操作，否则将需要重复，复制/粘贴和潜在的人为错误，这总是伴随着这种方法。</p><p id="1f07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过在脚本中使用数据定义语言(<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language" rel="noopener ugc nofollow" target="_blank"> DDL </a>)，您可以实现大量的自动化任务，而无需离开您可信赖的 BigQuery 控制台。</p><p id="916b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">BigQuery 脚本最有用的方面之一是能够将行为封装到一个<strong class="lb iu">过程</strong>(本质上是一个函数)中，然后用一组参数调用它来执行一个或一组任务。</p><h1 id="5200" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">程序存在于何处？</h1><p id="3528" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">BigQuery 中的过程看起来与用户界面左侧资源树中的表或视图完全一样(具有不同的图标)，无论您使用的是哪个版本，资源树都在左侧。我不喜欢在新版本中启动额外的标签页，所以我坚持使用以前的功能强大的控制台。</p><h1 id="a131" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">你是如何创造它们的？</h1><p id="e87b" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在 BigQuery 中定义一个函数(实际上它在技术上是一个过程。或者有时是例行公事。但我要称它们为函数，因为它们是函数)，至少你要命名函数，并在开头和结尾之间添加一些 SQL。开始由 BEGIN 语句标记，结束由 end 标记。</p><p id="b7e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到目前为止一切顺利。实际的语法是:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="cdaf" class="mx lw it mt b gy my mz l na nb">CREATE OR REPLACE PROCEDURE project_id.dataset_name.function_name() <br/>BEGIN<br/># function body <br/>END;</span></pre><p id="8355" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实际上，在开头和结尾之间会有很多代码，在括号之间是变量定义，但这是代码的高级结构。</p><p id="4d10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，上面的代码不会运行，因为函数体中没有要执行的内容。添加一个简单的 select 语句会在右下角给你一个方便的绿色勾号，这意味着你可以开始了。我将在<strong class="lb iu"> flowfunction </strong>项目的<strong class="lb iu">示例</strong>数据集中创建一个真正的函数(注意，如果您的项目名称中没有任何下划线，您不需要用反斜杠将它们括起来，我认为这样更简洁):</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="fd3b" class="mx lw it mt b gy my mz l na nb">CREATE OR REPLACE PROCEDURE <br/>flowfunctions.examples.hello_world() <br/>BEGIN<br/>SELECT TRUE;<br/>END;</span></pre><p id="4f36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了！运行后，我现在在<strong class="lb iu">示例</strong>数据集中有了一个名为<strong class="lb iu"> hello_world </strong>的函数。我可以在我的结果窗格中看到对此的确认:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="2d8c" class="mx lw it mt b gy my mz l na nb">This statement replaced the procedure named flowfunctions.examples.hello_world.</span></pre><p id="c494" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是我还没有实际运行它，所以我看不到输出。我将在脚本中添加另一行代码，重新定义函数，然后运行它:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="5229" class="mx lw it mt b gy my mz l na nb">CREATE OR REPLACE PROCEDURE <br/>flowfunctions.examples.hello_world() <br/>BEGIN<br/>SELECT TRUE;<br/>END;</span><span id="6f19" class="mx lw it mt b gy nc mz l na nb">CALL flowfunctions.examples.hello_world()</span></pre><p id="5d19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我应该在结果窗格中看到两个阶段。如果我第二次点击<strong class="lb iu">查看结果</strong>，我将看到一个结果为<strong class="lb iu">真</strong>。现在，由于我调用了函数<strong class="lb iu"> hello_world </strong>，我最好更新函数体以与此保持一致。我将把代码改为:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="fd0f" class="mx lw it mt b gy my mz l na nb">CREATE OR REPLACE PROCEDURE <br/>flowfunctions.examples.hello_world() <br/>BEGIN<br/>SELECT "Hello World!" AS response;<br/>END;</span><span id="2ca7" class="mx lw it mt b gy nc mz l na nb">CALL flowfunctions.examples.hello_world()</span></pre><p id="e4d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我有了一个名为“你好，世界！”的专栏作为单行响应值。太好了！我们现在已经构建了最简单的 BigQuery 函数(与<a class="ae ky" href="https://cloud.google.com/blog/products/data-analytics/command-and-control-now-easier-in-bigquery-with-scripting-and-stored-procedures" rel="noopener ugc nofollow" target="_blank">发布的博客文章</a>相比，后者非常有趣，但肯定不是最简单的脚本介绍示例)。</p><h1 id="f52e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">参数呢？</h1><p id="a41a" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">还有一件事，因为您几乎总是会将函数参数传递给 BigQuery 过程，所以我将添加一个名为<strong class="lb iu"> name </strong>的输入参数。这将是一个字符串，所以我需要预先定义它，我将把它变成一个新函数:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="0fe0" class="mx lw it mt b gy my mz l na nb">CREATE OR REPLACE PROCEDURE <br/>flowfunctions.examples.hello_name(name STRING) <br/>BEGIN<br/>SELECT FORMAT("Hello %s!", name) AS response;<br/>END;</span><span id="92ef" class="mx lw it mt b gy nc mz l na nb">CALL flowfunctions.examples.hello_name("Dad")</span></pre><p id="bd8a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，在执行之前，您可能会注意到函数调用带有红色下划线，这表明有问题。不要担心，这是因为在执行 CREATE 或 REPLACE 语句之前，该函数是不存在的。</p><p id="61be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">执行这个脚本将创建函数，然后显示“Hello Dad！”作为单行响应，使用<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions#format_string" rel="noopener ugc nofollow" target="_blank">格式的</a>字符串函数将变量注入字符串，这比使用<a class="ae ky" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/string_functions#concat" rel="noopener ugc nofollow" target="_blank">连接</a>更具可读性。</p><p id="ab5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我们开始吧，最简单的可能的函数让你开始在 BigQuery 中编写函数。</p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><p id="2dca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您觉得这(以及其他相关材料)有用和/或有趣，请跟我来！</p><p id="7fce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你还不是会员，<a class="ae ky" href="https://jim-barlow.medium.com/membership" rel="noopener">加入 Medium </a>，每月只需 5 美元，就能从这个活跃、充满活力和激情的数据人社区获得无限的故事。也有很多其他人，但是如果你对数据感兴趣，那么这里就是你要去的地方…</p></div></div>    
</body>
</html>