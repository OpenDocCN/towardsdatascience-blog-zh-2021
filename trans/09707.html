<html>
<head>
<title>Waterfall Charts with Plotly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Plotly制作瀑布图</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/waterfall-charts-with-plotly-43822918e9eb?source=collection_archive---------7-----------------------#2021-09-10">https://towardsdatascience.com/waterfall-charts-with-plotly-43822918e9eb?source=collection_archive---------7-----------------------#2021-09-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="43fd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><strong class="ak">为什么&amp;如何</strong></h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/15fb6201487cd954387d217b0241d183.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vkErpdkgQqEfwDl6emdOVw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由Muhamad Rizal Firmansyah从Unsplash拍摄</p></figure><h1 id="d9dc" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated"><strong class="ak">瀑布图</strong></h1><p id="4733" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated"><strong class="ls iu">又名</strong>:飞砖图、浮砖图、马里奥图</p><p id="b20e" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated"><strong class="ls iu">原因:</strong>是一个2D图，用于表示在一段时间内或在多个分类步骤内连续添加正值或负值的累积效果。随着时间或<strong class="ls iu">基于时间的瀑布图</strong>表示一段时间内的增加和减少。分类步骤或<strong class="ls iu">基于类别的瀑布图</strong>表示收入和费用或任何其他变量的加减，依次为正值和负值。</p><p id="07b1" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated"><strong class="ls iu">如何</strong>:瀑布图(WCs)由一系列竖条(柱)组成。初始值和最终值由全列表示(通常从零基线开始)，而中间值显示为代表加法和减法的<strong class="ls iu">浮动列</strong>。最后一个竖线表示这种加法和减法的结果。加法通常用绿色表示，而减法通常用红色表示。另外，习惯上用另一种颜色表示起始列和结束列。建议通过<strong class="ls iu">用连接横线连接各列来展示累积效果的理念。</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/2eb331db7a323931b71c3425f58dd2fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*HBak05M1Sk91FEp6_ycERQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1:瀑布图的示意图。作者用Plotly做的。</p></figure><p id="6ca1" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">现在应该清楚为什么它们被称为飞砖或浮砖图了。有人将它们命名为马里奥图表，因为它与流行的视频游戏有一定的相似性。</p><p id="d8ad" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated"><strong class="ls iu">讲故事</strong> : WCs通常用于金融和商业中的<strong class="ls iu">在正值和负值之间波动的数据。</strong>基于时间的WCs显示每月或每年的总变化，同时显示整月或整年的利润或亏损。基于类别的WCs显示<strong class="ls iu">给定变量的连续增加的正值或负值的累积效应</strong>。正值可能是收入、收益、仓库库存增加、积极变化或收入流。负值可能是费用、损失、仓库存货、负变化或流出量。请记住，阅读是从左到右依次进行的。</p><p id="ab6b" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">WC是一种有价值的数据可视化技术，因为它允许分析师清楚地确定哪些时段或项目显示最大收益，何时观察到最大损失，以及在评估的时间段内净变化是什么。它提供了比其他类似图表更多的上下文信息。</p><h1 id="13f0" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated"><strong class="ak">瀑布图与Plotly </strong></h1><p id="3556" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">我们使用了开源的图形库<strong class="ls iu"> Plotly </strong>，它提供了一组名为<em class="ms"> graph objects </em>的类来构造图形。<em class="ms">图</em>是具有数据属性和布局属性的主类。数据属性指的是一个<strong class="ls iu">轨迹</strong>，一个带有相应参数的特殊类型的图表。布局属性指定图形的标题、轴、图例和其他属性。</p><p id="7841" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">对于本文中的瀑布图，Plotly trace为<code class="fe mt mu mv mw b"><em class="ms">go.Waterfall()</em></code>对应的参数为:<em class="ms"> </em> <code class="fe mt mu mv mw b"><em class="ms">x=</em></code>设置x坐标(一般为字符串或日期时间对象)；<code class="fe mt mu mv mw b"><em class="ms">y=</em></code>设置y坐标(通常是一列con数值，包括<em class="ms">无</em>)；<code class="fe mt mu mv mw b"> <em class="ms">base=</em></code>设置数值基线。</p><p id="21ac" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">最重要的参数是<code class="fe mt mu mv mw b"><em class="ms">measure=</em></code> <em class="ms">，</em>一个具有下列值之一的数组:<em class="ms">相对；绝对；总计</em>。<em class="ms">相对值</em>，默认值，表示增加或减少。<em class="ms">绝对值</em>设置初始值，而<em class="ms">总和</em>计算代数和。</p><p id="1535" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">这是图1中瀑布图的代码:</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="4fea" class="nb kz it mw b gy nc nd l ne nf">import plotly.graph_objects as go</span><span id="6682" class="nb kz it mw b gy ng nd l ne nf">fig1  = go.Figure()</span><span id="0552" class="nb kz it mw b gy ng nd l ne nf">hrz = ["Initial", "Addition 1","Addition 2",<br/>       "Subtraction 1","Subtraction 2","Final"]</span><span id="41e4" class="nb kz it mw b gy ng nd l ne nf">vrt = [100, 600, 700, -400, -300, None]</span><span id="2dde" class="nb kz it mw b gy ng nd l ne nf">fig1.add_trace(go.Waterfall(                 <br/>                  x = hrz, y = vrt,<br/>                  base = 0,<br/>                  measure = [ "absolute","relative",    <br/>                              "relative","relative",<br/>                              "relative","total" ]                        <br/>                ))                                 </span><span id="194c" class="nb kz it mw b gy ng nd l ne nf">fig1.show()</span></pre><p id="f5b0" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我们更新了图表以改进讲故事:<code class="fe mt mu mv mw b">text</code>为每个条形设置注释；<code class="fe mt mu mv mw b">textposition</code>将文字列表<em class="ms">定位在</em>内或将<em class="ms">定位在</em>外；<code class="fe mt mu mv mw b">update.layout </code>设置标题文本和标题字体。</p><p id="723c" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">这是图2中瀑布图的代码:</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="4786" class="nb kz it mw b gy nc nd l ne nf">import plotly.graph_objects as go</span><span id="a434" class="nb kz it mw b gy ng nd l ne nf">fig2  = go.Figure()</span><span id="7e4d" class="nb kz it mw b gy ng nd l ne nf">hrz = [ "Initial",  "Addition 1", "Addition 2",<br/>       "Subtraction 1","Subtraction 2","Final"]</span><span id="d9c2" class="nb kz it mw b gy ng nd l ne nf">vrt  = [100, 600, 700, -400, -300, None]</span><span id="4598" class="nb kz it mw b gy ng nd l ne nf">text = ['100', '+600', '+700', '-400', '-300', '700']</span><span id="dd89" class="nb kz it mw b gy ng nd l ne nf">fig2.add_trace(go.Waterfall(<br/>               x = hrz, y = vrt,<br/>               base = 0,<br/>               text = text, textposition = 'inside',   </span><span id="8612" class="nb kz it mw b gy ng nd l ne nf">               measure = ["absolute",  "relative", "relative",<br/>                          "relative","relative","total"]  <br/>               ))              </span><span id="e047" class="nb kz it mw b gy ng nd l ne nf">fig2.update_layout(<br/>                   title_text = "Category-Based Waterfall Chart",<br/>                   title_font=dict(size=25,family='Verdana', <br/>                                   color='darkred')<br/>                   )</span><span id="07f5" class="nb kz it mw b gy ng nd l ne nf">fig2.show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/27ff366e578e6042f6d05d78d85c40e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*m4f3DrUx5QX83hM--iP9mA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图2:瀑布图的示意图。作者用Plotly做的。</p></figure><p id="d570" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在我们的第二个例子中，我们将使用一个基于时间的瀑布图来表示一个虚构的地方每月访客数量依次增加和减少的累积效应。</p><p id="e379" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">首先，我们将创建一个数据框架，其中包含我们应该收集的关于访问者数量增减的数据。我们需要将库<strong class="ls iu">Numpy</strong>&amp;<strong class="ls iu">Pandas</strong>分别导入为<em class="ms"> np </em>和<em class="ms"> pd </em>。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="8dbd" class="nb kz it mw b gy nc nd l ne nf">import numpy  as np<br/>import pandas as pd</span><span id="f8eb" class="nb kz it mw b gy ng nd l ne nf">months =   ['Initial', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',<br/>            'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Final']</span><span id="9a5d" class="nb kz it mw b gy ng nd l ne nf">visitors = [15000, +18000, +12000, -4000,  +8000, <br/>           -10000, -5000,  +20000, +15000, +18000,<br/>           -16000, -18000, +10000, 63000]</span><span id="0e6c" class="nb kz it mw b gy ng nd l ne nf">df = pd.DataFrame({'months' : months, 'visitors' : visitors,<br/>                   'text' : visitors})</span></pre><p id="4acb" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我们需要在dataframe中创建一个列，指示与<code class="fe mt mu mv mw b"><em class="ms">measure</em></code>相关的值。记住这个参数可以取以下三个值中的任意一个:<em class="ms">absolute；相对的；总计。</em>为了填充名为<code class="fe mt mu mv mw b"><em class="ms">measure </em></code>的列，我们使用了Numpy方法<code class="fe mt mu mv mw b">np.select()</code>，该方法根据条件列表返回一个从<em class="ms"> choicelist </em>中的元素提取的数组。</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="0843" class="nb kz it mw b gy nc nd l ne nf">conditionlist = [(df['months'] == 'Initial'),<br/>                 (df['months'] == 'Final'),<br/>            (df['months'] != 'Initial') &amp; (df['months'] != 'Final')]</span><span id="c4d1" class="nb kz it mw b gy ng nd l ne nf">choicelist   = ['absolute', 'total', 'relative']</span><span id="4905" class="nb kz it mw b gy ng nd l ne nf">df['measure'] = np.select(conditionlist, choicelist,<br/>                          default='absolute')</span></pre><p id="ac1f" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">下面的屏幕截图显示了数据集的14条记录:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/495aa61a188ff88b549228f26011b0c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*IDnts-dDfCzxTfo3WJTnSQ.png"/></div></figure><p id="5e19" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">现在我们准备画WC了。</p><p id="fdcf" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">Plotly允许通过<code class="fe mt mu mv mw b"> <em class="ms">increasing</em></code>、<code class="fe mt mu mv mw b"><em class="ms">decreasing</em></code>和<code class="fe mt mu mv mw b"><em class="ms">totals</em>.</code>自定义浮动条的颜色</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="a0ba" class="nb kz it mw b gy nc nd l ne nf">fig3  = go.Figure()</span><span id="5b3d" class="nb kz it mw b gy ng nd l ne nf">fig3.add_trace(go.Waterfall(<br/>               x = df['months'], y = df['visitors'],<br/>               measure = df['measure'],<br/>               base = 0,<br/>               text = df['visitors'],<br/>               textposition = 'outside',<br/>               decreasing = {"marker":{"color":"crimson",                 <br/>                  "line":{"color":"lightsalmon","width":2}}},<br/>               increasing = {"marker":{"color":"forestgreen",<br/>                  "line":{"color":"lightgreen", "width":2}}},<br/>               totals     = {"marker":{"color":"mediumblue"}}<br/>               ))</span></pre><p id="3031" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我们决定将注释<em class="ms">放在</em>条的外面，以避免混乱。最后，我们设置了标题并更新了坐标轴:</p><pre class="kj kk kl km gt mx mw my mz aw na bi"><span id="3377" class="nb kz it mw b gy nc nd l ne nf">fig3.update_layout(<br/>                   title_text = "Time-Based Waterfall Chart",<br/>                   title_font = dict(size=25,family='Verdana',<br/>                                     color='darkred'))</span><span id="c6d5" class="nb kz it mw b gy ng nd l ne nf">fig3.update_yaxes(title = 'Visitors' , range = [0, 100000])<br/>fig3.update_xaxes(title = 'Year 2020')</span><span id="41db" class="nb kz it mw b gy ng nd l ne nf">fig3.show()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/35f4a6b5d88648fd985f9842dd9c07a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*xN_5DcoEHc0BeP8IhcW3nQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3:基于时间的瀑布图。作者用Plotly做的。</p></figure><p id="8159" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated"><strong class="ls iu">总而言之:</strong>瀑布图的关键概念是传达一段时间内或一系列相关项目中正值和负值的变化。它们很容易实现，尤其是用Plotly。它们广泛用于金融分析和商业环境。</p><p id="d0e2" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">如果你发现了这篇感兴趣的文章，请阅读我之前的(https://medium.com/@dar.wtz):</p><p id="a807" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">分歧棒线，为什么&amp;如何，用分歧讲故事</p><div class="ni nj gp gr nk nl"><a rel="noopener follow" target="_blank" href="/diverging-bars-why-how-3e3ecc066dce"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd iu gy z fp nq fr fs nr fu fw is bi translated">背离棒线，为什么&amp;如何</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">用分歧讲故事</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">towardsdatascience.com</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz ks nl"/></div></div></a></div><p id="41af" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">斜率图表，为什么和如何，用斜率讲故事</p><div class="ni nj gp gr nk nl"><a rel="noopener follow" target="_blank" href="/slope-charts-why-how-11c2a0bc28be"><div class="nm ab fo"><div class="nn ab no cl cj np"><h2 class="bd iu gy z fp nq fr fs nr fu fw is bi translated">斜率图表，为什么和如何</h2><div class="ns l"><h3 class="bd b gy z fp nq fr fs nr fu fw dk translated">用斜坡讲故事</h3></div><div class="nt l"><p class="bd b dl z fp nq fr fs nr fu fw dk translated">towardsdatascience.com</p></div></div><div class="nu l"><div class="oa l nw nx ny nu nz ks nl"/></div></div></a></div></div></div>    
</body>
</html>