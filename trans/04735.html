<html>
<head>
<title>Creating and Managing Elasticsearch Indices with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python创建和管理弹性搜索索引</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/creating-and-managing-elasticsearch-indices-with-python-f676ff1c8113?source=collection_archive---------3-----------------------#2021-04-25">https://towardsdatascience.com/creating-and-managing-elasticsearch-indices-with-python-f676ff1c8113?source=collection_archive---------3-----------------------#2021-04-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ed75" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从CSV文件创建ES索引以及使用Python Elasticsearch客户端管理数据的实践指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/41cdeebc9c8487803fe5c110d3e79dc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IKlKIUxCr_sfdLzt"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@pgreen1983?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">保罗·格伦</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="4241" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi lv translated"><span class="l lw lx ly bm lz ma mb mc md di"> E </span> lasticsearch (ES)是一个分布式搜索引擎，旨在实现可扩展性和冗余性。它速度很快，适合<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html" rel="noopener ugc nofollow" target="_blank">存储和处理大量数据，用于分析、机器学习和其他应用</a>。ES在最近几年获得了发展，对于任何数据科学家(和数据工程师)的工具箱来说，它都是一项重要的技术。在这篇博文中，我们将使用Bonsai提供我们自己的(免费)ES集群，并使用<a class="ae ky" href="https://elasticsearch-py.readthedocs.io/en/6.8.2/" rel="noopener ugc nofollow" target="_blank"> Python Elasticsearch客户端</a>来建立索引，并写入和查询数据。这篇博文的所有代码都可以在GitHub 上找到。</p><h1 id="c956" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">设置您的弹性搜索集群</h1><p id="321f" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">第一步，我们将建立一个弹性搜索集群。你可以通过一个托管的弹性搜索服务提供商来完成这项工作，比如AWS的亚马逊弹性搜索服务。您如何决定供应、部署和管理您的集群(以及在哪里)取决于您正在构建哪种解决方案以及哪些功能对您来说是重要的。</p><p id="0df0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我们将使用<a class="ae ky" href="https://bonsai.io" rel="noopener ugc nofollow" target="_blank"> Bonsai </a>，它为我们提供了一个<a class="ae ky" href="https://elements.heroku.com/addons/bonsai" rel="noopener ugc nofollow" target="_blank">免费的“沙盒”层，具有125mb的存储空间和35，000个文档的存储限制</a>。首先，在Bonsai上为<a class="ae ky" href="https://app.bonsai.io/signup#free" rel="noopener ugc nofollow" target="_blank">注册一个帐户，然后按照网站上的步骤来设置和部署您的集群</a>。如果您已经在<a class="ae ky" href="http://www.heroku.com" rel="noopener ugc nofollow" target="_blank"> Heroku </a>上拥有一个帐户，您也可以通过<a class="ae ky" href="https://elements.heroku.com/addons/bonsai" rel="noopener ugc nofollow" target="_blank">选择Bonsai作为应用程序资源标签中</a>的附加组件，直接为您的应用程序提供一个ES集群，而无需在Bonsai上注册帐户(见下文)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/d4c5d519610280fd1e9693efcffb55ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*nYn5v6GG9rcHYID1LRsJJA.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通过Heroku附加组件提供Bonsai Elasticsearch集群(图片由作者提供)</p></figure><p id="f8eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您设置您的Bonsai帐户并部署您的集群(或通过Heroku为您的应用程序提供Bonsai集群)后，转到您的<a class="ae ky" href="https://docs.bonsai.io/article/199-cluster-overview" rel="noopener ugc nofollow" target="_blank"> Bonsai集群概览仪表板</a>左侧栏中的“凭证”页面，并复制您的主机URL、访问密钥和访问密码。稍后，我们将使用这些信息通过<a class="ae ky" href="https://elasticsearch-py.readthedocs.io/en/6.8.2/" rel="noopener ugc nofollow" target="_blank"> Python Elasticsearch客户端</a>建立一个连接。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/ff019dd59c4fc7ce4dae901ee9107808.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jRqzCzptYk580DPF-xDpAw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">从<a class="ae ky" href="https://docs.bonsai.io/article/199-cluster-overview" rel="noopener ugc nofollow" target="_blank">Bonsai Cluster overview dashboard</a>中的“凭证”页面获取ES集群的主机URL、访问密钥和访问密码(图片由作者提供)</p></figure><p id="0b19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Bonsai的沙盒层不是生产级部署，有一些限制。例如，沙箱层不允许您为用户设置有限的权限(例如，只读权限)，因此，如果您希望将此设置用于向互联网公开的应用程序，请记住这一点。<a class="ae ky" href="https://cloud.elastic.co/registration?elektra=downloads-overview&amp;storm=elasticsearch" rel="noopener ugc nofollow" target="_blank">Elastic.co提供了一个14天的免费试用版</a>，如果你想探索es所提供的全部功能的话，你可以使用这个试用版。</p><p id="be4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成上述步骤后，您可以使用Elasticsearch的<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cat.html" rel="noopener ugc nofollow" target="_blank">Compact and Aligned Text(CAT)API</a>从控制台检查集群健康状况和索引。卡特彼勒API旨在为您提供人类可读的输出。因此，它们<em class="nd">不是</em>打算由应用程序使用；相反，他们应该从终端或在<a class="ae ky" href="https://www.elastic.co/guide/en/kibana/7.12/console-kibana.html" rel="noopener ugc nofollow" target="_blank">基巴纳控制台</a>使用。</p><p id="e199" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在控制台上(直接在Kibana和Bonsai上)，下面的GET请求将返回关于<a class="ae ky" href="http://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html" rel="noopener ugc nofollow" target="_blank">集群健康</a>的信息(一个“绿色”状态意味着您的所有碎片都已分配):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/2be619d371bcfc37adb4e6a9f10dc7bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*yxOPfUnUoUspQ2o7cUgKhg.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-health.html" rel="noopener ugc nofollow" target="_blank">卡特彼勒健康API </a>在<a class="ae ky" href="https://www.elastic.co/guide/en/kibana/7.12/console-kibana.html" rel="noopener ugc nofollow" target="_blank"> Kibana控制台</a>上检查您的ES集群的健康状况(图片由作者提供)</p></figure><h1 id="639c" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">定义您的ES索引映射</h1><p id="63af" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">现在我们已经有了一个集群，让我们看看es中数据和索引的基础。</p><p id="3663" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Elasticsearch中的数据是以名为“<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.12/documents-indices.html" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">文档</strong> </a>”的JSON对象的形式存在的。一个文档包含<strong class="lb iu">字段</strong>，它们是键值对，可以是一个值(如布尔值或整数)或一个嵌套结构。文档被组织在<a class="ae ky" href="https://www.elastic.co/blog/what-is-an-elasticsearch-index" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu">索引</strong> </a>中，它们既是遵循模式的数据的<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/scalability.html" rel="noopener ugc nofollow" target="_blank">逻辑分组，也是通过碎片</a>的数据的<em class="nd">物理</em>组织。</p><p id="b7a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个索引由<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/scalability.html" rel="noopener ugc nofollow" target="_blank">一个或多个物理碎片组成，这些物理碎片形成一个逻辑组</a>。每个碎片依次是一个<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/scalability.html" rel="noopener ugc nofollow" target="_blank">“自含索引”</a>。索引中的数据跨这些<strong class="lb iu">碎片</strong>进行分区，而碎片分布在各个节点上。每个文档都有一个“主碎片”和一个“副本碎片”<strong class="lb iu"> </strong>(也就是说，如果索引已经被配置为有一个或多个副本碎片)。</p><p id="179e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">驻留在不同碎片中的数据可以并行处理。在您的CPU和内存允许的范围内(即，取决于您拥有的ES集群的类型)，更多的碎片意味着更快的搜索。但是请注意，碎片会带来开销，您应该仔细考虑<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/size-your-shards.html" rel="noopener ugc nofollow" target="_blank">集群中碎片的适当数量和大小</a>。</p><p id="c9e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们已经学习了ES的基础知识，让我们尝试建立一个我们自己的索引。这里，我们将使用Kaggle 上提供的关于网飞演出的<a class="ae ky" href="https://www.kaggle.com/shivamb/netflix-shows" rel="noopener ugc nofollow" target="_blank">数据。该数据集采用CSV格式，包含网飞上可用的电影和电视剧的信息，包括元数据，如上映日期、片名和演员阵容。</a></p><p id="ae87" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将首先为我们的索引定义一个ES映射。在这种情况下，我们将使用相对简单的字段类型，将所有字段定义为<code class="fe ne nf ng nh b">text</code>，除了<code class="fe ne nf ng nh b">release_year</code>(我们将其定义为<code class="fe ne nf ng nh b">integer</code>)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="9f1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然Elasticsearch能够在您编写文档时使用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html" rel="noopener ugc nofollow" target="_blank">动态字段映射</a>来推断文档的映射，但它不一定能达到最佳效果。通常，您需要花一些时间来定义映射，因为字段类型(以及各种其他选项)会影响索引的大小以及查询数据的灵活性。例如，<code class="fe ne nf ng nh b">text</code>字段类型在索引时被分解成单独的术语，允许部分匹配。<code class="fe ne nf ng nh b">keyword</code>类型也可以用于字符串，但是在索引时不进行分析(或者说:“标记化”)，只允许精确匹配(在本例中，我们可以将它用于<code class="fe ne nf ng nh b">type</code>字段，它取两个值之一——“电影”或“电视节目”)。</p><p id="f8bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里要记住的另一件事是es <a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html" rel="noopener ugc nofollow" target="_blank">没有数组字段类型</a>:如果你的文档包含一个由整数数组组成的字段，那么ES的等价数据类型就是<code class="fe ne nf ng nh b">integer</code>(关于ES字段类型的完整概述，请参见<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html" rel="noopener ugc nofollow" target="_blank">本页</a>)。以下面的文件为例:</p><pre class="kj kk kl km gt nk nh nl nm aw nn bi"><span id="c9f5" class="no mf it nh b gy np nq l nr ns">{<br/>    "values": [1,2,3,4,5]<br/>}</span></pre><p id="fa70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该数据的底层映射将简单地将<code class="fe ne nf ng nh b">values</code>字段类型定义为一个整数:</p><pre class="kj kk kl km gt nk nh nl nm aw nn bi"><span id="a443" class="no mf it nh b gy np nq l nr ns">mapping = {<br/>    "mappings": {<br/>        "properties": {<br/>            "values": {<br/>                "type": "integer"<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="7ac2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经定义了我们的映射，我们可以使用<a class="ae ky" href="https://elasticsearch-py.readthedocs.io/en/6.8.2/" rel="noopener ugc nofollow" target="_blank"> Python Elasticsearch客户端</a>在ES上设置我们的索引。在下面的Python代码中，我设置了一个名为 <code class="fe ne nf ng nh b"><a class="ae ky" href="https://github.com/ngoet/es_demo/blob/main/es_connection.py" rel="noopener ugc nofollow" target="_blank">EsConnection</a></code>的类<a class="ae ky" href="https://github.com/ngoet/es_demo/blob/main/es_connection.py" rel="noopener ugc nofollow" target="_blank">，带有一个ES客户端连接属性(<code class="fe ne nf ng nh b">es_client</code>)。注意，为了方便起见，我将我的访问凭证存储在环境变量中(也是为了避免在将代码推送到GitHub时意外地共享它们)。对于真正的应用程序，你必须使用更安全的方法，比如</a><a class="ae ky" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS Secrets Manager </a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="5234" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ne nf ng nh b">EsConnection</code>类还包括两个方法，一个基于映射创建索引(<code class="fe ne nf ng nh b">create_index</code>)，另一个(<code class="fe ne nf ng nh b">populate_index</code>)获取CSV文件，将其行转换为JSONs，并将每个条目(“文档”)写入es索引。这里，我们将只使用第一个函数来创建我们的<code class="fe ne nf ng nh b">netflix_movies</code>索引:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="ac72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以使用下面的代码检查索引的映射，该代码将返回我们刚刚编写的映射:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h1 id="52be" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">将数据写入ES</h1><p id="43ce" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">现在我们已经定义了我们的映射，我们可以使用下面的代码将网飞电影数据写入我们的es索引(请注意，这段代码期望本文前面讨论的来自Kaggle 的<a class="ae ky" href="https://www.kaggle.com/shivamb/netflix-shows" rel="noopener ugc nofollow" target="_blank">网飞数据可以在名为“data”的子目录中获得):</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="8eb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当这段代码运行时，我们可以通过查看Bonsai仪表板中的日志来检查数据是否通过。日志应该显示对<code class="fe ne nf ng nh b">netflix_movies</code>索引的POST请求(见下文)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/a5efe13719e0118f1cd7ef449548ed27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*pqIHNkHzKu2wl3MkHpJVSg.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">检查日志中对Bonsai索引的POST调用(图片由作者提供)</p></figure><p id="8b7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以使用<code class="fe ne nf ng nh b">count</code>方法检查<code class="fe ne nf ng nh b">netflix_movies</code>索引中的条目数量，例如:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="db4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以使用Kibana控制台中的<a class="ae ky" href="https://www.google.co.uk/search?q=CAT+indices+API&amp;client=safari&amp;source=hp&amp;ei=QPlpYIDFMevYgwfLkr7gDQ&amp;iflsig=AINFCbYAAAAAYGoHUNoVnfkkKa3B3-yI2Ja62TmRbazs&amp;oq=CAT+indices+API&amp;gs_lcp=Cgdnd3Mtd2l6EAMyAggAMgYIABAWEB46AgguOggILhDHARCjAjoFCC4QkwI6CAguEMcBEK8BOgUIABDJAzoECAAQCjoICAAQFhAKEB5Q7gZY1Blg1htoAXAAeACAAVmIAYUIkgECMTaYAQCgAQGqAQdnd3Mtd2l6&amp;sclient=gws-wiz&amp;ved=0ahUKEwiA5bS8kOXvAhVr7OAKHUuJD9wQ4dUDCAo&amp;uact=5" rel="noopener ugc nofollow" target="_blank">CAT indexes API</a>来检查索引中的文档数量、它们的大小、主碎片和复制碎片的数量以及它们的健康状态:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/64774096bb4416101054a46bc6ebe76b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*khM2O5KtiMuCqBgBp72mtg.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用<a class="ae ky" href="https://www.google.co.uk/search?q=CAT+indices+API&amp;client=safari&amp;source=hp&amp;ei=QPlpYIDFMevYgwfLkr7gDQ&amp;iflsig=AINFCbYAAAAAYGoHUNoVnfkkKa3B3-yI2Ja62TmRbazs&amp;oq=CAT+indices+API&amp;gs_lcp=Cgdnd3Mtd2l6EAMyAggAMgYIABAWEB46AgguOggILhDHARCjAjoFCC4QkwI6CAguEMcBEK8BOgUIABDJAzoECAAQCjoICAAQFhAKEB5Q7gZY1Blg1htoAXAAeACAAVmIAYUIkgECMTaYAQCgAQGqAQdnd3Mtd2l6&amp;sclient=gws-wiz&amp;ved=0ahUKEwiA5bS8kOXvAhVr7OAKHUuJD9wQ4dUDCAo&amp;uact=5" rel="noopener ugc nofollow" target="_blank"> CAT索引API </a>在<a class="ae ky" href="https://www.elastic.co/guide/en/kibana/7.12/console-kibana.html" rel="noopener ugc nofollow" target="_blank"> Kibana控制台</a>上检查es集群中的索引(图片由作者提供)</p></figure><p id="196d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面显示的输出中，<code class="fe ne nf ng nh b">store.size</code>字段显示了主碎片和复制碎片的总大小，而<code class="fe ne nf ng nh b">pri.store.size</code>只显示了主碎片的大小。在这种情况下,<code class="fe ne nf ng nh b">store.size</code>将是主碎片大小的两倍，因为我们的碎片健康是“绿色的”,这意味着副本碎片被正确分配。</p><p id="b1de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你喜欢全程使用Python，Python Elasticsearch客户端也可以<a class="ae ky" href="https://elasticsearch-py.readthedocs.io/en/6.8.2/api.html#cat" rel="noopener ugc nofollow" target="_blank">直接与CAT API </a>一起使用。</p><h1 id="5219" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">从ES查询数据</h1><p id="dbf1" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">现在我们已经建立了集群并编写了文档，让我们简单地看一下从Elasticsearch查询数据。ES查询是用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" rel="noopener ugc nofollow" target="_blank"> Elasticsearch领域特定语言(DSL) </a>编写的。正如在<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" rel="noopener ugc nofollow" target="_blank"> ES文档</a>中所描述的，DSL是基于JSON的，应该被认为是查询的抽象语法树(AST)。DSL查询由两种类型的子句组成:</p><ol class=""><li id="d9d5" class="nu nv it lb b lc ld lf lg li nw lm nx lq ny lu nz oa ob oc bi translated"><strong class="lb iu">叶查询子句</strong>，查找特定字段中的特定值(如<code class="fe ne nf ng nh b">match</code>或<code class="fe ne nf ng nh b">range</code>)；和</li><li id="252a" class="nu nv it lb b lc od lf oe li of lm og lq oh lu nz oa ob oc bi translated"><strong class="lb iu">复合查询子句</strong>用于逻辑组合多个查询(如多叶或复合查询)或改变这些查询的行为。</li></ol><p id="9e5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您对您的索引运行查询时，ES <a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-filter-context.html#relevance-scores" rel="noopener ugc nofollow" target="_blank">按照代表匹配质量的<strong class="lb iu">相关性分数</strong>(一个浮点数)对结果进行排序</a>(该值在与“命中”相关联的<code class="fe ne nf ng nh b">_score</code>字段中报告)。ES查询<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-filter-context.html" rel="noopener ugc nofollow" target="_blank">有一个查询和一个过滤上下文。</a>过滤器上下文——顾名思义——过滤掉不符合语法条件的文档。但是，这不会影响相关性分数。布尔上下文<em class="nd">中的匹配</em>对相关性分数有贡献。</p><p id="e8e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一个带有查询和过滤上下文的查询示例。下面的例子根据发行年份进行过滤，但是根据电影类型进行匹配。</p><pre class="kj kk kl km gt nk nh nl nm aw nn bi"><span id="6edb" class="no mf it nh b gy np nq l nr ns">{<br/>    "query": {<br/>        "bool": {<br/>            "must": [<br/>                {"match": {"type": "TV Show"}},<br/>            ],<br/>            "filter": [<br/>                {"range": {"release_year": {"gte": 2021}}}<br/>            ]<br/>        }<br/>    }<br/>}</span></pre><p id="b1db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以直接使用我们的ES控制台或者通过Python在我们的索引上运行这个查询。下面的例子使用了后一种方法。这段代码首先设置ES客户端。随后，它定义查询，最后，它针对<code class="fe ne nf ng nh b">netflix_movies</code> ES索引运行查询。代码的最后一行打印与我们的查询相匹配的电影的标题。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="7289" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请记住，对于常规搜索，每个查询最多有10，000次命中。如果您需要在单个查询中提取更多内容(即“深度分页”)，您可以使用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html#search-after" rel="noopener ugc nofollow" target="_blank"> search_after </a>选项(您也可以使用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/scroll-api.html" rel="noopener ugc nofollow" target="_blank">滚动搜索</a>，但ES不再推荐这种方式)。还要注意，因为我们知道“TV Show”是<code class="fe ne nf ng nh b">type</code>字段可以取的值，所以我们也可以使用过滤器上下文。我将把DSL的这些和其他复杂之处留到以后的博客文章中。</p></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><p id="66d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！我们已经配置了一个ES集群，检查了集群的健康状况，定义了一个索引，编写了文档，并对我们的索引运行了一个简单的查询。请继续关注Elasticsearch上的未来博客文章，在那里我将深入探讨DSL和索引存储大小优化的细节。</p><p id="696b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><p id="c666" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="nd">支持我的工作:</em> </strong> <em class="nd">如果你喜欢这篇文章，愿意支持我的工作，请考虑</em> <a class="ae ky" href="https://medium.com/@ndgoet/membership" rel="noopener"> <em class="nd">通过我的推荐页面</em> </a> <em class="nd">成为付费媒体会员。如果你通过我的推荐页面</em>  <em class="nd">注册</em> <a class="ae ky" href="https://medium.com/@ndgoet/membership" rel="noopener"> <em class="nd">，订阅的价格是一样的，但是我会收取你每月的部分会员费。</em></a></p></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><p id="1cbd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你喜欢这篇文章，这里还有一些你可能喜欢的文章</p><div class="op oq gp gr or os"><a rel="noopener follow" target="_blank" href="/four-things-you-need-to-master-to-get-started-with-elasticsearch-c51bed6ae99d"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">开始使用Elasticsearch需要掌握的四件事</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">弹性研究概念和原则的简明概述</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">towardsdatascience.com</p></div></div><div class="pb l"><div class="pc l pd pe pf pb pg ks os"/></div></div></a></div><div class="op oq gp gr or os"><a rel="noopener follow" target="_blank" href="/getting-started-with-elasticsearch-query-dsl-c862c9d6cf7f"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">Elasticsearch查询DSL入门</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">使用Python Elasticsearch客户端，用特定领域语言编写Elasticsearch查询的实践指南</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">towardsdatascience.com</p></div></div><div class="pb l"><div class="ph l pd pe pf pb pg ks os"/></div></div></a></div><div class="op oq gp gr or os"><a rel="noopener follow" target="_blank" href="/how-to-build-a-relational-database-from-csv-files-using-python-and-heroku-20ea89a55c63"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">如何使用Python和Heroku从CSV文件构建关系数据库</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">通过三个简单的步骤免费构建您自己的PostgreSQL数据库</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">towardsdatascience.com</p></div></div><div class="pb l"><div class="pi l pd pe pf pb pg ks os"/></div></div></a></div><div class="op oq gp gr or os"><a rel="noopener follow" target="_blank" href="/optimising-disk-usage-in-elasticsearch-d7b4238808f7"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">优化弹性搜索中的磁盘使用</h2><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">towardsdatascience.com</p></div></div><div class="pb l"><div class="pj l pd pe pf pb pg ks os"/></div></div></a></div></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><p id="2291" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> <em class="nd">免责声明</em></strong><em class="nd">:“elastic search”和“Kibana”是Elasticsearch BV在美国和其他国家的商标。本文中对任何第三方服务和/或商标的描述和/或使用不应被视为对其各自权利持有人的认可。</em></p><p id="216c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nd">在依赖</em> <a class="ae ky" href="/@ndgoet" rel="noopener ugc nofollow" target="_blank"> <em class="nd">中的任何内容之前，请仔细阅读</em> <a class="ae ky" href="https://medium.com/@ndgoet/disclaimer-5ad928afc841" rel="noopener"> <em class="nd">本免责声明</em> </a> <em class="nd">【我的Medium.com文章】</em> </a> <em class="nd">。</em></p></div></div>    
</body>
</html>