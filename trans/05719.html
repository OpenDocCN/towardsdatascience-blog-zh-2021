<html>
<head>
<title>Automate Pivot Table with Python (Create, Filter and Extract)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python自动化数据透视表(创建、过滤和提取)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/automate-excel-with-python-pivot-table-899eab993966?source=collection_archive---------1-----------------------#2021-05-22">https://towardsdatascience.com/automate-excel-with-python-pivot-table-899eab993966?source=collection_archive---------1-----------------------#2021-05-22</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><h2 id="c5f5" class="is it iu bd b dl iv iw ix iy iz ja dk jb translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/automation-with-pywin32" rel="noopener" target="_blank">使用PyWin32实现自动化</a></h2><div class=""/><div class=""><h2 id="7b67" class="pw-subtitle-paragraph ka jd iu bd b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dk translated">自动化数据透视表并从过滤后的数据透视表中提取数据。省点时间喝杯茶吧。</h2></div><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj ks"><img src="../Images/69f48f31cea85ba672c8f4f39a61c41b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tbSkzGn9o9pWY3v3g0rB0g.jpeg"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated"><a class="ae li" href="https://unsplash.com/@thejasmine?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">黄茉莉</a>在<a class="ae li" href="https://unsplash.com/s/photos/tea?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="dcb0" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">在<a class="ae li" rel="noopener" target="_blank" href="/automate-excel-with-python-7c0e8c7c6256">使用Python自动化Excel</a>中，包含对象、属性、方法和事件的Excel对象模型的概念是共享的。用Python <code class="fe mf mg mh mi b">pywin32 </code>库访问Excel中的对象、属性和方法的技巧也用例子进行了解释。</p><p id="2da1" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">现在，让我们用<strong class="ll je">透视表</strong>来利用Excel报表的自动化，这是Excel中最精彩的功能之一！</p></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><h1 id="d37e" class="mq mr iu bd ms mt mu mv mw mx my mz na kj nb kk nc km nd kn ne kp nf kq ng nh bi translated">为什么选择PyWin32？</h1><p id="7150" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated">你可能会好奇为什么我们不用<code class="fe mf mg mh mi b">pandas </code>库中的<code class="fe mf mg mh mi b">pandas.DataFrame.pivot </code>或<code class="fe mf mg mh mi b">pandas.DataFrame.pivot_table</code>来代替呢？这是一个内置的库，我们甚至不需要安装它。</p><p id="46e6" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">嗯，上面提到的两个<code class="fe mf mg mh mi b">pandas</code>函数可以很容易地创建数据透视表，但是如果你正在准备一个其他域用户可以访问的Excel报表，创建的硬编码数据透视表可能不适合他们，因为他们不能修改数据透视表字段。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div class="gi gj nn"><img src="../Images/1a14cfec4fef6931fc8c682e024a54c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:850/format:webp/1*YSW2nlePQAxSZiv-Q2hQTw.png"/></div><p class="le lf gk gi gj lg lh bd b be z dk translated">数据透视表字段。图片作者。</p></figure><p id="34b6" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">上图显示了Excel中数据透视表的数据透视表字段，数据透视表根据游戏类型显示了不同地区的视频游戏销售额。使用交互式Excel数据透视表，领域用户可以自由选择任意数量的国家显示在数据透视表中，而由<code class="fe mf mg mh mi b">pandas</code>创建的硬编码数据透视表不能这样做。</p></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><p id="7ffb" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">在下面的例子中，使用的数据集是来自Kaggle的<a class="ae li" href="https://www.kaggle.com/sidtwr/videogames-sales-dataset?select=PS4_GamesSales.csv" rel="noopener ugc nofollow" target="_blank"> PS4游戏销售</a>数据。那么，用来创建数据透视表的脚本就是参考Trenton McKinney创建的笔记本，<a class="ae li" href="https://trenton3983.github.io/files/solutions/2020-06-22_pivot_table_win32com/create_pivot_table_with_win32com.html" rel="noopener ugc nofollow" target="_blank">如何用Python win32com模块</a>在Excel中创建数据透视表。在McKinney的笔记本中，他定义了用Python创建综合数据、数据透视表和Excel com对象的函数(他还展示了如何用Excel VBA实现)。</p><p id="b546" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">他很好地优化了脚本，因此，在下面的例子中，McKinney的脚本将用于在Excel中创建数据透视表。然后，我将解释如何访问数据透视表的组件，修改数据透视表的过滤器，并使用Python提取过滤后的数据以供进一步分析。</p></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><p id="cb34" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">为了更清楚地描述我们在下面的例子中要做的事情，让我解释一下这个例子的输入和输出。输入是CSV格式的PS4游戏销售额，如下图所示。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj no"><img src="../Images/4fb7c20dfbabfd93fbba79287876fcef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*olWxQug-slAcJ16Dk_2hLg.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">数据快照。作者创建的图像。</p></figure><p id="8840" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">这些属性包括游戏的名称、出版年份、游戏类型、出版商以及游戏在北美、欧洲、日本、世界其他地区的销量和全球销量。基于这些数据，我们将创建一个数据透视表，根据游戏类型来展示PS4游戏在每个地区的总销售额。下图显示了我们将使用Python <code class="fe mf mg mh mi b">pywin32</code>库创建的数据透视表。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj np"><img src="../Images/1d3b18594c0e3c61d3b337c09edf45df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bLQpcbGA2au0PLbA1j7kfA.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">在Excel中创建的数据透视表。作者创建的图像。</p></figure></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><h1 id="1bce" class="mq mr iu bd ms mt mu mv mw mx my mz na kj nb kk nc km nd kn ne kp nf kq ng nh bi translated">创建数据透视表并用pywin32操作它</h1><p id="c2ea" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated">以下部分有五个部分:</p><ol class=""><li id="d8ed" class="nq nr iu ll b lm ln lp lq ls ns lw nt ma nu me nv nw nx ny bi translated">导入库</li><li id="a162" class="nq nr iu ll b lm nz lp oa ls ob lw oc ma od me nv nw nx ny bi translated">读取和处理数据集</li><li id="b105" class="nq nr iu ll b lm nz lp oa ls ob lw oc ma od me nv nw nx ny bi translated">创建数据透视表</li><li id="da25" class="nq nr iu ll b lm nz lp oa ls ob lw oc ma od me nv nw nx ny bi translated">访问数据透视表的方法和属性</li><li id="4516" class="nq nr iu ll b lm nz lp oa ls ob lw oc ma od me nv nw nx ny bi translated">修改数据透视表的过滤器并提取过滤后的数据</li></ol><h1 id="bc0c" class="mq mr iu bd ms mt oe mv mw mx of mz na kj og kk nc km oh kn ne kp oi kq ng nh bi translated">导入库</h1><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="fc63" class="on mr iu mi b gz oo op l oq or">import win32com.client as win32<br/>import pandas as pd<br/>import numpy as np<br/>from pathlib import Path<br/>import re<br/>import sys<br/>win32c = win32.constants</span></pre><h1 id="257e" class="mq mr iu bd ms mt oe mv mw mx of mz na kj og kk nc km oh kn ne kp oi kq ng nh bi translated">读取和处理数据集</h1><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="9bd0" class="on mr iu mi b gz oo op l oq or">df = pd.read_csv("PS4_GamesSales.csv", encoding = 'unicode_escape', engine ='python')</span><span id="685e" class="on mr iu mi b gz os op l oq or"># remove null values<br/>df = df.dropna()</span><span id="8e64" class="on mr iu mi b gz os op l oq or"># write the csv file to xlsx File to create Pivot Table<br/>df.to_excel("PS4_GamesSales.xlsx", sheet_name = 'Sales', index = False)</span></pre><p id="17bd" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">由于数据集中存在特殊字符，在读取CSV文件时需要定义<code class="fe mf mg mh mi b">encoding </code>。有兴趣的话，<a class="ae li" href="https://stackoverflow.com/questions/61264795/pandas-unicodedecodeerror-utf-8-codec-cant-decode-bytes-in-position-0-1-in#61267213" rel="noopener ugc nofollow" target="_blank">这里有编码</a>的参考。</p><p id="bcc1" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">需要注意的一点是，当我们导出以后要用来创建透视表的数据时，我们必须设置<code class="fe mf mg mh mi b">index = False</code>。如果没有，我们可能会在创建数据透视表时遇到问题，因为该函数无法判断哪一行是标签行还是标题行。</p></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><h1 id="e47c" class="mq mr iu bd ms mt mu mv mw mx my mz na kj nb kk nc km nd kn ne kp nf kq ng nh bi translated">创建数据透视表</h1><p id="99ba" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated">创建数据透视表的脚本修改自McKinney 的<a class="ae li" href="https://trenton3983.github.io/files/solutions/2020-06-22_pivot_table_win32com/create_pivot_table_with_win32com.html" rel="noopener ugc nofollow" target="_blank">笔记本。脚本包含三个函数，分别是<code class="fe mf mg mh mi b"> pivot_table()</code>、<code class="fe mf mg mh mi b">run_excel()</code>和<code class="fe mf mg mh mi b">main()</code>。</a></p><p id="6369" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated"><code class="fe mf mg mh mi b">pivot_table()</code>函数用于将数据字段分配到各自的透视表字段中(过滤器、列、行和值)。</p><figure class="kt ku kv kw gu kx"><div class="bz fq l di"><div class="ot ou l"/></div></figure><p id="4862" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">该函数的最后一部分用于修改Excel对象模型的透视表对象的属性“行总计”和“列总计”值的可见性，其他属性请参见此处的<a class="ae li" href="https://docs.microsoft.com/en-us/office/vba/api/excel.pivottable" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="2000" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">下一个功能是<code class="fe mf mg mh mi b">run_excel()</code>。该函数用于创建Excel对象，然后为透视表创建新的工作表。将添加到数据透视表字段的数据字段(筛选器、列、行和值)将在此定义。</p><figure class="kt ku kv kw gu kx"><div class="bz fq l di"><div class="ot ou l"/></div></figure><p id="ad65" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">透视表创建后，<code class="fe mf mg mh mi b">wb.Save()</code>将保存Excel文件。如果不包含这一行，创建的数据透视表将会丢失。如果您正在运行此脚本以在后台或计划的作业中创建数据透视表，您可能希望分别通过<code class="fe mf mg mh mi b">wb.Close(True)</code>和<code class="fe mf mg mh mi b">excel.Quit()</code>关闭Excel文件并退出Excel对象。这样，您就不需要在作业完成后手动关闭Excel文件。或者，您可以设置<code class="fe mf mg mh mi b">excel.Visible = False</code>，那么Excel文件将不会从头开始打开。</p><figure class="kt ku kv kw gu kx"><div class="bz fq l di"><div class="ot ou l"/></div></figure><p id="066f" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated"><code class="fe mf mg mh mi b">main()</code>函数为主函数，它会调用<code class="fe mf mg mh mi b">run_excel()</code>函数，然后<code class="fe mf mg mh mi b">run_excel()</code>函数会执行<code class="fe mf mg mh mi b">pivot_table()</code>函数。</p><p id="2f6e" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">如果您运行该函数两次，将会出现错误，因为数据透视表被编程为在名为“pivot_table”的工作表中创建，而该工作表已在第一次运行中创建，您可以更改pt_name或删除在第一次执行中创建的工作表。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj ov"><img src="../Images/d183251c936083246cfd0644011924b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ipt_o--cABsa6VVjcXhoMQ.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">错误消息。作者创建的图像。</p></figure></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><h1 id="41c6" class="mq mr iu bd ms mt mu mv mw mx my mz na kj nb kk nc km nd kn ne kp nf kq ng nh bi translated">访问数据透视表的属性</h1><p id="320f" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated">可以通过操作数据透视表对象(<a class="ae li" href="https://docs.microsoft.com/en-us/office/vba/api/excel.pivottable" rel="noopener ugc nofollow" target="_blank">数据透视表对象</a>引用)的两个方法和五个属性来研究或修改数据透视表:</p><h2 id="9c23" class="on mr iu bd ms ow ox dn mw oy oz dp na ls pa pb nc lw pc pd ne ma pe pf ng ja bi translated">方法</h2><ol class=""><li id="d143" class="nq nr iu ll b lm ni lp nj ls pg lw ph ma pi me nv nw nx ny bi translated">清除所有过滤器</li><li id="4c21" class="nq nr iu ll b lm nz lp oa ls ob lw oc ma od me nv nw nx ny bi translated">透视项目</li></ol><h2 id="ac30" class="on mr iu bd ms ow ox dn mw oy oz dp na ls pa pb nc lw pc pd ne ma pe pf ng ja bi translated">性能</h2><ol class=""><li id="04ad" class="nq nr iu ll b lm ni lp nj ls pg lw ph ma pi me nv nw nx ny bi translated">当前页面(分组在数据透视字段对象下)</li><li id="c62d" class="nq nr iu ll b lm nz lp oa ls ob lw oc ma od me nv nw nx ny bi translated">页面范围</li><li id="07d5" class="nq nr iu ll b lm nz lp oa ls ob lw oc ma od me nv nw nx ny bi translated">行字段</li><li id="4f5d" class="nq nr iu ll b lm nz lp oa ls ob lw oc ma od me nv nw nx ny bi translated">列字段</li><li id="e022" class="nq nr iu ll b lm nz lp oa ls ob lw oc ma od me nv nw nx ny bi translated">表格范围1</li></ol><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj pj"><img src="../Images/b9e5569fd604aacdc8e541b133449949.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7fS6Yi_vQPemy1M7mjIbZA.jpeg"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">数据透视表的属性。作者创建的图像。</p></figure><p id="ceb0" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">上图显示了数据透视表的CurrentPage、PageRange和TableRange1。数据透视表字段的行字段和列字段如下图所示。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj pk"><img src="../Images/1e3e771bcd95ec97fbc8ccb5f9b97728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6XwDdUJVqIjTuUQtYjDdMA.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">数据透视表属性。作者创建的图像。</p></figure><p id="4452" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">上面提到的数据透视表方法和属性将在示例中使用，以提取过滤后的数据透视表的数据并保存到DataFrame中。</p></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><p id="34c1" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">首先，创建Excel对象。虽然Excel对象是在创建数据透视表的过程中创建的，但我们仍然需要再次创建它，因为Excel对象是在函数中创建的，不能结转。</p><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="8b06" class="on mr iu mi b gz oo op l oq or">f_path = Path.cwd()<br/>f_name = 'PS4_GamesSales.xlsx'<br/>filename = f_path / f_name<br/># create excel object<br/>excel = win32.gencache.EnsureDispatch('Excel.Application')</span><span id="fa16" class="on mr iu mi b gz os op l oq or"># excel can be visible or not<br/>excel.Visible = True  # False<br/>wb = excel.Workbooks.Open(filename)  <br/>pvtTable = wb.Sheets("pivot_table").Range("A3").PivotTable</span></pre></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><h2 id="a25e" class="on mr iu bd ms ow ox dn mw oy oz dp na ls pa pb nc lw pc pd ne ma pe pf ng ja bi translated">页面范围和当前页面属性，清除所有过滤器方法</h2><p id="11f5" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated"><strong class="ll je">页范围</strong>指的是透视表的筛选字段(字段名和值)，如下图所示。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div class="gi gj pl"><img src="../Images/3470b504fc3b3a9bf30dbf8bb3365390.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*F2O4SAUOygxyAqPZhVJUEg.png"/></div><p class="le lf gk gi gj lg lh bd b be z dk translated">PageRange和CurrentPage。作者创建的图像。</p></figure><p id="235c" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated"><strong class="ll je"> CurrentPage </strong>是指过滤器的值，用于设置一个过滤器<strong class="ll je">的值，而<strong class="ll je"> Page Range </strong>返回当前过滤器及其值。</strong></p><p id="9e10" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">下面的脚本打印页面范围，然后清除所有过滤器。</p><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="b9c5" class="on mr iu mi b gz oo op l oq or">page_range_item = []<br/>for i in pvtTable.PageRange:<br/>    page_range_item.append(str(i))<br/>    <br/>print(page_range_item)</span><span id="98db" class="on mr iu mi b gz os op l oq or">pvtTable.PivotFields("Year").ClearAllFilters()</span></pre><p id="94f9" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">为了提供更清晰的信息，下面的GIF显示了运行上面脚本的结果。我在开始时手动设置过滤器，然后打印页面范围。之后，脚本清除了所有过滤器，然后再次打印页面范围。GIF还展示了<code class="fe mf mg mh mi b">pywin32</code>有多棒，因为我们可以<strong class="ll je">立即看到对Excel的更改</strong>。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj pm"><img src="../Images/23ae008c318570865eec0ba2ea000130.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*YgtdIFNbbAzSEE8VyaYvrw.gif"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">作者创建的GIF。</p></figure><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="9f08" class="on mr iu mi b gz oo op l oq or">pvtTable.PivotFields("Year").CurrentPage = "2020"<br/>page_range_item = []<br/>for i in pvtTable.PageRange:<br/>    page_range_item.append(str(i))<br/>    <br/>print(page_range_item)</span></pre><p id="2169" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">现在，让我们使用当前页面的透视字段属性来修改过滤器。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj pm"><img src="../Images/c75a09993b0efc0bfd17beabf7975f88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*kueGODSlm-yCE0a9bBBVCQ.gif"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">作者创建的GIF。</p></figure><p id="3faa" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">因为我们必须在修改当前页面时指定Pivot字段，所以它只能用于一次修改一个过滤器的值。</p><p id="cd83" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">在本例中，我们仅使用一个值进行过滤。过滤多个值的方法显示在最后一个示例中，这也是修改数据透视表过滤器然后提取过滤数据的完整示例。</p></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><h2 id="f059" class="on mr iu bd ms ow ox dn mw oy oz dp na ls pa pb nc lw pc pd ne ma pe pf ng ja bi translated"><strong class="ak">行字段/列字段</strong></h2><p id="a730" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated">行字段和列字段将列出创建透视表时透视表字段中添加到行字段或列字段的所有字段。</p><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="82f4" class="on mr iu mi b gz oo op l oq or">row_fields_item = []<br/>for i in pvtTable.RowFields:<br/>    row_fields_item.append(str(i))<br/>    <br/>print(row_fields_item)</span><span id="ce77" class="on mr iu mi b gz os op l oq or">column_fields_item = []<br/>for i in pvtTable.ColumnFields:<br/>    column_fields_item.append(str(i))<br/>    <br/>print(column_fields_item)</span></pre><p id="bd6b" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">在我们的例子中，行字段是“类型”,而列字段是自动生成的“值”。但是，我们可以用下面的脚本禁用它。</p><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="e245" class="on mr iu mi b gz oo op l oq or">wb.Sheets("pivot_table").PivotTables("example").DisplayFieldCaptions = False</span></pre><p id="4704" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">下面的GIF说明了上面脚本的结果。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj pn"><img src="../Images/bc0143cc800c1e2b037e5ff42fd6337a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*iZpJQQBiOwXodMAoIbIa3g.gif"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">作者创建的GIF。</p></figure><p id="0e83" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">“值”和“行标签”是字段标题，而不是数据字段。脚本与下面的操作相同。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj po"><img src="../Images/8fc7bfce13b5774c3e4c4f8405329e1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*-yvppZbcorpPZ0CTAfSSCQ.gif"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">作者创建的GIF。</p></figure></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><h2 id="6a44" class="on mr iu bd ms ow ox dn mw oy oz dp na ls pa pb nc lw pc pd ne ma pe pf ng ja bi translated"><strong class="ak">表格范围1 </strong></h2><p id="8389" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated">TableRange1打印不带页范围的数据，如果还想打印页字段，可以参考透视表的TableRange2属性。</p><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="900f" class="on mr iu mi b gz oo op l oq or">table_data = []<br/>for i in pvtTable.TableRange1:<br/>    #print(i)<br/>    table_data.append(str(i))<br/>    <br/>print(table_data)</span></pre><p id="89a9" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">表区域1属性以列表形式返回结果。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj pp"><img src="../Images/69d466d5108caa6bf8bdea53568737cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4rg8D9-63GvS4lj22KnCPQ.png"/></div></div></figure><p id="1104" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">要将列表转换成数据帧，我们需要知道数据透视表的实际维度。通过在创建透视表的脚本中添加<code class="fe mf mg mh mi b">pt_fields</code>并为行项目的列添加1，可以很容易地确定列的数量。在本例中，<code class="fe mf mg mh mi b">pt_fields</code>中有五个项目，“北美总销售额”、“欧洲总销售额”、“日本总销售额”、“世界其他地区总销售额”、“全球总销售额”。所以有了<code class="fe mf mg mh mi b">number of columns = 5 + 1 = 6</code>。</p><p id="dd5c" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">复杂的部分是确定行数。在本文的示例中，有三行<strong class="ll je"/>是根据列字段标题(“值”)、数据透视表字段行(“北美总销售额”、“欧洲总销售额”、“日本总销售额”、“世界其他地区总销售额”、“全球总销售额”)和列的总计构建的。其他行是经过过滤后的行字段中的<strong class="ll je">项。</strong></p><p id="a602" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">我通过使用RegEx删除列字段(" Values ")和<code class="fe mf mg mh mi b">pt_fields</code>项、其他标签(如"行标签"、"列标签"、"总计"和"无")以及数据透视表中的所有数值，获得了行字段中的项数。</p><figure class="kt ku kv kw gu kx"><div class="bz fq l di"><div class="ot ou l"/></div></figure><p id="db6b" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">在获得数据透视表的列数和行数之后，可以将表范围1中的列表整形为DataFrame。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj pq"><img src="../Images/ebae822857503138b302a26a1cb55bc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8FF2xi6SeM7j4Cs3k78ZMQ.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">将列表重塑为作者创建的数据帧图像。</p></figure><p id="fc99" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">在这个阶段，数据帧不能检测到正确的标题，即表格的第二行。因此，我们将第二行(row index = 1)设置为header，然后删除前两行。有多种方法可以做到这一点，您可以重命名该列，然后删除前两行。</p><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="d0e2" class="on mr iu mi b gz oo op l oq or">df.columns=df.iloc[1]<br/>df = df.drop(index = 0)<br/>df = df.drop(index = 1)</span></pre></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><h1 id="4dd0" class="mq mr iu bd ms mt mu mv mw mx my mz na kj nb kk nc km nd kn ne kp nf kq ng nh bi translated">修改数据透视表的过滤器并提取过滤后的数据</h1><p id="6722" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated">现在，让我们将所有内容结合起来，根据条目列表修改过滤器，然后提取过滤后的数据透视表数据并将其保存为DataFrame。</p><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="c87f" class="on mr iu mi b gz oo op l oq or"># Find all items in Year<br/>year_items = []<br/>for item in pvtTable.PivotFields("Year").PivotItems():<br/>    year = str(item)<br/>    year_items.append(year)</span><span id="d2b8" class="on mr iu mi b gz os op l oq or">year_to_include = ['2013','2014','2015']<br/>year_to_exclude = [x for x in year_items if x not in year_to_include]</span></pre><p id="b8da" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">在我们修改过滤器之前，知道过滤器中包含的项目的确切数量是很重要的。在我们的例子中，过滤器是“年”。这一步可以通过使用Pivot Table方法来完成，Pivot Items()如上面的脚本所示。</p><p id="4d93" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">下面是修改过滤器的完整函数，然后将过滤后的数据透视表提取为DataFrame。</p><figure class="kt ku kv kw gu kx"><div class="bz fq l di"><div class="ot ou l"/></div></figure><p id="d9ea" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">让我们在下面的GIF中见证这一点。</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj pr"><img src="../Images/61571ec9665fdbdad5ffbcadfa8eb567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*wVpVDryGeR81tcV59jFPtQ.gif"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">作者创建的GIF</p></figure><h1 id="257d" class="mq mr iu bd ms mt oe mv mw mx of mz na kj og kk nc km oh kn ne kp oi kq ng nh bi translated">额外收获:创建不同数据透视表的多个工作表</h1><p id="9886" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated">收到关于如何创建不同数据透视表的多个工作表的询问。我们可以修改<code class="fe mf mg mh mi b">run_excel()</code>函数来实现。</p><figure class="kt ku kv kw gu kx"><div class="bz fq l di"><div class="ot ou l"/></div></figure><p id="223e" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">我们只需要复制脚本中设置和调用<code class="fe mf mg mh mi b">pivot_table()</code>函数的部分。记得根据需要修改细节。最重要的是，我们需要更改保存新工作表标题和新工作表对象的变量名。如果没有，您可能想知道为什么在工作簿中只创建了一个数据透视表。😂我在下面的代码中加粗了您可能需要注意的变量名。</p><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="cb70" class="on mr iu mi b gz oo op l oq or"># Setup second pivot table and call pivot_table</span><span id="8ede" class="on mr iu mi b gz os op l oq or"><strong class="mi je">ws3_name </strong>= 'pivot_table_2'<br/>wb.Sheets.Add().Name = <strong class="mi je">ws3_name</strong><br/><strong class="mi je">ws3 </strong>= wb.Sheets(<strong class="mi je">ws3_name</strong>)</span><span id="7f3e" class="on mr iu mi b gz os op l oq or">pt_name = 'example'  # must be a string<br/>pt_rows = ['expense']  # must be a list<br/>pt_cols = ['products']  # must be a list<br/>pt_filters = ['date']  # must be a list</span><span id="3b8c" class="on mr iu mi b gz os op l oq or"># [0]: field name [1]: pivot table column name [3]: calulation method [4]: number format<br/>pt_fields = [['price', 'price: mean', win32c.xlAverage, '$#,##0.00']]  # must be a list of lists</span><span id="c825" class="on mr iu mi b gz os op l oq or">pivot_table(wb, ws1, <strong class="mi je">ws3</strong>, <strong class="mi je">ws3_name</strong>, pt_name, pt_rows, pt_cols, pt_filters, pt_fields)</span></pre><p id="d33f" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">谢谢你读到这里，这是我知道的一篇长文。这之后还有一点，如果你想在工作中使用<code class="fe mf mg mh mi b">pywin32</code>，这是必不可少的。</p></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><h1 id="af28" class="mq mr iu bd ms mt mu mv mw mx my mz na kj nb kk nc km nd kn ne kp nf kq ng nh bi translated">你可能面临的错误</h1><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj ps"><img src="../Images/38eecbce95ceb70ee03a3c6e24803513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MuUf0Vg6y7DBmlEuqPhRZw.png"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">错误。作者图片</p></figure><p id="d7c5" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">在执行创建数据透视表的脚本时，我遇到过几次这样的错误。幸运的是，我在<a class="ae li" href="https://stackoverflow.com/questions/52889704/python-win32com-excel-com-model-started-generating-errors" rel="noopener ugc nofollow" target="_blank">栈溢出</a>上找到了解决方案。解决办法很简单。我们只需要删除下面脚本返回的路径中的文件夹标题“00020813–0000–0000–C000–00000000046 x 0x 1 x 9”。</p><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="8144" class="on mr iu mi b gz oo op l oq or">import win32com<br/>print(win32com.__gen_path__)</span></pre><p id="2795" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">由于这是一个周期性(不是每天)出现的重复问题，我建议您运行以下脚本，在显示错误时直接删除文件夹。</p><pre class="kt ku kv kw gu oj mi ok ol aw om bi"><span id="3180" class="on mr iu mi b gz oo op l oq or">import win32com<br/>import shutil<br/>path = win32com.__gen_path__<br/>shutil.rmtree(path)</span></pre></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><h1 id="10a5" class="mq mr iu bd ms mt mu mv mw mx my mz na kj nb kk nc km nd kn ne kp nf kq ng nh bi translated">边注</h1><p id="e8c0" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated">如果你对Excel对象模型的对象、方法和属性感到困惑，或者想知道如何将Excel VBA的脚本翻译成Python，可以看看<a class="ae li" rel="noopener" target="_blank" href="/automate-excel-with-python-7c0e8c7c6256">用Python </a>自动化Excel。</p><p id="1de1" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">如果您有兴趣使用Python创建图表或数据透视图，并将其自动导出为图像，请使用Python自动制作Excel图表。</p><p id="1b79" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">如果你有兴趣知道如何使用<code class="fe mf mg mh mi b">pywin32</code>访问Microsoft Outlook邮件和下载附件，你可以参考这篇文章“用Python自动下载邮件附件<a class="ae li" rel="noopener" target="_blank" href="/automatic-download-email-attachment-with-python-4aa59bc66c25">”。</a></p><p id="3665" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated">如果您的工作使用Google Sheet而不是Microsoft Excel，您可以参考这篇文章“自动化Google Sheet Report<a class="ae li" rel="noopener" target="_blank" href="/automate-google-sheet-reporting-in-5-minutes-8bbdc1f8e293">”以了解可能的自动化。</a></p><h1 id="3ec4" class="mq mr iu bd ms mt oe mv mw mx of mz na kj og kk nc km oh kn ne kp oi kq ng nh bi translated">保持联系</h1><p id="458a" class="pw-post-body-paragraph lj lk iu ll b lm ni ke lo lp nj kh lr ls nk lu lv lw nl ly lz ma nm mc md me in bi translated">在YouTube<a class="ae li" href="https://www.youtube.com/channel/UCiMtx0qbILP41Ot-pkk6eJw" rel="noopener ugc nofollow" target="_blank">上订阅</a></p><h1 id="a593" class="mq mr iu bd ms mt oe mv mw mx of mz na kj og kk nc km oh kn ne kp oi kq ng nh bi translated">参考</h1><ol class=""><li id="98f2" class="nq nr iu ll b lm ni lp nj ls pg lw ph ma pi me nv nw nx ny bi translated"><a class="ae li" href="https://trenton3983.github.io/files/solutions/2020-06-22_pivot_table_win32com/create_pivot_table_with_win32com.html" rel="noopener ugc nofollow" target="_blank">如何用Python win32com模块在Excel中创建透视表</a></li><li id="2420" class="nq nr iu ll b lm nz lp oa ls ob lw oc ma od me nv nw nx ny bi translated"><a class="ae li" href="https://docs.microsoft.com/en-us/office/vba/api/overview/excel" rel="noopener ugc nofollow" target="_blank"> Excel VBA参考</a></li></ol></div><div class="ab cl mj mk hy ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="in io ip iq ir"><p id="863d" class="pw-post-body-paragraph lj lk iu ll b lm ln ke lo lp lq kh lr ls lt lu lv lw lx ly lz ma mb mc md me in bi translated"><em class="pt">祝贺并感谢你阅读到最后。希望你喜欢这篇文章。</em> ☺️</p><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj pu"><img src="../Images/935761c29c046d2efede46caf30e23e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TVe9BdkAClo8SGQ1Jwi7PQ.jpeg"/></div></div><p class="le lf gk gi gj lg lh bd b be z dk translated">亚历山大·莱多戈罗夫在<a class="ae li" href="https://unsplash.com/s/photos/peace?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure></div></div>    
</body>
</html>