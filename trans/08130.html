<html>
<head>
<title>Heart Disease Classification using Transformers in PyTorch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PyTorch中使用变压器的心脏病分类</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/heart-disease-classification-using-transformers-in-pytorch-8dbd277e079?source=collection_archive---------20-----------------------#2021-07-26">https://towardsdatascience.com/heart-disease-classification-using-transformers-in-pytorch-8dbd277e079?source=collection_archive---------20-----------------------#2021-07-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f911" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">心脏病是一个重要的问题，深度学习可以解决问题。变形金刚是未来:当我们把一切结合起来会发生什么？</h2></div><p id="297f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，将实现并讨论使用心电图(ECG/ EKG)数据的心房颤动(AF)分类系统。分类系统将是二元的(正常窦性心律，AF ),并将基于使用PyTorch框架的变压器网络。本文的结构如下:首先，将介绍手头的问题以及所用的数据；其次，将介绍网络的技术细节；第三，将介绍网络的实施和培训；最后，将介绍结果和讨论。这个项目的资源库可以在这里找到:<a class="ae lb" href="https://github.com/bh1995/AF-classification" rel="noopener ugc nofollow" target="_blank">https://github.com/bh1995/AF-classification</a>。</p><h1 id="11a8" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">心房颤动分类问题</h1><p id="3e01" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">心脏病是全球死亡的主要原因之一[1]。心脏病通常会导致心脏行为的不规则，称为心律不齐。在所有类型的心律失常中，心房纤维性颤动(AF)是最常见的心律失常，估计其在2%至4%的人群中流行；随着人口平均年龄的增加，预计将来流行率将线性增加。根据目前的统计数据，任何一个欧洲血统的人一生中患房颤的概率约为37%[2]。标准的心脏监测技术是心电图(ECG/ EKG)，它监测心脏中的电信号，因此对于临床医生诊断心律失常非常有用。这个项目的目的是利用真实的、公开可用的、已经被临床医生标记的心电图数据来训练深度学习模型。</p><p id="1f98" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本项目中使用的数据来自多个来源，即2018年中国生理信号挑战赛(CPSC2018)[3]、圣彼得堡英卡特12导联心律失常数据库[4]、佐治亚州12导联心电图挑战赛数据库(CinC2020)[5]、2017年心脏病挑战赛生理网络计算(CinC2017)数据集[5]、背景心律失常数据库(CACHET-CADB)[6]。</p><p id="230c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所使用的数据源以不同的采样率收集他们的ECG数据，并且使用不同的设备(有些使用Holter监护仪，有些使用医院级12导联ECG)，这导致每个数据源的性质略有不同。为了增加深度学习模型的学习能力，明智的做法是以规范化的方式处理所有数据。在这个项目中，所有信号都使用了带通滤波器(FIR滤波器),因此只保留了[0.5，40]范围内的频率。信号还以300 Hz的速率被重新采样，并被分成长度为10秒的单个片段(因此模型的每个输入是长度为3000个数据点的一维数组)。然后对每10秒的片段进行归一化，使得所有值都在0和1之间。下图显示了两个原始(raw)信号(一个AF和一个normal)以及预处理后的两个相同信号。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi lz"><img src="../Images/53c683578fefbffb3ca3b8c2deed1c8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bkpJ5BBu6-0e71955Teudw.jpeg"/></div></div><p class="ml mm gj gh gi mn mo bd b be z dk translated">显示房颤(左)和健康正常窦性心律(右)原始信号的图。</p></figure><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mp"><img src="../Images/b66643e78a69655babf1e635764313bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wdm9gs4UeCTupVvHoorZMA.jpeg"/></div></div><p class="ml mm gj gh gi mn mo bd b be z dk translated">显示房颤(左)和健康正常窦性心律(右)的预处理信号的图。</p></figure><p id="1e33" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一幅图像中的信号图显示了标准、清晰的10秒长ECG记录。图中的y轴代表电压差，x轴代表采样速率，本例中为300 Hz。从图中可以看出，一个人的心脏电压与另一个人的不同。对于我们人类来说，显然是在x轴上寻找一种模式，而不是在y轴上看振幅。然而，深度学习模型以无偏见的方式计算特征，因此会天真地使用所有给定的信息(即使幅度通常与心律失常分类无关)。这就是为什么将数据标准化到给定的时间间隔(例如[-1，1]或[0，1])。上图显示了一个房颤的例子，这可以从一些心跳之间的不规则间隔中看出。这种情况是一个“简单”的例子，因为即使是业余爱好者也能清楚地看到AF信号的异常。</p><p id="402e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本项目使用的完整数据集可通过<a class="ae lb" href="https://drive.google.com/drive/folders/1PONXv-dtV26nqTFz_EBEhEufLQiETycF?usp=sharing" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir">链接</strong> </a>下载。数据全部经过预处理，以数组的形式保存在<strong class="kh ir"> .h5 </strong>文件格式中。下面的代码片段显示了如何加载数据集的示例。</p><figure class="ma mb mc md gt me"><div class="bz fp l di"><div class="mq mr l"/></div><p class="ml mm gj gh gi mn mo bd b be z dk translated">为此项目加载数据集。</p></figure><h1 id="6345" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated"><strong class="ak">型号描述</strong></h1><p id="d7ce" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">本项目测试了两个模型，它们都遵循相同的基本架构，但使用不同的输入。第一种模型使用预处理的ECG信号作为其唯一的输入，而第二种模型使用预处理的ECG信号以及该信号的所谓RRI (RR-interval)。RRI是一个心跳和连续心跳之间的估计时间，以秒为单位。通过使用泛汤普金斯算法[10]估计信号中的R峰(每个心跳的中间位置),然后使用以下等式来计算RRI。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/df15d8b29d29008fc8cebbf1c1b7c032.png" data-original-src="https://miro.medium.com/v2/resize:fit:286/format:webp/1*7wPwQ-O0n-TSdeiLS5w7pg.png"/></div></figure><p id="bb73" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">其中<em class="mt"> Rn </em>为给定峰值，<em class="mt"> fs </em>为频率(采样率)。为了保持模型的输入RRI序列的固定长度，使用总RRI的前10个，并且如果发现少于10个，则补零。</p><p id="a814" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">项目中使用的模型受到了[8]工作的启发。该模型由以下模块组成:1)由一系列卷积层组成的嵌入网络，2)变换器编码器层的堆叠，3)由一系列全连接层组成的分类头。模型架构和模型训练的代码可以在<a class="ae lb" href="https://github.com/bh1995/AF-classification" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="8e00" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">嵌入</strong>:嵌入网络将一维卷积应用于原始ECG信号，这导致一系列嵌入表示(<em class="mt"> x[0]，…，x[n] </em>)。这些嵌入的表示与位置编码(<em class="mt"> p[0]，…，p[n] </em>)相加，以表示每个序列的顺序，如原始transformer论文中所做的那样[7]。结果是位置编码嵌入，<em class="mt"> e = </em> ( <em class="mt"> x[0]+p[0]，…，x[n]+p[n] </em>)，然后用作堆叠变换器编码器层模块的输入。</p><p id="6db8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">转换器编码器层:</strong>转换器模块由堆叠的转换器编码器层组成，其中每个编码器由多头自关注机制子层组成，经过反复试验，发现四个编码器层和头产生了良好的结果。同样，经过反复试验，编码器内的嵌入维数被选择为<em class="mt"> 64 </em>，编码器层内的前馈网络的维数被选择为<em class="mt"> 512 </em>。转换器模块的输出是具有形状、[序列长度、批量大小、嵌入]的注意力权重的张量。必须以某种方式转换输出，以便将其输入分类头模块，即需要将其转换为形状[批量大小，嵌入]。尝试了两种方法，第一种是简单地取序列维度上张量的平均值，第二种是使用自我注意力集中层，如[9]的工作中所建议的。两种方法都表现出良好的性能，然而，利用自我注意池层产生了最好的结果。自我注意力集中层被应用于变换器模块的输出，该变换器模块产生嵌入，该嵌入是编码器序列中特征的学习平均。</p><p id="d764" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">分类头:</strong>自我注意力池的输出被用作最终分类头的输入，以产生用于预测的逻辑。最终的分类头是两个完全连接的层，中间有一个分离层。</p><h1 id="f1b6" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">培养</h1><p id="ca2f" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">使用二进制交叉熵作为损失函数，AdamW算法作为优化器来训练该模型(<em class="mt"> β1=0.9，β2=0.98，ε=10^(-9) </em>)。10^(-3的初始学习速率),并且使用学习调度器来在前30个时期之后开始每五个时期将学习速率降低5%。该数据集总共有52 370个10秒长的ECG信号，其中正常与房颤标记的比例大致相等。随机选择数据集的85% (44 514)用于训练，剩余的15% (7 855)用于测试。使用的批量大小为10，并且在云计算环境中使用特斯拉P100 GPU进行训练。</p><h1 id="1cc3" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated"><strong class="ak">结果</strong></h1><p id="faef" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">两种模型的结果将在下面给出，首先是仅使用原始ECG信号的模型，然后是使用原始ECG信号以及该信号的RRI的模型。</p><p id="206a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">使用原始ECG信号:</strong></p><p id="910b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如下图所示，该模型显示了各时期的一致学习，没有任何相当大的过度拟合。测试准确度也持续增长。由于这项任务是对疾病的二元分类，敏感性和特异性可以说是一个更好的性能指标。训练结束时测试数据上的<strong class="kh ir">灵敏度</strong>和<strong class="kh ir">特异性</strong>分别为<strong class="kh ir"> 85.6 </strong>和<strong class="kh ir"> 92.7 </strong>。训练时间大约是每个时期178秒。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mu"><img src="../Images/4d507971b4592d3f3b2e2d0122ba52fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RSY1flkcNs3EAZWZauDY4w.png"/></div></div><p class="ml mm gj gh gi mn mo bd b be z dk translated">各时期的训练(橙色)和测试(蓝色)数据的损失曲线。</p></figure><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mu"><img src="../Images/9c42514d86e3b8c704046bc58b7a8a27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s9Kui6GvpBbWlPrG-Nvi8w.png"/></div></div><p class="ml mm gj gh gi mn mo bd b be z dk translated">跨时期测试数据模型的准确性。</p></figure><p id="f0b6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">使用原始ECG信号和RRI:</strong></p><p id="3655" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当在训练/推断期间使用RRI特征时，模型性能提高。下图显示，模型显示出明显的过度拟合迹象，但是，这种过度拟合不会对各时期测试数据的模型准确性产生负面影响。训练结束时测试数据的<strong class="kh ir">灵敏度</strong>和<strong class="kh ir">特异性</strong>分别为，<strong class="kh ir"> 96.9 </strong>和<strong class="kh ir"> 95.6 </strong>。训练时间大约是每个纪元1550秒。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mu"><img src="../Images/42071dad2bc874a1a627450221b1a7d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zulZQCEZMeA4wIAajPBREA.png"/></div></div><p class="ml mm gj gh gi mn mo bd b be z dk translated">各时期的训练(橙色)和测试(蓝色)数据的损失曲线。</p></figure><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi mu"><img src="../Images/4cf4f4fd14ee68a7bd24b7cdd0a4efcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9_wlpfjO1rxJd0PozGlcQQ.png"/></div></div><p class="ml mm gj gh gi mn mo bd b be z dk translated">跨时期测试数据模型的准确性。</p></figure><h1 id="183a" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">结论</h1><p id="5d37" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">从结果可以清楚地看出，基于变换器编码器的网络在对10秒长的ECG信号中的AF进行分类方面工作良好。同样清楚的是，使用RRI特征以训练和推理时间增加近九倍为代价，提供了模型性能的巨大改进。这种时间增加归因于用于执行R峰检测的泛汤普金斯算法很慢的事实。</p><h1 id="6a23" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">参考</h1><p id="ec8e" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">[1]心脏病和中风统计2018年更新:来自美国心脏协会的报告。美国心脏协会，1，2018。</p><p id="84d9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[2]与欧洲心胸外科协会(EACTS)合作制定的2020年欧洲心脏病学会房颤诊断和管理指南:欧洲心脏病学会(ESC)房颤诊断和管理特别工作组在ESC欧洲心律协会(EHRA)的特殊贡献下制定。欧洲心脏杂志，2020年8月。ehaa612。</p><p id="0ffe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[3]刘芳芳、刘春燕、赵良英、张晓燕、吴晓林、徐晓燕、刘延林、马春燕、魏胜生、何志清、李俊卿和郭念英。一个用于评估心电图节律和形态学异常检测算法的开放式数据库。医学影像与健康信息学杂志，2018，8(7):1368–1373。</p><p id="1cee" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[4] Goldberger，a .，Amaral，l .，Glass，l .，Hausdorff，j .，Ivanov，P. C .，Mark，r .，&amp; Stanley，H. E. (2000年)。生理银行、生理工具包和生理网:复杂生理信号新研究资源的组成部分。循环[在线]。101 (23)，第e215–e220页。</p><p id="95db" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[5]佩雷斯·阿尔代·埃、古·阿、沙阿·阿吉、罗比肖·阿吉、黄艾、刘·阿吉、刘·阿吉、拉德·阿吉、埃罗拉·阿吉、塞耶迪·阿吉、李q、沙尔马·阿吉、克利福德GD *、雷纳·马*。12导联心电图的分类:2020年心脏病学挑战中的生理网络/计算。生理测量。41 (2020).</p><p id="cd26" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[6] Devender Kumar、Sadasivan Puthusserypady和Jakob Eyvind Bardram。CADB纪念印。2021年5月5日。<a class="ae lb" href="https://doi.org/10." rel="noopener ugc nofollow" target="_blank">https://doi.org/10.</a>11583/dtu . 14547264 . v1</p><p id="6e41" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[7]瓦斯瓦尼，a .，布雷恩，g .，沙泽尔，n .，帕尔马，n .，乌兹科雷特，j .，琼斯，l .，戈麦斯，A. N .，凯泽，l .，&amp;波洛苏欣，I .注意力是你所需要的一切，。arXiv:1706.03762v5。</p><p id="5726" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[8] A .纳塔拉扬，<em class="mt">等</em>..用于12导联心电图分类的宽深度变压器神经网络。<em class="mt"> 2020年心脏病学计算</em>，2020年，第1–4页，doi: 10.22489/CinC.2020.107</p><p id="491e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">[9]萨法里出版社，印度，m .，&amp;赫尔南多，J..说话人识别的自我注意编码和汇集。arXiv:2008.01077v1</p><p id="8638" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">10潘杰和汤普金斯。一种实时QRS检测算法。IEEE生物医学工程汇刊，BME-32卷，第3期，第230-236页，1985年3月，doi: 10.1109/TBME.1985.325532</p></div></div>    
</body>
</html>