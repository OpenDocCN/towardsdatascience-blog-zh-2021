<html>
<head>
<title>Speed-up your Numpy Operations with NumExpr Package</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用NumExpr包加速你的Numpy操作</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/speed-up-your-numpy-operations-with-numexpr-package-1bead7f5b520?source=collection_archive---------23-----------------------#2021-10-07">https://towardsdatascience.com/speed-up-your-numpy-operations-with-numexpr-package-1bead7f5b520?source=collection_archive---------23-----------------------#2021-10-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6d84" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用多线程功能加速您的数字运算</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f3fd0554a1092a4097416beb8e10dba5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NVnrDO2OkPr6pmwhc5gj_w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=4787149" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/asimalways-15006432/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=4787149" rel="noopener ugc nofollow" target="_blank"> Ashim Shres </a></p></figure><p id="fa91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Numpy是数据科学社区中一个流行的Python包，它提供了大量高级数学函数来操作这些多维数组。在数据科学案例研究中，经常会遇到对大型向量执行数学运算的情况。</p><p id="1ca3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Numpy提供了快速和优化的矢量化函数来加速数学运算，但不涉及并行性。在本文中，我们将介绍NumExpr包，它是NumPy的一个快速数值表达式计算器。</p><h1 id="496c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">NumExpr入门:</h1><p id="3d06" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Numexpr是一个完全基于NumPy 1.6中引入的新数组迭代器的开源Python包。Numexpr计算作为参数传递给<code class="fe ms mt mu mv b"><strong class="lb iu">evaluate</strong></code>函数的字符串表达式。使用Python编译函数计算字符串函数，以找到变量和表达式。</p><p id="efbc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，a和b是两个NumPy数组。要添加这两个数组，需要传递<code class="fe ms mt mu mv b"><strong class="lb iu">numexpr.evaluate(“a+b”)</strong></code> <strong class="lb iu"> </strong>，其中<code class="fe ms mt mu mv b"><strong class="lb iu">a+b</strong></code>是字符串表达式。然后通过构建表达式的解析树来计算字符串表达式。这个解析树结构然后被编译成字节码程序，它描述了如何执行基于元素的操作。</p><h2 id="2768" class="mw lw it bd lx mx my dn mb mz na dp mf li nb nc mh lm nd ne mj lq nf ng ml nh bi translated">NumExpr如何加速计算？</h2><p id="3adb" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">NumExpr通过将符号赋值器数值Python表达式转换为高性能的矢量化代码，并在元素块中进行矢量化，而不是一次性编译所有内容，从而实现了并行性。</p><p id="66f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">NumExpr比NumPy实现了更好的性能，因为它避免了为中间结果分配内存，从而提高了缓存利用率并减少了一般的内存访问。还有，NumExpr虚拟机完全是用C语言写的，这使得它比Python快。因此，NumExpr最适合大型数组。</p><h2 id="b21e" class="mw lw it bd lx mx my dn mb mz na dp mf li nb nc mh lm nd ne mj lq nf ng ml nh bi translated">预期绩效:</h2><p id="e461" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">根据<a class="ae ky" href="https://numexpr.readthedocs.io/projects/NumExpr3/en/latest/intro.html" rel="noopener ugc nofollow" target="_blank"> NumExpr文档</a>，NumPy运算的计算速度有望提高2到4倍。这完全取决于表达式的复杂性和操作符的内部优化。使用大型阵列或非对齐阵列时，性能可能会提高20倍。</p><h1 id="f3a8" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">实施:</h1><p id="e18e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">NumExpr包可以使用<code class="fe ms mt mu mv b"><strong class="lb iu">pip install numexpr</strong></code> <strong class="lb iu"> </strong>从PyPI安装。</p><h2 id="746d" class="mw lw it bd lx mx my dn mb mz na dp mf li nb nc mh lm nd ne mj lq nf ng ml nh bi translated">简单的数学运算:</h2><p id="0e02" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">让我们从两个NumPy数组(a和b)的简单数学运算开始，每个数组都有10⁷元素。与Python操作相比，我们使用NumExpr获得了几乎4.2倍的加速——从337毫秒到79毫秒。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/0e840edcae96e108ee5f7df1114441ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XDkG-tOWxsWmglmpwl8cJg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)，与NumExpr的简单操作对比</p></figure><h2 id="e78a" class="mw lw it bd lx mx my dn mb mz na dp mf li nb nc mh lm nd ne mj lq nf ng ml nh bi translated">逻辑运算:</h2><p id="98e0" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在执行一些逻辑表达式和布尔过滤时，我们通过NumExpr获得了13倍的加速——从644毫秒到52毫秒。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/46c7582e7e6b31feffda0346c66c97e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jx7RPsORzC_c4XCqysjuvg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)，与NumExpr的复杂逻辑运算比较</p></figure><h2 id="4a1d" class="mw lw it bd lx mx my dn mb mz na dp mf li nb nc mh lm nd ne mj lq nf ng ml nh bi translated">未对齐的数组操作:</h2><p id="042d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">对于未对齐的数组，与Python NumPy操作相比，加速要高得多。使用NumExpr，我们可以实现大约32倍的增长</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/0e4a7c18b9ca79b7047039c128e76a9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fW2_P2-F1y3rC6GYcPYeMQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)，非对齐数组操作与NumExpr的比较</p></figure><p id="09e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">配置:</strong></p><p id="9b5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用NumExpr，您还可以使用<code class="fe ms mt mu mv b"><strong class="lb iu">numexpr.set_num_threads()</strong></code>函数指定内核的数量。</p><h1 id="a130" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论:</h1><p id="c257" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在本文中，我们讨论了一个开源Python包NumExpr，它通过向量化元素块而不是一次性编译所有元素来实现并行性，从而加快数学运算的速度。与NumPy操作相比，速度可以提高2到20倍，具体取决于各种条件。</p><p id="8457" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">NumExpr是一个很好的工具，可以加速大型数组的数学运算。</p><h1 id="d0cf" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">参考资料:</h1><p id="8a4d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">[1] NumExpr文档:<a class="ae ky" href="https://numexpr.readthedocs.io/projects/NumExpr3/en/latest/intro.html" rel="noopener ugc nofollow" target="_blank">https://nume xpr . readthedocs . io/projects/nume xpr 3/en/latest/intro . html</a></p></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><p id="c9ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ns">喜欢这篇文章吗？成为</em> <a class="ae ky" href="https://satyam-kumar.medium.com/membership" rel="noopener"> <em class="ns">中等会员</em> </a> <em class="ns">继续无限制学习。如果你使用下面的链接，我会收到你的一小部分会员费，不需要你额外付费。</em></p><blockquote class="nt"><p id="2265" class="nu nv it bd nw nx ny nz oa ob oc lu dk translated">感谢您的阅读</p></blockquote></div></div>    
</body>
</html>