<html>
<head>
<title>Optimising Disk Usage in Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">优化弹性搜索中的磁盘使用</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/optimising-disk-usage-in-elasticsearch-d7b4238808f7?source=collection_archive---------8-----------------------#2021-04-28">https://towardsdatascience.com/optimising-disk-usage-in-elasticsearch-d7b4238808f7?source=collection_archive---------8-----------------------#2021-04-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="0d0a" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/making-sense-of-big-data" rel="noopener" target="_blank">理解大数据</a></h2><div class=""/><div class=""><h2 id="3bc4" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">在处理大量连续的数据流时，这里有三个策略可以减少弹性搜索索引的存储空间</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/a7b1011bb7a7584f46ba04c32505db9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*edF2Oq0ehitGLQft"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">由<a class="ae lh" href="https://unsplash.com/@pietrozj?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">彼得罗·郑</a>在<a class="ae lh" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="5c59" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi me translated">近年来，lasticsearch (ES)获得了广泛的关注，因为它提供了一个强大的、可扩展的引擎，可以低延迟地存储和分析大量数据。如果您是处理大量(且快速增长的)数据的数据工程师或数据科学家，您会知道存储优化是构建高质量解决方案的关键组成部分。在本文中，我将讨论使用es时优化磁盘使用的三种策略。这篇博文的复制代码可以在<a class="ae lh" href="https://github.com/ngoet/es_demo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><h1 id="3f59" class="mn mo it bd mp mq mr ms mt mu mv mw mx ki my kj mz kl na km nb ko nc kp nd ne bi translated">弹性研究快速入门</h1><p id="b8ae" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">在我们开始探索Elasticsearch (ES)存储优化之前，让我们回顾一些ES基础知识。</p><p id="b771" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">如果你问，比如说，四个开发人员来描述ES是什么，你可能会得到同样多不同的答案。这并不奇怪:ES可以用作存储引擎，用于应用机器学习来实时建模数据，以及分析事件和日志，等等。此外，ES可以处理不同的数据类型(结构化和非结构化)，而它的分布式特性使它可以处理大量数据。因此，ES有理由成为各行各业越来越多公司的首选解决方案，包括Airbnb、优步、沃尔玛、思科和易贝。</p><p id="34f7" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">要理解ES的力量，我们需要理解它的基本原理。Elasticsearch是一个基于Lucene的分布式搜索和分析引擎。当您设置和部署一个Elasticsearch集群时，您可以<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/scalability.html" rel="noopener ugc nofollow" target="_blank">添加不同的节点(服务器)</a>。您的数据和针对es索引中的数据运行的查询都分布在这些节点上，所有这些都是自动完成的，以提供可伸缩性和高可用性。</p><p id="651d" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">ES中的数据组织在“<strong class="lk jd">指数</strong>”中。弹性搜索指数是数据的逻辑分组，遵循一个模式，但该术语也涵盖了通过碎片对数据的实际<em class="nk">物理</em>组织。每个索引由一个<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/scalability.html" rel="noopener ugc nofollow" target="_blank">“一个或多个物理碎片的逻辑分组”</a>组成。反过来，每个碎片都是一个独立的索引。</p><p id="43ce" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">存储在ES索引中的数据是名为“<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.12/documents-indices.html" rel="noopener ugc nofollow" target="_blank"> <strong class="lk jd"> documents </strong> </a>”的JSON对象。这些文档由<strong class="lk jd">字段</strong>(键-值对)组成，并在“<strong class="lk jd">碎片</strong>”之间划分，这些碎片分布在各个节点上。每个文档都属于一个“主碎片”和一个或多个“副本碎片”(假设您已经为索引配置了副本碎片)。因此，Elasticsearch通过由节点和碎片组成的设计来实现冗余，其中包括主碎片和副本。</p><p id="58bc" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在接下来的内容中，我将集中讨论优化es中数据存储的三个策略:I)设计好你的索引；ii)优化您的索引映射iii)使用热-暖-冷架构。我们将使用我在之前关于Elasticsearch的博客文章中设置的索引。这是Kaggle 上可用的<a class="ae lh" href="https://www.kaggle.com/shivamb/netflix-shows" rel="noopener ugc nofollow" target="_blank">网飞秀的元数据数据集。我们将逐步优化这个索引。</a></p><p id="6b29" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><em class="nk">如果你想了解更多关于提供一个ES集群和设置索引的信息，请阅读我在</em> <a class="ae lh" rel="noopener" target="_blank" href="/creating-and-managing-elasticsearch-indices-with-python-f676ff1c8113"> <em class="nk">上的帖子用Python创建和管理弹性搜索索引</em> </a> <em class="nk">。</em></p><div class="np nq gp gr nr ns"><a rel="noopener follow" target="_blank" href="/creating-and-managing-elasticsearch-indices-with-python-f676ff1c8113"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd jd gy z fp nx fr fs ny fu fw jc bi translated">使用Python创建和管理弹性搜索索引</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">从CSV文件创建ES索引以及使用Python Elasticsearch管理数据的实践指南…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">towardsdatascience.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og lb ns"/></div></div></a></div><p id="d7a5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在我们开始之前，请注意这篇博文中使用的数据仅包含7787个“静态”条目，无论如何也不能被归类为“大数据”。然而，本文中讨论的原则可以概括为大数据和流。</p><h1 id="e874" class="mn mo it bd mp mq mr ms mt mu mv mw mx ki my kj mz kl na km nb ko nc kp nd ne bi translated">策略1:删减数据并定义自己的映射</h1><p id="66e4" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">首先，冒着说出显而易见的事实的风险:你必须设计好你的弹性搜索指数。这首先要决定什么可以纳入你的指数，更重要的是，什么不可以。比如你需要把你所有的数据都存储在Elasticsearch里吗？或者，您是否只需要将Elasticsearch作为一个低延迟的存储，用于存储应用程序需要访问的数据子集，而其他数据可以存储在其他地方？如果后一个问题的答案是肯定的，那么您就可以很容易地识别出一些“立竿见影”的效果，并删除多余的数据。</p><p id="bf8a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">一旦决定了Elasticsearch中需要哪些数据，请确保很好地定义了映射。Elasticsearch能够使用<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html" rel="noopener ugc nofollow" target="_blank">动态字段映射</a>推断您的数据映射。这意味着每当ES在文档中检测到一个新的字段时，它会动态地将字段类型添加到映射中。但这并不意味着它以一种最适合数据存储或您所想的目的的方式来实现。</p><p id="9282" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html" rel="noopener ugc nofollow" target="_blank">动态字段映射</a>(当<code class="fe nl nm nn no b"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic.html" rel="noopener ugc nofollow" target="_blank">dynamic</a></code>参数设置为<code class="fe nl nm nn no b">true</code>时)将例如<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-disk-usage.html" rel="noopener ugc nofollow" target="_blank">索引字符串字段为</a> <code class="fe nl nm nn no b"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-disk-usage.html" rel="noopener ugc nofollow" target="_blank">text</a></code> <a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-disk-usage.html" rel="noopener ugc nofollow" target="_blank">和</a> <code class="fe nl nm nn no b"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-disk-usage.html" rel="noopener ugc nofollow" target="_blank">keyword</a></code>。你通常只需要这两个中的一个。<code class="fe nl nm nn no b">text</code>字段类型在索引时被分解成单个术语，并允许部分匹配。相反，索引时不分析<code class="fe nl nm nn no b">keyword</code>类型(或者说:“标记化”)，只允许精确匹配(在我们的<code class="fe nl nm nn no b">netflix_movies</code>示例中，我们可以对<code class="fe nl nm nn no b">type</code>字段使用<code class="fe nl nm nn no b">keyword</code>字段类型，它取两个值之一——“电影”或“电视节目”)。</p><p id="a333" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了建立一个基线来比较我们的优化策略，我们将首先使用<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html" rel="noopener ugc nofollow" target="_blank">动态字段映射</a>将网飞电影数据写入一个新的es索引，而无需定义我们自己的映射。ES为我们的<code class="fe nl nm nn no b">netflix_movies</code>数据推断出以下映射:</p><pre class="ks kt ku kv gt oh no oi oj aw ok bi"><span id="e544" class="ol mo it no b gy om on l oo op">{<br/> "netflix_movies_dynamic_field_mapping": {<br/>  "mappings": {<br/>   "properties": {<br/>    "cast": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    },<br/>    "country": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    },<br/>    "date_added": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    },<br/>    "description": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    },<br/>    "director": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    },<br/>    "duration": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    },<br/>    "listed_in": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    },<br/>    "rating": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    },<br/>    "release_year": {<br/>     "type": "long"<br/>    },<br/>    "show_id": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    },<br/>    "title": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    },<br/>    "type": {<br/>     "type": "text",<br/>     "fields": {<br/>      "keyword": {<br/>       "type": "keyword",<br/>       "ignore_above": 256<br/>      }<br/>     }<br/>    }<br/>   }<br/>  }<br/> }<br/>}</span></pre><p id="b46a" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">请注意，我们的目标是减少索引的磁盘使用量，即<code class="fe nl nm nn no b">store.size</code>参数。此参数表示集群上索引的主碎片和复制碎片的存储大小。您可以使用Kibana控制台中的<a class="ae lh" href="https://www.google.co.uk/search?q=CAT+indices+API&amp;client=safari&amp;source=hp&amp;ei=QPlpYIDFMevYgwfLkr7gDQ&amp;iflsig=AINFCbYAAAAAYGoHUNoVnfkkKa3B3-yI2Ja62TmRbazs&amp;oq=CAT+indices+API&amp;gs_lcp=Cgdnd3Mtd2l6EAMyAggAMgYIABAWEB46AgguOggILhDHARCjAjoFCC4QkwI6CAguEMcBEK8BOgUIABDJAzoECAAQCjoICAAQFhAKEB5Q7gZY1Blg1htoAXAAeACAAVmIAYUIkgECMTaYAQCgAQGqAQdnd3Mtd2l6&amp;sclient=gws-wiz&amp;ved=0ahUKEwiA5bS8kOXvAhVr7OAKHUuJD9wQ4dUDCAo&amp;uact=5" rel="noopener ugc nofollow" target="_blank">CAT indexes API</a>来检查您的索引的存储大小。使用动态字段映射，我们得到17.1 MB的基线存储大小(参见下面的屏幕截图)。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oq"><img src="../Images/a9249a3a6f853cde095ebdf08132107e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IY1d4AB33-F2F3jzJI5CJg.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">使用ES的动态字段映射存储大小(图片由作者提供)</p></figure><p id="4cb5" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">通过显式定义映射，我们能比我们的基线17.1 MB做得更好吗？让我们从我之前的博客文章中的简单(未经优化的)映射开始。除了<code class="fe nl nm nn no b">release_year</code>(我们将它定义为一个整数)之外，我们将所有字段都设为<code class="fe nl nm nn no b">text</code>类型:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="c190" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><code class="fe nl nm nn no b">netflix_movies</code>的索引存储大小为9.3 MB，与我们的基线映射相比减少了7.8 MB(减少了近46个百分点。).</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ot"><img src="../Images/64774096bb4416101054a46bc6ebe76b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*khM2O5KtiMuCqBgBp72mtg.gif"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">使用<a class="ae lh" href="https://www.google.co.uk/search?q=CAT+indices+API&amp;client=safari&amp;source=hp&amp;ei=QPlpYIDFMevYgwfLkr7gDQ&amp;iflsig=AINFCbYAAAAAYGoHUNoVnfkkKa3B3-yI2Ja62TmRbazs&amp;oq=CAT+indices+API&amp;gs_lcp=Cgdnd3Mtd2l6EAMyAggAMgYIABAWEB46AgguOggILhDHARCjAjoFCC4QkwI6CAguEMcBEK8BOgUIABDJAzoECAAQCjoICAAQFhAKEB5Q7gZY1Blg1htoAXAAeACAAVmIAYUIkgECMTaYAQCgAQGqAQdnd3Mtd2l6&amp;sclient=gws-wiz&amp;ved=0ahUKEwiA5bS8kOXvAhVr7OAKHUuJD9wQ4dUDCAo&amp;uact=5" rel="noopener ugc nofollow" target="_blank">卡特彼勒索引API </a>在<a class="ae lh" href="https://www.elastic.co/guide/en/kibana/7.12/console-kibana.html" rel="noopener ugc nofollow" target="_blank"> Kibana控制台</a>上检查ES集群上的索引(图片由作者提供)</p></figure><h1 id="5974" class="mn mo it bd mp mq mr ms mt mu mv mw mx ki my kj mz kl na km nb ko nc kp nd ne bi translated">策略2:基于映射的优化</h1><p id="d116" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">减少索引存储大小的第二个策略是优化映射。在定义映射时，有几种选择可以减少存储大小。这里的权衡是在搜索能力和限制索引大小之间:通常，你对存储优化得越多，查询数据的灵活性就越小。</p><h2 id="243a" class="ol mo it bd mp ou ov dn mt ow ox dp mx lr oy oz mz lv pa pb nb lz pc pd nd iz bi translated">选择正确的字段类型</h2><p id="8502" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">首先，为您的字段选择正确的数据类型。在我们的<code class="fe nl nm nn no b">netflix_movies</code>示例中，我们可以将<code class="fe nl nm nn no b">type</code>、<code class="fe nl nm nn no b">country</code>和<code class="fe nl nm nn no b">rating</code>字段转换成关键字字段类型，因为这些字段只能采用一些预定义的值，我们可以预期不必使用部分匹配。</p><p id="fc03" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">还要确保<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-disk-usage.html" rel="noopener ugc nofollow" target="_blank">检查你的变量是否适合“更小”的数据类型</a>。例如，我们可以通过使用<code class="fe nl nm nn no b">short</code>而不是<code class="fe nl nm nn no b">integer</code>字段类型来进一步减小<code class="fe nl nm nn no b">release_year</code>的大小。<code class="fe nl nm nn no b">short</code>字段类型是一个<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/number.html" rel="noopener ugc nofollow" target="_blank"> 16位整数</a>。我们改进后的索引如下所示:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="0173" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">与我们的基准17.1 MB相比，这一优化的索引使我们的数据减少到了8.7mb(减少了49.1%)。与我们未优化的映射(9.3 MB)相比，这表示磁盘使用量减少了6.5%。然而，如果您正在处理真正大量的数据，即使这些小的百分比也可以代表显著的节省。</p><h2 id="ad71" class="ol mo it bd mp ou ov dn mt ow ox dp mx lr oy oz mz lv pa pb nb lz pc pd nd iz bi translated">不要索引你不需要过滤的内容</h2><p id="249a" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">其次，您可以<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-disk-usage.html" rel="noopener ugc nofollow" target="_blank">对不需要在</a>上过滤的字段禁用索引。索引是为了快速检索而组织的数据。在ES中，<code class="fe nl nm nn no b">text</code>字段例如<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/documents-indices.html#documents-indices" rel="noopener ugc nofollow" target="_blank">存储在倒排索引</a>中(即:文档—术语→术语—文档)，而数字字段类型例如存储在BKD树中。</p><p id="02a4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在我们的<code class="fe nl nm nn no b">netflix_movies</code>示例中，从索引中排除的潜在候选对象是<code class="fe nl nm nn no b">duration</code>和<code class="fe nl nm nn no b">description</code>。前者在连续剧和电影之间的定义并不一致(前者以季为单位，后者以分钟为单位)。如果我想过滤持续时间，我可能会进一步处理这些数据并创建一个新字段。<code class="fe nl nm nn no b">description</code>反过来可能对部分匹配有用，但是让我们假设(为了说明的目的)我们只对通过元数据识别电影感兴趣，然后阅读它们的描述。</p><p id="71b9" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了关闭特定字段的索引，我们将<code class="fe nl nm nn no b">index</code>选项设置为<code class="fe nl nm nn no b">False</code>:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="9aea" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">使用这个新映射写入我们的<code class="fe nl nm nn no b">netflix_movies</code>数据会产生一个总大小为7.5 MB的索引(与我们之前的迭代相比减少了3.0%)。</p><h2 id="7956" class="ol mo it bd mp ou ov dn mt ow ox dp mx lr oy oz mz lv pa pb nb lz pc pd nd iz bi translated">如果不需要相关性分数，就不要规范化文本字段</h2><p id="a733" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">第三，如果你不需要相关性分数，你可以去掉<code class="fe nl nm nn no b">text</code>字段的标准化因子。<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/norms.html" rel="noopener ugc nofollow" target="_blank">归一化因子存储在索引中，用于评分</a>，即给用户定义的查询与文档的相关性附加一个数值的过程。这些标准化因子占用了大量的磁盘空间(即<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/norms.html" rel="noopener ugc nofollow" target="_blank">每个字段每个文档一个字节，包括不包含所述字段</a>的文档)。</p><p id="a41b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">让我们假设我们对相关性分数不感兴趣，并且我们可以放弃所有文本字段的标准化因子。我们更新后的映射如下所示(注意添加了<code class="fe nl nm nn no b">“norms”: False</code>):</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="2782" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">移除所有文本字段的标准化因子后，我们的大小降至7.3 MB(与之前的优化步骤相比，又减少了1.2%)。</p><p id="4bf4" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">总之，对于我们的不同优化选项，我们看到了以下索引存储大小和<code class="fe nl nm nn no b">netflix_movies</code>数据的磁盘使用量减少:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="or os l"/></div></figure><h1 id="ea53" class="mn mo it bd mp mq mr ms mt mu mv mw mx ki my kj mz kl na km nb ko nc kp nd ne bi translated">策略3:使用热-暖-冷架构</h1><p id="bfa6" class="pw-post-body-paragraph li lj it lk b ll nf kd ln lo ng kg lq lr nh lt lu lv ni lx ly lz nj mb mc md im bi translated">优化磁盘使用的第三个策略(或者更确切地说:减少磁盘使用的<em class="nk">成本</em>)是使用热-暖-冷架构，使用<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-lifecycle-management.html" rel="noopener ugc nofollow" target="_blank">索引生命周期管理(ILM) </a>和<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-index-lifecycle-management.html" rel="noopener ugc nofollow" target="_blank">自动索引翻转</a>。</p><p id="eff1" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">Elastic (ELK)堆栈(即:Elasticsearch、Kibana、Beats和Logstash) <a class="ae lh" href="https://www.elastic.co/blog/introducing-elasticsearch-searchable-snapshots" rel="noopener ugc nofollow" target="_blank">的创建者在2020年11月宣布为他们的Elasticsearch服务提供更好的低成本冷层支持</a>。<a class="ae lh" href="https://www.elastic.co/elasticsearch/service" rel="noopener ugc nofollow" target="_blank">官方ES服务</a>现在支持可以驻留在对象存储中的冷层，包括<a class="ae lh" href="https://aws.amazon.com/free/?all-free-tier.sort-by=item.additionalFields.SortRank&amp;all-free-tier.sort-order=asc&amp;awsf.Free%20Tier%20Categories=categories%23storage&amp;trk=ps_a134p000006paz5AAA&amp;trkCampaign=acq_paid_search_brand&amp;sc_channel=PS&amp;sc_campaign=acquisition_ND&amp;sc_publisher=Google&amp;sc_category=Storage&amp;sc_country=ND&amp;sc_geo=EMEA&amp;sc_outcome=acq&amp;sc_detail=aws%20s3&amp;sc_content=S3_e&amp;sc_matchtype=e&amp;sc_segment=494837903412&amp;sc_medium=ACQ-P%7CPS-GO%7CBrand%7CDesktop%7CSU%7CStorage%7CS3%7CND%7CEN%7CText%7Cxx%7CNon-EU&amp;s_kwcid=AL!4422!3!494837903412!e!!g!!aws%20s3&amp;ef_id=EAIaIQobChMI0YHTgOPy7wIVk-N3Ch2JOwnnEAAYASAAEgJd-_D_BwE:G:s&amp;s_kwcid=AL!4422!3!494837903412!e!!g!!aws%20s3" rel="noopener ugc nofollow" target="_blank"> AWS的简单云存储(S3) </a>、<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/plugins/7.12/repository-gcs.html" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a>、<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/plugins/7.12/repository-azure.html" rel="noopener ugc nofollow" target="_blank"> Azure Blob存储</a>、<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/plugins/7.12/repository-hdfs.html" rel="noopener ugc nofollow" target="_blank"> Hadoop分布式文件存储(HDFS) </a>以及<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-register-repository.html#snapshots-filesystem-repository" rel="noopener ugc nofollow" target="_blank">共享文件系统</a>如NFS。与暖层相比，<a class="ae lh" href="https://www.elastic.co/blog/introducing-elasticsearch-searchable-snapshots" rel="noopener ugc nofollow" target="_blank">冷存储可以将您的集群存储减少50%</a>。</p><p id="7fbf" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">冷层功能是Elastic项目生命周期管理的一部分，您可以为数据转换规则定义自己的标准。这意味着你可以在S3上以“<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/searchable-snapshots.html" rel="noopener ugc nofollow" target="_blank">可搜索快照</a>”的形式更便宜地存储你的旧数据，同时保持查询能力。搜索性能应该与搜索常规索引相当。</p><p id="9d48" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">将热-暖-冷架构与ES结合使用涉及<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-index-lifecycle-management.html" rel="noopener ugc nofollow" target="_blank">配置生命周期策略来定义索引的热、暖、冷阶段</a>。例如，您可以将索引配置为在设定的天数后，或者在索引达到某个大小限制后，从热状态翻转到暖状态。您可以重复这种模式进行从暖到冷的翻转。</p><p id="9d15" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">可以通过Kibana控制台配置生命周期策略。或者，您可以使用<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ilm-put-lifecycle.html" rel="noopener ugc nofollow" target="_blank">创建或更新策略</a> API。下面的例子定义了一个策略，如果数据超过30天，或者索引的大小超过20 GB，那么<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.12/indices-rollover-index.html" rel="noopener ugc nofollow" target="_blank">翻转索引</a>，并开始写入新的索引。随后，该策略会在60天后将当前索引(已转存的索引)移到暖阶段，并在75天后移到冷阶段。</p><pre class="ks kt ku kv gt oh no oi oj aw ok bi"><span id="c493" class="ol mo it no b gy om on l oo op">PUT _ilm/policy/netflix_movies_lp<br/>{<br/>  "policy": {<br/>    "phases": {<br/>      "hot": {<br/>        "actions": {<br/>          "rollover": {<br/>            "max_size": "20gb",<br/>            "max_age": "30d"<br/>          }<br/>        }<br/>      },<br/>      "warm": {<br/>        "min_age": "60d"<br/>      },<br/>      "cold": {<br/>        "min_age": "75d",<br/>        "actions": {<br/>          "searchable_snapshot": {<br/>            "snapshot_repository": "my-repository"<br/>          }<br/>        }<br/>      },<br/>      "delete": {<br/>        "min_age": "90d",<br/>        "actions": {<br/>          "delete": {}<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="51eb" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">第二步，我们可以将上述策略与进入<code class="fe nl nm nn no b">netflix_movies</code>索引的任何文档相关联:</p><pre class="ks kt ku kv gt oh no oi oj aw ok bi"><span id="5536" class="ol mo it no b gy om on l oo op">PUT _index_template/<!-- -->netflix_movies<!-- -->_template<br/>{<br/>  "index_patterns": ["<!-- -->netflix_movies<!-- -->"],                   <br/>  "data_stream": { },<br/>  "template": {<br/>    "settings": {<br/>      "number_of_shards": 1,<br/>      "number_of_replicas": 1,<br/>      "index.lifecycle.name": "netflix_movies_lp"     <br/>    }<br/>  }<br/>}</span></pre><p id="2f8c" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">随后，任何被推送到索引的文档都将受到<code class="fe nl nm nn no b">netflix_movies_lp</code>生命周期策略的约束，并逐步从热存储转移到温存储，再转移到冷存储。</p><p id="60f2" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">关于ILM和热-暖-冷架构的最后一个补充说明:Elastic已经宣布支持<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/data-tiers.html#frozen-tier" rel="noopener ugc nofollow" target="_blank">冻结层</a>，这也将由可搜索快照驱动。冻结层<em class="nk">中的数据不可更改</em>并用于很少访问的文档(有关Elasticsearch数据层的更多信息，请点击<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/data-tiers.html#frozen-tier" rel="noopener ugc nofollow" target="_blank">此处</a>)。然而，在撰写本文时，这项功能还处于试验阶段，还不能用于Elasticsearch服务。</p></div><div class="ab cl pe pf hx pg" role="separator"><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj"/></div><div class="im in io ip iq"><p id="2c4b" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">还有很多其他的策略来优化es中的存储，我在这篇文章中没有讨论，比如<a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-disk-usage.html" rel="noopener ugc nofollow" target="_blank">应用最好的压缩编解码器，使用更大的碎片，以及减少碎片的数量(使用shrink API) </a>。如果你想了解更多关于这些选项的信息，请点击下面的链接。</p><p id="fe0f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">感谢阅读！您遇到过哪些值得推荐的其他ES存储优化策略？请在评论中留下你的建议！</p></div><div class="ab cl pe pf hx pg" role="separator"><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj"/></div><div class="im in io ip iq"><div class="ks kt ku kv gt ns"><a href="https://medium.com/@ndgoet/membership" rel="noopener follow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd jd gy z fp nx fr fs ny fu fw jc bi translated">用我的推荐链接加入媒体。</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">medium.com</p></div></div><div class="ob l"><div class="pl l od oe of ob og lb ns"/></div></div></a></div></div><div class="ab cl pe pf hx pg" role="separator"><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj"/></div><div class="im in io ip iq"><p id="2530" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd">如果你喜欢这篇文章，这里还有一些你可能喜欢的文章:</strong></p><div class="np nq gp gr nr ns"><a rel="noopener follow" target="_blank" href="/four-things-you-need-to-master-to-get-started-with-elasticsearch-c51bed6ae99d"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd jd gy z fp nx fr fs ny fu fw jc bi translated">开始使用Elasticsearch需要掌握的四件事</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">弹性研究概念和原则的简明概述</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">towardsdatascience.com</p></div></div><div class="ob l"><div class="pm l od oe of ob og lb ns"/></div></div></a></div><div class="np nq gp gr nr ns"><a rel="noopener follow" target="_blank" href="/creating-and-managing-elasticsearch-indices-with-python-f676ff1c8113"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd jd gy z fp nx fr fs ny fu fw jc bi translated">使用Python创建和管理弹性搜索索引</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">从CSV文件创建ES索引以及使用Python Elasticsearch管理数据的实践指南…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">towardsdatascience.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og lb ns"/></div></div></a></div><div class="np nq gp gr nr ns"><a rel="noopener follow" target="_blank" href="/how-to-build-a-relational-database-from-csv-files-using-python-and-heroku-20ea89a55c63"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd jd gy z fp nx fr fs ny fu fw jc bi translated">如何使用Python和Heroku从CSV文件构建关系数据库</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">通过三个简单的步骤免费构建您自己的PostgreSQL数据库</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">towardsdatascience.com</p></div></div><div class="ob l"><div class="pn l od oe of ob og lb ns"/></div></div></a></div><div class="np nq gp gr nr ns"><a rel="noopener follow" target="_blank" href="/getting-started-with-elasticsearch-query-dsl-c862c9d6cf7f"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd jd gy z fp nx fr fs ny fu fw jc bi translated">Elasticsearch查询DSL入门</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">使用Python Elasticsearch客户端，用特定领域语言编写Elasticsearch查询的实践指南</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">towardsdatascience.com</p></div></div><div class="ob l"><div class="po l od oe of ob og lb ns"/></div></div></a></div></div><div class="ab cl pe pf hx pg" role="separator"><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj"/></div><div class="im in io ip iq"><p id="4b2f" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><em class="nk">如果你想了解这篇文章中描述的es的一些方面和特性的细节，这里有一些我认为有用的资源的概述，按主题组织(这篇文章中使用的所有资源都有全文链接)。</em></p><h2 id="78d3" class="ol mo it bd mp ou ov dn mt ow ox dp mx lr oy oz mz lv pa pb nb lz pc pd nd iz bi translated">弹性研究的一般原则</h2><ul class=""><li id="3b5b" class="pp pq it lk b ll nf lo ng lr pr lv ps lz pt md pu pv pw px bi translated"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html" rel="noopener ugc nofollow" target="_blank">ES的一般介绍</a></li><li id="9627" class="pp pq it lk b ll py lo pz lr qa lv qb lz qc md pu pv pw px bi translated"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/scalability.html" rel="noopener ugc nofollow" target="_blank">在节点、分片和索引上</a></li><li id="f003" class="pp pq it lk b ll py lo pz lr qa lv qb lz qc md pu pv pw px bi translated"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html" rel="noopener ugc nofollow" target="_blank">关于动态字段映射</a></li></ul><h2 id="4c7d" class="ol mo it bd mp ou ov dn mt ow ox dp mx lr oy oz mz lv pa pb nb lz pc pd nd iz bi translated">弹性搜索中的磁盘和存储优化</h2><ul class=""><li id="bce9" class="pp pq it lk b ll nf lo ng lr pr lv ps lz pt md pu pv pw px bi translated"><a class="ae lh" href="https://coralogix.com/log-analytics-blog/elasticsearch-disk-and-data-storage-optimizations-with-benchmarks/" rel="noopener ugc nofollow" target="_blank">elastic search的磁盘和数据存储优化策略概述，带有基准</a></li><li id="530e" class="pp pq it lk b ll py lo pz lr qa lv qb lz qc md pu pv pw px bi translated"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tune-for-disk-usage.html" rel="noopener ugc nofollow" target="_blank">优化磁盘使用</a></li></ul><h2 id="0b30" class="ol mo it bd mp ou ov dn mt ow ox dp mx lr oy oz mz lv pa pb nb lz pc pd nd iz bi translated">关于分层、索引生命周期管理以及Elasticsearch的冷层和可搜索快照</h2><ul class=""><li id="48b4" class="pp pq it lk b ll nf lo ng lr pr lv ps lz pt md pu pv pw px bi translated"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-index-lifecycle-management.html" rel="noopener ugc nofollow" target="_blank">关于ILM自动翻车</a></li><li id="b576" class="pp pq it lk b ll py lo pz lr qa lv qb lz qc md pu pv pw px bi translated"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/master/data-tiers.html" rel="noopener ugc nofollow" target="_blank">在Elastic的Elasticsearch服务的不同可用Elasticsearch层上</a></li><li id="ad7e" class="pp pq it lk b ll py lo pz lr qa lv qb lz qc md pu pv pw px bi translated"><a class="ae lh" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/searchable-snapshots.html" rel="noopener ugc nofollow" target="_blank">弹性搜索服务的“冷层”和可搜索快照</a></li><li id="6cba" class="pp pq it lk b ll py lo pz lr qa lv qb lz qc md pu pv pw px bi translated"><a class="ae lh" href="https://www.elastic.co/blog/elasticsearch-data-lifecycle-management-with-data-tiers" rel="noopener ugc nofollow" target="_blank">关于弹性搜索服务的数据生命周期管理和数据层</a></li></ul></div><div class="ab cl pe pf hx pg" role="separator"><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj pk"/><span class="ph bw bk pi pj"/></div><div class="im in io ip iq"><p id="ad69" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><strong class="lk jd"> <em class="nk">免责声明</em></strong><em class="nk">:“elastic search”和“Kibana”是Elasticsearch BV在美国和其他国家注册的商标。本文中对任何第三方服务和/或商标的描述和/或使用不应被视为对其各自权利持有人的认可。</em></p><p id="15a8" class="pw-post-body-paragraph li lj it lk b ll lm kd ln lo lp kg lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><em class="nk">请仔细阅读</em> <a class="ae lh" href="https://medium.com/@ndgoet/disclaimer-5ad928afc841" rel="noopener"> <em class="nk">本免责声明</em> </a> <em class="nk">中的任何内容后再依托</em> <a class="ae lh" href="/@ndgoet" rel="noopener ugc nofollow" target="_blank"> <em class="nk">我关于Medium.com的文章</em> </a> <em class="nk">。</em></p></div></div>    
</body>
</html>