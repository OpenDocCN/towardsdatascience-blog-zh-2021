<html>
<head>
<title>Apache Airflow 2.0 on Steroids — EKS Kubernetes &amp; MWAA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">服用类固醇的阿帕奇气流2.0——EKS·库伯内特和MWAA</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/apache-airflow-2-0-on-steroids-eks-kubernetes-mwaa-ec341d52fe2d?source=collection_archive---------13-----------------------#2021-06-29">https://towardsdatascience.com/apache-airflow-2-0-on-steroids-eks-kubernetes-mwaa-ec341d52fe2d?source=collection_archive---------13-----------------------#2021-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5aa5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">这篇文章将告诉我们如何在EKS自动气象站上运行气流2.0，以及它在新MWAA上的好处。它还将把它与原生的Kubernetes executor联系起来，并告诉我们它与它有什么不同，类似的还有Fargate vs EKS的节点管理EC2。</h2></div><p id="12f3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上个月，2021年5月，AWS发布了针对Apache Airflow (MWAA)的AWS托管工作流的更新，其中包括Airflow 2.0，这让我想到，当AWS以最新的稳定版本提供托管服务，价格并不昂贵，更不用说我们可以从AWS获得的支持(以前MWAA有一个旧的Airflow版本，不支持云形成)时，为什么现在有人要自己管理Airflow(典型的云困境)。但我担心自己处于尚未经过实战检验的技术的前沿。另一方面，AWS几个月前发布了一个关于EKS气流的版本，我们都知道K8s的可扩展性，所以我想尝试一下。我将站在技术的前沿，但至少它不会是一个黑匣子。</p><p id="6f24" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设我们都知道Kubernetes的组成部分以及什么是舵轮图，我将这篇文章分成两个子主题，即:</p><ol class=""><li id="1ec0" class="lb lc iq kh b ki kj kl km ko ld ks le kw lf la lg lh li lj bi translated">在EKS和MWAA部署air flow 2.0 &amp;</li><li id="b41a" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">添加Dag、变量、插件、连接等</li></ol><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi lp"><img src="../Images/191d9cc998e7aeb2606bbb9e9c22b1b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/1*CfZwUXeh-PL32X7p8osRMw.png"/></div><p class="lx ly gj gh gi lz ma bd b be z dk translated">来源:pixabay</p></figure><h1 id="48a3" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">在EKS和MWAA部署Airflow 2.0</h1><p id="1e57" class="pw-post-body-paragraph kf kg iq kh b ki mt jr kk kl mu ju kn ko mv kq kr ks mw ku kv kw mx ky kz la ij bi translated">简言之，K8s中的节点组可以使用AWS Fargate或节点管理的EC2来创建。两者都可以横向扩展，但主要区别是，Fargate AWS将管理工作节点扩展及其AMI配置，而在节点管理中，我们必须同时做这两件事，但它的好处是相当可观的。由于Fargate不支持daemonsets，使用受管节点组，我们不必将Dynatrace、Splunk或Datadog等监控服务的代理放在sidecar容器中，因此更加可靠。此外，Fargate不缓存容器图像，因此启动时间会更长。根据我的经验，Fargate更适合基于气流的工作流，其中大多数是批处理，而节点管理更适合与流相关的模式。</p><h2 id="becf" class="my mc iq bd md mz na dn mh nb nc dp ml ko nd ne mn ks nf ng mp kw nh ni mr nj bi translated">先决条件</h2><ul class=""><li id="079e" class="lb lc iq kh b ki mt kl mu ko nk ks nl kw nm la nn lh li lj bi translated">在您的角色需要访问的地方，设置了一个基于Linux的环境。我正在使用Ubuntu windows应用程序。</li></ul><h2 id="b356" class="my mc iq bd md mz na dn mh nb nc dp ml ko nd ne mn ks nf ng mp kw nh ni mr nj bi translated">创建集群</h2><p id="a77b" class="pw-post-body-paragraph kf kg iq kh b ki mt jr kk kl mu ju kn ko mv kq kr ks mw ku kv kw mx ky kz la ij bi translated">在创建集群之前，我们需要安装kubectl和eksctl。eksctl将创建和管理集群，而kubectl将与集群API服务器通信，以检索所需的节点、pod和名称空间。幸运的是，二进制文件对他们两个都是可用的。</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="d154" class="my mc iq np b gy nt nu l nv nw">curl -o kubectl <a class="ae nx" href="https://amazon-eks.s3.us-west-2.amazonaws.com/1.20.4/2021-04-12/bin/linux/amd64/kubectl" rel="noopener ugc nofollow" target="_blank">https://amazon-eks.s3.us-west-2.amazonaws.com/1.20.4/2021-04-12/bin/linux/amd64/kubectl</a></span><span id="9c31" class="my mc iq np b gy ny nu l nv nw">chmod +x ./kubectl</span><span id="96e0" class="my mc iq np b gy ny nu l nv nw">mkdir -p $HOME/bin &amp;&amp; cp ./kubectl $HOME/bin/kubectl &amp;&amp; export PATH=$PATH:$HOME/bin</span></pre><p id="aa68" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于eksctl来说，</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="201c" class="my mc iq np b gy nt nu l nv nw">curl — silent — location “<a class="ae nx" href="https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname" rel="noopener ugc nofollow" target="_blank">https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname</a> -s)_amd64.tar.gz” | tar xz -C /tmp</span><span id="a89a" class="my mc iq np b gy ny nu l nv nw">sudo mv /tmp/eksctl /usr/local/bin</span></pre><p id="a7c6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们使用Fargate创建一个k8集群，命令如下。这大约需要15–20分钟，用户可以查看有关将要创建的资源(Vpc、子网等)的云信息。</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="6303" class="my mc iq np b gy nt nu l nv nw">eksctl create cluster \<br/> — name test-cluster \<br/> — region ap-southeast-2 \<br/> — fargate</span></pre><p id="b077" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它会显示如下内容:</p><p id="5b3a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nz">…<br/>【】EKS集群</em> <code class="fe oa ob oc np b"><em class="nz">ap-southeast-2</em></code> <em class="nz">【地区】中的“测试集群”准备就绪</em></p><p id="88f0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，让我们创建一个节点管理的集群，区别就在这里。我们需要首先在本地创建将在EC2连接中使用的pub私有密钥对。</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="d2c2" class="my mc iq np b gy nt nu l nv nw">aws ec2 create-key-pair — region us-west-2 — key-name myKeyPair</span><span id="b64a" class="my mc iq np b gy ny nu l nv nw">eksctl create cluster \<br/> — name eksctl-airflow-cluster \<br/> — region ap-southeast-2 \<br/> — with-oidc \<br/> — ssh-access \<br/> — ssh-public-key &lt;your-key&gt; \<br/> — managed</span></pre><p id="bce9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在CFN中查看有关创建的节点组的信息。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div class="gh gi od"><img src="../Images/d7442d0c165236266c32319e9b63b90d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*Y87Ppi2soVeTpXkro9TA3Q.png"/></div><p class="lx ly gj gh gi lz ma bd b be z dk translated">作者图片</p></figure><p id="64d3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过运行以下命令，我们可以确认安装，它应该会显示群集中存在的节点:</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="13cb" class="my mc iq np b gy nt nu l nv nw">kubectl get nodes -o wide</span></pre><p id="9af2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们需要更新kubeconfig，以便无论何时运行kubectl，它都应该指向正确的集群。</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="3bdd" class="my mc iq np b gy nt nu l nv nw">aws eks — region ap-southeast-2 update-kubeconfig — name eksctl-airflow-cluster</span></pre><p id="b820" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，创建名称空间，以便我们可以在其中部署气流。它只是一种抽象，将相关资源保存在一个地方，就像一个堆栈一样。一个集群可以有许多可以相互通信的名称空间。</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="3cdc" class="my mc iq np b gy nt nu l nv nw">kubectl create namespace airflow</span></pre><p id="187c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在命名空间中创建气流之前，我们需要安装helm</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="124a" class="my mc iq np b gy nt nu l nv nw">$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3<br/>$ chmod 700 get_helm.sh<br/>$ ./get_helm.sh</span></pre><p id="0edc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面将创建气流资源，完成后你可以在localhost:8080查看。我们可以给任何你想要的版本名。</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="0325" class="my mc iq np b gy nt nu l nv nw">helm repo add airflow-stable <a class="ae nx" href="https://airflow-helm.github.io/charts" rel="noopener ugc nofollow" target="_blank">https://airflow-helm.github.io/charts</a><br/>helm repo update</span><span id="2abe" class="my mc iq np b gy ny nu l nv nw">helm install RELEASE_NAME airflow-stable/airflow <br/> — namespace airflow \<br/> — version 8.3.0</span></pre><p id="0dac" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在https://github.com/airflow-helm/charts/releases找到对应于最新气流发布的其他图表版本。</p><p id="606e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在检查GUI之前，我们需要使用以下命令将8080端口从pod转发到本地主机:</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="bdc6" class="my mc iq np b gy nt nu l nv nw">export POD_NAME=$(kubectl get pods — namespace NAMESPACE -l “component=web,app=airflow” -o jsonpath=”{.items[0].metadata.name}”)<br/>kubectl port-forward — namespace NAMESPACE $POD_NAME 8080:8080</span></pre><h1 id="51c2" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">添加Dag、变量、插件、连接等</h1><p id="fce1" class="pw-post-body-paragraph kf kg iq kh b ki mt jr kk kl mu ju kn ko mv kq kr ks mw ku kv kw mx ky kz la ij bi translated">现在有趣的部分来了，舵图给出了values.yml，其中提到了所有气流配置、变量、dagbag文件夹等，这有助于更新实际气流。因此，现在剩下的唯一事情就是给它所需的值，并使用下面的命令进行更新:</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="bb6c" class="my mc iq np b gy nt nu l nv nw">helm upgrade airflow airflow-stable/airflow — namespace airflow — version 8.3.0 — values values.yml — debug</span></pre><p id="1cb0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是values.yml的一部分，我们可以在其中指定需要安装的python模块</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="21b5" class="my mc iq np b gy nt nu l nv nw">airflow:<br/>    extraPipPackages: <br/>        — “pandas”<br/>        — “awscli”</span></pre><p id="f0a2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">类似地，下面是values.yml的一部分，其中指定了我们在部署efs后获得的持久卷和声明。</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="254b" class="my mc iq np b gy nt nu l nv nw">airflow:<br/>    extraVolumeMounts:<br/>        — name: airflow-efs-dag<br/>          mountPath: /opt/efs/<br/> <br/>    extraVolumes:<br/>        — name: airflow-efs-dag<br/>          persistentVolumeClaim:<br/>              claimName: efs-storage-claim</span></pre><p id="63b9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是它的大袋子:</p><pre class="lq lr ls lt gt no np nq nr aw ns bi"><span id="329a" class="my mc iq np b gy nt nu l nv nw">dags:<br/>    path: /opt/efs/dags</span></pre><p id="a12d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有趣的是，<strong class="kh ir"> MWAA </strong>也有类似的设置，它要求我们在云信息模板中提及所有这些细节。为了添加一个气流变量，MWAA使用了环境变量，为了更新env，我们需要在CFN中提到它。由于AWS SSM是MWAA的后端，我们可以指定包含conn_string的连接的键名，MWAA将使用键名选择它并将其部署在Airflow中。至于DAG、插件文件夹和requirements.txt，我们需要给它一个s3文件夹，但问题是它们都应该在同一个桶中。对任何刚开始的人来说都不是瓶颈。MWAA在后端使用RDS或Aurora，但它不会让用户随意摆弄。它只使用芹菜执行器，并根据不同的机器类型提供三种类型的集群。总之，它只能支持1000个Dag运行。因此，MWAA对中小企业有利，但对大公司不利。在撰写本文时，使用MWAA的一个缺点是，即使您通过CFN更新气流变量，调度程序也会在部署时停止，并需要大约10-20分钟才能运行。因此，需要考虑一个适当的发布策略，即每当有新的构建要部署时，不运行或运行较少的Dag。EKS也需要几分钟来完成头盔升级，但这比MWAA更透明，因为它提供了日志。</p><p id="28f8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，对于EKS，我们需要自己集成EFS和RDS，这应该不是什么大问题，然后任何CICD都可以将更新的Dag从代码库推送到EFS。</p><p id="38d6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">气流舵的values . yml:<a class="ae nx" href="https://github.com/airflow-helm/charts/blob/main/charts/airflow/values.yaml" rel="noopener ugc nofollow" target="_blank">https://github . com/air flow-helm/charts/blob/main/charts/air flow/values . YAML</a></p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="oe of l"/></div></figure><h2 id="2fb3" class="my mc iq bd md mz na dn mh nb nc dp ml ko nd ne mn ks nf ng mp kw nh ni mr nj bi translated"><strong class="ak"> EKS &amp;库伯内特的遗嘱执行人</strong></h2><p id="a844" class="pw-post-body-paragraph kf kg iq kh b ki mt jr kk kl mu ju kn ko mv kq kr ks mw ku kv kw mx ky kz la ij bi translated">在Airflow中使用k8 executor时，每个任务都在pod上运行，而airflow可以在单独的机器上运行。然而，在EKS，airflow的所有部分，即airflow db、调度程序等都在单独的pod中运行，因此具有更高的HA和可靠性。</p><h1 id="6f39" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">结论</h1><p id="8726" class="pw-post-body-paragraph kf kg iq kh b ki mt jr kk kl mu ju kn ko mv kq kr ks mw ku kv kw mx ky kz la ij bi translated">如果您已经完成了，那么恭喜您，您已经学会了如何使用fargate和节点管理ec2在EKS上部署Airflow 2.0。我们还学习了如何定制values.yml，它将具有气流配置和其他规定，如指定变量、连接等。在我看来，一切都将在不久的将来成为kubernetes，我们拥有将存储与计算分离的优势，可以随时利用潜在的无限量计算。这完全取决于您在理解和实现数据工程前景的旅程中处于哪个阶段。</p></div></div>    
</body>
</html>