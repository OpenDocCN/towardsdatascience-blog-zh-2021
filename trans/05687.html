<html>
<head>
<title>SQL — insert, delete and update in ONE statement: sync your tables with MERGE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL —在一条语句中插入、删除和更新:用MERGE同步表</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sql-insert-delete-and-update-in-one-statement-sync-your-tables-with-merge-14814215d32c?source=collection_archive---------4-----------------------#2021-05-21">https://towardsdatascience.com/sql-insert-delete-and-update-in-one-statement-sync-your-tables-with-merge-14814215d32c?source=collection_archive---------4-----------------------#2021-05-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5984" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用于合并两个表的灵活、安全和高效的解决方案</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9a82337a63dc39c7e62728bf263542bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a9vE_DpXKdOfmzB-ncrsWw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">该进程一次只能处理一个表；我们必须合并(图片由罗杰·布拉德肖在<a class="ae ky" href="https://unsplash.com/photos/1PPoNhMzAmY" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄)</p></figure><p id="2bdc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过合并，你可以通过在一个语句中执行<em class="lv">插入</em>、<em class="lv">删除</em>和<em class="lv">更新</em>来“同步”两个表。合并远不止这些。它在比较和同步表格方面为您提供了广泛的选项。您甚至可以跟踪合并的输出。我们将在本文中深入探讨所有这些问题。合并的主要原因是:</p><ul class=""><li id="beec" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">它是原子的；它或者执行所有命令(例如<em class="lv">更新</em>、<em class="lv">插入</em>和<em class="lv">删除</em>)或者不执行。如果其中一个命令失败，它将回滚所有内容。</li><li id="ed3c" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">高效快速:SQL Server需要比较记录<em class="lv">一次</em></li><li id="8aad" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">非常灵活</li><li id="907b" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">给你的经理和同事留下深刻印象</li></ul></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="1b0b" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">1设置:创建一些包含数据的表</h1><p id="caf8" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">想象一下，我们有一家新成立的披萨公司。我们在一个名为Pizzamenu的表中记录披萨。每周我们都会收到一个新的数据集，其中包含最新的菜单。我们的目标是更新现有比萨饼的信息，添加新的和删除旧的。让我们首先创建表格并插入一些数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="f98e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这些查询中，您可以看到PizzaMenu和NewPizzaMenu几乎是相同的。唯一的区别是PizzaMenu包含一个额外的列，指示比萨饼是否在菜单上(IsDeleted)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/53f0f8079bd5249eb011c8d6348c04c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qGVtNPu1RT9o495zoNtRYQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">PizzaMenu和NewPizzaMenu</p></figure><p id="dcfd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，新菜单不再包含夏威夷披萨。第一个比萨饼的名字和托诺的价格也是固定的。此外，还添加了两个比萨饼。让我们来看看如何做到这一点。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="3f00" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">2合并查询</h1><p id="abdc" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">合并查询比较目标表和源表。目标表是你真理的来源，这个来源将用来充实目标。看看下面的图表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/2ce927555d8573adf786c8d49f35742d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OPLfs8Xad6r3VDNP9E1oQw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">匹配源表和目标表(作者照片)</p></figure><p id="c368" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">比较基于多个列进行，并提醒其中一个连接。把合并看作是一种连接；它比较两个表的记录。代替左、内和右连接，我们可以认为合并能够检测和处理匹配“左”、“内”和“右”的记录。查看我们的查询:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="581a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在合并中，我们将目标表与源表合并。目标标签是真相的来源。在查询的第一个块<strong class="lb iu">中，我们定义了我们的源(newPizzaMenu)和目标(PizzaMenu)将会是什么。就像在连接中一样，我们定义了哪些列值必须匹配才能匹配记录。在这种情况下是“PizzaId”和“Size”。</strong></p><p id="7051" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—新记录('右匹配')<br/><strong class="lb iu">第二个块</strong>处理当源中有新记录而目标中还没有时会发生什么。在我们的例子中，这是两种新披萨的情况:Calzone L和XL。在这个块中，我们决定将新记录插入到目标(PizzaMenu)中。</p><p id="6334" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—匹配记录('内部匹配')<br/>这部分代表文氏图的中心；源表和目标表之间的一种内部连接。在我们的例子中，匹配的记录是意大利香肠和Tonno比萨饼。在这一部分，我们更新了名称、价格和修改。</p><p id="0e0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—已弃用的记录('左匹配')<br/>处理目标中存在但源中不存在的记录。这表示存在于当前菜单中但不在新菜单中的记录，在我们的示例中，这由pizza Hawaii表示。我们决定不删除这条记录(它被注释掉了)，而是更新目标(我们当前的菜单)中的IsDeleted列。</p><p id="16b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们执行查询时，我们看到:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/4148c9793a840aff32aabffa7d739cb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*0IcN8rSWcZRifWw5wBVfLQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们合并的结果</p></figure><p id="2ec4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正是我们想要的！请注意:</p><ul class=""><li id="d5aa" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">红色:从“正确搭配”→披萨tonno从菜单中删除</li><li id="3b93" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">橙色:更新:修正了前两个比萨饼的价格和名称</li><li id="5fc5" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">绿色:添加了底部的两条记录</li></ul></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="caba" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">3灵活性</h1><p id="bcb3" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">您不必更新出现在“匹配时”部分的记录；你想做什么都可以。合并只是检测记录是否匹配“左”、“右”或“内”。一些例子:</p><ul class=""><li id="5806" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">仅更新匹配记录并插入新记录；不要删除任何东西</li><li id="8c43" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">如果记录出现在左匹配或右匹配中，则在错误表中插入记录</li><li id="0174" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">从目标中删除所有匹配的记录，只插入正确匹配的(新)记录</li></ul><p id="3d5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，在选择匹配记录时也有一些灵活性。尝试下面的代码，该代码使用特殊限制更新匹配记录的名称。</p><ul class=""><li id="2260" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">当匹配和目标匹配时。然后瞄准目标。Name = '被禁者'</li><li id="a69e" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">当与target.stock匹配时！= '夏威夷'<br/>然后瞄准。名称=来源。Name <br/>只有当新股票是正数时，才会更新股票</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nt"><img src="../Images/f264c244aa852c22eadf110dc37077b8.png" data-original-src="https://miro.medium.com/v2/0*I4dUtA6KWVJxtbv-"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">现在让我们真正地用一些额外的用途来弄脏我们的手(图片由<a class="ae ky" href="https://www.pexels.com/@cottonbro" rel="noopener ugc nofollow" target="_blank"> Cottonbro </a>在<a class="ae ky" href="https://www.pexels.com/photo/person-in-blue-denim-jacket-holding-brown-wooden-stick-7568433/" rel="noopener ugc nofollow" target="_blank"> Pexels </a>上提供)</p></figure><h1 id="8f6f" class="mr ms it bd mt mu nu mw mx my nv na nb jz nw ka nd kc nx kd nf kf ny kg nh ni bi translated">额外收获:查看合并的输出</h1><p id="0c7e" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在执行合并时，我们还可以输出它所做的所有更改。为了演示这一点，我们稍微调整了一下查询。唯一的变化是，我们没有在正确的匹配更新，我们现在完全删除它。查看下面的查询。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="7156" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于最后5条记录，我们将输出我们执行了什么操作以及我们具体更改了什么:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/2d6bfdb62be336b8f2010122b22b2042.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w6nRnHFQURJz5QdhDwPssw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们合并的输出</p></figure><p id="f24a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第一列中，您会看到我们执行了什么操作，然后，在第2到第9列中，您会看到关于我们插入的记录的信息。最后8列您将看到关于已删除记录的信息。显然，插入的记录没有“插入的”信息，删除的记录没有“插入的”信息。被更新的记录两者都有。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="1211" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">Bonus2:将合并的输出插入到日志记录表中</h1><p id="1874" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">您可以使用合并的输出，并跟踪您的清单在所有新数据传递中的变化。让我们创建一个名为PizzaMenuhistory的表。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="cab5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以在一个事务中合并两个表(更新、插入和删除),并将合并的输出删除到历史表中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="1b7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在来看看这个小桌子披萨的历史:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/7ea55120d3660c7ff33c424f946e01fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*yauROSxSGDPLFAeK8DeKmQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们PizzaMenu的历史变迁</p></figure></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="ea16" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">结论</h1><p id="5a28" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">总之:merge为合并两个表提供了灵活、安全和高效的解决方案。使用它的输出，你也可以很容易地跟踪所有的变化。另请查看:</p><ul class=""><li id="3b9b" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-delete-into-another-table-b5b946a42299" rel="noopener">删除到另一个表中</a></li><li id="e278" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-into-another-table-bfc3dff79a66" rel="noopener">更新进入另一个标签页</a> le</li><li id="8695" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-rolling-back-statements-with-transactions-81937811e7a7" rel="noopener">使用交易撤销查询</a></li><li id="63a6" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-select-in-one-query-b067a7e60136" rel="noopener">更新选择一批记录</a></li><li id="6263" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" href="https://mikehuls.medium.com/version-control-your-database-part-1-creating-migrations-and-seeding-992d86c90170" rel="noopener">版本控制你的数据库</a></li></ul><p id="ca7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在前进，优化！！编码快乐！</p><p id="31f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="2c87" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page的缩写）学生:比如我正在做的事情？<a class="ae ky" href="https://mikehuls.medium.com/" rel="noopener">跟我来</a>！</p></div></div>    
</body>
</html>