<html>
<head>
<title>How to load geospatial data in Amazon Redshift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在亚马逊红移中加载地理空间数据</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-load-geospatial-data-in-amazon-redshift-e2f5528c8ae4?source=collection_archive---------25-----------------------#2021-05-05">https://towardsdatascience.com/how-to-load-geospatial-data-in-amazon-redshift-e2f5528c8ae4?source=collection_archive---------25-----------------------#2021-05-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d11b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用开源地理空间库和Amazon红移数据API的pythonic方法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/d85986a9de7b73747fd0e21720ac32f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*Ztfg2ayWChsezNsuIQzEjA.jpeg"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">Pawel Czerwinski 在<a class="ae kr" href="https://unsplash.com/images/stock/creative-common?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="67c4" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">亚马逊红移<a class="ae kr" href="https://aws.amazon.com/about-aws/whats-new/2019/11/amazon-redshift-announces-support-spatial-data" rel="noopener ugc nofollow" target="_blank">于2019年11月宣布</a>支持空间数据。这种支持包括新的几何数据类型和40多种空间函数。它在2020年9月得到了增强，增加了新的空间函数，并在使用JDBC/ODBC驱动程序时支持几何类型。</p><p id="381c" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如果您有地理空间数据，那么在Amazon Redshift中加载数据有两个选项，都涉及到COPY命令:</p><ul class=""><li id="0da6" class="lo lp iq ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated"><a class="ae kr" href="https://docs.aws.amazon.com/redshift/latest/dg/copy-usage_notes-spatial-data.html" rel="noopener ugc nofollow" target="_blank"> CSV </a>文件，带有<a class="ae kr" href="https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry#Format_variations" rel="noopener ugc nofollow" target="_blank"> EWKB </a>格式的几何图形</li><li id="a1b1" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated"><a class="ae kr" href="https://docs.aws.amazon.com/redshift/latest/dg/spatial-copy-shapefile.html" rel="noopener ugc nofollow" target="_blank">形状文件</a></li></ul><p id="67c3" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如果您已经有了这种格式的数据，使用shapefiles是一个很好的选择，但它是专有的，需要多个文件，属性名称限制为10个字符，大小限制为2 GB。</p><p id="a702" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如今，使用更新、更高级的格式(如GeoJSON或GeoPackage)来查找地理空间数据是很常见的。如果您想要加载以这些格式存储的数据，您需要使用带有EWKB几何图形的CSV文件选项。</p><p id="3b72" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在本文中，我将向您展示如何使用利用开源地理空间包和AWS SDK的Python脚本，以更常见的格式将地理空间数据加载到Redshift。</p><p id="dcf8" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">该脚本有三个主要步骤:</p><ol class=""><li id="f4e0" class="lo lp iq ku b kv kw ky kz lb lq lf lr lj ls ln mc lu lv lw bi translated">从输入文件创建带有EKWB几何图形的CSV文件</li><li id="33ec" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln mc lu lv lw bi translated">将创建的文件上传到S3存储桶</li><li id="bf15" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln mc lu lv lw bi translated">从S3文件导入红移表中的数据</li></ol></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="41ab" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">创建包含EWKB几何图形的CSV文件</h1><p id="a5b1" class="pw-post-body-paragraph ks kt iq ku b kv nc jr kx ky nd ju la lb ne ld le lf nf lh li lj ng ll lm ln ij bi translated">第一步是读取输入地理空间文件，然后用EWKB格式的几何创建一个新的CSV文件。</p><p id="c6fc" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">我们将使用最初由Sean Gillies开发的两个众所周知的地理空间包:</p><ul class=""><li id="72c9" class="lo lp iq ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">菲奥娜。基于<a class="ae kr" href="https://www.osgeo.org/projects/gdal/" rel="noopener ugc nofollow" target="_blank"> GDAL/OGR </a>，提供了用于读写地理空间文件的Python API。我们将使用Fiona来读取输入文件。</li><li id="2406" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated"><a class="ae kr" href="https://github.com/Toblerity/Shapely" rel="noopener ugc nofollow" target="_blank">身材匀称的</a>。基于<a class="ae kr" href="https://trac.osgeo.org/geos/" rel="noopener ugc nofollow" target="_blank">几何</a> / <a class="ae kr" href="https://locationtech.github.io/jts/" rel="noopener ugc nofollow" target="_blank"> JTS </a>，提供操作和分析平面几何对象的功能。我们将使用Shapely创建EWKB几何图形。</li></ul><p id="2785" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">首先我们用Fiona打开输入文件，然后使用Python <a class="ae kr" href="https://docs.python.org/3/library/csv.html" rel="noopener ugc nofollow" target="_blank"> csv模块</a>创建一个新文件。我们添加带有一个<em class="nh"> geom </em>列的标题和来自输入文件的属性名(<em class="nh"> f["properties"])。keys() </em>)作为第一行。然后，我们使用Shapely<a class="ae kr" href="https://shapely.readthedocs.io/en/stable/manual.html#shapely.wkb.dumps" rel="noopener ugc nofollow" target="_blank"><em class="nh">WKB . dumps</em></a>函数在输入文件中写入特征行，该函数允许我们使用<em class="nh">十六进制</em>参数以EWKB格式写入几何图形。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="fb35" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">如果输入文件使用EPSG代码定义空间参考，本文末尾链接的完整源代码支持将EPSG代码(空间参考ID-SRID)添加到输出EWKB几何。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="e7b2" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">把文件上传到S3</h1><p id="b05a" class="pw-post-body-paragraph ks kt iq ku b kv nc jr kx ky nd ju la lb ne ld le lf nf lh li lj ng ll lm ln ij bi translated">Redshift中的<em class="nh"> COPY </em>命令要求我们将想要加载的文件存储在S3桶中。我们将使用Python的<a class="ae kr" href="https://aws.amazon.com/sdk-for-python/" rel="noopener ugc nofollow" target="_blank">AWS SDK</a>(boto 3)来上传我们在上一步中创建的CSV文件。</p><p id="8b0a" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">将文件上传到S3的代码非常简单，正如您在下面看到的，但是我们需要有适当的权限来写入S3存储桶。</p><p id="ba83" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">您需要登录到<a class="ae kr" href="https://console.aws.amazon.com/iam/home" rel="noopener ugc nofollow" target="_blank"> AWS IAM控制台</a>，创建您的凭证，并确保您在<em class="nh">权限</em>部分附加了“<em class="nh"> AmazonS3FullAccess </em>”策略。</p><p id="6d75" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">Boto3将在环境变量(AWS_ACCESS_KEY_ID和AWS_SECRET_ACCESS_KEY)或您的主文件夹(<em class="nh"> ~/中的凭证文件中查找访问密钥。用于macOS/Linux的aws/credentials </em>或<em class="nh"> C:\Users\USER_NAME\。Windows版的aws\credentials </em>)。您可以自己创建这个文件，也可以安装<a class="ae kr" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>并运行<em class="nh"> aws configure </em>命令。</p><p id="3e71" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">配置好凭据后，您应该能够运行以下代码将包含EWKB几何图形的CSV文件上传到S3。重要的是，你上传文件到S3桶在同一个AWS地区，你有你的红移集群。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="2902" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">将数据导入红移</h1><p id="1331" class="pw-post-body-paragraph ks kt iq ku b kv nc jr kx ky nd ju la lb ne ld le lf nf lh li lj ng ll lm ln ij bi translated">现在我们在S3有了CSV文件，我们将使用<em class="nh"> COPY </em>命令将数据加载到Redshift中。在Redshift中，我们有不同的选项来执行SQL命令；其中一些如下:</p><ul class=""><li id="1c1c" class="lo lp iq ku b kv kw ky kz lb lq lf lr lj ls ln lt lu lv lw bi translated">我们可以使用PostgreSQL的<a class="ae kr" href="https://www.psycopg.org/" rel="noopener ugc nofollow" target="_blank"> psycopg </a>驱动程序。虽然Redshift不完全兼容PostgreSQL，但是我们可以用这个驱动连接Redshift，执行SQL语句。这个选项只允许我们使用传统的数据库认证。</li><li id="7ba0" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated">另一种选择是使用红移ODBC驱动程序和<a class="ae kr" href="https://pypi.org/project/pyodbc/" rel="noopener ugc nofollow" target="_blank"> pyodbc </a>模块。这是一个类似于psycopg的解决方案，具有红移特有的特性，也只提供传统的数据库认证。</li><li id="3de8" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated">更好的选择是使用<a class="ae kr" href="https://github.com/aws/amazon-redshift-python-driver" rel="noopener ugc nofollow" target="_blank"> Python红移连接器</a>。它是特定于红移的，由AWS开发，并支持红移特定的功能，如IAM身份验证。</li><li id="ca72" class="lo lp iq ku b kv lx ky ly lb lz lf ma lj mb ln lt lu lv lw bi translated">我们最终选择的选项是<a class="ae kr" href="https://docs.aws.amazon.com/redshift/latest/mgmt/data-api.html" rel="noopener ugc nofollow" target="_blank">红移数据API </a>。它使用boto3包进行异步HTTP调用。代码稍微复杂一点(您需要<a class="ae kr" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/redshift-data.html#RedshiftDataAPIService.Client.execute_statement" rel="noopener ugc nofollow" target="_blank">执行语句</a>，等待它结束，然后检索结果)，但是它提供了IAM和Secrets Manager认证，并且避免了管理连接的需要。</li></ul><p id="3ce5" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">要使用红移数据API，我们需要我们的凭证来附加<a class="ae kr" href="https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html" rel="noopener ugc nofollow" target="_blank">AmazonRedshiftDataFullAccess</a>策略。如上所述，使用AWS IAM控制台附加策略。</p><p id="2a96" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在加载数据之前，我们需要创建一个表，数据将被导入到这个表中。我们需要准备带有输入文件中的列名和数据类型的SQL语句。Fiona提供了一个<em class="nh">模式</em>属性，我们可以使用它将从Fiona读取的Python数据类型映射到<a class="ae kr" href="https://docs.aws.amazon.com/redshift/latest/dg/c_Supported_data_types.html" rel="noopener ugc nofollow" target="_blank">红移数据类型</a>。请看一下<em class="nh">get _ create _ table _ statement</em>和<em class="nh"> get_field_mappings </em>函数来理解这个过程。</p><p id="274b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">为了在Redshift上执行SQL语句，我们需要提供数据库凭证来访问数据库。该脚本使用存储在<a class="ae kr" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS Secrets Manager </a>中的凭证。这是连接到Redshift的推荐选项之一，它为循环、管理和检索数据库凭证提供了非常有用的功能。我们还需要提供这个秘密的ARN。</p><p id="cb91" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">一旦我们创建了表，我们就可以使用<em class="nh"> COPY </em>命令导入数据。除了数据库凭证之外，我们还需要为我们的红移集群附加一个角色，以允许对S3进行读访问。一旦我们附加了这个角色，我们将在COPY命令中使用该角色的Amazon资源名称(ARN)。</p><p id="1147" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">您可以在下面看到<em class="nh"> execute_statement </em>函数的语法。除了集群标识符和数据库之外，我们还用数据库凭证和SQL语句指定了秘密的ARN。在SQL语句中，我们需要指明S3中CSV文件的路径以及附加到Redshift集群的IAM角色，该角色对S3具有读取权限。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="2969" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">请查看完整的源代码，看看我们如何检查SQL语句执行是否成功，以及我们需要使用的其他选项，如<em class="nh"> COPY </em>命令中的<em class="nh"> TIMEFORMAT </em>参数，以正确解释日期/时间字段。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="8953" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">现在呢？</h1><p id="7340" class="pw-post-body-paragraph ks kt iq ku b kv nc jr kx ky nd ju la lb ne ld le lf nf lh li lj ng ll lm ln ij bi translated">所以你有我们的红移地理空间数据，现在你想工作的空间信息。您可以从红移<a class="ae kr" href="https://docs.aws.amazon.com/redshift/latest/dg/geospatial-functions.html" rel="noopener ugc nofollow" target="_blank">空间函数</a>开始，这些空间函数提供空间分析的基本功能，如要素相交或计算给定区域内的要素。</p><p id="b960" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">但是您可能希望使用这些数据集创建地图来理解信息并执行高级空间分析，如计算零售选址解决方案的双区域或计算包裹递送的最佳路径。</p><p id="17dc" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">这就是像<a class="ae kr" href="https://carto.com" rel="noopener ugc nofollow" target="_blank"> CARTO </a>这样的云原生地理空间平台有用的地方(免责声明:我目前是CARTO的产品经理)。CARTO允许您导入红移表，使用<a class="ae kr" href="https://carto.com/builder/" rel="noopener ugc nofollow" target="_blank">生成器</a>创建令人惊叹的可视化效果，并通过使用来自<a class="ae kr" href="https://carto.com/data-observatory/" rel="noopener ugc nofollow" target="_blank">数据观测站</a>的公共和优质数据集丰富您的信息来执行高级分析。您还可以使用React 的<a class="ae kr" href="https://docs.carto.com/react" rel="noopener ugc nofollow" target="_blank"> CARTO和awesome </a><a class="ae kr" href="https://deck.gl" rel="noopener ugc nofollow" target="_blank"> deck.gl </a>可视化库的CARTO <a class="ae kr" href="https://docs.carto.com/deck-gl" rel="noopener ugc nofollow" target="_blank">模块</a>创建自己的自定义空间应用程序。</p><p id="18a7" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">除了这些功能之外，CARTO即将推出的针对Redshift的空间分析扩展将允许您执行高级空间分析，而无需将数据从数据库中删除，这一新的云原生功能将允许您直接从Redshift集群创建2D和3D地图。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="3f18" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">源代码</h1><p id="006d" class="pw-post-body-paragraph ks kt iq ku b kv nc jr kx ky nd ju la lb ne ld le lf nf lh li lj ng ll lm ln ij bi translated">您可以在这个GitHub <a class="ae kr" href="https://github.com/borja-munoz/cloud-native-geo-importers" rel="noopener ugc nofollow" target="_blank">资源库</a>中找到Python脚本的源代码。脚本(<a class="ae kr" href="https://github.com/borja-munoz/cloud-native-geo-importers/blob/master/geo2rs.py" rel="noopener ugc nofollow" target="_blank"> <em class="nh"> geo2rs.py </em> </a>)可以独立运行，也可以作为模块使用。如果独立运行，它使用<a class="ae kr" href="https://docs.python.org/3/library/argparse.html" rel="noopener ugc nofollow" target="_blank"> argparse </a>库来解析命令参数。你可以在<a class="ae kr" href="https://github.com/borja-munoz/cloud-native-geo-importers/blob/master/README.md" rel="noopener ugc nofollow" target="_blank"> README.md </a>文件中找到关于命令行参数的更多信息。您还可以使用<a class="ae kr" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>修改代码，使其无服务器运行。</p></div></div>    
</body>
</html>