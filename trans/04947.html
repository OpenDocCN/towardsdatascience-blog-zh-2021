<html>
<head>
<title>Creating an environment with Airflow and DBT on AWS (part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在自动气象站上创造一个有气流和DBT的环境(第一部分)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/creating-an-environment-with-airflow-and-dbt-on-aws-part-1-ca13bc95f479?source=collection_archive---------8-----------------------#2021-04-30">https://towardsdatascience.com/creating-an-environment-with-airflow-and-dbt-on-aws-part-1-ca13bc95f479?source=collection_archive---------8-----------------------#2021-04-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="102b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">启动实例并安装气流</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/78c255ec8fa162b6d869ca2e3ec77de2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uf41_KvzrOVfvIdU"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kv" href="https://unsplash.com/@wansan_99?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">万圣业</a>拍摄的照片</p></figure><p id="ee9e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在研究气流的时候，我试着用它来安排一些DBT的工作。虽然我在互联网上找到了一些关于它们的设置和一些关于它们的集成的资源，但我在设置我可以测试集成选项的整个环境时遇到了一些麻烦，比如API调用或DBT命令。</p><p id="3a5c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我达到我所需要的时候，我必须做很多设置，安装操作系统库或Python库，以及诸如此类的事情。所以，我意识到从零开始再做一次有点难。此外，不仅我可能不得不再次这样做，而且有人可能会有同样的问题，并利用这些步骤。于是，我又做了一遍，记下了所有的事情。</p><p id="7a20" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文的主要目标是展示如何配置同时具有气流和DBT的环境，并集成这两种工具。</p><p id="6cd7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我不会试图解释这两个工具到底是什么或者它们的更高级的资源。基本上，DBT是一个使用SQL在数据仓库中转换数据的工具。Airflow是一个基于Python的工具，用于编排和调度工作流。好吧，既然你在使用Python，基本上你可以对各种东西进行编排。但是如果你看到了这个页面，你可能已经知道它们是什么以及它们是如何工作的了。我希望这篇文章可以帮助你作为一个起点，然后你可以延伸到你自己的需求。</p><p id="3332" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还有，我不会用更复杂更合适的架构。因为我们的目标是集成气流和DBT，所以我将在这个环境中使用最简单的配置。所以，我不会用其他像芹菜或Kubernetes的气流执行器。</p><p id="5799" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为此，我们将启动一个EC2实例，安装这两个工具，对它们进行配置，并在这两个工具上创建一些东西，这样我们就可以集成它们。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="8b6d" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak"> <em class="mr"> 1。在AWS </em> </strong>上启动EC2实例</h1><p id="baef" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">如果您知道如何在EC2上启动一个实例并连接到它，那么您可以按照自己喜欢的方式来做，然后跳到下一步。</p><p id="8a74" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将在AWS上使用t3a.medium EC2实例。起初我试图使用t2.micro，因为它在空闲层，但是一些命令冻结了机器。你可以尝试使用t2.micro，但我不推荐。</p><p id="8738" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要启动实例，我们可以使用Amazon AMI OS和所有默认设置。只要继续点击下一步，直到安全组页面。在此页面中，选择“创建新的安全组”。根据需要命名，并添加一个规则，选择“所有流量”类型和“我的IP”源。点击查看并启动。这将允许您进行SSH连接(端口22)并打开气流页面(端口8080)。如果您愿意，您可以只创建这两条规则。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/085a2b7ea240abdc2086184a82d7224e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jwuSzr1YqdxgB5xr9GsabA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">AWS上的安全组。这就像它的防火墙</p></figure><p id="3548" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下一页显示了实例的摘要。当您单击Launch按钮时，您会收到一个弹出窗口，要求您设置密钥对。如果您没有或不确定要选择什么，请选择“创建新的一对”选项。给文件命名，然后按“下载密钥对”按钮。确保您下载了密钥对文件(一个带有。pem扩展名)，然后单击“启动实例”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi my"><img src="../Images/599775795eae016d63db5f7262072635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*19kAxcGZoVjPWGEU8UNuhQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">下载实例的密钥对文件的唯一机会</p></figure><p id="f30f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可能需要等待几分钟才能运行实例。当新实例的状态为Running时，选择它并单击Connect按钮。选择SSH选项卡并复制SSH命令的示例(“SSH-I your-key . PEM ec2-user @ something”)。</p><p id="a23a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要连接到实例，您可以直接使用终端或Putty。但我将继续使用Visual Code Studio，因为它是我们稍后也要使用的工具，我们可能会在Windows或Linux上使用相同的过程。</p><p id="e706" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Visual Studio代码上，转到左上角的扩展图标。搜索SSH-Remote扩展并下载它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/c90cc5c4648b7d412271df7e690a82b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*-bdk5wTLpXGQmhKMRL4FaA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">远程SSH扩展</p></figure><p id="c633" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装后，按F1，数字SSH，你会看到新的扩展选项。选择“添加新的SSH主机”并粘贴AWS的示例。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi na"><img src="../Images/d9250625d270a9ef02afa2ab68b902bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*w9TFcdqmcVfyJYpXjRc7eQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将连接添加到实例中</p></figure><p id="e277" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">添加连接后，将显示一个带有打开配置的弹出窗口(如果没有，请按F1，编写SSH并选择“打开SSH配置文件”)。在该文件中，您将拥有一个主机，其主机和主机名与您在AWS上看到的EC2实例主机相同。您可以为Host使用更重要的文本。只是不要改变主机名。在“身份文件”字段中，您将只有。pem文件。写入文件的完整路径(在Windows上，类似于“C:\ Users \ UserName \…\ name-of-the-file . PEM”)；在Ubuntu上，类似“/home/users/UserName/…/name-of-file . PEM”的东西。保存文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/5c2bc2567a8c15f570091b96ef495d80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mj0-qBkuAWw_iDfipSQBbA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">SSH配置文件，其中包含。pem文件</p></figure><p id="d706" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，按F1，写SSH，选择“连接到主机”。选择您用作主机的名称。如果一切正常，您将有一个新的VSCode窗口连接到EC2实例。如果文件有错误。pem，您可能需要在路径中从“/”切换到“\”，反之亦然。现在，我们必须修改。pem文件。</p><p id="6957" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开终端(菜单终端&gt;新建终端，或点击终端选项卡)，转到保存有<em class="nc"> cd的文件的目录。</em></p><p id="1330" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，如果您使用的是Linux，请使用以下命令:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="af0e" class="ni ma iq ne b gy nj nk l nl nm">$ sudo chmod 400 name-of-the-file.pem</span></pre><p id="08db" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您使用的是Windows:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="9a8c" class="ni ma iq ne b gy nj nk l nl nm">$ path = ".\name-of-the-file.pem"<br/>$ icacls.exe $path /reset<br/>$ icacls.exe $path /GRANT:R "$($env:USERNAME):(R)"<br/>$ icacls.exe $path /inheritance:r</span></pre><p id="5dd5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">考虑到您现在已经连接到EC2实例，打开终端菜单，然后打开新建终端。使用下面的命令确保实例的操作系统得到更新。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="9203" class="ni ma iq ne b gy nj nk l nl nm">$ sudo yum -y update</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/e0cc06a54610b12d4d4dda0b2944b54d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xJ1VYUmrAdNUPQa2VXTZaw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们将使用的终端</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="b39a" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">2.安装气流及其要求</h1><p id="32dd" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">首先，让我们安装操作系统的先决条件。经过一些实验后，下面命令上的包似乎是必要的并且足以做我们想做的一切:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="4129" class="ni ma iq ne b gy nj nk l nl nm">$ sudo yum -y install wget tar intltool icu4c gettext icu libicu-devel gcc-c++ python3-devel redhat-rpm-config gcc libffi-devel python-devel openssl-devel gzip gcc make expect openssl-devel bzip2-devel libffi-devel</span></pre><p id="a091" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们安装Airflow之前，我们需要升级sqlite版本。以下是命令。如果你对sqlite的链接有错误，请查看它的页面，因为它可能会被更新。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="2a05" class="ni ma iq ne b gy nj nk l nl nm">$ wget <a class="ae kv" href="https://www.sqlite.org/src/tarball/sqlite.tar.gz" rel="noopener ugc nofollow" target="_blank">https://www.sqlite.org/src/tarball/sqlite.tar.gz</a><br/>$ tar xzf sqlite.tar.gz<br/>$ cd sqlite/<br/>$ export CFLAGS="-DSQLITE_ENABLE_FTS3 \<br/>-DSQLITE_ENABLE_FTS3_PARENTHESIS \<br/>-DSQLITE_ENABLE_FTS4 \<br/>-DSQLITE_ENABLE_FTS5 \<br/>-DSQLITE_ENABLE_JSON1 \<br/>-DSQLITE_ENABLE_LOAD_EXTENSION \<br/>-DSQLITE_ENABLE_RTREE \<br/>-DSQLITE_ENABLE_STAT4 \<br/>-DSQLITE_ENABLE_UPDATE_DELETE_LIMIT \<br/>-DSQLITE_SOUNDEX \<br/>-DSQLITE_TEMP_STORE=3 \<br/>-DSQLITE_USE_URI \<br/>-O2 \<br/>-fPIC"<br/>$ export PREFIX="/usr/local"<br/>$ LIBS="-lm" ./configure -disable-tcl -enable-shared -enable-tempstore=always -prefix="$PREFIX"<br/>$ make<br/>$ sudo make install</span></pre><p id="7649" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，打开/etc/environment文件:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="c31d" class="ni ma iq ne b gy nj nk l nl nm">$ sudo vi /etc/environment</span></pre><p id="afdb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并添加这些行，这样就加载了正确版本的SQLite。当您执行上面的命令时，终端中会打开一个空白文件。如果您使用vi(如上面的命令)进入编辑模式，请按“I”。然后，给下面的线编号或粘贴。按ESC退出编辑模式。然后数字':w '和回车保存文件。现在，数字':q '和回车退出文件。一开始可能有点棘手，但你会习惯的。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="2a35" class="ni ma iq ne b gy nj nk l nl nm">export LD_LIBRARY_PATH="/usr/local/lib"<br/>export LD_RUN_PATH="/usr/local/lib"</span></pre><p id="0f64" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并运行以下命令来加载修改后的文件:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="3b76" class="ni ma iq ne b gy nj nk l nl nm">$ source /etc/environment</span></pre><p id="a5ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令检查操作系统上的sqlite版本和Python识别的版本:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="f816" class="ni ma iq ne b gy nj nk l nl nm">$ sqlite3 --version<br/>$ python3 -c "import sqlite3; print(sqlite3.sqlite_version)"</span></pre><p id="f952" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切正常，两者都将返回版本3.36(或更高版本，取决于您何时执行该过程)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/b81ede2dc8368c21796684e5f573c80a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k0TlDRDgvGuxC8KIDuvnaQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在操作系统和Python上检查SQLite版本</p></figure><p id="ed71" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们创建一个拥有气流装置的用户:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="1b1f" class="ni ma iq ne b gy nj nk l nl nm">$ sudo adduser airflow</span></pre><p id="5f47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并使用以下命令为用户定义密码:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="c253" class="ni ma iq ne b gy nj nk l nl nm">$ sudo passwd airflow</span></pre><p id="2ad0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我继续使用“气流”这个密码，但是你可以随意选择一个更好的。请注意，如果我在某个地方使用了密码，而你有不同的密码，请用你的密码交换。</p><p id="63b0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用下面的命令编辑文件，将新用户添加到sudoers文件中:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="e284" class="ni ma iq ne b gy nj nk l nl nm">$ sudo vi /etc/sudoers</span></pre><p id="ae06" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">搜索“root ALL=(ALL) ALL”行。将这一行复制粘贴到下面，将“根”部分切换为“气流”(该行将是:气流全部=(全部)全部)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/4b2577a2d652f4f5df76d99854f58dbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tNYvmnpRUfv8wEUZ0sOCLA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将airflow用户添加到sudoers文件中</p></figure><p id="e658" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用命令切换到新用户，然后输入密码:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="738c" class="ni ma iq ne b gy nj nk l nl nm">$ su airflow -</span></pre><p id="b85d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们为airflow安装创建一个目录，为虚拟环境创建一个目录，然后创建一个venv来安装airflow:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="aa94" class="ni ma iq ne b gy nj nk l nl nm">$ mkdir ~/airflow<br/>$ mkdir ~/.venv<br/>$ python3 -m venv ~/.venv/airflow</span></pre><p id="880a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过以下方式激活新环境:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="9328" class="ni ma iq ne b gy nj nk l nl nm">$ source ~/.venv/airflow/bin/activate</span></pre><p id="0abf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，运行这两个命令来安装更多Airflow需要的依赖项:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="695a" class="ni ma iq ne b gy nj nk l nl nm">$ sudo python3 -m pip install -U pip<br/>$ sudo python3 -m pip install -U setuptools</span></pre><p id="c5a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们要安装气流。从Apache Airflow页面中的命令，我们必须将python改编为python3，将pip改编为pip3。因此，我们有以下内容:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="6de0" class="ni ma iq ne b gy nj nk l nl nm">$ AIRFLOW_VERSION=2.0.1<br/>$ PYTHON_VERSION="$(python3 --version | cut -d " " -f 2 | cut -d "." -f 1-2)"<br/>$ export AIRFLOW_HOME=~/airflow<br/>$ CONSTRAINT_URL="https://raw.githubusercontent.com/apache/airflow/constraints-${AIRFLOW_VERSION}/constraints-${PYTHON_VERSION}.txt"<br/>$ pip3 install --upgrade "apache-airflow[postgres,google]==${AIRFLOW_VERSION}" --constraint "${CONSTRAINT_URL}"</span></pre><p id="533f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，转到Airflow主目录并初始化airflow元数据数据库:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="f224" class="ni ma iq ne b gy nj nk l nl nm">$ cd ~/airflow<br/>$ airflow db init</span></pre><p id="c796" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切正常，您应该会看到类似airflow.cfg和airflow.db的文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/d5e24ff6ff5fb1bb1888db91e2b8554f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gGDyxVcwvn7DqyNw2KYtxg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">气流目录中的文件，在我们初始化它之后</p></figure><p id="7d05" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，要以最简单的方式运行气流，我们需要运行两个服务。其中一个是调度器。为此，只需在终端上运行以下命令:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="7803" class="ni ma iq ne b gy nj nk l nl nm">$ airflow scheduler</span></pre><p id="8366" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您运行这个命令时，您的终端将被该服务的所有输出“锁定”。因为我们仍然需要运行第二个服务，所以我们需要打开第二个终端。在VSCode中，我们只需进入终端菜单，选择新终端。第一个航站楼将继续运行，并将开通一个全新的航站楼。如果您从一开始就遵循了整个过程，那么将再次与ec2用户建立远程ssh连接。我们需要切换到airflow用户并激活我们创建的虚拟环境:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="8b47" class="ni ma iq ne b gy nj nk l nl nm">$ sudo su airflow -<br/>$ cd ~<br/>$ source ~/.venv/airflow/bin/activate</span></pre><p id="8472" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，运行我们需要的第二个服务:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="12bb" class="ni ma iq ne b gy nj nk l nl nm">$ airflow webserver</span></pre><p id="7972" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们有足够的证据来检查气流是否流动。转到您的浏览器，使用端口为8080 (http://#的实例的IP或主机名作为URL。##.###.###:8080).可能需要几秒钟才能访问应用程序。如果您在使用此地址时遇到一些错误，请检查您的浏览器是否正在尝试使用https而不是http。必须是http。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/611a63672969a3dc5c3d199847aa3896.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*di6CLPQDN33BzEi24U-9vQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">气流初始页面</p></figure><p id="29df" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，即使气流页面正确打开，我们仍然无法登录。为此，我们需要创建一个用户。因为我们使用的两个终端正在运行服务，所以我们需要再打开一个，以便再次在实例上运行命令。打开新的终端，回到我们的用户和python环境:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="961e" class="ni ma iq ne b gy nj nk l nl nm">$ sudo su airflow -<br/>$ cd ~<br/>$ source ~/.venv/airflow/bin/activate</span></pre><p id="1592" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在运行下面的airflow命令来创建用户:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="81e1" class="ni ma iq ne b gy nj nk l nl nm">$ airflow users create -u admin -p admin -f FirstName -l LastName -r Admin -e name@mail.com</span></pre><p id="766c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，您可以将参数切换到您喜欢的用户名、密码等。</p><p id="bd43" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，回到您的浏览器，使用您选择的登录名和密码。您将看到示例Dag列表。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="119a" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">3.测试气流装置</h1><p id="cace" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">转到VSCode。考虑到您仍然连接到实例，激活了Airflow用户和虚拟环境(确保在每个命令的开头都有“(airflow)”。转到Airflow安装文件夹，创建Airflow DAGs的目录，并转到该目录:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="e865" class="ni ma iq ne b gy nj nk l nl nm">$ cd ~/airflow<br/>$ mkdir dags<br/>$ cd dags</span></pre><p id="d272" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建新文件:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="f0e2" class="ni ma iq ne b gy nj nk l nl nm">$ vi test.py</span></pre><p id="80f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并添加以下代码:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="a547" class="ni ma iq ne b gy nj nk l nl nm">from airflow import DAG<br/>from airflow.operators.python_operator import PythonOperator<br/>from datetime import datetime</span><span id="64a9" class="ni ma iq ne b gy nr nk l nl nm">default_args = {'start_date': datetime(2021,1,1)}</span><span id="3297" class="ni ma iq ne b gy nr nk l nl nm">def test():<br/>    print('Success')</span><span id="695c" class="ni ma iq ne b gy nr nk l nl nm">with DAG('test_dag', default_args=default_args, schedule_interval='@daily', catchup=False) as dag:</span><span id="d1ee" class="ni ma iq ne b gy nr nk l nl nm">    task_1 = PythonOperator(task_id='task_1', python_callable=test)</span></pre><p id="d346" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回到你的浏览器，在气流页面。</p><p id="a74f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">刷新页面并检查Dag列表中的新文件。加载DAG可能需要几分钟时间。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/2470ba01d28ab1c87a3eedee1c8dde56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/1*D_KhCaNom-d0rqfjySywIA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们在狗狗列表中的新狗狗</p></figure><p id="3b83" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开新的DAG。打开DAG名称左侧的开关。刷新页面。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/11d726c0eeb74d7425692eb88a9d0bcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*ubMWq0Wesvshybb6_QLWUw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">打开DAG的开关</p></figure><p id="9f60" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">转到图表视图。检查任务是否标记为绿色。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/db4b1d5a856e8c0cab455e3982f8cc97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qncmcWhVAHmoU1nKAPdaOg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">像往常一样，绿色是一个好信号</p></figure><p id="85fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击它并进入日志。用我们打印的文本检查这一行。“成功”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/7b842cbc813509c72075d0f5adf68d00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kt5DQrg49FQiTqwqn5rc-A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们想要的信息</p></figure><p id="6457" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">仅此而已。</p><p id="5112" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文的下一部分中，我们将在这个实例上安装DBT，进行一些设置以简化一些事情，在AWS上启动一些实验所需的其他资源，配置DBT并使用Airflow来调度DBT。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="bb99" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">阅读本文的所有部分:</h1><p id="23e7" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">第1部分:启动一个实例并安装气流<br/>第2部分:<a class="ae kv" rel="noopener" target="_blank" href="/creating-an-environment-with-airflow-and-dbt-on-aws-part-2-a23617d56eeb">安装DBT和一些设置使工作更容易</a> <br/>第3部分:<a class="ae kv" rel="noopener" target="_blank" href="/creating-an-environment-with-airflow-and-dbt-on-aws-part-3-2789f35adb5d">使用DBT云并将气流与DBT集成</a></p><h1 id="9178" class="lz ma iq bd mb mc nv me mf mg nw mi mj jw nx jx ml jz ny ka mn kc nz kd mp mq bi translated">参考</h1><p id="af31" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated"><a class="ae kv" href="https://docs.aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://docs.aws.amazon.com/<br/></em></a><a class="ae kv" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://airflow.apache.org/<br/></em></a><a class="ae kv" href="https://airflow.apache.org/docs/apache-airflow/stable/installation.html" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://air flow . Apache . org/docs/Apache-air flow/stable/installation . html</em></a><em class="nc"><br/></em><a class="ae kv" href="https://charlesleifer.com/blog/compiling-sqlite-for-use-with-python-applications/" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://charlesleifer . com/blog/compilating-SQLite-for-use-with-python-applications/</em></a><em class="nc"><br/></em></p><p id="6ed8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">对我在这里所做的大部分事情有帮助的来源:<br/></strong><a class="ae kv" href="https://www.datascienceacademy.com.br" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://www.datascienceacademy.com.br</em></a><em class="nc">【葡萄牙语】<br/></em><a class="ae kv" href="https://academy.astronomer.io/" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://academy.astronomer.io/</em></a><em class="nc"><br/></em><a class="ae kv" href="https://www.udemy.com/course/the-complete-hands-on-course-to-master-apache-airflow" rel="noopener ugc nofollow" target="_blank"><em class="nc">https://www . udemy . com/course/the-complete-hand-on-course-master-Apache-air</em></a></p></div></div>    
</body>
</html>