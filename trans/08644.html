<html>
<head>
<title>Image Augmentation With Domain-Related Artifacts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有领域相关伪像的图像增强</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/image-augmentation-with-domain-related-artifacts-e5f333f40d48?source=collection_archive---------42-----------------------#2021-08-09">https://towardsdatascience.com/image-augmentation-with-domain-related-artifacts-e5f333f40d48?source=collection_archive---------42-----------------------#2021-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/ef19f60881236f173c0f08971618aa27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OTYXrS3yxEXTynPmllZjHw.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">图片来自Unsplash的OpticalNomad</p></figure><div class=""/><div class=""><h2 id="d91a" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">用头发，昆虫和针隆胸的例子</h2></div><h1 id="0b7d" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">介绍</h1><p id="c76c" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">当在图像上训练深度神经网络模型时，扩充训练样本(图像)可以允许模型通过在由扩充人工生成的更多图像上进行训练来更好地概括。常用的增强包括水平和垂直翻转/移位、在某一角度和方向(顺时针/逆时针)的随机旋转、亮度、饱和度、对比度和缩放增强。</p><p id="1c20" class="pw-post-body-paragraph lm ln jf lo b lp mi kg lr ls mj kj lu lv mk lx ly lz ml mb mc md mm mf mg mh ij bi translated">Python中一个非常流行的图像扩充库是<code class="fe mn mo mp mq b">albumentations</code>(<a class="ae mr" href="https://albumentations.ai/" rel="noopener ugc nofollow" target="_blank">https://albumentations.ai/</a>)，它通过直观的函数和优秀的文档使图像扩充变得容易。它也可以与PyTorch和TensorFlow等流行的深度学习框架一起使用。</p><h1 id="c05c" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">领域相关伪影增强</h1><h2 id="dbbe" class="ms kv jf bd kw mt mu dn la mv mw dp le lv mx my lg lz mz na li md nb nc lk nd bi translated">直觉</h2><p id="bf14" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">这种用现实生活场景中可以找到的伪像来增加图像数据的方法背后的想法来自于模仿和概括现实中可能遇到的跨图像的模型的动机。例如，像雪或雨滴这样的增强物是不应在x光图像中发现的伪影，但胸管和起搏器是可以在x光图像内发现的伪影。</p><h2 id="f602" class="ms kv jf bd kw mt mu dn la mv mw dp le lv mx my lg lz mz na li md nb nc lk nd bi translated">这个想法是从哪里来的</h2><p id="5427" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">我第一次改变方法是从Roman的(@ nroman on Kaggle)为SIIM-ISIC黑色素瘤分类竞赛做的头发增加。他的方法的细节可以在这里找到:<a class="ae mr" href="https://www.kaggle.com/c/siim-isic-melanoma-classification/discussion/159176" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/c/siim-ISIC-黑素瘤-分类/讨论/159176 </a>。该增强的一个片段如下:</p><figure class="nf ng nh ni gt is gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/a263ce801cb4f0a25d0a3e5751b83121.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*td0mfd-WhKwYPPClkjwRTQ.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">原图(左上)和头发增强图(右上)，摘自<a class="ae mr" href="https://www.kaggle.com/c/siim-isic-melanoma-classification/discussion/159176" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/c/siim-ISIC-黑色素瘤-分类/讨论/159176 </a></p></figure><p id="dad3" class="pw-post-body-paragraph lm ln jf lo b lp mi kg lr ls mj kj lu lv mk lx ly lz ml mb mc md mm mf mg mh ij bi translated">我的团队在我们的模型训练中使用了他的增强，这有助于提高我们大多数模型的交叉验证(CV)分数。我想说这种形式的增强可能在我们的最终排名中起到了关键作用！从那以后，用头发(或一般的人工制品)来增加图像数据的想法在我参加的随后的比赛中站得很近，并在我可以的地方应用它。特别是在<a class="ae mr" href="https://www.kaggle.com/c/global-wheat-detection" rel="noopener ugc nofollow" target="_blank">全球小麦检测</a>、<a class="ae mr" href="https://www.kaggle.com/c/cassava-leaf-disease-classification" rel="noopener ugc nofollow" target="_blank">木薯叶部病害分类</a>和<a class="ae mr" href="https://www.kaggle.com/c/ranzcr-clip-catheter-line-classification" rel="noopener ugc nofollow" target="_blank"> RANZCR CLiP —导管和线位挑战赛</a>中推广应用了该方法。</p><h2 id="20a6" class="ms kv jf bd kw mt mu dn la mv mw dp le lv mx my lg lz mz na li md nb nc lk nd bi translated">昆虫扩增</h2><p id="9f46" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">顾名思义，这种方法包括用昆虫来增强图像。这种人工制品的正确领域可以是数据中的一种自然设置，其中昆虫通常在空中或表面上到处可见。在这个例子中，在木薯和全球小麦检测比赛中，当增强叶子图像时，蜜蜂被用作选择的昆虫。以下是增强图像的外观示例:</p><figure class="nf ng nh ni gt is gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/2b4aa416b0654521db290dfccfa345f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*yG1BNLabwl1VNvCoEbcWDQ.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">蜜蜂在树叶周围飞舞的增强图像，摘自<a class="ae mr" href="https://www.kaggle.com/khoongweihao/insect-augmentation-et-al/notebook" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/khoongweihao/昆虫增强-et-al/notebook </a></p></figure><p id="2fa0" class="pw-post-body-paragraph lm ln jf lo b lp mi kg lr ls mj kj lu lv mk lx ly lz ml mb mc md mm mf mg mh ij bi translated">我们还可以使用伪像的掩蔽形式，在图像中产生黑点(类似于白蛋白中的<code class="fe mn mo mp mq b">CoarseDropout</code>)，即没有颜色的黑色蜜蜂:</p><figure class="nf ng nh ni gt is gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/bde805b3455b44116c8d266dcd15252f.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*8WbZAKAiUAtxbTkqX33MeA.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">深色/黑色蜜蜂在树叶周围飞行的增强图像，取自<a class="ae mr" href="https://www.kaggle.com/khoongweihao/insect-augmentation-et-al/notebook" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/khoongweihao/昆虫增强-et-al/notebook </a></p></figure><p id="aa9a" class="pw-post-body-paragraph lm ln jf lo b lp mi kg lr ls mj kj lu lv mk lx ly lz ml mb mc md mm mf mg mh ij bi translated">以下以albuminations风格编写的代码允许工件增强与来自albuminations库的其他增强一起轻松使用:</p><pre class="nf ng nh ni gt nk mq nl nm aw nn bi"><span id="4124" class="ms kv jf mq b gy no np l nq nr">from albumentations.core.transforms_interface import ImageOnlyTransform<br/>    <br/>class <strong class="mq jg">InsectAugmentation</strong>(ImageOnlyTransform):<br/>    <em class="ns">"""</em><br/><em class="ns">    Impose an image of a insect to the target image</em><br/><em class="ns">    -----------------------------------------------</em><br/><em class="ns">    Args:</em><br/><em class="ns">        insects (int): maximum number of insects to impose</em><br/><em class="ns">        insects_folder (str): path to the folder with insects images</em><br/><em class="ns">    """</em><br/><br/>    def __init__(self, insects=2, dark_insect=False, always_apply=False, p=0.5):<br/>        super().__init__(always_apply, p)<br/>        self.insects = insects<br/>        self.dark_insect = dark_insect<br/>        self.insects_folder = "/kaggle/input/bee-augmentation/"<br/><br/>    def apply(self, image, **kwargs):<br/>        <em class="ns">"""</em><br/><em class="ns">        Args:</em><br/><em class="ns">            image (PIL Image): Image to draw insects on.</em><br/><br/><em class="ns">        Returns:</em><br/><em class="ns">            PIL Image: Image with drawn insects.</em><br/><em class="ns">        """</em><br/>        n_insects = random.randint(1, self.insects) <em class="ns"># for this example I put 1 instead of 0 to illustrate the augmentation</em><br/>        <br/>        if <strong class="mq jg">not</strong> n_insects:<br/>            return image<br/>        <br/>        height, width, _ = image.shape  <em class="ns"># target image width and height</em><br/>        insects_images = [im for im <strong class="mq jg">in</strong> os.listdir(self.insects_folder) if 'png' <strong class="mq jg">in</strong> im]<br/>        <br/>        for _ <strong class="mq jg">in</strong> range(n_insects):<br/>            insect = cv2.cvtColor(cv2.imread(os.path.join(self.insects_folder, random.choice(insects_images))), cv2.COLOR_BGR2RGB)<br/>            insect = cv2.flip(insect, random.choice([-1, 0, 1]))<br/>            insect = cv2.rotate(insect, random.choice([0, 1, 2]))<br/><br/>            h_height, h_width, _ = insect.shape  <em class="ns"># insect image width and height</em><br/>            roi_ho = random.randint(0, image.shape[0] - insect.shape[0])<br/>            roi_wo = random.randint(0, image.shape[1] - insect.shape[1])<br/>            roi = image[roi_ho:roi_ho + h_height, roi_wo:roi_wo + h_width]<br/><br/>            <em class="ns"># Creating a mask and inverse mask </em><br/>            img2gray = cv2.cvtColor(insect, cv2.COLOR_BGR2GRAY)<br/>            ret, mask = cv2.threshold(img2gray, 10, 255, cv2.THRESH_BINARY)<br/>            mask_inv = cv2.bitwise_not(mask)<br/><br/>            <em class="ns"># Now black-out the area of insect in ROI</em><br/>            img_bg = cv2.bitwise_and(roi, roi, mask=mask_inv)<br/><br/>            <em class="ns"># Take only region of insect from insect image.</em><br/>            if self.dark_insect:<br/>                img_bg = cv2.bitwise_and(roi, roi, mask=mask_inv)<br/>                insect_fg = cv2.bitwise_and(img_bg, img_bg, mask=mask)<br/>            else:<br/>                insect_fg = cv2.bitwise_and(insect, insect, mask=mask)<br/><br/>            <em class="ns"># Put insect in ROI and modify the target image</em><br/>            dst = cv2.add(img_bg, insect_fg, dtype=cv2.CV_64F)<br/><br/>            image[roi_ho:roi_ho + h_height, roi_wo:roi_wo + h_width] = dst<br/>                <br/>        return image</span></pre><p id="ab9a" class="pw-post-body-paragraph lm ln jf lo b lp mi kg lr ls mj kj lu lv mk lx ly lz ml mb mc md mm mf mg mh ij bi translated">如果你想使用黑色版本的神器，将<code class="fe mn mo mp mq b">dark_insect</code>设置为<code class="fe mn mo mp mq b">True</code>。在我的Kaggle笔记本中可以找到一个示例实现:<a class="ae mr" href="https://www.kaggle.com/khoongweihao/insect-augmentation-with-efficientdet-d6/notebook" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/khoongwihao/昆虫增强高效检测-d6/notebook </a>。</p><h2 id="7bd0" class="ms kv jf bd kw mt mu dn la mv mw dp le lv mx my lg lz mz na li md nb nc lk nd bi translated">针头增大术</h2><p id="30b1" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">在这种方法中，使用针来增强图像，例如，图像可以是x射线图像或带有针线包的桌面。以下是增强图像的外观示例:</p><figure class="nf ng nh ni gt is gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/d825da1f6754b2fffa6c1893367d9a10.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*6qWQUx1CoyrsKOcr1MACMg.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">x光左侧有针的增强图像，取自<a class="ae mr" href="https://www.kaggle.com/khoongweihao/x-ray-needle-augmentation-et-al/notebook" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/khoongweihao/x-ray-needle-augmentation-et-al/notebook</a></p></figure><p id="a4c1" class="pw-post-body-paragraph lm ln jf lo b lp mi kg lr ls mj kj lu lv mk lx ly lz ml mb mc md mm mf mg mh ij bi translated">类似地，我们可以使用针状伪像的黑色版本，从而得到以下增强图像:</p><figure class="nf ng nh ni gt is gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/3345364945d77389e1ed8a5fe80ae8a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*pW0XIvQN9QxBY5U0YuhDqg.png"/></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">x光片两侧暗/黑色针状物的增强图像，取自<a class="ae mr" href="https://www.kaggle.com/khoongweihao/x-ray-needle-augmentation-et-al/notebook" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/khoongweihao/x-ray-needle-augmentation-et-al/notebook</a></p></figure><p id="214f" class="pw-post-body-paragraph lm ln jf lo b lp mi kg lr ls mj kj lu lv mk lx ly lz ml mb mc md mm mf mg mh ij bi translated">用作上述增强模块的代码片段如下:</p><pre class="nf ng nh ni gt nk mq nl nm aw nn bi"><span id="0a94" class="ms kv jf mq b gy no np l nq nr">def NeedleAugmentation(image, n_needles=2, dark_needles=False, p=0.5, needle_folder='../input/xray-needle-augmentation'):<br/>    aug_prob = random.random()<br/>    if aug_prob &lt; p:<br/>        height, width, _ = image.shape  <em class="ns"># target image width and height</em><br/>        needle_images = [im for im <strong class="mq jg">in</strong> os.listdir(needle_folder) if 'png' <strong class="mq jg">in</strong> im]<br/><br/>        for _ <strong class="mq jg">in</strong> range(1, n_needles):<br/>            needle = cv2.cvtColor(cv2.imread(os.path.join(needle_folder, random.choice(needle_images))), cv2.COLOR_BGR2RGB)<br/>            needle = cv2.flip(needle, random.choice([-1, 0, 1]))<br/>            needle = cv2.rotate(needle, random.choice([0, 1, 2]))<br/><br/>            h_height, h_width, _ = needle.shape  <em class="ns"># needle image width and height</em><br/>            roi_ho = random.randint(0, abs(image.shape[0] - needle.shape[0]))<br/>            roi_wo = random.randint(0, abs(image.shape[1] - needle.shape[1]))<br/>            roi = image[roi_ho:roi_ho + h_height, roi_wo:roi_wo + h_width]<br/><br/>            <em class="ns"># Creating a mask and inverse mask </em><br/>            img2gray = cv2.cvtColor(needle, cv2.COLOR_BGR2GRAY)<br/>            ret, mask = cv2.threshold(img2gray, 10, 255, cv2.THRESH_BINARY)<br/>            mask_inv = cv2.bitwise_not(mask)<br/><br/>            <em class="ns"># Now black-out the area of needle in ROI</em><br/>            img_bg = cv2.bitwise_and(roi, roi, mask=mask_inv)<br/><br/>            <em class="ns"># Take only region of insect from insect image.</em><br/>            if dark_needles:<br/>                img_bg = cv2.bitwise_and(roi, roi, mask=mask_inv)<br/>                needle_fg = cv2.bitwise_and(img_bg, img_bg, mask=mask)<br/>            else:<br/>                needle_fg = cv2.bitwise_and(needle, needle, mask=mask)<br/><br/>            <em class="ns"># Put needle in ROI and modify the target image</em><br/>            dst = cv2.add(img_bg, needle_fg, dtype=cv2.CV_64F)<br/><br/>            image[roi_ho:roi_ho + h_height, roi_wo:roi_wo + h_width] = dst<br/><br/>    return image</span></pre><p id="495d" class="pw-post-body-paragraph lm ln jf lo b lp mi kg lr ls mj kj lu lv mk lx ly lz ml mb mc md mm mf mg mh ij bi translated">请注意，以上不是白蛋白格式，不能直接应用于通常的白蛋白增加。必须做一些调整，使其格式与上面的昆虫/蜜蜂增强相同。但是变化应该是微小的！</p><p id="0fc1" class="pw-post-body-paragraph lm ln jf lo b lp mi kg lr ls mj kj lu lv mk lx ly lz ml mb mc md mm mf mg mh ij bi translated">类似地，如果您希望使用工件的黑色版本，请将<code class="fe mn mo mp mq b">dark_needles</code>设置为<code class="fe mn mo mp mq b">True</code>。一个实现的例子可以在我的Kaggle笔记本这里找到:<a class="ae mr" href="https://www.kaggle.com/khoongweihao/x-ray-needle-augmentation-et-al/notebook" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/khoongweihao/x-ray-needle-augmentation-et-al/notebook</a>。</p><h1 id="7d7e" class="ku kv jf bd kw kx ky kz la lb lc ld le kl lf km lg ko lh kp li kr lj ks lk ll bi translated">实验结果</h1><p id="855a" class="pw-post-body-paragraph lm ln jf lo b lp lq kg lr ls lt kj lu lv lw lx ly lz ma mb mc md me mf mg mh ij bi translated">总的来说，局部CV结果有所改善，但改善幅度不大(例如0.001–0.003)。但是在训练中，使用这种伪影增强的方法会有“失败”的情况。在全球小麦探测竞赛中可以找到一个例子，其中任务涉及探测小麦穗，即物体探测任务。尽管进行了广泛的超参数调整，但使用蜜蜂的原始颜色进行蜜蜂增强导致了具有巨大波动的零星训练验证损失。虽然使用增强确实提高了CV，但可以说这确实是一次幸运的尝试。使用仅保留黑色像素的伪影增强(如粗略丢失增强)被证明在应用领域中是稳定的。特别是，CV的提高是实质性的，也是持续的。到目前为止，还没有找到蜜蜂扩增导致不同时期之间出现这种零星训练结果的原因，但一个假设是蜜蜂的颜色接近一些麦穗，因此“混淆”了检测算法，该算法随后在同一边界框内捕获麦穗和最近的蜜蜂。在一些边界框预测中观察到了这一点，但是没有足够多的观察案例来肯定地说该假设是正确的。在任何情况下，还应该考虑伪影的图像属性(颜色)是否具有接近目标(例如麦穗)的分布。另一方面，针隆乳被证明对两种隆乳都是相对稳定的(原始伪影及其黑色/深色版本)。在该示例中，尽管颜色分布相似，但预测的目标可能具有不同的特征(例如，胸腔管看起来与细小的针非常不同)，从而分类算法不会混淆针是否是正确的目标。</p></div></div>    
</body>
</html>