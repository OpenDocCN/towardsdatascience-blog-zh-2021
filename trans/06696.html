<html>
<head>
<title>Calculating Internal Rate of Return (IRR) in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在BigQuery中计算内部收益率(IRR)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/calculating-internal-rate-of-return-irr-in-bigquery-75e6703e8ec3?source=collection_archive---------12-----------------------#2021-06-16">https://towardsdatascience.com/calculating-internal-rate-of-return-irr-in-bigquery-75e6703e8ec3?source=collection_archive---------12-----------------------#2021-06-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="75b9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在BigQuery中实现Excel的IRR函数的分步指南</h2></div><p id="6b17" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">内部收益率(IRR)是财务中经常出现的一种常见计算方法。在这篇博文中，我将展示如何在BigQuery中构建一个查询，该查询执行相当于<a class="ae lb" href="https://support.microsoft.com/en-us/office/irr-function-64925eaa-9988-495b-b290-3ad0c163c1bc" rel="noopener ugc nofollow" target="_blank"> Excel的</a> <code class="fe lc ld le lf b"><a class="ae lb" href="https://support.microsoft.com/en-us/office/irr-function-64925eaa-9988-495b-b290-3ad0c163c1bc" rel="noopener ugc nofollow" target="_blank">IRR</a></code> <a class="ae lb" href="https://support.microsoft.com/en-us/office/irr-function-64925eaa-9988-495b-b290-3ad0c163c1bc" rel="noopener ugc nofollow" target="_blank">函数</a>的计算。如果现金流存储在BigQuery表中，并且您希望在不将数据移动到Excel的情况下计算IRR，或者如果您希望将BigQuery用作数据可视化和BI的来源，这将很有帮助。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/f1087dda7b85ab806ad704167541f01c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*J42Mxr972_D-6iYI"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@homajob?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">斯科特·格雷厄姆</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="901c" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">1.背景:内部收益率(IRR)和净现值(NPV)</h1><p id="e740" class="pw-post-body-paragraph kf kg iq kh b ki mo jr kk kl mp ju kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">内部收益率(IRR)是投资产生的所有现金流的净现值等于零的收益率。它主要作为一个决策规则:一项投资的一系列现金流的内部收益率越高，超过资本成本的金额越大，该项投资就越有利可图。</p><p id="002b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">从数学上讲，IRR是求解以下方程的<code class="fe lc ld le lf b">r</code>的值:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/8d8242905053e73fd9003bd288bd3772.png" data-original-src="https://miro.medium.com/v2/resize:fit:508/format:webp/1*1yZibzzBoLKR4wWuN1J3yQ.png"/></div></figure><p id="78b7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这与以下内容相同:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mu"><img src="../Images/f2bb3e1890d39d02222193d68b9e5b5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*4De8OWgrdmjyMYXizHdtzA.png"/></div></div></figure><p id="7a8c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里，<code class="fe lc ld le lf b">t</code>是时间段(从0到<code class="fe lc ld le lf b">N</code>)，<code class="fe lc ld le lf b">CF</code>是时间段<code class="fe lc ld le lf b">t</code>的现金流，<code class="fe lc ld le lf b">r</code>是收益率(IRR)。</p><p id="1a55" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上述方程没有解析解。换句话说，没有数学公式可以给我们内部收益率。解决这个问题的唯一方法是用数值方法，尝试<code class="fe lc ld le lf b">r</code>的多个值，看看哪一个最接近满足这个方程。</p><p id="06a7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于<code class="fe lc ld le lf b">r</code>的任何给定值，上述等式的左侧给出了净现值:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/96b4297d321821cf513ba890e657f3b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:804/format:webp/1*4FORCRfrQPItv96TIbd6yA.png"/></div></figure><h1 id="bb06" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated"><strong class="ak"> 2。示例</strong>使用Excel的IRR函数计算IRR</h1><p id="d628" class="pw-post-body-paragraph kf kg iq kh b ki mo jr kk kl mp ju kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated">在本指南的其余部分，我们将使用下面的简单示例。让我们假设我们在文件<code class="fe lc ld le lf b">irr.csv</code>中存储了以下现金流</p><pre class="lh li lj lk gt mw lf mx my aw mz bi"><span id="9622" class="na lx iq lf b gy nb nc l nd ne">PERIOD, CASHFLOW<br/>0, -10000<br/>1, 2000<br/>2, 6000<br/>3, 6000</span></pre><p id="4be4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以用Excel的<code class="fe lc ld le lf b">IRR</code>函数来计算内部收益率。<a class="ae lb" href="https://support.microsoft.com/en-us/office/irr-function-64925eaa-9988-495b-b290-3ad0c163c1bc" rel="noopener ugc nofollow" target="_blank"> Excel的文档</a>对<code class="fe lc ld le lf b">IRR</code>函数描述如下:</p><blockquote class="nf ng nh"><p id="17c6" class="kf kg ni kh b ki kj jr kk kl km ju kn nj kp kq kr nk kt ku kv nl kx ky kz la ij bi translated">返回由数值中的数字表示的一系列现金流的内部收益率。这些现金流不必像年金一样均匀。然而，现金流必须定期发生，例如每月或每年。</p></blockquote><p id="654d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Excel中计算IRR相当简单:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nm"><img src="../Images/b0c68c9c56ff1dfc64eb53b755d03c2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n0-RsvDuUgF5DT9MpkZXmw.png"/></div></div></figure><p id="5948" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的目标是在BigQuery中实现这一点。</p><h1 id="8191" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">3.现在净价值</h1><p id="ff5b" class="pw-post-body-paragraph kf kg iq kh b ki mo jr kk kl mp ju kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated"><strong class="kh ir"> a. </strong>首先，让我们在BigQuery中计算上述现金流的净现值。我们可以使用BigQuery控制台轻松地将<code class="fe lc ld le lf b">irr.csv</code>数据导入到BigQuery表<a class="ae lb" href="https://cloud.google.com/bigquery/docs/batch-loading-data" rel="noopener ugc nofollow" target="_blank">中。在本指南中，生成的表被命名为<code class="fe lc ld le lf b">tutorial.irr.cashflows</code></a></p><p id="2a37" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi nn translated"><strong class="kh ir"> b. </strong>一旦创建了表，我们就可以运行下面的查询，该查询返回一个包含每个现金流现值的附加列:</p><pre class="lh li lj lk gt mw lf mx my aw mz bi"><span id="ac83" class="na lx iq lf b gy nb nc l nd ne">SELECT<br/>  period,<br/>  cashflow,<br/>  cashflow/POWER(1+0.16, period) AS present_value<br/>FROM<br/>  `<!-- -->tutorial.irr.cashflows<!-- -->`<br/>ORDER BY<br/>  period</span></pre><p id="1ad0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BigQuery输出以下查询结果:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi no"><img src="../Images/f9e8460a83f6cb6615ce0a98804e2467.png" data-original-src="https://miro.medium.com/v2/resize:fit:680/format:webp/1*0rpM25ynpquX_A7mvxdjvQ.png"/></div></figure><p id="e1f0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi nn translated"><strong class="kh ir"> c. </strong>净现值就是现金流的现值之和。因此，我们可以使用SUM aggregate函数来获得现金流的净现值:</p><pre class="lh li lj lk gt mw lf mx my aw mz bi"><span id="087f" class="na lx iq lf b gy nb nc l nd ne">SELECT<br/>  SUM(cashflow/POWER(1+0.1614, period)) AS net_present_value<br/>FROM<br/>  `<!-- -->tutorial.irr.cashflows<!-- -->`</span></pre><p id="1905" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BigQuery输出以下查询结果:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi np"><img src="../Images/ca09f2d0c0b31fbb97c2763f50a39802.png" data-original-src="https://miro.medium.com/v2/resize:fit:374/format:webp/1*EGi-rE3-v4TJeSVPSDxVKw.png"/></div></figure><p id="b6be" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">净现值接近于零，这验证了我们从Excel得到的结果，即16.14%是IRR的近似值。</p><h1 id="2688" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">4.内部收益率</h1><p id="d50e" class="pw-post-body-paragraph kf kg iq kh b ki mo jr kk kl mp ju kn ko mq kq kr ks mr ku kv kw ms ky kz la ij bi translated"><strong class="kh ir">答</strong>。现在我们知道了如何计算净现值，我们的目标是找到<code class="fe lc ld le lf b">r</code>的一系列值的净现值，并选择最接近零的一个。为了生成<code class="fe lc ld le lf b">r</code>的一系列值，我们将利用BigQuery的<code class="fe lc ld le lf b">GENERATE_ARRAY</code>函数。下面是来自BigQuery的<a class="ae lb" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/arrays" rel="noopener ugc nofollow" target="_blank">官方文档</a>对<code class="fe lc ld le lf b">GENERATE_ARRAY</code>函数的简要说明:</p><blockquote class="nf ng nh"><p id="150c" class="kf kg ni kh b ki kj jr kk kl km ju kn nj kp kq kr nk kt ku kv nl kx ky kz la ij bi translated"><code class="fe lc ld le lf b"><a class="ae lb" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/array_functions#generate_array" rel="noopener ugc nofollow" target="_blank">GENERATE_ARRAY</a></code>根据起始值、结束值和步长值生成一个值数组。例如，以下查询生成一个数组，其中包含从11到33的所有奇数，包括11和33:</p><p id="f12f" class="kf kg ni kh b ki kj jr kk kl km ju kn nj kp kq kr nk kt ku kv nl kx ky kz la ij bi translated"><code class="fe lc ld le lf b">SELECT GENERATE_ARRAY(11, 33, 2) AS odds;</code></p><p id="39ac" class="kf kg ni kh b ki kj jr kk kl km ju kn nj kp kq kr nk kt ku kv nl kx ky kz la ij bi translated"><code class="fe lc ld le lf b">+--------------------------------------------------+<br/>| odds |<br/>+--------------------------------------------------+<br/>| [11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31, 33] |<br/>+--------------------------------------------------+</code></p></blockquote><p id="4950" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> b </strong>。为了说明我们将如何找到IRR，让我们考虑一小组<code class="fe lc ld le lf b">r</code> <code class="fe lc ld le lf b">[0.14, 0.15, 0.16, 0.17, 0.18, 0.19]</code>的值作为IRR的猜测值。(我们稍后将考虑更大范围的值。现在，假设我们知道IRR在上述范围内。我们从前面的计算中知道，IRR最接近0.16。)以下查询为这些猜测值中的每一个生成净现值:</p><pre class="lh li lj lk gt mw lf mx my aw mz bi"><span id="5268" class="na lx iq lf b gy nb nc l nd ne">SELECT<br/>  guess,<br/>  SUM(cashflow/POWER(1+guess, period)) AS net_present_value<br/>FROM<br/>  `<!-- -->tutorial.irr.cashflows<!-- -->`<br/>CROSS JOIN<br/>  UNNEST(GENERATE_ARRAY(0.14,.19,0.01)) AS guess<br/>GROUP BY<br/>  guess</span></pre><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/c122f67558365dd9ecb26e392eb3f06f.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/1*mk2r2ug9Tuu2ibDoVjhhaw.png"/></div></figure><p id="3218" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以看到，当猜测值等于0.16时，结果表中的净现值最接近于零。</p><p id="220e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的下一个任务是编写一条SQL，给出净现值最接近于零的<code class="fe lc ld le lf b">r</code>的值(即IRR)。以下查询通过使用公用表表达式来实现这一点:</p><pre class="lh li lj lk gt mw lf mx my aw mz bi"><span id="7e7c" class="na lx iq lf b gy nb nc l nd ne">WITH<br/>  npv_table AS (<br/>  SELECT<br/>    guess,<br/>    SUM(cashflow/POWER(1+guess, period)) AS net_present_value<br/>  FROM<br/>    `<!-- -->tutorial.irr.cashflows<!-- -->`<br/>  CROSS JOIN<br/>    UNNEST(GENERATE_ARRAY(0.14,.19,.01)) AS guess<br/>  GROUP BY<br/>    guess)<br/>SELECT<br/>  guess AS IRR<br/>FROM<br/>  npv_table<br/>WHERE<br/>  ABS(net_present_value) = (<br/>  SELECT<br/>    MIN(ABS(net_present_value))<br/>  FROM<br/>    npv_table)</span></pre><p id="568a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BigQuery输出以下查询结果:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/0c0ae242b0d2885d6f3fca3f9a646cf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:378/format:webp/1*ypfODF0-Sk9NEaTcPJDt9A.png"/></div></figure><p id="1393" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> d. </strong>现在我们知道了如何计算IRR，我们可以考虑使用下面的查询来计算<code class="fe lc ld le lf b">GENERATE_ARRAY</code>函数中<code class="fe lc ld le lf b">r</code>的更大范围的值:</p><pre class="lh li lj lk gt mw lf mx my aw mz bi"><span id="cf4d" class="na lx iq lf b gy nb nc l nd ne">WITH<br/>  npv_table AS (<br/>  SELECT<br/>    guess,<br/>    SUM(cashflow/POWER(1+guess, period)) AS net_present_value<br/>  FROM<br/>    `<!-- -->tutorial.irr.cashflows<!-- -->`<br/>  CROSS JOIN<br/>    UNNEST(GENERATE_ARRAY(0,2,.0001)) AS guess<br/>  GROUP BY<br/>    guess)<br/>SELECT<br/>  ROUND(guess*100,2) AS IRR_percentage<br/>FROM<br/>  npv_table<br/>WHERE<br/>  ABS(net_present_value) = (<br/>  SELECT<br/>    MIN(ABS(net_present_value))<br/>  FROM<br/>    npv_table)</span></pre><p id="2ec0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">BigQuery输出以下查询结果:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/fc86eaa58ea2f1fac0c04c835a4024ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:376/format:webp/1*-HjHmwBDpuFNHcZf_lhbmQ.png"/></div></figure><p id="1185" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这与我们从Excel的IRR函数中得到的值完全相同。(在最终查询中，IRR值已被格式化为小数点后两位的百分比。)</p><p id="818c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="ni">感谢阅读！请在评论中分享反馈。</em></p></div></div>    
</body>
</html>