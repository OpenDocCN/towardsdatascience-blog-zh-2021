<html>
<head>
<title>Custom AWS SageMaker: Train and Deploy Fake Tweets predictor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">定制AWS SageMaker:训练和部署假推预测器</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/custom-aws-sagemaker-train-and-deploy-fake-tweets-predictor-9178f20d0f99?source=collection_archive---------23-----------------------#2021-05-23">https://towardsdatascience.com/custom-aws-sagemaker-train-and-deploy-fake-tweets-predictor-9178f20d0f99?source=collection_archive---------23-----------------------#2021-05-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="2d89" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在数据和信息技术领域，云提供商势头强劲。AWS、Azure、Google Cloud等最大的云提供商不仅在云中租用硬件。它们还为机器学习模型的简单操作提供了基础设施。在我的<a class="ae ko" rel="noopener" target="_blank" href="/colab-synergy-with-mlflow-how-to-monitor-progress-and-store-models-fbfdf7bb0d7d">上一篇文章</a>中，我提到了用谷歌云训练模型的可能性。同时，AWS提供了自己的一套工具来训练和管理模型。在这篇文章中，我想深入探讨的工具之一是AWS SageMaker。</p><p id="4c0b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我不确定SageMaker的名字是否与鼠尾草(鼠尾草)有关，但是我喜欢它的味道。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/d9c9719402b735cb3be9fedd126db4e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*t7h-EMHi6zPbQcrP"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">照片由<a class="ae ko" href="https://unsplash.com/@phillip_larking?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">菲利普·拉金</a>在<a class="ae ko" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="4845" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">SageMaker是一款准备、构建、培训和调整、部署和管理机器学习模型的首选工具。SageMaker提供了大量的预设置和即用型容器。范围涵盖了不同的框架:PyTorch、Scikit-learn、Chainer、MXNet以及Huggingface。当您想要构建一个只使用其中一个框架的模型时，设置容器是很方便的。但是越来越需要使用它们的组合。例如，我可能想从Huggingface获取一个模型，并在输出中添加一些Scikit-learn ML模型。那我该怎么办？幸运的是，可以构建一个定制的Docker容器并用SageMaker部署它。这可能是一个不错的通用解决方案。然而，如果使用Scikit-learn部署预构建容器需要大约10行代码，那么定制Docker的开发可能<a class="ae ko" href="https://github.com/aws-samples/amazon-sagemaker-custom-container" rel="noopener ugc nofollow" target="_blank">需要一些时间</a>。如果我告诉你有一个中间的解决方案。它花费了超过10行的代码，但是，你不应该为SageMakers定制Dockers？忍耐一下，我们会找到路的。</p><p id="a48f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">问题描述</strong></p><p id="c2ee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">目标</strong></p><p id="279a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了展示定制的SageMaker设置，让我们看看一个<a class="ae ko" href="https://www.kaggle.com/vbmokin/nlp-with-disaster-tweets-cleaning-data" rel="noopener ugc nofollow" target="_blank"> Kaggle竞赛数据集</a>的例子，它由关于灾难的虚假和真实推文组成。任务是对推文进行分类。在这篇博文中，我们构建了一个应用程序，它接受文本作为输入，并返回关于灾难的推文是真实的概率。最终的应用程序可能如下所示:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lf"><img src="../Images/2b4e4f76c102f5b8a81de1c68d4ab6e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O1XBzslE_nVq7CHzo7O-aA.jpeg"/></div></div></figure><p id="06d7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以将任务分成三个子任务:</p><ol class=""><li id="92b8" class="lg lh it js b jt ju jx jy kb li kf lj kj lk kn ll lm ln lo bi translated">使用SageMaker培训和部署定制模型</li><li id="7bb9" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated">创建将使用SageMaker模型的API</li><li id="55cd" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated">构建并部署一个Flask应用程序，它将获取tweets并返回API的结果</li></ol><p id="63a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这篇博文中，我们将详细讨论第一个任务。另外两个在<a class="ae ko" href="https://aws.amazon.com/blogs/machine-learning/call-an-amazon-sagemaker-model-endpoint-using-amazon-api-gateway-and-aws-lambda/" rel="noopener ugc nofollow" target="_blank"> AWS教程</a>、<a class="ae ko" href="https://medium.com/techfront/step-by-step-visual-guide-on-deploying-a-flask-application-on-aws-ec2-8e3e8b82c4f7" rel="noopener"> TECHFRONT帖子</a>中有所涉及。最终的架构将如下所示:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lu"><img src="../Images/00402480272a187389daf25f51c9d76a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WRanrrI86etJocqb9sGYoQ.jpeg"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated"><a class="ae ko" href="https://aws.amazon.com/blogs/machine-learning/call-an-amazon-sagemaker-model-endpoint-using-amazon-api-gateway-and-aws-lambda/" rel="noopener ugc nofollow" target="_blank"> AWS教程</a>、<a class="ae ko" href="https://medium.com/techfront/step-by-step-visual-guide-on-deploying-a-flask-application-on-aws-ec2-8e3e8b82c4f7" rel="noopener"> TECHFRONT帖子</a></p></figure><p id="622b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里我们故意牺牲模型的准确性(不包括其他特征，不了解太多数据，不降维等。)为了训练脚本简单起见。目的是展示如何使用SageMaker训练和部署一个应用，而不是展示如何建立一个准确的模型。人们可以在Kaggle的<a class="ae ko" href="https://www.kaggle.com/vbmokin/nlp-with-disaster-tweets-cleaning-data/code" rel="noopener ugc nofollow" target="_blank">相应解决方案</a>中了解更多关于构建更好模型的信息。</p><p id="f613" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">数据集</strong></p><p id="9b92" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae ko" href="https://www.kaggle.com/vbmokin/nlp-with-disaster-tweets-cleaning-data?select=train_data_cleaning.csv" rel="noopener ugc nofollow" target="_blank">数据集</a>由带标签的虚假和真实推文组成。标签在“目标”栏中提供。有几个特征，尽管为了这篇博文的目的，我们将只使用“文本”字段来表示推文的文本。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lv"><img src="../Images/2fd2f878739a2ef9e431baaae439eced.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qfNWlTmtvhA-gImjB3CX0A.png"/></div></div><p class="lb lc gj gh gi ld le bd b be z dk translated">更多信息请参见<a class="ae ko" href="https://www.kaggle.com/vbmokin/nlp-with-disaster-tweets-cleaning-data?select=train_data_cleaning.csv" rel="noopener ugc nofollow" target="_blank">卡格尔比赛</a></p></figure><p id="7f2e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">记住，我们要对真假推文进行分类。</p><p id="716e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">模型训练脚本</strong></p><p id="6b10" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对推文进行分类的一个选择是导出推文的嵌入，然后在其上运行一些分类算法。HuggingFace是一个很酷的库，可以为嵌入推文提供模型！只需要几行代码就可以派生出嵌入:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="d2f1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以我们得到了嵌入，现在可以进行分类。Scikit-learn RandomForest是这项任务的理想人选。培训脚本可能如下所示:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="076b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个设置中，使用了两个机器学习库:HuggingFace和Scikit-learn。我们现在知道我们想做什么了。让我们在SageMaker上训练和部署模型！</p><h1 id="e60b" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated"><strong class="ak">列车&amp;部署！</strong></h1><p id="e66c" class="pw-post-body-paragraph jq jr it js b jt mw jv jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn im bi translated"><strong class="js iu">准备工作</strong></p><p id="1db3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面的部分，我用的是SageMaker的Jupyter笔记本。请进行相应的设置，以确保SageMaker可以提前访问S3桶！</p><p id="e3c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，在SageMaker的Jupyter实验室中，我们需要创建一个目录，我们的培训+部署脚本就位于这个目录中。该目录可能如下所示:</p><pre class="kq kr ks kt gt nb nc nd ne aw nf bi"><span id="34b6" class="ng lz it nc b gy nh ni l nj nk">Deployment_Notebook.ipynb<br/>mysrc<br/>|--serve.py<br/>|--requirements.txt</span></pre><p id="8a53" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">总共有三个文件。在下一节中，我们将详细介绍这些文件:requirements.txt、serve.py和Deployment_Notebook.ipynb。在这里，我们将放置我们想要使用的库。在我们的例子中，它是HuggingFace和Scikit-learn。requirements.txt看起来是这样的:</p><pre class="kq kr ks kt gt nb nc nd ne aw nf bi"><span id="7e80" class="ng lz it nc b gy nh ni l nj nk">scikit-learn==0.24.1<br/>transformers==4.5.1</span></pre><p id="2914" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">训练部署脚本:serve.py </strong></p><p id="18b1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的serve.py文件有两个目的。它必须能够:(1)训练模型和(2)部署模型。因此，它应该由两部分组成:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/16f28d08b01e4691bcfdc9d9de7565ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/1*cW3-80ePxM7fx3W3yjrGKA.jpeg"/></div></figure><p id="9f6e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">先说培训部分。当我们指示SageMaker训练模型时，它将执行if _ _ name _ _ = = ' _ _ main _ _ ':in serve . py脚本中的任何后续内容。因此，我们将这篇博文的“模型训练脚本”中的脚本稍加修改:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="bce8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在数据存储在S3桶中，所以我们直接从PATH_TO_DATA文件中读取我们的训练数据(不要忘记插入您自己的路径)。另外，在SageMaker容器中有一个名为<em class="nm"> model-dir </em>的环境参数。我们应该解析它，将我们的模型存储在由该参数定义的文件夹中。</p><p id="a926" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在部署阶段，SageMaker容器希望我们在serve.py中定义四个函数:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="cac2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果没有定义这些函数，就有默认的替代函数。默认情况下，<em class="nm"> input_fn </em>期望拥有NPY格式的参数<em class="nm"> request_body </em>。在我们的例子中，我们需要将其修改为JSON，因此我们的部署脚本部分看起来应该是这样的:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="806b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在组合训练和部署部件之后，我们得到<a class="ae ko" href="https://github.com/azarnyx/CustomSagemaker/blob/master/SageMaker/mysrc/serve.py" rel="noopener ugc nofollow" target="_blank"> serve.py </a>文件。</p><p id="d6a0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">用SageMaker:Deployment _ notebook . ipynb运行测试</strong></p><p id="c4f6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">HuggingFace依赖于PyTorch python库。为了减少安装时间，我们可以选择SageMaker的PyTorch estimator。这将在预装PyTorch的容器中部署我们的脚本，因此我们不必将PyTorch添加到requirements.txt文件中。现在我们准备在SageMaker笔记本中运行脚本:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="dc58" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们应该使用Predictor类来告诉容器接受JSON格式。另外，PyTorch估计器要求指定一些参数:PyTorch的<em class="nm"> framework_version </em>和python的版本。我们用<em class="nm"> sourced_dir </em>参数告诉估算器我们想要哪个文件夹复制到容器中。此外，我们将<em class="nm">入口点</em>定义为我们上面构建的<em class="nm"> serve.py </em>脚本。在执行这些命令之后，我们将为模型做好一切准备并部署它。这可以通过以下命令来完成:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="cef9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在计算实例上剥离容器，然后部署端点，大约需要5到10分钟。完成后，我们可以用boto3测试我们的端点:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="ea4c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">训练部分应该返回两个概率。</p><h1 id="8155" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">在EC2中构建API和Flask App！</h1><p id="97a1" class="pw-post-body-paragraph jq jr it js b jt mw jv jw jx mx jz ka kb my kd ke kf mz kh ki kj na kl km kn im bi translated">接下来的步骤是创建一个API，并在EC2实例上部署Flask应用程序。如上所述，这些任务在<a class="ae ko" href="https://aws.amazon.com/blogs/machine-learning/call-an-amazon-sagemaker-model-endpoint-using-amazon-api-gateway-and-aws-lambda/" rel="noopener ugc nofollow" target="_blank"> AWS教程</a>和<a class="ae ko" href="https://medium.com/techfront/step-by-step-visual-guide-on-deploying-a-flask-application-on-aws-ec2-8e3e8b82c4f7" rel="noopener"> TECHFRONT帖子</a>中有很好的介绍。烧瓶应用程序代码和SageMaker的完整代码可以在<a class="ae ko" href="https://github.com/azarnyx/CustomSagemaker.git" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中找到。祝你快乐！</p></div></div>    
</body>
</html>