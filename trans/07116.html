<html>
<head>
<title>Take Your SQL From Good to Great: Part 4</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让您的SQL从优秀走向卓越:第4部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/take-your-sql-from-good-to-great-part-4-99a55fd0e7ff?source=collection_archive---------8-----------------------#2021-06-28">https://towardsdatascience.com/take-your-sql-from-good-to-great-part-4-99a55fd0e7ff?source=collection_archive---------8-----------------------#2021-06-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="07d9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><em class="kf">大家最喜欢的SQL作弊代码。</em></h2></div><p id="ccfc" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这是关于我最看重的SQL“技巧”的4部分系列的第4部分。</p><p id="d04b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">查看该系列中的其他内容:</p><ul class=""><li id="a9f9" class="lc ld iq ki b kj kk km kn kp le kt lf kx lg lb lh li lj lk bi translated">第一部分:<a class="ae ll" rel="noopener" target="_blank" href="/take-your-sql-from-good-to-great-part-1-3ae61539e92a">常见的餐桌用语</a></li><li id="ca6b" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb lh li lj lk bi translated">第二部分:<a class="ae ll" rel="noopener" target="_blank" href="/take-your-sql-from-good-to-great-part-2-cb03b1b7981b">关于那些日子的一切</a></li><li id="21f7" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb lh li lj lk bi translated">第三部分:<a class="ae ll" rel="noopener" target="_blank" href="/take-your-sql-from-good-to-great-part-3-687d797d1ede">其他加入</a></li><li id="1036" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb lh li lj lk bi translated">第4部分:窗口函数(你在正确的地方)</li></ul><p id="ba3e" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这是我计划的最后一部，但如果你想看更多，请在评论中给我留言！</p><p id="f796" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">但是，现在我们来看看#内容。</p><h1 id="6418" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">介绍</h1><p id="fffd" class="pw-post-body-paragraph kg kh iq ki b kj mk jr kl km ml ju ko kp mm kr ks kt mn kv kw kx mo kz la lb ij bi translated">窗口函数是SQL用户最喜欢的功能之一。它们非常强大，可以快速消除嵌套子查询和烦人的交叉连接。</p><p id="bed0" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">然而，由于它们极其冗长的实现和无用的关键字，许多人害怕深入窗口函数的水域。在深入研究我最喜欢的一些窗口函数用例之前，本文将简要介绍窗口函数的工作原理。</p><p id="6acf" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><em class="lr">本笔记中的所有示例都是使用BigQuery语法构建的，但是不同方言之间基本没有什么区别。这里</em>  <em class="lr">可以查看&amp;编辑代码全文</em> <a class="ae ll" href="https://count.co/n/lA6QPC5R0T3" rel="noopener ugc nofollow" target="_blank"> <em class="lr">。</em></a></p><h1 id="c788" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">解释的窗口功能</h1><blockquote class="mp mq mr"><p id="d0b8" class="kg kh lr ki b kj kk jr kl km kn ju ko ms kq kr ks mt ku kv kw mu ky kz la lb ij bi translated">在SQL中，<strong class="ki ir">窗口函数</strong>或<strong class="ki ir">分析函数</strong>是使用一行或多行中的值为每行返回一个值的函数— <a class="ae ll" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/analytic-function-concepts" rel="noopener ugc nofollow" target="_blank">大查询</a></p></blockquote><p id="b2cd" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">了解窗口函数的关键是它们为指定表格的每一行计算一个值<strong class="ki ir">。这与聚合函数形成对比，聚合函数将<strong class="ki ir">汇总指定<strong class="ki ir">组</strong>的</strong>值。</strong></p><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi mv"><img src="../Images/ac2fce9b36624686318649cc3acefbce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LmUnbAHlobcSJkYD_PGqzw.png"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">图片作者。</p></figure><p id="055b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">当我们看一些虚构的<a class="ae ll" href="https://www.youtube.com/watch?v=bhef_fxMQP0" rel="noopener ugc nofollow" target="_blank">隐藏神殿的传说</a>数据时，我们可以看到这出戏。为了找到每个团队的<strong class="ki ir">最佳</strong>事件，我们可以看到如何使用简单的聚合函数MAX返回每个团队的最高分，但它不会告诉我们<em class="lr">哪个</em>比赛是他们的最佳<strong class="ki ir">。</strong></p><p id="2035" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">要用聚合函数做到这一点，我们必须将初始结果返回到原始表中，以找出红色美洲虎在哪个比赛中获得了98分。有点痛苦，☠️.</p><p id="1499" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">相比之下，通过使用窗口功能，我们可以快速找到每个团队的最佳活动。让我们来分析一下它是如何工作的。</p><h1 id="09c6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">窗口函数的剖析</h1><p id="d223" class="pw-post-body-paragraph kg kh iq ki b kj mk jr kl km ml ju ko kp mm kr ks kt mn kv kw kx mo kz la lb ij bi translated">乍一看，窗口函数很复杂，但是当你分解它们时，它们比你想象的要简单得多。</p><p id="bdaf" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">要创建一个窗口函数，你必须做两件事:</p><ol class=""><li id="4c03" class="lc ld iq ki b kj kk km kn kp le kt lf kx lg lb nl li lj lk bi translated">定义返回的内容</li><li id="278a" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb nl li lj lk bi translated">定义您的窗口</li></ol><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nm"><img src="../Images/2b828d6e62e33da0794d2b9b31a1a0b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jxGSo-j6RWwewYpq7ADQhQ.png"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">图片作者。</p></figure><h2 id="9149" class="nn lt iq bd lu no np dn ly nq nr dp mc kp ns nt me kt nu nv mg kx nw nx mi ny bi translated">定义什么是返回↪</h2><p id="0450" class="pw-post-body-paragraph kg kh iq ki b kj mk jr kl km ml ju ko kp mm kr ks kt mn kv kw kx mo kz la lb ij bi translated">一般来说，窗口功能可以分为三种类型:</p><ol class=""><li id="76e7" class="lc ld iq ki b kj kk km kn kp le kt lf kx lg lb nl li lj lk bi translated"><strong class="ki ir">导航功能</strong>:返回给定特定位置标准的值(例如first_value、lag、lead)</li><li id="0d6e" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb nl li lj lk bi translated"><strong class="ki ir">编号功能</strong>:根据每行在指定窗口中的位置，给每行分配一个编号(如rank，row_number)</li><li id="a847" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb nl li lj lk bi translated"><strong class="ki ir">分析功能</strong>:对一组数值(如sum，avg，max)进行计算</li></ol><p id="5ef7" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">可用的具体函数将取决于您的数据库。使用参考资料部分中的指南来查看您的数据库中有哪些内容，或者查看我在此处构建的深入指南:</p><div class="nz oa gp gr ob oc"><a href="https://count.co/sql-resources/bigquery-standard-sql/window-functions-explained" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd ir gy z fp oh fr fs oi fu fw ip bi translated">窗口函数说明| BigQuery语法和示例|计数</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">关于SQL窗口函数你需要知道的一切。窗口函数，或称之为分析函数…</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">count.co</p></div></div><div class="ol l"><div class="om l on oo op ol oq nf oc"/></div></div></a></div><h2 id="eefe" class="nn lt iq bd lu no np dn ly nq nr dp mc kp ns nt me kt nu nv mg kx nw nx mi ny bi translated">定义您的窗口🪟</h2><p id="9abf" class="pw-post-body-paragraph kg kh iq ki b kj mk jr kl km ml ju ko kp mm kr ks kt mn kv kw kx mo kz la lb ij bi translated">在您的窗口函数中，OVER关键字之后的所有内容都代表您的窗口定义。</p><p id="7cfc" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">OVER子句具有以下组件:</p><ul class=""><li id="9c85" class="lc ld iq ki b kj kk km kn kp le kt lf kx lg lb lh li lj lk bi translated">分区依据:每个窗口由什么组成(例如，重新启动间隔…)</li><li id="cfb0" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb lh li lj lk bi translated">排序依据:如何对每个窗口的行进行排序</li><li id="938f" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb lh li lj lk bi translated">X之前和Y之后之间的行:在每个窗口中使用哪些行</li></ul><p id="d83e" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">现在我们有了基本的东西，让我们看看我们能用这些东西做什么…</p><h1 id="39e9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">窗口功能欺骗代码🕹</h1><h2 id="cbef" class="nn lt iq bd lu no np dn ly nq nr dp mc kp ns nt me kt nu nv mg kx nw nx mi ny bi translated">1.排名结果</h2><p id="39e6" class="pw-post-body-paragraph kg kh iq ki b kj mk jr kl km ml ju ko kp mm kr ks kt mn kv kw kx mo kz la lb ij bi translated">像“购买最多的5件商品是什么”这样的问题很简单，但是如果加上“按地区”这样的问题，你的查询会变得非常复杂。</p><p id="952e" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">能够根据指定的数据分组对结果进行排序，可以开启各种新的分析可能性，例如找到用户购买的第二件商品，或者比较用户第一次和第二次访问您的网站时的使用模式。</p><p id="aabb" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><strong class="ki ir">举例:</strong>如果我想找到三位流行歌手的热门曲目:Drake、T Swift和Post Malone，我可以使用<strong class="ki ir"> rank </strong>函数，按<strong class="ki ir">歌手</strong>划分，并按<strong class="ki ir">流</strong>排序，来计算每首曲目的排名。</p><p id="6191" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">然后，我们可以很容易地比较每个艺术家的前3首歌曲，并看到德雷克和波斯特马龙排名第三的歌曲仍然在泰勒最热门的歌曲中排名第一。</p><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi or"><img src="../Images/96216df77e144350f5b0bf91086f162e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tWo-bDNoBWVXEY1SMKU95w.png"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">图片作者。内置<a class="ae ll" href="https://count.co/n/lA6QPC5R0T3#qT09pVB2MZx" rel="noopener ugc nofollow" target="_blank">计数</a>。</p></figure><h2 id="1ede" class="nn lt iq bd lu no np dn ly nq nr dp mc kp ns nt me kt nu nv mg kx nw nx mi ny bi translated">2.计算两个事件之间的时间</h2><p id="d672" class="pw-post-body-paragraph kg kh iq ki b kj mk jr kl km ml ju ko kp mm kr ks kt mn kv kw kx mo kz la lb ij bi translated">数据的结构通常是每行代表一个事件。这使得查找事件之间的时间变得棘手，因为它涉及到<strong class="ki ir">查找2行之间的时间增量，而不是2列。</strong></p><p id="62a0" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">但是，这就是窗口函数的用武之地！特别是滞后和超前。</p><p id="9bd4" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><strong class="ki ir">例子</strong>:我想找出Spotify艺人在他们的第一热门歌曲之间最大的干旱。为此，我:</p><ol class=""><li id="4f9a" class="lc ld iq ki b kj kk km kn kp le kt lf kx lg lb nl li lj lk bi translated">找到每天排名第一的曲目。</li><li id="efe2" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb nl li lj lk bi translated">找到了前一天的<strong class="ki ir"/>艺术家每次都是第一，使用<strong class="ki ir">滞后</strong>。</li><li id="73ef" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb nl li lj lk bi translated">然后我发现了当天他们是第一名和最近一天他们是第一名之间的差异。</li></ol><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi os"><img src="../Images/e35d7cb18432a7fc47aac57f74b41604.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x3WY5XQIjFqCgiteFV0a-Q.png"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">图片作者。内置<a class="ae ll" href="https://count.co/n/lA6QPC5R0T3#og05HZRZtpF-7qhcs" rel="noopener ugc nofollow" target="_blank">计数</a>。</p></figure><h2 id="558f" class="nn lt iq bd lu no np dn ly nq nr dp mc kp ns nt me kt nu nv mg kx nw nx mi ny bi translated">3.“移动”计算</h2><p id="9edd" class="pw-post-body-paragraph kg kh iq ki b kj mk jr kl km ml ju ko kp mm kr ks kt mn kv kw kx mo kz la lb ij bi translated">当进行任何类型的时间序列分析时，您通常会看到在很长一段时间内发生的一系列事件。这种数据往往是“嘈杂的”，因为它充满了每天的变化，这使得很难透过树木看到森林。</p><p id="70a4" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">与移动平均值一样，移动计算是一种将时间序列数据汇总到一定水平的好方法，可以让您确定一些高层次的模式，而不会失去与底层细节的联系。</p><p id="fca5" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><strong class="ki ir">示例:</strong>在这种情况下，我想查看每日Spotify流的30天移动平均值。这将让我快速查看流是否随时间增加，以及有多少值得注意的异常值，等等。</p><figure class="mw mx my mz gt na gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi ot"><img src="../Images/22d4e38dbfa37b5939e1c82204818fb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZAWHrs2SPppRtZv6sNe1vQ.png"/></div></div><p class="nh ni gj gh gi nj nk bd b be z dk translated">图片作者。内置<a class="ae ll" href="https://count.co/n/lA6QPC5R0T3#QhYsmi4lf3H-b55id" rel="noopener ugc nofollow" target="_blank">计数</a>。</p></figure><h1 id="69b6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">车窗功能注意事项和最佳实践</h1><p id="b9c6" class="pw-post-body-paragraph kg kh iq ki b kj mk jr kl km ml ju ko kp mm kr ks kt mn kv kw kx mo kz la lb ij bi translated">⚠️窗口函数不能位于查询的WHERE或HAVING部分，因此您需要使用cte或子查询来基于窗口函数结果进行过滤。<em class="lr">参见本系列第3部分</em>  <em class="lr">中的</em> <a class="ae ll" rel="noopener" target="_blank" href="/take-your-sql-from-good-to-great-part-3-687d797d1ede"> <em class="lr">图，了解为什么不能将窗口函数添加到WHERE和HAVING查询部分。</em></a></p><p id="bdb7" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">⚠️在同一个查询中组合窗口和典型的聚合函数是非常麻烦的，如果不是完全不可能的话。如果可以的话，尽量避免。</p><p id="1f02" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">💡如果您想要“分组”窗口函数查询的结果，请使用DISTINCT。</p><p id="6497" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">⚠️总是用窗口函数检查你的结果，因为如果数据不是你所期望的那样结构化，你很可能得到错误的结果。</p><h1 id="cb3e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">参考资料:</h1><ul class=""><li id="2366" class="lc ld iq ki b kj mk km ml kp ou kt ov kx ow lb lh li lj lk bi translated">big query(<a class="ae ll" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/analytic-function-concepts" rel="noopener ugc nofollow" target="_blank">docs</a>)(<a class="ae ll" href="https://count.co/sql-resources/bigquery-standard-sql/window-functions-explained" rel="noopener ugc nofollow" target="_blank">guide</a>)中的分析函数</li><li id="7cb6" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb lh li lj lk bi translated">雪花中的窗口功能(<a class="ae ll" href="https://docs.snowflake.com/en/sql-reference/functions-analytic.html" rel="noopener ugc nofollow" target="_blank">文档</a> ) ( <a class="ae ll" href="https://count.co/sql-resources/snowflake/window-functions" rel="noopener ugc nofollow" target="_blank">向导</a>)</li><li id="5a04" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb lh li lj lk bi translated">MySQL中的窗口函数(<a class="ae ll" href="https://dev.mysql.com/doc/refman/8.0/en/window-functions.html" rel="noopener ugc nofollow" target="_blank"> docs </a>)</li><li id="a492" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb lh li lj lk bi translated">MS SQL中的窗口函数(<a class="ae ll" href="https://docs.microsoft.com/en-us/sql/t-sql/queries/select-over-clause-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank"> docs </a> ) ( <a class="ae ll" href="https://www.sqlshack.com/use-window-functions-sql-server/" rel="noopener ugc nofollow" target="_blank"> guide </a>)</li><li id="a0fc" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb lh li lj lk bi translated">PostgreSQL中的窗口函数(<a class="ae ll" href="https://www.postgresql.org/docs/9.1/tutorial-window.html" rel="noopener ugc nofollow" target="_blank"> docs </a>)</li><li id="d958" class="lc ld iq ki b kj lm km ln kp lo kt lp kx lq lb lh li lj lk bi translated">红移中的窗口函数(<a class="ae ll" href="https://docs.aws.amazon.com/redshift/latest/dg/c_Window_functions.html" rel="noopener ugc nofollow" target="_blank">文档</a>)</li></ul></div></div>    
</body>
</html>