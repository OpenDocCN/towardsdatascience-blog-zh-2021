<html>
<head>
<title>Programming with dplyr</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 dplyr 编程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/programming-with-dplyr-a8161c03d947?source=collection_archive---------37-----------------------#2021-11-08">https://towardsdatascience.com/programming-with-dplyr-a8161c03d947?source=collection_archive---------37-----------------------#2021-11-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c07c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在 1.0 版本中，你可以用新的方式编写函数</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/e4b460e5f5103fd31b7ae451f96e796c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_ZjC4SnxCeG9PTMmoHOWug.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">我们的超能力！图片作者。</p></figure><p id="fe05" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">如果你是 R 的新手，那么使用 dplyr 编程的文档是最好的参考……但是如果你不是，让我们看看如何从旧的方式升级你的编程。</p><p id="86cb" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">如果您熟悉使用<code class="fe kf kg kh ki b">sym</code>并从标准形式转换为非标准形式，下面的进度将向您展示如何替换(和扩展)您的代码。应该大多是查找-替换！如果你有一个函数，它接受一个字符向量并使用一个<code class="fe kf kg kh ki b">_at</code>动词，看看相应的旧选项(这里是带有<code class="fe kf kg kh ki b">_at</code>的选项 1)之间的区别，并看看底部的“超级版本”是如何改变的。</p><h1 id="96c3" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">老办法 1:使用<code class="fe kf kg kh ki b">*_at</code>动词</h1><p id="8cf2" class="pw-post-body-paragraph kz la iq lb b lc mo jr le lf mp ju lh li mq lk ll lm mr lo lp lq ms ls lt lu ij bi translated">这是编写 dplyr 函数的老方法:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="4dc5" class="mx lx iq ki b gy my mz l na nb">max_by_at &lt;- <strong class="ki ir">function</strong>(data, var, by="") {<br/>  data %&gt;%<br/>    group_by_at(by) %&gt;%<br/>    summarise_at(var, max, na.rm = TRUE)<br/>}</span></pre><p id="eb18" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">让我们试一试:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="b350" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_at("height", by="gender")<br/>starwars %&gt;% max_by_at(c("height", "mass"), by="gender")<br/>starwars %&gt;% max_by_at(c("height", "mass"), by=c("sex", "gender"))</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nc"><img src="../Images/4d247616a1357885a885aa964f41bac1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q-4VzOmoANZXMNJ8onuroA.png"/></div></div></figure><p id="7f3d" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">这很有效，但是对 env 变量无效:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="113c" class="mx lx iq ki b gy my mz l na nb">testthat::expect_error(starwars %&gt;% max_by_at(height, by=gender))<br/>testthat::expect_error(starwars %&gt;% max_by_at("height", by=gender))<br/>testthat::expect_error(starwars %&gt;% max_by_at(height, by="gender"))</span></pre><h1 id="98df" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">旧选项 2:使用<code class="fe kf kg kh ki b"><em class="nd">across</em></code></h1><p id="d0b9" class="pw-post-body-paragraph kz la iq lb b lc mo jr le lf mp ju lh li mq lk ll lm mr lo lp lq ms ls lt lu ij bi translated">这适用于字符和字符向量，但不适用于 env 变量。使用<code class="fe kf kg kh ki b">across</code>是使用<code class="fe kf kg kh ki b">*_at</code>的替代，它具有相同的功能:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="87bc" class="mx lx iq ki b gy my mz l na nb">max_by_across &lt;- <strong class="ki ir">function</strong>(data, var, by="") {<br/>  data %&gt;%<br/>    group_by(across(by)) %&gt;%<br/>    summarise(across(var, max, na.rm = TRUE), .groups='keep')<br/>}</span></pre><p id="d507" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">这是如何工作的:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="9066" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_across("height", by="gender")<br/>starwars %&gt;% max_by_across(c("height", "mass"), by="gender")<br/>starwars %&gt;% max_by_across(c("height", "mass"), by=c("sex", "gender"))</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ne"><img src="../Images/9828fd6a582d00de25a1c03ecc03d955.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t3uwsef31Mx1WO775QM45A.png"/></div></div></figure><p id="ff64" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">这对向量和字符串都有效(记住，R 中的所有东西实际上都是向量)。但是我们不能使用环境变量:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="d95c" class="mx lx iq ki b gy my mz l na nb">testthat::expect_error(starwars %&gt;% max_by_across(height, by=gender))<br/>testthat::expect_error(starwars %&gt;% max_by_across("height", by=gender))<br/>testthat::expect_error(starwars %&gt;% max_by_across(height, by="gender"))</span></pre><h1 id="8053" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">旧选项 3:通过<code class="fe kf kg kh ki b">sym</code>从字符转换为环境变量</h1><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="b12c" class="mx lx iq ki b gy my mz l na nb">max_by_1 &lt;- <strong class="ki ir">function</strong>(data, var, by="") {<br/>  data %&gt;%<br/>    group_by(!!sym(by)) %&gt;%<br/>    summarise(maximum = max(!!sym(var), na.rm = TRUE))<br/>}</span></pre><p id="876f" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">它不适用于传入 env 变量:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="9ee7" class="mx lx iq ki b gy my mz l na nb">testthat::expect_error(starwars %&gt;% max_by_1(height))<br/>testthat::expect_error(starwars %&gt;% max_by_1(height, by=gender))</span></pre><p id="81a3" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">它对字符串有效:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="1a5d" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_1("height")<br/>starwars %&gt;% max_by_1("height", by="gender")</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nf"><img src="../Images/b4245cff51c2c4b016831d5db992e8cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xW7rjzfFbxnTVsVzXn9F0w.png"/></div></div></figure><p id="d74b" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">但是，它对列表不起作用(所以，它没有<code class="fe kf kg kh ki b">across</code>那么通用):</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="62a3" class="mx lx iq ki b gy my mz l na nb">testthat::expect_error(starwars %&gt;% max_by_1(c("height", "weight")))<br/>testthat::expect_error(starwars %&gt;% max_by_1("height", by=c("gender", "sex")))</span></pre><h1 id="ab47" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">戴牙套更好</h1><p id="f893" class="pw-post-body-paragraph kz la iq lb b lc mo jr le lf mp ju lh li mq lk ll lm mr lo lp lq ms ls lt lu ij bi translated">看看这个改进的版本！</p><p id="9682" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">它适用于 env 变量，所以我们可以像使用非标准 eval 的 dplyr 函数一样使用它，也可以传入<code class="fe kf kg kh ki b">sym</code>变量。</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="4be2" class="mx lx iq ki b gy my mz l na nb">max_by_2 &lt;- <strong class="ki ir">function</strong>(data, var, by) {<br/>  data %&gt;%<br/>    group_by({{ by }}) %&gt;%<br/>    summarise(maximum = max({{ var }}, na.rm = TRUE))<br/>}</span></pre><p id="2f4f" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">它对 env 变量有效！</p><p id="eef4" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">这很酷:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="d5d7" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_2(height)<br/>starwars %&gt;% max_by_2(height, by=gender)</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ng"><img src="../Images/62f96c73e72d1e1653f8f1cadeed4ad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oG_YMoEHujvUEbYNhYRa_A.png"/></div></div></figure><p id="cde1" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">它不适用于现成的字符串:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="3011" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_2("height")<br/>starwars %&gt;% max_by_2("height", by="gender")</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ne"><img src="../Images/54ace60add70295f3683040d870abce0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wGjKw6ejF6Z4XBNyRIQLrg.png"/></div></div></figure><p id="d86b" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">我们可以用<code class="fe kf kg kh ki b">sym</code>来解决这个问题:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="8b0b" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_2(!!sym("height"))</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nh"><img src="../Images/fd937ae6c496a1c4c44573efc31902a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_KIx-Rf2PKybbUuR1JombQ.png"/></div></div></figure><p id="1073" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">它不适用于环境变量列表:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="3230" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_2(c(height, mass))</span><span id="73df" class="mx lx iq ki b gy ni mz l na nb">testthat::expect_error(starwars %&gt;% max_by_2(height, by=c(gender, sex)))</span></pre><h1 id="8e35" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">超级版本</h1><p id="53ab" class="pw-post-body-paragraph kz la iq lb b lc mo jr le lf mp ju lh li mq lk ll lm mr lo lp lq ms ls lt lu ij bi translated">我们将使用<code class="fe kf kg kh ki b">across()</code>来允许字符串、环境变量列表，甚至字符串列表。默认的<code class="fe kf kg kh ki b">by=()</code>变成一个空列表，我们简单地用<code class="fe kf kg kh ki b">across()</code>包装<code class="fe kf kg kh ki b">{{}}</code>:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="f2fe" class="mx lx iq ki b gy my mz l na nb">max_by_3 &lt;- <strong class="ki ir">function</strong>(data, var, by=c()) {<br/>  data %&gt;%<br/>    group_by(across({{ by }})) %&gt;%<br/>    summarise(across({{ var }}, max, .names = "max_{.col}", na.rm = TRUE), .groups='keep')<br/>}</span></pre><p id="606b" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">它适用于环境变量:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="1f13" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_3(height)<br/>starwars %&gt;% max_by_3(height, by=gender)</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nc"><img src="../Images/41a1a734f6c3dc636d8ed5ce58efeb4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vld2jaB7rSfj5OMhsirpSg.png"/></div></div></figure><p id="a472" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">它适用于字符串:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="a1a9" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_3("height")<br/>starwars %&gt;% max_by_3("height", by="gender")</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nc"><img src="../Images/0780b26e28ed806f4d570c5408b19ed7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vv9U2tXgmIFSaQFXSXFAJQ.png"/></div></div></figure><p id="d319" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">它适用于 env 变量列表:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="2419" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_3(c(height, mass))<br/>starwars %&gt;% max_by_3(height, by=c(gender, sex))<br/>starwars %&gt;% max_by_3(c(height, mass), by=c(gender, sex))</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nf"><img src="../Images/98c7c81ec0f24742dea5a5eb370b62dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*acFVWD2oeoLelbZZRHOp8Q.png"/></div></div></figure><p id="2c3e" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">它适用于字符列表:</p><pre class="kk kl km kn gt mt ki mu mv aw mw bi"><span id="c0ab" class="mx lx iq ki b gy my mz l na nb">starwars %&gt;% max_by_3(c("height", "mass"))<br/>starwars %&gt;% max_by_3("height", by=c(gender, sex))<br/>starwars %&gt;% max_by_3(c("height", "mass"), by=c("gender", "sex"))</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nj"><img src="../Images/aebe5d869cdcddeed3295749057a8f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*btnFzVwNQAqQQcbwhTmNrQ.png"/></div></div></figure><p id="2d2e" class="pw-post-body-paragraph kz la iq lb b lc ld jr le lf lg ju lh li lj lk ll lm ln lo lp lq lr ls lt lu ij bi translated">现在您已经看到了如何使用 dplyr 编程的新功能编写一些非常灵活的函数。尽情享受吧！</p></div></div>    
</body>
</html>