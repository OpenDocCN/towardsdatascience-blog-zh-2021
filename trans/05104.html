<html>
<head>
<title>Take Your SQL from Good to Great: Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让您的SQL从优秀走向卓越:第1部分</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/take-your-sql-from-good-to-great-part-1-3ae61539e92a?source=collection_archive---------3-----------------------#2021-05-05">https://towardsdatascience.com/take-your-sql-from-good-to-great-part-1-3ae61539e92a?source=collection_archive---------3-----------------------#2021-05-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4d8b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">有了cte，你可以走得更远。</h2></div><p id="48c5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上周，我看到一条<a class="ae lb" href="https://twitter.com/BecomingDataSci/status/1384571468525223942?s=20" rel="noopener ugc nofollow" target="_blank">推文</a>，这让我想到:<em class="lc">如果可能的话，有哪些SQL“窍门”我会很快回去自学？这个简单的问题很快变成了一系列文章，阐述了我最喜欢的一些方法，解释了它们为什么有用，以及如何使用它们。我选择的主题是:</em></p><p id="0e6e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第1部分:常见的表表达式</p><p id="b826" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" rel="noopener" target="_blank" href="/take-your-sql-from-good-to-great-part-2-cb03b1b7981b">第二部分:关于那些日子的一切</a></p><p id="15b2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" rel="noopener" target="_blank" href="/take-your-sql-from-good-to-great-part-3-687d797d1ede">第三部分:其他连接</a></p><p id="5fde" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" rel="noopener" target="_blank" href="/take-your-sql-from-good-to-great-part-4-99a55fd0e7ff">第4部分:窗口功能</a></p><p id="eaa5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="lc">有没有一个被低估的SQL方法对您有所帮助？给我留言吧！</em></p></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><p id="cae0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好了，接下来是第一部分:CTE！</p><h1 id="d591" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">什么是CTE？</h1><p id="74e7" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">公共表表达式(cte)是在单个查询中可用的临时表。</p><p id="56b3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它们使用以下语法:</p><pre class="mh mi mj mk gt ml mm mn mo aw mp bi"><span id="26c1" class="mq ll iq mm b gy mr ms l mt mu">WITH cte_name AS <br/>  (SELECT ... FROM ... )<br/>SELECT * FROM cte_name; </span></pre><h1 id="9e07" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">为什么它们很重要</h1><p id="52e6" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">为了说明为什么这种看似良性的查询构造如此有益，让我们看一个例子。假设我有两张桌子:</p><ol class=""><li id="5fd8" class="mv mw iq kh b ki kj kl km ko mx ks my kw mz la na nb nc nd bi translated">比赛:网球比赛统计的大文件</li><li id="c962" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated">球员:网球运动员元数据文件</li></ol><figure class="mh mi mj mk gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nj"><img src="../Images/74a6c6a458d7e5440f157785ad5c9266.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T4c6BSfu8xcEHD_Vp1EEWA.png"/></div></div><p class="nr ns gj gh gi nt nu bd b be z dk translated">网球比赛预告</p></figure><figure class="mh mi mj mk gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nv"><img src="../Images/8a3d83b9dee170ec666c2f776b0579c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PqpU_S3OY53mH44FrKsgxA.png"/></div></div><p class="nr ns gj gh gi nt nu bd b be z dk translated">网球运动员预览</p></figure><p id="dd29" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir">我想知道每位选手在获得第一个<em class="lc"/></strong><a class="ae lb" href="https://en.wikipedia.org/wiki/Grand_Slam_(tennis)" rel="noopener ugc nofollow" target="_blank"><strong class="kh ir">大满贯决赛</strong> </a> <strong class="kh ir">时的年龄。</strong></p><p id="a4ba" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要做到这一点，我需要从<strong class="kh ir"><em class="lc"/></strong>表中找到每个球员赢得大满贯的第一个<em class="lc"/>时间，然后使用<strong class="kh ir"> <em class="lc">球员</em> </strong>表将该日期与他们的生日进行比较。</p><p id="093f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">解决这个问题有很多方法，但大体上可以归结为两种方法:</p><figure class="mh mi mj mk gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nw"><img src="../Images/f348665aa98429cf1d495d427f80a6c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ubIJsMiJqZxRPEhMTKMjrw.png"/></div></div><p class="nr ns gj gh gi nt nu bd b be z dk translated">作者图片</p></figure><p id="274e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然这两种方法在长度上相似，并且应用的逻辑相同，但是CTE方法有几个明显的优势:</p><h2 id="c08a" class="mq ll iq bd lm nx ny dn lq nz oa dp lu ko ob oc lw ks od oe ly kw of og ma oh bi translated">1.比较好理解。</h2><p id="f87d" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">如果回答这个问题的第一步包括获得每个球员赢得大满贯的第一时间，那不应该是你读的第一件事吗？</p><p id="b60d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于子查询，执行的顺序几乎是不可能辨别的，因为您不得不扫描最低级别的缩进，并一步步向上，直到最后到达第一行。</p><p id="ba83" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">cte让您能够以一种简单明了的方式构建查询，这不仅有利于您编写查询，也有利于其他被迫解释查询的人。</p><h2 id="c50f" class="mq ll iq bd lm nx ny dn lq nz oa dp lu ko ob oc lw ks od oe ly kw of og ma oh bi translated">2.更快的迭代。</h2><p id="96d5" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">如果我想知道最年轻的球员进入大满贯决赛但失败了怎么办？或者是赢得任何锦标赛决赛的年龄最大的球员，而不仅仅是大满贯？</p><p id="c1e7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我可以很容易地调整我的CTE<strong class="kh ir"><em class="lc">grand _ slam _ matches</em></strong>来回答这些问题，而不必担心我是否在正确的子查询中进行了更改。</p><p id="9e76" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当我们与数据进行“对话”时，很多数据分析都涉及到对查询的快速迭代调整。当我们有复杂的查询时，这些“调整”会膨胀成痛苦的任务；cte为您提供了一个常识性的结构来快速完成这些调整。</p><h2 id="b7b4" class="mq ll iq bd lm nx ny dn lq nz oa dp lu ko ob oc lw ks od oe ly kw of og ma oh bi translated">3.可信验证</h2><p id="1cc5" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">像每个优秀的分析师一样，我会<em class="lc">总是</em>验证我的结果(😉)，而cte让这变得简单多了。因为我可以检查每个单独的CTE，所以我可以快速识别任何验证错误的来源，并对单个逻辑步骤进行故障排除，而不是处理混乱的子查询。</p><p id="6313" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我想那是40——如果你还记得分数的话，我很乐意。</p><h1 id="a33c" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">CTE加电👾</h1><p id="f13f" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">CTE在单个查询级别上的好处很多，但是如果我们能够利用CTE的好处，并将其应用于我们的整个分析，而不仅仅是一个查询，会怎么样呢？</p><p id="d6d5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">随着<a class="ae lb" href="https://count.co" rel="noopener ugc nofollow" target="_blank"> SQL笔记本</a>最近的进步，我们可以开始看到当我们将CTE构造应用到更大规模时会有什么可能。</p><p id="d204" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这些笔记本中，每个单元格代表一个CTE，每个单元格都可以被任何其他单元格引用，实际上创建了一个完整的cte连通图。</p><figure class="mh mi mj mk gt nk gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/4cf5197df2d423364f058a60bae7b0ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*7U8Nmwl9GzFfr_ljNqra1w.png"/></div><p class="nr ns gj gh gi nt nu bd b be z dk translated">我们的分析在Count.co完成</p></figure><p id="7e8a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">或者作为一个连通图:</p><figure class="mh mi mj mk gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi oj"><img src="../Images/91b5ff6cfacc77a7291bc8aa2886965b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7jgKqIc5x8Sni02ETRl_jQ.png"/></div></div><p class="nr ns gj gh gi nt nu bd b be z dk translated">我们的分析表现为一个连通图。图片作者。</p></figure><p id="feda" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这能让你做的事情令人惊讶。您仍然可以享受单个CTE的好处，例如在逻辑流中构建分析，进行快速迭代和验证检查，此外，它还允许查询和文本的参数化。</p><blockquote class="ok"><p id="a1ef" class="ol om iq bd on oo op oq or os ot la dk translated">累积的效果更像是一个应用程序，而不是一个查询。</p></blockquote><p id="d010" class="pw-post-body-paragraph kf kg iq kh b ki ou jr kk kl ov ju kn ko ow kq kr ks ox ku kv kw oy ky kz la ij bi translated">如果我们想扩展我们的分析以包括更多的查询，我们可以将更多的单元格链接在一起。如果我们想要包含全局过滤器，我们可以将它们添加到笔记本中，并像其他单元格一样将它们链接起来。</p><figure class="mh mi mj mk gt nk gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi oz"><img src="../Images/448a87ad6cac01a055b8c462e616daf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4jRac21PijEykT3-shEgvw.png"/></div></div><p class="nr ns gj gh gi nt nu bd b be z dk translated">图片作者。</p></figure><p id="a26f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在这里看到上面这张连通图的笔记本:</p><div class="pa pb gp gr pc pd"><a href="https://count.co/n/jFWwjRetKMx" rel="noopener  ugc nofollow" target="_blank"><div class="pe ab fo"><div class="pf ab pg cl cj ph"><h2 class="bd ir gy z fp pi fr fs pj fu fw ip bi translated">网球分析</h2><div class="pk l"><h3 class="bd b gy z fp pi fr fs pj fu fw dk translated">背景</h3></div><div class="pl l"><p class="bd b dl z fp pi fr fs pj fu fw dk translated">count.co</p></div></div></div></a></div><p id="c0c0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以在这里了解更多关于SQL笔记本的信息<a class="ae lb" href="https://count.co" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="0133" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">CTE最佳实践</h1><ol class=""><li id="4ddc" class="mv mw iq kh b ki mc kl md ko pm ks pn kw po la na nb nc nd bi translated">使用唯一且有意义的列名和cte名(请不要用“cte”作为…)</li><li id="d9f6" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la na nb nc nd bi translated">试着把它们变成“通用的”,这样你就可以很容易地返回并调整逻辑</li></ol><h1 id="d743" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">进一步阅读</h1><ul class=""><li id="78e1" class="mv mw iq kh b ki mc kl md ko pm ks pn kw po la pp nb nc nd bi translated">CTE文档为<a class="ae lb" href="https://www.postgresql.org/docs/9.1/queries-with.html" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>、<a class="ae lb" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax#with_clause" rel="noopener ugc nofollow" target="_blank"> BigQuery </a>、<a class="ae lb" href="https://docs.snowflake.com/en/sql-reference/constructs/with.html" rel="noopener ugc nofollow" target="_blank">雪花</a>、<a class="ae lb" href="https://docs.aws.amazon.com/redshift/latest/dg/r_WITH_clause.html" rel="noopener ugc nofollow" target="_blank">红移</a>、<a class="ae lb" href="https://dev.mysql.com/doc/refman/8.0/en/with.html" rel="noopener ugc nofollow" target="_blank"> MySQL </a></li><li id="e45c" class="mv mw iq kh b ki ne kl nf ko ng ks nh kw ni la pp nb nc nd bi translated"><a class="ae lb" rel="noopener" target="_blank" href="/using-ctes-to-improve-sql-queries-dfcb04b7edf0">如何在SQL中使用CTEs</a></li></ul><p id="4f9e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kh ir"> <em class="lc">敬请关注第2部分即将推出的内容！</em> </strong></p></div></div>    
</body>
</html>