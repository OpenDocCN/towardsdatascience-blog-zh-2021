<html>
<head>
<title>AWS Lambda integration with Snowflake</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Lambda与雪花的集成</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/aws-lambda-integration-with-snowflake-426debc9ec3a?source=collection_archive---------15-----------------------#2021-07-31">https://towardsdatascience.com/aws-lambda-integration-with-snowflake-426debc9ec3a?source=collection_archive---------15-----------------------#2021-07-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/75301a9e2cbf5c4e26c4bff07ec7814c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WvR1mrkjk98FVo39eTjv-Q.jpeg"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">图为<a class="ae jd" href="https://unsplash.com/@t_saskia?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">泰根·罗杰</a>在<a class="ae jd" href="https://unsplash.com/s/photos/snowflake?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><div class=""/><div class=""><h2 id="ed66" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">在lambda中执行python代码作为雪花中的外部函数</h2></div><p id="d73c" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最近，我和<a class="lr ls ep" href="https://medium.com/u/2b96cea834d4?source=post_page-----426debc9ec3a--------------------------------" rel="noopener" target="_blank"> Supreeth Chandrashekar </a>合作了一项任务，我们希望对存储在雪花中的一些数据进行多重推理。我们利用外部函数触发lambda，lambda反过来从AWS Sagemaker端点(服务于不同的模型)获得推断。在这篇博客中，我们将讨论如何从雪花中调用lambda。</p><h1 id="620a" class="lt lu jg bd lv lw lx ly lz ma mb mc md km me kn mf kp mg kq mh ks mi kt mj mk bi translated">解决方案概述</h1><figure class="mm mn mo mp gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ml"><img src="../Images/f9e1128cf7181f6353dca5c2e5cf1983.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YFsiRm2pbipsT14JyJroTw.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><h1 id="49ee" class="lt lu jg bd lv lw lx ly lz ma mb mc md km me kn mf kp mg kq mh ks mi kt mj mk bi translated">工艺流程</h1><ol class=""><li id="3f07" class="mq mr jg kx b ky ms lb mt le mu li mv lm mw lq mx my mz na bi translated">雪花用户承担目标帐户中的角色</li><li id="f3e8" class="mq mr jg kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">它使用角色调用API网关(API网关资源策略只允许上述角色调用POST方法)</li><li id="7b67" class="mq mr jg kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">API网关将有效负载传递给lambda</li><li id="f146" class="mq mr jg kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">Lambda处理数据并将响应返回给API Gateway</li><li id="f78d" class="mq mr jg kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">API网关向雪花发送回响应</li></ol><h1 id="a6b4" class="lt lu jg bd lv lw lx ly lz ma mb mc md km me kn mf kp mg kq mh ks mi kt mj mk bi translated">AWS设置</h1><h2 id="cef8" class="ng lu jg bd lv nh ni dn lz nj nk dp md le nl nm mf li nn no mh lm np nq mj nr bi translated">我的角色将由雪花承担</h2><p id="3249" class="pw-post-body-paragraph kv kw jg kx b ky ms kh la lb mt kk ld le ns lg lh li nt lk ll lm nu lo lp lq ij bi translated">只需创建一个没有权限的空角色。我们稍后将添加跨帐户信任。</p><h2 id="cc94" class="ng lu jg bd lv nh ni dn lz nj nk dp md le nl nm mf li nn no mh lm np nq mj nr bi translated">λ函数</h2><p id="445a" class="pw-post-body-paragraph kv kw jg kx b ky ms kh la lb mt kk ld le ns lg lh li nt lk ll lm nu lo lp lq ij bi translated">创建一个lambda函数，它将响应API网关。使用下面的代码。这里要注意的重要事情是事件结构和响应结构。</p><figure class="mm mn mo mp gt is"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="f43e" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">雪花以list的形式发送事件，list以JSON格式封装在名为<code class="fe nx ny nz oa b">data</code>的key中。它期望响应对象包含一个<code class="fe nx ny nz oa b">statusCode</code>键和一个带有JSON值的<code class="fe nx ny nz oa b">data</code>键。</p><h2 id="888c" class="ng lu jg bd lv nh ni dn lz nj nk dp md le nl nm mf li nn no mh lm np nq mj nr bi translated">API网关</h2><p id="3c98" class="pw-post-body-paragraph kv kw jg kx b ky ms kh la lb mt kk ld le ns lg lh li nt lk ll lm nu lo lp lq ij bi translated">使用具有lambda代理集成的POST方法创建API网关。使用我们在上一步中创建的Lambda ARN。在“方法请求”中添加IAM授权。</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ob"><img src="../Images/d3658fd750b6fff0fc10a0327289426a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ppZTczLU5uj3NJOJPheFuA.png"/></div></div></figure><h2 id="58ea" class="ng lu jg bd lv nh ni dn lz nj nk dp md le nl nm mf li nn no mh lm np nq mj nr bi translated">资源政策</h2><p id="4079" class="pw-post-body-paragraph kv kw jg kx b ky ms kh la lb mt kk ld le ns lg lh li nt lk ll lm nu lo lp lq ij bi translated">替换以下JSON中的相关字段后，为API添加相同的资源策略。</p><figure class="mm mn mo mp gt is"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="4042" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，在lambda控制台中，您应该观察API触发的Lambda函数。</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oc"><img src="../Images/57266495034769b56de733289cfd966d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P5woyoLri39G9pvrZx9Q6A.png"/></div></div></figure><h1 id="9372" class="lt lu jg bd lv lw lx ly lz ma mb mc md km me kn mf kp mg kq mh ks mi kt mj mk bi translated">雪花设置</h1><h2 id="a35d" class="ng lu jg bd lv nh ni dn lz nj nk dp md le nl nm mf li nn no mh lm np nq mj nr bi translated">API集成</h2><p id="0e40" class="pw-post-body-paragraph kv kw jg kx b ky ms kh la lb mt kk ld le ns lg lh li nt lk ll lm nu lo lp lq ij bi translated">我们在雪花中创建了一个API集成。该集成将创建一个用户，并允许该用户承担我们在AWS设置步骤1中创建的角色。此外，它记录了我们在API网关中创建的API的执行端点。</p><h2 id="b40e" class="ng lu jg bd lv nh ni dn lz nj nk dp md le nl nm mf li nn no mh lm np nq mj nr bi translated">外部函数</h2><p id="3ee3" class="pw-post-body-paragraph kv kw jg kx b ky ms kh la lb mt kk ld le ns lg lh li nt lk ll lm nu lo lp lq ij bi translated">我们通过使用上一步中创建的集成来创建一个外部函数。使用以下代码进行集成和外部函数创建。</p><figure class="mm mn mo mp gt is"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="1adc" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦创建了集成。描述集成。您将得到与下图类似的结果。</p><figure class="mm mn mo mp gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi od"><img src="../Images/f8e7049d9eb2c629f7773126dc7af6ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ssjDeQ1MWsrkGfn1ikyG9A.png"/></div></div><p class="iz ja gj gh gi jb jc bd b be z dk translated">作者图片</p></figure><p id="5709" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">记下<code class="fe nx ny nz oa b">describe integration</code>命令输出的<strong class="kx jh">API _ AWS _ IAM _ USER _ ARN</strong>&amp;<strong class="kx jh">API _ AWS _ EXTERNAL _ ID</strong>。在下面的策略中替换它，然后将它作为信任策略添加到开始时创建的“承担角色”中。</p><p id="7c3c" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了测试端到端功能，在雪花中运行该函数，您应该会看到lambda的响应。</p><p id="1e65" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">添加从雪花内部执行python代码的功能，提供了雪花和云系统之间更好的集成。我们可以插入这些函数，并从雪花内部触发外部流程。</p><p id="f8fb" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="oe">注意:lambda上有6MB有效载荷的限制，所以来自雪花的触发不能太大。</em></p><p id="bfa2" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">快乐融入！！</p></div></div>    
</body>
</html>