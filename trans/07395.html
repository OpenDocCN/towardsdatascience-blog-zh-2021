<html>
<head>
<title>AMLSim Fraud Detection with TigerGraph and Google Vertex Part IV: Running Online Predictions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用TigerGraph和Google Vertex检测AMLSim欺诈第四部分:运行在线预测</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-iv-running-online-predictions-b1bcc64e9576?source=collection_archive---------31-----------------------#2021-07-05">https://towardsdatascience.com/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-iv-running-online-predictions-b1bcc64e9576?source=collection_archive---------31-----------------------#2021-07-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1eb8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用我们的定制模型运行在线预测</h2></div><blockquote class="kf kg kh"><p id="6257" class="ki kj kk kl b km kn jr ko kp kq ju kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">注意:这是系列的第四篇博客。要获得数据，请阅读<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-i-preparing-the-data-2f3e6487f398">这篇博客</a>:<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-i-preparing-the-data-2f3e6487f398">https://towards data science . com/AML sim-fraud-detection-with-tiger graph-and-Google-vertex-part-I-preparing-the-data-2f3e 6487 f 398</a>。<br/>要创建使用的模型，请阅读<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-iii-preparing-your-model-for-custom-561e333e1806">本博客</a>:<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-iii-preparing-your-model-for-custom-561e333e1806">https://towards data science . com/AML sim-fraud-detection-with-tiger graph-and-Google-vertex-part-iii-preparing-your-model-for-custom-561 e333 e 1806</a>。<br/>要在谷歌的控制台中查看正在使用谷歌AutoML的数据，请阅读<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-ii-using-automl-with-tigergraph-data-65cb86fc34b3">这篇博客</a>:<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-ii-using-automl-with-tigergraph-data-65cb86fc34b3">https://towards data science . com/AML sim-fraud-detection-with-tiger graph-and-Google-vertex-part-ii-using-AutoML-with-tiger graph-data-65 CB 86 fc 34 b 3</a></p></blockquote><h1 id="6458" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">概观</h1><blockquote class="kf kg kh"><p id="877a" class="ki kj kk kl b km kn jr ko kp kq ju kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">注:这是与<a class="ly lz ep" href="https://medium.com/u/9ee92495f34e?source=post_page-----b1bcc64e9576--------------------------------" rel="noopener" target="_blank">德州陈</a>在<a class="ly lz ep" href="https://medium.com/u/571f80cc8b69?source=post_page-----b1bcc64e9576--------------------------------" rel="noopener" target="_blank"> Jon Herke </a>的帮助下共同创作的。该实验室基于谷歌的顶点人工智能在线预测笔记本。</p></blockquote><p id="901a" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">这是TigerGraph和Vertex AI系列(目前)的倒数第二篇博客，它正在探索使用带有TigerGraph和Vertex AI的图形的力量。在过去的博客中，我们使用来自TigerGraph的定制数据来创建和拟合我们的模型。现在，我们需要部署我们的模型，用它进行预测，最后进行清理。</p><p id="893d" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">第一篇博客讲述了如何创建我们的图表(设计模式、加载数据、创建和执行查询等)。).然后，在<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-ii-using-automl-with-tigergraph-data-65cb86fc34b3">的第二篇博客</a>中，我们使用谷歌的控制台对我们的数据运行AutoML。在<a class="ae lf" rel="noopener" target="_blank" href="/amlsim-fraud-detection-with-tigergraph-and-google-vertex-part-iii-preparing-your-model-for-custom-561e333e1806">的第三篇博客</a>中，与AutoML路线相反，我们使用TensorFlow准备了一个定制模型。最后，利用过去博客的数据，我们有两个选择:在线预测和批量预测。本博客将介绍运行在线预测，明天的博客将介绍批量预测。所以让我们开始吧！</p><h1 id="714b" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">第一部分:创建端点</h1><p id="f1bf" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">首先，我们需要部署我们的模型并创建一个端点。让我们从创建常数开始。这些是我们在部署模型时要传递的一些变量。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="2645" class="mr lh iq mn b gy ms mt l mu mv">DEPLOYED_NAME = "tg_custom_fraud_model_deployed-" + TIMESTAMP<br/>TRAFFIC_SPLIT = {"0": 100}<br/>MIN_NODES = 1<br/>MAX_NODES = 1</span></pre><p id="d23f" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">然后我们将部署模型。</p><blockquote class="kf kg kh"><p id="9847" class="ki kj kk kl b km kn jr ko kp kq ju kr ks kt ku kv kw kx ky kz la lb lc ld le ij bi translated">注意:传递的一些变量是在前面的博客中声明的。</p></blockquote><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="c793" class="mr lh iq mn b gy ms mt l mu mv">if DEPLOY_GPU:</span><span id="aac5" class="mr lh iq mn b gy mw mt l mu mv">   endpoint = model.deploy(<br/>      deployed_model_display_name=DEPLOYED_NAME,<br/>      traffic_split=TRAFFIC_SPLIT,<br/>      machine_type=DEPLOY_COMPUTE,<br/>      accelerator_type=DEPLOY_GPU.name,<br/>      accelerator_count=DEPLOY_NGPU,<br/>      min_replica_count=MIN_NODES,<br/>      max_replica_count=MAX_NODES,<br/>   )</span><span id="e8c9" class="mr lh iq mn b gy mw mt l mu mv">else:</span><span id="dd05" class="mr lh iq mn b gy mw mt l mu mv">   endpoint = model.deploy(<br/>      deployed_model_display_name=DEPLOYED_NAME,<br/>      traffic_split=TRAFFIC_SPLIT,<br/>      machine_type=DEPLOY_COMPUTE,<br/>      accelerator_type=None, # DEPLOY_COMPUTE.name,<br/>      accelerator_count=None, # 0,<br/>      min_replica_count=MIN_NODES,<br/>      max_replica_count=MAX_NODES,<br/>   )</span></pre><p id="e8f7" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">在我们的例子中，我们在过去的博客中将GPU设置为None，如下所示。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="f69f" class="mr lh iq mn b gy ms mt l mu mv">TRAIN_GPU, TRAIN_NGPU = (None, None)</span><span id="464f" class="mr lh iq mn b gy mw mt l mu mv">DEPLOY_GPU, DEPLOY_NGPU = (None, None)</span></pre><p id="f8ce" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">因此，上面的代码将运行else。因为我们没有使用任何加速器，所以计数和类型的值被设置为None，但是如果您确实声明了某些加速器，您可以使用注释值。</p><p id="7e2c" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">您可以在Google Vertex仪表板的“端点”选项卡中查看您部署的端点。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi mx"><img src="../Images/8346aa3073c9bfafa3e71f011fe0bfd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B2LA7lt80JANUNLxwyxdHQ.png"/></div></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">顶点人工智能控制台中的端点</p></figure><p id="006a" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">现在我们的端点已经部署好了，让我们开始使用我们的模型进行预测吧！</p><h1 id="66b4" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">第二部分:使用测试数据运行预测</h1><h2 id="3aa7" class="mr lh iq bd li nj nk dn lm nl nm dp lq ma nn no ls mb np nq lu mc nr ns lw nt bi translated">第一步:验证TG Cloud上的解决方案是否就绪</h2><p id="321f" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">现在我们准备运行预测！首先，我们需要从图表中获取测试数据。为此，请确保您在TigerGraph Cloud上的解决方案显示就绪。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/cc4375505d83c4db9eac68fda8ac8fb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*j-JakQMJ97M9XMYLHGeiKg.png"/></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">确保你的状态下有一个绿点和“准备好”字样。</p></figure><h2 id="07c4" class="mr lh iq bd li nj nk dn lm nl nm dp lq ma nn no ls mb np nq lu mc nr ns lw nt bi translated">第二步:导入库</h2><p id="d2b2" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">接下来，我们需要导入我们的库。我们将再次使用pyTigerGraph、flat-table、pandas、numpy和sklearn。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="817e" class="mr lh iq mn b gy ms mt l mu mv">import pyTigerGraph as tg<br/>import flat_table<br/>import pandas as pd<br/>import numpy as np<br/>from sklearn.model_selection import train_test_split</span></pre><h2 id="11ee" class="mr lh iq bd li nj nk dn lm nl nm dp lq ma nn no ls mb np nq lu mc nr ns lw nt bi translated">第三步:连接到图表</h2><p id="0aaf" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">然后，您需要连接到您的图表。再次用您的框中的值修改conn.TigerGraphConnection，将SUBDOMAIN更改为您的子域，将PASSWORD更改为您的密码。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="c9d0" class="mr lh iq mn b gy ms mt l mu mv">conn = tg.TigerGraphConnection(host="https://SUBDOMAIN.i.tgcloud.io", username="tigergraph", password="PASSWORD", graphname = "AMLSim")<br/>conn.apiToken = conn.getToken(conn.createSecret())</span></pre><h2 id="4d0b" class="mr lh iq bd li nj nk dn lm nl nm dp lq ma nn no ls mb np nq lu mc nr ns lw nt bi translated">第四步:运行查询并解析数据</h2><p id="9cc6" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">最后，我们将运行查询(txMultiHopLimit)并解析数据。我们将再次使用平面表来删除数据中的任何错误，并使用train_test_split将数据分为训练和测试两部分。最后一步将把X_test变成一个列表，而不是DataFrame。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="142e" class="mr lh iq mn b gy ms mt l mu mv">tx_hop = conn.runInstalledQuery("txMultiHopLimit", {}, timeout="99999999999", sizeLimit="1500000000")</span><span id="7929" class="mr lh iq mn b gy mw mt l mu mv">odf_tx_hop = pd.DataFrame(tx_hop[0]["@@txRecords"], index=None)<br/>dataset = flat_table.normalize(odf_tx_hop)</span><span id="0148" class="mr lh iq mn b gy mw mt l mu mv">features = ['tx_amount', 's_pagerank', 's_label', 's_min_send_tx', 's_min_receieve_tx', 's_max_send_tx', 's_max_recieve_tx', 's_avg_send_tx', 's_avg_recieve_tx', 's_cnt_recieve_tx', 's_cnt_send_tx', 's_timestamp', 'r_pagerank', 'r_label', 'r_min_send_tx', 'r_min_receieve_tx', 'r_max_send_tx', 'r_max_recieve_tx', 'r_avg_send_tx', 'r_avg_recieve_tx', 'r_cnt_recieve_tx', 'r_cnt_send_tx', 'r_timestamp']</span><span id="4e2d" class="mr lh iq mn b gy mw mt l mu mv">X_train, X_test, y_train, y_test = train_test_split(dataset[features], dataset["tx_fraud"], test_size=0.2, random_state=42)</span><span id="dc40" class="mr lh iq mn b gy mw mt l mu mv">X_test = list([list(i) for i in np.array(X_test)])</span></pre><h2 id="aaff" class="mr lh iq bd li nj nk dn lm nl nm dp lq ma nn no ls mb np nq lu mc nr ns lw nt bi translated">第五步:预测</h2><p id="1a21" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">到目前为止做得很好！最后，我们需要创建预测。为此，我们将运行endpoint.predict。然后我们可以将它与y_test正确答案进行比较，并最终将其打印出来。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="01a5" class="mr lh iq mn b gy ms mt l mu mv">predictions = endpoint.predict(instances=[X_test])<br/>y_predicted = np.argmax(predictions.predictions, axis=1)</span><span id="e9cf" class="mr lh iq mn b gy mw mt l mu mv">correct = sum(y_predicted == np.array(y_test))<br/>accuracy = len(y_predicted)</span><span id="2473" class="mr lh iq mn b gy mw mt l mu mv">print( f"Correct predictions = {correct}, Total predictions = {accuracy}, Accuracy = {correct/accuracy}" )</span></pre><p id="7795" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">恭喜你。如果到目前为止一切正常，那么您已经部署了您的模型，现在您可以对它进行预测了！如果你导航回谷歌顶点人工智能控制台，你现在可以看到一些图表填充了你的预测数据。</p><figure class="mi mj mk ml gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi mx"><img src="../Images/92eded82511bf7a7ef128cfbc9ea2cea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ldbFOcdTBPM7G7eM0MBYug.png"/></div></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">带预测的端点</p></figure><h1 id="60a8" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">第三部分:清理</h1><p id="f341" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">最后，为了避免来自Google Cloud的任何未来费用，让我们取消部署模型并进行清理。你可以删除整个谷歌云项目，或者按照以下步骤撤销在线预测部分。</p><p id="3545" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">首先，为了取消部署模型，我们将运行endpoint.undeploy。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="9e86" class="mr lh iq mn b gy ms mt l mu mv">deployed_model_id = endpoint.list_models()[0].id<br/>endpoint.undeploy(deployed_model_id=deployed_model_id)</span></pre><p id="04e5" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">此外，我们可以使用。delete()函数。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="fc8a" class="mr lh iq mn b gy ms mt l mu mv">job.delete()<br/>model.delete()<br/>endpoint.delete()</span></pre><p id="56f0" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">最后，如果您想删除您的存储桶，您可以运行以下命令:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="0e8c" class="mr lh iq mn b gy ms mt l mu mv">! gsutil -m rm -r $BUCKET_NAME</span></pre><p id="e4ea" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">运行完所有这些之后，所有的更改都应该被恢复。</p><h1 id="4df0" class="lg lh iq bd li lj lk ll lm ln lo lp lq jw lr jx ls jz lt ka lu kc lv kd lw lx bi translated">第四部分:祝贺+资源</h1><p id="5614" class="pw-post-body-paragraph ki kj iq kl b km md jr ko kp me ju kr ma mf ku kv mb mg ky kz mc mh lc ld le ij bi translated">干得好！本课还有最后一节是关于批量预测的！与此同时，如果您有任何问题，请直接联系TigerGraph Discord:</p><div class="nv nw gp gr nx ny"><a href="https://discord.gg/gRHWBZNpxW" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd ir gy z fp od fr fs oe fu fw ip bi translated">加入TigerGraph Discord服务器！</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">查看Discord上的TigerGraph社区-与578名其他成员一起玩，享受免费的语音和文本聊天。</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">不和谐. gg</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om nd ny"/></div></div></a></div><p id="f1b6" class="pw-post-body-paragraph ki kj iq kl b km kn jr ko kp kq ju kr ma kt ku kv mb kx ky kz mc lb lc ld le ij bi translated">感谢您阅读这篇博客，希望您继续探索TigerGraph！</p></div></div>    
</body>
</html>