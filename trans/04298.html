<html>
<head>
<title>Tutorial on displaying SHAP force plots in Python HTML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Python HTML中显示SHAP力图的教程</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/tutorial-on-displaying-shap-force-plots-in-python-html-4883aeb0ee7c?source=collection_archive---------7-----------------------#2021-04-12">https://towardsdatascience.com/tutorial-on-displaying-shap-force-plots-in-python-html-4883aeb0ee7c?source=collection_archive---------7-----------------------#2021-04-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6bbd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Flask在网络上绘制SHAP力图</h2></div><p id="688c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://github.com/yi-ye-zhi-qiu/shaphtml" rel="noopener ugc nofollow" target="_blank">这里是本教程的</a>源代码，这样你就可以跟着做了，你可以运行<code class="fe lc ld le lf b">app.py</code>来查看结果。</p><h2 id="53c5" class="lg lh iq bd li lj lk dn ll lm ln dp lo ko lp lq lr ks ls lt lu kw lv lw lx ly bi translated">这样做的动机</h2><p id="8bd4" class="pw-post-body-paragraph kf kg iq kh b ki lz jr kk kl ma ju kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">SHAP图对于模型的可解释性非常有用(见<a class="ae lb" href="https://www.youtube.com/watch?v=ngOBhhINWb8" rel="noopener ugc nofollow" target="_blank">这里</a>有一个关于它们的精彩演讲)。</p><p id="395c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">作为最近使用SHAP显示英雄联盟数据的逻辑回归项目的一部分(你可以在这里看到项目web应用<a class="ae lb" href="http://liamisaacs.com/league" rel="noopener ugc nofollow" target="_blank">和下面的截图)，我努力寻找一种在页面加载中显示SHAP图的方法，而不必先保存图像。我非常习惯于在笔记本或类似的东西上使用SHAP的绘图，但我真的想在网络应用程序上显示它。</a></p><p id="6f27" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于这对我来说是一个很大的痛点，我想巩固我所学到的东西，并在这里写下来。我将介绍我在尝试<code class="fe lc ld le lf b">base64</code>、<code class="fe lc ld le lf b">plt.savefig()</code>时遇到的一些问题，以及这些方法的问题，最后我将介绍使用HTML iFrames的解决方案。</p><p id="a8fe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了直观显示这一结果，最终结果示例是在Flask web应用程序中显示SHAP力图:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/1b7e633a5c3b130c6138a70316667dab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ISEd9xBWGqifbBZUPcbJsw.png"/></div></div><p class="mq mr gj gh gi ms mt bd b be z dk translated">将力图动态合并到用户界面中(您可以在<a class="ae lb" href="http://liamisaacs.com/league" rel="noopener ugc nofollow" target="_blank">源</a>上搜索“100 Closer”查看相同内容)</p></figure><h2 id="4d01" class="lg lh iq bd li lj lk dn ll lm ln dp lo ko lp lq lr ks ls lt lu kw lv lw lx ly bi translated">方法1: Base64编码</h2><p id="2e25" class="pw-post-body-paragraph kf kg iq kh b ki lz jr kk kl ma ju kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Base64是一种二进制到文本的编码方法。使用这个，我们可以定义我们的<code class="fe lc ld le lf b">force_plot</code>并使用<code class="fe lc ld le lf b">plt.savefig()</code>将它存储在变量<code class="fe lc ld le lf b">buf</code>中，稍后我们可以将它解码为ASCII。在我看来，理解其功能并不重要，但是<em class="mu">结果</em>是你的电脑会保存每一张单独的图片，然后以HTML格式显示出来。这意味着您的<code class="fe lc ld le lf b">img</code>标签的<code class="fe lc ld le lf b">src</code>变量将必须在本地定位每个保存的图像。</p><h2 id="28ca" class="lg lh iq bd li lj lk dn ll lm ln dp lo ko lp lq lr ks ls lt lu kw lv lw lx ly bi translated">使用XGBoost的Base64编码示例</h2><pre class="mf mg mh mi gt mv lf mw mx aw my bi"><span id="8d69" class="lg lh iq lf b gy mz na l nb nc">"""<br/>Example implementation of XGBoost algorithm and base64 approach to save the SHAP force plot and later display in HTML.</span><span id="7d51" class="lg lh iq lf b gy nd na l nb nc">If you're doing this in Flask, the ML is in app.py and you pass the SHAP force plot as a *variable* which you can index in your HTML page.</span><span id="9c2e" class="lg lh iq lf b gy nd na l nb nc">"""</span><span id="aa72" class="lg lh iq lf b gy nd na l nb nc">#Train test split</span><span id="7426" class="lg lh iq lf b gy nd na l nb nc">#Let's assume you have some X_, y_...</span><span id="a190" class="lg lh iq lf b gy nd na l nb nc">Xt, Xv, yt, yv = train_test_split(X_,y_, test_size=0.2, random_state=10)</span><span id="4de9" class="lg lh iq lf b gy nd na l nb nc">dt = xgb.DMatrix(Xt, label=yt.values, enable_categorical=True)<br/>dv = xgb.DMatrix(Xv, label=yv.values)</span><span id="4406" class="lg lh iq lf b gy nd na l nb nc">#Tuned hyperparameters via hyperopt Bayesian optimization<br/>params = {<br/>   "eta": 0.5,<br/>   "max_depth": 8,<br/>   "min_child_weight": 1,<br/>   "objective": "binary:logistic",<br/>   "verbosity": 0,<br/>   "base_score": np.mean(yt),<br/>   "eval_metric": "logloss",<br/>   "colsample_bytree": 0.7434869381604485,<br/>   'gamma': 1.1053886968419446,<br/>   'reg_alpha': 49.0,<br/>   'reg_lambda': 0.9997899615065826<br/>}</span><span id="2906" class="lg lh iq lf b gy nd na l nb nc">#Run model<br/>model = xgb.train(params, dt, 35, [(dt, "train"), (dv, "valid")], early_stopping_rounds=5, verbose_eval=35)</span><span id="9001" class="lg lh iq lf b gy nd na l nb nc">#SHAP explainer values (NumPy array)<br/>explainer = shap.TreeExplainer(model)<br/>shap_values = explainer.shap_values(Xv)</span><span id="d51e" class="lg lh iq lf b gy nd na l nb nc">#The SHAP *force* plot itself (using this method, I think you can <br/>#also do Beeswarm plots but I have not tried it)</span><span id="359b" class="lg lh iq lf b gy nd na l nb nc">shap_plot = shap.force_plot(explainer.expected_value, <br/>    shap_values[-1:], features=Xv.iloc[-1:], <br/>    feature_names=Xv.columns[0:20],<br/>    matplotlib=True, show=False, plot_cmap=['#77dd77', '#f99191'])</span><span id="f4be" class="lg lh iq lf b gy nd na l nb nc">#Encode into base64,<br/>#Answer inspiration: <a class="ae lb" href="https://stackoverflow.com/questions/60621103/is-there-a-way-to-render-shap-or-lime-output-from-flask-to-react/60669449#60669449" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/questions/60621103/is-there-a-way-to-render-shap-or-lime-output-from-flask-to-react/60669449#60669449</a></span><span id="de18" class="lg lh iq lf b gy nd na l nb nc">buf = BytesIO()<br/>plt.savefig(buf,<br/>            format = "png",<br/>            dpi = 150,<br/>            bbox_inches = 'tight')<br/>dataToTake = base64.b64encode(buf.getbuffer()).decode("ascii")<br/>return dataToTake</span><span id="4aa9" class="lg lh iq lf b gy nd na l nb nc">#Example HTML integration<br/>&lt;img class="xgboost_image" src="data:image/png;base64"&gt;</span></pre><h2 id="9ecf" class="lg lh iq bd li lj lk dn ll lm ln dp lo ko lp lq lr ks ls lt lu kw lv lw lx ly bi translated">这种方法的问题</h2><p id="631b" class="pw-post-body-paragraph kf kg iq kh b ki lz jr kk kl ma ju kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">虽然这对于单个图的生成很方便，但在生产环境中是不可行的，因为这意味着您将保存每个图。</p><h2 id="9629" class="lg lh iq bd li lj lk dn ll lm ln dp lo ko lp lq lr ks ls lt lu kw lv lw lx ly bi translated">方法2: plt.savefig()</h2><p id="4640" class="pw-post-body-paragraph kf kg iq kh b ki lz jr kk kl ma ju kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">使用<code class="fe lc ld le lf b">plt.savefig()</code>我们缩短了工作时间(Base64并不是完全必要的)，但结果是一样的，必须保存每个力图，并在我们的<code class="fe lc ld le lf b">&lt;img src="wherever_the_plot_is_locally"&gt;</code>标签中将其索引为一个文件。</p><pre class="mf mg mh mi gt mv lf mw mx aw my bi"><span id="9bfa" class="lg lh iq lf b gy mz na l nb nc">#Just using the same XGBoost model from above </span><span id="f0ec" class="lg lh iq lf b gy nd na l nb nc">def shap_plot(ind): <br/>    explainer = shap.TreeExplainer(model)<br/>    shap_values = explainer.shap_values(Xv)<br/>    p = shap.force_plot(explainer.expected_value, shap_values[ind], Xv.iloc[[ind]])<br/>    plt.savefig('temp.svg')<br/>    plt.close()<br/>    return p</span><span id="5e7f" class="lg lh iq lf b gy nd na l nb nc">shap_plot(3)</span></pre><p id="229c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">是的，更容易理解，但是在生产环境中同样不可用:您仍然保存每个图像。</p><h2 id="e1cf" class="lg lh iq bd li lj lk dn ll lm ln dp lo ko lp lq lr ks ls lt lu kw lv lw lx ly bi translated">方法3:使用。html()选项(我最终使用的)</h2><p id="5111" class="pw-post-body-paragraph kf kg iq kh b ki lz jr kk kl ma ju kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">通过这种方法，我们利用了<strong class="kh ir"> HTML iFrames </strong>，它可以将我们的SHAP <code class="fe lc ld le lf b">force_plot</code>嵌入到我们的主HTML中。</p><pre class="mf mg mh mi gt mv lf mw mx aw my bi"><span id="45c2" class="lg lh iq lf b gy mz na l nb nc">#works in Dash<br/>#taken from here: <a class="ae lb" href="https://stackoverflow.com/questions/54292226/putting-html-output-from-shap-into-the-dash-output-layout-callback" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/questions/54292226/putting-html-output-from-shap-into-the-dash-output-layout-callback</a></span><span id="5b7f" class="lg lh iq lf b gy nd na l nb nc">def _force_plot_html(*args):<br/>    force_plot = shap.force_plot(*args, matplotlib=False)<br/>    shap_html = f"&lt;head&gt;{shap.getjs()}&lt;/head&gt;&lt;body&gt;{force_plot.html()}&lt;/body&gt;"<br/>    return html.Iframe(srcDoc=shap_html,<br/>                       style={"width": "100%", "height": "200px", <br/>                       "border": 0})</span></pre><p id="f929" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这并不完全翻译成我所使用的，虽然，这是烧瓶。我把上面的想法用在一个烧瓶的环境中:</p><h2 id="a545" class="lg lh iq bd li lj lk dn ll lm ln dp lo ko lp lq lr ks ls lt lu kw lv lw lx ly bi translated">集成到Flask web应用程序的示例:</h2><p id="9de9" class="pw-post-body-paragraph kf kg iq kh b ki lz jr kk kl ma ju kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">让我们假设您有这样一个逻辑回归模型:</p><pre class="mf mg mh mi gt mv lf mw mx aw my bi"><span id="e430" class="lg lh iq lf b gy mz na l nb nc">Xt, Xv, yt, yv = train_test_split(X_, y_, test_size=0.2, random_state=10)</span><span id="2673" class="lg lh iq lf b gy nd na l nb nc">model = LogisticRegression(penalty='l2', solver='liblinear', max_iter=900, C=0.1).fit(Xt, yt)</span><span id="f0cc" class="lg lh iq lf b gy nd na l nb nc">explainer = shap.Explainer(model, Xt, feature_names=Xt.columns)<br/>shap_values = explainer(Xv)</span></pre><p id="93d5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">基本思想是在<code class="fe lc ld le lf b">app.py</code>中创建一个<code class="fe lc ld le lf b">_force_plot_html</code>函数，该函数使用<code class="fe lc ld le lf b">explainer</code>、<code class="fe lc ld le lf b">shap_values</code>和<code class="fe lc ld le lf b">ind</code>输入返回一个<code class="fe lc ld le lf b">shap_html</code> srcdoc。我们将使用<code class="fe lc ld le lf b">render_template</code>将那个<code class="fe lc ld le lf b">shap_html</code>变量传递给我们的HTML，并且在HTML文件本身中，我们将在一个嵌入式iFrame中显示<code class="fe lc ld le lf b">shap_html</code>。</p><p id="9955" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是一个我们循环遍历<code class="fe lc ld le lf b">ind</code>的例子，创建各种SHAP图，并在我们的HTML中显示为iFrames。</p><pre class="mf mg mh mi gt mv lf mw mx aw my bi"><span id="39a1" class="lg lh iq lf b gy mz na l nb nc">#in app.py</span><span id="0fba" class="lg lh iq lf b gy nd na l nb nc">from flask import *</span><span id="932f" class="lg lh iq lf b gy nd na l nb nc">import shap<br/>from shap.plots._force_matplotlib import draw_additive_plot</span><span id="8c50" class="lg lh iq lf b gy nd na l nb nc">from model import give_shap_plot</span><span id="2532" class="lg lh iq lf b gy nd na l nb nc">app = Flask(__name__)</span><span id="2cdf" class="lg lh iq lf b gy nd na l nb nc"><a class="ae lb" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/')</span><span id="d10f" class="lg lh iq lf b gy nd na l nb nc">def displayshap():</span><span id="38c4" class="lg lh iq lf b gy nd na l nb nc">    explainer, shap_values = give_shap_plot()</span><span id="7392" class="lg lh iq lf b gy nd na l nb nc">    def _force_plot_html(explainer, shap_values, ind):<br/>        force_plot = shap.plots.force(shap_values[ind], <br/>                     matplotlib=False)<br/>        shap_html = f"&lt;head&gt;{shap.getjs()}&lt;/head&gt;&lt;body&gt;{force_plot.html()}&lt;/body&gt;"<br/>        return shap_html</span><span id="ee5f" class="lg lh iq lf b gy nd na l nb nc">    shap_plots = {}</span><span id="cd26" class="lg lh iq lf b gy nd na l nb nc">    for i in range(10): #how many plots you want<br/>        ind = i<br/>        shap_plots[i] = _force_plot_html(explainer, shap_values, ind)<br/>   <br/>    return render_template('displayshap.html', shap_plots = shap_plots)</span><span id="248f" class="lg lh iq lf b gy nd na l nb nc">if __name__ == '__main__':<br/>    app.run()</span><span id="2ce8" class="lg lh iq lf b gy nd na l nb nc">#EXIT app.py<br/>###</span><span id="b077" class="lg lh iq lf b gy nd na l nb nc">&lt;!-- HTML --&gt;<br/>&lt;!-- in displayshap.html --&gt;</span><span id="dbf4" class="lg lh iq lf b gy nd na l nb nc">{% for i in shap_plots: %}<br/>    &lt;iframe srcdoc="{{shap_plots[i]}}" style={"width": "2000px"; "height": "200px"; border: none;} &gt;&lt;/iframe&gt;<br/>{% endfor %}</span></pre><p id="c807" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lc ld le lf b">shap.getjs()</code>非常重要，因为如果没有它，你的HTML就会出现“可视化被忽略，Javascript库没有被加载！问题。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi ne"><img src="../Images/e2e565dfff47b3827b9b3062cc7581ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b-zNXW82xccvIpUAEE3SZQ.png"/></div></div><p class="mq mr gj gh gi ms mt bd b be z dk translated">这篇博文的教程存储库的示例结果。运行逻辑回归的代码是从SHAP的文档“用逻辑回归进行情感分析”中借用的。你也可以得到同样的悬停效果，所有的javascript都被保留下来。</p></figure><h2 id="2956" class="lg lh iq bd li lj lk dn ll lm ln dp lo ko lp lq lr ks ls lt lu kw lv lw lx ly bi translated">缺点</h2><p id="c05b" class="pw-post-body-paragraph kf kg iq kh b ki lz jr kk kl ma ju kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">这种解决方案的一些缺点是<em class="mu">只对力图</em>有效。</p><ul class=""><li id="5e6a" class="nf ng iq kh b ki kj kl km ko nh ks ni kw nj la nk nl nm nn bi translated">我无法得到这样的蜂群/条形图:</li></ul><pre class="mf mg mh mi gt mv lf mw mx aw my bi"><span id="d6ac" class="lg lh iq lf b gy mz na l nb nc">#TYPES OF PLOTS THAT WORK: <br/>force_plot = shap.plots.force(shap_values[ind], matplotlib=False)</span><span id="fa5d" class="lg lh iq lf b gy nd na l nb nc">#TYPES OF PLOTS THAT DO NOT WORK:<br/>force_plot = shap.plots.beeswarm(shap_values)<br/>force_plot = shap.plots.bar(shap_values[ind])</span><span id="99ad" class="lg lh iq lf b gy nd na l nb nc">#I think no .html() method is written for these? I'm not quite sure</span></pre><h1 id="1940" class="no lh iq bd li np nq nr ll ns nt nu lo jw nv jx lr jz nw ka lu kc nx kd lx ny bi translated">谢谢你</h1><p id="cd6a" class="pw-post-body-paragraph kf kg iq kh b ki lz jr kk kl ma ju kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">感谢您的阅读！我希望这对任何想将SHAP集成到web应用程序中的人有所帮助。你可以在这里找到这个教程<a class="ae lb" href="https://github.com/yi-ye-zhi-qiu/shaphtml" rel="noopener ugc nofollow" target="_blank">的源代码</a>。</p><p id="ad93" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以在<a class="ae lb" href="http://liamisaacs.com/" rel="noopener ugc nofollow" target="_blank">我的网站</a>、<a class="ae lb" href="https://www.linkedin.com/in/liam-isaacs-7018b9197/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或<a class="ae lb" href="https://github.com/yi-ye-zhi-qiu" rel="noopener ugc nofollow" target="_blank"> github </a>上找到我。你可以在这里阅读更多我的文章。</p></div></div>    
</body>
</html>