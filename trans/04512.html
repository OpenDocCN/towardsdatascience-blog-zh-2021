<html>
<head>
<title>Your guide to basic SQL while learning Ethereum at the same time</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你的基本SQL指南，同时学习以太坊</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/your-guide-to-basic-sql-while-learning-ethereum-at-the-same-time-9eac17a05929?source=collection_archive---------4-----------------------#2021-04-18">https://towardsdatascience.com/your-guide-to-basic-sql-while-learning-ethereum-at-the-same-time-9eac17a05929?source=collection_archive---------4-----------------------#2021-04-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/e07893242f5bb682d2017d7f784414ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vO-uFCV6MmXmDCbHS5iO-Q.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">照片由<a class="ae jg" href="https://unsplash.com/@giabyte?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Gia Oris </a>在<a class="ae jg" href="https://unsplash.com/s/photos/start?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h2 id="8ea0" class="jh ji jj bd b dl jk jl jm jn jo jp dk jq translated" aria-label="kicker paragraph"><a class="ae ep" href="https://towardsdatascience.com/tagged/hands-on-tutorials" rel="noopener" target="_blank">实践教程</a></h2><div class=""/><div class=""><h2 id="0dc8" class="pw-subtitle-paragraph kp js jj bd b kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg dk translated">事实证明，以太坊是一个非常棒的关系数据库，可以用来学习和练习SQL查询！</h2></div><p id="2057" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><em class="md">如果你正在寻找更多的web3数据内容，请查看我的</em> <a class="ae jg" href="https://ournetwork.mirror.xyz/gP16wLY-9BA1E_ZuOSv1EUAgYGfK9mELNza8cfgMWPQ" rel="noopener ugc nofollow" target="_blank"> <em class="md"> 30天免费课程(带视频)</em> </a> <em class="md">！请务必</em> <a class="ae jg" href="https://web3datadegens.substack.com/" rel="noopener ugc nofollow" target="_blank"> <em class="md">订阅我的简讯</em> </a> <em class="md">了解更多课程和教育技巧。</em></p><h2 id="12de" class="me mf jj bd mg mh mi dn mj mk ml dp mm lq mn mo mp lu mq mr ms ly mt mu mv jp bi translated"><strong class="ak"> &gt; &gt; </strong> <a class="ae jg" href="https://web3datadegens.substack.com/p/a-basic-wizard-guide-to-dune-sql" rel="noopener ugc nofollow" target="_blank"> <strong class="ak">我在这里写了一个更最新更好的指南</strong></a><strong class="ak">&lt;&lt;</strong></h2><p id="d489" class="pw-post-body-paragraph lh li jj lj b lk mw kt lm ln mx kw lp lq my ls lt lu mz lw lx ly na ma mb mc im bi translated">当你学习如何在智能合约上存储和管理数据时，以太坊更容易理解，当你有不止两三个基本数据表要查询时，SQL更容易学习。</p><p id="9f1d" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">到本文结束时，您将了解以太坊的基础知识，以及以下SQL函数:</p><ul class=""><li id="cdd4" class="nb nc jj lj b lk ll ln lo lq nd lu ne ly nf mc ng nh ni nj bi translated">选择、位置、限制</li><li id="30e0" class="nb nc jj lj b lk nk ln nl lq nm lu nn ly no mc ng nh ni nj bi translated">总和、计数、最大值、分组依据、拥有</li><li id="6198" class="nb nc jj lj b lk nk ln nl lq nm lu nn ly no mc ng nh ni nj bi translated">不同，计数不同</li><li id="c290" class="nb nc jj lj b lk nk ln nl lq nm lu nn ly no mc ng nh ni nj bi translated">加入</li><li id="9b95" class="nb nc jj lj b lk nk ln nl lq nm lu nn ly no mc ng nh ni nj bi translated">时间转换/解析(日期TRUNC，时间间隔)</li><li id="7827" class="nb nc jj lj b lk nk ln nl lq nm lu nn ly no mc ng nh ni nj bi translated">联合和联合所有</li></ul><p id="7322" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我还将做一个中级和高级SQL/以太坊指南，所以如果你有兴趣阅读的话，一定要跟着我。在<a class="ae jg" href="https://duneanalytics.com/hagaetc/example-dashboard" rel="noopener ugc nofollow" target="_blank"> Dune Analytics </a>上会有所有这些查询的链接，所以你可以随时编辑和运行它们。</p><h2 id="0d9b" class="me mf jj bd mg mh mi dn mj mk ml dp mm lq mn mo mp lu mq mr ms ly mt mu mv jp bi translated">什么是关系数据库？</h2><p id="cdb5" class="pw-post-body-paragraph lh li jj lj b lk mw kt lm ln mx kw lp lq my ls lt lu mz lw lx ly na ma mb mc im bi translated">如果您没有关系数据库的一般背景，让我们来分析一下它们是什么。关系数据库包含一组数据表，因此用户可以查询一些表的组合，只获得他们需要的数据(行)的子集。这通常比尝试将所有数据存储在一个文档中，然后在每次执行某个操作(无论是运行模型还是创建数据可视化)时读取整个数据集更有效。</p><p id="674e" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">表格可以被认为是CSV文件。每个表都有一个列键，每个列都有一个特定的数据类型(string、integer、boolean、JSON是一些常见的例子)。每个表必须包含一个<strong class="lj jt">主键</strong>，用于确保特定列中的数据是唯一的(因此，如果您存储事务，那么该表中的每一行都有一个唯一的事务id)。表还可能包含一个<strong class="lj jt">外键</strong>，它是关系数据库表中的一列或一组列，提供两个表中数据之间的链接。常见的外键包括从日期和时间到客户id或地理点的任何内容。</p><p id="1492" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">下面是一个关系数据库的例子，其中显示的字段是列键。PK是主键，FK是外键。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div class="gh gi np"><img src="../Images/869fec1ad408c63c0ff35f6c57950b1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/0*G2IHSoKltVQryGJM.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">关系数据库的例子(<a class="ae jg" href="https://upload.wikimedia.org/wikipedia/commons/c/c0/Planet-express-db.png" rel="noopener ugc nofollow" target="_blank"> CC许可</a>)</p></figure><p id="cf75" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">SQL允许我们查询这些数据库——就这么简单！SQL有各种版本，但略有不同，对于本文，我们将使用PostgreSQL。</p><h2 id="a7e7" class="me mf jj bd mg mh mi dn mj mk ml dp mm lq mn mo mp lu mq mr ms ly mt mu mv jp bi translated">以太坊上的数据表是什么？</h2><p id="8497" class="pw-post-body-paragraph lh li jj lj b lk mw kt lm ln mx kw lp lq my ls lt lu mz lw lx ly na ma mb mc im bi translated">现在对于以太坊来说，你需要知道的是，有接近无限数量的钱包可以容纳这个名为ETH的令牌，而ETH经常充当你在区块链上进行交易时必须支付的汽油。也有智能合约，其行为类似于钱包，但可以同时进行一系列复杂的交易，但在这一点上不要太担心智能合约是什么<strong class="lj jt">只需将它们想象为绑定了API函数的数据库表</strong>。一旦你学会了如何浏览存储在合同上的数据，那么理解功能和语言就变得容易多了。</p><p id="27ec" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">假设您已经创建了一个新的智能合约(即数据库表)，并且想要发行一种名为USDC的新货币。这种智能合约将跟踪您发行的USDC总量、每个人钱包中的USDC余额以及所有使用USDC的钱包之间的历史支付(交易作为数据库表行)。</p><p id="788c" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">ETH的价值就像实体经济中的天然气/石油一样，是不稳定的，很大程度上取决于供求关系。您可能想要一个更稳定的令牌(如Dai)发送给其他方进行支付，但也不想失去ETH的任何上升潜力。要做到这一点，可以创建另一个智能合约，允许您存储ETH作为抵押，以向Dai借款。如果汽油的类比没有意义，那就把它想象成从你房子的价值中借美元(或你的当地货币)。</p><p id="a9ad" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这种借贷方式是以太坊上最大的产品类型之一，其中<a class="ae jg" href="https://aave.com/" rel="noopener ugc nofollow" target="_blank"> Aave </a>、<a class="ae jg" href="https://compound.finance/" rel="noopener ugc nofollow" target="_blank"> Compound </a>和<a class="ae jg" href="https://makerdao.com/en/" rel="noopener ugc nofollow" target="_blank"> Maker </a>是一些主要的合同提供商。在本文的其余部分，<strong class="lj jt">我们将探索这些抵押债务头寸(CDP，或有时称为保险库)的属性，通过使用SQL查询来了解它们是如何工作的。</strong></p><blockquote class="nu nv nw"><p id="bc81" class="lh li md lj b lk ll kt lm ln lo kw lp nx lr ls lt ny lv lw lx nz lz ma mb mc im bi translated">请记住，以太坊是<strong class="lj jt">数据库</strong>，智能合约是<strong class="lj jt">数据表</strong>，来自钱包的交易是<strong class="lj jt">每个表中的行</strong>。</p></blockquote><h2 id="dda3" class="me mf jj bd mg mh mi dn mj mk ml dp mm lq mn mo mp lu mq mr ms ly mt mu mv jp bi translated">选择、位置和限制</h2><p id="2090" class="pw-post-body-paragraph lh li jj lj b lk mw kt lm ln mx kw lp lq my ls lt lu mz lw lx ly na ma mb mc im bi translated">智能合约通常在调用事务时发出函数调用和事件(日志)。作为契约的子集，每个函数和事件都是我们可以查询的表。</p><p id="c5fa" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们可以使用Etherscan来探索合同的功能，在本例中，是<a class="ae jg" href="https://etherscan.io/address/0x398ec7346dcd622edc5ae82352f02be94c62d119#writeProxyContract" rel="noopener ugc nofollow" target="_blank"> Aave lending pool合同</a>。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oa"><img src="../Images/0033decf4f0bffbe0200d91fd0ce6715.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xj3qYqgerU4x6g6H-a4tBw.png"/></div></div></figure><p id="b95e" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在你借钱之前，你必须先存入抵押品。我们可以运行第一个查询来查看最近的100笔存款交易，方法是从Aave lending pool存款数据表中选择所有列(<code class="fe ob oc od oe b">SELECT * FROM</code>)并用(<code class="fe ob oc od oe b">LIMIT 100</code>)限制返回的行</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div class="gh gi of"><img src="../Images/2339073cf1c8ffdb38fed222d3551493.png" data-original-src="https://miro.medium.com/v2/resize:fit:780/format:webp/1*rBoHN6d0QhCvvCZGPpEdHg.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://duneanalytics.com/queries/34562" rel="noopener ugc nofollow" target="_blank">https://duneanalytics.com/queries/34562</a></p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi og"><img src="../Images/0ef7cb7af246bd9035e360fcd1fa572d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YASleqrbfSaZqaVnL5O8OA.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">返回的前几行，列被截断</p></figure><p id="7fea" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">让我们分解查询返回的键列:</p><p id="4e07" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><code class="fe ob oc od oe b"><strong class="lj jt">_user</strong></code>:发起存款的钱包地址</p><p id="0c07" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><code class="fe ob oc od oe b"><strong class="lj jt">_reserve</strong></code>:作为抵押品存放的代币的地址</p><p id="7409" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><code class="fe ob oc od oe b"><strong class="lj jt">_amount</strong></code>:代币金额</p><p id="ebbb" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><code class="fe ob oc od oe b"><strong class="lj jt">_timestamp</strong></code>:交易被挖掘到区块链的时间戳</p><p id="0ea1" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这是介绍地址的好时机。地址要么属于钱包，要么属于智能合约，在以太坊上总是唯一的。</p><p id="1dd6" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">让我们再次运行我们的查询，但是现在使用了一个<code class="fe ob oc od oe b">WHERE</code>语句来只过滤ETH储备(ETH是特殊的，因为它没有智能合同，因为它在更深的层被跟踪，所以Dune使用<code class="fe ob oc od oe b">\xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee</code>作为地址。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/ed20fb0177ef7ade579cc567ebc2e90b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*P_6llK48Cxqv6cmkHHwXWw.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://duneanalytics.com/queries/34609" rel="noopener ugc nofollow" target="_blank">https://duneanalytics.com/queries/34609</a></p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oi"><img src="../Images/168ef3942816c03fb3abe019d9a99a42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nPHUMCVtFQy1PeBaM9TgJw.png"/></div></div></figure><p id="3ccc" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><code class="fe ob oc od oe b">WHERE</code>作为一个过滤器，意味着只有满足您设置的条件的行将被保留在返回的数据中。上图中，你可以看到<code class="fe ob oc od oe b">_reserve</code>列中的所有地址现在都代表ETH。</p><p id="2267" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">前面我提到有一个智能契约跟踪我们的USDC，该契约可以在地址<a class="ae jg" href="https://etherscan.io/address/0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48" rel="noopener ugc nofollow" target="_blank">0xa 0b 86991 c 6218 b 36 C1 d 19d 4 a 2e e9 EB 0 ce 3606 EB 48</a>找到。让我们再次运行上面的查询，但是是在lending pool borrow数据表上，过滤USDC。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/9297a34215bf5976decb8934de393fa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/format:webp/1*Ipl-55UHDK2J43NuRFPWvA.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://duneanalytics.com/queries/34613" rel="noopener ugc nofollow" target="_blank">https://duneanalytics.com/queries/34613</a></p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ok"><img src="../Images/3f8e9e830fc21af3b515070cefbb821f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YfslZi1zVQN46k85LS2rbw.png"/></div></div></figure><p id="4f2e" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这里，我们对一组指定的列而不是所有的列运行了<code class="fe ob oc od oe b">SELECT</code>,正如您所看到的，这些正是返回的列。</p><h2 id="81e4" class="me mf jj bd mg mh mi dn mj mk ml dp mm lq mn mo mp lu mq mr ms ly mt mu mv jp bi translated">计数、总和、最大值、分组依据、拥有、排序依据</h2><p id="5842" class="pw-post-body-paragraph lh li jj lj b lk mw kt lm ln mx kw lp lq my ls lt lu mz lw lx ly na ma mb mc im bi translated">既然我们已经知道了如何从表中选择列并根据某些条件进行过滤，我们将希望开始使用聚合函数来提供更多信息。</p><p id="2ef1" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">像<code class="fe ob oc od oe b">COUNT</code>、<code class="fe ob oc od oe b">SUM</code>和<code class="fe ob oc od oe b">MAX</code>这样的聚合器会绕过您想要执行算术运算的列。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/574520778ab99aa42ec16a92e3386992.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/format:webp/1*IiFnG51F2v352h4xTE7t5A.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">【https://duneanalytics.com/queries/34615】</p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi om"><img src="../Images/52a366f41bfd46c764e127110995119b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R1GvSVA0Ry7T59r4S_31lA.png"/></div></div></figure><p id="437e" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><code class="fe ob oc od oe b">sum</code>列给出了USDC所有历史借款的总和<code class="fe ob oc od oe b">_amount</code>(因为这被USDC过滤掉了<code class="fe ob oc od oe b">_reserve</code>)。<code class="fe ob oc od oe b">count</code>列将给出该列中的行数。</p><p id="1a14" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们返回的表中的这些名称信息不多，所以接下来我们将使用<code class="fe ob oc od oe b">as</code>重命名这些列。</p><p id="a72b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如果你以前在excel中使用过数据透视表，那么<code class="fe ob oc od oe b">GROUP BY</code>就不会太难理解。如果没有，可以把它想象成对作为透视依据的列中的每个唯一id运行select查询。我们用<code class="fe ob oc od oe b">_borrowRateMode</code>，浮动利率贷款用<code class="fe ob oc od oe b">1</code>，固定利率贷款用<code class="fe ob oc od oe b">2</code>。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div class="gh gi on"><img src="../Images/b4c50993240a74dc23b0888aad3d840d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DZFBFMF289h9FqcvWnpgtw.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://duneanalytics.com/queries/34617" rel="noopener ugc nofollow" target="_blank">https://duneanalytics.com/queries/34617</a></p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oo"><img src="../Images/5bc03aa89265642cb556a334e9325118.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ht_aXFHP13EhXyTmLO5aog.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">注意，我们将“sum”重命名为“usdc_total ”,这改变了我们返回的表中的列名</p></figure><p id="c12c" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">从这一点上，我们可以看到，似乎没有压倒性的偏好固定或浮动利率贷款。注意，我使用了<code class="fe ob oc od oe b">GROUP BY 1</code>，它将基于我们的<code class="fe ob oc od oe b">SELECT</code>查询中的第一个词。如果我放入<code class="fe ob oc od oe b">GROUP BY 2</code>,那么它会试图通过求和来透视它，这会返回一个错误，因为你不能通过聚合函数来透视。</p><p id="8a79" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们现在可以引入第二个过滤函数<code class="fe ob oc od oe b">HAVING</code>。记住<code class="fe ob oc od oe b">GROUP BY</code>在<code class="fe ob oc od oe b">WHERE</code>已经运行之后运行，所以如果我们想要过滤透视表，那么我们就不能再使用<code class="fe ob oc od oe b">WHERE</code>。让我们透视用户借的USDC总额，其中用户必须有大于1，000，000的借款。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div class="gh gi op"><img src="../Images/aa327d6a4f4daf5db64a14f22ac4ca7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*pGdrxO-6Km_Vy4ZB1Sh3tw.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://duneanalytics.com/queries/34621" rel="noopener ugc nofollow" target="_blank">https://duneanalytics.com/queries/34621</a></p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oq"><img src="../Images/8353a8b2b94ed5c7b5fd466dc275e2f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dsbA4qlZxqIdjcb2DIE4eg.png"/></div></div></figure><p id="9620" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">让我们对这个查询做一个小小的调整，我们希望按照usdc_total从大到小对表进行排序。为此，我们在查询的末尾添加了<code class="fe ob oc od oe b">ORDER BY</code>，并指定了一个列和<code class="fe ob oc od oe b">DESC</code>。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div class="gh gi or"><img src="../Images/93a7e2392c5c4839118bf99aed45acc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*Zokbj6ZpFlmGsMtj0-OGsg.png"/></div><p class="jc jd gj gh gi je jf bd b be z dk translated">与上面相同的查询链接</p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi os"><img src="../Images/9e68c997a95ff050f49e1d3a39fc8e25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rtSNaSEVgm4ioiemUNjMOQ.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">看起来有人借了超过231万亿USDC！注意，这不是一笔未偿还的借款，所以已经偿还了很多次。</p></figure><h2 id="6213" class="me mf jj bd mg mh mi dn mj mk ml dp mm lq mn mo mp lu mq mr ms ly mt mu mv jp bi translated">不同，计数不同</h2><p id="323a" class="pw-post-body-paragraph lh li jj lj b lk mw kt lm ln mx kw lp lq my ls lt lu mz lw lx ly na ma mb mc im bi translated">根据上一次查询中的行数(3，721)，我们已经可以看到在Aave上为USDC调用borrow函数的用户的唯一数量，但是我们也可以使用<code class="fe ob oc od oe b">DISTINCT</code>函数在不进行旋转的情况下完成这项工作。<code class="fe ob oc od oe b">COUNT DISTINCT</code>是一个组合，我们可以用它来计算不同事件的数量。当我们想要计算某一列相对于另一列的唯一值时，这很有用。值得注意的是，如果您正在寻找一些特殊的组合，您可以在<code class="fe ob oc od oe b">DISTINCT</code>中放置多个列名。假设我们想要查看每个用户从Aave借用了多少种不同类型的令牌:</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ot"><img src="../Images/6eb53ab1842146cfbf371fb7e61121b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s9wnUkdSJmyK9Q-6GW8apg.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://duneanalytics.com/queries/34625" rel="noopener ugc nofollow" target="_blank">https://duneanalytics.com/queries/34625</a></p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ou"><img src="../Images/a68652774ec797ff4ac365dc316fb78f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I7oygIbpR6I-VrCiRMpaXw.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">总的来说，Aave有10，320个不同的用户借用了某种令牌，其中一个人最多借用了17个不同的令牌(如USDC)。</p></figure><h2 id="c24b" class="me mf jj bd mg mh mi dn mj mk ml dp mm lq mn mo mp lu mq mr ms ly mt mu mv jp bi translated">外部(如左)和内部连接</h2><p id="5246" class="pw-post-body-paragraph lh li jj lj b lk mw kt lm ln mx kw lp lq my ls lt lu mz lw lx ly na ma mb mc im bi translated">到目前为止，我们只是一次在一个表上运行查询——连接是SQL的一个重要部分，因为它被称为关系数据库是有原因的(还记得开头提到的那些外键吗？).您可以指定七种类型的连接，如下所示:</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ov"><img src="../Images/f2c72176625417da54425b091e18deb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cMd2TQSzYfTHueV-.jpg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://live.staticflickr.com/8346/8190148857_78d0f88cef_b.jpg" rel="noopener ugc nofollow" target="_blank">CC许可下的图像</a></p></figure><p id="cd33" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这是将我们的lending pool存款数据表带回到我们的查询中的好时机。让我们使用用户地址的内部连接来连接存款和借款，然后过滤ETH存款和USDC借款的储备对。</p><p id="a6d5" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们不能在原始的Aave借和存表上直接这样做，因为我们没有一组外键。取而代之的是，我们将进行子查询，在子查询中，我们将获得独立用户的枢轴以及从USDC借入或存入ETH的总金额。然后我们可以在users列上做一个内部连接。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ow"><img src="../Images/4cc0bc3b306ae05bfb3bb3161ba2024e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Y8VfJQzHdvC2LjfqhpM3A.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://duneanalytics.com/queries/34628" rel="noopener ugc nofollow" target="_blank">https://duneanalytics.com/queries/34628</a></p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ox"><img src="../Images/f4180e4b7888b60fd2223d4ea109d3b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nqa888RiXC8qeQn9sVWxWA.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">ETH目前的价格是2400美元……所以已经存了很多ETH了！同样，这没有考虑还款或提款，所以这不是一个未偿金额。</p></figure><p id="0374" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们的查询现在已经变得很长了，所以让我们逐个函数地分析一下。</p><pre class="nq nr ns nt gt oy oe oz pa aw pb bi"><span id="eebd" class="me mf jj oe b gy pc pd l pe pf">(SELECT "_user", SUM(_amount) as USDC_total_borrowed FROM aave."LendingPool_evt_Borrow"<br/>WHERE _reserve = '\xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48'<br/>GROUP BY 1) as borrow</span></pre><p id="f02b" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">在这里，我们创建了一个子查询，它从前面的<a class="ae jg" href="https://duneanalytics.com/queries/34621" rel="noopener ugc nofollow" target="_blank">返回相同的表</a>(没有<code class="fe ob oc od oe b">HAVING</code>)，然后将该表重命名为“borrow”。我们对“存款”也重复这一点。现在我们有了两个有外键的表(_users)，我们可以做一个<code class="fe ob oc od oe b">INNER JOIN</code>来在每个表的外键列<code class="fe ob oc od oe b">ON deposit.”_user”=borrow.”_user”</code>中只保留既存了ETH又借了USDC的用户。最后是选择部分，在这里我们使用点连接符<code class="fe ob oc od oe b">SELECT borrow.”_user”, borrow.USDC_total_borrowed, deposit.ETH_total_deposited</code>指定我们想要的表和列的组合。为了让这在将来更具可读性，我们可以使用常见的表表达式(<a class="ae jg" href="https://docs.microsoft.com/en-us/sql/t-sql/queries/with-common-table-expression-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank"> CTE </a>)，但是我将在下一篇文章中介绍这一点。</p><h2 id="4c24" class="me mf jj bd mg mh mi dn mj mk ml dp mm lq mn mo mp lu mq mr ms ly mt mu mv jp bi translated">时间转换</h2><p id="b8aa" class="pw-post-body-paragraph lh li jj lj b lk mw kt lm ln mx kw lp lq my ls lt lu mz lw lx ly na ma mb mc im bi translated">Postgres有一个可爱的名为<code class="fe ob oc od oe b">date_trunc</code>的日期解析函数和时间管理器<code class="fe ob oc od oe b">interval</code>，这使得处理时间戳数据变得轻而易举。假设我们想看看在过去的7天里USDC每天被借走了多少:</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi pg"><img src="../Images/3f8c1e9090586a1035588b83b3d40e88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YrLT1udHPPZ2lbBdfRo9XQ.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://duneanalytics.com/queries/34631" rel="noopener ugc nofollow" target="_blank">https://duneanalytics.com/queries/34631</a></p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ph"><img src="../Images/c315d7b0c4e942e97f9523ae43c82d9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pHRmMK3T_KcMxEPuxjqCVQ.png"/></div></div></figure><p id="154a" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated"><code class="fe ob oc od oe b">date_trunc(‘day’, evt_block_time)</code>获取evt_block_time列并解析它，以便给定一天中的所有时间戳都设置为该日期的午夜。我们也可以这样做几分钟、几周、几个月或几年。</p><p id="e335" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我们添加了<code class="fe ob oc od oe b">borrow.evt_block_time &gt; now() — interval ‘7 days’</code>作为另一个<code class="fe ob oc od oe b">WHERE</code>条件，只保留在查询运行(<code class="fe ob oc od oe b">now()</code>)的一周内具有<code class="fe ob oc od oe b">evt_block_time</code>的行。</p><p id="33a4" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如果您以前没有使用过DateTime对象，请相信我的话，这两个函数(<code class="fe ob oc od oe b">date_trunc</code>和<code class="fe ob oc od oe b">interval</code>)为您节省了大量工作。</p><h2 id="0031" class="me mf jj bd mg mh mi dn mj mk ml dp mm lq mn mo mp lu mq mr ms ly mt mu mv jp bi translated">联合和联合所有</h2><p id="3ba2" class="pw-post-body-paragraph lh li jj lj b lk mw kt lm ln mx kw lp lq my ls lt lu mz lw lx ly na ma mb mc im bi translated">这是最后一部分，希望这是一个容易理解的部分。联接按列工作，而联合是当我们想按行组合两个查询或表时。关键是使用<code class="fe ob oc od oe b">UNION</code>删除完全相同的行，而<code class="fe ob oc od oe b">UNION ALL</code>没有。</p><p id="1d6a" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">Aave只是一个lending pool/CDP协议，所以让我们也将它与Compound进行比较。我们将获取每个协议的唯一用户和他们的总USDC借款，并获取联合。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi pi"><img src="../Images/adbde815aaa039f6391299f27e37d85f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bA635zk8Ly-ly78F-zrdLA.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated"><a class="ae jg" href="https://duneanalytics.com/queries/34635" rel="noopener ugc nofollow" target="_blank">https://duneanalytics.com/queries/34635</a></p></figure><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi pj"><img src="../Images/02b6c1b41ba3ef04d89ed1abe43fa996.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RjOJ0fysyGKPjSBeU4XBQw.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">你可以在这里看到，前13名USDC借款人中只有一人使用Aave——这可能有很多原因，包括他们的抵押品在哪里和借款利率。</p></figure><p id="8cf2" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我通过唯一用户和他们的总USDC借款进行旋转查询，然后在查询之间使用<code class="fe ob oc od oe b">UNION ALL</code>，最后通过<code class="fe ob oc od oe b">usdc_borrow</code>对组合表进行排序。另外，请注意，我创建了一个名为<code class="fe ob oc od oe b">lending_pool</code>的新列，在每个子查询中使用默认值<code class="fe ob oc od oe b">aave</code>和<code class="fe ob oc od oe b">comp</code>。</p><h1 id="fb37" class="pk mf jj bd mg pl pm pn mj po pp pq mm ky pr kz mp lb ps lc ms le pt lf mv pu bi translated">你成功了！🎉</h1><p id="7312" class="pw-post-body-paragraph lh li jj lj b lk mw kt lm ln mx kw lp lq my ls lt lu mz lw lx ly na ma mb mc im bi translated">如果你做到了这一步，那么恭喜你！您已经掌握了使用SQL进行基本数据探索和分析的足够知识。如果你想进一步了解以太坊，请查看我的另一篇文章，这篇文章深入探讨了以太坊的工作原理。</p><p id="8318" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如果您还没有点击任何查询链接，我强烈建议您这样做，因为Dune Analytics是一个测试查询和快速创建可视化甚至仪表板的好地方。当我开始学习SQL时，我希望有一个这样的工具来练习，而不是依赖hackerank或leetcode中的表(或者摆弄本地服务器，用网上的基本模拟数据表填充它)。</p><p id="9cb2" class="pw-post-body-paragraph lh li jj lj b lk ll kt lm ln lo kw lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">再次提醒，请关注本系列的下两部分！</p></div></div>    
</body>
</html>