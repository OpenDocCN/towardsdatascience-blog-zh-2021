<html>
<head>
<title>Azure Synapse Analytics &amp; Power BI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Synapse分析和Power BI</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/azure-synpase-analytics-power-bi-f6ded6f96d5f?source=collection_archive---------16-----------------------#2021-05-11">https://towardsdatascience.com/azure-synpase-analytics-power-bi-f6ded6f96d5f?source=collection_archive---------16-----------------------#2021-05-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5b45" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用无服务器SQL池轻松高效地刷新Power BI数据集</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/289df7a7e84a39b7dddd1b36c111581c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8nYAPPJ4ZcLjpoAY"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://www.pexels.com/photo/adventure-air-aircraft-balloon-210012/" rel="noopener ugc nofollow" target="_blank">https://www . pexels . com/photo/adventure-air-aircraft-balloon-210012/</a></p></figure><p id="946a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">引用微软的Synapse产品页面</p><blockquote class="ls lt lu"><p id="21d1" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">Azure Synapse Analytics是一项无限的分析服务，它将数据集成、企业数据仓库和大数据分析结合在一起。它让你可以自由地使用无服务器或专用资源来查询数据。</p></blockquote><p id="53ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我非常同意与自由有关的那一点。Synapse拥有您针对不同工作负载或需求所需的所有工具。如果您需要一个普通的数据仓库，那么使用专用的或无服务器的SQL池。如果你想要Spark，那么Spark pools可以提供友好的笔记本体验，如Databricks(缺点是最新的Spark版本还没有出现)。Data factory还与Synapse workspace集成在一起，因此无需在不同的工具之间来回切换。如果您想要对代码制品和CI/CD过程有更多的控制，那么源代码控制也包含在同一个配方中。</p><p id="0da4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，如果不首先进行测试，就无法评估某个工具或应用程序的有用性。</p><h2 id="9f5e" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">要解决的问题</h2><p id="259e" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">我想解决的问题是提高Power BI数据集刷新速度，并简化一些用于提取所需数据的M查询。源数据是Azure Data Lake Gen2上托管的一组parquet文件。Power BI提供了一个M函数来解析拼花数据，就像所有用于读取CSV、Excel等的经典连接器一样。不幸的是，这种方法的总体体验并不理想。对于重要的数据加载，数据集刷新通常很慢，因为解析是使用Power BI premium capacity完成的，这不是从parquet文件加载/过滤大量数据的最佳工具。此外，用于提取数据的M查询有点复杂，更重要的是不容易阅读。</p><h2 id="8f5d" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">潜在解决方案</h2><p id="8e70" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">Azure Synapse无服务器SQL池可以在包含CSV或Parquet文件的数据湖文件夹上定义外部表或视图。一旦定义了这些表或视图，我们就可以用SQL数据库连接器切换Power BI中的parquet连接器，并尝试创建使用查询折叠的加载查询。因此，使用M完成的任何过滤器或投影都将被翻译成普通的T-SQL语句，这些语句将由Synapse本身执行，而不是Power BI。如果Synapse足够聪明，能够像Spark一样进行分区修剪或谓词下推，那么这将是一个巨大的胜利。数据集刷新有望更快，产生的成本也将最小。顺便说一下，无服务器SQL池的定价取决于为查询服务而读取的数据的大小。</p><p id="b105" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们来制作一些Power BI数据集。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/82866b277d6566cd82b0748df2772404.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*W8XJqTdIqP3l1bXn"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://www.pexels.com/photo/cooked-food-on-black-plate-5949889/" rel="noopener ugc nofollow" target="_blank">https://www . pexels . com/photo/cooked-food-on-black-plate-5949889/</a></p></figure></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><h2 id="88b1" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">环境设置</h2><p id="aff6" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">需要synapse analytics工作区。它带有一个内置的无服务器SQL池，您可以选择连接到一个现有的数据湖或创建一个新的与工作区相关联的数据湖。我将使用<a class="ae kv" href="https://azure.microsoft.com/en-au/services/open-datasets/catalog/nyc-taxi-limousine-commission-yellow-taxi-trip-records/" rel="noopener ugc nofollow" target="_blank">纽约市黄色出租车出行数据集</a>。这是一个非常著名的数据集，已经被许多Synapse样本很好地记录和使用。数据集托管在美国东部Azure地区，因此出于数据局部性目的，建议将Synapse workspace &amp; Power BI服务放在同一地区。在我的情况下，我将2015/2016/2017年复制到我的Synapse工作区，因为它不在同一地区托管。</p><p id="30af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设报告要求是:</p><ul class=""><li id="03eb" class="ne nf iq ky b kz la lc ld lf ng lj nh ln ni lr nj nk nl nm bi translated">年份是2015年</li><li id="698a" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">供应商ID为1</li></ul><p id="88de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将包括2015年在内的3年数据加载到数据湖中，以便稍后使用Synapse测试分区修剪，但对于测试Power BI开箱即用数据湖加拼花连接，我们可以简单地指向仅托管2015年的文件夹。</p><p id="fe44" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">提示:</strong> Azure storage explorer还可以用来从公共blob容器中浏览/复制数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/0e88d8d870fb054e74287ba1e4a946c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wpTM8UzBdBQLhR84qvB0Nw.png"/></div></div></figure><p id="5ec8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">提供公共blob容器的URL，即<a class="ae kv" href="https://azureopendatastorage.blob.core.windows.net/nyctlc" rel="noopener ugc nofollow" target="_blank">https://azureopendatastorage.blob.core.windows.net/nyctlc</a>。一旦连接，你可以浏览数据，甚至复制一些文件夹到你自己的数据湖文件夹。您需要获取<code class="fe nt nu nv nw b">nyctlc/yellow</code>文件夹中的数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/3ec441d2b59cea44e246a02574a2d0e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0UBS5AZgRkR_2u36R86bJw.png"/></div></div></figure><h2 id="119a" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">使用Power BI拼花阅读器</h2><p id="f631" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">好了，让我们首先尝试使用Power BI提供的parquet连接器读取这些数据。由于需要从数据湖中枚举文件、parquet解析和应用供应商Id过滤器，M query看起来有点复杂。下面的大部分内容是由向导创建的，用来从数据湖中加载数据。将首先选择某个容器文件夹，然后使用M函数扩展该根文件夹中的所有拼花文件的内容，并将所有内容连接在一起。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/b38a7e046f9ee567de6f27cd97f41833.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6R6dcELs-XKnKnbPhdym6g.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/c04c4b58f43a417d3a5cea7f99e22768.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o0pNmKAksjSikp72Lv-Y3Q.png"/></div></figure><p id="533d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了最大限度地减少本地填充文件并发布到powerbi.com所需的时间，我使用了一个小技巧。</p><ul class=""><li id="3b86" class="ne nf iq ky b kz la lc ld lf ng lj nh ln ni lr nj nk nl nm bi translated">通过在2015文件夹的末尾添加一些字符来重命名该文件夹</li><li id="cbdc" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">用相同的命名模式创建一个新的2015文件夹</li><li id="a8f4" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">从real 2015文件夹中复制超过一个月的数据</li><li id="6d84" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">将更改应用于本地报表，然后将其发布到powerbi.com</li><li id="9d50" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">删除包含一个月数据的文件夹，然后恢复2015重命名的文件夹，使其具有正确的名称</li></ul><p id="0293" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们将了解刷新powerbi.com数据集需要多少时间。此次刷新是针对包括12个月在内的2015年文件夹数据进行的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/7e4420f38307200373b331577fd93f91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l0-KVD8zAGxwuxlKOr7iow.png"/></div></div></figure><p id="a1f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">供应商Id为1的2015年纽约旅行的数据刷新花费了43分钟。该数据集有一个包含大约7000万条记录的表，虽然不算多，但刷新速度很慢。部分时间用于构建数据集的底层表格数据库，但43分钟似乎太长了。</p><p id="8317" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，让我们看看使用不同的方法(如使用Synapse无服务器SQL pool)是否会有所不同。</p><h2 id="08dd" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">正在准备Synapse无服务器SQL池</h2><p id="a697" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">Synapse workspace附带一个内置的无服务器SQL池。我们需要准备一个指向数据湖中trips数据的SQL抽象层。</p><p id="62e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要使用UTF8排序规则创建一个数据库。如果没有UTF8排序规则，在读取拼花文件时会有很多警告。详见<a class="ae kv" href="https://docs.microsoft.com/en-us/azure/synapse-analytics/troubleshoot/reading-utf8-text" rel="noopener ugc nofollow" target="_blank">本文</a>。打开Synapse Studio，然后创建一个新的空SQL脚本文件来运行以下代码片段。</p><pre class="kg kh ki kj gt oa nw ob oc aw od bi"><span id="be89" class="lz ma iq nw b gy oe of l og oh">CREATE DATABASE NycTaxiTrips COLLATE Latin1_General_100_BIN2_UTF8;</span></pre><p id="1c55" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们需要添加一些认证细节，那么就特别需要一个外部数据源。在我们的例子中，我使用传递身份验证，所以不需要添加这样的细节。</p><pre class="kg kh ki kj gt oa nw ob oc aw od bi"><span id="032c" class="lz ma iq nw b gy oe of l og oh">CREATE EXTERNAL DATA SOURCE NycTripsDataSource</span><span id="4df0" class="lz ma iq nw b gy oi of l og oh">WITH (LOCATION='https://[DATA-LAKE-ACCOUNT].dfs.core.windows.net/')</span></pre><p id="804b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个指向包含3年纽约出租车旅行的文件夹的视图。</p><pre class="kg kh ki kj gt oa nw ob oc aw od bi"><span id="9410" class="lz ma iq nw b gy oe of l og oh">CREATE VIEW Trips AS</span><span id="af32" class="lz ma iq nw b gy oi of l og oh">SELECT *, T.filepath(1) AS year, T.filepath(2) AS month</span><span id="fe7a" class="lz ma iq nw b gy oi of l og oh">FROM</span><span id="c9d8" class="lz ma iq nw b gy oi of l og oh">OPENROWSET(</span><span id="1963" class="lz ma iq nw b gy oi of l og oh">BULK '/root/nyctlc/puYear=*/puMonth=*/*.parquet',</span><span id="addb" class="lz ma iq nw b gy oi of l og oh">DATA_SOURCE = 'NycTripsDataSource',</span><span id="3b04" class="lz ma iq nw b gy oi of l og oh">FORMAT='PARQUET'</span><span id="f596" class="lz ma iq nw b gy oi of l og oh">)</span><span id="3245" class="lz ma iq nw b gy oi of l og oh">AS T;</span></pre><p id="df56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您想尝试上面的两个片段，那么更新它们以使用您自己的data lake帐户名和trips parquet文件的正确相对路径。</p><p id="cfdf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以看到，我们已经使用synapse <code class="fe nt nu nv nw b">filepath</code>函数从文件路径中提取了年份和月份列。</p><p id="d157" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要验证视图是否按预期工作，请读取前10条记录。如果向右滚动，您将看到来自分区结构的额外的year和month列。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/0f31af348e1579a5e11feb3c25b18fc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TrHWFDd-i0-tjimvzU5y2g.png"/></div></div></figure><h2 id="790a" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">分区修剪</h2><p id="cede" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">数据湖有3年的数据。如果我们想读取2015年的数据，Synapse应该能够读取2015年的文件夹，只选择所需的数据。我们来验证一下这个假设是否成立。</p><p id="7820" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先运行此查询。</p><pre class="kg kh ki kj gt oa nw ob oc aw od bi"><span id="1b0d" class="lz ma iq nw b gy oe of l og oh">SELECT year, COUNT(*) AS count <br/>FROM Trips<br/>GROUP BY year</span></pre><p id="e6eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果应该是这样的，这意味着视图可以访问3年的数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/a776254aa44768ea7b70e15223d67f75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cUtKMg_OfkYBqNchnkw3lA.png"/></div></div></figure><p id="3848" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">切换到messages选项卡，查看与运行该查询所读取的数据量相关的查询统计信息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/b8861dbb1f0c437e6f5608fcec53eeea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dO6Kg3UOj9Rs6NH1mBX3Fw.png"/></div></div></figure><p id="8325" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Synapse需要读取53MB来运行这个查询。顺便说一下，Synapse不必读取parquet文件的全部内容来得出记录计数。Parquet是一种分栏文件格式，在我们的例子中，或者在投影几列的情况下，Synapse可以只读取满足查询所需的列。</p><p id="f5ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们对同一个查询应用一个年份过滤器。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/718052d190a2b88480ef896d69d79b19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3jDipopK58UqRqWF9JZsiA.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/e94023cc16ce71592035fe100c8e3620.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rFlBerQwvGNzwTng_qEJAA.png"/></div></div></figure><p id="5661" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Synapse这次扫描了18MB的数据，大约是查询扫描所有年份读取的53MB数据的1/3。</p><p id="3ee3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一个类似的模式是，读取较小数量的列比读取较大数量的列需要读取较少的数据。如果我们不需要加载所有的列，这是很方便的。</p><p id="e946" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">太好了！这意味着我们可以在所有年份定义一个视图，如果我们想要提取特定年份，分区修剪将只读取所需的数据，这使得查询运行更快，并且您的Azure账单不会飙升。</p></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><h2 id="17db" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">更新Power BI以使用Synapse SQL视图</h2><p id="cd4f" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">现在克隆您拥有的Power BI报告，并删除现有的Trips表。然后将其替换为到SQL server数据库的连接，并选择Trips视图。SQL server连接可以从Synapse workspace主页获取，因为它具有无服务器SQL池服务器名称。使用您的Azure凭据进行身份验证。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/658468ebe13e9dc78f59e4779cab7116.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vb2jBJ29kXqJgowhR_Qhkw.png"/></div></div></figure><p id="86ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在year列上，使用下拉箭头应用基本文本筛选器，仅提取2015年，类似地，在vendorID列筛选器上，值为1。删除年份和月份列。</p><p id="4550" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">右键单击最后一个应用的步骤，然后单击<strong class="ky ir">查看本地查询</strong>，它应该被启用，这意味着查询折叠在那里。您将看到应用的过滤器出现在WHERE子句中，SELECT语句有一个投影，因此year &amp; month列不包括在内。如果您只需要几列，投影也会使事情变得更快。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/b8a8e5fb80487455def72c1cfbc44150.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VA8c_taibIFQew5jjNj1tw.png"/></div></div></figure><p id="243e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用于提取数据的m查询看起来更加清晰易读。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/5a551543e3bc9895218e5cb33d116c4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5oeFVpgPPDkvvpaV40yTvA.png"/></div></div></figure><p id="3184" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">查询折叠提示</strong></p><p id="28fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您需要使用一个包含过滤值的<br/> CSV字符串(类似于多个产品id)的参数来过滤某一列，您可以使用<code class="fe nt nu nv nw b">Table.SelectRows</code>和<code class="fe nt nu nv nw b">List.Contains</code>的组合。不幸的是，这将直接破坏查询折叠。您需要将<strong class="ky ir">参数值具体化为一个独立的查询，生成一个值列表，然后将<code class="fe nt nu nv nw b">List.Contains</code>指向该查询。</strong></p><p id="204f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在是关键时刻了。使用之前使用的相同技巧将该报告推送到powerbi.com，填充Synapse连接的凭证并触发数据集刷新。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/a575a040ae0b19a0d4f956b87a49ae13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vievBkddw7SQTsaIqvU1xQ.png"/></div></div></figure><p id="199a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在大约需要23分钟，大约是数据湖和拼花连接器所需时间的一半。实际上，如果您有滤波器，使得滤波后的数据是完整原始数据的一个小子集，则增益会明显得多。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi or"><img src="../Images/c9285e6aea65c89c702df01eceda7998.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*u7988Bv9ZhVH_psc.jpg"/></div></figure><p id="2d8d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用于执行刷新的数据量如何？</p><p id="568e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下查询获取由无服务器SQL池处理的数据大小。数据刷新后的每日值与数据刷新前的每日值之间的差异可以很好地指示用于进行刷新的数据大小，这可以用于评估使用Synapse所需的成本，特别是在定期计划刷新的情况下。</p><pre class="kg kh ki kj gt oa nw ob oc aw od bi"><span id="bf85" class="lz ma iq nw b gy oe of l og oh">SELECT * FROM sys.dm_external_data_processed</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/67d2a585cba5031406ada29fcb782e78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*udoBVhTf1-wrGd_SZ4u6hw.png"/></div></div></figure></div><div class="ab cl mx my hu mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ij ik il im in"><h2 id="2e9e" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">要考虑的其他想法</h2><p id="3eed" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">将刷新数据集所需的时间减少一半是一个很好的进步，但在Synapse和Power BI方面还可以做得更多。这里是Dax Studio VertiPaq Analyzer指标，它提供了一些优化该数据集的线索。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/c0a9cc21f9aad741c3955565798e2fac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R99zSNyNp3BCSk0m4ndwXg.png"/></div></div></figure><ul class=""><li id="da75" class="ne nf iq ky b kz la lc ld lf ng lj nh ln ni lr nj nk nl nm bi translated">接送时间的基数非常大(大约25M)。我们可以考虑使用一个日期列来表示接送，两个时间列来表示接送，也许可以使用另一个列来表示持续时间，以防旅行跨越一天的界限。</li><li id="20c5" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">所有包含货币金额的列都应该从十进制转换为固定十进制(货币)。</li><li id="028f" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">重新定义Synapse视图，仅从Parquet中选择所需的列(以防我们不需要所有列)，并在CREATE VIEW语句中显式指定每个列的数据类型。这可能有助于字符串列。</li><li id="f49f" class="ne nf iq ky b kz nn lc no lf np lj nq ln nr lr nj nk nl nm bi translated">对于空间列(纬度和经度)，我们可以将它们四舍五入到小数点后4位，例如，如果报告位置的误差在11米范围内是可以的。这将减少最终数据集的基数和大小。</li></ul><h2 id="03a0" class="lz ma iq bd mb mc md dn me mf mg dp mh lf mi mj mk lj ml mm mn ln mo mp mq mr bi translated">资源</h2><div class="ou ov gp gr ow ox"><a href="https://datamozart.medium.com/synapse-serverless-sql-power-bi-having-fun-with-pivot-3491dbb13ae8" rel="noopener follow" target="_blank"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd ir gy z fp pc fr fs pd fu fw ip bi translated">Synapse无服务器SQL和Power BI —享受PIVOT带来的乐趣！</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">查看Synapse无服务器SQL pool的最新改进如何帮助您创建最受欢迎的Power BI…</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">datamozart.medium.com</p></div></div><div class="pg l"><div class="ph l pi pj pk pg pl kp ox"/></div></div></a></div><div class="ou ov gp gr ow ox"><a href="https://blog.crossjoin.co.uk/2021/01/31/comparing-the-performance-of-importing-data-into-power-bi-from-adlsgen2-direct-and-via-azure-synapse-analytics-serverless-part-2-transformations/" rel="noopener  ugc nofollow" target="_blank"><div class="oy ab fo"><div class="oz ab pa cl cj pb"><h2 class="bd ir gy z fp pc fr fs pd fu fw ip bi translated">Chris Webb的BI博客:将数据从ADLSgen2导入Power BI的性能比较…</h2><div class="pe l"><h3 class="bd b gy z fp pc fr fs pd fu fw dk translated">在我的上一篇文章中，我展示了如何从存储在ADLSgen2中的csv文件的文件夹中导入所有数据，而不做任何…</h3></div><div class="pf l"><p class="bd b dl z fp pc fr fs pd fu fw dk translated">blog.crossjoin.co.uk</p></div></div><div class="pg l"><div class="pm l pi pj pk pg pl kp ox"/></div></div></a></div></div></div>    
</body>
</html>