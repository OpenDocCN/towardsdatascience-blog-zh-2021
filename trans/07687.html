<html>
<head>
<title>10x times faster Pandas Apply in a single line change of code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">速度快10倍熊猫应用在一行代码的变化</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/10x-times-faster-pandas-apply-in-a-single-line-change-of-code-c42cb5e82f6d?source=collection_archive---------11-----------------------#2021-07-14">https://towardsdatascience.com/10x-times-faster-pandas-apply-in-a-single-line-change-of-code-c42cb5e82f6d?source=collection_archive---------11-----------------------#2021-07-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d104" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用更快的包裹加速熊猫处理工作流程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/beb73ab6d0effaba03413f1683f9cbe9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K28_heQQB4dPr1VNhmSJyw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)</p></figure><p id="c8c0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Pandas是数据科学社区中流行的Python包之一，因为它为数据探索和可视化提供了巨大的API和灵活的数据结构。当处理大规模数据集时，它失败了。</p><p id="c67c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">人们可以分块加载和处理大规模数据集，或者使用分布式并行计算库，如Dask、Pandarallel、Vaex等。可以使用Modin库或多处理包来并行执行Python函数，并加快工作流程。在我以前的文章中，我已经讨论了Dask、Vaex、Modin、多处理库的实际实现。</p><p id="38bc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有时我们不愿意使用Dask或Vaex库来代替Pandas，或者我们不希望仅仅为了并行执行几个函数而编写所有那些无关的代码。</p><p id="aa2e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu"> <em class="lu">我们能在不做太多代码改动的情况下并行执行Python函数吗？</em></strong>——<strong class="la iu">肯定是</strong></p><p id="ea6a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">熊猫库中的函数允许开发者传递一个函数，并将其应用于系列中的每一个值。函数的执行<code class="fe lv lw lx ly b"><strong class="la iu">apply()</strong></code>带来了巨大的改进，因为它根据所需的条件分离数据。</p><p id="2201" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于Pandas系列，最好使用apply()函数，而不是自定义调用该函数。在本文中，我们将讨论如何进一步并行执行<code class="fe lv lw lx ly b"><strong class="la iu"><em class="lu">apply()</em></strong></code>函数，并使用<strong class="la iu"> Swifter </strong>包优化时间约束。</p><h1 id="f16c" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">更快:</h1><p id="75e6" class="pw-post-body-paragraph ky kz it la b lb mr ju ld le ms jx lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated"><strong class="la iu"> Swifter </strong>是一个开源包，可以加速函数的执行。为了方便使用，它可以与熊猫对象集成在一起。通过集成swifter包，用一行代码就可以并行执行Python中的任何函数。</p><h2 id="cf6f" class="mw ma it bd mb mx my dn mf mz na dp mj lh nb nc ml ll nd ne mn lp nf ng mp nh bi translated">它是如何工作的？</h2><p id="de5d" class="pw-post-body-paragraph ky kz it la b lb mr ju ld le ms jx lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">Swifter通过矢量化或在后端使用Dask实现来并行化执行，自动选择实现<code class="fe lv lw lx ly b"><strong class="la iu">apply()</strong></code>功能的最佳方式。对于小规模数据集，Swifter可以选择执行Pandas apply()函数。</p><h2 id="edfc" class="mw ma it bd mb mx my dn mf mz na dp mj lh nb nc ml ll nd ne mn lp nf ng mp nh bi translated">安装:</h2><p id="989f" class="pw-post-body-paragraph ky kz it la b lb mr ju ld le ms jx lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">可以使用<code class="fe lv lw lx ly b"><strong class="la iu">pip install swifter</strong></code> <strong class="la iu"> </strong>从PyPl安装swifter包，并使用<strong class="la iu"> </strong> <code class="fe lv lw lx ly b"><strong class="la iu">import swifter</strong></code> <strong class="la iu">导入它。</strong></p><h2 id="2efc" class="mw ma it bd mb mx my dn mf mz na dp mj lh nb nc ml ll nd ne mn lp nf ng mp nh bi translated">实施和使用:</h2><p id="e709" class="pw-post-body-paragraph ky kz it la b lb mr ju ld le ms jx lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">我创建了一个函数，对熊猫系列执行一些随机操作。首先，我们将使用apply()执行函数:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="736f" class="mw ma it ly b gy nm nn l no np"># Call random_function for col1 and col2 columns using apply()</span><span id="99b5" class="mw ma it ly b gy nq nn l no np"><strong class="ly iu">df['new_col'] = df.apply(lambda x: random_func(x['col1'], x['col2']))</strong></span></pre><p id="e7b3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，为了并行执行函数，我们可以将swifter包与Pandas数据框对象相集成:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="1425" class="mw ma it ly b gy nm nn l no np"># Call random_function for col1 and col2 columns for parallel execution</span><span id="c529" class="mw ma it ly b gy nq nn l no np"><strong class="ly iu">df['new_col'] = df.swifter.apply(lambda x: random_func(x['col1'], x['col2']))</strong></span></pre><p id="f8ea" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">只要集成关键字swifter，就可以并行执行该函数。</p><h1 id="3293" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">基准测试:</h1><p id="4063" class="pw-post-body-paragraph ky kz it la b lb mr ju ld le ms jx lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">我比较了使用apply()和通过将swifter包与Pandas数据帧对象集成然后调用apply()来执行函数的基准时间数。现在让我们观察一下执行速度的提高。</p><blockquote class="nr ns nt"><p id="452b" class="ky kz lu la b lb lc ju ld le lf jx lg nu li lj lk nv lm ln lo nw lq lr ls lt im bi translated"><em class="it">性能记录在一个带有</em><strong class="la iu"><em class="it">RAM:64GB</em></strong><em class="it"/><strong class="la iu"><em class="it">10个CPU核心</em> </strong> <em class="it">的系统上。</em></p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/06768ff9f6fa3bb078991c35d87e4219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lErcRPKlS8aRy6MKpUEyNQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(图片由作者提供)，执行apply()的基准测试时间和速度</p></figure><p id="3dc1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从上面的图中我们可以观察到，在使用更快的并行包后，对于<strong class="la iu">6500万</strong>个数据样本，工作流的速度几乎提高了<strong class="la iu">10倍</strong>。</p><h1 id="381c" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">结论:</h1><p id="d788" class="pw-post-body-paragraph ky kz it la b lb mr ju ld le ms jx lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">Swifter是并行执行Python函数的一个很好的工具。它会自动选择最快的方式来执行您的函数，通过矢量化或在后端使用Dask。</p><p id="58db" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于6500万条记录，我们的执行速度提高了10倍，随着样本量的增加，这一速度还会进一步提高。</p><p id="83a8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它是一个方便的工具，只需修改一次代码就可以优化函数的执行。您也可以使用Python多处理库来并行执行您的定制，但是它只需要对代码进行几行修改。</p><blockquote class="nr ns nt"><p id="4077" class="ky kz lu la b lb lc ju ld le lf jx lg nu li lj lk nv lm ln lo nw lq lr ls lt im bi translated"><strong class="la iu">阅读我之前的一篇关于代码优化并行化的文章:</strong></p></blockquote><ul class=""><li id="9d1b" class="nx ny it la b lb lc le lf lh nz ll oa lp ob lt oc od oe of bi translated">4个可以并行处理现有熊猫生态系统的库</li><li id="b3ff" class="nx ny it la b lb oh le oi lh oj ll ok lp ol lt oc od oe of bi translated"><a class="ae og" rel="noopener" target="_blank" href="/speed-up-your-pandas-workflow-by-changing-a-single-line-of-code-11dfd85efcfb">用摩丁</a>加速你的熊猫工作流程</li><li id="a4b6" class="nx ny it la b lb oh le oi lh oj ll ok lp ol lt oc od oe of bi translated"><a class="ae og" rel="noopener" target="_blank" href="/25x-times-faster-python-function-execution-in-a-few-lines-of-code-4c82bdd0f64c">借助多处理模块，Python函数执行速度提高30倍</a></li><li id="bcdc" class="nx ny it la b lb oh le oi lh oj ll ok lp ol lt oc od oe of bi translated"><a class="ae og" rel="noopener" target="_blank" href="/400x-time-faster-pandas-data-frame-iteration-16fb47871a0a">熊猫数据帧迭代速度快400倍</a></li><li id="9876" class="nx ny it la b lb oh le oi lh oj ll ok lp ol lt oc od oe of bi translated"><a class="ae og" rel="noopener" target="_blank" href="/3x-times-faster-pandas-with-pypolars-7550e605805e">速度快3倍的大熊猫带着pypolar</a></li><li id="4515" class="nx ny it la b lb oh le oi lh oj ll ok lp ol lt oc od oe of bi translated"><a class="ae og" rel="noopener" target="_blank" href="/optimize-pandas-memory-usage-while-reading-large-datasets-1b047c762c9b">为大型数据集优化Pandas内存使用</a></li><li id="c338" class="nx ny it la b lb oh le oi lh oj ll ok lp ol lt oc od oe of bi translated"><a class="ae og" rel="noopener" target="_blank" href="/20x-times-faster-grid-search-cross-validation-19ef01409b7c">网格搜索交叉验证速度提高20倍</a></li></ul><h1 id="aaae" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">参考资料:</h1><p id="5f6f" class="pw-post-body-paragraph ky kz it la b lb mr ju ld le ms jx lg lh mt lj lk ll mu ln lo lp mv lr ls lt im bi translated">[1]更迅捷的GitHub库:【https://github.com/jmcarpenter2/swifter T2】</p><blockquote class="om"><p id="b5cc" class="on oo it bd op oq or os ot ou ov lt dk translated">感谢您的阅读</p></blockquote></div></div>    
</body>
</html>