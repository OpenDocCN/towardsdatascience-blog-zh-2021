<html>
<head>
<title>How to track statistics on all queries in your Postgres database to prevent slow queries or bottlenecks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何跟踪Postgres数据库中所有查询的统计数据，以防止缓慢的查询或瓶颈</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-track-statistics-on-all-queries-in-your-postgres-database-to-prevent-slow-queries-or-730d3f94076c?source=collection_archive---------8-----------------------#2021-12-01">https://towardsdatascience.com/how-to-track-statistics-on-all-queries-in-your-postgres-database-to-prevent-slow-queries-or-730d3f94076c?source=collection_archive---------8-----------------------#2021-12-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="128d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用这个扩展提供的重要统计数据来优化数据库性能</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a17f0cbd555687c11b9c6304b2b1c129.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4fVt4TUv56GRoZq9"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这种延伸就像一件救生背心；你永远不会希望你需要它，但它在困难的情况下会非常有用(图片由<a class="ae ky" href="https://unsplash.com/photos/owm3TQrv6N4" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@karsten116" rel="noopener ugc nofollow" target="_blank">卡斯滕·温内格特</a>提供)</p></figure><p id="8492" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你有没有想过为什么你的应用程序的某些部分突然变得非常慢？可以是你的数据库吗？你会怎么发现？如果有一个扩展来跟踪它执行的所有查询的统计数据，以便您可以分析数据库性能并清除瓶颈，这不是很好吗？</p><p id="323d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将看到一个名为pg_stat_statements的Postgres扩展。它对数据库执行的所有查询进行统计，从而提供关于数据库性能的重要信息。有了它，您可以轻松地跟踪数据库的性能，检测缓慢的查询，消除瓶颈并防止问题发生。</p><p id="ed43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将首先进行非常简单的安装。然后我们演示如何使用它。我们来编码吧！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="aa5d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">这个扩展是做什么的？</h1><p id="31b6" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Pg_stat_statements是Postgres的扩展，它跟踪服务器执行的所有查询的执行统计信息。这个扩展跟踪静态数据，比如</p><ul class=""><li id="6534" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">该语句被调用的次数</li><li id="f6d9" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">语句的最快和最慢执行</li><li id="d37e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">语句执行时间的平均值和标准差</li><li id="9428" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">已检索或受影响的总行数</li><li id="b287" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">关于块的信息(命中、读取、写入、变脏等。)</li></ul><p id="3c5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这对于分析查询的质量非常有用。使用统计数据，很容易调试数据库中的问题，跟踪缓慢的查询和表，并防止与数据库相关的问题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/04e935ec4c9191fc492d081981b13b2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kgBM7KO2HP87FhSD"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这一扩展将帮助我们保持数据在数据库中顺畅流动(图片由<a class="ae ky" href="https://unsplash.com/@dnevozhai" rel="noopener ugc nofollow" target="_blank">丹尼斯·内沃扎伊</a>在<a class="ae ky" href="https://unsplash.com/photos/7nrsVjvALnA" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure><h1 id="7b09" class="mc md it bd me mf nn mh mi mj no ml mm jz np ka mo kc nq kd mq kf nr kg ms mt bi translated">装置</h1><p id="4ca9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">安装pg_stat_statements非常简单，只需要三个步骤。在这一部分中，我们将介绍每个步骤，然后向您展示如何在本地安装的Postgres实例和Postgres的Dockerized版本中执行这些步骤。如果你对Docker不熟悉，可以看看这篇文章，这篇文章由Docker【<strong class="lb iu"/>和【<strong class="lb iu"> </strong> <a class="ae ky" href="https://mikehuls.medium.com/docker-compose-for-absolute-beginners-how-does-it-work-and-how-to-use-it-examples-733ca24c5e6c" rel="noopener"> <strong class="lb iu">撰写。</strong></a></p><p id="9332" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">步骤如下:</p><ol class=""><li id="de54" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ns nf ng nh bi translated">给<code class="fe nt nu nv nw b">postgresql.conf</code>添加几行</li><li id="0581" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ns nf ng nh bi translated">在数据库中创建扩展</li><li id="b248" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ns nf ng nh bi translated">重启Postgres</li></ol></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="1b2d" class="nx md it bd me ny nz dn mi oa ob dp mm li oc od mo lm oe of mq lq og oh ms oi bi translated">1.修改postgresql.conf</h2><p id="8020" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这个文件存储了Postgres的一些配置。我们需要修改它，以便告诉Postgres在我们的语句中存储一些统计数据是可以的。</p><p id="c126" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">本地安装<br/> </strong>首先我们来处理<code class="fe nt nu nv nw b">postgresql.conf</code>文件。找到文件(通常位于Postgres安装位置的<code class="fe nt nu nv nw b">data</code>文件夹中(windows示例:<code class="fe nt nu nv nw b">C:\Program Files\PostgreSQL\14\data</code>)并打开它。找到写着<code class="fe nt nu nv nw b"># — Shared Library Preloading</code>的行，并添加以下三行:</p><pre class="kj kk kl km gt oj nw ok ol aw om bi"><span id="b341" class="nx md it nw b gy on oo l op oq">shared_preload_libraries = 'pg_stat_statements'<br/>pg_stat_statements.max = 10000<br/>pg_stat_statements.track = all</span></pre><p id="fe5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在<code class="fe nt nu nv nw b">docker-compose.yml</code>文件中定义一些额外的命令，以便将额外的行添加到<code class="fe nt nu nv nw b">postgres.conf</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="8bef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第13行中，我们将pg _ stat _语句包含到shared_preload_libraries中。搞定了。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="96c4" class="nx md it bd me ny nz dn mi oa ob dp mm li oc od mo lm oe of mq lq og oh ms oi bi translated">步骤2:创建扩展</h2><p id="bbbe" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这是一个非常简单的步骤。我们将在PgAdmin(或另一个数据库GUI工具)中执行下面的语句</p><pre class="kj kk kl km gt oj nw ok ol aw om bi"><span id="c491" class="nx md it nw b gy on oo l op oq">CREATE EXTENSION pg_stat_statements;</span></pre><h2 id="505a" class="nx md it bd me ny nz dn mi oa ob dp mm li oc od mo lm oe of mq lq og oh ms oi bi translated">第三步:重启Postgres</h2><p id="dd05" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">也没那么难；在windows中，按下<code class="fe nt nu nv nw b">control-r</code>并运行<code class="fe nt nu nv nw b">services.msc</code>。找到Postgres，右键，重启。使用Docker时，只需重启容器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/dfc4e82bf55e522469216ff220707140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GuT0HsmYKHLE-6oh"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安装完成！让我们为一些问题计时(图片由<a class="ae ky" href="https://unsplash.com/@veri_ivanova" rel="noopener ugc nofollow" target="_blank"> Veri Ivanova </a>在<a class="ae ky" href="https://unsplash.com/photos/p3Pj7jOYvnM" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上提供)</p></figure><h1 id="0969" class="mc md it bd me mf nn mh mi mj no ml mm jz np ka mo kc nq kd mq kf nr kg ms mt bi translated">演示</h1><p id="0e3e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在所有无聊的事情都已经过去了，让我们看看这个扩展能给我们带来的巨大优势吧！我们将假装是一个图书馆，创建一个出租书籍的数据库。</p><h2 id="dd04" class="nx md it bd me ny nz dn mi oa ob dp mm li oc od mo lm oe of mq lq og oh ms oi bi translated">设置-创建表</h2><p id="c3d2" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们将创建三个表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/08fad7f7f956d931d02eecf54f42b58b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*y5GIlYyQExEC0rSPnYnKqA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们简单的数据库结构(图片由作者提供)</p></figure><p id="811c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在执行了创建这些表的语句之后，当我们调用<code class="fe nt nu nv nw b">SELECT [some columns] FROM pg_stat_statements</code>时，我们已经看到了一些统计数据:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/4c5932c39f2e680a0922370269e6b641.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XVk4dFMieNUzwYSVSSG3wg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的首次统计(图片由作者提供)</p></figure><p id="ab11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，这些统计数据主要涉及创建我们的表的语句。</p><h2 id="46c4" class="nx md it bd me ny nz dn mi oa ob dp mm li oc od mo lm oe of mq lq og oh ms oi bi translated">重置我们的统计数据</h2><p id="884d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">下一步是插入一些数据，以便我们可以运行一些查询并检查结果。因为我们对以前操作的统计数据不感兴趣，所以我们调用<code class="fe nt nu nv nw b">SELECT pg_stat_statements_reset();</code>来清除所有当前的统计数据。</p><h2 id="8290" class="nx md it bd me ny nz dn mi oa ob dp mm li oc od mo lm oe of mq lq og oh ms oi bi translated">插入一些数据并运行一些查询</h2><p id="d00a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">下一步；插入一些数据！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="eb26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并运行一些查询:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="or os l"/></div></figure><p id="558d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们执行了一些不同的查询。</p><h2 id="5f00" class="nx md it bd me ny nz dn mi oa ob dp mm li oc od mo lm oe of mq lq og oh ms oi bi translated">分析我们的查询</h2><p id="dd57" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在我们可以调用<code class="fe nt nu nv nw b">SELECT * FROM pg_stat_statements</code>并分析执行统计数据。我选择了一些列，并根据平均执行时间对行进行了排序。这是返回的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/b23cf0c6eb0fbfa20297601c325a50ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3mCBG4JDmQUq8kjg0zJMEA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自我们新扩展的一批新的执行统计数据(图片由作者提供)</p></figure><p id="f1ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些结果不言自明，但让我们快速浏览一遍。第一条记录包含了我们执行两个连接的最后一个最大的查询，难怪它是最慢的！<br/>请注意，我们在<code class="fe nt nu nv nw b">lib.books</code>中选择了三个不同的标题。这由记录5表示；显示我们对过滤标题的<code class="fe nt nu nv nw b">books</code>表进行了三次调用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fcb315f9608534151080a470b51448eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oez29SRqJhAeGgZB"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用统计数据，我们可以调整我们的数据库，以优化性能！(图片由<a class="ae ky" href="https://unsplash.com/@nina_mercado" rel="noopener ugc nofollow" target="_blank">妮娜·梅尔卡多</a>在<a class="ae ky" href="https://unsplash.com/photos/Y_t0n-T4H5M" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure><h1 id="4287" class="mc md it bd me mf nn mh mi mj no ml mm jz np ka mo kc nq kd mq kf nr kg ms mt bi translated">结论</h1><p id="c63c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">通过这篇短文，我们完成了一个非常有用的扩展。我希望已经展示了简单的安装以及它可以为您提供的监视和改进数据库的价值。如果你有建议/澄清，请评论，以便我可以改进这篇文章。同时，看看我的其他关于各种编程相关主题的文章:</p><ul class=""><li id="2dab" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-delete-into-another-table-b5b946a42299" rel="noopener">删除到另一个表中</a></li><li id="0a52" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-into-another-table-bfc3dff79a66" rel="noopener">更新到另一个标签页</a> le</li><li id="d743" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-insert-delete-and-update-in-one-statement-sync-your-tables-with-merge-14814215d32c" rel="noopener">在一条语句中插入、删除和更新</a></li><li id="76c7" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-update-select-in-one-query-b067a7e60136" rel="noopener">更新选择一批记录</a></li><li id="ae66" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-inserting-only-unique-values-in-a-unique-table-af2eb3b9890a" rel="noopener">插入到唯一的表中</a></li><li id="f594" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://mikehuls.medium.com/sql-understand-how-indices-work-under-the-hood-to-speed-up-your-queries-a7f07eef4080" rel="noopener">了解索引如何加快查询速度</a></li></ul><p id="0117" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><p id="be82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">—迈克</p><p id="3f7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页（page的缩写）学生:比如我正在做的事情？<a class="ae ky" href="https://mikehuls.medium.com/membership" rel="noopener">跟我来！</a></p></div></div>    
</body>
</html>