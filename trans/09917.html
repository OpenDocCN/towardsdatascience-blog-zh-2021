<html>
<head>
<title>What’s fancy about context transition in DAX?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DAX中的语境转换有什么花哨的地方？</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/whats-fancy-about-context-transition-in-dax-efb5d5bc4c01?source=collection_archive---------10-----------------------#2021-09-18">https://towardsdatascience.com/whats-fancy-about-context-transition-in-dax-efb5d5bc4c01?source=collection_archive---------10-----------------------#2021-09-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f02f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">行和过滤器上下文是DAX中众所周知的概念。但是我们可以通过上下文转换在这两者之间切换。让我们看看我们能用它做什么。</em></h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/9072272807c736c4664383258ccc2246.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*o5YW0Ln0AYm_zcdA"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">由<a class="ae kz" href="https://unsplash.com/@raimondklavins?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">雷蒙·克拉文斯</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="5743" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">介绍</h1><p id="1633" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">在本文中，我将向您展示什么是DAX中的上下文转换以及如何使用它。</p><p id="49ea" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我将只讲述这个特性的基础知识。如果我想解释所有的细节，我将不得不开始一整个系列的文章。</p><p id="d8da" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">相反，我想给你一些小例子，告诉你如何使用上下文转换，以及关于它最重要的事情。这样，您可以开始使用它，并根据需要了解更多信息。</p><p id="7d0b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">你可以在文章的最后找到一个文章和博客帖子的列表，这些文章和博客帖子更深入地探讨了上下文转换。</p><h1 id="15a3" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">首先，我们来说说数据。</h1><p id="113d" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">我使用Contoso样本数据集，就像我以前的文章一样。</p><p id="2ed5" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在整个数据模型中，对于本文中的示例，我只需要两个表:</p><ul class=""><li id="84be" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">客户(dim客户)</li><li id="2b71" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">在线销售(FactOnlineSales)</li></ul><p id="661c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">关于在线销售表的一个重要因素是存储在在线销售表中的订单包含一个OrderNumber和一个OrderLineNumber。</p><p id="88db" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">一个订单可以有一个或多个OrderLineNumber:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/6219ee6a45bcdbc418155efca4873a86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*n0ajQxOpx_20Nw6BSbkGaA.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图1 —样本数据(图片由作者提供)</p></figure><p id="1c68" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">每个OrderLineNumber都有一个映射的产品和一个SalesAmount。</p><p id="840a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">为了保持代码简单，我将分析单个订单行，而不是订单。</p><p id="36da" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我需要改变数据的粒度，以便能够分析订单。我将在以后的文章中继续讨论在DAX中改变粒度的话题。</p><h1 id="50b2" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">商业案例</h1><p id="098b" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">让我们假设以下情况:我们有一个客户列表，我们想知道每个客户的总销售额并获得其他信息。</p><p id="8a94" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">为了获得所需的信息，我们希望计算以下结果:</p><ul class=""><li id="e07b" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">客户表中每个客户的最高销售额</li><li id="181e" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">每个客户每年的总销售额</li><li id="b1d1" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">每位顾客的平均销售额是多少</li><li id="9507" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">按客户列出的销售额占所有销售额的百分比</li><li id="3c3a" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">每年总销售额排名前10 %的客户是谁</li></ul><p id="00ba" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我无法创建度量来计算这些结果，因为我想将它们用作切片器中的筛选器以及我的报告中的报告属性。<br/>这意味着我必须在Customer表中添加计算的DAX列。</p><h1 id="5f0f" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">客户表中每个客户的最高销售额</h1><p id="821f" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">这个要求看起来很简单:从每个客户的在线销售表中获取MAX()。</p><p id="6f9a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是，我无法在Customer表中用MAX('Online Sales'[SalesAmount])创建计算列，因为SalesAmount列不在Customer表中。</p><p id="1ca4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我可以编写以下代码:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="6ee4" class="nn lb it nj b gy no np l nq nr">Highest OrderLine = MAXX(‘Online Sales’<br/>      , ‘Online Sales’[SalesAmount]<br/>)</span></pre><p id="e81d" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">结果将如下所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/d4d88c485ac77ae5a24d5be87bb0ffbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*CzrG5g7vUtuZJm0UBC1Ucg.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图2 —简单的MAXX(图片由作者提供)</p></figure><p id="ff92" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">由于MAXX没有过滤器上下文，它将检索所有客户中销售额最高的订单行。</p><p id="2c31" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我必须使用上下文转换来强制DAX引擎从行上下文切换到过滤器上下文。在上下文转换过程中，实际行的内容将被添加到过滤器上下文中，MAXX将使用该过滤器上下文执行。</p><p id="cc59" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我可以用CALCULATE()强制进行上下文转换:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="a9c8" class="nn lb it nj b gy no np l nq nr">Highest Order Line =<br/>    VAR Result =<br/>        CALCULATE(<br/>            MAXX( ‘Online Sales’<br/>                  ,’Online Sales’[SalesAmount])<br/>                 )</span><span id="4a5b" class="nn lb it nj b gy nt np l nq nr">RETURN<br/>    Result</span></pre><p id="5b8a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">你可以在下图中看到结果:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nu"><img src="../Images/e76677ffc00742029eedab0a703a510c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rWECU2_MHI1EDdEuRL7YhQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图3 —带有上下文转换的MAXX(图片由作者提供)</p></figure><p id="59a4" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">会发生什么？</p><ol class=""><li id="f76b" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn nv mz na nb bi translated">在对Customer表中的每一行进行迭代的过程中，context transition将实际行的内容添加到筛选器上下文中，包括CustomerKey列。CustomerKey列用于与Online Sales表的关系中。</li><li id="c121" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nv mz na nb bi translated">CustomerKey为每个客户筛选在线销售表</li><li id="f7e9" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nv mz na nb bi translated">现在为每个CustomerKey计算SalesAmount列的最大值</li></ol><p id="bbf9" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">您可以利用所有迭代器函数的上下文转换，包括FILTER()和其他函数。</p><p id="0dff" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我在我的上一篇文章(<a class="ae kz" rel="noopener" target="_blank" href="/to-weigh-or-not-to-weigh-this-is-the-average-question-ece33fad9180">称体重或不称体重——这是一个普通的问题</a>)中使用了这个技巧，采用了以下方法:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="ab85" class="nn lb it nj b gy no np l nq nr">Average per Country =<br/>    AVERAGEX(VALUES(‘Geography’[Region Country])<br/>        ,DIVIDE([Online Sales (By Customer)]<br/>                 , [Order Count (By Customer)] )<br/>    )</span></pre><p id="5b73" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">尽管您在解决方案中看不到任何CALCULATE()，但我在AVERAGEX函数中使用了度量。在行上下文中使用度量会自动触发上下文转换。</p><h1 id="869b" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">客户表中每个客户销售额最高的年份</h1><p id="8490" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">这个要求解决起来有点复杂。</p><p id="29d6" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">如上所述，我不想创建度量，因为我想在切片器中使用计算结果。</p><p id="345b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">因此，我还必须创建一个计算列:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="7da9" class="nn lb it nj b gy no np l nq nr">Year of Highest Order Line =</span><span id="a143" class="nn lb it nj b gy nt np l nq nr">VAR HighestOrderLine = ‘Customer’[Highest Order Line]</span><span id="9503" class="nn lb it nj b gy nt np l nq nr">VAR Result =<br/>    CALCULATE(<br/>        MAXX ( ‘Online Sales’<br/>                ,YEAR(‘Online Sales’[OrderDate])<br/>               )<br/>            , ‘Online Sales’[SalesAmount] = HighestOrderLine<br/>            )</span><span id="0d66" class="nn lb it nj b gy nt np l nq nr">RETURN<br/>    Result</span></pre><p id="893a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">同样，我使用CALCULATE()启动上下文转换，这会自动将CustomerKey列添加到MAXX()函数的过滤器上下文中。正因为如此，我不需要在CALCULATE()里面按CustomerKey过滤。</p><p id="934e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我只需要搜索销售额最高的订单行，这是我在上一篇专栏文章中计算的，然后使用MAXX获得去年的销售额。</p><p id="b6be" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">使用CALCULATE()添加的筛选器被添加到现有的筛选器上下文中，该上下文已经通过上下文转换包含了customer表中当前客户的行。</p><p id="0098" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">你可以在下图中看到结果:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/8af2266ff16ed5142bc1b51b3b0453dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/1*kcEtq8YZbqP97C9poYrC-Q.png"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图4 —去年销售额最高的一年(图片由作者提供)</p></figure><h1 id="fbaf" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">每位顾客的平均销售额是多少</h1><p id="1c34" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">以你到现在为止所获得的知识，你应该能够独立解决这个需求。</p><p id="7549" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">试着想一想，想出一个解决方案可能是什么样子的想法。</p><p id="3ff1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi">.</p><p id="58bb" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi">.</p><p id="f148" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi">.</p><p id="b12c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">完成了吗？</p><p id="2ed7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">好了，这是这个计算列的解:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="934d" class="nn lb it nj b gy no np l nq nr">Average Sales = CALCULATE(<br/>                          AVERAGEX(‘Online Sales’<br/>                          ,’Online Sales’[SalesAmount])<br/>                          )</span></pre><p id="27e1" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">上下文转换允许我们编写这样简短而强大的DAX公式。</p><p id="aabb" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">另一种方法是用AVERAGEX()创建一个度量，如上所示，并将这个度量直接用于计算列。</p><h1 id="76b1" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">按客户列出的销售额占所有销售额的百分比</h1><p id="abb6" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">这一要求要求我们结合获得的知识，使用以下DAX公式创建一个新的计算列:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="b62b" class="nn lb it nj b gy no np l nq nr">% Sales of Total Sales =</span><span id="01e6" class="nn lb it nj b gy nt np l nq nr">VAR SalesOverall = SUMX(‘Online Sales’<br/>                        ,’Online Sales’[SalesAmount]<br/>                        )</span><span id="5ac5" class="nn lb it nj b gy nt np l nq nr">VAR SalesOfCustomer = CALCULATE(<br/>                             SUMX(‘Online Sales’<br/>                                   ,’Online Sales’[SalesAmount]<br/>                                  )<br/>                              )</span><span id="2135" class="nn lb it nj b gy nt np l nq nr">VAR PctOfTotalSales = DIVIDE(SalesOfCustomer, SalesOverall)</span><span id="a8da" class="nn lb it nj b gy nt np l nq nr">RETURN<br/>    PctOfTotalSales</span></pre><p id="e010" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">下面是这个公式的解释:</p><ol class=""><li id="f2a7" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn nv mz na nb bi translated">变量<em class="nx">sales total</em>不使用上下文转换。结果是所有客户的总销售额</li><li id="ec3a" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nv mz na nb bi translated">变量SalesOfCustomer用CALCULATE()包含了与<em class="nx">sales total</em>相同的表达式，从而强制执行上下文转换。<br/>结果是当前客户的销售额总和</li><li id="e104" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nv mz na nb bi translated">变量<em class="nx">中的除法运算PctOfTotalSales </em>计算<em class="nx">销售额占<em class="nx">总销售额</em>的百分比</em></li></ol><p id="0069" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">结果看起来像这样:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ny"><img src="../Images/06e50c09da11b8e6a0f37c53427e4b2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4HayXk5Gx6DrekGCn00x1Q.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图5 —每个客户占总销售额的百分比(图片由作者提供)</p></figure><h1 id="81ee" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">哪个客户在总销售额的前10 %之内</h1><p id="dc46" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">为此，我需要根据总销售额计算所有客户的排名。然后我需要得到最高的排名，或者说客户数量，计算出哪些客户在所有客户的前10 %。</p><p id="031c" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">输出应该是包含True或False值的列。</p><p id="8420" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">你可以想象，这是不可能一步到位的。</p><p id="66d8" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">在这里，我想向您展示两种解决方案，它们以略微不同的方式使用上下文转换。</p><h1 id="daa5" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">解决方案1-计算表和查找值()</h1><p id="3292" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">通过这种方法，我创建了一个计算DAX表。然后我使用LOOKUPVALUE()将这些值映射到Customer表中。</p><p id="3aac" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这是创建DAX表的代码:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="eb4f" class="nn lb it nj b gy no np l nq nr">Customer Ranking =</span><span id="6512" class="nn lb it nj b gy nt np l nq nr">VAR CustAndSales = ADDCOLUMNS( VALUES(Customer[CustomerKey] )<br/>                              ,”Amt”, [Online Sales (By Order Date)]<br/>                              )</span><span id="4227" class="nn lb it nj b gy nt np l nq nr">VAR RankedCustomer = ADDCOLUMNS(CustAndSales<br/>                                ,”Rank”, RANKX(CustAndSales<br/>                                               ,[Amt]<br/>                                               )<br/>                                 )</span><span id="930e" class="nn lb it nj b gy nt np l nq nr">VAR MaxRank = MAXX( RankedCustomer<br/>                     ,[Rank]<br/>                     )</span><span id="842e" class="nn lb it nj b gy nt np l nq nr">VAR Result = ADDCOLUMNS(<br/>                    RankedCustomer<br/>                    ,”IsTop10Perc”<br/>                        , IF(<br/>                               DIVIDE( [Rank]<br/>                                     , MaxRank ) &lt;= 0.1<br/>                               , TRUE()<br/>                               ,FALSE()<br/>                               )<br/>                         )</span><span id="b55f" class="nn lb it nj b gy nt np l nq nr">RETURN<br/>    Result</span></pre><p id="2f44" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">变量<em class="nx"> CustAndSales </em>创建一个所有CustomerKey的列表，并使用度量[在线销售额(按订单日期)]计算每个客户的销售额总和</p><ol class=""><li id="1e19" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn nv mz na nb bi translated">在变量<em class="nx"> RankedCustomer中，</em>我使用RANKX()根据每个客户的总销售额来计算总体CustomerKeys的排名</li><li id="6f0f" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nv mz na nb bi translated">变量<em class="nx"> MaxRank </em>获得最高等级，我将在下面的变量中使用它</li><li id="224d" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn nv mz na nb bi translated">最后，我将添加带有IF()结果的列IsTop10Perc。根据每个客户的总销售额，如果客户位于前10 %的客户中，则此列包含该标志</li></ol><p id="4d82" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">现在，我使用以下表达式在Customer表中创建新的计算列:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="c406" class="nn lb it nj b gy no np l nq nr">Is Top 10 % customer by Sales =</span><span id="d550" class="nn lb it nj b gy nt np l nq nr">VAR Result = LOOKUPVALUE(‘Customer Ranking’[IsTop10Perc]<br/>                          , ‘Customer Ranking’[CustomerKey]<br/>                          , ‘Customer’[CustomerKey]<br/>                          )</span><span id="ae67" class="nn lb it nj b gy nt np l nq nr">RETURN<br/>    Result</span></pre><p id="c55f" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我可以使用这种方法从计算的DAX表中添加以下列:</p><ul class=""><li id="0d3f" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">按销售额排名</li><li id="3129" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">是前10%</li><li id="c488" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">每位客户的总销售额</li></ul><h1 id="e219" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">解决方案2-本地计算的列</h1><p id="62f3" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">使用这种方法，我创建了几个包含中间结果的计算列来获得最终结果。</p><ol class=""><li id="727a" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn nv mz na nb bi translated">每位客户的总销售额:</li></ol><p id="ef93" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">要获得每个客户的总销售额，我需要使用现有的方法[在线销售额(按订单日期)]:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="040a" class="nn lb it nj b gy no np l nq nr">Total Sales per Customer = [Online Sales (By Order Date)]</span></pre><p id="46fa" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">当我们在行上下文中使用一个度量时，DAX开始一个上下文转换，这足以获得每个客户的销售总额。</p><p id="57d7" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">2.计算每个客户的排名</p><p id="267a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我需要列[每个客户的总销售额]来计算排名。</p><p id="8892" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">与第一个解决方案一样，我使用RANKX来完成这项工作:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="e818" class="nn lb it nj b gy no np l nq nr">Rank by Sales (local) = RANKX(‘Customer’<br/>                              ,’Customer’[Total Sales per Customer])</span></pre><p id="b517" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">3.按销售额设定前10 %的客户</p><p id="7b8a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">最后，我可以使用与之前相同的逻辑来查找当前客户是否在总销售额前10 %的客户中:</p><pre class="kk kl km kn gt ni nj nk nl aw nm bi"><span id="e4df" class="nn lb it nj b gy no np l nq nr">Is Top 10 Percent (local) =</span><span id="5c14" class="nn lb it nj b gy nt np l nq nr">VAR MaxRank = MAXX( ‘Customer’<br/>                    ,[Rank by Sales (local)]<br/>                    )</span><span id="21d0" class="nn lb it nj b gy nt np l nq nr">VAR Result = IF(<br/>                DIVIDE( [Rank by Sales (local)]<br/>                        , MaxRank ) &lt;= 0.1<br/>                  ,TRUE()<br/>                  ,FALSE()<br/>                  )</span><span id="c3da" class="nn lb it nj b gy nt np l nq nr">RETURN<br/>    Result</span></pre><p id="a18a" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">如您所见，这两种解决方案使用相同的基本逻辑，但技术略有不同。</p><p id="5ac8" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">你想用哪个由你决定。</p><p id="0be0" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">两种解决方案的结果是相同的:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nz"><img src="../Images/82b7fecc3e2c65dcb78e4f4f4ecfee70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EXDEwrcLA6KOCJxC3zunHQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图6 —带有排名和前10%标志的客户列表</p></figure><p id="d070" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">解决方案1是我的第一个方法，因为它看起来更容易做到。我隐藏了计算表，因为在我将所有列都包含到Customer表中之后，它就没有用了。但是，我不喜欢模型中有不必要的对象，所以我想出了没有DAX表的情况下如何解决需求。</p><h1 id="528a" class="la lb it bd lc ld le lf lg lh li lj lk jz ll ka lm kc ln kd lo kf lp kg lq lr bi translated">结论</h1><p id="170b" class="pw-post-body-paragraph ls lt it lu b lv lw ju lx ly lz jx ma mb mc md me mf mg mh mi mj mk ml mm mn im bi translated">上下文转换是DAX中一个复杂但非常有用的特性。这个功能可以比你不知道怎么用的时候更快的帮你解决问题。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oa"><img src="../Images/b603c918083812cb8562455032558164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z2jvqYBLoqgfmbMA"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">米歇尔·玛特隆在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="6e23" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">但是它有一些重要的怪癖，你需要知道:</p><ul class=""><li id="2417" class="mt mu it lu b lv mo ly mp mb mv mf mw mj mx mn my mz na nb bi translated">背景转换在措施上是缓慢的</li><li id="f946" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">上下文转换所使用的表中的重复行(上面例子中的“在线销售”事实表)可能会导致错误的结果，这是很难发现的。</li><li id="9c54" class="mt mu it lu b lv nc ly nd mb ne mf nf mj ng mn my mz na nb bi translated">您需要知道上下文转换何时发生:总是在您遍历行、使用度量或者使用CALCULATE()时</li></ul><p id="c6ee" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">我鼓励您阅读下面的SQL文章<a class="ae kz" href="https://www.sqlbi.com/articles/understanding-context-transition/" rel="noopener ugc nofollow" target="_blank">了解上下文转换——SQL bi</a>来学习基础知识。</p><p id="e654" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">您可以阅读文章<a class="ae kz" href="https://www.sqlbi.com/articles/context-transition-and-filters-in-calculate/" rel="noopener ugc nofollow" target="_blank">CALCULATE-SQLBI中的上下文转换和过滤器</a>来了解CALCULATE中的上下文转换。</p><p id="a28e" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">阅读本文<a class="ae kz" href="https://www.burningsuit.co.uk/blog/2021/08/context-transition-where-the-row-context-becomes-a-filter-context/" rel="noopener ugc nofollow" target="_blank">https://www . burning suit . co . uk/blog/2021/08/context-transition-where-the-row-context-become-a-filter-context/</a>，其中包含了对上下文转换的完整解释，包括使用上下文转换时需要考虑的事项</p><p id="c33b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated">这里有更多关于这个重要话题的文章和博客:</p><p id="da22" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><a class="ae kz" href="https://blog.enterprisedna.co/power-bi-filters-invoking-context-transitions/" rel="noopener ugc nofollow" target="_blank">https://blog . enterprise DNA . co/power-bi-filters-invoking-context-transitions/</a></p><p id="7a7b" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><a class="ae kz" href="https://blog.enterprisedna.co/iterators-and-context-transitions-in-dax-queries/" rel="noopener ugc nofollow" target="_blank">https://blog . enterprise DNA . co/iterators-and-context-transitions-in-DAX-queries/</a></p><p id="19a9" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><a class="ae kz" href="https://blog.enterprisedna.co/dax-calculation-filter-context-transitions/" rel="noopener ugc nofollow" target="_blank">https://blog . enterprise DNA . co/DAX-calculation-filter-context-transitions/</a></p><p id="0cb5" class="pw-post-body-paragraph ls lt it lu b lv mo ju lx ly mp jx ma mb mq md me mf mr mh mi mj ms ml mm mn im bi translated"><a class="ae kz" href="https://community.powerbi.com/t5/Community-Blog/DAX-Context-Transition-Why-it-can-be-handy-to-use-a-Measure/ba-p/1133639" rel="noopener ugc nofollow" target="_blank">https://Community . power bi . com/T5/Community-Blog/DAX-Context-Transition-Why-it-can-hand-to-use-a-Measure/ba-p/1133639</a></p></div></div>    
</body>
</html>