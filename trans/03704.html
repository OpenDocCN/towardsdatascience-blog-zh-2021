<html>
<head>
<title>Interpolating NYC Bike Share Data to Discover Rebalancing Movements</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">内插纽约市自行车共享数据以发现再平衡运动</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/interpolating-nyc-bike-share-data-to-discover-rebalancing-movements-6cf8a80eb902?source=collection_archive---------15-----------------------#2021-03-26">https://towardsdatascience.com/interpolating-nyc-bike-share-data-to-discover-rebalancing-movements-6cf8a80eb902?source=collection_archive---------15-----------------------#2021-03-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3a78" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Pandas concat重构花旗自行车出行数据</h2></div><p id="9ddc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了确保在需要时有自行车(和码头)可用，像大多数自行车共享系统一样，<em class="lb">重新平衡</em>或将自行车从过多的地方转移到需要的地方。Citi Bike没有披露自行车何时何地被移动的数据，但事实证明这些移动是可以被发现的。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/0ec860a45aa1955ccae6909ca6fa2b82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RXIUHmC4WMTtoXuztko7ZQ.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">几乎空无一人的花旗自行车站——作者照片</p></figure><p id="51d0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文是对花旗自行车提供的自行车份额数据的一系列探索的一部分。如果你觉得这篇文章很有趣，你可能也想看看:</p><p id="e03e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae ls" rel="noopener" target="_blank" href="/exploring-bike-share-data-3e3b2f28760c">探索纽约市自行车共享数据</a> —介绍数据准备和分析以及如何开始使用所使用的工具:Jupyter、Python、Pandas和Seaborn。</p><p id="7f29" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae ls" rel="noopener" target="_blank" href="/reverse-geocoding-with-nyc-bike-share-data-cdef427987f8">使用NYC Bike Share数据进行反向地理编码</a> —这是一个关于如何增加Citi Bike提供的区、社区和邮政编码数据的教程。</p><p id="cfed" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae ls" rel="noopener" target="_blank" href="/exploring-the-effects-of-the-pandemic-on-nyc-bike-share-usage-ab79f67ac2df">探索疫情对纽约市自行车共享使用的影响</a> —查看两年的数据以及在此期间骑行人数的变化。</p><h1 id="fda8" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">下载花旗自行车旅行数据</h1><p id="7277" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">Citi Bike提供tripdata文件，这样任何人都可以分析该系统是如何使用的。<a class="ae ls" href="https://www.citibikenyc.com/system-data" rel="noopener ugc nofollow" target="_blank">花旗自行车系统数据</a>页面描述了所提供的信息。每个文件包含一个月的数据；每条记录代表一次旅行。</p><p id="1273" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于这篇文章，我使用的是2020年9月的tripdata文件。在疫情最初几个月的下降之后，使用率已经恢复，这是迄今为止最繁忙的一个月。</p><p id="dcfe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Windows上，使用上面的链接找到并下载纽约9月份的tripdata文件，然后将其放到一个<code class="fe mq mr ms mt b">bikeshare</code>目录中。</p><p id="0068" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Linux上，从命令提示符下创建一个<code class="fe mq mr ms mt b">bikeshare</code>目录，下载tripdata文件，将其解压缩，然后删除zip文件。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="4790" class="my lu iq mt b gy mz na l nb nc">mkdir bikeshare &amp;&amp; cd bikeshare <br/>wget <a class="ae ls" href="https://s3.amazonaws.com/tripdata/202003-citibike-tripdata.csv.zip" rel="noopener ugc nofollow" target="_blank">https://s3.amazonaws.com/tripdata/202009-citibike-tripdata.csv.zip</a><br/>unzip 202009-citibike-tripdata.csv.zip<br/>rm 2020009-citibike-tripdata.csv.zip</span></pre><h1 id="87f8" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">导入库和数据</h1><p id="dd8b" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">启动Jupyter，从浏览器窗口在你的<code class="fe mq mr ms mt b">bikeshare</code>目录下创建一个新的笔记本。本文中使用的带有Python代码的Jupyter笔记本在GitHub上的名称是<a class="ae ls" href="https://github.com/ckran/bikeshare/blob/main/rebalancing.ipynb" rel="noopener ugc nofollow" target="_blank"> rebalancing.ipynb </a>。</p><p id="ffcb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">导入常用库:用于分析的<strong class="kh ir"> Pandas </strong>和用于图表的<strong class="kh ir"> Seaborn </strong>。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="f28c" class="my lu iq mt b gy mz na l nb nc">import pandas as pd<br/>from pandas import to_datetime<br/>import seaborn as sns<br/>import matplotlib.pyplot as plt</span></pre><p id="f093" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将花旗自行车旅行数据文件读入熊猫数据帧。对于这种分析，我们只需要开始和结束站ID和时间。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="aa50" class="my lu iq mt b gy mz na l nb nc">df = pd.read_csv('~/bikeshare/202009-citibike-tripdata.csv',\<br/>     usecols=['starttime','start station id',\<br/>              'stoptime','end station id','bikeid'],\<br/>     parse_dates=['starttime','stoptime'])<br/>df.info()</span></pre><p id="dac8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我看到9月份有将近200万人次。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/bfe26236348992e6c3851f40e274d2b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/1*3u01sGmztOl3au-qwR7V5A.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">所选列的Tripdata信息</p></figure><h1 id="8ad8" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">幽灵骑士</h1><p id="ec6a" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">Citi Bike是一个传统系统，用户从一个站点取车，然后在另一个站点下车。</p><p id="6f37" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当分析行程数据文件时，如果我创建一个新的数据帧并按<code class="fe mq mr ms mt b">bikeid</code>和<code class="fe mq mr ms mt b">starttime</code>排序，我可以跟踪每辆自行车在系统中从一个站点到另一个站点的运动。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="4eed" class="my lu iq mt b gy mz na l nb nc">dfbike=df.sort_values(by=['bikeid','starttime'])<br/>dfbike.head(10)</span></pre><p id="6c23" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我可以在一个月内跟踪自行车的行程。一次乘坐的<code class="fe mq mr ms mt b">end station id</code>(几乎)总是下一次乘坐的<code class="fe mq mr ms mt b">start station id</code>。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/730ca6365575386333ae95d5ada88f5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*jYLQeBjJ6K3nLBXL1jaugw.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">按bikeid和开始时间排序的行程-按作者排序的图片</p></figure><p id="35d4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果不一样，那么这辆自行车(不知何故)在两次骑行之间从一个站移动到了另一个站。</p><p id="7de7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然我可以通过循环遍历数据帧并比较每次旅行和下一次旅行来找到这些“幽灵之旅”，但有近200万次旅行需要一段时间。</p><p id="74d2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">更好的方法是利用Panda的矢量运算，创建一个包含成对游乐设施的数据框架。</p><p id="6039" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我将创建一个带有单个虚拟记录的<code class="fe mq mr ms mt b">offset</code>数据帧:</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="a005" class="my lu iq mt b gy mz na l nb nc">offset = pd.DataFrame({'starttime': pd.to_datetime('2010-09-01'),\<br/>  'start station id':0,'stoptime': pd.to_datetime('2010-09-01'),\<br/>  'end station id':0,'bikeid':0},index=[0])</span></pre><p id="6986" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后创建两个新的数据帧，一个先使用偏移量，一个最后使用偏移量:</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="e6f9" class="my lu iq mt b gy mz na l nb nc">dfbike1 = pd.concat([offset,dfbike]).reset_index(drop=True)<br/>dfbike2 = pd.concat([dfbike,offset]).reset_index(drop=True)</span></pre><p id="4606" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe mq mr ms mt b">axis=1</code>并排组合这两个数据帧</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="4924" class="my lu iq mt b gy mz na l nb nc">dfbike=pd.concat ([dfbike1[['bikeid','stoptime','end station id']]\<br/>            ,dfbike2[['bikeid','starttime','start station id']] ],\<br/>             axis=1 )<br/>dfbike.head()</span></pre><p id="4649" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里每条记录代表一辆自行车停靠的时间段。我可以看到一趟车在388站结束，下一趟车从同一个站开始。然后它停靠在480号站，依此类推。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/677b7cbd5d1f7429803905fbe2fc34dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*5cGBXPRo8FMINDG41Ut9NQ.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片</p></figure><p id="372c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是当我追踪这辆自行车的行程时，我发现有一天这辆自行车被移动了！它前一天停靠在3906站，第二天在4123站被取走。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/9e6dd9d979d119d0358e82fa6e72abbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/1*WtlUxixAzofR6DU2rOP3VA.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">作者图片</p></figure><p id="cb5c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了检测这些运动，我想创建一个这些“幽灵游乐设施”的数据框架，就好像它们是真实的游乐设施一样。这需要交换起止名称。然后我选择那些<code class="fe mq mr ms mt b">bikeid</code>相同但<code class="fe mq mr ms mt b">station id</code>值不同的记录。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="27fc" class="my lu iq mt b gy mz na l nb nc">dfbike.columns=['bikeid1','starttime','start station id',\<br/>                'bikeid2','stoptime','end station id']<br/>dfrebal = dfbike[['starttime','start station id',\<br/>                  'stoptime','end station id']].\<br/>           loc[(dfbike.bikeid1==dfbike.bikeid2) &amp; \<br/>          (dfbike['start station id'] != dfbike['end station id']) ]<br/>dfrebal.reset_index(drop=True, inplace=True)<br/>dfrebal</span></pre><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/b17966ef605137ff0362f73037583df1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*lHSJ6__80h_UA93WKmZlTA.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">2020年9月的再平衡运动—作者图片</p></figure><p id="f900" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个数据帧的每一行都代表一辆自行车，出于重新平衡、维修或其他目的，这辆自行车不知何故从一个站点移动到了另一个站点。</p><p id="c197" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我有了这个数据框架，我将把它保存为一个拼花文件，这样我就可以在我的下一篇文章<a class="ae ls" rel="noopener" target="_blank" href="/estimating-bike-availability-from-nyc-bike-share-data-7cfc4655d5f6">中使用它，根据纽约市自行车共享数据</a>估计自行车共享可用性。</p><blockquote class="ni nj nk"><p id="220c" class="kf kg lb kh b ki kj jr kk kl km ju kn nl kp kq kr nm kt ku kv nn kx ky kz la ij bi translated">这需要pyarrow(安装者:<code class="fe mq mr ms mt b">conda install -c conda-forge pyarrow</code>)</p></blockquote><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="2adb" class="my lu iq mt b gy mz na l nb nc">dfrebal.to_parquet('202009-citibike-reblance.parquet')</span></pre><p id="92c8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，上面的报告显示，9月份有近4万辆自行车被重新平衡。这个数字合理吗？</p><p id="6ad6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae ls" href="https://www.citibikenyc.com/system-data/operating-reports" rel="noopener ugc nofollow" target="_blank">花旗自行车每月运营报告</a>页面有每月运营报告的链接。对于2020年9月，它说:</p><blockquote class="ni nj nk"><p id="878a" class="kf kg lb kh b ki kj jr kk kl km ju kn nl kp kq kr nm kt ku kv nn kx ky kz la ij bi translated">九月份，花旗自行车员工重新平衡了总共51，179辆自行车…利用箱式卡车、货车、合同三轮车、铰接三轮车(“自行车列车”)、服务员和会员奖励(“自行车天使”)在全系统范围内重新分配自行车。</p></blockquote><p id="e9c1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，尽管官方统计的超过51179人比我发现的要高，但这也包括“自行车天使”的骑行，他们是为了重新平衡而被激励骑自行车的成员。这些游乐设施将在tripdata文件中显示为“常规”游乐设施。我会说我的衍生计数<em class="lb">足够接近政府工作</em>。</p><h1 id="fab9" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">哪些站得到重新平衡？</h1><p id="783f" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">现在我知道有多少自行车被重新平衡，我想知道哪些站有最多的重新平衡。</p><p id="cc09" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">站名比数字站名更有意义，所以我将返回到tripdata文件并创建一个站名和站名的表。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="5a32" class="my lu iq mt b gy mz na l nb nc">dfstations = \<br/>  pd.read_csv('~/bikeshare/202009-citibike-tripdata.csv',\<br/>  usecols=['start station id','start station name']).\<br/>  drop_duplicates()                <br/>dfstations.columns=['station id','station name']<br/>dfstations.set_index('station id',drop=True, inplace=True)</span></pre><p id="e6d1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将使用熊猫<code class="fe mq mr ms mt b">merge</code>来获取起点和终点站名。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="6ad3" class="my lu iq mt b gy mz na l nb nc">dfrebal = pd.merge(dfrebal, dfstations[['station name']],\<br/>     how = 'left', left_on='start station id', right_on='stationid')<br/>dfrebal = pd.merge(dfrebal, dfstations[['station name']],\<br/>     how = 'left', left_on='end station id', right_on='stationid')</span></pre><p id="0675" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并根据生成的默认值重命名列名。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="5702" class="my lu iq mt b gy mz na l nb nc">dfrebal.rename(columns = <br/>        {'station name_x':'start station name',\<br/>         'station name_y':'end station name'},\<br/>          inplace = True)</span></pre><p id="c98c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建两个系列，前20个站点都有自行车进出。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="7a52" class="my lu iq mt b gy mz na l nb nc">rebalin = dfrebal['end station name'].value_counts()[:20]<br/>rebalout = dfrebal['start station name'].value_counts()[:20]</span></pre><p id="4ba5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用<code class="fe mq mr ms mt b">barplot</code>显示前20个站点中从<em class="lb">移出</em>的自行车总数，同样也显示移入<em class="lb">的自行车总数。</em></p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="90ba" class="my lu iq mt b gy mz na l nb nc">plt.figure(figsize=(10,8))<br/>plt.title('Citi Bike Rebalancing - September 2020\<br/> - Top 20 Stations bikes moved OUT'  ) <br/>plt.xlabel('Count of bikes moved') <br/>sns.barplot( x=rebalout.values, y=rebalout.index,  orient="h" ) ;</span></pre><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi no"><img src="../Images/d685a5d853dfdd1bc89f22b6e98ac4c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ufbxV0uSZpiN52yda1XZGg.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">搬出的自行车数量-图片由作者提供</p></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi np"><img src="../Images/be58b90d17ee56aec250468cabc73c66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qipp876yLZq7EXXhzlCv_w.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">移入的自行车数量-图片由作者提供</p></figure><p id="9d4c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在查看了按站点移动的自行车数量后，我意识到按<em class="lb">街区</em>查看数量会更有趣。Citi Bike不按街区识别站点，但正如我在之前的文章<a class="ae ls" rel="noopener" target="_blank" href="/reverse-geocoding-with-nyc-bike-share-data-cdef427987f8?source=your_stories_page-------------------------------------">中描述的，使用NYC Bike Share数据进行反向地理编码</a>可以使用所提供的纬度和经度来实现。有关创建这些图表的步骤，请参见Jupyter笔记本<a class="ae ls" href="https://github.com/ckran/bikeshare/blob/main/rebalancing.ipynb" rel="noopener ugc nofollow" target="_blank"> rebalancing.ipynb </a>。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nq"><img src="../Images/bd022c20e7aadba4fa8517dc9001140d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K2Nl1AwdE3JYPROq1QRCyA.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">邻域计数-按作者分类的图像</p></figure><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nr"><img src="../Images/a107b21b98312cb904c11a8bd0d62c6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KWlj9Ljy-YgEZKzvzel0xw.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">邻域计数-按作者分类的图像</p></figure><p id="a1d8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">图表显示，自行车更经常从市中心的车站移出，主要是商业区；而自行车被转移到住宅区和市中心区的车站。</p><h1 id="a9c6" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">按一天中的时间重新平衡</h1><p id="a512" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">再平衡何时发生？花旗自行车无法提供这些信息，也无法从tripdata文件中确定。我知道在自行车被移动之前<em class="lb">自行车被丢弃的时间，以及在</em>自行车被移动之后<em class="lb">第一次被取走的时间，但是实际的移动可能发生在两者之间的任何时间，甚至相隔几天。因为这是我所有的数据，所以我将使用它。</em></p><p id="6a28" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先添加与记录时间相对应的<em class="lb">小时</em>栏。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="1d40" class="my lu iq mt b gy mz na l nb nc">dfrebal['starthour'],dfrebal['endhour'] = \<br/>    dfrebal.starttime.dt.hour, dfrebal.stoptime.dt.hour</span></pre><p id="a171" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要创建一个显示每小时进出的自行车数量的条形图，我可以使用<code class="fe mq mr ms mt b">countplot</code>但是没有每小时重新平衡，所以图表缺少了条形。相反，我可以先进行计数，当没有运动时，计数为零。</p><p id="0194" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这让我可以看到一个宽格式的计数，每个站一行，一天中每个小时一列。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="225e" class="my lu iq mt b gy mz na l nb nc">pd.set_option('display.max_columns', 24)<br/>dfrebal.value_counts(subset=['start station id', 'starthour'])\<br/>        .unstack().astype('Int64').fillna(0).head(10)</span></pre><p id="e449" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有很多东西需要解释，所以我将把它们分解开来:</p><ul class=""><li id="26c8" class="ns nt iq kh b ki kj kl km ko nu ks nv kw nw la nx ny nz oa bi translated"><code class="fe mq mr ms mt b">.value_counts(subset=['start station id', 'starthour'])</code>通过<code class="fe mq mr ms mt b">start station id</code>和<code class="fe mq mr ms mt b">starthour</code>统计行程次数。</li><li id="2c7f" class="ns nt iq kh b ki ob kl oc ko od ks oe kw of la nx ny nz oa bi translated"><code class="fe mq mr ms mt b">.unstack()</code>将<code class="fe mq mr ms mt b">starthour</code>从行转到列。当一个小时没有乘坐时，填写<code class="fe mq mr ms mt b">NaN</code>(不是一个数字)。</li><li id="b299" class="ns nt iq kh b ki ob kl oc ko od ks oe kw of la nx ny nz oa bi translated"><code class="fe mq mr ms mt b">.astype('Int64')</code>每当有<code class="fe mq mr ms mt b">NaN</code>值时，Pandas会将数据转换为<code class="fe mq mr ms mt b">float64</code>，这不适用于<em class="lb">计数</em>。这将数据转换回整数格式<code class="fe mq mr ms mt b">Int64</code>，缺失值表示为<code class="fe mq mr ms mt b">&lt;NA&gt;</code>。</li><li id="601c" class="ns nt iq kh b ki ob kl oc ko od ks oe kw of la nx ny nz oa bi translated"><code class="fe mq mr ms mt b">.fillna(0)</code>用零替换缺失值或<code class="fe mq mr ms mt b">&lt;NA&gt;</code>值。</li><li id="6e76" class="ns nt iq kh b ki ob kl oc ko od ks oe kw of la nx ny nz oa bi translated"><code class="fe mq mr ms mt b">.head(10)</code>显示前十行。</li></ul><p id="b76b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该语句生成一个类似于这样的内容广泛的报告，由<code class="fe mq mr ms mt b">start station id</code>和<code class="fe mq mr ms mt b">starthour</code>组成。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi og"><img src="../Images/274e5c77066d8bc5971d1c4d0fe0887e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cNU_9ZucpnvroYrHSGVMXA.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">一小时内按站点显示的重新平衡计数的详细报告-按作者显示的图片</p></figure><p id="cfc2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后一步是使用<code class="fe mq mr ms mt b">stack()</code>将数据转换回长格式，我将为进出车站的自行车做这件事。</p><p id="a935" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将数据从一个系列转换为一个数据帧，并添加一个新列<code class="fe mq mr ms mt b">Movement</code>来指示移动的方向(向内或向外),并将两个数据帧连接成一个数据帧，以便在一个图表中轻松显示两种类型的移动。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="4f51" class="my lu iq mt b gy mz na l nb nc">startcounts = \<br/>    dfrebal.value_counts(subset=['start station id','starthour'])\<br/>   .unstack().astype('Int64').fillna(0).stack()<br/>startcounts=pd.DataFrame(startcounts).assign(Movement='Out')</span><span id="c03c" class="my lu iq mt b gy oh na l nb nc">endcounts = \<br/>    dfrebal.value)counts(subset=['end station id', 'endhour'])\<br/>   .size().astype('Int64').unstack().fillna(0).stack()<br/>endcounts=pd.DataFrame(endcounts).assign(Movement='In')</span><span id="f190" class="my lu iq mt b gy oh na l nb nc">rebalcounts=pd.concat([startcounts, endcounts])<br/>rebalcounts.columns=['Bike Count','Movement']</span></pre><p id="b8fc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了创建多个站点的图表，我将生成图表的代码放入一个函数中。它需要两个数据帧<code class="fe mq mr ms mt b">stationrebal</code>和<code class="fe mq mr ms mt b">dfstations</code>，并以一个站名作为参数。</p><pre class="ld le lf lg gt mu mt mv mw aw mx bi"><span id="7ef0" class="my lu iq mt b gy mz na l nb nc">def stationrebal (stationname):<br/>    plt.figure(figsize=(12,5))<br/>    if stationname not in list(dfstations['station name']):<br/>        raise RuntimeError("Station name not found.")<br/>    plt.suptitle('Citi Bike Rebalanancing - ' +  stationname   )         <br/>    ax=sns.barplot(data=rebalcounts.loc[station], \<br/>                x=list(rebalcounts.loc[station].index),\<br/>                y="Bike Count", hue="Movement" ,\<br/>                palette=["darkred", "darkgreen"], edgecolor = 'w')  <br/>    ax.set(xlabel="Hour of Day", ylabel = "Count of bikes moved") ;</span></pre><p id="38cf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是为重新平衡而拆除自行车最多的车站的图表:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oi"><img src="../Images/57fd80c9c4818997ae4ab0e244cc3cee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vyl3RxiOqq5wjuy2vT2SRw.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">搬出去的自行车顶站——作者图片</p></figure><p id="3e9b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个车站位于苏荷区的中间，这里既是住宅区又是零售区。图表显示，自行车大多是从<em class="lb">这个车站</em>移出的，上午有一些，下午有很多。</p><p id="4a94" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是增加自行车最多的车站:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oj"><img src="../Images/ce1060d81679542d924010e7d5dfb436.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o2HVjl6dIW1nz9liTgu4Kw.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">搬进来的自行车顶站—作者图片</p></figure><p id="9f9a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这个主要的居民区，图表显示自行车在早上被移入车站，下午较少。</p><h1 id="61e2" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">结论</h1><p id="f051" class="pw-post-body-paragraph kf kg iq kh b ki ml jr kk kl mm ju kn ko mn kq kr ks mo ku kv kw mp ky kz la ij bi translated">尽管Citi Bike不提供出于重新平衡和其他目的手动移动自行车的信息，但可以通过查看单辆自行车的移动以及它们在没有骑行的情况下位置发生变化的情况，从tripdata中获得这些信息。</p><p id="106a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些信息总体上(按邻域)比单个站点更有意义。</p><p id="7624" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过查看自行车何时被带走，我们可以大致了解自行车何时在车站被重新平衡。</p></div></div>    
</body>
</html>