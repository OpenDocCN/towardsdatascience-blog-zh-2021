<html>
<head>
<title>Fully Automating Your ML Pipelines With the AWS CI/CD Tools</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS CI/CD工具完全自动化您的ML管道</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/fully-automating-your-ml-pipelines-with-the-aws-ci-cd-tools-bfc337aa77c3?source=collection_archive---------18-----------------------#2021-07-18">https://towardsdatascience.com/fully-automating-your-ml-pipelines-with-the-aws-ci-cd-tools-bfc337aa77c3?source=collection_archive---------18-----------------------#2021-07-18</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="e536" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">利用可信的DevOps工具集构建自动化MLOps管道的指南。</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/58fd9aa140859c6536318b4041c301c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L9WS7oRJfgPTShEG"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kz" href="https://unsplash.com/@scienceinhd?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">科学高清</a>拍摄的照片</p></figure><p id="cd13" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在过去的几年里，由于谷歌和脸书等公司的进步，以及开源社区的贡献，机器学习(ML)的受欢迎程度呈指数级增长。由于它可以应用于非常广泛的用例，几乎世界上的每个公司都开始利用ML并将其集成到其流程中。</p><p id="074f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这种大规模采用ML最初缺少一个关键部分:<strong class="lc iv">自动化</strong>。即使ML系统基本上是软件系统，它们之间的细微差别，例如ML本质上是实验性的，使得一些最初的采用者在构建他们的ML系统时放弃了DevOps原则——即使DevOps已经是其他软件系统的标准。</p><p id="5679" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这为人工智能平台向其客户提供MLOps功能创造了空间，允许他们通过应用CI/CD原则来自动化其ML管道。在本文中，我们的目标是展示如何通过依赖大多数云提供商提供的工具，将我们在DevOps管道中日常使用的CI/CD原则应用到ML管道中。我们将在本文中讨论AWS工具，但大多数其他云提供商也提供类似的功能。</p><h1 id="f181" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">首先:把代码放在一个地方</h1><p id="77ac" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">是的，ML本质上是实验性的，所以应用源代码控制可能不像对其他软件系统那样简单。但是，一旦你开始将你的ML代码库的不同组件(从预处理、训练或后处理脚本，到你的实验笔记本)集中在一个主要服务中，你将开始收获好处:协作将变得更加无缝，并且你将确保代码质量。</p><p id="2729" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">与其他软件系统不同，对ML来说，对代码进行版本控制只是工作的一半，因为管道也依赖于数据集。理想情况下，你不希望通过你的源代码控制服务来版本化你的数据集，所以你可以利用<a class="ae kz" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Versioning.html" rel="noopener ugc nofollow" target="_blank">S3</a>提供的版本化功能。这样，无论何时新的数据集到达，您都可以确定您将在管道中使用它，同时还可以跟踪数据的确切版本。至于笔记本，你可以使用像<a class="ae kz" href="https://github.com/mwouts/jupytext" rel="noopener ugc nofollow" target="_blank"> Jupytext </a>这样的工具，让它们更容易在你的版本控制服务上工作。</p><p id="c59d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这一步还将允许您定义最适合您的项目的分支策略，以及您决定如何组织它们。无论您决定使用AWS CodeCommit还是其他提供者，如GitHub或GitLab，都不会真正影响管道的其余部分，因为我们将要讨论的工具提供了大多数主流源代码控制服务的连接器。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj mt"><img src="../Images/f74203b30088f39bdb3be920d3acc414.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g-Mc06jim_vftWPQ5iJzrQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">管道的当前版本:版本化代码和数据集</p></figure><h1 id="73c1" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">AWS代码管道:更大的图景</h1><p id="56b9" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">构建我们的MLOps管道的最佳起点实际上是定义管道本身，即使不同的组件仍然没有准备好。AWS CodePipeline是AWS持续交付产品中经常被忽视的核心部分，有了它，您将能够构建一个实际的MLOps管道，在不同的AWS服务上运行和编排步骤。</p><p id="8956" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">除了与大多数AWS服务(包括我们将为该管道利用的所有工具)集成之外，CodePipeline还提供了与大多数源代码控制服务的连接器，这意味着您可以配置一个webhook，允许它在推送到主分支之后或合并拉请求时(取决于您希望管道运行的频率)检索项目的新版本。</p><p id="b7a3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">既然我们可以基于适合用例的事件来触发管道，我们就已经可以定义管道的不同步骤了:</p><ol class=""><li id="9717" class="mu mv iu lc b ld le lg lh lj mw ln mx lr my lv mz na nb nc bi translated">当有我们想要触发管道的事件时，从我们的源代码控制服务中检索代码(这已经由CodePipeline在一个专用的源代码步骤中处理了)。</li><li id="4707" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv mz na nb nc bi translated">对数据运行预处理脚本(这是可选的，可以独立于此管道发生)。</li><li id="d2f5" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv mz na nb nc bi translated">使用最新版本的训练脚本来训练ML模型。</li><li id="a9f9" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv mz na nb nc bi translated">评估我们的新模型并测试其性能。</li><li id="62f6" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv mz na nb nc bi translated">如果模型在性能方面满足一定的标准，则部署该模型。</li></ol><p id="0f3b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这个阶段，我们已经定义了CodePipeline中的不同步骤，现在让我们看看如何实现它们。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj mt"><img src="../Images/49771545332515cde60a6fc710952f9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8WYEeGE6Xoc5ew2r2xlLyQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">管道的当前版本:通过AWS代码管道定义的步骤，初始源步骤包括检索代码和数据</p></figure><h1 id="9b9c" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">AWS代码构建:您的瑞士军刀</h1><p id="8744" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">我们模型的训练、评估和部署需要在一个包含所有必要包(无论是开源库还是定制的内部包)的环境中进行，这样我们不同的脚本就可以运行而不会出现任何问题或意外。</p><p id="7ade" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">使用容器是对这种需求的直接回答，它允许我们为管道中的不同步骤高效地构建可预测的环境。幸运的是，AWS提供了CodeBuild，这是一种持续集成服务，我们可以利用它为我们的三个主要步骤中的每一个步骤推送Docker容器。</p><p id="d783" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这种设计为我们的不同步骤提供了极大的灵活性，因为我们可以指定每个容器的包列表以及我们希望如何执行我们的脚本。CodeBuild需要做的唯一额外工作是为每个作业提供<a class="ae kz" href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html" rel="noopener ugc nofollow" target="_blank">一个</a> <code class="fe ni nj nk nl b"><a class="ae kz" href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html" rel="noopener ugc nofollow" target="_blank">buildspec</a></code> <a class="ae kz" href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html" rel="noopener ugc nofollow" target="_blank">脚本</a>，其中我们指定了构建Docker映像要执行的命令。在<code class="fe ni nj nk nl b">buildspec</code>脚本中，我们还将图像推送到<a class="ae kz" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank"> ECR </a>，AWS容器注册表。</p><p id="de5f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，对于我们的三个主要步骤中的每一个，我们都有一个容器映像来表示执行该步骤的合适环境——但是我们可以在哪里运行这些容器呢？</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj mt"><img src="../Images/e5ac7d1f146af6596d4805ef081d348f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l97hNQ1iM1KSB32qiLmQCg.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">管道的当前版本:CodeBuild允许我们为管道的每一步构建一个专用的Docker映像</p></figure><h1 id="186c" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">AWS SageMaker:奇迹发生的地方</h1><p id="d9bb" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">SageMaker，Amazon的通用ML平台，允许我们在ML优化的实例上运行不同的容器。SageMaker还为我们的不同步骤提供专用组件:</p><ul class=""><li id="bc8a" class="mu mv iu lc b ld le lg lh lj mw ln mx lr my lv nm na nb nc bi translated">SageMaker培训任务:它们允许我们无缝运行培训任务并生成模型。</li><li id="0b3c" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv nm na nb nc bi translated"><a class="ae kz" href="https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_ProcessingJob.html" rel="noopener ugc nofollow" target="_blank"> SageMaker加工作业</a>:非常适合模型评估任务。例如，我们可以使用测试数据集评估模型，然后在我们的跟踪工具上记录一组指标。</li><li id="f4e5" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv nm na nb nc bi translated"><a class="ae kz" href="https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_CreateEndpoint.html" rel="noopener ugc nofollow" target="_blank"> SageMaker端点</a>:它们允许我们轻松地部署我们的服务模型。</li></ul><p id="2528" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">多亏了这些工具，我们现在可以运行我们专用的容器映像来训练模型、评估它，然后部署它来提供服务。我们的ML难题中唯一剩下的部分是增加从CodePipeline触发这些不同的SageMaker组件的能力。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj mt"><img src="../Images/41e62f22d06221ce01d762df739b3e96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b5580EpkT5B_NJASh9zAFg.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">管道的当前版本:我们运行培训作业、模型评估，然后在SageMaker上部署</p></figure><h1 id="3d69" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">AWS Lambda:将点连接起来</h1><p id="3d71" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">Lambda函数是AWS上使用最广泛的服务之一。这主要归功于它们的多功能性、简单性以及作为无服务器计算服务提供的便利性。</p><p id="5ecf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">对于我们的MLOps管道，可以有效地利用Lambda函数来触发不同的SageMaker作业，在必要时执行附加操作，并在管道内将参数从一个步骤传递到另一个步骤。</p><p id="c5a5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">例如，在评估步骤中，我们可以使用Lambda函数来执行以下操作:</p><ul class=""><li id="df1e" class="mu mv iu lc b ld le lg lh lj mw ln mx lr my lv nm na nb nc bi translated">检索由训练步骤产生的模型的位置(在S3上)。</li><li id="2243" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv nm na nb nc bi translated">为我们的评估环境检索完整的Docker图像名称和标签(图像将由SageMaker从ECR中提取)。</li><li id="b1b1" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv nm na nb nc bi translated">通过传递所有必要的参数，触发SageMaker处理作业来运行评估。</li></ul><p id="0c24" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了将变量从一个步骤传递到另一个步骤，我们可以通过CodePipeline本身定义想要传递的元数据<a class="ae kz" href="https://docs.aws.amazon.com/codepipeline/latest/userguide/actions-variables.html" rel="noopener ugc nofollow" target="_blank">，然后我们可以从不同的Lambda函数中检索变量。</a></p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj mt"><img src="../Images/749769fd96c58390b0268c1482191697.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tsqdIUDq2oDl_ttXUvVqKA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">最终的管道:我们使用Lambda函数来触发不同的SageMaker组件，依赖于通过CodePipeline传递的变量</p></figure><h1 id="7974" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">结论</h1><p id="db61" class="pw-post-body-paragraph la lb iu lc b ld mo jv lf lg mp jy li lj mq ll lm ln mr lp lq lr ms lt lu lv in bi translated">建立一个自动化的MLOps管道是工业化ML工作流程和确保模型及时到达生产的必要条件。在本文中，我们展示了AWS提供的CI/CD工具是构建这种管道的合适选择。</p><p id="acdd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">与开箱即用的解决方案相比，这种方法所需的额外工作是为极度灵活性(因为管道可以轻松修改或更新)和与其他AWS服务的自然集成(例如，我们可以在几分钟内通过<a class="ae kz" href="https://aws.amazon.com/sns/" rel="noopener ugc nofollow" target="_blank"> SNS </a>添加通知)所付出的代价。</p><p id="d240" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">流水线本身也应该通过IaC(作为代码的基础设施)自动化，以确保可再现性和效率。文章中提到的所有资源都可以通过Terraform或CloudFormation创建。</p><p id="18fc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，以下资源提供了关于该设计不同组件的更多见解:</p><ul class=""><li id="17a4" class="mu mv iu lc b ld le lg lh lj mw ln mx lr my lv nm na nb nc bi translated"><a class="ae kz" href="https://cloud.google.com/architecture/mlops-continuous-delivery-and-automation-pipelines-in-machine-learning" rel="noopener ugc nofollow" target="_blank"> MLOps:机器学习中的连续交付和自动化管道</a></li><li id="eb01" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv nm na nb nc bi translated"><a class="ae kz" href="https://www.youtube.com/watch?v=hkwBymJhIqM&amp;ab_channel=AmazonWebServices" rel="noopener ugc nofollow" target="_blank"> AWS re:Invent 2018:使用CI/CD技术工业化机器学习</a></li><li id="b6b5" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv nm na nb nc bi translated"><a class="ae kz" href="https://aws.amazon.com/blogs/machine-learning/scheduling-jupyter-notebooks-on-sagemaker-ephemeral-instances/" rel="noopener ugc nofollow" target="_blank">在SageMaker短暂实例上调度Jupyter笔记本</a></li><li id="a85a" class="mu mv iu lc b ld nd lg ne lj nf ln ng lr nh lv nm na nb nc bi translated"><a class="ae kz" href="https://neptune.ai/blog/ways-ml-teams-use-ci-cd-in-production" rel="noopener ugc nofollow" target="_blank">机器学习团队在生产中使用CI/CD的4种方式</a></li></ul></div><div class="ab cl nn no hy np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="in io ip iq ir"><p id="5b15" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="nu">要了解更多数据工程内容，您可以订阅我的双周刊时事通讯Data Espresso，我将在其中讨论与数据工程和技术相关的各种主题:</em></p><div class="nv nw gq gs nx ny"><a href="https://dataespresso.substack.com/" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fp"><div class="oa ab ob cl cj oc"><h2 class="bd iv gz z fq od fs ft oe fv fx it bi translated">数据浓缩咖啡</h2><div class="of l"><h3 class="bd b gz z fq od fs ft oe fv fx dk translated">数据工程更新和评论伴随您的午后咖啡。点击阅读数据咖啡，由马赫迪…</h3></div><div class="og l"><p class="bd b dl z fq od fs ft oe fv fx dk translated">dataespresso.substack.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om kt ny"/></div></div></a></div></div></div>    
</body>
</html>