<html>
<head>
<title>Leverage AWS Pipelines to enable DevSecOps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用 AWS 管道支持 DevSecOps</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/leverage-aws-pipelines-to-enable-devsecops-e671e710a9f9?source=collection_archive---------17-----------------------#2021-11-07">https://towardsdatascience.com/leverage-aws-pipelines-to-enable-devsecops-e671e710a9f9?source=collection_archive---------17-----------------------#2021-11-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="06e6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用 AWS CDK 创建安全的 CI/CD 管道，并在部署前扫描代码。</h2></div><p id="9e64" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为 AWS 的前安全顾问，我经常被问到类似这样的问题:“我们如何确保 T2 的 CI/CD 管道是安全的，我们如何在应用部署之前验证安全性？”像任何 CI 工具如 Jenkins 和 AWS 代码管道；您可以为您的用例添加安全分析器。</p><p id="2e72" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是如何保护管道基础设施和堆栈本身呢？一种方法，至少如果你使用 AWS，是利用基础设施作为代码(<a class="ae le" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"> IaC </a>)技术让管道自部署并评估它自己的部署。</p><p id="0981" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将学习如何利用 AWS CDK 框架来部署 CI/CD 管道，该管道将检查其自身的堆栈配置，部署一个示例 Lambda，这取决于它是否通过了流程中的安全检查。你准备好了吗？让我们开始吧。</p><p id="198c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">先决条件:首先跟我来抢锅炉板块代号<a class="ae le" href="https://github.com/dc401/AWS-CDK-SecurePipeline/blob/main/demo_cdkapp_withdependecies.zip" rel="noopener ugc nofollow" target="_blank">这里</a>。确保您至少安装并配置了以下内容:</p><ul class=""><li id="b687" class="lf lg it kk b kl km ko kp kr lh kv li kz lj ld lk ll lm ln bi translated">AWS <a class="ae le" href="https://aws.amazon.com/cdk/" rel="noopener ugc nofollow" target="_blank"> CDK </a></li><li id="2da3" class="lf lg it kk b kl lo ko lp kr lq kv lr kz ls ld lk ll lm ln bi translated">AWS <a class="ae le" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> CLIv2 </a></li><li id="ab86" class="lf lg it kk b kl lo ko lp kr lq kv lr kz ls ld lk ll lm ln bi translated">AWS <a class="ae le" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-services-iam-create-creds.html" rel="noopener ugc nofollow" target="_blank"> IAM 键</a>或 SSO</li><li id="26e4" class="lf lg it kk b kl lo ko lp kr lq kv lr kz ls ld lk ll lm ln bi translated"><a class="ae le" href="https://www.python.org/downloads/" rel="noopener ugc nofollow" target="_blank"> Python 3 </a></li><li id="0d36" class="lf lg it kk b kl lo ko lp kr lq kv lr kz ls ld lk ll lm ln bi translated"><a class="ae le" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> VS 代码</a>或兼容的 IDE</li><li id="b4b8" class="lf lg it kk b kl lo ko lp kr lq kv lr kz ls ld lk ll lm ln bi translated"><a class="ae le" href="https://git-scm.com/downloads" rel="noopener ugc nofollow" target="_blank"> Git </a></li></ul><p id="64de" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="lt">建筑概述</em></p><p id="cfc5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">CI/CD 管道将包括用于 lambda 示例应用程序静态代码分析的<a class="ae le" href="https://aws.amazon.com/codecommit/" rel="noopener ugc nofollow" target="_blank">代码提交</a>、<a class="ae le" href="https://aws.amazon.com/codepipeline/" rel="noopener ugc nofollow" target="_blank">代码管道</a>、<a class="ae le" href="https://aws.amazon.com/codebuild/" rel="noopener ugc nofollow" target="_blank">代码构建</a>、<a class="ae le" href="https://github.com/bridgecrewio/checkov" rel="noopener ugc nofollow" target="_blank"> Bridgecrew </a>、可选的<a class="ae le" href="https://github.com/PyCQA/bandit" rel="noopener ugc nofollow" target="_blank"> Bandit </a>的自动化实践，以及部署我们的 lambda 应用程序之前的手动批准阶段:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/f058060bad5e64272b9311305c2ae605.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*AKS-GaaeXFfhSLSWe6LMsA.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">我们将建立的 CI/CD 管道图</p></figure><p id="4460" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="lt">部署说明</em></p><p id="0d7e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请在克隆 repo 后遵循“README.md”文件或下载<a class="ae le" href="https://github.com/dc401/AWS-CDK-SecurePipeline/blob/main/demo_cdkapp_withdependecies.zip" rel="noopener ugc nofollow" target="_blank">文件</a>。确保您已将 repo 或 zip 文件提取到一个空的暂存文件夹中。自述文件包含原始语法步骤。要获得这方面的指导，请继续阅读本节。如果您不需要引导式演练，请跳到下一节查看代码亮点和解释。</p><p id="c25a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">解压缩 zip 文件或将克隆的存储库复制到临时文件夹中。不要将其命名为 demo_cdkapp:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/9f73ca3ae48f32194296d4a368b6e51c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*c4ULmKW3-7c6YaeygY98MA.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">解压缩的 demo_cdkapp.zip 文件夹</p></figure><p id="4699" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在 temp 文件夹的相邻目录中，创建一个名为“demo_cdkapp”的新文件夹。这将是我们初始化 CDK 解决方案的地方:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/9ead3fbd26a280773b5df35ed14e9e09.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/1*ZBmSeN_FfeKNya7si6NLtA.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">创建一个新文件夹，将您的 CDK 项目命名为 demo_cdkapp</p></figure><p id="dd3d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">打开终端，导航到空的“demo_cdkapp”路径，然后运行以下命令:</p><pre class="lv lw lx ly gt mi mj mk ml aw mm bi"><span id="b30b" class="mn mo it mj b gy mp mq l mr ms">cdk init --language python</span></pre><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi lu"><img src="../Images/157715526ebb8aa4ec642ddd11097141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*yvhD-GIMXSI7TQQZB6yMbA.png"/></div></div><p class="mc md gj gh gi me mf bd b be z dk translated">在新文件夹中初始化 cdk 项目的输出示例</p></figure><p id="2341" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">CDK 现在为 Python 虚拟环境创建了框架初始化文件。从您创建的“temp”文件夹中复制解决方案，并在需要时替换文件。比如 requirements.txt，README。MD 等:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/2c2bcb2474544efbb675f5c209c4a1e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*5wBDdLXrFk_4iHXWtNOVFg.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">确保您的 CDK 框架文件位于正确的目录中</p></figure><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/2c375637bc4fd92e5708058f48e9512c.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*J-dp-LjsGCkY9emH2u1J7Q.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">框架在目录中生成的新 CDK 文件的屏幕截图</p></figure><p id="d1e8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用适当的语法和激活脚本激活 Python 虚拟环境并设置依赖项。在 Windows PowerShell 中，这是通过以下方式调用的:</p><pre class="lv lw lx ly gt mi mj mk ml aw mm bi"><span id="569f" class="mn mo it mj b gy mp mq l mr ms">. .\.venv\Scripts\Activate.ps1<br/>pip install -r .\requirements.txt</span></pre><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/1e680414d1d435768777e81904e3f2ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*ShK5jdt5_nn95GyiDA0tXw.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">为 CDK 激活虚拟环境的输出</p></figure><p id="9234" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者，您现在可以通过键入以下内容在 IDE(如 Microsoft VSCode 2019)中打开您的解决方案文件夹:</p><pre class="lv lw lx ly gt mi mj mk ml aw mm bi"><span id="0e67" class="mn mo it mj b gy mp mq l mr ms">code .</span></pre><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/e7083d1ff0dd47b07229a4aa99116228.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*oWut6NOj_SyhGZUjJHZ2aA.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">您可以看到您下载的样板示例提供的示例代码</p></figure><p id="6585" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确保代码中没有语法或其他错误，以防您可能通过执行“cdk ls”意外修改了 Python 堆栈文件。您应该会看到一个名为“CdkPipelineStack”的堆栈。我们需要引导 CDK，创建 IAM 资源，包括角色和 S3 存储桶，以便能够将我们的解决方案加载到客户中:</p><pre class="lv lw lx ly gt mi mj mk ml aw mm bi"><span id="e1c8" class="mn mo it mj b gy mp mq l mr ms">cdk ls<br/>cdk bootstrap --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess</span></pre><p id="b204" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">免责声明:请注意，这仅用于演示目的。在实际部署或利益相关方现场演示期间，您应该实践最佳实践，并使用权限最小的自定义执行策略，或者在将来使用 CDK 支持的替代策略或配置文件构造。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/1b20cd01e402272b7c9ef5c9b7ec10d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*jsmBf86TxH6TDtU5Ci1D2w.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">成功时的命令输出示例</p></figure><p id="6e2b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们必须部署我们的管道。运行“cdk 部署”,以便构建我们的 CI/CD 管道基础设施。将要求您确认更改，因为将创建新的角色和与安全相关的更改。按“y”确认:</p><pre class="lv lw lx ly gt mi mj mk ml aw mm bi"><span id="41c9" class="mn mo it mj b gy mp mq l mr ms">cdk deploy</span></pre><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/c345abb3600621d322acc6f1d312b359.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*LeK_xdxUOZXfLZR0GViOFA.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">cdk 部署和确认提示的输出示例</p></figure><p id="5f6e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦完成，预计会看到管道处于失败状态。这是因为我们还没有将任何内容推送到我们即将建立的 CodeCommit repo:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi my"><img src="../Images/e5b225850cf2c4c50f77330479881909.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/format:webp/1*llBsiSq_BByoJi_2wx5kiw.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">登录到您的 AWS 帐户，注意代码管道状态</p></figure><p id="e5c1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">初始化将被推送到 CodeCommit 的本地 git repo 目录。运行以下命令:<em class="lt">git init；git add-A；git commit -m '初始化'</em>。成功的提交和回购将返回:</p><pre class="lv lw lx ly gt mi mj mk ml aw mm bi"><span id="1dec" class="mn mo it mj b gy mp mq l mr ms">git init; git add -A; git commit -m 'initialize'</span></pre><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/b076875d28d3635e6c71d5c838aca25a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*AdXtQwjkucEBTHO_4XVWxA.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">成功提交到代码提交存储库的 git 输出示例</p></figure><p id="b9c5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确保您已经在 IAM 中为 CodeCommit 创建了 HTTPS Git 凭据。下载或保存它们，因为在推送至克隆 URL 时会用到它们:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/5423a61191b2455910e176cab29dd738.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*7de-qVSzzSwO6E4kgMOgvQ.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">首先需要配置代码提交 Git URL</p></figure><p id="a1f1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在您需要设置您的 Git 克隆 HTTP/S URL，它是用 CodeCommit 的 repo 创建的。注意:如果您在代码中重命名或修改了回购名称，请相应地更新 URL:</p><pre class="lv lw lx ly gt mi mj mk ml aw mm bi"><span id="e277" class="mn mo it mj b gy mp mq l mr ms">git remote add origin https://git-codecommit.us-west-2.amazonaws.com/v1/repos/demo_cicid_pipeline_repo<br/>git push --set-upstream origin master</span></pre><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/4a8fbe802d3206117eb688a163d99498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*XtWrWXo5L1POjrBTPAIQPQ.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">代码提交报告成功部署的输出</p></figure><p id="6d55" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="lt">验证应用和云架构堆栈安全性</em></p><p id="0ed6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦您成功部署了 CI/CD 管道并执行了首次代码提交，您仍然会有一个“按原样”的失败构建状态管道，这是意料之中的。您需要更正有问题的不安全代码才能通过构建。现在是时候纠正不安全的代码，并演示我们的 Lambda 示例应用程序的成功构建和部署了。</p><p id="5e4d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">打开 CodePipeline 并访问最近失败的构建阶段。单击详细信息，并按照执行链接进行操作:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi na"><img src="../Images/be57c03d2cf8f12b26a8ab49ea8fc8d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*W84lmT7UUWwxJy3FwXCnvQ.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">最初为代码管道生成失败状态</p></figure><p id="e7f7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">向下滚动日志，直到找到与 Lambda 函数的 Bandit 验证相关的测试结果错误，违规行包括<strong class="kk iu"> helloworld.py </strong>中的第 6 行和第 9 行:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi na"><img src="../Images/e63acd4d783f580d667cb4df419bab13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*8Qgmt3IZSqHw1uj1wD4kew.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">AWS CodeBuild 部署失败，因为来自 Bandit 检查的不安全代码</p></figure><p id="62f2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">返回到您首选的编辑器或 IDE，将第 4 行中的 print 语句修改为结果变量。注释掉有问题的第 6 行和第 9 行。以下应该是您更新后的代码:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/bfebc63261dcf210c2a7dbc98e5d55e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*hSmZx0Xq7b2s_erRH9Ik4g.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">代码现在可以通过注释掉 helloworld.py 中有问题的不安全代码来通过</p></figure><p id="e312" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">确保您已经在 IDE 或代码编辑器中保存并暂存了所有更改。对于 VSCode，它位于左侧，您需要在保存文件后单击菜单中的“+”按钮:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/c7ccf31ceb8d4adee56f502774a2d2dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*mlmdT7fp8UCcmZ-OW5Nq3A.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">确保您的阶段性更改在 VS 代码中提交</p></figure><p id="402a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">回到终端，通过运行“git status”确保正确跟踪更改，然后通过运行以下命令提交和推送更改:</p><pre class="lv lw lx ly gt mi mj mk ml aw mm bi"><span id="0fcc" class="mn mo it mj b gy mp mq l mr ms">git status<br/>git commit -am 'secured lambda code'; git push</span></pre><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/e8f36a9090dd24991694edd2364d914e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*k7NcgtWXksP4lS0cBq3b4A.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">关于新 git 提交更改的命令输出</p></figure><p id="f3eb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">返回 web 控制台并检查代码管道，然后等待构建成功。它将贯穿更新其他阶段，并进入部署阶段。在部署阶段，我们已经在部署之前设置了手动合并审查，作为最佳实践完成。这将需要 3-5 分钟。打开一个新标签，探索 <a class="ae le" href="https://aws.amazon.com/codeguru/" rel="noopener ugc nofollow" target="_blank"> <em class="lt">代码大师</em> </a>的概念。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/8906b62edb275e4d87a6338da3a6b622.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*g4Js98vg8EEgRFmS31zZOQ.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">代码管道为部署阶段传递新的安全 lambda 代码</p></figure><p id="93e6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当管道处于“等待批准”状态时，作为代码审查最佳实践的一部分，您可以选择通过设置事件通知和 SNS 主题向电子邮件开发人员发送合并请求。</p><p id="7176" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在 CodeGuru 中打开一个新的选项卡，并展开 Profiling Groups 部分，这样您就可以看到建议了。单击“{ code guru } DemoProfilingGroup-with issues”并显示性能建议，其中显示了代码中最“昂贵”的部分:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nd"><img src="../Images/a16c4f5771f7b342b28c34c89457e25f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*Lvm8OLF6ufV7HyPcvgb93w.png"/></div></div><p class="mc md gj gh gi me mf bd b be z dk translated">AWS CodeGuru 分析 lambda 函数的性能</p></figure><p id="241e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，浏览代码评审部分，点击“Create Repository Analysis ”,指向我们的演示 repo，将主分支作为目标。这将需要几分钟的时间，因此在现场演示期间，最好提前运行，或者将您的注意力转移到批准代码合并上:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/4bf6a2e391e256cd73e0f2a3d41b9368.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*JBUChRrePpws-qGIvLtwYQ.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">CodeGuru 允许您查看 helloworld.py lambda 建议的状态</p></figure><p id="6539" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在对 Codeguru 结果进行满意的审查之后，返回到代码管道并批准部署操作。这将需要 1-2 分钟:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/bab66102762ff91ab966857e5572c44e.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/1*L8dHOyRoMKRzdmNDMivbiw.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">手动批准管道以开始部署到 AWS 帐户</p></figure><p id="6e87" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于 Lambda 函数正在进行部署，我们还可以编辑管道堆栈代码，并尝试将未加密的 AWS SQS 服务添加到我们的环境中。返回代码编辑器或 IDE。打开解决方案文件夹中的<strong class="kk iu"> 'cdkpipeline_stack.py </strong>'文件夹。向下滚动并取消注释 SQS 的构造。在编辑器中保存并暂存您的更改:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi na"><img src="../Images/676c0fb8ac10a93f044f6d129215f8bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*GGdCKZ8g2aZlB0PoMAU9gQ.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">编辑您的管道，将未经授权的配置添加到您的 CDK 堆栈中</p></figure><p id="7071" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">返回到终端，运行 git 提交和推送来启动管道触发的事件:</p><pre class="lv lw lx ly gt mi mj mk ml aw mm bi"><span id="fe61" class="mn mo it mj b gy mp mq l mr ms">git commit –am 'added insecure SQS IaC'; git push</span></pre><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/533284c66aebb8998dc18b9866a21dfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*9TGsxbyUWQ4myVxBlW9Pcg.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">新代码提交和推送的输出</p></figure><p id="7ff5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">返回到 CodePipeline 页面，注意构建阶段正在进行，我们新的不安全基础设施作为代码堆栈，CDK 正在创建云结构变更集和更新。它会因为我们不安全的代码而失败。向下滚动，您应该会看到部署我们成功的 Lambda 函数的第一个按钮。</p><p id="0ad3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意:您不必等到部署阶段才开始推送更多的提交更新。阶段可以有多个并行验证检查的操作:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/d9229557b46d9cc870d54c979ac0fd62.png" data-original-src="https://miro.medium.com/v2/resize:fit:670/format:webp/1*HhPHzlXDXZC6QhsimdZA5A.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">代码管道检测到不安全的 CI/CDstack 配置，导致构建失败。</p></figure><p id="7b34" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不要被末尾的绿色所迷惑，增量是构建状态。从<em class="lt">之前的</em>部署来看，之前的阶段仍然是绿色的:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/cebb48b17fc1c5c4ce706370d3be8838.png" data-original-src="https://miro.medium.com/v2/resize:fit:674/format:webp/1*JcYJPTStluorRLkzOHoXqg.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">先前的构建和部署与您最近的更改无关</p></figure><p id="8148" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">调查我们来自 CDK 的不安全的 SQS 构造代码推送的代码构建失败日志。向下滚动执行细节日志，您将看到由 CDK 生成的令人不快的云形成模板行以及失败的原因。APN 桥船员包注明这是检查 CKV_AWS_27:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/9b0b61113260d0ff9eaefecc9cc0a1c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*d5l1QErz8Fm9sKBcIW8wjw.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">不安全的 SQS 尝试添加到 CI/CD 管道堆栈失败</p></figure><p id="13f5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">或者，您可以在堆栈 Python 中再次重新注释与 SQS 相关的构造代码，演示另一个 commit，并再次推送以显示通过的管道状态。</p><p id="9065" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="lt">打扫卫生</em></p><p id="df4f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您将需要运行“cdk destroy ”,但也要删除 cdk 创建的 S3 存储桶，以及在我们成功部署期间创建的相关云形成堆栈。如果您需要演练，请执行以下步骤。如果它仍然打开，请关闭代码编辑器并返回到终端。运行“cdk destroy”并确认提示符为“y”:</p><pre class="lv lw lx ly gt mi mj mk ml aw mm bi"><span id="3149" class="mn mo it mj b gy mp mq l mr ms">cdk destroy</span></pre><p id="ca02" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">返回 CloudFormation 中的 AWS 控制台，删除 Lambda 部署应用程序堆栈和 CDKToolkit 引导堆栈:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/a8e31b90c49f3331e692f60d1ccbff4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*MSpNw7nbW6BVyIGu5vZb8Q.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">删除 CloudFormation 中的引导堆栈</p></figure><p id="93a9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在删除 S3 工件桶和由 CDK 创建的引导桶。请注意，这些名称的前缀与我们的堆栈名称和我们所在地区的 cdk 引导后缀相关:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/203ca1b977b11ecc55cae6b368daacc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*i6nrYl-AbKNruWXHFw2yYA.png"/></div><p class="mc md gj gh gi me mf bd b be z dk translated">确保删除在 CDK 为您创建的 S3 引导存储桶</p></figure><p id="793a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">恭喜你。在 CDK 使用 boiler plate 代码，现在您可以使用 AWS 和第三方集成扩展创建自部署和安全的 CI/CD 管道。和往常一样，如果你觉得我的建议很有帮助，并且想要更多的咨询，请拨打<a class="ae le" href="http://www.scissecurity.com" rel="noopener ugc nofollow" target="_blank">www.scissecurity.com</a>联系我</p><p id="b376" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">快乐<em class="lt">安全</em>发展！</p></div></div>    
</body>
</html>